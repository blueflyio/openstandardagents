# Multi-Region Deployment Configuration for OSSA v0.1.8
# This manifest sets up geographic distribution across multiple regions

apiVersion: v1
kind: Namespace
metadata:
  name: ossa-global
  labels:
    app.kubernetes.io/name: ossa-global
    app.kubernetes.io/version: "0.1.8"
    app.kubernetes.io/component: global
    ossa.bluefly.io/version: "0.1.8"
    ossa.bluefly.io/tier: global
  annotations:
    ossa.bluefly.io/description: "OSSA Global Services for Multi-Region Coordination"

---
# Global Load Balancer Configuration
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: ossa-global-ssl-cert
  namespace: ossa-global
  labels:
    app.kubernetes.io/name: ossa-global
    app.kubernetes.io/component: ssl-certificate
spec:
  domains:
    - "ossa.llm.bluefly.io"
    - "ossa-api.llm.bluefly.io"
    - "*.ossa.llm.bluefly.io"

---
# Global Multi-Cluster Ingress
apiVersion: networking.gke.io/v1
kind: MultiClusterIngress
metadata:
  name: ossa-global-mci
  namespace: ossa-global
  labels:
    app.kubernetes.io/name: ossa-global
    app.kubernetes.io/component: multi-cluster-ingress
  annotations:
    networking.gke.io/load-balancer-type: "External"
    networking.gke.io/managed-certificates: "ossa-global-ssl-cert"
spec:
  template:
    spec:
      backend:
        serviceName: ossa-global-backend
        servicePort: 80
      rules:
      - host: ossa.llm.bluefly.io
        http:
          paths:
          - path: /api/v1/*
            backend:
              serviceName: ossa-gateway-mcs
              servicePort: 80
          - path: /graphql/*
            backend:
              serviceName: ossa-gateway-mcs
              servicePort: 80
          - path: /*
            backend:
              serviceName: ossa-global-backend
              servicePort: 80

---
# Multi-Cluster Service for Gateway
apiVersion: networking.gke.io/v1
kind: MultiClusterService
metadata:
  name: ossa-gateway-mcs
  namespace: ossa-global
  labels:
    app.kubernetes.io/name: ossa-gateway
    app.kubernetes.io/component: multi-cluster-service
spec:
  template:
    spec:
      selector:
        app.kubernetes.io/name: ossa-gateway
      ports:
      - name: http
        protocol: TCP
        port: 80
        targetPort: 3000
  clusters:
  - link: "us-west-2/ossa-platform"  # Primary region
  - link: "us-east-1/ossa-platform"  # Secondary region
  - link: "eu-west-1/ossa-platform"  # European region

---
# Region-specific NodeAffinity for US West
apiVersion: v1
kind: ConfigMap
metadata:
  name: ossa-region-us-west
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-region-config
    ossa.bluefly.io/region: "us-west-2"
data:
  REGION: "us-west-2"
  AVAILABILITY_ZONES: "us-west-2a,us-west-2b,us-west-2c"
  REGION_PRIORITY: "primary"
  CROSS_REGION_REPLICATION: "true"
  LATENCY_REGION_WEIGHTS: "us-west-2:1,us-east-1:2,eu-west-1:3"

---
# Anti-Affinity Rules for Cross-Region Distribution
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ossa-gateway-global
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-gateway
    app.kubernetes.io/component: gateway-global
    ossa.bluefly.io/deployment-type: global
spec:
  replicas: 15  # Distributed across 3 regions
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 20%
      maxSurge: 20%
  selector:
    matchLabels:
      app.kubernetes.io/name: ossa-gateway
      ossa.bluefly.io/deployment-type: global
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ossa-gateway
        app.kubernetes.io/component: gateway-global
        ossa.bluefly.io/deployment-type: global
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
    spec:
      serviceAccountName: ossa-service-account
      topologySpreadConstraints:
      - maxSkew: 2
        topologyKey: topology.kubernetes.io/region
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: ossa-gateway
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: ossa-gateway
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - ossa-gateway
              topologyKey: kubernetes.io/hostname
          - weight: 50
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - ossa-gateway
              topologyKey: topology.kubernetes.io/zone
      containers:
      - name: gateway
        image: gitlab.bluefly.io/ossa/platform:0.1.8-gateway
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: REGION
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['topology.kubernetes.io/region']
        - name: ZONE
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['topology.kubernetes.io/zone']
        - name: MULTI_REGION_MODE
          value: "true"
        - name: CROSS_REGION_DISCOVERY
          value: "true"
        - name: REGION_WEIGHTS
          valueFrom:
            configMapKeyRef:
              name: ossa-region-us-west
              key: LATENCY_REGION_WEIGHTS
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5

---
# Cross-Region Service Discovery
apiVersion: v1
kind: Service
metadata:
  name: ossa-cross-region-discovery
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-cross-region-discovery
    app.kubernetes.io/component: service-discovery
    ossa.bluefly.io/scope: global
  annotations:
    cloud.google.com/neg: '{"exposed_ports": {"80":{"name": "ossa-discovery"}}}'
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
spec:
  type: LoadBalancer
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 300
  selector:
    app.kubernetes.io/name: ossa-discovery
  ports:
  - port: 80
    targetPort: 3011
    name: http

---
# Geo-Location Routing Policy
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ossa-geo-routing
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-geo-routing
    app.kubernetes.io/component: geo-routing
spec:
  hosts:
  - "ossa.llm.bluefly.io"
  gateways:
  - ossa-gateway
  http:
  # Route based on geolocation headers
  - match:
    - headers:
        cf-ipcountry:
          exact: "US"
    - headers:
        x-geo-country:
          exact: "US"
    route:
    - destination:
        host: ossa-gateway.ossa-platform.svc.cluster.local
        subset: us-region
      weight: 90
    - destination:
        host: ossa-gateway.ossa-platform.svc.cluster.local
        subset: eu-region
      weight: 10
  
  # European traffic routing
  - match:
    - headers:
        cf-ipcountry:
          regex: "GB|DE|FR|ES|IT|NL"
    - headers:
        x-geo-country:
          regex: "GB|DE|FR|ES|IT|NL"
    route:
    - destination:
        host: ossa-gateway.ossa-platform.svc.cluster.local
        subset: eu-region
      weight: 90
    - destination:
        host: ossa-gateway.ossa-platform.svc.cluster.local
        subset: us-region
      weight: 10

  # Default routing (latency-based)
  - route:
    - destination:
        host: ossa-gateway.ossa-platform.svc.cluster.local
        subset: us-region
      weight: 70
    - destination:
        host: ossa-gateway.ossa-platform.svc.cluster.local
        subset: eu-region
      weight: 30

---
# Regional Subsets for Traffic Management
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: ossa-regional-subsets
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-regional-subsets
    app.kubernetes.io/component: destination-rule
spec:
  host: ossa-gateway.ossa-platform.svc.cluster.local
  subsets:
  - name: us-region
    labels:
      ossa.bluefly.io/region: us-west-2
    trafficPolicy:
      loadBalancer:
        localityLbSetting:
          enabled: true
          distribute:
          - from: "region/us-west-2/*"
            to:
              "region/us-west-2/*": 80
              "region/us-east-1/*": 20
          failover:
          - from: "region/us-west-2"
            to: "region/us-east-1"
  
  - name: eu-region
    labels:
      ossa.bluefly.io/region: eu-west-1
    trafficPolicy:
      loadBalancer:
        localityLbSetting:
          enabled: true
          distribute:
          - from: "region/eu-west-1/*"
            to:
              "region/eu-west-1/*": 100
          failover:
          - from: "region/eu-west-1"
            to: "region/us-east-1"

---
# Cross-Region Database Replication Configuration
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ossa-postgres-replica
  namespace: ossa-system
  labels:
    app.kubernetes.io/name: ossa-postgres
    app.kubernetes.io/component: database-replica
    ossa.bluefly.io/role: replica
spec:
  serviceName: ossa-postgres-replica
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: ossa-postgres
      ossa.bluefly.io/role: replica
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ossa-postgres
        app.kubernetes.io/component: database-replica
        ossa.bluefly.io/role: replica
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/region
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: ossa-postgres
            ossa.bluefly.io/role: replica
      containers:
      - name: postgres
        image: postgres:15-alpine
        env:
        - name: POSTGRES_DB
          value: ossa
        - name: POSTGRES_USER
          value: ossa
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ossa-platform-secrets
              key: POSTGRES_PASSWORD
        - name: POSTGRES_MASTER_SERVICE
          value: "ossa-postgres.ossa-system.svc.cluster.local"
        - name: POSTGRES_REPLICATION_MODE
          value: "slave"
        - name: POSTGRES_REPLICATION_USER
          value: "replica_user"
        - name: POSTGRES_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ossa-platform-secrets
              key: POSTGRES_PASSWORD
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
          limits:
            memory: "4Gi"
            cpu: "2"
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: ossa-fast-ssd
      resources:
        requests:
          storage: 100Gi

---
# Cross-Region Coordination Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ossa-global-coordinator
  namespace: ossa-global
  labels:
    app.kubernetes.io/name: ossa-global-coordinator
    app.kubernetes.io/component: coordinator
    ossa.bluefly.io/scope: global
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: ossa-global-coordinator
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ossa-global-coordinator
        app.kubernetes.io/component: coordinator
        ossa.bluefly.io/scope: global
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/region
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: ossa-global-coordinator
      containers:
      - name: global-coordinator
        image: gitlab.bluefly.io/ossa/platform:0.1.8-global-coordinator
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: COORDINATION_MODE
          value: "global"
        - name: REGIONS
          value: "us-west-2,us-east-1,eu-west-1"
        - name: CONSENSUS_ALGORITHM
          value: "raft"
        - name: CLUSTER_SIZE
          value: "3"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5

---
# Global Service for Cross-Region Communication
apiVersion: v1
kind: Service
metadata:
  name: ossa-global-coordinator
  namespace: ossa-global
  labels:
    app.kubernetes.io/name: ossa-global-coordinator
    app.kubernetes.io/component: coordinator-service
spec:
  selector:
    app.kubernetes.io/name: ossa-global-coordinator
  ports:
  - port: 8080
    targetPort: 8080
    name: http
  type: LoadBalancer
  
---
# Cross-Region Monitoring Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: ossa-cross-region-monitoring
  namespace: ossa-monitoring
  labels:
    app.kubernetes.io/name: ossa-monitoring
    app.kubernetes.io/component: cross-region-config
data:
  prometheus-federated.yml: |
    global:
      scrape_interval: 15s
      external_labels:
        region: '{{ .Region }}'
        cluster: '{{ .Cluster }}'

    scrape_configs:
    # Federated scraping from other regions
    - job_name: 'federated-us-east'
      scrape_interval: 30s
      honor_labels: true
      metrics_path: '/federate'
      params:
        'match[]':
          - '{job=~"ossa-.*"}'
          - '{__name__=~"up|ossa_.*"}'
      static_configs:
        - targets:
          - 'prometheus-us-east-1.ossa-monitoring.svc.cluster.local:9090'
    
    - job_name: 'federated-eu-west'
      scrape_interval: 30s
      honor_labels: true
      metrics_path: '/federate'
      params:
        'match[]':
          - '{job=~"ossa-.*"}'
          - '{__name__=~"up|ossa_.*"}'
      static_configs:
        - targets:
          - 'prometheus-eu-west-1.ossa-monitoring.svc.cluster.local:9090'

  cross-region-alerts.yml: |
    groups:
    - name: cross-region.rules
      rules:
      - alert: CrossRegionLatencyHigh
        expr: ossa_cross_region_latency_seconds > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High cross-region latency detected"
          description: "Cross-region latency between {{ $labels.source_region }} and {{ $labels.target_region }} is {{ $value }}s"
      
      - alert: RegionPartition
        expr: up{job="ossa-global-coordinator"} < 2
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Potential region partition detected"
          description: "Less than 2 global coordinators are available, potential network partition"