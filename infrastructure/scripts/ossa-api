#!/bin/bash
# OSSA API Portal CRUD Command
# Manage OpenAPI documentation services

set -e

# Configuration
INFRASTRUCTURE_DIR="/Users/flux423/Sites/LLM/OSSA/infrastructure"
COMPOSE_FILE="$INFRASTRUCTURE_DIR/docker/docker-compose.openapi.yml"
PROJECT_NAME="ossa-openapi"

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# CRUD Operations
case ${1:-help} in
    create|start|up)
        echo -e "${BLUE}üöÄ Creating OpenAPI Portal services...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d
        echo -e "${GREEN}‚úÖ Services created and started${NC}"
        echo ""
        echo "üìò Swagger UI: http://localhost:8080"
        echo "üìï Redocly: http://localhost:8081"
        echo "üåê Portal: http://localhost:8082"
        echo "üîß Mock API: http://localhost:4010"
        ;;
        
    read|status|ps)
        echo -e "${BLUE}üìä Reading service status...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" ps
        echo ""
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" logs --tail=5
        ;;
        
    update|restart)
        echo -e "${YELLOW}üîÑ Updating services...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" restart
        echo -e "${GREEN}‚úÖ Services updated${NC}"
        ;;
        
    delete|stop|down)
        echo -e "${RED}üõë Deleting services...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" down
        echo -e "${GREEN}‚úÖ Services deleted${NC}"
        ;;
        
    logs)
        echo -e "${CYAN}üìú Viewing logs...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" logs -f
        ;;
        
    exec)
        SERVICE=${2:-swagger-ui}
        echo -e "${CYAN}üîß Executing in $SERVICE...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" exec "$SERVICE" /bin/sh
        ;;
        
    scale)
        SERVICE=${2:-swagger-ui}
        COUNT=${3:-2}
        echo -e "${BLUE}üìà Scaling $SERVICE to $COUNT instances...${NC}"
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d --scale "$SERVICE=$COUNT"
        ;;
        
    help|*)
        echo "OSSA API Portal CRUD Commands"
        echo "=============================="
        echo ""
        echo "Usage: $0 <operation> [options]"
        echo ""
        echo "CRUD Operations:"
        echo "  create/start/up    - Create and start all services"
        echo "  read/status/ps     - Read service status and logs"
        echo "  update/restart     - Update/restart services"
        echo "  delete/stop/down   - Delete/stop all services"
        echo ""
        echo "Additional Commands:"
        echo "  logs              - Stream service logs"
        echo "  exec [service]    - Execute shell in service"
        echo "  scale [service] [count] - Scale service instances"
        echo ""
        echo "Services:"
        echo "  ‚Ä¢ swagger-ui  - Interactive API documentation"
        echo "  ‚Ä¢ redocly     - Beautiful API docs"
        echo "  ‚Ä¢ api-portal  - Main portal"
        echo "  ‚Ä¢ prism-mock  - Mock API server"
        echo "  ‚Ä¢ prism-proxy - Validation proxy"
        echo ""
        echo "Examples:"
        echo "  $0 create         # Start all services"
        echo "  $0 status         # Check status"
        echo "  $0 logs           # View logs"
        echo "  $0 delete         # Stop services"
        ;;
esac