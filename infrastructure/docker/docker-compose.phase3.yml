# OSSA Phase 3: 150-Agent Community Marketplace
# Extends base docker-compose.yml with Phase 3 scaling services

services:
  # Phase 3 Community Marketplace Services
  marketplace-api:
    container_name: ossa-marketplace-api
    image: ossa:phase3-marketplace
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.marketplace
    environment:
      - NODE_ENV=production
      - MARKETPLACE_PORT=3020
      - REDIS_URL=redis://redis-cluster:6379
      - POSTGRES_URL=postgresql://ossa:ossa_prod_password@postgres-cluster:5432/ossa_marketplace
      - KAFKA_BROKERS=kafka:9092
    ports:
      - "3020:3020"   # Marketplace API
    depends_on:
      - redis-cluster
      - postgres-cluster  
      - kafka
    networks:
      - ossa-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  certification-service:
    container_name: ossa-certification
    image: ossa:phase3-certification
    environment:
      - NODE_ENV=production
      - CERT_PORT=3021
      - SECURITY_SCAN_ENABLED=true
      - QUALITY_GATES=5
    ports:
      - "3021:3021"   # Certification Service
    depends_on:
      - marketplace-api
    networks:
      - ossa-network

  community-analytics:
    container_name: ossa-community-analytics  
    image: ossa:phase3-analytics
    environment:
      - NODE_ENV=production
      - ANALYTICS_PORT=3022
      - METRICS_RETENTION=30d
      - DASHBOARD_ENABLED=true
    ports:
      - "3022:3022"   # Analytics Dashboard
    depends_on:
      - marketplace-api
    networks:
      - ossa-network

  # Scaled Infrastructure for Phase 3
  redis-cluster:
    container_name: ossa-redis-cluster
    image: redis/redis-stack:latest
    environment:
      - REDIS_ARGS=--cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000
    ports:
      - "6379:6379"
      - "6380:6380"  # Redis Insight
    volumes:
      - redis-cluster-data:/data
    networks:
      - ossa-network

  postgres-cluster:
    container_name: ossa-postgres-cluster
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ossa_marketplace
      POSTGRES_USER: ossa
      POSTGRES_PASSWORD: ossa_prod_password
      POSTGRES_MAX_CONNECTIONS: 2000
    ports:
      - "5432:5432"
    volumes:
      - postgres-cluster-data:/var/lib/postgresql/data
      - ./sql/phase3-schema.sql:/docker-entrypoint-initdb.d/phase3-schema.sql
    networks:
      - ossa-network
    command: |
      postgres
      -c max_connections=2000
      -c shared_buffers=512MB
      -c effective_cache_size=2GB
      -c work_mem=16MB

  kafka:
    container_name: ossa-kafka
    image: confluentinc/cp-kafka:latest
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 50
      KAFKA_LOG_RETENTION_HOURS: 168
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - ossa-network

  zookeeper:
    container_name: ossa-zookeeper
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
    networks:
      - ossa-network

  # Enhanced monitoring for 150 agents
  prometheus-federation:
    container_name: ossa-prometheus-federation
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus-phase3.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=720h'  # 30 days for Phase 3
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    ports:
      - '9094:9090'
    volumes:
      - ./monitoring/prometheus/prometheus-phase3.yml:/etc/prometheus/prometheus-phase3.yml
      - prometheus-federation-data:/prometheus
    networks:
      - ossa-network

  grafana-cluster:
    container_name: ossa-grafana-cluster
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=ossa-phase3-2025
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel,grafana-worldmap-panel
      - GF_SERVER_ROOT_URL=http://localhost:3081/
    ports:
      - '3081:3000'
    volumes:
      - grafana-cluster-data:/var/lib/grafana
      - ./monitoring/grafana/phase3-dashboards:/var/lib/grafana/dashboards
    networks:
      - ossa-network
    depends_on:
      - prometheus-federation

networks:
  ossa-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis-cluster-data:
  postgres-cluster-data:
  kafka-data:
  zookeeper-data:
  prometheus-federation-data:
  grafana-cluster-data: