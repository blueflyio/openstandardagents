version: '3.8'

services:
  # Swagger UI for interactive API documentation
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: ossa-swagger-ui
    ports:
      - "8080:8080"
    environment:
      - SWAGGER_JSON=/api-specs/specification.openapi.yml
      - BASE_URL=/swagger
      - URLS_PRIMARY_NAME=OSSA Main API
      - URLS=[
          {"url":"/api-specs/specification.openapi.yml","name":"OSSA Specification API"},
          {"url":"/api-specs/orchestration.openapi.yml","name":"Orchestration API"},
          {"url":"/api-specs/clean-architecture.openapi.yml","name":"Clean Architecture API"},
          {"url":"/api-specs/mcp-infrastructure.openapi.yml","name":"MCP Infrastructure"},
          {"url":"/api-specs/voice-agent-specification.yml","name":"Voice Agent API"}
        ]
    volumes:
      - ../../src/api:/api-specs:ro
    networks:
      - openapi-network

  # Redocly for beautiful documentation
  redocly:
    image: redocly/redoc:latest
    container_name: ossa-redocly
    ports:
      - "8081:80"
    environment:
      - SPEC_URL=/api-specs/specification.openapi.yml
    volumes:
      - ./src/api:/usr/share/nginx/html/api-specs:ro
    networks:
      - openapi-network

  # API Portal with all project APIs
  api-portal:
    image: nginx:alpine
    container_name: ossa-api-portal
    ports:
      - "8082:80"
    volumes:
      - ../../public:/usr/share/nginx/html:ro
      - ../../docs/api:/usr/share/nginx/html/docs/api:ro
      - ./nginx-portal.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - openapi-network

  # Mock API server based on OpenAPI specs
  prism-mock:
    image: stoplight/prism:latest
    container_name: ossa-mock-api
    command: mock -h 0.0.0.0 /api-specs/specification.openapi.yml
    ports:
      - "4010:4010"
    volumes:
      - ../../src/api:/api-specs:ro
    networks:
      - openapi-network

  # API validation proxy
  prism-proxy:
    image: stoplight/prism:latest
    container_name: ossa-api-proxy
    command: proxy /api-specs/specification.openapi.yml http://host.docker.internal:3000 -h 0.0.0.0
    ports:
      - "4011:4010"
    volumes:
      - ../../src/api:/api-specs:ro
    networks:
      - openapi-network

networks:
  openapi-network:
    driver: bridge
    name: ossa-openapi-network