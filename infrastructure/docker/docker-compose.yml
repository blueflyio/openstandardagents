version: '3.8'

services:
  # ==========================================
  # OSSA MCP Server - Core Agent Protocol
  # ==========================================
  ossa-mcp:
    build: .
    container_name: ossa-mcp-server
    ports:
      - "4000:4000"  # HTTP/REST API
      - "4001:4001"  # WebSocket transport
      - "4002:4002"  # SSE transport
    environment:
      - OSSA_VERSION=0.1.9
      - NODE_ENV=production
      - MCP_TRANSPORT=multi
      - MCP_HTTP_PORT=4000
      - MCP_WS_PORT=4001
      - MCP_SSE_PORT=4002
    volumes:
      - ./logs:/app/logs
      - ./src:/app/src:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - ossa-network

  # ==========================================
  # API Documentation Services
  # ==========================================
  
  # Swagger UI for interactive API documentation
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: ossa-swagger-ui
    ports:
      - "8080:8080"
    environment:
      - SWAGGER_JSON=/api-specs/specification.openapi.yml
      - BASE_URL=/swagger
      - URLS_PRIMARY_NAME=OSSA Main API
      - URLS=[
          {"url":"/api-specs/specification.openapi.yml","name":"OSSA Specification API"},
          {"url":"/api-specs/ossa-complete.openapi.yml","name":"OSSA Complete"},
          {"url":"/api-specs/orchestration.openapi.yml","name":"Orchestration API"},
          {"url":"/api-specs/clean-architecture.openapi.yml","name":"Clean Architecture API"},
          {"url":"/api-specs/mcp-infrastructure.openapi.yml","name":"MCP Infrastructure"},
          {"url":"/api-specs/acdl-specification.yml","name":"ACDL Specification"}
        ]
    volumes:
      - ./src/api:/api-specs:ro
    networks:
      - ossa-network

  # Redocly for beautiful documentation
  redocly:
    image: redocly/redoc:latest
    container_name: ossa-redocly
    ports:
      - "8081:80"
    environment:
      - SPEC_URL=/api-specs/ossa-complete.openapi.yml
    volumes:
      - ./src/api:/usr/share/nginx/html/api-specs:ro
    networks:
      - ossa-network

  # API Portal with all documentation
  api-portal:
    image: nginx:alpine
    container_name: ossa-api-portal
    ports:
      - "8082:80"
    volumes:
      - ./public:/usr/share/nginx/html:ro
      - ./docs/api:/usr/share/nginx/html/docs/api:ro
      - ./infrastructure/docker/nginx-portal.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - ossa-network

  # ==========================================
  # Development & Testing Services
  # ==========================================
  
  # Mock API server based on OpenAPI specs
  prism-mock:
    image: stoplight/prism:latest
    container_name: ossa-mock-api
    command: mock -h 0.0.0.0 /api-specs/specification.openapi.yml
    ports:
      - "4010:4010"
    volumes:
      - ./src/api:/api-specs:ro
    networks:
      - ossa-network

  # API validation proxy
  prism-proxy:
    image: stoplight/prism:latest
    container_name: ossa-api-proxy
    command: proxy /api-specs/specification.openapi.yml http://ossa-mcp:4000 -h 0.0.0.0
    ports:
      - "4011:4010"
    volumes:
      - ./src/api:/api-specs:ro
    depends_on:
      - ossa-mcp
    networks:
      - ossa-network

  # ==========================================
  # Future Services (Ready for activation)
  # ==========================================
  
  # Redis for caching and session management
  # redis:
  #   image: redis:alpine
  #   container_name: ossa-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data
  #   networks:
  #     - ossa-network

  # PostgreSQL for persistent storage
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: ossa-postgres
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     - POSTGRES_USER=ossa
  #     - POSTGRES_PASSWORD=ossa_secure_password
  #     - POSTGRES_DB=ossa_db
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - ossa-network

# ==========================================
# Networks
# ==========================================
networks:
  ossa-network:
    driver: bridge
    name: ossa-cluster-network

# ==========================================
# Volumes (for future use)
# ==========================================
volumes:
  redis-data:
  postgres-data: