# Visual regression testing with Playwright
test:visual:baseline:
  stage: test
  image: mcr.microsoft.com/playwright:v1.48.0-jammy
  cache:
    key: playwright-cache
    paths:
      - .cache/ms-playwright
  before_script:
    - cd website
    - npm ci --prefer-offline --no-audit
  script:
    - npx playwright install --with-deps
    - npx playwright test tests/visual --update-snapshots
  artifacts:
    paths:
      - website/tests/visual/**/*.png
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

test:visual:verify:
  stage: test
  image: mcr.microsoft.com/playwright:v1.48.0-jammy
  cache:
    key: playwright-cache
    paths:
      - .cache/ms-playwright
  before_script:
    - cd website
    - npm ci --prefer-offline --no-audit
  script:
    - npx playwright install --with-deps
    - npx playwright test tests/visual --reporter=html,junit
  artifacts:
    when: always
    reports:
      junit: website/test-results/junit.xml
    paths:
      - website/playwright-report
      - website/test-results
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release\/.+/
