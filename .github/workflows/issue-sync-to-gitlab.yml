name: Issue Sync to GitLab

on:
  issues:
    types: [opened, edited, closed, reopened, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  # Triage new issues
  triage-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const labels = ['github-issue'];

            // Auto-detect issue type from title/body
            if (title.includes('bug') || title.includes('error') || title.includes('fix')) {
              labels.push('bug');
            } else if (title.includes('feature') || title.includes('request') || title.includes('add')) {
              labels.push('enhancement');
            } else if (title.includes('doc') || title.includes('readme')) {
              labels.push('documentation');
            } else if (title.includes('question') || title.includes('help')) {
              labels.push('question');
            }

            // Detect component from content
            if (body.includes('schema') || body.includes('manifest')) {
              labels.push('component:schema');
            }
            if (body.includes('cli') || body.includes('command')) {
              labels.push('component:cli');
            }
            if (body.includes('extension') || body.includes('cursor') || body.includes('langchain')) {
              labels.push('component:extensions');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });

      - name: Welcome Comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const author = issue.user.login;

            const welcomeMessage = `## üëã Thanks for opening an issue, @${author}!

We appreciate your feedback on **OSSA (Open Standard for Scalable AI Agents)**.

### üìã What happens next?

1. **üè∑Ô∏è Auto-Labeling** - Issue has been automatically labeled based on content
2. **üîó GitLab Sync** - This issue will be synced to our [GitLab repository](https://gitlab.com/blueflyio/openstandardagents/-/issues)
3. **üëÄ Triage** - Core team will review within 24-48 hours
4. **üí¨ Updates** - You'll be notified here when there's progress

### üîç Quick Links

- üìñ [Documentation](https://openstandardagents.org)
- üí¨ [Discord Community](https://discord.gg/ossa)
- ü¶ä [GitLab Issues](https://gitlab.com/blueflyio/openstandardagents/-/issues)

---

*This repository is a public mirror. Active development happens on [GitLab](https://gitlab.com/blueflyio/openstandardagents).*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: welcomeMessage
            });

      - name: Notify GitLab Agent Platform
        if: ${{ secrets.GITLAB_WEBHOOK_URL }}
        run: |
          curl -X POST "${{ secrets.GITLAB_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: issues" \
            -d '{
              "event": "github_issue_opened",
              "issue_number": ${{ github.event.issue.number }},
              "issue_title": "${{ github.event.issue.title }}",
              "issue_url": "${{ github.event.issue.html_url }}",
              "author": "${{ github.event.issue.user.login }}"
            }'

  # Sync issue closure
  sync-issue-close:
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Log Closure
        run: |
          echo "Issue #${{ github.event.issue.number }} closed"
          echo "Closed by: ${{ github.event.sender.login }}"

  # Sync new comments
  sync-comment:
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Notify GitLab of Comment
        if: ${{ secrets.GITLAB_WEBHOOK_URL }}
        run: |
          # Skip bot comments
          if [[ "${{ github.event.comment.user.login }}" == *"bot"* ]]; then
            echo "Skipping bot comment"
            exit 0
          fi

          curl -X POST "${{ secrets.GITLAB_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: issue_comment" \
            -d '{
              "event": "github_comment_created",
              "issue_number": ${{ github.event.issue.number }},
              "comment_url": "${{ github.event.comment.html_url }}",
              "author": "${{ github.event.comment.user.login }}"
            }'
