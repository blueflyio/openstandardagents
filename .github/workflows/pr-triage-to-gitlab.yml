name: PR Triage to GitLab

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Triage new PRs and create corresponding GitLab MR
  triage-pr:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Welcome and Triage
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const prTitle = pr.title;
            const prBody = pr.body || '';
            const author = pr.user.login;

            // Add triage label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['github-pr', 'needs-triage']
            });

            // Welcome message with GitLab sync info
            const welcomeMessage = `## üëã Welcome @${author}!

Thank you for your contribution to **OSSA (Open Standard for Scalable AI Agents)**!

### üìã Triage Process

This GitHub repository is a **public mirror** of our [GitLab repository](https://gitlab.com/blueflyio/openstandardagents). Here's what happens next:

1. **ü§ñ Automated Triage** - Your PR will be analyzed by our OSSA-powered agents
2. **üîó GitLab Sync** - If approved, a corresponding MR will be created on GitLab
3. **‚úÖ Review & Merge** - Core team reviews on GitLab where CI/CD runs
4. **üîÑ Auto-Close** - This PR auto-closes when changes sync back to GitHub

### üìù PR Details

| Field | Value |
|-------|-------|
| Title | \`${prTitle}\` |
| Author | @${author} |
| Files Changed | ${pr.changed_files} |
| Additions | +${pr.additions} |
| Deletions | -${pr.deletions} |

### ‚è±Ô∏è Timeline

We aim to triage within **24-48 hours**. For urgent issues, please also file an issue on [GitLab](https://gitlab.com/blueflyio/openstandardagents/-/issues).

---

*ü¶ä [GitLab Repository](https://gitlab.com/blueflyio/openstandardagents) | üìñ [Documentation](https://openstandardagents.org) | üí¨ [Discord](https://discord.gg/ossa)*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: welcomeMessage
            });

      - name: Notify GitLab Agent Platform
        if: ${{ secrets.GITLAB_WEBHOOK_URL }}
        run: |
          curl -X POST "${{ secrets.GITLAB_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: pull_request" \
            -d '{
              "event": "github_pr_opened",
              "pr_number": ${{ github.event.pull_request.number }},
              "pr_title": "${{ github.event.pull_request.title }}",
              "pr_url": "${{ github.event.pull_request.html_url }}",
              "author": "${{ github.event.pull_request.user.login }}",
              "head_sha": "${{ github.event.pull_request.head.sha }}",
              "base_branch": "${{ github.event.pull_request.base.ref }}"
            }'

  # Sync PR updates to GitLab
  sync-pr-updates:
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      - name: Notify GitLab of PR Update
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: 'üîÑ PR updated. Changes will be synced to GitLab MR.'
            });

  # Handle review comments - sync to GitLab
  sync-review:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    steps:
      - name: Log Review
        run: |
          echo "Review submitted: ${{ github.event.review.state }}"
          echo "Reviewer: ${{ github.event.review.user.login }}"

  # Auto-close PRs that duplicate existing GitLab MRs
  check-duplicate:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Check for Duplicate
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Check if this is a bot PR (from GitLab sync)
            if (pr.user.login === 'github-actions[bot]' || pr.user.login === 'gitlab-mirror') {
              console.log('Skipping bot PR');
              return;
            }

            // Check if PR title matches existing GitLab MR pattern
            const mrPattern = /^(feat|fix|docs|refactor|test|chore|perf)(\(.+\))?!?:/;
            if (!mrPattern.test(pr.title)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `‚ö†Ô∏è **PR Title Format**

Please use [Conventional Commits](https://www.conventionalcommits.org/) format:
- \`feat: add new feature\`
- \`fix: resolve bug\`
- \`docs: update documentation\`

This helps with automated changelog generation and semantic versioning.`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['needs-title-fix']
              });
            }
