stages:
  - build
  - deploy

variables:
  CONTAINER_IMAGE: ${CI_REGISTRY_IMAGE}/website:${CI_COMMIT_REF_SLUG}
  CONTAINER_IMAGE_LATEST: ${CI_REGISTRY_IMAGE}/website:latest

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - cd ..
    - docker build -t ${CONTAINER_IMAGE} -t ${CONTAINER_IMAGE_LATEST} -f website/Dockerfile .
    - docker push ${CONTAINER_IMAGE}
    - docker push ${CONTAINER_IMAGE_LATEST}
  only:
    - main
    - development
  tags:
    - docker

# Deploy to GitLab Pages (static fallback using nginx)
pages:
  stage: deploy
  image: node:20-alpine
  script:
    - cd website
    - npm ci --legacy-peer-deps
    - npm run fetch-versions
    - npm run sync-version
    - npm run generate-examples
    # Start dev server, wait, then wget static files
    - npm run dev &
    - sleep 30
    - mkdir -p public
    - wget -r -np -nH --cut-dirs=0 -P public http://localhost:3000/ || true
    - wget -r -np -nH --cut-dirs=0 -P public http://localhost:3000/docs/ || true
    - wget -r -np -nH --cut-dirs=0 -P public http://localhost:3000/examples/ || true
    - wget -r -np -nH --cut-dirs=0 -P public http://localhost:3000/schema/ || true
    - wget -r -np -nH --cut-dirs=0 -P public http://localhost:3000/playground/ || true
    - pkill -f "next dev" || true
    # Move public to correct location
    - mv public ../public
  artifacts:
    paths:
      - public
  only:
    - main
