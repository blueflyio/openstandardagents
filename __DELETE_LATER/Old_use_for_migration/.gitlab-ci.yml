# OpenAPI AI Agents Standard - Comprehensive CI/CD Pipeline
# Uses latest components from https://gitlab.bluefly.io/llm/gitlab_components

stages:
  - validate
  - test
  - security
  - build
  - publish
  - deploy
  - pages

variables:
  # Project configuration
  PROJECT_NAME: "openapi-ai-agents-standard"
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.11"
  
  # Component configuration
  AGENT_SPEC: "examples/04-agent-enterprise/openapi.yaml"
  CERTIFICATION_TARGET: "gold"
  TOKEN_BUDGET: 1000000
  SECURITY_SCAN_LEVEL: "comprehensive"
  
  # Build configuration
  BUILD_DIR: "dist"
  PAGES_DIR: "public"
  
  # Cache configuration
  CACHE_KEY: "${CI_COMMIT_REF_SLUG}-${CI_PROJECT_ID}"

# Include latest components from GitLab Components repository
include:
  # Agent validation and compliance
  - component: gitlab.bluefly.io/llm/gitlab_components/agent-validator@latest
    inputs:
      agent-spec-file: "examples/04-agent-enterprise/openapi.yaml"
      certification-target: "gold"
      strict-mode: true
      output-format: "json"
  
  # Token monitoring and optimization
  - component: gitlab.bluefly.io/llm/gitlab_components/token-monitor@latest
    inputs:
      token-budget: 1000000
      alert-threshold: 80
      optimization-level: "aggressive"
      tiktoken-encoding: "cl100k_base"
  
  # Security scanning
  - component: gitlab.bluefly.io/llm/gitlab_components/security-scan@latest
    inputs:
      scan-level: "comprehensive"
      frameworks: ["maestro", "owasp", "cis"]
      fail-on-critical: true
      generate-sbom: true
  
  # Agent deployment
  - component: gitlab.bluefly.io/llm/gitlab_components/agent-deploy@latest
    inputs:
      environment: "staging"
      protocol-bridges: ["mcp", "a2a", "openapi"]
      health-check: true
      rollback-on-failure: true

# Base configuration for all jobs
.base_config:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache git jq curl python3 py3-pip
    - npm config set registry https://registry.npmjs.org/
    - npm install -g npm@latest

# Validation stage
validate:project-structure:
  extends: .base_config
  stage: validate
  script:
    - echo "üîç Validating project structure..."
    - |
      # Check required directories exist
      for dir in docs examples schemas services; do
        if [ ! -d "$dir" ]; then
          echo "‚ùå Missing required directory: $dir"
          exit 1
        fi
        echo "‚úÖ Found directory: $dir"
      done
    - |
      # Validate all OpenAPI specifications
      echo "üìÑ Validating OpenAPI specifications..."
      for spec in examples/*/openapi.yaml; do
        if [ -f "$spec" ]; then
          echo "Validating $spec..."
          npx @apidevtools/swagger-parser validate "$spec" || exit 1
        fi
      done
    - |
      # Validate all agent configurations
      echo "ü§ñ Validating agent configurations..."
      for agent in examples/*/agent.yml; do
        if [ -f "$agent" ]; then
          echo "Validating $agent..."
          # Basic YAML validation
          python3 -c "import yaml; yaml.safe_load(open('$agent'))" || exit 1
        fi
      done
  artifacts:
    reports:
      junit: validation-results.xml
    paths:
      - validation-results.xml
    expire_in: 1 week

validate:services:
  extends: .base_config
  stage: validate
  script:
    - echo "üîß Validating services..."
    - cd services
    - npm ci
    - npm run build
    - npm run test
    - |
      # Validate TypeScript compilation
      echo "üìù Validating TypeScript compilation..."
      npx tsc --noEmit
    - |
      # Validate service APIs
      echo "üåê Validating service APIs..."
      for service in src/*; do
        if [ -d "$service" ]; then
          echo "Validating service: $service"
          # Check for proper exports and interfaces
          if [ -f "$service/index.ts" ]; then
            npx tsc --noEmit "$service/index.ts" || exit 1
          fi
        fi
      done
  artifacts:
    paths:
      - services/dist/
    expire_in: 1 week

# Testing stage
test:unit:
  extends: .base_config
  stage: test
  script:
    - echo "üß™ Running unit tests..."
    - cd services
    - npm ci
    - npm run test:coverage
    - |
      # Generate test coverage report
      echo "üìä Generating coverage report..."
      npx nyc report --reporter=text --reporter=json
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: services/coverage/cobertura-coverage.xml
    paths:
      - services/coverage/
    expire_in: 1 week

test:integration:
  extends: .base_config
  stage: test
  script:
    - echo "üîó Running integration tests..."
    - cd services
    - npm ci
    - npm run build
    - |
      # Test OAAS service integration
      echo "üîß Testing OAAS service integration..."
      node -e "
        const { OAASService } = require('./dist/index.js');
        const service = new OAASService({ projectRoot: '.' });
        console.log('‚úÖ OAAS Service loaded successfully');
      "
    - |
      # Test discovery engine
      echo "üîç Testing discovery engine..."
      node -e "
        const { DiscoveryEngine } = require('./dist/discovery/DiscoveryEngine.js');
        const engine = new DiscoveryEngine({ projectRoot: '.' });
        console.log('‚úÖ Discovery Engine loaded successfully');
      "
  artifacts:
    paths:
      - services/test-results/
    expire_in: 1 week

# Security stage
security:dependency-scan:
  extends: .base_config
  stage: security
  script:
    - echo "üîí Running dependency security scan..."
    - cd services
    - npm ci
    - |
      # Run npm audit
      echo "üìã Running npm audit..."
      npm audit --audit-level=moderate --json > audit-results.json || true
      cat audit-results.json | jq '.vulnerabilities | length' || echo "0"
    - |
      # Check for known vulnerabilities
      echo "‚ö†Ô∏è Checking for critical vulnerabilities..."
      CRITICAL=$(cat audit-results.json | jq '.vulnerabilities | to_entries[] | select(.value.severity == "critical") | .key' | wc -l)
      if [ "$CRITICAL" -gt 0 ]; then
        echo "‚ùå Found $CRITICAL critical vulnerabilities"
        exit 1
      fi
      echo "‚úÖ No critical vulnerabilities found"
  artifacts:
    paths:
      - services/audit-results.json
    expire_in: 1 week

# Build stage
build:services:
  extends: .base_config
  stage: build
  script:
    - echo "üèóÔ∏è Building services..."
    - cd services
    - npm ci
    - npm run build
    - |
      # Create production build
      echo "üì¶ Creating production build..."
      npm run build:production || npm run build
    - |
      # Generate API documentation
      echo "üìö Generating API documentation..."
      npx typedoc --out ../public/api-docs src/index.ts || echo "TypeDoc not available"
  artifacts:
    paths:
      - services/dist/
      - public/
    expire_in: 1 week

build:documentation:
  extends: .base_config
  stage: build
  script:
    - echo "üìñ Building documentation..."
    - |
      # Create public directory for GitLab Pages
      mkdir -p public
      
      # Copy documentation
      echo "üìã Copying documentation..."
      cp -r docs/* public/
      
      # Generate index page
      echo "üè† Generating index page..."
      cat > public/index.html << 'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>OpenAPI AI Agents Standard - Documentation</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui.css">
          <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; }
              .nav { display: flex; gap: 1rem; margin-bottom: 2rem; }
              .nav a { padding: 0.5rem 1rem; background: #f8f9fa; border-radius: 4px; text-decoration: none; color: #333; }
              .nav a:hover { background: #e9ecef; }
              .api-section { margin: 2rem 0; }
              .swagger-ui { margin-top: 2rem; }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>OpenAPI AI Agents Standard</h1>
              <p>Universal interoperability framework for AI agents with enterprise compliance</p>
          </div>
          
          <nav class="nav">
              <a href="#overview">Overview</a>
              <a href="#getting-started">Getting Started</a>
              <a href="#api-docs">API Documentation</a>
              <a href="#examples">Examples</a>
              <a href="#compliance">Compliance</a>
          </nav>
          
          <section id="overview">
              <h2>Overview</h2>
              <p>The OpenAPI AI Agents Standard (OAAS) establishes the definitive technical framework for universal AI agent interoperability in enterprise environments.</p>
              <ul>
                  <li><strong>Universal Protocol Translation</strong>: Runtime translation between MCP, LangChain, CrewAI, and custom protocols</li>
                  <li><strong>Enterprise Compliance</strong>: Built-in automation for ISO 42001, NIST AI RMF, and EU AI Act</li>
                  <li><strong>Production Ready</strong>: Sub-100ms discovery, 35-45% token optimization, comprehensive monitoring</li>
              </ul>
          </section>
          
          <section id="getting-started">
              <h2>Getting Started</h2>
              <p>Implementation guide and reference examples for OAAS integration.</p>
              <ul>
                  <li><a href="getting-started.html">Getting Started Guide</a></li>
                  <li><a href="examples/01-agent-basic/">Foundation Agent Example</a></li>
                  <li><a href="examples/02-agent-integration/">Integration Example</a></li>
              </ul>
          </section>
          
          <section id="api-docs" class="api-section">
              <h2>API Documentation</h2>
              <p>Comprehensive API documentation with interactive Swagger UI.</p>
              <div id="swagger-ui"></div>
          </section>
          
          <section id="examples">
              <h2>Examples</h2>
              <p>Production-ready examples and templates for different use cases.</p>
              <ul>
                  <li><a href="examples/01-agent-basic/">Basic Agent</a> - Simple agent with basic capabilities</li>
                  <li><a href="examples/02-agent-integration/">Integration Agent</a> - Multi-framework integration</li>
                  <li><a href="examples/03-agent-production/">Production Agent</a> - Production-ready with security</li>
                  <li><a href="examples/04-agent-enterprise/">Enterprise Agent</a> - Full compliance and governance</li>
              </ul>
          </section>
          
          <section id="compliance">
              <h2>Compliance & Governance</h2>
              <p>Enterprise compliance frameworks and governance models.</p>
              <ul>
                  <li><a href="03-governance-compliance.html">Governance & Compliance</a></li>
                  <li><a href="04-enterprise-integrations.html">Enterprise Integrations</a></li>
              </ul>
          </section>
          
          <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui-bundle.js"></script>
          <script>
              // Load the main OpenAPI specification
              SwaggerUIBundle({
                  url: 'examples/04-agent-enterprise/openapi.yaml',
                  dom_id: '#swagger-ui',
                  presets: [
                      SwaggerUIBundle.presets.apis,
                      SwaggerUIBundle.presets.standalone
                  ],
                  layout: "StandaloneLayout",
                  deepLinking: true,
                  showExtensions: true,
                  showCommonExtensions: true
              });
          </script>
      </body>
      </html>
      EOF
      
      # Generate OpenAPI specifications index
      echo "üìã Generating OpenAPI specifications index..."
      cat > public/api-specs.html << 'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>OpenAPI Specifications - OAAS</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui.css">
          <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; }
              .spec-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 2rem 0; }
              .spec-card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; }
              .spec-card h3 { margin-top: 0; color: #333; }
              .spec-card p { color: #666; }
              .spec-card a { display: inline-block; margin-top: 0.5rem; padding: 0.5rem 1rem; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
              .spec-card a:hover { background: #0056b3; }
          </style>
      </head>
      <body>
          <h1>OpenAPI Specifications</h1>
          <p>Interactive API documentation for all OAAS agent examples and services.</p>
          
          <div class="spec-grid">
              <div class="spec-card">
                  <h3>Basic Agent</h3>
                  <p>Simple agent with basic capabilities and MCP integration.</p>
                  <a href="examples/01-agent-basic/openapi.yaml" target="_blank">View Specification</a>
              </div>
              
              <div class="spec-card">
                  <h3>Integration Agent</h3>
                  <p>Multi-framework integration with LangChain, CrewAI, and OpenAI support.</p>
                  <a href="examples/02-agent-integration/openapi.yaml" target="_blank">View Specification</a>
              </div>
              
              <div class="spec-card">
                  <h3>Production Agent</h3>
                  <p>Production-ready agent with enterprise security and monitoring.</p>
                  <a href="examples/03-agent-production/openapi.yaml" target="_blank">View Specification</a>
              </div>
              
              <div class="spec-card">
                  <h3>Enterprise Agent</h3>
                  <p>Full compliance agent with ISO 42001, NIST AI RMF, and EU AI Act support.</p>
                  <a href="examples/04-agent-enterprise/openapi.yaml" target="_blank">View Specification</a>
              </div>
          </div>
      </body>
      </html>
      EOF
      
      # Copy examples to public directory
      echo "üìÅ Copying examples..."
      cp -r examples public/
      
      # Copy schemas to public directory
      echo "üìã Copying schemas..."
      cp -r schemas public/
      
      # Generate schema documentation
      echo "üìö Generating schema documentation..."
      cat > public/schemas.html << 'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>OAAS Schemas - Documentation</title>
          <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; }
              .schema-list { list-style: none; padding: 0; }
              .schema-list li { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
              .schema-list h3 { margin-top: 0; color: #333; }
              .schema-list p { color: #666; margin-bottom: 0.5rem; }
              .schema-list a { color: #007bff; text-decoration: none; }
              .schema-list a:hover { text-decoration: underline; }
          </style>
      </head>
      <body>
          <h1>OAAS Schemas</h1>
          <p>JSON Schema definitions for OAAS agent configurations and workspace settings.</p>
          
          <ul class="schema-list">
              <li>
                  <h3>Agent Minimal</h3>
                  <p>Minimal agent configuration for basic discovery and functionality.</p>
                  <a href="schemas/agent-minimal.yml">View Schema</a>
              </li>
              
              <li>
                  <h3>Agent Basic</h3>
                  <p>Basic agent configuration with essential capabilities.</p>
                  <a href="schemas/agent-basic.yml">View Schema</a>
              </li>
              
              <li>
                  <h3>Agent Integration</h3>
                  <p>Integration-ready agent with multi-framework support.</p>
                  <a href="schemas/agent-integration.yml">View Schema</a>
              </li>
              
              <li>
                  <h3>Agent Production</h3>
                  <p>Production-grade agent with security and monitoring.</p>
                  <a href="schemas/agent-production.yml">View Schema</a>
              </li>
              
              <li>
                  <h3>Agent Enterprise</h3>
                  <p>Enterprise agent with full compliance and governance.</p>
                  <a href="schemas/agent-enterprise.yml">View Schema</a>
              </li>
              
              <li>
                  <h3>Workspace Enterprise</h3>
                  <p>Enterprise workspace configuration with advanced orchestration.</p>
                  <a href="schemas/workspace-enterprise.yml">View Schema</a>
              </li>
              
              <li>
                  <h3>Governance Configuration</h3>
                  <p>Governance and compliance configuration schemas.</p>
                  <a href="schemas/governance-configuration.yml">View Schema</a>
              </li>
              
              <li>
                  <h3>Orchestration Rules</h3>
                  <p>Agent orchestration and coordination rules.</p>
                  <a href="schemas/orchestration-rules.yml">View Schema</a>
              </li>
          </ul>
      </body>
      </html>
      EOF
  artifacts:
    paths:
      - public/
    expire_in: 1 week

# Deployment stage
deploy:staging:
  extends: .base_config
  stage: deploy
  environment:
    name: staging
    url: https://staging.openapi-ai-agents.bluefly.io
  script:
    - echo "üöÄ Deploying to staging..."
    - |
      # Deploy services to staging
      echo "üì¶ Deploying services..."
      cd services
      npm run deploy:staging || echo "Deploy script not available"
    - |
      # Health check
      echo "üè• Running health checks..."
      sleep 30
      curl -f https://staging.openapi-ai-agents.bluefly.io/health || echo "Health check failed"
  only:
    - develop
    - staging

deploy:production:
  extends: .base_config
  stage: deploy
  environment:
    name: production
    url: https://openapi-ai-agents.bluefly.io
  script:
    - echo "üöÄ Deploying to production..."
    - |
      # Deploy services to production
      echo "üì¶ Deploying services..."
      cd services
      npm run deploy:production || echo "Deploy script not available"
    - |
      # Health check
      echo "üè• Running health checks..."
      sleep 30
      curl -f https://openapi-ai-agents.bluefly.io/health || echo "Health check failed"
  only:
    - main
  when: manual

# GitLab Pages deployment
pages:
  extends: .base_config
  stage: pages
  script:
    - echo "üìÑ Deploying GitLab Pages..."
    - |
      # Ensure public directory exists
      mkdir -p public
      
      # Copy all documentation and examples
      cp -r docs/* public/ 2>/dev/null || true
      cp -r examples public/ 2>/dev/null || true
      cp -r schemas public/ 2>/dev/null || true
      
      # Generate comprehensive index
      cat > public/index.html << 'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>OpenAPI AI Agents Standard</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.9.0/swagger-ui.css">
          <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
              .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4rem 2rem; text-align: center; }
              .hero h1 { font-size: 3rem; margin: 0 0 1rem 0; }
              .hero p { font-size: 1.2rem; margin: 0 0 2rem 0; opacity: 0.9; }
              .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
              .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin: 2rem 0; }
              .card { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
              .card h3 { color: #333; margin-top: 0; }
              .card p { color: #666; }
              .card a { display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
              .card a:hover { background: #0056b3; }
              .badge { display: inline-block; padding: 0.25rem 0.5rem; background: #28a745; color: white; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem; }
          </style>
      </head>
      <body>
          <div class="hero">
              <h1>OpenAPI AI Agents Standard</h1>
              <p>Universal interoperability framework for AI agents with enterprise compliance</p>
              <span class="badge">Production Ready</span>
          </div>
          
          <div class="container">
              <div class="grid">
                  <div class="card">
                      <h3>üöÄ Getting Started</h3>
                      <p>Implementation guide and reference examples for OAAS integration.</p>
                      <a href="getting-started.html">Get Started</a>
                  </div>
                  
                  <div class="card">
                      <h3>üìö API Documentation</h3>
                      <p>Comprehensive API documentation with interactive Swagger UI for all agent examples.</p>
                      <a href="api-specs.html">View APIs</a>
                  </div>
                  
                  <div class="card">
                      <h3>üîß Examples</h3>
                      <p>Production-ready examples and templates for different use cases and compliance levels.</p>
                      <a href="examples/">Browse Examples</a>
                  </div>
                  
                  <div class="card">
                      <h3>üìã Schemas</h3>
                      <p>JSON Schema definitions for agent configurations and workspace settings.</p>
                      <a href="schemas.html">View Schemas</a>
                  </div>
                  
                  <div class="card">
                      <h3>üõ°Ô∏è Compliance</h3>
                      <p>Enterprise compliance frameworks including ISO 42001, NIST AI RMF, and EU AI Act.</p>
                      <a href="03-governance-compliance.html">Learn More</a>
                  </div>
                  
                  <div class="card">
                      <h3>üè¢ Enterprise</h3>
                      <p>Enterprise integrations and deployment guides for production environments.</p>
                      <a href="04-enterprise-integrations.html">Enterprise Guide</a>
                  </div>
              </div>
              
              <div style="margin-top: 3rem; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
                  <h2>üéØ Key Features</h2>
                  <ul style="columns: 2; column-gap: 2rem;">
                      <li>Universal Protocol Translation (MCP ‚Üî LangChain ‚Üî CrewAI)</li>
                      <li>Enterprise Compliance Automation (ISO 42001, NIST AI RMF, EU AI Act)</li>
                      <li>Sub-100ms Agent Discovery for 1000+ Agents</li>
                      <li>35-45% Token Cost Optimization</li>
                      <li>Production-Ready Security & Monitoring</li>
                      <li>Zero-Modification Integration</li>
                      <li>Progressive Certification Levels (Bronze ‚Üí Silver ‚Üí Gold)</li>
                      <li>Comprehensive Audit Trails & Governance</li>
                  </ul>
              </div>
          </div>
      </body>
      </html>
      EOF
  artifacts:
    paths:
      - public
  only:
    - main
    - develop

# Dual Registry Publishing
publish:private:
  stage: publish
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - echo "Publishing OSSA $CI_COMMIT_TAG to private registry..."
    - npm run publish:private
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_NAME != "main"
  environment:
    name: private-registry
    url: https://gitlab.bluefly.io/llm/openapi-ai-agents-standard/-/packages

publish:public:
  stage: publish
  image: node:18-alpine
  before_script:
    - npm ci
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
  script:
    - echo "Publishing OSSA $CI_COMMIT_TAG to npmjs.org..."
    - npm run publish:public
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_NAME == "main"
  environment:
    name: npm-public
    url: https://www.npmjs.com/package/@bluefly/open-standards-scalable-agents
  when: manual

# Cache configuration
cache:
  key: ${CACHE_KEY}
  paths:
    - services/node_modules/
    - .npm/
  policy: pull-push
