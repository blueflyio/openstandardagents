# GitLab CI Component: OpenAPI AI Agent Validator
# Version: 1.0.0
# 
# This component validates OpenAPI specifications against the AI Agents standard
# and provides certification level assessment.
#
# Usage:
#   include:
#     - component: gitlab.com/openapi-ai-agents/components/agent-validator@1.0.0
#   
#   variables:
#     AGENT_SPEC_FILE: "openapi.yaml"  # Your OpenAPI spec file
#     CERTIFICATION_TARGET: "silver"    # Target certification level

spec:
  inputs:
    agent-spec-file:
      description: "Path to OpenAPI specification file"
      default: "openapi.yaml"
    certification-target:
      description: "Target certification level (bronze|silver|gold)"
      default: "silver"
      options:
        - bronze
        - silver
        - gold
    strict-mode:
      description: "Enable strict validation mode"
      default: false
      type: boolean
    output-format:
      description: "Output format for validation report"
      default: "text"
      options:
        - text
        - json
        - junit
        - markdown

---

.agent-validator-base:
  image: node:18-alpine
  before_script:
    - apk add --no-cache git jq
    - npm install -g @openapi-ai-agents/validators@latest
  variables:
    AGENT_SPEC_FILE: $[[ inputs.agent-spec-file ]]
    CERTIFICATION_TARGET: $[[ inputs.certification-target ]]
    STRICT_MODE: $[[ inputs.strict-mode ]]
    OUTPUT_FORMAT: $[[ inputs.output-format ]]

validate:openapi-spec:
  extends: .agent-validator-base
  stage: validate
  script:
    - echo "ğŸ” Validating OpenAPI specification..."
    - echo "ğŸ“„ Spec file: $AGENT_SPEC_FILE"
    - echo "ğŸ¯ Target certification: $CERTIFICATION_TARGET"
    - |
      # Check if spec file exists
      if [ ! -f "$AGENT_SPEC_FILE" ]; then
        echo "âŒ Error: OpenAPI spec file not found: $AGENT_SPEC_FILE"
        exit 1
      fi
    - |
      # Run validation
      VALIDATION_CMD="openapi-agent-validate $AGENT_SPEC_FILE"
      
      if [ "$STRICT_MODE" = "true" ]; then
        VALIDATION_CMD="$VALIDATION_CMD --strict"
      fi
      
      if [ "$OUTPUT_FORMAT" != "text" ]; then
        VALIDATION_CMD="$VALIDATION_CMD --format $OUTPUT_FORMAT"
      fi
      
      if [ "$OUTPUT_FORMAT" = "json" ]; then
        $VALIDATION_CMD > validation-report.json
        
        # Extract key metrics
        ERRORS=$(jq '.errors | length' validation-report.json)
        WARNINGS=$(jq '.warnings | length' validation-report.json)
        CERT_LEVEL=$(jq -r '.certification_level' validation-report.json)
        
        echo "ğŸ“Š Validation Results:"
        echo "   Errors: $ERRORS"
        echo "   Warnings: $WARNINGS"
        echo "   Achieved Certification: $CERT_LEVEL"
        
        # Check if target certification met
        if [ "$CERT_LEVEL" != "$CERTIFICATION_TARGET" ] && [ "$CERT_LEVEL" != "gold" ]; then
          echo "âš ï¸ Warning: Target certification ($CERTIFICATION_TARGET) not achieved"
          if [ "$STRICT_MODE" = "true" ]; then
            exit 1
          fi
        fi
      else
        $VALIDATION_CMD
      fi
    - |
      # Generate GitLab badge
      if [ "$OUTPUT_FORMAT" = "json" ] && [ -f "validation-report.json" ]; then
        CERT_LEVEL=$(jq -r '.certification_level' validation-report.json)
        echo "CERTIFICATION_LEVEL=$CERT_LEVEL" > validation.env
        
        # Create badge metadata
        echo "{\"certification\": \"$CERT_LEVEL\"}" > badge.json
      fi
  artifacts:
    reports:
      dotenv: validation.env
      junit: $OUTPUT_FORMAT == "junit" && validation-report.xml || null
    paths:
      - validation-report.*
      - badge.json
    expire_in: 1 week
  cache:
    key: agent-validator-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

validate:agent-config:
  extends: .agent-validator-base
  stage: validate
  script:
    - echo "ğŸ¤– Validating agent configuration..."
    - |
      # Check for agent.yml
      if [ -f "agent.yml" ]; then
        echo "ğŸ“„ Found agent.yml"
        agent-config-validate agent.yml --format $OUTPUT_FORMAT
      elif [ -f "agent.yaml" ]; then
        echo "ğŸ“„ Found agent.yaml"
        agent-config-validate agent.yaml --format $OUTPUT_FORMAT
      else
        echo "âš ï¸ No agent configuration file found (agent.yml or agent.yaml)"
        echo "   This is optional but recommended for full compliance"
      fi
  artifacts:
    paths:
      - agent-validation-report.*
    expire_in: 1 week
  allow_failure: true

validate:breaking-changes:
  extends: .agent-validator-base
  stage: validate
  script:
    - echo "ğŸ”„ Checking for breaking changes..."
    - npm install -g @openapitools/openapi-diff
    - |
      if [ "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" ]; then
        echo "ğŸ“Š Comparing against $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
        
        # Fetch target branch
        git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
        
        # Check if spec exists in target branch
        if git show origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME:$AGENT_SPEC_FILE > /dev/null 2>&1; then
          # Run diff
          openapi-diff \
            origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME:$AGENT_SPEC_FILE \
            HEAD:$AGENT_SPEC_FILE \
            --json > breaking-changes.json
          
          # Check for breaking changes
          if [ -s breaking-changes.json ]; then
            BREAKING=$(jq '.breakingChanges | length' breaking-changes.json)
            if [ "$BREAKING" -gt 0 ]; then
              echo "âŒ Found $BREAKING breaking changes:"
              jq '.breakingChanges' breaking-changes.json
              
              if [ "$STRICT_MODE" = "true" ]; then
                exit 1
              fi
            else
              echo "âœ… No breaking changes detected"
            fi
          fi
        else
          echo "â„¹ï¸ OpenAPI spec not found in target branch - skipping comparison"
        fi
      else
        echo "â„¹ï¸ Not a merge request - skipping breaking change detection"
      fi
  artifacts:
    paths:
      - breaking-changes.json
    expire_in: 1 week
  only:
    - merge_requests

validate:compliance-ready:
  extends: .agent-validator-base
  stage: validate
  script:
    - echo "ğŸ“‹ Checking compliance readiness..."
    - |
      # Quick compliance check
      COMPLIANCE_CHECK=$(openapi-agent-validate $AGENT_SPEC_FILE --check-compliance --format json)
      
      echo "$COMPLIANCE_CHECK" | jq '{
        iso_42001_ready: .compliance.iso_42001,
        nist_ai_rmf_ready: .compliance.nist_ai_rmf,
        eu_ai_act_ready: .compliance.eu_ai_act,
        certification_level: .certification_level
      }' > compliance-readiness.json
      
      cat compliance-readiness.json
  artifacts:
    paths:
      - compliance-readiness.json
    expire_in: 1 week

# Summary job that runs after all validations
validate:summary:
  extends: .agent-validator-base
  stage: validate
  needs:
    - validate:openapi-spec
    - validate:agent-config
    - validate:breaking-changes
    - validate:compliance-ready
  script:
    - echo "ğŸ“Š Validation Summary"
    - echo "===================="
    - |
      # Collect all validation results
      if [ -f "validation-report.json" ]; then
        echo "âœ… OpenAPI Specification: Valid"
        echo "ğŸ† Certification Level: $(jq -r '.certification_level' validation-report.json)"
      fi
      
      if [ -f "agent-validation-report.json" ]; then
        echo "âœ… Agent Configuration: Valid"
      fi
      
      if [ -f "breaking-changes.json" ]; then
        BREAKING=$(jq '.breakingChanges | length' breaking-changes.json 2>/dev/null || echo "0")
        if [ "$BREAKING" -eq 0 ]; then
          echo "âœ… Breaking Changes: None"
        else
          echo "âš ï¸ Breaking Changes: $BREAKING found"
        fi
      fi
      
      if [ -f "compliance-readiness.json" ]; then
        echo "ğŸ“‹ Compliance Status:"
        cat compliance-readiness.json | jq -r 'to_entries[] | "   \(.key): \(.value)"'
      fi
      
      echo ""
      echo "ğŸ‰ Validation pipeline complete!"
  artifacts:
    paths:
      - validation-summary.txt
    expire_in: 1 week
  when: always