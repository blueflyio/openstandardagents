# Enterprise Orchestration Rules - Production-Grade Multi-Agent Coordination
# OpenAPI AI Agents Standard (OSSA) v0.1.8

ossa: "0.1.8"
kind: "OrchestrationRules"
metadata:
  name: "enterprise-orchestration-rules"
  version: "1.0.0"
  description: "Production-grade orchestration rules for cross-project agent coordination"
  annotations:
    compliance/frameworks: "iso-42001,nist-ai-rmf,eu-ai-act"
    security/classification: "internal"
    monitoring/enabled: "true"

spec:
  # === ROUTING RULES ===
  routing_rules:
    # Default routing strategy
    default_strategy: "intelligent_routing"  # capability_match | load_balance | priority | intelligent_routing
    fallback_strategy: "round_robin"
    cache_routing_decisions: true
    cache_ttl: 300  # 5 minutes
    
    # Capability-based routing with intelligence
    capability_routing:
      - capability: "code_analysis"
        required_confidence: 0.85
        preferred_projects: ["backend-api", "frontend-app", "mobile-app"]
        fallback_projects: ["general-purpose-agent"]
        load_balancing: "weighted_round_robin"
        weights:
          backend-api: 0.5
          frontend-app: 0.3
          mobile-app: 0.2
        health_check_required: true
        timeout: 30000  # 30 seconds
        
      - capability: "security_scanning"
        required_confidence: 0.95
        preferred_projects: ["security-scanner", "vulnerability-assessor"]
        fallback_projects: []  # No fallback for security
        load_balancing: "least_latency"
        require_certification: "gold"
        isolation_level: "strict"
        audit_trail: true
        
      - capability: "data_processing"
        required_confidence: 0.80
        preferred_projects: ["data-pipeline", "ml-platform", "analytics-engine"]
        fallback_projects: ["batch-processor"]
        load_balancing: "resource_aware"
        resource_thresholds:
          cpu: 80
          memory: 85
          gpu: 90
        queue_overflow_strategy: "elastic_scaling"
        
      - capability: "compliance_validation"
        required_confidence: 0.99
        preferred_projects: ["compliance-validator", "audit-engine"]
        fallback_projects: []  # No fallback for compliance
        load_balancing: "priority_based"
        require_certification: "gold"
        require_human_review: true
        audit_trail: true
        retention_period: "7y"
        
    # Domain-based routing with expertise matching
    domain_routing:
      - domain: "machine_learning"
        expertise_required: ["deep_learning", "nlp", "computer_vision"]
        route_to_projects: ["ml-platform", "ai-research", "model-serving"]
        confidence_threshold: 0.85
        gpu_required: true
        
      - domain: "financial_services"
        expertise_required: ["risk_analysis", "fraud_detection", "compliance"]
        route_to_projects: ["fintech-engine", "risk-analyzer", "compliance-checker"]
        confidence_threshold: 0.95
        compliance_requirements: ["sox", "pci-dss"]
        
      - domain: "healthcare"
        expertise_required: ["medical_knowledge", "hipaa_compliance", "clinical_trials"]
        route_to_projects: ["healthcare-ai", "clinical-analyzer", "patient-care"]
        confidence_threshold: 0.98
        compliance_requirements: ["hipaa", "gdpr"]
        data_residency: "us-east-1"
        
    # Team-based routing with RBAC
    team_routing:
      engineering:
        allowed_projects: ["backend-api", "frontend-app", "mobile-app", "devops-tools"]
        priority: "high"
        rate_limit: 1000  # requests per minute
        budget_limit: 10000  # tokens per hour
        
      data_science:
        allowed_projects: ["ml-platform", "data-pipeline", "analytics-engine", "research"]
        priority: "high"
        rate_limit: 500
        budget_limit: 50000  # Higher token budget for ML
        gpu_access: true
        
      security:
        allowed_projects: ["*"]  # Security team can access all
        priority: "critical"
        rate_limit: "unlimited"
        budget_limit: "unlimited"
        bypass_queue: true
        audit_exempt: false
        
      compliance:
        allowed_projects: ["compliance-validator", "audit-engine", "risk-analyzer"]
        priority: "critical"
        rate_limit: 200
        budget_limit: 5000
        require_mfa: true
        
    # Cost-based routing
    cost_optimization:
      enabled: true
      strategies:
        - name: "token_budget_routing"
          max_tokens_per_request: 4096
          max_cost_per_request: 0.50  # USD
          prefer_cached_responses: true
          
        - name: "model_selection"
          prefer_smaller_models: true
          fallback_on_budget_exceeded: true
          alert_on_threshold: 80  # percent
          
  # === ORCHESTRATION PATTERNS ===
  orchestration_patterns:
    # Sequential execution pattern
    sequential:
      - name: "code_review_pipeline"
        description: "Enterprise code review process with security validation"
        retry_on_failure: true
        max_retries: 3
        steps:
          - name: "static_analysis"
            project: "code-analyzer"
            agent: "static-analyzer"
            timeout: "30s"
            required: true
            on_failure: "stop"
            
          - name: "security_scan"
            project: "security-scanner"
            agent: "vulnerability-scanner"
            timeout: "60s"
            required: true
            on_failure: "alert_security"
            
          - name: "compliance_check"
            project: "compliance-validator"
            agent: "code-compliance"
            timeout: "45s"
            required: false
            on_failure: "continue_with_warning"
            
          - name: "generate_report"
            project: "reporting-engine"
            agent: "report-generator"
            timeout: "20s"
            required: true
            on_failure: "retry"
            
    # Parallel execution pattern
    parallel:
      - name: "multi_project_validation"
        description: "Validate across multiple projects simultaneously"
        max_parallel: 10
        timeout_strategy: "wait_for_all"
        groups:
          - name: "application_validation"
            projects: ["backend-api", "frontend-app", "mobile-app"]
            agent_type: "validator"
            max_parallel: 3
            collect_metrics: true
            
          - name: "infrastructure_validation"
            projects: ["kubernetes-cluster", "database-layer", "cache-layer"]
            agent_type: "infrastructure-validator"
            max_parallel: 3
            require_healthy_state: true
            
    # Fan-out/fan-in pattern
    fanout:
      - name: "workspace_security_audit"
        description: "Comprehensive security audit across all projects"
        fanout:
          target: "all_projects"
          filter: "production_only"
          agent: "security-auditor"
          batch_size: 5
          parallel_batches: 2
          collect_results: true
          
        fanin:
          aggregation: "security-dashboard"
          aggregation_strategy: "merge_findings"
          deduplication: true
          severity_threshold: "medium"
          
    # Pipeline pattern
    pipeline:
      - name: "ml_training_pipeline"
        description: "End-to-end ML model training pipeline"
        stages:
          - name: "data_preparation"
            project: "data-pipeline"
            agents: ["data-cleaner", "feature-engineer"]
            parallel: true
            
          - name: "model_training"
            project: "ml-platform"
            agents: ["model-trainer"]
            gpu_required: true
            checkpoint_enabled: true
            
          - name: "model_evaluation"
            project: "ml-platform"
            agents: ["model-evaluator", "bias-detector"]
            parallel: true
            
          - name: "deployment_preparation"
            project: "model-serving"
            agents: ["model-packager", "deployment-validator"]
            parallel: false
            
    # Map-reduce pattern
    mapreduce:
      - name: "distributed_analysis"
        description: "Large-scale distributed data analysis"
        map:
          splitter: "data-splitter"
          chunk_size: "1GB"
          parallel_mappers: 20
          mapper_agent: "data-analyzer"
          
        reduce:
          reducer_agent: "result-aggregator"
          reduction_strategy: "hierarchical"
          intermediate_storage: "s3://temp-results/"
          
    # Circuit breaker pattern
    circuit_breaker:
      - name: "external_api_orchestration"
        description: "Orchestration with external API circuit breaking"
        threshold: 5  # failures
        timeout: 30000  # ms
        reset_timeout: 60000  # ms
        half_open_requests: 3
        
        states:
          closed:
            allow_requests: true
            monitor_failures: true
            
          open:
            allow_requests: false
            fallback: "cached_response"
            alert: "operations"
            
          half_open:
            allow_requests: "limited"
            test_requests: 3
            
  # === COORDINATION STRATEGIES ===
  coordination:
    # Consensus mechanisms
    consensus:
      default_mechanism: "majority_vote"
      mechanisms:
        majority_vote:
          required_votes: 0.51
          timeout: 10000
          
        unanimous:
          required_votes: 1.0
          timeout: 30000
          
        weighted:
          weight_by: "expertise_score"
          threshold: 0.75
          
        quorum:
          minimum_participants: 3
          required_agreement: 0.66
          
    # Conflict resolution
    conflict_resolution:
      default_strategy: "expertise_weighted"
      strategies:
        expertise_weighted:
          factors: ["certification_level", "success_rate", "domain_match"]
          
        seniority_based:
          factors: ["deployment_date", "version", "usage_count"]
          
        performance_based:
          factors: ["latency", "accuracy", "cost_efficiency"]
          
        human_override:
          require_approval: true
          approvers: ["tech-lead", "architect"]
          
    # Load balancing algorithms
    load_balancing:
      algorithms:
        round_robin:
          reset_counter: 1000
          
        weighted_round_robin:
          weight_update_interval: 300  # seconds
          
        least_connections:
          connection_tracking: true
          
        least_latency:
          latency_window: "5m"
          percentile: 95
          
        resource_aware:
          metrics: ["cpu", "memory", "gpu", "tokens"]
          threshold_based: true
          
        intelligent:
          ml_model: "load-predictor"
          features: ["time_of_day", "request_type", "historical_load"]
          
  # === MONITORING & OBSERVABILITY ===
  monitoring:
    # Metrics collection
    metrics:
      enabled: true
      interval: "15s"
      retention: "30d"
      
      collected_metrics:
        - orchestration_latency
        - routing_decisions
        - pattern_usage
        - success_rate
        - error_rate
        - token_usage
        - cost_per_orchestration
        
    # Distributed tracing
    tracing:
      enabled: true
      sampling_rate: 0.1
      trace_id_propagation: "w3c"
      
    # Alerting rules
    alerts:
      - name: "high_orchestration_latency"
        condition: "p95_latency > 5000ms"
        severity: "warning"
        
      - name: "orchestration_failures"
        condition: "error_rate > 0.05"
        severity: "critical"
        
      - name: "budget_exceeded"
        condition: "hourly_cost > budget_limit"
        severity: "critical"
        
      - name: "consensus_timeout"
        condition: "consensus_time > 30s"
        severity: "warning"
        
  # === SECURITY & COMPLIANCE ===
  security:
    # Authentication between agents
    inter_agent_auth:
      method: "mutual_tls"
      certificate_rotation: "30d"
      
    # Authorization for orchestration
    orchestration_auth:
      model: "rbac"
      policy_engine: "opa"
      policy_update_interval: "5m"
      
    # Encryption
    encryption:
      in_transit: "tls_1_3"
      at_rest: "aes_256_gcm"
      key_management: "vault"
      
  compliance:
    # Audit trail
    audit:
      enabled: true
      events: ["routing_decision", "orchestration_start", "orchestration_complete", "errors"]
      retention: "7y"
      immutable_storage: true
      
    # Data governance
    data_governance:
      pii_detection: true
      pii_handling: "redact"
      data_residency_enforcement: true
      
    # Compliance validation
    validation:
      pre_orchestration: true
      post_orchestration: true
      continuous: true
      frameworks: ["iso-42001", "nist-ai-rmf", "sox", "hipaa"]