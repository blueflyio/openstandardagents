FROM node:20-alpine

# Install system dependencies
RUN apk add --no-cache \
    wget \
    curl \
    bash \
    git \
    python3 \
    py3-pip

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install root dependencies
RUN npm install || true

# Copy source code
COPY . .

# Install and build the CLI package
WORKDIR /app/src/cli
RUN npm install && npm run build

# Return to app root
WORKDIR /app

# Create MCP agent startup script
RUN cat > /app/start-mcp-agent.sh << 'EOF'
#!/bin/bash
echo "ðŸ”Œ Starting OSSA MCP Bridge Agent v0.1.8..."

# Start the MCP bridge agent service
node -e "
const express = require('express');

const app = express();
app.use(express.json());

// MCP Protocol adapter
class MCPAdapter {
  constructor() {
    this.servers = new Map();
    this.tools = new Map();
  }
  
  async registerServer(config) {
    const serverId = 'mcp-' + Date.now();
    this.servers.set(serverId, {
      ...config,
      status: 'active',
      registered_at: new Date().toISOString()
    });
    return serverId;
  }
  
  async translateToOSSA(mcpMessage) {
    return {
      format: 'ossa',
      version: '0.1.8',
      agent_id: mcpMessage.agent || 'unknown',
      capabilities: mcpMessage.tools || [],
      metadata: mcpMessage,
      timestamp: new Date().toISOString()
    };
  }
  
  async translateFromOSSA(ossaMessage) {
    return {
      jsonrpc: '2.0',
      method: ossaMessage.method || 'notification',
      params: ossaMessage.data || {},
      id: Date.now()
    };
  }
}

const mcpAdapter = new MCPAdapter();

// Health endpoint
app.get('/health', (req, res) => {
  res.json({
    service: 'mcp-agent',
    status: 'healthy',
    version: '0.1.8',
    agent_type: 'mcp',
    active_servers: mcpAdapter.servers.size,
    timestamp: new Date().toISOString()
  });
});

// Agent capabilities endpoint
app.get('/capabilities', (req, res) => {
  res.json({
    agent_type: 'mcp',
    capabilities: [
      'mcp_protocol_bridging',
      'tool_registration',
      'message_translation',
      'server_management'
    ],
    endpoints: {
      register: '/register',
      translate: '/translate',
      servers: '/servers',
      tools: '/tools'
    },
    supported_protocols: ['mcp-2.0', 'ossa-0.1.8']
  });
});

// Register MCP server endpoint
app.post('/register', async (req, res) => {
  try {
    const { name, endpoint, tools, capabilities } = req.body;
    
    const serverId = await mcpAdapter.registerServer({
      name,
      endpoint,
      tools: tools || [],
      capabilities: capabilities || []
    });
    
    res.json({
      status: 'registered',
      server_id: serverId,
      name,
      endpoint,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    res.status(500).json({
      status: 'error',
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});

// Translate message endpoint
app.post('/translate', async (req, res) => {
  try {
    const { message, direction } = req.body;
    
    let translated;
    if (direction === 'to-ossa') {
      translated = await mcpAdapter.translateToOSSA(message);
    } else if (direction === 'from-ossa') {
      translated = await mcpAdapter.translateFromOSSA(message);
    } else {
      throw new Error('Invalid direction: use to-ossa or from-ossa');
    }
    
    res.json({
      status: 'translated',
      direction,
      original: message,
      translated,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    res.status(500).json({
      status: 'error',
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});

// List servers endpoint
app.get('/servers', (req, res) => {
  const servers = Array.from(mcpAdapter.servers.entries()).map(([id, server]) => ({
    id,
    ...server
  }));
  
  res.json({
    servers,
    total: servers.length,
    timestamp: new Date().toISOString()
  });
});

const port = process.env.SERVICE_PORT || 3003;
app.listen(port, '0.0.0.0', () => {
  console.log('âœ… MCP Bridge Agent running on port ' + port);
});
"

EOF

# Make startup script executable
RUN chmod +x /app/start-mcp-agent.sh

# Expose port
EXPOSE 3003

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3003/health || exit 1

# Start MCP agent service
CMD ["/app/start-mcp-agent.sh"]