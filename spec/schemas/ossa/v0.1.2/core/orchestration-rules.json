{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://open-standards-scalable-agents.org/schemas/v0.1.2/orchestration-rules.json",
  "title": "OSSA Orchestration Rules Schema",
  "description": "OSSA orchestration rules for defining multi-agent coordination patterns",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "spec"],
  "properties": {
    "apiVersion": {
      "type": "string",
      "const": "open-standards-scalable-agents/v0.1.2",
      "description": "OSSA API version"
    },
    "kind": {
      "type": "string",
      "const": "OrchestrationRules",
      "description": "Resource type"
    },
    "metadata": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
          "description": "Rules identifier"
        },
        "description": {
          "type": "string",
          "description": "Rules description"
        },
        "labels": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "spec": {
      "type": "object",
      "required": ["patterns"],
      "properties": {
        "patterns": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["name", "type"],
            "properties": {
              "name": {
                "type": "string",
                "description": "Pattern name"
              },
              "type": {
                "type": "string",
                "enum": ["sequential", "parallel", "fanout", "circuit_breaker", "saga", "pipeline", "custom"],
                "description": "Orchestration pattern type"
              },
              "description": {
                "type": "string",
                "description": "Pattern description"
              },
              "trigger": {
                "type": "object",
                "properties": {
                  "conditions": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["field", "operator", "value"],
                      "properties": {
                        "field": {
                          "type": "string",
                          "description": "Field to evaluate"
                        },
                        "operator": {
                          "type": "string",
                          "enum": ["equals", "not_equals", "contains", "matches", "greater_than", "less_than"]
                        },
                        "value": {
                          "oneOf": [
                            {"type": "string"},
                            {"type": "number"},
                            {"type": "boolean"}
                          ]
                        }
                      }
                    }
                  },
                  "logic": {
                    "type": "string",
                    "enum": ["and", "or"],
                    "default": "and"
                  }
                }
              }
            },
            "allOf": [
              {
                "if": {
                  "properties": {"type": {"const": "sequential"}}
                },
                "then": {
                  "properties": {
                    "stages": {
                      "type": "array",
                      "minItems": 2,
                      "items": {
                        "type": "object",
                        "required": ["agent", "capability"],
                        "properties": {
                          "agent": {
                            "type": "string",
                            "description": "Agent identifier"
                          },
                          "capability": {
                            "type": "string",
                            "description": "Capability to invoke"
                          },
                          "timeout": {
                            "type": "string",
                            "pattern": "^[0-9]+[smh]$"
                          },
                          "retry": {
                            "type": "object",
                            "properties": {
                              "max_attempts": {
                                "type": "integer",
                                "minimum": 1,
                                "maximum": 10
                              },
                              "backoff": {
                                "type": "string",
                                "enum": ["linear", "exponential", "fixed"]
                              }
                            }
                          },
                          "fallback": {
                            "type": "string",
                            "description": "Fallback agent"
                          }
                        }
                      }
                    },
                    "rollback_on_failure": {
                      "type": "boolean",
                      "default": false
                    }
                  },
                  "required": ["stages"]
                }
              },
              {
                "if": {
                  "properties": {"type": {"const": "parallel"}}
                },
                "then": {
                  "properties": {
                    "agents": {
                      "type": "array",
                      "minItems": 2,
                      "items": {
                        "type": "string"
                      },
                      "description": "Agents to execute in parallel"
                    },
                    "capabilities": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Capabilities to invoke"
                    },
                    "aggregation": {
                      "type": "string",
                      "enum": ["all", "first", "majority", "consensus", "custom"],
                      "default": "all"
                    },
                    "timeout": {
                      "type": "string",
                      "pattern": "^[0-9]+[smh]$"
                    },
                    "partial_failure_handling": {
                      "type": "string",
                      "enum": ["fail_fast", "continue", "retry_failed"],
                      "default": "continue"
                    }
                  },
                  "required": ["agents"]
                }
              },
              {
                "if": {
                  "properties": {"type": {"const": "fanout"}}
                },
                "then": {
                  "properties": {
                    "coordinator": {
                      "type": "string",
                      "description": "Coordinator agent"
                    },
                    "workers": {
                      "type": "array",
                      "minItems": 2,
                      "items": {
                        "type": "string"
                      },
                      "description": "Worker agents"
                    },
                    "distribution_strategy": {
                      "type": "string",
                      "enum": ["round_robin", "load_based", "capability_based", "custom"],
                      "default": "capability_based"
                    },
                    "aggregation_strategy": {
                      "type": "string",
                      "enum": ["merge", "consensus", "weighted", "priority", "custom"],
                      "default": "consensus"
                    },
                    "fan_in_timeout": {
                      "type": "string",
                      "pattern": "^[0-9]+[smh]$"
                    }
                  },
                  "required": ["coordinator", "workers"]
                }
              },
              {
                "if": {
                  "properties": {"type": {"const": "circuit_breaker"}}
                },
                "then": {
                  "properties": {
                    "agent": {
                      "type": "string",
                      "description": "Protected agent"
                    },
                    "failure_threshold": {
                      "type": "integer",
                      "minimum": 1,
                      "default": 5,
                      "description": "Failures before opening circuit"
                    },
                    "recovery_timeout": {
                      "type": "string",
                      "pattern": "^[0-9]+[smh]$",
                      "default": "60s",
                      "description": "Time before attempting recovery"
                    },
                    "monitoring_window": {
                      "type": "string",
                      "pattern": "^[0-9]+[smh]$",
                      "default": "10s",
                      "description": "Time window for failure tracking"
                    },
                    "fallback_agent": {
                      "type": "string",
                      "description": "Fallback agent when circuit is open"
                    }
                  },
                  "required": ["agent"]
                }
              },
              {
                "if": {
                  "properties": {"type": {"const": "saga"}}
                },
                "then": {
                  "properties": {
                    "transactions": {
                      "type": "array",
                      "minItems": 2,
                      "items": {
                        "type": "object",
                        "required": ["step", "agent", "capability", "compensation"],
                        "properties": {
                          "step": {
                            "type": "string",
                            "description": "Transaction step name"
                          },
                          "agent": {
                            "type": "string",
                            "description": "Agent for this step"
                          },
                          "capability": {
                            "type": "string",
                            "description": "Capability to invoke"
                          },
                          "compensation": {
                            "type": "object",
                            "required": ["agent", "capability"],
                            "properties": {
                              "agent": {
                                "type": "string",
                                "description": "Compensation agent"
                              },
                              "capability": {
                                "type": "string",
                                "description": "Compensation capability"
                              }
                            }
                          },
                          "timeout": {
                            "type": "string",
                            "pattern": "^[0-9]+[smh]$"
                          }
                        }
                      }
                    },
                    "isolation_level": {
                      "type": "string",
                      "enum": ["read_uncommitted", "read_committed", "repeatable_read", "serializable"],
                      "default": "read_committed"
                    }
                  },
                  "required": ["transactions"]
                }
              },
              {
                "if": {
                  "properties": {"type": {"const": "pipeline"}}
                },
                "then": {
                  "properties": {
                    "stages": {
                      "type": "array",
                      "minItems": 2,
                      "items": {
                        "type": "object",
                        "required": ["name", "agent", "capability"],
                        "properties": {
                          "name": {
                            "type": "string",
                            "description": "Stage name"
                          },
                          "agent": {
                            "type": "string",
                            "description": "Processing agent"
                          },
                          "capability": {
                            "type": "string",
                            "description": "Processing capability"
                          },
                          "batch_size": {
                            "type": "integer",
                            "minimum": 1,
                            "description": "Batch size for processing"
                          },
                          "parallelism": {
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 100,
                            "default": 1,
                            "description": "Parallel instances"
                          }
                        }
                      }
                    },
                    "backpressure": {
                      "type": "object",
                      "properties": {
                        "enabled": {
                          "type": "boolean",
                          "default": true
                        },
                        "buffer_size": {
                          "type": "integer",
                          "minimum": 1,
                          "default": 100
                        },
                        "strategy": {
                          "type": "string",
                          "enum": ["block", "drop", "overflow"],
                          "default": "block"
                        }
                      }
                    }
                  },
                  "required": ["stages"]
                }
              }
            ]
          }
        },
        "defaults": {
          "type": "object",
          "properties": {
            "timeout": {
              "type": "string",
              "pattern": "^[0-9]+[smh]$",
              "default": "30s"
            },
            "retry": {
              "type": "object",
              "properties": {
                "max_attempts": {
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 10,
                  "default": 3
                },
                "backoff": {
                  "type": "string",
                  "enum": ["linear", "exponential", "fixed"],
                  "default": "exponential"
                },
                "initial_delay": {
                  "type": "string",
                  "pattern": "^[0-9]+[smh]$",
                  "default": "1s"
                }
              }
            },
            "monitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": true
                },
                "metrics": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "enum": ["latency", "throughput", "error_rate", "success_rate"]
                  },
                  "default": ["latency", "error_rate"]
                }
              }
            }
          }
        }
      }
    }
  }
}