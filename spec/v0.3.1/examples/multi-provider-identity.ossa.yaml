# OSSA v0.3.1 Multi-Provider Identity Configuration
# Enterprise-grade agent with fallback identity chain and compliance
apiVersion: ossa/v0.3.2
kind: Agent
metadata:
  name: enterprise-deployer
  version: 2.0.0
  description: Enterprise deployment agent with multi-provider identity and compliance
  labels:
    team: platform
    tier: production
    compliance: soc2
  annotations:
    security.ossa.io/audit-level: high
    security.ossa.io/mfa-required: "true"
spec:
  role: |
    You are an enterprise deployment orchestrator responsible for managing
    production deployments across multiple cloud providers and git platforms.
    You must ensure all operations are auditable, compliant, and follow
    the principle of least privilege.

  llm:
    provider: anthropic
    model: claude-sonnet-4-20250514
    temperature: 0.1
    max_tokens: 16000

  # Comprehensive Identity Configuration
  identity:
    # Primary: GitLab self-hosted
    provider: gitlab
    service_account:
      id: 31840535
      username: bot-ci-local
      email: bot-ci-local@bluefly.io
      display_name: CI/CD Bot
      roles:
        - maintainer

    # Authentication with rotation policy
    authentication:
      method: project_access_token
      scopes:
        - api
        - read_repository
        - write_repository
        - read_registry
        - write_registry
      auto_refresh: true
      expiry_warning_days: 14
      rotation_policy:
        enabled: true
        interval_days: 90
        notify_on_rotation: true

    # Multi-source token configuration
    token_source:
      env_var: GITLAB_BOT_CI_TOKEN
      file_path: ~/.tokens/bot-ci-local
      vault:
        path: secret/data/ci/gitlab-token
        key: token
        role: ci-agent
      kubernetes_secret:
        name: gitlab-ci-token
        namespace: ci-cd
        key: token

    # Auto-detection patterns
    patterns:
      - "*/gitlab_components"
      - "*/infrastructure/*"
      - "**/deploy/**"
      - "**/ci-cd/**"

    # Fallback identity chain for high availability
    fallback:
      - provider: github
        service_account:
          username: enterprise-ci-bot
          email: ci-bot@enterprise.com
        token_source:
          env_var: GITHUB_CI_TOKEN
          vault:
            path: secret/data/ci/github-token
        condition:
          platform_unavailable: true

      - provider: azure-devops
        service_account:
          username: ado-ci-service
          email: ci-service@enterprise.onmicrosoft.com
        token_source:
          azure_key_vault:
            vault_url: https://enterprise-vault.vault.azure.net
            secret_name: ado-ci-token
        condition:
          pattern_match:
            - "**/azure/**"

    # Full DORA metrics tracking
    dora_tracking:
      enabled: true
      metrics:
        - deployment_frequency
        - lead_time
        - change_failure_rate
        - mttr
      labels:
        environment: production
        team: platform
        cost_center: engineering
      prometheus:
        push_gateway: http://prometheus-pushgateway:9091
        job_name: enterprise-deployer
      classifications:
        deployment_frequency:
          elite: multiple_per_day
          high: daily
          medium: weekly
          low: monthly
        lead_time:
          elite: "1"
          high: "24"
          medium: "168"
          low: "720"

    # Claude Code session integration
    session:
      init_on_start: true
      propagate_to_subprocesses: true
      git_attribution: true
      heartbeat_interval: 60
      timeout: 7200
      hooks:
        pre_prompt_submit: true
        post_session: true

    # OpenTelemetry observability
    observability:
      service_name: enterprise-deployer
      service_namespace: production
      service_version: "2.0.0"
      service_instance_id: ${HOSTNAME}
      resource_attributes:
        deployment.environment: production
        cloud.provider: multi

    # Enterprise compliance
    compliance:
      require_mfa: true
      ip_allowlist:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
      audit_logging: required
      data_residency: us-east-1
      frameworks:
        - SOC2
        - ISO27001

    # Security policies
    security:
      token_encryption: both
      minimum_token_length: 40
      prohibited_actions:
        - delete_production_branch
        - disable_branch_protection
        - modify_security_policies
      required_approvals:
        force_push: true
        delete_protected_branch: true
        modify_ci_config: true
      rate_limits:
        requests_per_minute: 100
        requests_per_hour: 2000
        git_operations_per_hour: 200

  # Tool configuration
  tools:
    - name: kubernetes
      type: mcp
      config:
        server: kubernetes-mcp-server
        allowed_namespaces:
          - production
          - staging
    - name: terraform
      type: mcp
      config:
        server: terraform-mcp-server
        workspace: production
    - name: git
      type: mcp
      config:
        server: git-mcp-server

  # Strict autonomy controls
  autonomy:
    level: semi-autonomous
    require_approval:
      - deploy_to_production
      - rollback_deployment
      - scale_down_replicas
      - modify_secrets
    approval_timeout: 3600
    escalation:
      enabled: true
      timeout: 1800
      channels:
        - slack://platform-oncall
        - pagerduty://platform-critical

  # Comprehensive safety configuration
  safety:
    max_tokens_per_turn: 16000
    rate_limits:
      requests_per_minute: 30
      max_concurrent_requests: 5
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      recovery_timeout: 300
    kill_switch:
      enabled: true
      trigger_conditions:
        - error_rate > 0.5
        - latency_p99 > 30000
      recovery_requires_approval: true

  # State management
  state:
    storage: redis
    ttl: 86400
    encryption: aes-256-gcm
