apiVersion: ossa.ai/v0.2.7
kind: ResourceDefinition
metadata:
  name: AgentGraph
  version: 1.0.0
  description: Multi-agent composition and orchestration resource

spec:
  # AgentGraph defines a directed graph of agents with data flow
  schema:
    apiVersion:
      type: string
      pattern: ^ossa\.ai/v\d+\.\d+\.\d+$
      required: true
    
    kind:
      type: string
      enum: [AgentGraph]
      required: true
    
    metadata:
      type: object
      required: true
      properties:
        name:
          type: string
          description: Unique identifier for the agent graph
        version:
          type: string
          pattern: ^\d+\.\d+\.\d+$
        description:
          type: string
    
    spec:
      type: object
      required: true
      properties:
        agents:
          type: array
          description: List of agents in the graph
          items:
            type: object
            properties:
              id:
                type: string
                description: Unique ID within graph
              agentRef:
                type: string
                description: Reference to Agent resource
              config:
                type: object
                description: Agent-specific configuration
        
        edges:
          type: array
          description: Data flow between agents
          items:
            type: object
            properties:
              from:
                type: string
                description: Source agent ID
              to:
                type: string
                description: Target agent ID
              condition:
                type: string
                description: Optional condition for edge traversal
              transform:
                type: string
                description: Optional data transformation
        
        entrypoint:
          type: string
          description: Starting agent ID
        
        errorHandling:
          type: object
          properties:
            strategy:
              type: string
              enum: [fail-fast, continue, retry]
            maxRetries:
              type: integer
            fallbackAgent:
              type: string

examples:
  - name: Sequential Pipeline
    description: Simple sequential agent pipeline
    yaml: |
      apiVersion: ossa.ai/v0.2.7
      kind: AgentGraph
      metadata:
        name: content-pipeline
        version: 1.0.0
      spec:
        agents:
          - id: researcher
            agentRef: research-agent
          - id: writer
            agentRef: writing-agent
          - id: editor
            agentRef: editing-agent
        edges:
          - from: researcher
            to: writer
          - from: writer
            to: editor
        entrypoint: researcher
  
  - name: Conditional Routing
    description: Route based on agent output
    yaml: |
      apiVersion: ossa.ai/v0.2.7
      kind: AgentGraph
      metadata:
        name: support-router
        version: 1.0.0
      spec:
        agents:
          - id: classifier
            agentRef: intent-classifier
          - id: technical
            agentRef: technical-support
          - id: billing
            agentRef: billing-support
        edges:
          - from: classifier
            to: technical
            condition: output.intent == 'technical'
          - from: classifier
            to: billing
            condition: output.intent == 'billing'
        entrypoint: classifier
