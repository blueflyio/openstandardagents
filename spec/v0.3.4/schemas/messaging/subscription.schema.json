{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://openstandardagents.org/schemas/v0.3.3/messaging/subscription.json",
  "title": "OSSA Subscription Schema",
  "description": "Schema for agent message subscriptions in OSSA v0.3.3",
  "type": "object",
  "required": [
    "channel",
    "handler"
  ],
  "properties": {
    "channel": {
      "type": "string",
      "description": "Channel name or pattern (supports wildcards)",
      "pattern": "^agents\\.(([a-z0-9-]+|\\*)\\.)+([a-z0-9-]+|#)$",
      "minLength": 3,
      "maxLength": 256,
      "examples": [
        "agents.tasks.assigned",
        "agents.*.completed",
        "agents.#"
      ]
    },
    "schema": {
      "type": "string",
      "description": "Expected message schema for validation",
      "examples": [
        "TaskAssigned",
        "TaskCompleted"
      ]
    },
    "handler": {
      "type": "string",
      "description": "Handler function name in agent implementation",
      "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
      "examples": [
        "handleTaskAssigned",
        "onTaskCompleted",
        "processMessage"
      ]
    },
    "filter": {
      "type": "object",
      "description": "Message filter criteria (JSONPath-like syntax)",
      "additionalProperties": true,
      "examples": [
        {
          "payload.assignedTo": "ossa://agents/code-reviewer",
          "payload.priority": "high"
        }
      ]
    },
    "priority": {
      "type": "string",
      "enum": ["low", "normal", "high", "critical"],
      "default": "normal",
      "description": "Subscription processing priority"
    },
    "config": {
      "$ref": "#/definitions/SubscriptionConfig",
      "description": "Subscription-specific configuration"
    },
    "metadata": {
      "type": "object",
      "description": "Custom subscription metadata",
      "additionalProperties": true
    }
  },
  "additionalProperties": false,
  "definitions": {
    "SubscriptionConfig": {
      "type": "object",
      "description": "Subscription configuration options",
      "properties": {
        "autoAcknowledge": {
          "type": "boolean",
          "default": false,
          "description": "Automatically acknowledge messages after handler completes"
        },
        "maxConcurrentMessages": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1000,
          "default": 10,
          "description": "Maximum concurrent message processing"
        },
        "prefetchCount": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1000,
          "default": 10,
          "description": "Number of messages to prefetch from broker"
        },
        "timeout": {
          "type": "integer",
          "minimum": 100,
          "maximum": 300000,
          "default": 30000,
          "description": "Handler timeout in milliseconds"
        },
        "retryOnError": {
          "type": "boolean",
          "default": true,
          "description": "Retry message on handler error"
        },
        "maxRetries": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 3,
          "description": "Maximum retry attempts for failed handlers"
        },
        "retryBackoff": {
          "type": "object",
          "description": "Retry backoff configuration",
          "properties": {
            "strategy": {
              "type": "string",
              "enum": ["none", "linear", "exponential"],
              "default": "exponential"
            },
            "initialDelay": {
              "type": "integer",
              "minimum": 100,
              "maximum": 60000,
              "default": 1000,
              "description": "Initial retry delay in milliseconds"
            },
            "maxDelay": {
              "type": "integer",
              "minimum": 1000,
              "maximum": 300000,
              "default": 30000,
              "description": "Maximum retry delay in milliseconds"
            },
            "multiplier": {
              "type": "number",
              "minimum": 1,
              "maximum": 10,
              "default": 2,
              "description": "Backoff multiplier for exponential strategy"
            }
          },
          "additionalProperties": false
        },
        "deadLetterQueue": {
          "type": "boolean",
          "default": true,
          "description": "Send failed messages to DLQ after max retries"
        },
        "messageOrdering": {
          "type": "string",
          "enum": ["strict", "relaxed", "none"],
          "default": "relaxed",
          "description": "Message ordering guarantee"
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "channel": "agents.tasks.assigned",
      "schema": "TaskAssigned",
      "handler": "handleTaskAssigned",
      "filter": {
        "payload.assignedTo": "ossa://agents/code-reviewer"
      },
      "priority": "high",
      "config": {
        "autoAcknowledge": false,
        "maxConcurrentMessages": 5,
        "prefetchCount": 10,
        "timeout": 60000,
        "retryOnError": true,
        "maxRetries": 5,
        "retryBackoff": {
          "strategy": "exponential",
          "initialDelay": 1000,
          "maxDelay": 30000,
          "multiplier": 2
        },
        "deadLetterQueue": true,
        "messageOrdering": "strict"
      }
    },
    {
      "channel": "agents.*.completed",
      "schema": "TaskCompleted",
      "handler": "onAnyTaskCompleted",
      "priority": "normal",
      "config": {
        "autoAcknowledge": true,
        "maxConcurrentMessages": 20,
        "timeout": 5000,
        "retryOnError": false,
        "messageOrdering": "none"
      }
    },
    {
      "channel": "agents.broadcast.shutdown",
      "schema": "SystemShutdown",
      "handler": "handleShutdown",
      "priority": "critical",
      "config": {
        "autoAcknowledge": true,
        "maxConcurrentMessages": 1,
        "timeout": 10000,
        "retryOnError": false,
        "deadLetterQueue": false
      }
    }
  ]
}
