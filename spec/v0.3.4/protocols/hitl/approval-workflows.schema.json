{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://openstandardagents.org/schemas/v0.3.4/protocols/hitl/approval-workflows.json",
  "title": "Human Approval Workflows",
  "description": "Multi-step human approval processes for agent actions requiring authorization",
  "type": "object",
  "properties": {
    "workflows": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/ApprovalWorkflow"
      },
      "description": "List of approval workflow definitions"
    },
    "default_workflow": {
      "type": "string",
      "description": "Default workflow ID to use if no specific match"
    }
  },
  "definitions": {
    "ApprovalWorkflow": {
      "type": "object",
      "required": ["id", "name", "stages"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique workflow identifier"
        },
        "name": {
          "type": "string",
          "description": "Human-readable workflow name"
        },
        "description": {
          "type": "string",
          "description": "What this workflow is for"
        },
        "trigger_conditions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TriggerCondition"
          },
          "description": "Conditions that activate this workflow"
        },
        "stages": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/ApprovalStage"
          },
          "description": "Sequential approval stages"
        },
        "allow_parallel_stages": {
          "type": "boolean",
          "default": false,
          "description": "Whether stages can run in parallel"
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "description": "Total workflow timeout"
        },
        "on_timeout": {
          "type": "string",
          "enum": ["approve", "reject", "escalate", "custom"],
          "default": "reject",
          "description": "Action to take on timeout"
        },
        "on_rejection": {
          "type": "string",
          "enum": ["abort", "retry", "escalate", "custom"],
          "default": "abort",
          "description": "Action to take on rejection"
        },
        "metadata": {
          "type": "object",
          "description": "Additional workflow metadata",
          "additionalProperties": true
        }
      }
    },
    "ApprovalStage": {
      "type": "object",
      "required": ["id", "name", "approvers"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Stage identifier"
        },
        "name": {
          "type": "string",
          "description": "Stage name"
        },
        "description": {
          "type": "string",
          "description": "Stage description"
        },
        "approvers": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/Approver"
          },
          "description": "Users or roles who can approve at this stage"
        },
        "approval_type": {
          "type": "string",
          "enum": ["any", "all", "majority", "weighted", "custom"],
          "default": "any",
          "description": "How many approvals needed"
        },
        "majority_threshold": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 1.0,
          "default": 0.5,
          "description": "Threshold for majority approval (0.5 = 50%)"
        },
        "required_approvals": {
          "type": "integer",
          "minimum": 1,
          "description": "Specific number of required approvals"
        },
        "allow_comments": {
          "type": "boolean",
          "default": true,
          "description": "Whether approvers can add comments"
        },
        "require_comments_on_rejection": {
          "type": "boolean",
          "default": true,
          "description": "Whether rejection requires explanation"
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "description": "Stage timeout"
        },
        "notification_config": {
          "$ref": "#/definitions/NotificationConfig"
        },
        "conditional_skip": {
          "$ref": "#/definitions/ConditionalSkip"
        },
        "order": {
          "type": "integer",
          "minimum": 1,
          "description": "Stage order in workflow"
        }
      }
    },
    "Approver": {
      "type": "object",
      "required": ["type", "identifier"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["user", "role", "group", "api", "llm"],
          "description": "Approver type"
        },
        "identifier": {
          "type": "string",
          "description": "User ID, role name, group name, API endpoint, or LLM config"
        },
        "weight": {
          "type": "number",
          "minimum": 0,
          "default": 1,
          "description": "Approval weight for weighted voting"
        },
        "fallback_approver": {
          "type": "string",
          "description": "Fallback approver if primary unavailable"
        },
        "auto_approve_conditions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "field": {
                "type": "string"
              },
              "operator": {
                "type": "string",
                "enum": ["eq", "ne", "gt", "gte", "lt", "lte"]
              },
              "value": {
                "oneOf": [
                  {"type": "string"},
                  {"type": "number"},
                  {"type": "boolean"}
                ]
              }
            }
          },
          "description": "Conditions for automatic approval"
        },
        "llm_config": {
          "type": "object",
          "description": "LLM configuration if type is 'llm'",
          "properties": {
            "model": {
              "type": "string"
            },
            "temperature": {
              "type": "number"
            },
            "approval_criteria": {
              "type": "string",
              "description": "Criteria for LLM to approve"
            }
          }
        }
      }
    },
    "TriggerCondition": {
      "type": "object",
      "required": ["field", "operator", "value"],
      "properties": {
        "field": {
          "type": "string",
          "description": "Field to evaluate (e.g., 'action_type', 'cost', 'risk_level')"
        },
        "operator": {
          "type": "string",
          "enum": ["eq", "ne", "gt", "gte", "lt", "lte", "contains", "matches"],
          "description": "Comparison operator"
        },
        "value": {
          "description": "Value to compare against",
          "oneOf": [
            {"type": "string"},
            {"type": "number"},
            {"type": "boolean"}
          ]
        }
      }
    },
    "NotificationConfig": {
      "type": "object",
      "description": "Notification configuration for approval requests",
      "properties": {
        "channels": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["email", "slack", "webhook", "sms", "ui", "teams"]
          },
          "default": ["email"],
          "description": "Notification channels"
        },
        "template": {
          "type": "string",
          "description": "Message template for notification"
        },
        "reminder_enabled": {
          "type": "boolean",
          "default": true,
          "description": "Whether to send reminders"
        },
        "reminder_interval_ms": {
          "type": "integer",
          "minimum": 60000,
          "default": 3600000,
          "description": "Interval between reminders (default 1 hour)"
        },
        "max_reminders": {
          "type": "integer",
          "minimum": 1,
          "default": 3,
          "description": "Maximum number of reminders"
        },
        "urgency": {
          "type": "string",
          "enum": ["low", "normal", "high", "critical"],
          "default": "normal",
          "description": "Notification urgency"
        }
      }
    },
    "ConditionalSkip": {
      "type": "object",
      "description": "Conditions for skipping this stage",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Whether conditional skip is enabled"
        },
        "conditions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "field": {
                "type": "string"
              },
              "operator": {
                "type": "string",
                "enum": ["eq", "ne", "gt", "gte", "lt", "lte"]
              },
              "value": {
                "oneOf": [
                  {"type": "string"},
                  {"type": "number"},
                  {"type": "boolean"}
                ]
              }
            }
          },
          "description": "Conditions that trigger skip"
        },
        "operator": {
          "type": "string",
          "enum": ["AND", "OR"],
          "default": "AND",
          "description": "How to combine multiple conditions"
        }
      }
    }
  }
}
