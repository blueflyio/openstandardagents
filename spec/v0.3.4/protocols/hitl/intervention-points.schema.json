{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://openstandardagents.org/schemas/v0.3.4/protocols/hitl/intervention-points.json",
  "title": "Human-in-the-Loop Intervention Points",
  "description": "Defines when and how human intervention is required during agent execution",
  "type": "object",
  "properties": {
    "intervention_points": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/InterventionPoint"
      },
      "description": "List of intervention point configurations"
    },
    "default_mode": {
      "type": "string",
      "enum": ["ALWAYS", "NEVER", "TERMINATE", "CONDITIONAL"],
      "default": "NEVER",
      "description": "Default human input mode when no specific intervention point matches"
    },
    "escalation_policy": {
      "$ref": "#/definitions/EscalationPolicy"
    },
    "timeout_behavior": {
      "type": "string",
      "enum": ["proceed", "abort", "retry", "fallback"],
      "default": "abort",
      "description": "What to do if human doesn't respond within timeout"
    }
  },
  "definitions": {
    "InterventionPoint": {
      "type": "object",
      "required": ["id", "trigger", "mode"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique intervention point identifier"
        },
        "name": {
          "type": "string",
          "description": "Human-readable name"
        },
        "description": {
          "type": "string",
          "description": "What this intervention is for"
        },
        "trigger": {
          "$ref": "#/definitions/InterventionTrigger"
        },
        "mode": {
          "type": "string",
          "enum": ["ALWAYS", "NEVER", "TERMINATE", "CONDITIONAL"],
          "description": "When to request human input"
        },
        "conditional_logic": {
          "$ref": "#/definitions/ConditionalLogic"
        },
        "required_approvers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of user IDs or roles required to approve"
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "description": "How long to wait for human response"
        },
        "priority": {
          "type": "string",
          "enum": ["low", "normal", "high", "critical"],
          "default": "normal",
          "description": "Intervention priority"
        },
        "notification_channels": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["email", "slack", "webhook", "sms", "ui"]
          },
          "description": "How to notify humans"
        },
        "allow_delegation": {
          "type": "boolean",
          "default": false,
          "description": "Whether approver can delegate to someone else"
        },
        "context_data": {
          "type": "object",
          "description": "Context data to show to human",
          "additionalProperties": true
        }
      }
    },
    "InterventionTrigger": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "before_action",
            "after_action",
            "on_error",
            "on_threshold",
            "on_decision",
            "periodic",
            "manual"
          ],
          "description": "When intervention is triggered"
        },
        "action_name": {
          "type": "string",
          "description": "Specific action that triggers intervention"
        },
        "error_codes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Error codes that trigger intervention"
        },
        "threshold": {
          "$ref": "#/definitions/ThresholdCondition"
        },
        "decision_type": {
          "type": "string",
          "description": "Type of decision requiring human input"
        },
        "interval_ms": {
          "type": "integer",
          "minimum": 1000,
          "description": "Interval for periodic checks"
        },
        "custom_condition": {
          "type": "string",
          "description": "Custom trigger logic expression"
        }
      }
    },
    "ConditionalLogic": {
      "type": "object",
      "description": "Logic for conditional intervention",
      "properties": {
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ConditionalRule"
          },
          "description": "List of conditional rules"
        },
        "operator": {
          "type": "string",
          "enum": ["AND", "OR", "NOT"],
          "default": "AND",
          "description": "How to combine multiple rules"
        }
      }
    },
    "ConditionalRule": {
      "type": "object",
      "required": ["field", "operator", "value"],
      "properties": {
        "field": {
          "type": "string",
          "description": "Field to evaluate (e.g., 'cost', 'confidence', 'risk_score')"
        },
        "operator": {
          "type": "string",
          "enum": ["eq", "ne", "gt", "gte", "lt", "lte", "contains", "matches"],
          "description": "Comparison operator"
        },
        "value": {
          "description": "Value to compare against",
          "oneOf": [
            {"type": "string"},
            {"type": "number"},
            {"type": "boolean"}
          ]
        }
      }
    },
    "ThresholdCondition": {
      "type": "object",
      "properties": {
        "metric": {
          "type": "string",
          "description": "Metric to monitor (e.g., 'cost', 'confidence', 'execution_time')"
        },
        "operator": {
          "type": "string",
          "enum": ["gt", "gte", "lt", "lte"],
          "description": "Threshold operator"
        },
        "value": {
          "type": "number",
          "description": "Threshold value"
        },
        "window_ms": {
          "type": "integer",
          "minimum": 1000,
          "description": "Time window for metric evaluation"
        }
      }
    },
    "EscalationPolicy": {
      "type": "object",
      "description": "Policy for escalating interventions when not addressed",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Whether escalation is enabled"
        },
        "levels": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/EscalationLevel"
          },
          "description": "Escalation levels in order"
        }
      }
    },
    "EscalationLevel": {
      "type": "object",
      "required": ["delay_ms", "notify"],
      "properties": {
        "delay_ms": {
          "type": "integer",
          "minimum": 1000,
          "description": "Time to wait before escalating to this level"
        },
        "notify": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "User IDs or roles to notify at this level"
        },
        "channels": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["email", "slack", "webhook", "sms", "ui", "pagerduty"]
          },
          "description": "Notification channels for this level"
        },
        "message_template": {
          "type": "string",
          "description": "Custom message template for this escalation level"
        }
      }
    }
  }
}
