# =============================================================================
# OSSA v0.3.2 - Tier 3 (Write Elevated) Example: Deployment Operator
# =============================================================================
# Demonstrates separation of duties for elevated-access operator agents
# Can modify production systems but requires approval chains
# =============================================================================

apiVersion: ossa/v0.3.2
kind: Agent

metadata:
  name: deployment-operator
  version: 1.0.0
  description: Deployment operator agent with elevated write access
  labels:
    team: platform
    access_tier: tier_3_write_elevated
    domain: infrastructure

spec:
  type: operator

  role: |
    You are a deployment operator that manages CI/CD pipelines, deployments,
    and infrastructure changes. You have elevated access to production systems
    but all changes require approval through the defined approval chain.

    CRITICAL: Never bypass approval processes. Never delete production data.
    Always ensure rollback plans exist before deployment.

  llm:
    provider: anthropic
    model: claude-sonnet-4-20250514
    temperature: 0.1
    profile: safe

  # Taxonomy Classification (v0.3.2+)
  taxonomy:
    domain: infrastructure
    subdomain: deployment
    capability: execute_deployments
    concerns:
      - reliability
      - observability
      - performance

  # Access Tier Configuration (v0.3.2+)
  access:
    tier: tier_3_write_elevated
    permissions:
      - read_code
      - read_configs
      - read_metrics
      - read_logs
      - execute_deployments
      - modify_pipelines
      - merge_mrs
      - modify_configs
      - execute_commands
    prohibited:
      - delete_production
      - modify_secrets_direct
      - bypass_approvals
      - force_push
    audit_level: detailed
    requires_approval: true
    approval_chain: elevated

  # Separation of Duties (v0.3.2+)
  separation:
    role: deployer
    conflicts_with:
      - governor
      - policy_definer
      - critic
    can_delegate_to:
      - worker
      - analyzer

  # Delegation Configuration (v0.3.2+)
  delegation:
    enabled: true
    allowed_tiers:
      - tier_1_read
      - tier_2_write_limited
    allowed_operations:
      - gather_information
      - run_analysis
      - generate_reports
      - write_docs
    requires:
      - task_specification
      - audit_trail

  tools:
    - name: kubernetes
      type: kubernetes
      config:
        namespace: production
        rbac_required: true
    - name: gitlab-ci
      type: api
      config:
        endpoint: https://gitlab.com/api/v4
        scopes:
          - api
          - write_repository
    - name: deployment-monitor
      type: mcp
      config:
        server: monitoring-mcp-server

  autonomy:
    level: supervised
    approval_required:
      - deploy_to_production
      - modify_infrastructure
      - delete_resources
    allowed_actions:
      - deploy_to_staging
      - run_tests
      - view_metrics
    escalation_policy:
      triggers:
        - deployment_failure
        - rollback_required
        - security_alert
      notify:
        - slack:#platform-alerts
        - gitlab:@platform-team

  safety:
    guardrails:
      enabled: true
      max_tool_calls: 50
      max_execution_time_seconds: 1800
      policies:
        - require_rollback_plan
        - no_production_deletes
        - approval_chain_required
    human_in_loop:
      enabled: true
      triggers:
        - production_deployment
        - infrastructure_change
        - security_modification

  identity:
    provider: gitlab
    service_account:
      username: bot-deployer
      email: bot-deployer@bluefly.io
    token_source:
      env_var: GITLAB_BOT_DEPLOYER_TOKEN
      file_path: ~/.tokens/bot-deployer
    authentication:
      method: project_access_token
      scopes:
        - api
        - write_repository
        - read_registry

  observability:
    tracing:
      enabled: true
      exporter: otlp
    metrics:
      enabled: true
      customMetrics:
        - name: deployments_total
          type: counter
          description: Total deployments executed
        - name: deployment_duration_seconds
          type: histogram
          description: Time to complete deployment
        - name: rollbacks_total
          type: counter
          description: Total rollbacks performed
    slo:
      availability: 99.9
      latency_p95_ms: 30000
      error_budget: 0.1

  messaging:
    subscribes:
      - channel: ci.pipeline_complete
        description: Listen for pipeline completion to trigger deployments
        handler: onPipelineComplete
    publishes:
      - channel: deployments.status
        description: Deployment status updates
        schema:
          type: object
          properties:
            environment:
              type: string
            status:
              type: string
              enum: [started, success, failed, rolled_back]
            version:
              type: string
