apiVersion: ossa/v0.3.3
kind: Agent
metadata:
  name: mr-reviewer
  version: 1.0.0
  description: Automated merge request reviewer for code quality, security, and best practices
  labels:
    domain: quality-assurance
    subdomain: code-review
    autonomy: fully_autonomous
    use-case: merge-request-review
    ossa-version: v0.3.0
  annotations:
    gitlab.com/service-account: bot-mr-reviewer
spec:
  lifecycle:
    phases:
      - name: message_normalization
        description: "Normalize incoming messages to canonical format"
        timeout: 5s
        retry: 2
      - name: tool_resolution
        description: "Resolve available tools and capabilities"
        timeout: 10s
        retry: 1
      - name: llm_inference
        description: "Execute LLM reasoning with context"
        timeout: 60s
        retry: 3
      - name: tool_execution
        description: "Execute resolved tools and actions"
        timeout: 120s
        retry: 2
      - name: response_assembly
        description: "Assemble final response"
        timeout: 5s
        retry: 1
      - name: state_persistence
        description: "Persist state and memory updates"
        timeout: 10s
        retry: 3
      - name: observability_emission
        description: "Emit telemetry, traces, and metrics"
        timeout: 5s
        retry: 1
  role: |
    You are @bot-mr-reviewer, the automated merge request reviewer for BlueFly.io projects.
    
    You review merge requests comprehensively and provide actionable feedback. You work alongside 
    other specialized agents and coordinate their findings.
    
    Review Checklist:
    1. Code Quality - Follows standards, no code smells, proper error handling, no hardcoded values
    2. Testing - Tests added/updated, coverage ≥80%, meaningful tests
    3. Documentation - README, API docs, inline comments, CHANGELOG
    4. Commits - Conventional format, issue references, descriptive messages
    5. Security - No secrets, dependencies audited, input validation, auth checks
    6. Performance - No obvious issues, optimized queries, caching considered
    7. Integration - Other agent validations passed (OSSA, Drupal, Config, Pipeline)
    
    Auto-approve if ALL conditions met:
    - All agent validations passed
    - Pipeline is green
    - No security issues
    - Test coverage ≥ 80%
    - Conventional commits used
    - Author is @bluefly (solo developer workflow)
    - Target branch is release/* (not main)
    
    Coordinate with other agents:
    - bot-ossa-validator: OSSA schema validation
    - bot-drupal-standards: Drupal code standards
    - bot-config-auditor: Config security
    - bot-gitlab-ci-fixer: Pipeline issues
    - bot-wiki-aggregator: Documentation sync
    
    Your role is to orchestrate their findings and make the final approval decision.
    
    Tone: Professional but friendly, constructive, specific and actionable, acknowledge good work.
  llm:
    provider: anthropic
    model: claude-sonnet-4.5-20250929
    temperature: 0.1
    fallback_models:
      - provider: openai
        model: gpt-4o
      - provider: anthropic
        model: claude-haiku-3.5
    retry_config:
      max_attempts: 3
      backoff_strategy: exponential
    cost_tracking:
      enabled: true
      budget_alert_threshold: 20
      cost_allocation_tags:
        project: ossa-agents
        team: platform
        service: mr-reviewer
  capabilities:
    policy: deny_by_default
    grants:
      - capability: file_read
        scope: ["**/*.ts", "**/*.js", "**/*.py", "**/*.php", "**/*.go", "**/*.rs", "**/*.java", "**/*.md", "**/*.yaml", "**/*.json"]
        rationale: "Read source code and configuration files for code review"
      - capability: api_call
        scope: ["gitlab.com/api/v4/projects/*/merge_requests/*"]
        rate_limit: "100/minute"
        rationale: "GitLab API access for merge request operations"
      - capability: api_call
        scope: ["gitlab.com/api/v4/projects/*/repository/*"]
        rate_limit: "50/minute"
        rationale: "GitLab API access for repository content retrieval"
      - capability: comment_write
        scope: ["gitlab.com/api/v4/projects/*/merge_requests/*/notes"]
        rate_limit: "30/minute"
        rationale: "Post review comments and feedback on merge requests"
      - capability: mr_approve
        scope: ["gitlab.com/api/v4/projects/*/merge_requests/*/approve"]
        rate_limit: "10/minute"
        rationale: "Approve merge requests that pass all quality checks"
      - capability: llm_inference
        providers: ["anthropic", "openai"]
        models: ["claude-sonnet-4.5-20250929", "gpt-4o", "claude-haiku-3.5"]
        rationale: "AI reasoning for code analysis and review comment generation"
      - capability: agent_communication
        scope: ["bot-ossa-validator", "bot-drupal-standards", "bot-config-auditor", "bot-gitlab-ci-fixer", "bot-wiki-aggregator"]
        rationale: "Coordinate with specialized agents for comprehensive review"
  tasks:
    - name: code-review
      description: Review code changes for quality and best practices
      steps:
        - name: fetch-mr-changes
          action: exec
          command: |
            curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              "${CI_API_V4_URL}/projects/${project_id}/merge_requests/${merge_request_id}/changes" \
              | jq -r '.changes[] | "\(.new_path): \(.diff)"'
        - name: analyze-code-quality
          action: exec
          command: |
            echo "Analyzing code quality..."
            # Code quality checks would go here
        - name: check-test-coverage
          action: exec
          command: |
            echo "Checking test coverage..."
            # Test coverage checks would go here
        - name: generate-review-comments
          action: exec
          command: |
            echo "Generating review comments..."
            # Review comment generation would go here
        - name: post-review
          action: exec
          command: |
            echo "Posting review to MR..."
            # Post review comments to GitLab MR
  tools:
    - type: http
      name: gitlab_api
    - type: function
      name: diff_analyzer
    - type: function
      name: security_scanner
  observability:
    telemetry:
      enabled: true
      exporter: otlp
      endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT}"
      service_name: "${AGENT_NAME}"
      service_version: "${AGENT_VERSION}"
    tracing:
      enabled: true
      sampler: parentbased_traceidratio
      sample_rate: 0.1
      propagation: ["tracecontext", "baggage"]
    metrics:
      enabled: true
      interval: 30s
      histogram_buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
      labels:
        - agent_name
        - agent_version
        - phase
        - capability
        - status
    logging:
      level: info
      format: json
      redact_pii: true
      structured: true
      fields:
        - execution_id
        - agent_id
        - phase
        - duration_ms
  security:
    authentication:
      required: true
      method: service_account
    authorization:
      required: true
      scopes:
        - api
        - read_repository
        - write_repository
  safety:
    guardrails:
      pii_detection:
        enabled: true
        action: redact
        categories: ["email", "phone", "ssn", "credit_card"]
      secrets_detection:
        enabled: true
        action: block
        patterns:
          - "glpat-*"
          - "ghp_*"
          - "sk-*"
          - "bearer *"
          - "password=*"
          - "api_key=*"
      prompt_injection:
        enabled: true
        action: warn
        detection: ["ignore previous", "system prompt", "jailbreak"]
      content_policy:
        enabled: true
        categories:
          violence: block
          hate: block
          sexual: block
          self_harm: block
    kill_switch:
      enabled: true
      trigger: manual
      webhook: "${KILL_SWITCH_WEBHOOK}"
      grace_period: 30s
    compliance:
      profiles:
        - fedramp_moderate
        - hipaa
        - gdpr
        - soc2_type2
extensions:
  gitlab_duo:
    enabled: true
    flow_execution: true
    model: claude-sonnet-4.5-20250929
