apiVersion: ossa/v0.3.3
kind: Agent
metadata:
  name: release-orchestrator
  version: 1.0.0
  labels:
    domain: release-automation
    priority: critical
    team: platform
    ossa-version: v0.3.0
spec:
  lifecycle:
    phases:
      - name: message_normalization
        description: "Normalize incoming messages to canonical format"
        timeout: 5s
        retry: 2
      - name: tool_resolution
        description: "Resolve available tools and capabilities"
        timeout: 10s
        retry: 1
      - name: llm_inference
        description: "Execute LLM reasoning with context"
        timeout: 60s
        retry: 3
      - name: tool_execution
        description: "Execute resolved tools and actions"
        timeout: 120s
        retry: 2
      - name: response_assembly
        description: "Assemble final response"
        timeout: 5s
        retry: 1
      - name: state_persistence
        description: "Persist state and memory updates"
        timeout: 10s
        retry: 3
      - name: observability_emission
        description: "Emit telemetry, traces, and metrics"
        timeout: 5s
        retry: 1

  type: orchestrator
  identity:
    instance_id:
      generation: uuid_v4
      scope: pod
    session_id:
      generation: uuid_v4
      scope: workflow
    interaction_id:
      generation: uuid_v4
      scope: turn
  reasoning:
    strategy: react
    max_steps: 25
    max_depth: 5
    trace_enabled: true
    export_format: otel
    self_reflection:
      enabled: true
      trigger: on_failure
      threshold: 0.95
  prompts:
    system:
      template: |
        You are the OSSA Release Orchestrator - autonomous AI for production releases.
        Execute flawless releases when milestones close with zero human intervention.
      version: 1.0.0
  capabilities:
    policy: deny_by_default
    grants:
      - capability: file_read
        scope: ["CHANGELOG.md", "package.json", "VERSION", "*.version", ".releaserc*"]
        rationale: "Read version files and changelog for release preparation"
      - capability: file_write
        scope: ["CHANGELOG.md", "package.json", "VERSION", "*.version"]
        rationale: "Update version files and changelog during release"
      - capability: api_call
        scope: ["gitlab.com/api/v4/projects/*/milestones/*"]
        rate_limit: "50/minute"
        rationale: "GitLab API access for milestone validation and management"
      - capability: api_call
        scope: ["gitlab.com/api/v4/projects/*/issues*", "gitlab.com/api/v4/projects/*/labels*"]
        rate_limit: "100/minute"
        rationale: "GitLab API access for issue queries and label management"
      - capability: api_call
        scope: ["gitlab.com/api/v4/projects/*/releases*"]
        rate_limit: "20/minute"
        rationale: "GitLab API access for release creation"
      - capability: api_call
        scope: ["gitlab.com/api/v4/projects/*/merge_requests"]
        rate_limit: "30/minute"
        rationale: "GitLab API access for merge request creation"
      - capability: npm_publish
        scope: ["@bluefly/*", "@openstandardagents/*"]
        rate_limit: "10/hour"
        rationale: "Publish packages to npm registry"
      - capability: changelog_generate
        scope: ["conventional-commits"]
        rationale: "Generate changelog from conventional commits"
      - capability: llm_inference
        providers: ["anthropic", "openai"]
        models: ["claude-sonnet", "gpt-4o"]
        rationale: "AI reasoning for release notes and decision making"
      - capability: git_operations
        scope: ["tag", "push"]
        rationale: "Create and push git tags for releases"

    actions:
      - ossa:gitlab/milestone_validate@1.0
      - ossa:gitlab/issue_query@1.0
      - ossa:gitlab/changelog_generate@1.0
      - ossa:gitlab/mr_create@1.0
      - ossa:gitlab/release_create@1.0
      - ossa:gitlab/label_apply@1.0
      - ossa:gitlab/milestone_manage@1.0
      - ossa:npm/publish@1.0
  tools:
    - name: gitlab-api
      type: http
      config:
        base_url: ${CI_API_V4_URL}
        auth:
          type: bearer
          token_ref: GITLAB_PUSH_TOKEN
  triggers:
    - type: webhook
      event: milestone
      conditions:
        - object_attributes.action == "close"
        - object_attributes.title matches "^v\\d+\\.\\d+\\.\\d+"
  observability:
    telemetry:
      enabled: true
      exporter: otlp
      endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT}"
      service_name: "${AGENT_NAME}"
      service_version: "${AGENT_VERSION}"
    tracing:
      enabled: true
      sampler: parentbased_traceidratio
      sample_rate: 0.1
      propagation: ["tracecontext", "baggage"]
    metrics:
      enabled: true
      interval: 30s
      histogram_buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
      labels:
        - agent_name
        - agent_version
        - phase
        - capability
        - status
    logging:
      level: info
      format: json
      redact_pii: true
      structured: true
      fields:
        - execution_id
        - agent_id
        - phase
        - duration_ms
  safety:
    guardrails:
      pii_detection:
        enabled: true
        action: redact
        categories: ["email", "phone", "ssn", "credit_card"]
      secrets_detection:
        enabled: true
        action: block
        patterns:
          - "glpat-*"
          - "ghp_*"
          - "sk-*"
          - "bearer *"
          - "password=*"
          - "api_key=*"
      prompt_injection:
        enabled: true
        action: warn
        detection: ["ignore previous", "system prompt", "jailbreak"]
      content_policy:
        enabled: true
        categories:
          violence: block
          hate: block
          sexual: block
          self_harm: block
    kill_switch:
      enabled: true
      trigger: manual
      webhook: "${KILL_SWITCH_WEBHOOK}"
      grace_period: 30s
    compliance:
      profiles:
        - fedramp_moderate
        - hipaa
        - gdpr
        - soc2_type2
extensions:
  gitlab_duo:
    enabled: true
    flow_execution: true
    model: ${GITLAB_DUO_MODEL:-claude-sonnet}
  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: agent-system
      labels:
        app.kubernetes.io/name: release-orchestrator
        app.kubernetes.io/part-of: ossa-showcase
        openstandardagents.org/version: v0.3.0
      resourceLimits:
        cpu: "1"
        memory: 2Gi
    deployment:
      replicas:
        min: 1
        max: 3
      strategy: rolling-update
    a2aConfig:
      enabled: true
      protocol: json-rpc
    meshIntegration:
      enabled: true
      istioIntegration: true
  mcp:
    enabled: true
    server_type: stdio
    server_name: release-orchestrator-mcp
