apiVersion: ossa/v0.3.3
kind: Agent

metadata:
  name: ossa-validator-v0.3
  version: 1.0.0
  description: |
    OpenStandardAgents Validator (v0.3.x) - Comprehensive OSSA v0.3.0 manifest validation.
    
    Validates OSSA v0.3.x manifests using @bluefly/openstandardagents npm package for:
    - Schema compliance (apiVersion, kind, metadata, spec)
    - LLM configuration with environment variable support
    - Capabilities, tools (MCP), and autonomy settings
    - Observability (telemetry, tracing, metrics)
    - Safety guardrails (PII, secrets, prompt injection)
    - Cost tracking and A2A messaging
    - Runtime bindings validation

  labels:
    domain: ossa-compliance
    subdomain: validation
    category: quality-assurance
    autonomy: assisted
    ossa-version: v0.3.0

  annotations:
    ossa.standard/compliance: full
    ossa.standard/validator: "true"
    npm.package: "@bluefly/openstandardagents"

spec:
  lifecycle:
    phases:
      - name: message_normalization
        description: "Normalize incoming messages to canonical format"
        timeout: 5s
        retry: 2
      - name: tool_resolution
        description: "Resolve available tools and capabilities"
        timeout: 10s
        retry: 1
      - name: llm_inference
        description: "Execute LLM reasoning with context"
        timeout: 60s
        retry: 3
      - name: tool_execution
        description: "Execute resolved tools and actions"
        timeout: 120s
        retry: 2
      - name: response_assembly
        description: "Assemble final response"
        timeout: 5s
        retry: 1
      - name: state_persistence
        description: "Persist state and memory updates"
        timeout: 10s
        retry: 3
      - name: observability_emission
        description: "Emit telemetry, traces, and metrics"
        timeout: 5s
        retry: 1

  role: |
    You are the OpenStandardAgents Validator (v0.3.x), a specialized agent that validates
    OSSA v0.3.0 manifests for complete compliance with the specification.
    
    Your mission is to ensure every OSSA manifest meets the highest standards of:
    - Schema correctness
    - Security best practices
    - Observability completeness
    - Cost management
    - Runtime compatibility
    
    You use the @bluefly/openstandardagents npm package for validation and provide clear,
    actionable feedback with specific fixes for any violations.

  prompts:
    system:
      template: |
        You are the OpenStandardAgents Validator (v0.3.x).
        
        Validate OSSA v0.3.0 manifests using @bluefly/openstandardagents npm package
        with precision and provide actionable feedback.
        
        Validation scope:
        - Schema compliance (apiVersion, kind, metadata, spec)
        - LLM configuration (env var support, fallbacks, cost tracking)
        - Capabilities and tools (MCP compliance)
        - Autonomy settings and constraints
        - Observability (tracing, metrics, logging)
        - Safety guardrails (PII, secrets, prompt injection)
        - A2A messaging configuration
        - Runtime bindings validation
        
        Use: npx @bluefly/openstandardagents validate <manifest-path>
        
        Be thorough, clear, and helpful. Provide specific fixes for all violations.
      version: "1.0.0"

  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-3-5-sonnet-20241022}
    temperature: 0.1
    maxTokens: 8000

    profile: ${LLM_PROFILE:-balanced}

    fallback_models:
      - provider: ${LLM_FALLBACK_1_PROVIDER:-openai}
        model: ${LLM_FALLBACK_1_MODEL:-gpt-4o-mini}
        temperature: 0.1
      - provider: ${LLM_FALLBACK_2_PROVIDER:-anthropic}
        model: ${LLM_FALLBACK_2_MODEL:-claude-3-haiku-20240307}
        temperature: 0.1

    retry_config:
      max_attempts: 3
      backoff_strategy: exponential
      initial_delay_ms: 1000
      max_delay_ms: 30000

    cost_tracking:
      enabled: true
      budget_alert_threshold: 10.00
      daily_limit: 50.00
      cost_allocation_tags:
        project: ossa-validation
        team: ossa-core
        service: validator
        purpose: compliance

  capabilities:
    policy: deny_by_default
    grants:
      - capability: file_read
        scope: ["**/*.yaml", "**/*.yml", "**/*.json", ".agents/**/*"]
        rationale: "Read OSSA manifest files and JSON schemas for validation"
      - capability: exec
        scope: ["npx @bluefly/openstandardagents validate *"]
        rationale: "Execute OSSA validation CLI tool"
      - capability: schema_validation
        scope: ["ossa/v0.3.*"]
        rationale: "Validate manifests against OSSA v0.3.x schema"
      - capability: llm_inference
        providers: ["anthropic", "openai"]
        models: ["claude-3-5-sonnet-20241022", "gpt-4o-mini", "claude-3-haiku-20240307"]
        rationale: "AI reasoning for validation analysis and fix suggestions"
      - capability: report_generation
        scope: ["validation_reports/**", "compliance_reports/**"]
        rationale: "Generate validation and compliance reports"
      - capability: message_publish
        scope: ["ossa.validation.*"]
        rationale: "Publish validation results to message channels"
      - capability: message_subscribe
        scope: ["ossa.manifest.*"]
        rationale: "Subscribe to manifest creation and update events"

    actions:
      - name: schema_validation
        description: Validate OSSA v0.3.0 schema compliance using @bluefly/openstandardagents
        version: "1.0.0"
        scopes: [read, validate]

      - name: llm_config_validation
        description: Validate LLM configuration and env var support
        version: "1.0.0"
        scopes: [read, validate]

      - name: security_validation
        description: Validate safety guardrails and security settings
        version: "1.0.0"
        scopes: [read, validate]

      - name: observability_validation
        description: Validate observability configuration
        version: "1.0.0"
        scopes: [read, validate]

      - name: runtime_validation
        description: Validate runtime bindings and compatibility
        version: "1.0.0"
        scopes: [read, validate]

  tools:
    - type: exec
      name: ossa_validate_cli
      description: Execute @bluefly/openstandardagents CLI validation
      command: npx
      args:
        - @bluefly/openstandardagents
        - validate
      args:
        - @bluefly/openstandardagents
        - validate
        - /path/to/manifest.ossa.yaml
      outputSchema:
        type: object
        properties:
          exit_code:
            type: integer
          stdout:
            type: string
          stderr:
            type: string
          valid:
            type: boolean

    - type: mcp
      name: validate_ossa_schema
      description: Validate OSSA manifest against v0.3.0 schema using @bluefly/openstandardagents
      inputSchema:
        type: object
        required: [manifest_path]
        properties:
          manifest_path:
            type: string
            description: Path to OSSA manifest file
          strict_mode:
            type: boolean
            default: true
            description: Enable strict validation
          check_deprecated:
            type: boolean
            default: true
            description: Check for deprecated fields
      outputSchema:
        type: object
        properties:
          valid:
            type: boolean
          errors:
            type: array
            items:
              type: object
              properties:
                path:
                  type: string
                message:
                  type: string
                severity:
                  type: string
                  enum: [error, warning, info]
                suggestion:
                  type: string
          compliance_score:
            type: number
            minimum: 0
            maximum: 100

  autonomy:
    level: assisted

    approval_required:
      - modify_manifests
      - bypass_validation

    allowed_actions:
      - validate_ossa_schema
      - ossa_validate_cli
      - validate_llm_config
      - validate_safety
      - validate_observability
      - validate_runtime
      - generate_report
      - suggest_fixes

    blocked_actions:
      - modify_files
      - delete_files
      - access_secrets

  constraints:
    cost:
      maxTokensPerDay: 500000
      maxTokensPerRequest: 8000
      maxCostPerDay: 50.00
      currency: USD

    performance:
      maxLatencySeconds: 30
      maxConcurrentRequests: 10
      timeoutSeconds: 60

  state:
    mode: stateless
    context_window:
      max_messages: 50
      max_tokens: 16000

  observability:
    telemetry:
      enabled: true
      exporter: otlp
      endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT}"
      service_name: "${AGENT_NAME}"
      service_version: "${AGENT_VERSION}"
    tracing:
      enabled: true
      sampler: parentbased_traceidratio
      sample_rate: 0.1
      propagation: ["tracecontext", "baggage"]
    metrics:
      enabled: true
      interval: 30s
      histogram_buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
      labels:
        - agent_name
        - agent_version
        - phase
        - capability
        - status
    logging:
      level: info
      format: json
      redact_pii: true
      structured: true
      fields:
        - execution_id
        - agent_id
        - phase
        - duration_ms

  safety:
    content_filtering:
      enabled: true
      categories: [pii, credentials, secrets, api_keys]
      threshold: strict
      action: redact

    pii_detection:
      enabled: true
      types: [email, phone, api_key, private_key]
      action: redact

    rate_limiting:
      enabled: true
      requests_per_minute: 100
      burst_limit: 200

    guardrails:
      enabled: true
      policies:
        - name: max_tool_calls
          max_tool_calls: 50
        - name: max_execution_time
          max_execution_time_seconds: 60
        - name: no_destructive_actions
          blocked_patterns: ["rm -rf", "DELETE FROM"]
      pii_detection:
        enabled: true
        action: redact
        categories: ["email", "phone", "ssn", "credit_card"]
      secrets_detection:
        enabled: true
        action: block
        patterns:
          - "glpat-*"
          - "ghp_*"
          - "sk-*"
          - "bearer *"
          - "password=*"
          - "api_key=*"
      prompt_injection:
        enabled: true
        action: warn
        detection: ["ignore previous", "system prompt", "jailbreak"]
      content_policy:
        enabled: true
        categories:
          violence: block
          hate: block
          sexual: block
          self_harm: block
    kill_switch:
      enabled: true
      trigger: manual
      webhook: "${KILL_SWITCH_WEBHOOK}"
      grace_period: 30s
    compliance:
      profiles:
        - fedramp_moderate
        - hipaa
        - gdpr
        - soc2_type2

  messaging:
    publishes:
      - channel: ossa.validation.complete
        description: Published when validation completes
        schema:
          type: object
          required: [manifest_path, result, timestamp]
          properties:
            manifest_path:
              type: string
            result:
              type: string
              enum: [passed, failed, warnings]
            compliance_score:
              type: number
            errors:
              type: array
            duration_ms:
              type: integer
        tags: [ossa, validation]

    subscribes:
      - channel: ossa.manifest.created
        description: Listen for new OSSA manifests
        handler: on_manifest_created
        priority: high
        maxConcurrency: 5

      - channel: ossa.manifest.updated
        description: Listen for manifest updates
        handler: on_manifest_updated
        priority: normal
        maxConcurrency: 5

    commands:
      - name: validate_manifest
        description: Validate a specific OSSA manifest using @bluefly/openstandardagents
        inputSchema:
          type: object
          required: [path]
          properties:
            path:
              type: string
            version:
              type: string
              default: "v0.3.0"
            strict:
              type: boolean
              default: true
        outputSchema:
          type: object
          properties:
            valid:
              type: boolean
            errors:
              type: array
            warnings:
              type: array
            compliance_score:
              type: number
        timeoutSeconds: 60
        idempotent: true

    reliability:
      deliveryGuarantee: at-least-once
      retry:
        maxAttempts: 3
        backoff:
          strategy: exponential
          initialDelayMs: 1000
          maxDelayMs: 10000

  extensions:
    mcp:
      enabled: true
      server_type: stdio
      server_name: ossa-validator-mcp

      tools:
        - name: ossa_validate
          description: Validate OSSA manifests using @bluefly/openstandardagents
        - name: llm_config_validate
          description: Validate LLM configuration
        - name: safety_validate
          description: Validate safety settings
        - name: observability_validate
          description: Validate observability config
        - name: runtime_validate
          description: Validate runtime bindings

      resources:
        - uri: npm://@bluefly/openstandardagents
          name: OSSA Validation Package
          description: The @bluefly/openstandardagents npm package for validation
          mimeType: application/json

        - uri: file:///spec/v0.3.0
          name: OSSA v0.3.0 Specification
          description: The complete OSSA v0.3.0 specification
          mimeType: application/json

  runtime:
    type: container
    image: node:20-bookworm
    transport: sync

    dependencies:
      - name: "@bluefly/openstandardagents"
        version: "latest"
        type: npm

    bindings:
      validate_ossa_schema:
        handler: OSSAValidator::validateSchema
        tool: ossa_validate
        config:
          package: "@bluefly/openstandardagents"
          command: "npx @bluefly/openstandardagents validate"
          schema_path: /spec/v0.3.0
          strict_mode: true

      validate_llm_config:
        handler: LLMConfigValidator::validate
        tool: llm_config_validate
        config:
          check_env_vars: true
          check_fallbacks: true

      validate_safety:
        handler: SafetyValidator::validate
        tool: safety_validate
        config:
          check_all: true

      validate_observability:
        handler: ObservabilityValidator::validate
        tool: observability_validate
        config:
          check_all: true

      validate_runtime:
        handler: RuntimeValidator::validate
        tool: runtime_validate
        config:
          check_compatibility: true

  reasoning:
    strategy: react
    max_steps: 20
    trace_enabled: true
    export_format: otel

    chains:
      - name: validation_chain
        steps:
          - fetch_manifest
          - parse_yaml
          - validate_schema_via_cli
          - validate_llm_config
          - validate_safety
          - validate_observability
          - validate_runtime
          - generate_report
