# OSSA Agent Router Configuration
# Routes MR comments and events to appropriate agents

apiVersion: ossa/v0.3.0
kind: Workflow
metadata:
  name: mr-agent-router
  version: 1.0.0
  description: Routes GitLab MR events to OSSA agents
  labels:
    domain: gitlab
    capability: routing
    environment: production

spec:
  triggers:
    - type: webhook
      source: gitlab
      events:
        - merge_request
        - note
      filter:
        expression: "${{ event.object_attributes.action in ['open', 'update', 'reopen'] || event.object_kind == 'note' }}"

  inputs:
    type: object
    properties:
      event:
        type: object
        description: GitLab webhook event payload
      project_id:
        type: integer
      merge_request_iid:
        type: integer

  steps:
    # ==========================================================================
    # Step 1: Parse event and extract agent commands
    # ==========================================================================
    - id: parse-event
      name: Parse GitLab Event
      kind: Task
      ref: tasks/gitlab-event-parser.ossa.yaml
      input:
        event: "${{ workflow.input.event }}"
      output:
        event_type: string
        commands: array
        mentions: array
        file_changes: array
        labels: array

    # ==========================================================================
    # Step 2: Route based on explicit agent mentions
    # ==========================================================================
    - id: route-mentions
      name: Route Agent Mentions
      kind: Conditional
      condition: "${{ steps.parse-event.output.mentions | length > 0 }}"
      steps:
        - id: invoke-mentioned-agents
          name: Invoke Mentioned Agents
          kind: Loop
          loop:
            over: "${{ steps.parse-event.output.mentions }}"
            as: mention
            parallelism: 5
          steps:
            - id: dispatch-to-agent
              name: Dispatch to Agent
              kind: Agent
              ref: ".agents/${{ item.mention.agent }}/manifest.ossa.yaml"
              input:
                command: "${{ item.mention.command }}"
                context:
                  project_id: "${{ workflow.input.project_id }}"
                  mr_iid: "${{ workflow.input.merge_request_iid }}"
                  event: "${{ workflow.input.event }}"

    # ==========================================================================
    # Step 3: Auto-dispatch based on file changes
    # ==========================================================================
    - id: auto-dispatch
      name: Auto-Dispatch by File Type
      kind: Conditional
      condition: "${{ steps.parse-event.output.event_type == 'merge_request' }}"
      steps:
        # OSSA files â†’ OSSA Validator
        - id: ossa-files-check
          name: Check OSSA Files
          kind: Conditional
          condition: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', '.*\\.ossa\\.yaml$') | list | length > 0 }}"
          steps:
            - id: invoke-ossa-validator
              kind: Agent
              ref: .agents/ossa-validator/manifest.ossa.yaml
              input:
                command: "validate --strict"
                files: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', '.*\\.ossa\\.yaml$') | list }}"

        # Drupal files â†’ Drupal Standards
        - id: drupal-files-check
          name: Check Drupal Files
          kind: Conditional
          condition: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', 'web/(modules|themes|profiles)/.*') | list | length > 0 }}"
          steps:
            - id: invoke-drupal-standards
              kind: Agent
              ref: .agents/drupal-standards/manifest.ossa.yaml
              input:
                command: "check --full"
                files: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', 'web/(modules|themes|profiles)/.*') | list }}"

        # CI files â†’ CI Fixer
        - id: ci-files-check
          name: Check CI Files
          kind: Conditional
          condition: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', '.*\\.gitlab-ci.*\\.yml$|\\.gitlab/ci/.*') | list | length > 0 }}"
          steps:
            - id: invoke-ci-fixer
              kind: Agent
              ref: .agents/gitlab-ci-fixer/manifest.ossa.yaml
              input:
                command: "validate"
                files: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', '.*\\.gitlab-ci.*') | list }}"

        # Recipe files â†’ Recipe Scaffolder
        - id: recipe-files-check
          name: Check Recipe Files
          kind: Conditional
          condition: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', 'recipes/.*') | list | length > 0 }}"
          steps:
            - id: invoke-recipe-scaffolder
              kind: Agent
              ref: .agents/drupal-recipe-scaffolder/manifest.ossa.yaml
              input:
                command: "validate"
                files: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', 'recipes/.*') | list }}"

        # Config files â†’ Config Auditor
        - id: config-files-check
          name: Check Config Files
          kind: Conditional
          condition: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', 'config/.*\\.yml$') | list | length > 0 }}"
          steps:
            - id: invoke-config-auditor
              kind: Agent
              ref: .agents/config-auditor/manifest.ossa.yaml
              input:
                command: "audit"
                files: "${{ steps.parse-event.output.file_changes | selectattr('path', 'match', 'config/.*') | list }}"

    # ==========================================================================
    # Step 4: Always invoke MR Reviewer (unless hotfix)
    # ==========================================================================
    - id: standard-review
      name: Standard MR Review
      kind: Conditional
      condition: "${{ 'hotfix' not in steps.parse-event.output.labels }}"
      steps:
        - id: invoke-mr-reviewer
          kind: Agent
          ref: .agents/mr-reviewer/manifest.ossa.yaml
          input:
            command: "review full"
            context:
              project_id: "${{ workflow.input.project_id }}"
              mr_iid: "${{ workflow.input.merge_request_iid }}"

    # ==========================================================================
    # Step 5: Hotfix expedited processing
    # ==========================================================================
    - id: hotfix-review
      name: Hotfix Expedited Review
      kind: Conditional
      condition: "${{ 'hotfix' in steps.parse-event.output.labels }}"
      steps:
        - id: invoke-mr-reviewer-urgent
          kind: Agent
          ref: .agents/mr-reviewer/manifest.ossa.yaml
          input:
            command: "review urgent --security"
            priority: critical
            context:
              project_id: "${{ workflow.input.project_id }}"
              mr_iid: "${{ workflow.input.merge_request_iid }}"
              hotfix: true

    # ==========================================================================
    # Step 6: Aggregate and respond
    # ==========================================================================
    - id: aggregate-responses
      name: Aggregate Agent Responses
      kind: Task
      ref: tasks/response-aggregator.ossa.yaml
      input:
        responses: "${{ steps.*.output }}"
      output:
        summary: string
        blocking_issues: array
        warnings: array

    - id: post-comment
      name: Post Summary Comment
      kind: Task
      ref: tasks/gitlab-comment.ossa.yaml
      input:
        project_id: "${{ workflow.input.project_id }}"
        mr_iid: "${{ workflow.input.merge_request_iid }}"
        body: |
          ## ðŸ¤– Agent Review Summary
          
          ${{ steps.aggregate-responses.output.summary }}
          
          ### Blocking Issues (${{ steps.aggregate-responses.output.blocking_issues | length }})
          ${{ steps.aggregate-responses.output.blocking_issues | join('\n') }}
          
          ### Warnings (${{ steps.aggregate-responses.output.warnings | length }})
          ${{ steps.aggregate-responses.output.warnings | join('\n') }}

  error_handling:
    on_failure: notify
    notification:
      channels:
        - slack
      template: agent-router-failure

  observability:
    tracing:
      enabled: true
      exporter: otlp
    metrics:
      enabled: true
      custom_labels:
        workflow: mr-agent-router

---
# Agent Command Mapping Reference
# Used by the router to match commands to agents

apiVersion: ossa/v0.3.0
kind: Task
metadata:
  name: command-mapping
  version: 1.0.0

spec:
  execution:
    type: deterministic
    runtime: any

  # Command to Agent Mapping
  config:
    mappings:
      # Review commands
      "/review": "bot-mr-reviewer"
      "/review security": "bot-mr-reviewer"
      "/review performance": "bot-mr-reviewer"
      "/review urgent": "bot-mr-reviewer"
      
      # OSSA commands
      "/ossa validate": "bot-ossa-validator"
      "/ossa diff": "bot-ossa-validator"
      "/ossa migrate": "bot-ossa-validator"
      "/validate ossa": "bot-ossa-validator"
      
      # CI commands
      "/ci validate": "bot-gitlab-ci-fixer"
      "/ci lint": "bot-gitlab-ci-fixer"
      "/ci simulate": "bot-gitlab-ci-fixer"
      "/fix pipeline": "bot-gitlab-ci-fixer"
      
      # Drupal commands
      "/drupal check": "bot-drupal-standards"
      "/drupal phpcs": "bot-drupal-standards"
      "/drupal phpstan": "bot-drupal-standards"
      "/drupal deprecations": "bot-drupal-standards"
      
      # Scaffolding commands
      "/scaffold module": "bot-module-scaffolder"
      "/scaffold entity": "bot-module-scaffolder"
      "/scaffold form": "bot-module-scaffolder"
      "/scaffold service": "bot-module-scaffolder"
      "/scaffold recipe": "bot-drupal-recipe-scaffolder"
      "/component build": "bot-component-builder"
      
      # Recipe commands
      "/recipe validate": "bot-drupal-recipe-scaffolder"
      "/recipe scaffold": "bot-drupal-recipe-scaffolder"
      "/recipe lint": "bot-drupal-recipe-scaffolder"
      "/recipe publish": "bot-drupal-recipe-pub"
      
      # Audit commands
      "/audit config": "bot-config-auditor"
      "/audit content": "bot-content-auditor"
      
      # Testing commands
      "/test theme": "bot-theme-tester"
      
      # Documentation commands
      "/sync docs": "bot-wiki-aggregator"
      "/docs sync": "bot-wiki-aggregator"
      
      # Canvas/diagram commands
      "/canvas": "bot-canvas-builder"
      "/canvas architecture": "bot-canvas-builder"

    # File pattern to agent mapping (for auto-dispatch)
    file_patterns:
      "**/*.ossa.yaml": "bot-ossa-validator"
      ".agents/**/*": "bot-ossa-validator"
      "web/modules/**/*": "bot-drupal-standards"
      "web/themes/**/*": ["bot-drupal-standards", "bot-theme-tester"]
      "web/profiles/**/*": "bot-drupal-standards"
      ".gitlab-ci.yml": "bot-gitlab-ci-fixer"
      ".gitlab/ci/**/*": "bot-gitlab-ci-fixer"
      "config/**/*.yml": "bot-config-auditor"
      "recipes/**/*": "bot-drupal-recipe-scaffolder"
      "docs/**/*": "bot-wiki-aggregator"
      "**/*.md": "bot-wiki-aggregator"
