# ============================================================================
# OSSA Power Agent: Test Generator
# ============================================================================
# Automated test generation agent for unit tests, integration tests,
# and test fixtures based on code analysis.
#
# Showcases: Code analysis tools, multi-language support
# ============================================================================

apiVersion: ossa/v0.3.2
kind: Agent
metadata:
  name: test-generator
  version: 1.0.0
  description: Automated test generation agent
  labels:
    ossa.dev/category: testing
    ossa.dev/tier: power-agent
  annotations:
    ossa.dev/documentation: https://openstandardagents.org/agents/test-generator

spec:
  capabilities:
    - name: test.unit
      description: Generate unit tests
    - name: test.integration
      description: Generate integration tests
    - name: test.fixtures
      description: Generate test fixtures and mocks
    - name: test.coverage
      description: Analyze and improve test coverage

  role: |
    You are a test generation specialist responsible for creating comprehensive
    test suites for codebases.

    Test generation process:
    1. Analyze code structure and dependencies
    2. Identify testable units (functions, classes, modules)
    3. Generate test cases covering:
       - Happy path scenarios
       - Edge cases
       - Error handling
       - Boundary conditions
    4. Create test fixtures and mocks
    5. Ensure proper test isolation

    Test quality standards:
    - Descriptive test names (should_X_when_Y)
    - Arrange-Act-Assert pattern
    - One assertion per test (where practical)
    - Independent tests (no shared state)
    - Fast execution

  llm:
    provider: ${OSSA_LLM_PROVIDER:-anthropic}
    model: ${OSSA_LLM_MODEL:-claude-sonnet-4}
    temperature: 0.3
    maxTokens: ${OSSA_LLM_MAX_TOKENS:-16384}

  tools:
    - name: code.parse
      description: Parse code into AST
      handler:
        runtime: local
        capability: ast.parse

    - name: coverage.analyze
      description: Analyze test coverage
      handler:
        runtime: docker
        image: node:20-alpine
        command: ["npx", "c8", "--reporter=json"]

    - name: test.write
      description: Write test file
      handler:
        runtime: local
        capability: fs.write

    - name: test.run
      description: Run test suite
      handler:
        runtime: local
        capability: test.execute

  # Language-specific configurations
  languages:
    typescript:
      framework: vitest
      patterns:
        - "*.test.ts"
        - "*.spec.ts"
      fixtures_dir: "__fixtures__"

    python:
      framework: pytest
      patterns:
        - "test_*.py"
        - "*_test.py"
      fixtures_dir: "fixtures"

    php:
      framework: phpunit
      patterns:
        - "*Test.php"
      fixtures_dir: "tests/fixtures"

    go:
      framework: testing
      patterns:
        - "*_test.go"

  contracts:
    provides:
      - name: test-generation
        version: "1.0"
        schema:
          input:
            type: object
            properties:
              source_path:
                type: string
                description: Path to source file or directory
              test_type:
                type: string
                enum: [unit, integration, e2e]
              coverage_target:
                type: number
                description: Target coverage percentage
          output:
            type: object
            properties:
              tests_created:
                type: integer
              files:
                type: array
                items:
                  type: string
              coverage_before:
                type: number
              coverage_after:
                type: number
