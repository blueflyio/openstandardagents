# ============================================================================
# OSSA Power Agent: Data Transformer
# ============================================================================
# Data pipeline and transformation agent for ETL operations, format
# conversion, validation, and data quality checks.
#
# Showcases: Task kind (deterministic), batch processing, data contracts
# ============================================================================

apiVersion: ossa/v0.3.2
kind: Task
metadata:
  name: data-transformer
  version: 1.0.0
  description: Data transformation and ETL pipeline agent
  labels:
    ossa.dev/category: data
    ossa.dev/tier: power-agent
    ossa.dev/execution: deterministic
  annotations:
    ossa.dev/documentation: https://openstandardagents.org/agents/data-transformer

spec:
  # Task-specific execution configuration
  execution:
    type: deterministic
    runtime: any  # Can run on any runtime
    batch:
      enabled: true
      parallelism: 10
      chunk_size: 1000
    retry:
      max_attempts: 3
      backoff: exponential

  capabilities:
    - name: data.extract
      description: Extract data from various sources
    - name: data.transform
      description: Transform data between formats
    - name: data.validate
      description: Validate data against schemas
    - name: data.load
      description: Load data to destination

  role: |
    You are a data transformation specialist responsible for ETL pipelines,
    format conversion, and data quality validation.

    ETL workflow:
    1. Extract - Read from sources (API, database, files)
    2. Transform - Convert, clean, normalize, enrich
    3. Validate - Check against schemas, business rules
    4. Load - Write to destination systems

    Data quality checks:
    - Schema compliance
    - Null/empty value detection
    - Type validation
    - Range/boundary checks
    - Referential integrity
    - Duplicate detection

  # Note: Tasks may not need LLM for deterministic operations
  llm:
    provider: ${OSSA_LLM_PROVIDER:-anthropic}
    model: ${OSSA_LLM_MODEL:-claude-haiku-3-5}  # Faster model for data tasks
    temperature: 0.0  # Deterministic
    maxTokens: ${OSSA_LLM_MAX_TOKENS:-4096}

  tools:
    - name: data.read.json
      description: Read JSON data
      handler:
        runtime: local
        capability: fs.read.json

    - name: data.read.csv
      description: Read CSV data
      handler:
        runtime: local
        capability: fs.read.csv

    - name: data.read.yaml
      description: Read YAML data
      handler:
        runtime: local
        capability: fs.read.yaml

    - name: data.write
      description: Write data to file
      handler:
        runtime: local
        capability: fs.write

    - name: data.validate
      description: Validate against JSON Schema
      handler:
        runtime: local
        capability: jsonschema.validate

    - name: db.query
      description: Query database
      handler:
        runtime: local
        capability: db.query

  # Input/output contracts for deterministic execution
  input:
    type: object
    required: [source, destination]
    properties:
      source:
        type: object
        properties:
          type:
            type: string
            enum: [file, api, database]
          path:
            type: string
          format:
            type: string
            enum: [json, csv, yaml, xml]
      destination:
        type: object
        properties:
          type:
            type: string
            enum: [file, api, database]
          path:
            type: string
          format:
            type: string
      transformations:
        type: array
        items:
          type: object
          properties:
            field:
              type: string
            operation:
              type: string
              enum: [rename, map, filter, aggregate, join]
            config:
              type: object

  output:
    type: object
    properties:
      records_processed:
        type: integer
      records_succeeded:
        type: integer
      records_failed:
        type: integer
      errors:
        type: array
        items:
          type: object
          properties:
            record_id:
              type: string
            error:
              type: string
      duration_ms:
        type: integer

  contracts:
    provides:
      - name: data-transformation
        version: "1.0"
        schema:
          input: ${spec.input}
          output: ${spec.output}
