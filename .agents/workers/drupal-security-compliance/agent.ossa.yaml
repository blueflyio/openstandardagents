apiVersion: ossa/v0.3.3
kind: Agent

metadata:
  name: drupal-security-compliance
  version: 1.0.0
  description: |
    Drupal security and compliance specialist for FedRAMP, NIST, and
    enterprise security requirements.

  labels:
    ossa-version: v0.3.3
    platform: drupal
    provider: blueflyio
    category: worker
    domain: security

spec:
  taxonomy:
    domain: security
    subdomain: compliance
    capability: drupal-security

  role: |
    You are a Drupal Security and Compliance specialist.

    Your responsibilities:
    1. Perform comprehensive security audits following NIST and FedRAMP guidelines
    2. Scan for vulnerabilities in Drupal core, modules, and custom code
    3. Assess compliance against FedRAMP, HIPAA, SOX, GDPR frameworks
    4. Generate security hardening configurations
    5. Create remediation plans with prioritized actions

    Always follow security best practices and compliance requirements.

  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-sonnet-4}
    temperature: 0.1
    maxTokens: 8000

    fallback_models:
      - provider: ${LLM_FALLBACK_PROVIDER_1:-openai}
        model: ${LLM_FALLBACK_MODEL_1:-gpt-4o}

    retry_config:
      max_attempts: 3
      backoff_strategy: exponential

    cost_tracking:
      enabled: true
      budget_alert_threshold: 100.00
      cost_allocation_tags:
        platform: drupal
        team: security-agents

  capabilities:
    - name: security_audit
      description: Comprehensive security audit of Drupal site following NIST and FedRAMP guidelines
      input_schema:
        type: object
        required: [siteInfo]
        properties:
          siteInfo:
            type: object
            properties:
              drupalRoot:
                type: string
              siteUrl:
                type: string
              environment:
                type: string
                enum: [development, staging, production]
              drupalVersion:
                type: string
          auditScope:
            type: object
            properties:
              codeAudit:
                type: boolean
                default: true
              configAudit:
                type: boolean
                default: true
              moduleAudit:
                type: boolean
                default: true
          complianceFrameworks:
            type: array
            items:
              type: string
              enum: [fedramp, nist_csf, nist_800_53, sox, hipaa, gdpr, wcag_aa]
      output_schema:
        type: object
        properties:
          auditId:
            type: string
          overallScore:
            type: number
          riskLevel:
            type: string
            enum: [low, medium, high, critical]
          findings:
            type: array

    - name: vulnerability_scan
      description: Automated vulnerability scanning for Drupal core, modules, and custom code
      input_schema:
        type: object
        required: [target]
        properties:
          target:
            type: object
            properties:
              type:
                type: string
                enum: [site, code, modules, dependencies]
              path:
                type: string
              url:
                type: string
          scanOptions:
            type: object
            properties:
              scanDepth:
                type: string
                enum: [basic, standard, comprehensive]
                default: standard
              includeContrib:
                type: boolean
                default: true
      output_schema:
        type: object
        properties:
          scanId:
            type: string
          vulnerabilities:
            type: array
          summary:
            type: object

    - name: compliance_assessment
      description: Detailed compliance assessment against specific frameworks
      input_schema:
        type: object
        required: [framework, siteInfo]
        properties:
          framework:
            type: string
            enum: [fedramp_low, fedramp_moderate, fedramp_high, nist_csf, nist_800_53, sox, hipaa, gdpr]
          siteInfo:
            type: object
            properties:
              drupalRoot:
                type: string
              configPath:
                type: string
              environment:
                type: string
      output_schema:
        type: object
        properties:
          assessmentId:
            type: string
          complianceStatus:
            type: string
            enum: [compliant, partially_compliant, non_compliant]
          overallScore:
            type: number
          controlsAssessment:
            type: array

    - name: generate_security_hardening
      description: Generate security hardening configuration for Drupal
      input_schema:
        type: object
        required: [environment, securityLevel]
        properties:
          environment:
            type: string
            enum: [development, staging, production]
          securityLevel:
            type: string
            enum: [basic, enhanced, maximum]
          requirements:
            type: object
            properties:
              fedramp:
                type: boolean
                default: false
              hipaa:
                type: boolean
                default: false
      output_schema:
        type: object
        properties:
          hardeningId:
            type: string
          configurations:
            type: object
          securityModules:
            type: array
          policies:
            type: array

  autonomy:
    level: advisory
    approval_required:
      - generate_security_hardening
    escalation:
      enabled: true
      triggers:
        - critical_vulnerability
        - compliance_failure
      target: security-team

  constraints:
    cost:
      maxTokensPerDay: 300000
      maxCostPerDay: 30.00
    time:
      maxTurns: 40
      timeout: 1800

  runtime:
    type: docker
    config:
      timeout: 1800
      retries: 3
      resources:
        cpu: 2
        memory: 4Gi

  observability:
    logging:
      level: info
    metrics:
      enabled: true
    tracing:
      enabled: true
      provider: otel

  safety:
    content_filtering:
      enabled: true
      block_secrets: true
    guardrails:
      enabled: true
    output_filtering:
      redact_secrets: true
      redact_pii: true

  compliance:
    profiles:
      - fedramp-moderate
      - nist-csf
    audit:
      enabled: true
      retention_days: 2555

  integration:
    platform: drupal
    version: ">=10.0.0"
    configuration:
      protocol: http
      endpoints:
        base_url: http://localhost:3000
        health: /health
        metrics: /metrics

extensions:
  opentelemetry:
    enabled: true
    service_name: "drupal-security-compliance"
    traces:
      enabled: true
      exporter: otlp
      endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT:-http://localhost:4317}"
    metrics:
      enabled: true
      exporter: otlp
      endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT:-http://localhost:4317}"
      enabled: true
      api_key_env: "PHOENIX_API_KEY"
    langfuse:
      enabled: true
      public_key_env: "LANGFUSE_PUBLIC_KEY"
      secret_key_env: "LANGFUSE_SECRET_KEY"
    resource_attributes:
      agent.id: "drupal-security-compliance"
      domain: "security"
      compliance: "fedramp,soc2"
