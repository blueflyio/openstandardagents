openapi: 3.1.0
jsonSchemaDialect: https://spec.openapis.org/oas/3.1/dialect/base
info:
  title: OSSA Orchestration API
  version: 0.1.9
  description: |
    Orchestration API for managing multi-agent workflows, task distribution,
    and the 360° feedback loop (Plan → Execute → Review → Judge → Learn → Govern)

servers:
  - url: http://localhost:3002/api/v1
    description: Local orchestration server
  - url: https://orchestrator.ossa.bluefly.io/api/v1
    description: Production orchestration server

paths:
  /orchestration/workflows:
    post:
      summary: Create new workflow
      operationId: createWorkflow
      tags:
        - Workflows
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowDefinition'
      responses:
        '201':
          description: Workflow created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowInstance'

  /orchestration/workflows/{workflowId}/execute:
    post:
      summary: Execute workflow
      operationId: executeWorkflow
      tags:
        - Workflows
      parameters:
        - name: workflowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecutionRequest'
      responses:
        '202':
          description: Workflow execution started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionResponse'

  /orchestration/tasks/distribute:
    post:
      summary: Distribute task to agents
      operationId: distributeTasks
      tags:
        - Tasks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskDistribution'
      responses:
        '200':
          description: Tasks distributed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DistributionResult'

  /orchestration/feedback-loop/initiate:
    post:
      summary: Initiate 360° feedback loop
      operationId: initiateFeedbackLoop
      tags:
        - FeedbackLoop
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackLoopRequest'
      responses:
        '202':
          description: Feedback loop initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackLoopInstance'

  /orchestration/agents/allocate:
    post:
      summary: Allocate agents to task
      operationId: allocateAgents
      tags:
        - AgentManagement
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AllocationRequest'
      responses:
        '200':
          description: Agents allocated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllocationResponse'

  /orchestration/agents/spin-up:
    post:
      summary: Spin up new agent instances
      operationId: spinUpAgents
      tags:
        - AgentManagement
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SpinUpRequest'
      responses:
        '201':
          description: Agents spun up
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpinUpResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for accessing services
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authenticated requests
    OAuth2:
      type: oauth2
      description: OAuth2 authentication
      flows:
        authorizationCode:
          authorizationUrl: https://auth.llm.bluefly.io/oauth/authorize
          tokenUrl: https://auth.llm.bluefly.io/oauth/token
          scopes:
            read: Read access to resources
            write: Write access to resources
            admin: Administrative access
  schemas:
    WorkflowDefinition:
      type: object
      required:
        - name
        - tasks
        - dependencies
      properties:
        name:
          type: string
        description:
          type: string
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/TaskDefinition'
        dependencies:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
        budget:
          $ref: '#/components/schemas/Budget'

    TaskDefinition:
      type: object
      required:
        - id
        - type
        - requirements
      properties:
        id:
          type: string
        type:
          type: string
        description:
          type: string
        requirements:
          type: object
          properties:
            capabilities:
              type: array
              items:
                type: string
            agentType:
              type: string
            agentSubType:
              type: string
        input:
          type: object
        expectedOutput:
          type: object

    FeedbackLoopRequest:
      type: object
      required:
        - taskId
        - phases
      properties:
        taskId:
          type: string
        phases:
          type: array
          items:
            type: string
            enum: [plan, execute, review, judge, learn, govern]
        agents:
          type: object
          properties:
            orchestrator:
              type: string
            workers:
              type: array
              items:
                type: string
            critics:
              type: array
              items:
                type: string
            judge:
              type: string
            trainer:
              type: string
            governor:
              type: string

    SpinUpRequest:
      type: object
      required:
        - agents
      properties:
        agents:
          type: array
          items:
            type: object
            required:
              - type
              - count
            properties:
              type:
                type: string
              subtype:
                type: string
              count:
                type: integer
                minimum: 1
              config:
                type: object
              resources:
                type: object

    SpinUpResponse:
      type: object
      properties:
        spunUp:
          type: array
          items:
            type: object
            properties:
              agentId:
                type: string
              type:
                type: string
              status:
                type: string
              endpoint:
                type: string
        total:
          type: integer
        successful:
          type: integer
        failed:
          type: integer

    AllocationRequest:
      type: object
      required:
        - taskId
        - requirements
      properties:
        taskId:
          type: string
        requirements:
          type: object
          properties:
            capabilities:
              type: array
              items:
                type: string
            minAgents:
              type: integer
            maxAgents:
              type: integer
            performance:
              type: object
            budget:
              type: object

    AllocationResponse:
      type: object
      properties:
        allocated:
          type: array
          items:
            type: object
            properties:
              agentId:
                type: string
              type:
                type: string
              role:
                type: string
              capabilities:
                type: array
                items:
                  type: string
        strategy:
          type: string
          enum: [optimal, balanced, cost-efficient, performance]

    Budget:
      type: object
      properties:
        tokens:
          type: object
          properties:
            total:
              type: integer
            perPhase:
              type: object
            perAgent:
              type: object
        time:
          type: object
          properties:
            total:
              type: integer
            perPhase:
              type: object

    TaskDistribution:
      type: object
      required:
        - task
        - strategy
      properties:
        task:
          $ref: '#/components/schemas/TaskDefinition'
        strategy:
          type: string
          enum: [round-robin, least-loaded, capability-match, cost-optimal]
        constraints:
          type: object

    DistributionResult:
      type: object
      properties:
        taskId:
          type: string
        assignments:
          type: array
          items:
            type: object
            properties:
              agentId:
                type: string
              subtask:
                type: object
              estimatedDuration:
                type: integer
              tokenBudget:
                type: integer

    ExecutionRequest:
      type: object
      properties:
        input:
          type: object
        config:
          type: object
        timeout:
          type: integer

    ExecutionResponse:
      type: object
      properties:
        executionId:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, completed, failed]
        startedAt:
          type: string
          format: date-time

    WorkflowInstance:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        status:
          type: string
        createdAt:
          type: string
          format: date-time

    FeedbackLoopInstance:
      type: object
      properties:
        id:
          type: string
          format: uuid
        taskId:
          type: string
        currentPhase:
          type: string
        phases:
          type: object
          properties:
            plan:
              type: object
            execute:
              type: object
            review:
              type: object
            judge:
              type: object
            learn:
              type: object
            govern:
              type: object
        status:
          type: string
        startedAt:
          type: string
          format: date-time

security:
  - ApiKeyAuth: []
  - BearerAuth: []