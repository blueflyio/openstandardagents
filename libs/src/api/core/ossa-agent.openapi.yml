openapi: 3.1.0
info:
  title: OSSA Agent API
  version: 0.1.9-alpha.1
  description: Standard API specification for OSSA-compliant agents
  contact:
    name: OSSA Support
    email: support@ossa.io
    url: https://ossa.io/support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
  x-ossa:
    version: 0.1.9-alpha.1
    conformance_tier: core
    protocols: [mcp, ossa, rest]
    compliance:
      frameworks:
        - NIST-800-53
        - FedRAMP-Moderate
      audit_level: governed

servers:
  - url: http://localhost:{port}/api/v1
    description: Local development
    variables:
      port:
        default: '3000'
  - url: https://{environment}.ossa.io/api/v1
    description: Cloud deployment
    variables:
      environment:
        default: staging
        enum: [staging, production]

tags:
  - name: System
    description: System operations and health
  - name: Execution
    description: Task execution endpoints
  - name: Discovery
    description: Agent discovery and registration
  - name: Configuration
    description: Agent configuration management
  - name: Training
    description: Training data submission
  - name: Monitoring
    description: Metrics and observability
  - name: MCP
    description: Model Context Protocol operations
  - name: Workflow
    description: Workflow orchestration

paths:
  # System Endpoints
  /agent/health:
    get:
      operationId: getHealth
      summary: Agent health check
      tags: [System]
      security: []
      responses:
        '200':
          description: Agent is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
              examples:
                healthy:
                  value:
                    status: healthy
                    timestamp: "2025-01-15T12:00:00Z"
                    uptime: 3600
                    version: "0.1.9"
                    ossa_version: "0.1.9-alpha.1"
                    memory_usage:
                      used: 256000000
                      total: 1073741824
                    active_tasks: 5

  /agent/info:
    get:
      operationId: getAgentInfo
      summary: Get agent information
      tags: [System]
      responses:
        '200':
          description: Agent information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentInfo'

  /agent/shutdown:
    post:
      operationId: shutdownAgent
      summary: Gracefully shutdown agent
      tags: [System]
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                timeout:
                  type: integer
                  description: Shutdown timeout in seconds
                  default: 30
                force:
                  type: boolean
                  default: false
      responses:
        '202':
          description: Shutdown initiated

  # Discovery Endpoints
  /agent/capabilities:
    get:
      operationId: getCapabilities
      summary: Get agent capabilities
      tags: [Discovery]
      responses:
        '200':
          description: Agent capabilities
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Capabilities'

  /agent/discover:
    get:
      operationId: discoverPeers
      summary: Discover peer agents (UADP)
      tags: [Discovery]
      parameters:
        - name: capability
          in: query
          schema:
            type: string
          description: Filter by capability
        - name: scope
          in: query
          schema:
            type: string
            enum: [workspace, project, repository]
          description: Discovery scope
        - name: type
          in: query
          schema:
            type: string
            enum: [orchestrator, worker, critic, judge, trainer, governor, monitor, integrator, voice]
          description: Filter by agent type
      responses:
        '200':
          description: Discovered agents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiscoveryResponse'

  /agent/register:
    post:
      operationId: registerAgent
      summary: Register with workspace
      tags: [Discovery]
      security:
        - ApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegistrationRequest'
      responses:
        '201':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegistrationResponse'
        '409':
          description: Agent already registered

  # Execution Endpoints
  /agent/execute:
    post:
      operationId: executeTask
      summary: Execute agent task
      tags: [Execution]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskRequest'
            examples:
              simple:
                value:
                  type: process_text
                  payload:
                    text: "Process this text"
                  priority: 5
      responses:
        '202':
          description: Task accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /agent/execute/batch:
    post:
      operationId: executeBatch
      summary: Execute multiple tasks
      tags: [Execution]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tasks:
                  type: array
                  items:
                    $ref: '#/components/schemas/TaskRequest'
                parallel:
                  type: boolean
                  default: false
      responses:
        '202':
          description: Batch accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  batch_id:
                    type: string
                    format: uuid
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskResponse'

  /agent/status/{taskId}:
    get:
      operationId: getTaskStatus
      summary: Get task execution status
      tags: [Execution]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskStatus'
        '404':
          description: Task not found

  /agent/cancel/{taskId}:
    post:
      operationId: cancelTask
      summary: Cancel running task
      tags: [Execution]
      security:
        - BearerAuth: []
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task cancelled
        '404':
          description: Task not found

  # MCP Endpoints
  /mcp/tools:
    get:
      operationId: getMcpTools
      summary: List available MCP tools
      tags: [MCP]
      responses:
        '200':
          description: Available tools
          content:
            application/json:
              schema:
                type: object
                properties:
                  tools:
                    type: array
                    items:
                      $ref: '#/components/schemas/McpTool'

  /mcp/resources:
    get:
      operationId: getMcpResources
      summary: List available MCP resources
      tags: [MCP]
      responses:
        '200':
          description: Available resources
          content:
            application/json:
              schema:
                type: object
                properties:
                  resources:
                    type: array
                    items:
                      $ref: '#/components/schemas/McpResource'

  /mcp/prompts:
    get:
      operationId: getMcpPrompts
      summary: List available MCP prompts
      tags: [MCP]
      responses:
        '200':
          description: Available prompts
          content:
            application/json:
              schema:
                type: object
                properties:
                  prompts:
                    type: array
                    items:
                      $ref: '#/components/schemas/McpPrompt'

  # Configuration Endpoints
  /agent/behaviors:
    get:
      operationId: getBehaviors
      summary: Get agent behaviors
      tags: [Configuration]
      responses:
        '200':
          description: Agent behaviors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Behavior'

  /agent/behaviors/{behaviorName}:
    put:
      operationId: updateBehavior
      summary: Update behavior configuration
      tags: [Configuration]
      security:
        - BearerAuth: []
      parameters:
        - name: behaviorName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Behavior'
      responses:
        '200':
          description: Behavior updated

  /agent/handlers:
    get:
      operationId: getHandlers
      summary: Get event handlers
      tags: [Configuration]
      responses:
        '200':
          description: Event handlers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Handler'

  /agent/config:
    get:
      operationId: getConfig
      summary: Get agent configuration
      tags: [Configuration]
      responses:
        '200':
          description: Agent configuration
          content:
            application/json:
              schema:
                type: object
    patch:
      operationId: updateConfig
      summary: Update agent configuration
      tags: [Configuration]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Configuration updated

  # Training Endpoints
  /agent/training:
    post:
      operationId: submitTrainingData
      summary: Submit training examples
      tags: [Training]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrainingData'
      responses:
        '201':
          description: Training data accepted

  /agent/training/feedback:
    post:
      operationId: submitFeedback
      summary: Submit execution feedback
      tags: [Training]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                task_id:
                  type: string
                  format: uuid
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                feedback:
                  type: string
      responses:
        '201':
          description: Feedback accepted

  # Monitoring Endpoints
  /agent/metrics:
    get:
      operationId: getMetrics
      summary: Get agent metrics (Prometheus format)
      tags: [Monitoring]
      responses:
        '200':
          description: Agent metrics
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP ossa_agent_tasks_total Total tasks executed
                  # TYPE ossa_agent_tasks_total counter
                  ossa_agent_tasks_total{status="success"} 1234
            application/json:
              schema:
                $ref: '#/components/schemas/Metrics'

  /agent/logs:
    get:
      operationId: getLogs
      summary: Stream agent logs
      tags: [Monitoring]
      parameters:
        - name: since
          in: query
          schema:
            type: string
            format: date-time
        - name: level
          in: query
          schema:
            type: string
            enum: [debug, info, warn, error]
        - name: follow
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Log stream
          content:
            text/event-stream:
              schema:
                type: string

  /agent/traces/{traceId}:
    get:
      operationId: getTrace
      summary: Get execution trace
      tags: [Monitoring]
      parameters:
        - name: traceId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Execution trace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trace'

  # Workflow Endpoints
  /agent/workflow/validate:
    post:
      operationId: validateWorkflow
      summary: Validate workflow definition
      tags: [Workflow]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowDefinition'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  errors:
                    type: array
                    items:
                      type: string

  /agent/workflow/execute:
    post:
      operationId: executeWorkflow
      summary: Execute workflow
      tags: [Workflow]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowRequest'
      responses:
        '202':
          description: Workflow started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResponse'

# Component Schemas
components:
  schemas:
    AgentInfo:
      type: object
      required: [id, name, version, type, conformance_tier]
      properties:
        id:
          type: string
          pattern: '^[a-z0-9-]+'
          example: "example-worker-001"
        name:
          type: string
          example: "Example Worker Agent"
        version:
          type: string
          pattern: '^\d+\.\d+\.\d+(-[a-z0-9-]+)?'
          example: "0.1.9-alpha.1"
        type:
          type: string
          enum: [orchestrator, worker, critic, judge, trainer, governor, monitor, integrator, voice]
        subtype:
          type: string
          example: "worker.text-processor"
        conformance_tier:
          type: string
          enum: [core, governed, advanced, enterprise]
        namespace:
          type: string
          example: "project-namespace"
        description:
          type: string
        author:
          type: string
        license:
          type: string
        repository:
          type: string
          format: uri
        documentation:
          type: string
          format: uri
        created:
          type: string
          format: date-time
        updated:
          type: string
          format: date-time
        labels:
          type: object
          additionalProperties:
            type: string
        annotations:
          type: object
          additionalProperties:
            type: string

    HealthStatus:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        uptime:
          type: integer
          description: Uptime in seconds
        version:
          type: string
        ossa_version:
          type: string
        memory_usage:
          type: object
          properties:
            used:
              type: integer
            total:
              type: integer
            percentage:
              type: number
        cpu_usage:
          type: object
          properties:
            percentage:
              type: number
            cores:
              type: integer
        active_tasks:
          type: integer
        queue_depth:
          type: integer
        last_error:
          type: string
        checks:
          type: object
          properties:
            database:
              type: string
              enum: [healthy, degraded, unhealthy]
            cache:
              type: string
              enum: [healthy, degraded, unhealthy]
            dependencies:
              type: string
              enum: [healthy, degraded, unhealthy]

    Capabilities:
      type: object
      required: [primary, protocols, operations]
      properties:
        primary:
          type: array
          items:
            type: string
          example: ["text-processing", "data-validation"]
        secondary:
          type: array
          items:
            type: string
        operations:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              description:
                type: string
              inputSchema:
                type: object
              outputSchema:
                type: object
              timeout:
                type: integer
        protocols:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                enum: [ossa, mcp, rest, grpc, websocket]
              version:
                type: string
              features:
                type: array
                items:
                  type: string
              preferred:
                type: boolean
        resource_requirements:
          type: object
          properties:
            cpu:
              type: string
            memory:
              type: string
            gpu:
              type: string
        compliance:
          type: object
          properties:
            frameworks:
              type: array
              items:
                type: string
            certifications:
              type: array
              items:
                type: string

    TaskRequest:
      type: object
      required: [type, payload]
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          example: "process_text"
        payload:
          type: object
        context:
          type: object
          properties:
            user_id:
              type: string
            session_id:
              type: string
            trace_id:
              type: string
            parent_task_id:
              type: string
            metadata:
              type: object
        priority:
          type: integer
          minimum: 1
          maximum: 10
          default: 5
        timeout:
          type: integer
          description: Timeout in milliseconds
          default: 30000
        retry_policy:
          type: object
          properties:
            max_attempts:
              type: integer
              default: 3
            backoff:
              type: string
              enum: [linear, exponential]
            initial_delay:
              type: integer
        callbacks:
          type: object
          properties:
            on_success:
              type: string
              format: uri
            on_failure:
              type: string
              format: uri
            on_progress:
              type: string
              format: uri

    TaskResponse:
      type: object
      required: [task_id, status]
      properties:
        task_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [accepted, rejected, queued]
        reason:
          type: string
          description: Rejection reason if applicable
        estimated_completion:
          type: integer
          description: Estimated time to completion in milliseconds
        queue_position:
          type: integer
        webhook_url:
          type: string
          format: uri
          description: URL for status updates

    TaskStatus:
      type: object
      required: [task_id, status]
      properties:
        task_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, running, completed, failed, cancelled, timeout]
        progress:
          type: integer
          minimum: 0
          maximum: 100
        current_step:
          type: string
        total_steps:
          type: integer
        result:
          type: object
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
            stack_trace:
              type: string
        metrics:
          type: object
          properties:
            execution_time:
              type: integer
            cpu_time:
              type: integer
            memory_peak:
              type: integer
            io_operations:
              type: integer
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        retry_count:
          type: integer

    DiscoveryResponse:
      type: object
      properties:
        discovered_at:
          type: string
          format: date-time
        scope:
          type: string
          enum: [workspace, project, repository]
        agents:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              type:
                type: string
              capabilities:
                type: array
                items:
                  type: string
              endpoint:
                type: string
                format: uri
              health:
                type: string
                enum: [healthy, degraded, unknown]
              load:
                type: number
                minimum: 0
                maximum: 1
              available:
                type: boolean
              conformance_tier:
                type: string
              last_seen:
                type: string
                format: date-time

    RegistrationRequest:
      type: object
      required: [agent_id, endpoint, capabilities, manifest]
      properties:
        agent_id:
          type: string
        endpoint:
          type: string
          format: uri
        manifest:
          type: object
        capabilities:
          type: array
          items:
            type: string
        protocols:
          type: array
          items:
            type: string
        scope:
          type: string
          enum: [workspace, project, repository]
        ttl:
          type: integer
          description: Registration TTL in seconds

    RegistrationResponse:
      type: object
      properties:
        registered:
          type: boolean
        workspace_id:
          type: string
        registry_id:
          type: string
        registry_version:
          type: string
        assigned_role:
          type: string
        refresh_interval:
          type: integer
        token:
          type: string
          description: Registration token for future requests

    Behavior:
      type: object
      properties:
        name:
          type: string
        enabled:
          type: boolean
        priority:
          type: integer
        triggers:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [event, schedule, condition]
              pattern:
                type: string
              conditions:
                type: object
        actions:
          type: array
          items:
            type: string
        error_handling:
          type: object
          properties:
            strategy:
              type: string
              enum: [retry, fallback, escalate, ignore]
            max_attempts:
              type: integer
            fallback_behavior:
              type: string

    Handler:
      type: object
      properties:
        event:
          type: string
        action:
          type: string
        conditions:
          type: array
          items:
            type: object
        priority:
          type: integer
        async:
          type: boolean
        timeout:
          type: integer

    TrainingData:
      type: object
      properties:
        session_id:
          type: string
        examples:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              input:
                type: object
              output:
                type: object
              success:
                type: boolean
              feedback:
                type: object
              timestamp:
                type: string
                format: date-time

    Metrics:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        tasks:
          type: object
          properties:
            total:
              type: integer
            succeeded:
              type: integer
            failed:
              type: integer
            cancelled:
              type: integer
            timeout:
              type: integer
        performance:
          type: object
          properties:
            success_rate:
              type: number
            average_latency:
              type: integer
            p50_latency:
              type: integer
            p95_latency:
              type: integer
            p99_latency:
              type: integer
        resources:
          type: object
          properties:
            cpu_usage:
              type: number
            memory_usage:
              type: number
            disk_usage:
              type: number
            network_in:
              type: integer
            network_out:
              type: integer
        errors:
          type: array
          items:
            type: object
            properties:
              code:
                type: string
              count:
                type: integer
              last_occurrence:
                type: string
                format: date-time

    Trace:
      type: object
      properties:
        trace_id:
          type: string
        spans:
          type: array
          items:
            type: object
            properties:
              span_id:
                type: string
              parent_span_id:
                type: string
              operation:
                type: string
              start_time:
                type: string
                format: date-time
              end_time:
                type: string
                format: date-time
              duration:
                type: integer
              tags:
                type: object
              logs:
                type: array
                items:
                  type: object

    McpTool:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        inputSchema:
          type: object
        outputSchema:
          type: object

    McpResource:
      type: object
      properties:
        uri:
          type: string
        name:
          type: string
        description:
          type: string
        mimeType:
          type: string

    McpPrompt:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        arguments:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              description:
                type: string
              required:
                type: boolean

    WorkflowDefinition:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        version:
          type: string
        dag:
          type: object
          properties:
            nodes:
              type: array
              items:
                type: object
            edges:
              type: array
              items:
                type: object

    WorkflowRequest:
      type: object
      required: [workflow_id]
      properties:
        workflow_id:
          type: string
        inputs:
          type: object
        context:
          type: object
        priority:
          type: integer

    WorkflowResponse:
      type: object
      properties:
        execution_id:
          type: string
          format: uuid
        status:
          type: string
        webhook_url:
          type: string
          format: uri

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              code:
                type: string
              details:
                type: object

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                default: "Authentication required"

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                default: "Insufficient permissions"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                default: "Resource not found"

    ServiceUnavailable:
      description: Service unavailable
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              retry_after:
                type: integer
                description: Seconds to wait before retry

  securitySchemes:
    ApiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for agent authentication

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT bearer token authentication

    OAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://auth.ossa.io/authorize
          tokenUrl: https://auth.ossa.io/token
          scopes:
            read: Read agent data
            write: Execute tasks
            admin: Full administrative access

security:
  - ApiKey: []
  - BearerAuth: []
  - OAuth2: [read]

# Webhooks for async notifications
webhooks:
  taskComplete:
    post:
      summary: Task completion notification
      operationId: webhookTaskComplete
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                task_id:
                  type: string
                status:
                  type: string
                result:
                  type: object
      responses:
        '200':
          description: Webhook processed

  agentHealthChange:
    post:
      summary: Agent health status change notification
      operationId: webhookAgentHealthChange
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                agent_id:
                  type: string
                previous_status:
                  type: string
                current_status:
                  type: string
                timestamp:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Webhook processed