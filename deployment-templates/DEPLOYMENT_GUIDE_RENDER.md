# Render Deployment Guide - OSSA Buildkit

Complete guide for deploying OSSA Buildkit to Render with one-click blueprint configuration.

---

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Quick Deploy (One-Click)](#quick-deploy-one-click)
3. [Manual Setup](#manual-setup)
4. [Configuration](#configuration)
5. [Environment Variables](#environment-variables)
6. [Post-Deployment](#post-deployment)
7. [Troubleshooting](#troubleshooting)
8. [Advanced Configuration](#advanced-configuration)

---

## Prerequisites

### Required

- Render account ([sign up](https://render.com))
- GitHub/GitLab repository with OSSA Buildkit code
- Node.js 20+ (for local testing)

### Recommended

- Render CLI installed (`pip install render-cli`)
- Git configured with SSH keys
- Access to Drupal instance (if using Drupal integration)

---

## Quick Deploy (One-Click)

### Step 1: Deploy from Blueprint

1. Click the Render deploy button:

   [![Deploy to Render](https://render.com/images/deploy-to-render-button.svg)](https://render.com/deploy?repo=https://github.com/YOUR_ORG/ossa-buildkit)

2. Render will:
   - Fork or connect your repository
   - Read `render.yaml` blueprint
   - Create all services automatically

3. Click **Apply** to start deployment

### Step 2: Configure Secrets

Render will prompt for required environment variables. Set these:

```bash
# Core API Configuration
API_BASE_URL=https://your-api.onrender.com

# Drupal Integration
DRUPAL_BASE_URL=https://your-drupal-site.com
DRUPAL_API_KEY=your-drupal-api-key-here

# Vector Database
QDRANT_URL=https://your-qdrant.onrender.com
QDRANT_API_KEY=your-qdrant-api-key

# Security (auto-generated by Render)
JWT_SECRET=<auto-generated>
ENCRYPTION_KEY=<auto-generated>

# CORS Configuration
ALLOWED_ORIGINS=https://your-frontend.com,https://your-drupal.com

# Agent Registry
AGENT_REGISTRY_URL=https://registry.your-domain.com

# Monitoring (optional)
SENTRY_DSN=https://your-sentry-dsn@sentry.io/project

# Bridge Server
BRIDGE_API_KEY=<auto-generated>
CORS_ORIGINS=https://your-frontend.com
```

### Step 3: Deploy

1. Click **Create Services**
2. Wait for deployment (5-10 minutes)
3. Verify services are live

---

## Manual Setup

### Step 1: Install Render CLI

```bash
# Using pip
pip install render-cli

# Or using Homebrew (macOS)
brew install render

# Login
render login
```

### Step 2: Create render.yaml Blueprint

Copy the template to your project root:

```bash
cp deployment-templates/render.yaml.hbs render.yaml
```

**Fill in template variables** (or use template engine):

```yaml
# Example values for common variables
serviceName: ossa-buildkit
nodeEnv: production
region: oregon
plan: standard
branch: main
buildCommand: npm ci && npm run build
startCommand: npm start
port: 8080
replicas: 1
autoDeploy: true
preDeployCommand: npm run migrate
```

### Step 3: Create Services via CLI

```bash
# Validate blueprint
render blueprint validate

# Deploy blueprint
render blueprint apply

# Check status
render service list
```

### Step 4: Add Database and Cache

Render will automatically create:
- PostgreSQL database (`ossa-buildkit-postgres`)
- Redis cache (`ossa-buildkit-redis`)

Connection strings are auto-injected as environment variables.

---

## Configuration

### Service Architecture

Render will deploy:

1. **Web Service** (`ossa-buildkit`)
   - Node.js application
   - Public HTTP/HTTPS endpoint
   - Autoscaling enabled
   - Health checks: `/health`

2. **Bridge Server** (`ossa-buildkit-bridge`)
   - Node.js web service
   - Drupal ↔ OSSA bridge
   - Private service (optional)
   - Health checks: `/health`

3. **Background Workers** (`ossa-buildkit-worker`)
   - Long-running tasks
   - Agent execution queue
   - Connected to same database

4. **Cron Jobs**
   - `ossa-buildkit-cron-cleanup`: Daily cleanup
   - `ossa-buildkit-cron-sync`: Hourly sync with Drupal

5. **PostgreSQL Database**
   - Managed Postgres 16
   - Automatic backups
   - Point-in-time recovery

6. **Redis Cache**
   - Managed Redis 7
   - High availability
   - Automatic failover

### Service Plans

**Render Plan Recommendations:**

| Environment | Web Service | Worker | Database | Redis |
|-------------|-------------|--------|----------|-------|
| **Development** | Starter | Starter | Starter | Free |
| **Staging** | Standard | Starter | Standard | Standard |
| **Production** | Pro | Standard | Pro | Pro |

**Resource Allocation:**

```yaml
# render.yaml
services:
  - type: web
    name: ossa-buildkit
    plan: standard  # $25/month
    scaling:
      minInstances: 1
      maxInstances: 5
      targetMemoryPercent: 80
      targetCPUPercent: 70
```

### Autoscaling Configuration

Render autoscales based on:
- **CPU**: Scale when average > 70%
- **Memory**: Scale when average > 80%
- **Concurrent Requests**: Scale when > 100 requests/instance

Configure in `render.yaml`:

```yaml
scaling:
  minInstances: 1
  maxInstances: 10
  targetMemoryPercent: 80
  targetCPUPercent: 70
```

---

## Environment Variables

### Required Variables

| Variable | Description | How to Set |
|----------|-------------|------------|
| `API_BASE_URL` | Public API URL | Manual (after deployment) |
| `DRUPAL_BASE_URL` | Drupal site URL | Manual |
| `DRUPAL_API_KEY` | Drupal API key | Secret |
| `DATABASE_URL` | PostgreSQL connection | Auto-injected by Render |
| `REDIS_URL` | Redis connection | Auto-injected by Render |
| `QDRANT_URL` | Vector DB URL | Manual |
| `QDRANT_API_KEY` | Vector DB API key | Secret |
| `JWT_SECRET` | JWT signing secret | Auto-generated |
| `ENCRYPTION_KEY` | Encryption key | Auto-generated |
| `ALLOWED_ORIGINS` | CORS origins | Manual |

### Optional Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `LOG_LEVEL` | `info` | Logging verbosity |
| `RATE_LIMIT_WINDOW` | `60000` | Rate limit window (ms) |
| `RATE_LIMIT_MAX` | `100` | Max requests per window |
| `MAX_CONCURRENT_AGENTS` | `10` | Concurrent agent limit |
| `AGENT_TIMEOUT_MS` | `300000` | Agent timeout (5 min) |
| `CACHE_TTL_SECONDS` | `300` | Cache TTL |
| `ENABLE_METRICS` | `true` | Prometheus metrics |
| `SENTRY_DSN` | - | Error tracking |

### Setting Variables

**Via Render Dashboard:**

1. Go to service (e.g., `ossa-buildkit`)
2. Click **Environment** tab
3. Click **Add Environment Variable**
4. Enter key and value
5. Click **Save Changes**

**Via Render CLI:**

```bash
# Set variable
render env set API_BASE_URL=https://api.example.com

# Set secret
render env set DRUPAL_API_KEY=secret-value --secret

# Bulk set from file
render env set --file .env.production
```

**In render.yaml:**

```yaml
envVars:
  - key: LOG_LEVEL
    value: info

  - key: DRUPAL_API_KEY
    sync: false  # Must be set in dashboard

  - key: JWT_SECRET
    generateValue: true  # Auto-generated by Render
```

---

## Post-Deployment

### 1. Verify Deployment

```bash
# Check service status
render service list

# View logs
render logs --service ossa-buildkit --tail 100

# Check health endpoint
curl https://ossa-buildkit.onrender.com/health
```

Expected response:

```json
{
  "status": "healthy",
  "version": "0.4.1",
  "services": {
    "database": "connected",
    "redis": "connected",
    "qdrant": "connected"
  },
  "timestamp": "2026-02-04T12:00:00Z"
}
```

### 2. Configure Custom Domains

**Via Render Dashboard:**

1. Go to **Settings** → **Custom Domain**
2. Click **Add Custom Domain**
3. Enter domain: `api.your-domain.com`
4. Update DNS:
   ```
   CNAME api.your-domain.com → ossa-buildkit.onrender.com
   ```
5. SSL auto-provisioned (Let's Encrypt)

**Via Render CLI:**

```bash
render domain add api.your-domain.com --service ossa-buildkit
```

### 3. Setup Monitoring

**Built-in Metrics:**

Render provides:
- Request rate
- Response time (p50, p95, p99)
- Error rate
- Memory usage
- CPU usage

Access at: `https://dashboard.render.com/services/[service-id]/metrics`

**Custom Metrics:**

Enable Prometheus endpoint:

```yaml
envVars:
  - key: ENABLE_METRICS
    value: true
  - key: METRICS_PORT
    value: 9090
```

Access at: `https://your-app.onrender.com/metrics`

**Sentry Integration:**

```bash
render env set SENTRY_DSN=https://your-key@sentry.io/project
render env set SENTRY_ENVIRONMENT=production
```

### 4. Configure Backups

**Database Backups:**

Render automatically backs up databases:
- **Starter Plan**: Daily backups (7-day retention)
- **Standard Plan**: Daily backups (14-day retention)
- **Pro Plan**: Daily backups (30-day retention)

**Manual Backup:**

```bash
# Create snapshot
render database snapshot create ossa-buildkit-postgres

# List snapshots
render database snapshot list

# Restore from snapshot
render database snapshot restore [snapshot-id]
```

### 5. Setup Alerts

**Via Render Dashboard:**

1. Go to **Settings** → **Notifications**
2. Configure alerts:
   - Deployment failures
   - Service crashes
   - Health check failures
   - High error rates

**Webhook Integration:**

```yaml
services:
  - type: web
    name: ossa-buildkit
    alerts:
      - type: slack
        url: https://hooks.slack.com/services/YOUR/WEBHOOK/URL
      - type: pagerduty
        key: YOUR_PAGERDUTY_KEY
```

---

## Troubleshooting

### Deployment Failures

**Issue: Build fails**

```bash
# Check build logs
render logs --service ossa-buildkit --build

# Common causes:
# 1. Missing dependencies
# 2. TypeScript compilation errors
# 3. Node version mismatch

# Fix: Update render.yaml
services:
  - type: web
    buildCommand: npm ci --legacy-peer-deps && npm run build
    runtime: node
    nodeVersion: 20.x
```

**Issue: Service won't start**

```bash
# Check runtime logs
render logs --service ossa-buildkit --tail 500

# Common causes:
# 1. Missing environment variables
render env list

# 2. Port binding issues
# Ensure your app listens on process.env.PORT

# 3. Health check failures
# Verify /health returns 200 OK
```

### Performance Issues

**Issue: Slow response times**

```bash
# Check metrics
render metrics --service ossa-buildkit

# Scale up
render scale --min 2 --max 10

# Upgrade plan
render plan upgrade standard --service ossa-buildkit
```

**Issue: Memory leaks**

```bash
# Monitor memory usage
render metrics --metric memory

# Enable debug logging
render env set ENABLE_DEBUG=true
render env set LOG_LEVEL=debug

# Restart service
render restart --service ossa-buildkit
```

### Database Issues

**Issue: Connection pool exhausted**

```bash
# Check database connections
render database metrics ossa-buildkit-postgres

# Increase pool size (in your app)
# or upgrade database plan
render plan upgrade standard --database ossa-buildkit-postgres
```

**Issue: Slow queries**

```bash
# Enable query logging
render database logs ossa-buildkit-postgres

# Analyze slow queries
# Add indexes where needed
```

### Networking Issues

**Issue: CORS errors**

```bash
# Update ALLOWED_ORIGINS
render env set ALLOWED_ORIGINS=https://your-frontend.com,https://your-drupal.com

# Verify CORS headers
curl -I -H "Origin: https://your-frontend.com" \
  https://ossa-buildkit.onrender.com/api/agents
```

**Issue: Timeouts**

```bash
# Increase timeout settings
render env set REQUEST_TIMEOUT_MS=60000
render env set AGENT_TIMEOUT_MS=600000

# Check for long-running queries
# Consider moving to background workers
```

### Debug Mode

```bash
# Enable comprehensive debugging
render env set ENABLE_DEBUG=true
render env set LOG_LEVEL=debug
render env set NODE_ENV=development

# Stream logs
render logs --service ossa-buildkit --follow

# Disable debug when done
render env set ENABLE_DEBUG=false
render env set LOG_LEVEL=info
```

---

## Advanced Configuration

### Private Services

Make bridge server private (internal only):

```yaml
services:
  - type: web
    name: ossa-buildkit-bridge
    envVars:
      - key: RENDER_INTERNAL_URL
        value: true
```

Access via internal hostname:
```
http://ossa-buildkit-bridge:8081
```

### Background Workers

Configure dedicated worker service:

```yaml
services:
  - type: worker
    name: ossa-buildkit-worker
    runtime: node
    buildCommand: npm ci && npm run build
    startCommand: npm run worker
    numInstances: 2
    envVars:
      - key: WORKER_CONCURRENCY
        value: 5
```

Worker code example:

```javascript
// worker.js
const { Worker } = require('bullmq');

const worker = new Worker('agents', async (job) => {
  // Process agent execution
  await executeAgent(job.data);
}, {
  connection: {
    url: process.env.REDIS_URL
  }
});
```

### Cron Jobs

Schedule recurring tasks:

```yaml
services:
  - type: cron
    name: cleanup-old-agents
    schedule: "0 2 * * *"  # Daily at 2 AM
    buildCommand: npm ci && npm run build
    startCommand: npm run cleanup
```

### Multi-Region Deployment

Deploy to multiple regions for low latency:

```yaml
services:
  - type: web
    name: ossa-buildkit-us
    region: oregon

  - type: web
    name: ossa-buildkit-eu
    region: frankfurt

  - type: web
    name: ossa-buildkit-asia
    region: singapore
```

Use Render's global load balancing or Cloudflare for routing.

### Preview Environments

Automatic preview deployments for PRs:

```yaml
services:
  - type: web
    name: ossa-buildkit
    autoDeploy: true
    previewsEnabled: true
    previewsExpireAfterDays: 7
```

### Health Check Configuration

Custom health checks:

```yaml
services:
  - type: web
    healthCheckPath: /health
    healthCheckTimeout: 30s
    healthCheckInterval: 60s
```

Implement health check endpoint:

```javascript
// health.js
app.get('/health', async (req, res) => {
  const checks = {
    database: await checkDatabase(),
    redis: await checkRedis(),
    qdrant: await checkQdrant()
  };

  const healthy = Object.values(checks).every(c => c);

  res.status(healthy ? 200 : 503).json({
    status: healthy ? 'healthy' : 'unhealthy',
    checks
  });
});
```

---

## Support

### Resources

- **Render Documentation**: https://render.com/docs
- **OSSA Documentation**: See `DRUPAL_INTEGRATION_INDEX.md`
- **Community Forum**: https://community.render.com

### Support Channels

- **Email**: support@render.com (paid plans)
- **Chat**: In-dashboard chat (paid plans)
- **Community**: https://community.render.com

### Commercial Support

Contact BlueFly.io for:
- Custom deployment configurations
- Performance optimization
- 24/7 support
- Enterprise SLA

---

## Next Steps

1. [Configure Railway Deployment](./DEPLOYMENT_GUIDE_RAILWAY.md)
2. [Configure Fly.io Deployment](./DEPLOYMENT_GUIDE_FLY.md)
3. [Environment Variables Reference](./ENVIRONMENT_VARIABLES.md)

---

**Last Updated**: 2026-02-04
**OSSA Version**: v0.4.1
**Render Blueprint Version**: v2
