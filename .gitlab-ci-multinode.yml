# Multi-Node Version Testing - Production-Grade CI
# Tests OSSA package on Node 16, 18, 20, and 22+

variables:
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/cache/Cypress"

# Cache for faster builds
cache:
  paths:
    - .npm
    - node_modules
    - cache/Cypress

# Test on multiple Node versions
.test_template:
  stage: test
  before_script:
    - node --version
    - npm --version
    - npm ci
  script:
    - npm run typecheck
    - npm run lint
    - npm run test:unit
    - npm run validate:schema
  artifacts:
    reports:
      junit: junit.xml
      coverage: coverage/
    paths:
      - coverage/
    when: always
    expire_in: 30 days
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

# Node 16 (Minimum supported version)
test:node-16:
  extends: .test_template
  image: node:16.20-alpine
  allow_failure: false

# Node 18 (LTS)
test:node-18:
  extends: .test_template
  image: node:18-alpine
  allow_failure: false

# Node 20 (LTS)
test:node-20:
  extends: .test_template
  image: node:20-alpine
  allow_failure: false

# Node 22 (Current)
test:node-22:
  extends: .test_template
  image: node:22-alpine
  allow_failure: false

# Integration tests (Node 20 only)
test:integration:
  stage: test
  image: node:20-alpine
  before_script:
    - node --version
    - npm --version
    - npm ci
  script:
    - npm run test:integration
  artifacts:
    reports:
      junit: junit.xml
    when: always
    expire_in: 7 days

# E2E smoke tests (Node 20 only)
test:e2e-smoke:
  stage: test
  image: node:20-alpine
  before_script:
    - node --version
    - npm --version
    - npm ci
  script:
    - npm run test:smoke
  artifacts:
    reports:
      junit: junit.xml
    when: always
    expire_in: 7 days

# Validation suite (Node 20 only)
validate:all:
  stage: test
  image: node:20-alpine
  before_script:
    - node --version
    - npm --version
    - npm ci
  script:
    - npm run validate:all
  artifacts:
    when: always
    expire_in: 7 days

# Security audit
security:audit:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
  script:
    - npm audit --audit-level=moderate || true
    - npm audit --json > security-audit.json || true
  artifacts:
    reports:
      dependency_scanning: security-audit.json
    paths:
      - security-audit.json
    when: always
    expire_in: 30 days
  allow_failure: true

# Dependency check
security:dependencies:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
  script:
    - npm run validate:deps
  allow_failure: true

# Release verification (only on tags)
release:verify:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
  script:
    - npm run release:verify
  only:
    - tags
  allow_failure: false
