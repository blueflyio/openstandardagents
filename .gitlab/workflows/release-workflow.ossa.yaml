# ============================================================================
# OSSA v0.3.0 Workflow: Release Orchestration
# ============================================================================
# Composes multiple agents and tasks into a complete release workflow
# Demonstrates OSSA v0.3.0 Workflow kind with all features
# ============================================================================

apiVersion: ossa/v0.3.2
kind: Workflow
metadata:
  name: release-orchestration-workflow
  version: 1.0.0
  description: "Complete release workflow from milestone closure to npm publish"
  labels:
    domain: release-automation
    priority: critical
    ossa-version: v0.3.0

spec:
  # ==========================================================================
  # TRIGGERS: Event-Driven Activation
  # ==========================================================================
  triggers:
    - type: webhook
      event: milestone
      conditions:
        - object_attributes.action == "close"
        - object_attributes.title matches "^v\\d+\\.\\d+\\.\\d+"

  # ==========================================================================
  # INPUTS: Workflow Input Schema
  # ==========================================================================
  inputs:
    type: object
    properties:
      milestone_id:
        type: integer
        description: GitLab milestone ID
      milestone_title:
        type: string
        description: Milestone title (e.g., "v0.3.0")
      project_id:
        type: integer
        description: GitLab project ID
    required:
      - milestone_id
      - milestone_title
      - project_id

  # ==========================================================================
  # OUTPUTS: Workflow Output Schema
  # ==========================================================================
  outputs:
    type: object
    properties:
      version:
        type: string
        description: Released version
      npm_url:
        type: string
        format: uri
        description: npm package URL
      release_url:
        type: string
        format: uri
        description: GitLab release URL
      success:
        type: boolean
        description: Whether release completed successfully

  # ==========================================================================
  # STEPS: Workflow Execution Steps
  # ==========================================================================
  steps:
    # Step 1: Validate milestone readiness
    - id: validate_milestone
      ref: .gitlab/agents/release-validator/manifest.ossa.yaml
      kind: Agent
      inputs:
        milestone_id: "{{ workflow.inputs.milestone_id }}"
        project_id: "{{ workflow.inputs.project_id }}"
      timeout_seconds: 60
      retry:
        max_attempts: 3
        backoff_strategy: exponential

    # Step 2: Generate changelog (Task - deterministic)
    - id: generate_changelog
      ref: .gitlab/tasks/generate-changelog-task.ossa.yaml
      kind: Task
      inputs:
        milestone_id: "{{ workflow.inputs.milestone_id }}"
        project_id: "{{ workflow.inputs.project_id }}"
      depends_on:
        - validate_milestone

    # Step 3: Validate release readiness
    - id: validate_release
      ref: .gitlab/agents/release-validator/manifest.ossa.yaml
      kind: Agent
      inputs:
        version: "{{ validate_milestone.outputs.version }}"
        changelog: "{{ generate_changelog.outputs.changelog }}"
      depends_on:
        - generate_changelog

    # Step 4: Publish to npm (Task - deterministic)
    - id: publish_npm
      ref: .gitlab/tasks/publish-npm-task.ossa.yaml
      kind: Task
      inputs:
        version: "{{ validate_milestone.outputs.version }}"
        access: public
      depends_on:
        - validate_release

    # Step 5: Create GitLab Release (Agent - needs AI for release notes)
    - id: create_release
      ref: .gitlab/agents/release-orchestrator/manifest.ossa.yaml
      kind: Agent
      inputs:
        version: "{{ validate_milestone.outputs.version }}"
        changelog: "{{ generate_changelog.outputs.changelog }}"
        milestone_title: "{{ workflow.inputs.milestone_title }}"
      depends_on:
        - publish_npm

    # Step 6: Close milestone (Task - deterministic)
    - id: close_milestone
      ref: .gitlab/tasks/close-milestone-task.ossa.yaml
      kind: Task
      inputs:
        milestone_id: "{{ workflow.inputs.milestone_id }}"
        project_id: "{{ workflow.inputs.project_id }}"
      depends_on:
        - create_release

    # Step 7: Post-release cleanup (Agent - coordinates multiple operations)
    - id: post_release_cleanup
      ref: .gitlab/agents/release-orchestrator/manifest.ossa.yaml
      kind: Agent
      inputs:
        version: "{{ validate_milestone.outputs.version }}"
        milestone_id: "{{ workflow.inputs.milestone_id }}"
      depends_on:
        - close_milestone

  # ==========================================================================
  # CONTEXT: Shared Workflow Variables
  # ==========================================================================
  context:
    variables:
      GITLAB_API_URL: "${CI_API_V4_URL}"
      NPM_REGISTRY: "https://registry.npmjs.org"
    secrets:
      - name: GITLAB_TOKEN
        ref: vault://gitlab-token
      - name: NPM_TOKEN
        ref: vault://npm-token

  # ==========================================================================
  # CONCURRENCY: Workflow Execution Control
  # ==========================================================================
  concurrency:
    group: release-{{ workflow.inputs.milestone_title }}
    cancel_in_progress: false

  # ==========================================================================
  # ERROR HANDLING: Failure Recovery
  # ==========================================================================
  error_handling:
    on_failure: rollback
    compensation_steps:
      - id: rollback_npm
        ref: .gitlab/tasks/rollback-npm-task.ossa.yaml
        kind: Task
        condition: "{{ publish_npm.status == 'failed' }}"
      - id: reopen_milestone
        ref: .gitlab/tasks/reopen-milestone-task.ossa.yaml
        kind: Task
        condition: "{{ close_milestone.status == 'failed' }}"

  # ==========================================================================
  # PARALLEL EXECUTION: Steps that can run concurrently
  # ==========================================================================
  parallel:
    - steps:
        - id: tag_issues
          ref: .gitlab/tasks/tag-issues-task.ossa.yaml
          kind: Task
        - id: create_next_milestone
          ref: .gitlab/tasks/create-milestone-task.ossa.yaml
          kind: Task
      depends_on:
        - post_release_cleanup

# ============================================================================
# EXTENSIONS: Framework Integrations
# ============================================================================
extensions:
  gitlab_duo:
    enabled: true
    flow_path: .gitlab/flows/release-orchestration-flow.yaml
    triggers:
      - event: milestone
        conditions:
          - action == "close"

  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: workflow-system
      labels:
        app.kubernetes.io/name: release-orchestration-workflow
        app.kubernetes.io/part-of: ossa-showcase

# ============================================================================
# RUNTIME: Runtime Capability Bindings
# ============================================================================
runtime:
  type: kubernetes
  bindings:
    gitlab_api:
      capability: gitlab_api_access
      binding: service_account
      service_account: gitlab-workflow-sa
    npm_registry:
      capability: npm_publish
      binding: secret
      secret: npm-token

