# GitLab Duo Agent Platform - OSSA Agent Files Trigger
# PUBLIC trigger for detecting changes to OSSA agent manifests
# Documentation: https://docs.gitlab.com/user/duo_agent_platform/triggers/
#
# What this trigger does:
# - Automatically detects when OSSA agent manifests are created or modified
# - Triggers the OSSA validation flow to ensure manifests comply with standards
# - Helps teams catch agent definition errors early in development
# - Works with any file format: .agent, agent.json, agent.yaml, *.ossa.yaml
#
# Why use this trigger:
# - Save time by validating agents automatically on every commit
# - Prevent invalid agent definitions from reaching production
# - Get immediate feedback in merge requests
# - Learn OSSA best practices through validation feedback
#
# How to use:
# 1. Copy this file to your project's .gitlab/triggers/ directory
# 2. Ensure the OSSA validation flow exists at .gitlab/workflows/ossa-validation-flow.yaml
# 3. Push changes to agent files - validation runs automatically!

name: ossa-agent-files-trigger
version: "1.0.0"
description: |
  Automatically detect and validate OSSA agent manifest files.

  This trigger watches for changes to agent definition files and kicks off
  comprehensive validation to ensure your agents follow OSSA standards.

  Perfect for:
  - Teams building multi-agent systems
  - Projects using OSSA for agent governance
  - Organizations standardizing on agent definitions
  - Anyone wanting to ensure agent quality

# Trigger metadata for discoverability
metadata:
  author: "BlueFly Agents Platform"
  license: "MIT"
  tags:
    - ossa
    - agents
    - validation
    - automation
  public: true
  documentation: "https://openstandardagents.com/docs/triggers"

# When to trigger - these events activate the validation flow
on:
  # Trigger on push to any branch
  # Why: Catch issues early, even in feature branches
  push:
    branches:
      - '**/*'  # All branches
    paths:
      # OSSA manifest files in any location
      - '**/*.ossa.yaml'
      - '**/*.ossa.yml'

      # Standard agent file names
      - '**/.agent'
      - '**/agent.json'
      - '**/agent.yaml'
      - '**/agent.yml'

      # GitLab Duo Agent Platform configs
      - '.gitlab/agents/**/config.yaml'
      - '.gitlab/agents/**/config.yml'

      # Platform-specific agent directories
      - 'platform-agents/**/*.yaml'
      - 'platform-agents/**/*.yml'
      - 'platform-agents/**/*.json'

      # Common agent directories (helps teams organize agents)
      - 'agents/**/*.yaml'
      - 'agents/**/*.yml'
      - 'agents/**/*.json'
      - '.agents/**/*.yaml'
      - '.agents/**/*.yml'
      - '.agents/**/*.json'

  # Trigger on merge request events
  # Why: Validate before merging to protect main branch
  merge_request:
    types:
      - opened      # New MR created
      - updated     # MR updated with new commits
      - reopened    # MR reopened after being closed
    paths:
      # Same file patterns as push events
      - '**/*.ossa.yaml'
      - '**/*.ossa.yml'
      - '**/.agent'
      - '**/agent.json'
      - '**/agent.yaml'
      - '**/agent.yml'
      - '.gitlab/agents/**/config.yaml'
      - '.gitlab/agents/**/config.yml'
      - 'platform-agents/**/*.yaml'
      - 'platform-agents/**/*.yml'
      - 'platform-agents/**/*.json'
      - 'agents/**/*.yaml'
      - 'agents/**/*.yml'
      - 'agents/**/*.json'
      - '.agents/**/*.yaml'
      - '.agents/**/*.yml'
      - '.agents/**/*.json'

  # Optional: Trigger on schedule for periodic validation
  # Useful for catching schema changes or validating entire agent library
  schedule:
    enabled: false  # Set to true to enable scheduled validation
    cron: '0 2 * * *'  # Daily at 2 AM UTC
    description: "Daily validation of all OSSA agent manifests"

# What to do when triggered - launch the validation flow
actions:
  # Step 1: Collect changed files
  - name: collect_changed_files
    description: |
      Identify which agent files changed in this commit/MR.
      This helps focus validation on relevant files only.
    run: |
      # Get list of changed files matching our patterns
      git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | \
        grep -E '\.(ossa\.yaml|ossa\.yml|agent\.json|agent\.yaml|agent\.yml)$|/\.agent$|/agents/.*/config\.yaml$' \
        > changed_agent_files.txt || true

      # Show what we found (helps users understand what's being validated)
      if [ -s changed_agent_files.txt ]; then
        echo "üìã Found agent files to validate:"
        cat changed_agent_files.txt | sed 's/^/  - /'
      else
        echo "‚ÑπÔ∏è  No agent files changed in this commit"
      fi

  # Step 2: Trigger the validation flow
  - name: trigger_validation
    description: |
      Launch the OSSA validation flow to check agent manifests.
      Results will be posted as MR comments (if in an MR).
    condition: ${{ steps.collect_changed_files.outputs.file_count > 0 }}
    trigger:
      project: ${{ CI_PROJECT_PATH }}
      workflow: .gitlab/workflows/ossa-validation-flow.yaml
      inputs:
        files_changed: ${{ steps.collect_changed_files.outputs.files }}
        schema_version: "0.3.3"  # Latest OSSA schema
        validation_level: "strict"  # Enforce best practices
        fail_fast: false  # Check all files, don't stop at first error
        post_mr_comment: true  # Post results to MR

# Filter rules - when NOT to trigger
filters:
  # Skip validation for certain branches (optional)
  exclude_branches:
    - 'docs/**'  # Documentation-only branches
    - 'tmp/**'   # Temporary branches

  # Skip validation for certain paths (optional)
  exclude_paths:
    - '**/examples/**/*.yaml'  # Example files (if you don't want to validate them)
    - '**/test/fixtures/**'    # Test fixtures

  # Skip validation for certain commit messages (optional)
  exclude_commit_messages:
    - '[skip ossa]'       # Explicitly skip OSSA validation
    - '[skip validation]' # Explicitly skip validation
    - 'WIP:'              # Work in progress commits

# Concurrency control
# Prevents multiple validation runs from stepping on each other
concurrency:
  group: ossa-trigger-${{ CI_MERGE_REQUEST_IID || CI_COMMIT_SHA }}
  cancel_in_progress: true  # Cancel old runs when new commits arrive

# Permissions required
# These are the minimum permissions needed for the trigger to work
permissions:
  repository:
    - read  # Read files to detect changes
  merge_requests:
    - write  # Post validation results as MR comments
  pipelines:
    - write  # Trigger validation workflows

# Environment variables
# Customize behavior using these variables
variables:
  # Default OSSA schema version to validate against
  # Override in project CI/CD settings if needed
  OSSA_SCHEMA_VERSION:
    value: "0.3.3"
    description: "OSSA schema version for validation"

  # Validation strictness level
  OSSA_VALIDATION_LEVEL:
    value: "strict"
    description: "Validation level: strict, normal, or permissive"
    options:
      - strict
      - normal
      - permissive

  # Whether to post MR comments
  OSSA_POST_MR_COMMENTS:
    value: "true"
    description: "Post validation results as MR comments"

  # Fail pipeline on validation errors
  OSSA_FAIL_ON_ERROR:
    value: "true"
    description: "Fail pipeline if validation errors found"

# Notification settings
# Keep teams informed about validation results
notifications:
  # Notify on validation failure
  on_failure:
    - type: merge_request_comment
      message: |
        ‚ùå **OSSA Agent Validation Failed**

        Your agent manifests have validation errors that need attention.
        Check the validation report above for details.

        **Common issues:**
        - Missing required fields (name, version, description)
        - Invalid access tier (must be tier_1_read through tier_4_policy)
        - Schema version mismatch
        - Security policy violations

        **Need help?**
        - [OSSA Documentation](https://openstandardagents.com/docs)
        - [Validation Guide](https://openstandardagents.com/docs/validation)
        - [Schema Reference](https://openstandardagents.com/schemas/v0.3.3)

  # Notify on validation success (optional)
  on_success:
    - type: merge_request_comment
      enabled: false  # Set to true if you want success notifications
      message: |
        ‚úÖ **OSSA Agent Validation Passed**

        All agent manifests comply with OSSA v0.3.3 standards.
        Great work maintaining quality agent definitions!

# Observability and monitoring
# Track trigger performance and usage
observability:
  # OpenTelemetry tracing
  opentelemetry:
    enabled: true
    traces: true
    metrics: true

  # Metrics to track
  metrics:
    - name: trigger_invocations
      type: counter
      description: "Number of times trigger fired"
      labels:
        - event_type
        - branch

    - name: files_validated
      type: histogram
      description: "Number of agent files validated per trigger"

    - name: trigger_duration
      type: histogram
      description: "Time from trigger to validation completion"

# Usage examples for adoption
# Copy these examples to your .gitlab-ci.yml
examples:
  - name: "Basic setup"
    description: |
      Enable automatic OSSA validation for your project.
      This is the simplest way to get started.
    code: |
      # .gitlab-ci.yml
      include:
        # Include the OSSA validation trigger
        - remote: 'https://gitlab.com/blueflyio/ossa/openstandardagents/-/raw/main/.gitlab/triggers/ossa-agent-files.yaml'

      # That's it! Validation runs automatically on push and MR

  - name: "Custom validation level"
    description: |
      Override the validation level for your project.
      Use 'permissive' for gradual adoption, 'strict' for production.
    code: |
      # .gitlab-ci.yml
      include:
        - remote: 'https://gitlab.com/blueflyio/ossa/openstandardagents/-/raw/main/.gitlab/triggers/ossa-agent-files.yaml'

      variables:
        OSSA_VALIDATION_LEVEL: "normal"  # Options: strict, normal, permissive

  - name: "Validate specific schema version"
    description: |
      Pin to a specific OSSA schema version.
      Useful when upgrading gradually.
    code: |
      # .gitlab-ci.yml
      include:
        - remote: 'https://gitlab.com/blueflyio/ossa/openstandardagents/-/raw/main/.gitlab/triggers/ossa-agent-files.yaml'

      variables:
        OSSA_SCHEMA_VERSION: "0.3.2"  # Pin to v0.3.2

  - name: "Disable MR comments"
    description: |
      Run validation but don't post MR comments.
      Results still visible in pipeline logs.
    code: |
      # .gitlab-ci.yml
      include:
        - remote: 'https://gitlab.com/blueflyio/ossa/openstandardagents/-/raw/main/.gitlab/triggers/ossa-agent-files.yaml'

      variables:
        OSSA_POST_MR_COMMENTS: "false"

  - name: "Scheduled validation"
    description: |
      Validate all agents daily to catch schema drift.
      Great for large agent libraries.
    code: |
      # .gitlab-ci.yml
      validate:all:agents:
        stage: validate
        trigger:
          include:
            - local: '.gitlab/triggers/ossa-agent-files.yaml'
          variables:
            schedule.enabled: "true"
            schedule.cron: "0 2 * * *"  # 2 AM daily
        only:
          - schedules

# Migration guide for existing projects
migration:
  from_manual_validation:
    description: |
      Migrating from manual OSSA validation? Here's how:

      1. Remove manual validation scripts from .gitlab-ci.yml
      2. Include this trigger (see examples above)
      3. Push a commit touching an agent file to test
      4. Check MR comments for validation results
      5. Adjust validation level if needed (strict ‚Üí normal ‚Üí permissive)

      Benefits:
      - Automatic validation on every push/MR
      - Consistent validation across team
      - No need to remember to run validation
      - Immediate feedback in MRs

# Troubleshooting guide
troubleshooting:
  - issue: "Trigger not firing"
    solution: |
      1. Check file patterns match your agent file locations
      2. Verify .gitlab/workflows/ossa-validation-flow.yaml exists
      3. Ensure GitLab Duo Agent Platform is enabled in project settings
      4. Check CI/CD pipeline logs for errors

  - issue: "Validation failing unexpectedly"
    solution: |
      1. Review validation error messages in MR comments
      2. Check OSSA schema version matches your manifests
      3. Try lowering validation level (strict ‚Üí normal)
      4. Validate manually: `npx @bluefly/compliance-engine validate-ossa <file>`

  - issue: "Too many false positives"
    solution: |
      1. Use OSSA_VALIDATION_LEVEL="permissive" for gradual adoption
      2. Review exclude_paths to skip non-production agents
      3. Upgrade to latest OSSA schema version
      4. Open issue at https://gitlab.com/blueflyio/ossa/openstandardagents/-/issues

# Support and community
support:
  documentation: "https://openstandardagents.com/docs/triggers"
  issues: "https://gitlab.com/blueflyio/ossa/openstandardagents/-/issues"
  discussions: "https://gitlab.com/blueflyio/ossa/openstandardagents/-/discussions"
  examples: "https://gitlab.com/blueflyio/ossa/openstandardagents/-/tree/main/examples"
