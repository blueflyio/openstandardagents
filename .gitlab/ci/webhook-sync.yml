# =============================================================================
# Webhook-Triggered Sync Pipeline
# Triggered by OSSA package releases via GitLab webhook
# =============================================================================

sync:webhook:
  stage: sync
  image: node:20-alpine
  variables:
    NODE_ENV: development
    GIT_STRATEGY: clone
  before_script:
    - apk add --no-cache git
    - git config user.email "ci@blueflyio.com"
    - git config user.name "GitLab CI Bot"
    - cd website
    - npm ci --prefer-offline --no-audit
  script:
    - echo "ðŸ”„ OSSA release webhook triggered"
    - echo "Version: ${OSSA_VERSION:-latest}"
    - echo "Trigger source: ${TRIGGER_SOURCE:-manual}"
    - echo "Framework pipeline: ${FRAMEWORK_PIPELINE_ID:-N/A}"
    - |
      # fetch-spec.js uses GitLab API directly - no npm package needed
      # It fetches from the openstandardagents repo (project 76265294)
      export OSSA_SPEC_VERSION="${OSSA_VERSION:-}"
    - npm run fetch-spec
    - npm run fetch-versions
    - npm run sync-version
    - npm run fetch-examples || echo "âš ï¸  fetch-examples failed (non-blocking)"
    - npm run sync-wiki || echo "âš ï¸  sync-wiki failed (non-blocking)"
    - |
      VERSION=${OSSA_VERSION:-$(npm view @bluefly/openstandardagents version 2>/dev/null || echo "latest")}
      BRANCH="chore/sync-ossa-${VERSION}"
      
      git checkout -b "$BRANCH"
      git add -A
      git commit -m "chore(ci): sync OSSA spec v${VERSION}

Triggered by OSSA package release webhook.

Closes #${CI_MERGE_REQUEST_IID:-auto}

[skip ci]"
      git push https://oauth2:${CI_JOB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git HEAD:"$BRANCH"
      
      # Determine target branch dynamically from version (major.minor.x)
      MAJOR_MINOR=$(echo "$VERSION" | sed 's/\([0-9]*\.[0-9]*\).*/\1/')
      TARGET_BRANCH="release/v${MAJOR_MINOR}.x"

      # Create MR
      curl --request POST \
        --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{
          \"source_branch\": \"$BRANCH\",
          \"target_branch\": \"$TARGET_BRANCH\",
          \"title\": \"chore(ci): sync OSSA spec v${VERSION}\",
          \"description\": \"Automated sync triggered by OSSA v${VERSION} release.\n\nâœ… Spec synced\nâœ… Examples updated\nâœ… Wiki synced\",
          \"remove_source_branch\": true,
          \"labels\": [\"automation\", \"ossa-sync\"]
        }" \
        "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/merge_requests"
      
      echo "âœ… MR created"
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
      when: always
  allow_failure: false
