# OSSA Version Management - Dynamic Version Injection
# NO HARDCODED VERSIONS IN MANIFESTS
# Version detection from Git tags, milestones, and branches
# Injected at deploy time via envsubst

detect-ossa-version:
  stage: version-detect
  image: alpine:latest
  before_script:
    - apk add --no-cache git bash
  script:
    - |
      #!/bin/bash
      set -e

      echo "Detecting OSSA Version..."
      echo "========================="
      echo ""

      # Priority 1 - Git tag (releases)
      if [ -n "$CI_COMMIT_TAG" ]; then
        OSSA_VERSION="$CI_COMMIT_TAG"
        echo "Using Git tag - $OSSA_VERSION"

      # Priority 2 - Milestone (feature branches)
      elif [ -n "$CI_MERGE_REQUEST_MILESTONE" ]; then
        OSSA_VERSION=$(echo "$CI_MERGE_REQUEST_MILESTONE" | sed 's/\.x$//')
        echo "Using milestone - $OSSA_VERSION"

      # Priority 3 - Release branch name
      elif echo "$CI_COMMIT_BRANCH" | grep -qE '^release/v[0-9]+\.[0-9]+\.x$'; then
        OSSA_VERSION=$(echo "$CI_COMMIT_BRANCH" | sed -E 's/release\/v?([0-9]+\.[0-9]+)\.x/v\1/')
        echo "Using release branch - $OSSA_VERSION"

      # Fallback - Default version
      else
        OSSA_VERSION="v0.3"
        echo "Using default version - $OSSA_VERSION"
      fi

      echo ""
      echo "Detected OSSA_VERSION=$OSSA_VERSION"
      echo ""

      # Export for subsequent jobs
      echo "OSSA_VERSION=$OSSA_VERSION" >> ossa-version.env
      echo "DETECTED_VERSION=$OSSA_VERSION" >> ossa-version.env

      # Show what will be injected
      echo "Version injection preview"
      echo "-------------------------"
      echo "apiVersion - ossa/\${OSSA_VERSION} becomes ossa/$OSSA_VERSION"
      echo "version - \${CI_COMMIT_SHA} becomes $CI_COMMIT_SHA"
      echo ""

  artifacts:
    reports:
      dotenv: ossa-version.env
    expire_in: 1 day
  rules:
    - when: always

validate-and-inject-version:
  stage: validate
  image: node:22
  needs: [detect-ossa-version]
  before_script:
    - npm ci
    - npm run build
  script:
    - |
      #!/bin/bash
      set -e

      echo "Injecting OSSA version into manifests..."
      echo "========================================="
      echo "OSSA_VERSION=$OSSA_VERSION"
      echo "CI_COMMIT_SHA=$CI_COMMIT_SHA"
      echo ""

      # Count manifests
      MANIFEST_COUNT=$(find .gitlab/agents -name "*.ossa.yaml" -type f | wc -l)
      echo "Found $MANIFEST_COUNT OSSA manifests"
      echo ""

      # Inject version into all OSSA manifests
      if [ $MANIFEST_COUNT -gt 0 ]; then
        find .gitlab/agents -name "*.ossa.yaml" -type f | while read manifest; do
          echo "Processing $manifest"

          # Use envsubst to replace variables
          envsubst < "$manifest" > "$manifest.tmp"
          mv "$manifest.tmp" "$manifest"

          # Show what was injected (first few lines)
          echo "  apiVersion - $(grep "^apiVersion" "$manifest" || echo "not found")"
          echo "  version - $(grep "^  version" "$manifest" | head -1 || echo "not found")"
        done
        echo ""
        echo "Version injection complete"
      else
        echo "No OSSA manifests found, skipping injection"
      fi
      echo ""

      # Validate all manifests with injected versions
      echo "Validating manifests..."
      echo "----------------------"
      npx ossa validate .gitlab/agents/**/*.ossa.yaml --schema-version "$OSSA_VERSION" || {
        echo ""
        echo "Validation failed!"
        echo "Check manifests in .gitlab/agents/"
        exit 1
      }

      echo ""
      echo "All manifests valid with OSSA version $OSSA_VERSION"

  artifacts:
    paths:
      - .gitlab/agents/
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'
    - if: '$CI_COMMIT_BRANCH =~ /^release\//'

deploy-agents-with-version:
  stage: deploy
  image: bitnami/kubectl:latest
  needs: [validate-and-inject-version]
  script:
    - |
      #!/bin/bash
      set -e

      echo "Deploying OSSA agents to Kubernetes..."
      echo "======================================"
      echo "OSSA_VERSION=$OSSA_VERSION"
      echo ""

      # Deploy to K8s with version injected
      DEPLOYED=0
      for agent in .gitlab/agents/**/*.ossa.yaml; do
        if [ -f "$agent" ]; then
          echo "Deploying $agent"
          kubectl apply -f "$agent" --dry-run=client || {
            echo "Dry-run failed for $agent"
            exit 1
          }
          DEPLOYED=$((DEPLOYED + 1))
        fi
      done

      echo ""
      echo "Deployed $DEPLOYED agents with OSSA version $OSSA_VERSION"

  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - if: '$CI_COMMIT_TAG'
      when: on_success
  environment:
    name: production
    kubernetes:
      namespace: ossa-agents
