# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Schema Automation CI Jobs
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# These jobs automate SDK generation and validation from the JSON Schema.
# Triggered by schema changes or manually for releases.
#
# Uses OSSA Task definitions in .gitlab/agents/tasks/ for execution.
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# VALIDATE: Run example validation against schema
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
schema:validate-examples:
  stage: validate
  image: node:${NODE_VERSION:-22}-alpine
  script:
    - npm ci --legacy-peer-deps
    - |
      echo "ğŸ” Validating YAML examples against schema..."

      VERSION=$(node -p "require('./package.json').version")
      SCHEMA_PATH="spec/v${VERSION}/ossa-${VERSION}.schema.json"

      if [ ! -f "$SCHEMA_PATH" ]; then
        echo "âŒ Schema not found: $SCHEMA_PATH"
        exit 1
      fi

      # Run the validate-examples script
      node scripts/validate-examples.js "$SCHEMA_PATH" "examples/**/*.ossa.yaml" --strict

      echo "âœ… All examples validated successfully"
  artifacts:
    paths:
      - /tmp/ossa-validation-report.json
    expire_in: 7 days
    when: always
  rules:
    - changes:
        - spec/**/*
        - examples/**/*
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GENERATE: Python SDK Types (Deterministic Task)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
schema:generate-python:
  stage: build
  image: node:${NODE_VERSION:-22}-alpine
  script:
    - npm ci --legacy-peer-deps
    - |
      echo "ğŸ Generating Python Pydantic types from schema..."

      VERSION=$(node -p "require('./package.json').version")
      SCHEMA_PATH="spec/v${VERSION}/ossa-${VERSION}.schema.json"
      OUTPUT_PATH="sdks/python/ossa/generated_types.py"

      mkdir -p sdks/python/ossa

      # Run the schema-to-python script
      node scripts/schema-to-python.js "$SCHEMA_PATH" "$OUTPUT_PATH" --generator=pydantic

      echo "âœ… Python types generated: $OUTPUT_PATH"
      head -50 "$OUTPUT_PATH"
  artifacts:
    paths:
      - sdks/python/ossa/generated_types.py
    expire_in: 30 days
  rules:
    - changes:
        - spec/**/*.schema.json
      when: on_success
    - if: $GENERATE_SDKS == "true"
      when: on_success

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GENERATE: TypeScript Types (Deterministic Task)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
schema:generate-typescript:
  stage: build
  image: node:${NODE_VERSION:-22}-alpine
  script:
    - npm ci --legacy-peer-deps
    - |
      echo "ğŸ“˜ Generating TypeScript types from schema..."

      VERSION=$(node -p "require('./package.json').version")
      SCHEMA_PATH="spec/v${VERSION}/ossa-${VERSION}.schema.json"
      OUTPUT_PATH="src/types/generated.ts"

      mkdir -p src/types

      # Run the schema-to-typescript script
      node scripts/schema-to-typescript.js "$SCHEMA_PATH" "$OUTPUT_PATH" --generator=zod

      echo "âœ… TypeScript types generated: $OUTPUT_PATH"
      head -50 "$OUTPUT_PATH"
  artifacts:
    paths:
      - src/types/generated.ts
    expire_in: 30 days
  rules:
    - changes:
        - spec/**/*.schema.json
      when: on_success
    - if: $GENERATE_SDKS == "true"
      when: on_success

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GENERATE: VS Code Snippets (Deterministic Task)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
schema:generate-snippets:
  stage: build
  image: node:${NODE_VERSION:-22}-alpine
  script:
    - npm ci --legacy-peer-deps
    - |
      echo "ğŸ“ Generating VS Code snippets from schema..."

      VERSION=$(node -p "require('./package.json').version")
      SCHEMA_PATH="spec/v${VERSION}/ossa-${VERSION}.schema.json"
      OUTPUT_PATH="tools/vscode-ossa/snippets/ossa-snippets.json"

      mkdir -p tools/vscode-ossa/snippets

      # Run the schema-to-snippets script
      node scripts/schema-to-snippets.js "$SCHEMA_PATH" "$OUTPUT_PATH" --prefix=ossa

      echo "âœ… VS Code snippets generated: $OUTPUT_PATH"
      cat "$OUTPUT_PATH" | head -100
  artifacts:
    paths:
      - tools/vscode-ossa/snippets/ossa-snippets.json
    expire_in: 30 days
  rules:
    - changes:
        - spec/**/*.schema.json
      when: on_success
    - if: $GENERATE_SDKS == "true"
      when: on_success

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# COMMIT: Auto-commit generated files (on release branches only)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
schema:commit-generated:
  stage: deploy
  image: node:${NODE_VERSION:-22}-alpine
  needs:
    - job: schema:generate-python
      artifacts: true
    - job: schema:generate-typescript
      artifacts: true
    - job: schema:generate-snippets
      artifacts: true
  before_script:
    - apk add --no-cache git
    - git config user.email "ci@openstandardagents.org"
    - git config user.name "OSSA CI Bot"
    - git remote set-url origin https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
  script:
    - |
      echo "ğŸ“¦ Committing generated SDK files..."

      # Check for changes
      git add sdks/ src/types/generated.ts tools/vscode-ossa/ 2>/dev/null || true

      if git diff --cached --quiet; then
        echo "âœ… No changes to commit"
        exit 0
      fi

      git commit -m "chore(generated): update SDK types from schema [skip ci]"
      git push origin HEAD:${CI_COMMIT_BRANCH}

      echo "âœ… Generated files committed"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/
      when: on_success
    - if: $CI_COMMIT_BRANCH =~ /^release\/v/ && $AUTO_COMMIT_GENERATED == "true"
      when: on_success
    - when: never

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# WORKFLOW: Full Schema Automation (Manual trigger)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
schema:full-automation:
  stage: build
  image: node:${NODE_VERSION:-22}-alpine
  before_script:
    - apk add --no-cache git
    - npm ci --legacy-peer-deps
  script:
    - |
      echo "ğŸš€ OSSA Schema Automation Workflow"
      echo "==================================="

      VERSION=$(node -p "require('./package.json').version")
      SCHEMA_PATH="spec/v${VERSION}/ossa-${VERSION}.schema.json"

      echo "Schema: $SCHEMA_PATH"
      echo "Version: v${VERSION}"
      echo ""

      # Step 1: Validate examples
      echo "ğŸ“‹ Step 1: Validating examples..."
      node scripts/validate-examples.js "$SCHEMA_PATH" "examples/**/*.ossa.yaml" || true

      # Step 2: Generate Python types
      echo ""
      echo "ğŸ Step 2: Generating Python types..."
      mkdir -p sdks/python/ossa
      node scripts/schema-to-python.js "$SCHEMA_PATH" "sdks/python/ossa/generated_types.py"

      # Step 3: Generate TypeScript types
      echo ""
      echo "ğŸ“˜ Step 3: Generating TypeScript types..."
      mkdir -p src/types
      node scripts/schema-to-typescript.js "$SCHEMA_PATH" "src/types/generated.ts"

      # Step 4: Generate VS Code snippets
      echo ""
      echo "ğŸ“ Step 4: Generating VS Code snippets..."
      mkdir -p tools/vscode-ossa/snippets
      node scripts/schema-to-snippets.js "$SCHEMA_PATH" "tools/vscode-ossa/snippets/ossa-snippets.json"

      echo ""
      echo "âœ… Schema automation complete!"
      echo ""
      echo "Generated files:"
      ls -la sdks/python/ossa/generated_types.py
      ls -la src/types/generated.ts
      ls -la tools/vscode-ossa/snippets/ossa-snippets.json
  artifacts:
    paths:
      - sdks/python/ossa/generated_types.py
      - src/types/generated.ts
      - tools/vscode-ossa/snippets/ossa-snippets.json
      - /tmp/ossa-validation-report.json
    expire_in: 30 days
  rules:
    - if: $SCHEMA_AUTOMATION == "true"
      when: on_success
    - when: manual
  allow_failure: false
