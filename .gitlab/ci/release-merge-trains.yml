# ============================================================================
# Release-Based Merge Train Configuration
# ============================================================================
# 
# Enables parallel release development with merge trains:
# - Work on v0.3.2 while preparing v0.3.3
# - Each release branch has its own merge train
# - Feature branches → release/* (auto-merge via train)
# - Release branches → main (manual approval via train)
#
# Merge trains ensure:
# 1. Sequential merging prevents conflicts
# 2. Combined state testing before merge
# 3. Auto-rebase when target updates
# 4. Clean parallel development across versions
#
# ============================================================================

# Merge train validation for release branches
# Runs lightweight checks in merge train to save CI minutes
train:release-validation:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  rules:
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"
      if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^release\/v[0-9]+\.[0-9]+\.x$/
      when: on_success
  before_script:
    - npm ci --legacy-peer-deps
  script:
    - |
      echo "=== Release Branch Merge Train Validation ==="
      echo "Source: ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}"
      echo "Target: ${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}"
      echo ""
      
      # Extract version from target branch
      TARGET_VERSION=$(echo "${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}" | sed -n 's|^release/v\([0-9]\+\.[0-9]\+\)\.x|\1|p')
      echo "Release version: v${TARGET_VERSION}.x"
      
      # Quick validation (full tests already passed in MR pipeline)
      echo "Running quick validation..."
      npm run typecheck
      npm run lint || echo "Lint warnings (non-blocking in train)"
      
      echo "✅ Release merge train validation passed"
  allow_failure: false

# Merge train validation for release → main
# Ensures release is ready before merging to main
train:release-to-main:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git
  rules:
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"
      if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
      if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release\/v[0-9]+\.[0-9]+\.x$/
      when: on_success
  script:
    - |
      echo "=== Release → Main Merge Train Validation ==="
      echo "Source: ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}"
      echo "Target: ${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}"
      echo ""
      
      # Extract version from source release branch
      RELEASE_VERSION=$(echo "${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}" | sed -n 's|^release/v\([0-9]\+\.[0-9]\+\)\.x|\1|p')
      echo "Release version: v${RELEASE_VERSION}.x"
      
      # Check milestone is assigned and closed
      if [ -n "${GITLAB_PUSH_TOKEN:-}" ]; then
        MR_DATA=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}" 2>/dev/null || echo "{}")
        
        MILESTONE=$(echo "$MR_DATA" | jq -r '.milestone.title // empty' 2>/dev/null || echo "")
        
        if [ -n "$MILESTONE" ] && [ "$MILESTONE" != "null" ]; then
          echo "✅ Milestone assigned: ${MILESTONE}"
          
          # Check if milestone is closed
          MILESTONE_ID=$(echo "$MR_DATA" | jq -r '.milestone.id // empty' 2>/dev/null || echo "")
          if [ -n "$MILESTONE_ID" ] && [ "$MILESTONE_ID" != "null" ]; then
            MILESTONE_DATA=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
              "${CI_API_V4_URL}/groups/87749026/milestones/${MILESTONE_ID}" 2>/dev/null || echo "{}")
            
            MILESTONE_STATE=$(echo "$MILESTONE_DATA" | jq -r '.state // "active"' 2>/dev/null || echo "active")
            
            if [ "$MILESTONE_STATE" = "closed" ]; then
              echo "✅ Milestone is closed - ready for release"
            else
              echo "⚠️  WARNING: Milestone is not closed"
              echo "   Release should only merge to main after milestone closure"
            fi
          fi
        else
          echo "⚠️  WARNING: No milestone assigned to MR"
        fi
      else
        echo "ℹ️  GITLAB_PUSH_TOKEN not set - skipping milestone validation"
      fi
      
      # Check version consistency
      if [ -f .version.json ]; then
        CURRENT_VERSION=$(jq -r '.current' .version.json 2>/dev/null || echo "")
        if [ -n "$CURRENT_VERSION" ]; then
          VERSION_MAJOR_MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f1-2)
          if [ "$VERSION_MAJOR_MINOR" = "$RELEASE_VERSION" ]; then
            echo "✅ Version matches release branch: ${CURRENT_VERSION}"
          else
            echo "⚠️  WARNING: Version mismatch"
            echo "   .version.json: ${CURRENT_VERSION}"
            echo "   Release branch: v${RELEASE_VERSION}.x"
          fi
        fi
      fi
      
      echo "✅ Release → main merge train validation complete"
  allow_failure: false

# Notification when release merge train completes
train:release-merged:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  rules:
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"
      if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
      if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release\/v[0-9]+\.[0-9]+\.x$/
      when: on_success
  script:
    - |
      echo "✅ Release merged to main via merge train"
      echo "Release branch: ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}"
      echo "MR: !${CI_MERGE_REQUEST_IID}"
      
      # Extract version for notifications
      RELEASE_VERSION=$(echo "${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}" | sed -n 's|^release/v\([0-9]\+\.[0-9]\+\)\.x|\1|p')
      
      # Post to MR (if token available)
      if [ -n "${GITLAB_PUSH_TOKEN:-}" ]; then
        curl -sS --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "{\"body\": \"✅ **Release v${RELEASE_VERSION}.x merged to main**\n\nMerge train completed successfully. Release automation will now run.\"}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes" || true
      fi
  allow_failure: true
