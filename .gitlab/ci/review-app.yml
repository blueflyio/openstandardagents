# Review App for OrbStack Kubernetes
# Updates existing ossa.orb.local deployment with MR branch

.review_app_base:
  image: bitnami/kubectl:latest
  before_script:
    - kubectl config use-context orbstack

review:deploy:
  extends: .review_app_base
  stage: deploy
  script:
    - export REVIEW_NAMESPACE="review-${CI_MERGE_REQUEST_IID}"
    - export REVIEW_URL="ossa-mr-${CI_MERGE_REQUEST_IID}.ossa.orb.local"
    
    # Create namespace
    - kubectl create namespace ${REVIEW_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
    
    # Update deployment with MR branch
    - |
      kubectl apply -n ${REVIEW_NAMESPACE} -f - <<EOF
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ossa
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: ossa
            mr: "${CI_MERGE_REQUEST_IID}"
        template:
          metadata:
            labels:
              app: ossa
              mr: "${CI_MERGE_REQUEST_IID}"
          spec:
            containers:
            - name: ossa
              image: node:22-alpine
              workingDir: /app
              command: ["/bin/sh", "-c"]
              args:
                - |
                  apk add --no-cache git
                  git clone --branch ${CI_COMMIT_REF_NAME} --depth 1 https://gitlab.com/blueflyio/openstandardagents.git /app
                  cd /app
                  npm ci --legacy-peer-deps
                  npm run build
                  npm start
              ports:
              - containerPort: 3000
              env:
              - name: NODE_ENV
                value: "review"
              - name: MR_NUMBER
                value: "${CI_MERGE_REQUEST_IID}"
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: ossa
      spec:
        selector:
          app: ossa
        ports:
        - port: 80
          targetPort: 3000
      ---
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: ossa
        annotations:
          kubernetes.io/ingress.class: "nginx"
      spec:
        rules:
        - host: ${REVIEW_URL}
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: ossa
                  port:
                    number: 80
      EOF
    
    - echo "Review app deployed at http://${REVIEW_URL}"
    - kubectl rollout status deployment/ossa -n ${REVIEW_NAMESPACE} --timeout=5m
    
  environment:
    name: review/mr-${CI_MERGE_REQUEST_IID}
    url: http://ossa-mr-${CI_MERGE_REQUEST_IID}.ossa.orb.local
    on_stop: review:stop
    auto_stop_in: 7 days
  rules:
    - if: $CI_MERGE_REQUEST_IID
      when: on_success
  allow_failure: false

review:stop:
  extends: .review_app_base
  stage: deploy
  script:
    - export REVIEW_NAMESPACE="review-${CI_MERGE_REQUEST_IID}"
    - kubectl delete namespace ${REVIEW_NAMESPACE} --ignore-not-found
    - echo "Review app stopped"
  environment:
    name: review/mr-${CI_MERGE_REQUEST_IID}
    action: stop
  rules:
    - if: $CI_MERGE_REQUEST_IID
      when: manual
  allow_failure: true
