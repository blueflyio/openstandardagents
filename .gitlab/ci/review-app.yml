# Review App for OrbStack Kubernetes via GitLab Agent
# Deploys MR branches to Kubernetes cluster via GitLab Kubernetes Agent
# Uses Docker image built from website static export

.review_app_base:
  image: alpine/k8s:1.28.0
  before_script:
    - apk add --no-cache bash curl
    - |
      set -e
      # Verify kubectl is available
      kubectl version --client || (echo "ERROR: kubectl not available" && exit 1)

review:deploy:
  extends: .review_app_base
  stage: deploy
  dependencies:
    - build:website
    - build:docker
  script:
    - |
      set -e
      export REVIEW_NAMESPACE="review-${CI_MERGE_REQUEST_IID}"
      export REVIEW_URL="ossa-mr-${CI_MERGE_REQUEST_IID}.ossa.orb.local"
      export IMAGE_TAG="${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
      
      # Cleanup function
      cleanup() {
        echo "Cleaning up on failure..."
        kubectl delete namespace ${REVIEW_NAMESPACE} --ignore-not-found || true
      }
      trap cleanup ERR
      
      # Wait for GitLab Kubernetes Agent connection (if needed)
      # The agent connection is established automatically when environment.kubernetes is set
      # But we need to verify kubectl can access the cluster
      echo "Verifying cluster access..."
      if ! kubectl cluster-info >/dev/null 2>&1; then
        echo "WARNING: kubectl cluster-info failed, but continuing..."
        echo "GitLab Kubernetes Agent should provide connection via environment.kubernetes"
      fi
      
      # Create namespace
      kubectl create namespace ${REVIEW_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
      
      # Create image pull secret (idempotent)
      kubectl create secret docker-registry gitlab-registry \
        --docker-server=${CI_REGISTRY} \
        --docker-username=gitlab-ci-token \
        --docker-password=${CI_JOB_TOKEN} \
        --namespace=${REVIEW_NAMESPACE} \
        --dry-run=client -o yaml | kubectl apply -f -
      
      # Deploy review app
      kubectl apply -n ${REVIEW_NAMESPACE} -f - <<EOF
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: ossa-review
        labels:
          app: ossa-review
          mr: "${CI_MERGE_REQUEST_IID}"
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: ossa-review
            mr: "${CI_MERGE_REQUEST_IID}"
        template:
          metadata:
            labels:
              app: ossa-review
              mr: "${CI_MERGE_REQUEST_IID}"
          spec:
            securityContext:
              runAsNonRoot: true
              runAsUser: 101
              fsGroup: 101
            imagePullSecrets:
            - name: gitlab-registry
            containers:
            - name: ossa-review
              image: ${IMAGE_TAG}
              ports:
              - containerPort: 80
                name: http
                protocol: TCP
              env:
              - name: NODE_ENV
                value: "review"
              - name: MR_NUMBER
                value: "${CI_MERGE_REQUEST_IID}"
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
              livenessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 10
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 3
              readinessProbe:
                httpGet:
                  path: /
                  port: 80
                initialDelaySeconds: 5
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 3
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: ossa-review
        labels:
          app: ossa-review
          mr: "${CI_MERGE_REQUEST_IID}"
      spec:
        selector:
          app: ossa-review
          mr: "${CI_MERGE_REQUEST_IID}"
        ports:
        - port: 80
          targetPort: 80
          protocol: TCP
          name: http
      ---
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: ossa-review
        labels:
          app: ossa-review
          mr: "${CI_MERGE_REQUEST_IID}"
        annotations:
          nginx.ingress.kubernetes.io/rewrite-target: /
      spec:
        ingressClassName: nginx
        rules:
        - host: ${REVIEW_URL}
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: ossa-review
                  port:
                    number: 80
      EOF
      
      echo "Waiting for deployment to be ready..."
      kubectl rollout status deployment/ossa-review -n ${REVIEW_NAMESPACE} --timeout=10m
      
      # Verify deployment
      if ! kubectl get deployment ossa-review -n ${REVIEW_NAMESPACE} | grep -q "1/1"; then
        echo "ERROR: Deployment not ready"
        kubectl describe deployment ossa-review -n ${REVIEW_NAMESPACE}
        kubectl logs -n ${REVIEW_NAMESPACE} -l app=ossa-review --tail=50
        exit 1
      fi
      
      echo "Review app deployed at http://${REVIEW_URL}"
      trap - ERR
      
  environment:
    name: review/mr-${CI_MERGE_REQUEST_IID}
    url: http://ossa-mr-${CI_MERGE_REQUEST_IID}.ossa.orb.local
    kubernetes:
      namespace: review-${CI_MERGE_REQUEST_IID}
    on_stop: review:stop
    auto_stop_in: 7 days
  rules:
    - if: $CI_MERGE_REQUEST_IID
      when: on_success
  allow_failure: false

review:stop:
  extends: .review_app_base
  stage: deploy
  script:
    - export REVIEW_NAMESPACE="review-${CI_MERGE_REQUEST_IID}"
    - kubectl delete namespace ${REVIEW_NAMESPACE} --ignore-not-found
    - echo "Review app stopped"
  environment:
    name: review/mr-${CI_MERGE_REQUEST_IID}
    action: stop
    kubernetes:
      namespace: review-${CI_MERGE_REQUEST_IID}
  rules:
    - if: $CI_MERGE_REQUEST_IID
      when: manual
  allow_failure: true
