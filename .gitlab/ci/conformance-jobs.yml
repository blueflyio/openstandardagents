# GitLab CI Jobs for OSSA Conformance Testing
# Tests agent manifests against conformance profiles

.conformance-template:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
    - npm run build
  artifacts:
    reports:
      junit: conformance-report-${PROFILE}.xml
    paths:
      - conformance-report-${PROFILE}.json
    expire_in: 30 days
  # Allow failure on merge result pipelines (profile loading issues)
  allow_failure:
    exit_codes: [1]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'

# Baseline Conformance Testing
conformance:baseline:
  extends: .conformance-template
  variables:
    PROFILE: baseline
  script:
    - echo "Running baseline conformance tests..."
    - |
      for manifest in spec/v0.3/conformance/tests/baseline/valid/*.yaml; do
        echo "Testing $manifest against baseline profile"
        node dist/cli/index.js conformance run "$manifest" --profile baseline --output json > conformance-baseline-$(basename $manifest).json || exit 1
      done
    - |
      for manifest in spec/v0.3/conformance/tests/baseline/invalid/*.yaml; do
        echo "Testing invalid manifest: $manifest (should fail)"
        node dist/cli/index.js conformance run "$manifest" --profile baseline --output json && exit 1 || true
      done
    - echo "Baseline conformance tests passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - spec/v0.3/conformance/**/*
        - src/services/conformance/**/*
        - spec/v0.3/conformance/tests/baseline/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'

# Enterprise Conformance Testing
conformance:enterprise:
  extends: .conformance-template
  variables:
    PROFILE: enterprise
  script:
    - echo "Running enterprise conformance tests..."
    - |
      for manifest in spec/v0.3/conformance/tests/enterprise/valid/*.yaml; do
        echo "Testing $manifest against enterprise profile"
        node dist/cli/index.js conformance run "$manifest" --profile enterprise --output json > conformance-enterprise-$(basename $manifest).json || exit 1
      done
    - echo "Enterprise conformance tests passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - spec/v0.3/conformance/**/*
        - src/services/conformance/**/*
        - spec/v0.3/conformance/tests/enterprise/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'

# GitLab Kagent Conformance Testing
conformance:gitlab-kagent:
  extends: .conformance-template
  variables:
    PROFILE: gitlab-kagent
  script:
    - echo "Running GitLab Kagent conformance tests..."
    - |
      for manifest in spec/v0.3/conformance/tests/gitlab-kagent/valid/*.yaml; do
        echo "Testing $manifest against gitlab-kagent profile"
        node dist/cli/index.js conformance run "$manifest" --profile gitlab-kagent --output json > conformance-kagent-$(basename $manifest).json || exit 1
      done
    - echo "GitLab Kagent conformance tests passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - spec/v0.3/conformance/**/*
        - src/services/conformance/**/*
        - spec/v0.3/conformance/tests/gitlab-kagent/**/*
        - extensions/kagent/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'

# All Conformance Tests (runs on main/development)
conformance:all:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
    - npm run build
  script:
    - echo "Running all conformance profile tests..."
    - node dist/cli/index.js conformance list
    - |
      # Test all profiles
      for profile in baseline enterprise gitlab-kagent; do
        echo "Testing profile: $profile"
        for manifest in spec/v0.3/conformance/tests/$profile/valid/*.yaml 2>/dev/null; do
          [ -f "$manifest" ] || continue
          echo "  Testing $manifest"
          node dist/cli/index.js conformance run "$manifest" --profile "$profile" --verbose || exit 1
        done
      done
    - echo "All conformance tests passed"
  artifacts:
    paths:
      - conformance-report-all.json
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'
    - if: '$CI_COMMIT_TAG'

# Example Manifests Conformance Check
conformance:examples:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
    - npm run build
  script:
    - echo "Validating example manifests against baseline profile..."
    - |
      for manifest in examples/*.yaml examples/*.ossa.yaml; do
        [ -f "$manifest" ] || continue
        echo "Testing $manifest"
        node dist/cli/index.js conformance run "$manifest" --profile baseline --verbose || echo "Warning: $manifest does not meet baseline conformance"
      done
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - examples/**/*
        - src/services/conformance/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'
