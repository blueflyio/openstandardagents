# ============================================================================
# OpenAPI Validation Pipeline - Issue #176
# ============================================================================
# Validates OpenAPI specifications with OSSA extensions
#
# Tools:
# - Spectral: OpenAPI linting with custom OSSA rules
# - OSSA Validator: Custom extension validation (AJV-based)
# - Schema Validation: JSON Schema validation of OpenAPI docs
#
# Files validated:
# - openapi/**/*.yaml
# - openapi/**/*.json
#
# @see https://openstandardagents.org/docs/openapi-extensions
# ============================================================================

# Hidden job template for OpenAPI validation base
.openapi-validation-base:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build
  rules:
    - changes:
        - openapi/**/*
        - spec/extensions/openapi/**/*
        - scripts/validate-openapi-extensions.ts
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - openapi/**/*
      when: always
    - if: $CI_COMMIT_BRANCH =~ /^release\/v/
      when: always
    - if: $CI_COMMIT_BRANCH == "main"
      when: always

# ============================================================================
# JOB: Validate OSSA OpenAPI Extensions
# ============================================================================
# Uses custom AJV-based validator for OSSA-specific extensions
validate:openapi:ossa-extensions:
  extends: .openapi-validation-base
  needs: []
  script:
    - echo "OSSA OpenAPI Extensions Validation"
    - echo "=================================="
    - |
      # Find all OpenAPI files
      OPENAPI_FILES=$(find openapi -name "*.yaml" -o -name "*.yml" 2>/dev/null | sort)
      if [ -z "$OPENAPI_FILES" ]; then
        echo "No OpenAPI files found in openapi/ directory"
        exit 0
      fi

      echo "Found OpenAPI files:"
      echo "$OPENAPI_FILES" | while read f; do echo "  - $f"; done
      echo ""

      # Run OSSA extension validation
      while IFS= read -r file; do
        npx tsx scripts/validate-openapi-extensions.ts "$file" || {
          echo ""
          echo "ERROR: OSSA OpenAPI extension validation failed"
          exit 1
        }
      done <<< "$OPENAPI_FILES"
  artifacts:
    when: always
    paths:
      - openapi-validation-report.json
    expire_in: 1 week
  allow_failure: true  # OpenAPI validation issues are tracked in separate issues

# ============================================================================
# JOB: Spectral OpenAPI Linting
# ============================================================================
# Uses Spectral for general OpenAPI structure validation
validate:openapi:spectral:
  extends: .openapi-validation-base
  needs: []
  before_script:
    - npm ci --legacy-peer-deps
    - npm install -g @stoplight/spectral-cli || npm install --save-dev @stoplight/spectral-cli
  script:
    - echo "Spectral OpenAPI Linting"
    - echo "========================"
    - |
      # Check for custom ruleset
      if [ -f ".spectral.yaml" ]; then
        RULESET_ARG="--ruleset .spectral.yaml"
        echo "Using custom ruleset: .spectral.yaml"
      elif [ -f ".spectral.yml" ]; then
        RULESET_ARG="--ruleset .spectral.yml"
        echo "Using custom ruleset: .spectral.yml"
      else
        RULESET_ARG=""
        echo "Using default Spectral rules"
      fi

      # Find all OpenAPI files
      OPENAPI_FILES=$(find openapi -name "*.yaml" -o -name "*.yml" 2>/dev/null | sort)
      if [ -z "$OPENAPI_FILES" ]; then
        echo "No OpenAPI files found in openapi/ directory"
        exit 0
      fi

      # Track failures
      FAILURES=0

      # Validate each file
      for file in $OPENAPI_FILES; do
        echo ""
        echo "Validating: $file"
        if npx spectral lint "$file" $RULESET_ARG --format=text 2>/dev/null || npx @stoplight/spectral-cli lint "$file" $RULESET_ARG --format=text 2>/dev/null; then
          echo "  OK"
        else
          echo "  FAILED or warnings found"
          # Don't increment failures for warnings (exit 1 from Spectral)
          # Only real errors are exit code 2
        fi
      done

      echo ""
      echo "Spectral validation complete"
  allow_failure: true  # Warnings shouldn't block pipeline

# ============================================================================
# JOB: OpenAPI Schema Validation
# ============================================================================
# Validates OpenAPI files against OpenAPI 3.x JSON Schema
validate:openapi:schema:
  extends: .openapi-validation-base
  needs: []
  script:
    - echo "OpenAPI 3.x Schema Validation"
    - echo "============================="
    - |
      # Find all OpenAPI files
      OPENAPI_FILES=$(find openapi -name "*.yaml" -o -name "*.yml" 2>/dev/null | sort)
      if [ -z "$OPENAPI_FILES" ]; then
        echo "No OpenAPI files found in openapi/ directory"
        exit 0
      fi

      # Track results
      VALID=0
      INVALID=0

      # Validate each file
      for file in $OPENAPI_FILES; do
        echo ""
        echo "Checking: $file"

        # Check for openapi version field
        OPENAPI_VERSION=$(node -e "
          const fs = require('fs');
          const yaml = require('yaml');
          try {
            const content = fs.readFileSync('$file', 'utf-8');
            const doc = yaml.parse(content);
            console.log(doc.openapi || '');
          } catch (e) {
            console.error('Parse error');
          }
        " 2>/dev/null)

        if [ -z "$OPENAPI_VERSION" ]; then
          echo "  WARNING: Not an OpenAPI document (missing 'openapi' field)"
          continue
        fi

        if echo "$OPENAPI_VERSION" | grep -qE "^3\.(0|1)"; then
          echo "  OpenAPI version: $OPENAPI_VERSION"

          # Check for required fields
          VALID_STRUCTURE=$(node -e "
            const fs = require('fs');
            const yaml = require('yaml');
            try {
              const content = fs.readFileSync('$file', 'utf-8');
              const doc = yaml.parse(content);
              if (!doc.info) throw new Error('Missing info object');
              if (!doc.info.title) throw new Error('Missing info.title');
              if (!doc.info.version) throw new Error('Missing info.version');
              if (!doc.paths && !doc.webhooks && !doc.components) {
                throw new Error('Missing paths, webhooks, or components');
              }
              console.log('valid');
            } catch (e) {
              console.error(e.message);
            }
          " 2>&1)

          if [ "$VALID_STRUCTURE" = "valid" ]; then
            echo "  Structure: VALID"
            VALID=$((VALID + 1))
          else
            echo "  Structure: INVALID - $VALID_STRUCTURE"
            INVALID=$((INVALID + 1))
          fi
        else
          echo "  Unsupported OpenAPI version: $OPENAPI_VERSION"
          INVALID=$((INVALID + 1))
        fi
      done

      echo ""
      echo "================================"
      echo "Summary:"
      echo "  Valid: $VALID"
      echo "  Invalid: $INVALID"
      echo "================================"

      if [ $INVALID -gt 0 ]; then
        echo "ERROR: Some OpenAPI files are invalid"
        exit 1
      fi

      echo "All OpenAPI files are valid"
  allow_failure: false

# ============================================================================
# JOB: OpenAPI Examples Validation (if examples exist in specs)
# ============================================================================
validate:openapi:examples:
  extends: .openapi-validation-base
  needs: []
  script:
    - echo "OpenAPI Examples Validation"
    - echo "==========================="
    - |
      # Find all OpenAPI files
      OPENAPI_FILES=$(find openapi -name "*.yaml" -o -name "*.yml" 2>/dev/null | sort)
      if [ -z "$OPENAPI_FILES" ]; then
        echo "No OpenAPI files found"
        exit 0
      fi

      # Count files with examples
      EXAMPLES_COUNT=0
      VALID_EXAMPLES=0

      for file in $OPENAPI_FILES; do
        # Check if file has example or examples fields
        HAS_EXAMPLES=$(node -e "
          const fs = require('fs');
          const yaml = require('yaml');
          try {
            const content = fs.readFileSync('$file', 'utf-8');
            const doc = yaml.parse(content);
            const str = JSON.stringify(doc);
            if (str.includes('\"example\":') || str.includes('\"examples\":')) {
              console.log('yes');
            }
          } catch (e) {}
        " 2>/dev/null)

        if [ "$HAS_EXAMPLES" = "yes" ]; then
          EXAMPLES_COUNT=$((EXAMPLES_COUNT + 1))
          echo "  $file: contains examples"

          # Basic example format validation
          EXAMPLE_VALID=$(node -e "
            const fs = require('fs');
            const yaml = require('yaml');
            try {
              const content = fs.readFileSync('$file', 'utf-8');
              const doc = yaml.parse(content);
              // Just check that YAML parsed without errors
              console.log('valid');
            } catch (e) {
              console.error(e.message);
            }
          " 2>&1)

          if [ "$EXAMPLE_VALID" = "valid" ]; then
            VALID_EXAMPLES=$((VALID_EXAMPLES + 1))
          else
            echo "    WARNING: Example validation issue - $EXAMPLE_VALID"
          fi
        fi
      done

      echo ""
      echo "Files with examples: $EXAMPLES_COUNT"
      echo "Valid: $VALID_EXAMPLES"

      if [ $EXAMPLES_COUNT -eq 0 ]; then
        echo "INFO: No examples found in OpenAPI specs (consider adding examples)"
      fi
  allow_failure: true  # Examples are optional

# ============================================================================
# JOB: Generate OpenAPI Validation Report
# ============================================================================
# Aggregates all validation results into a single report
validate:openapi:report:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  needs:
    - job: validate:openapi:ossa-extensions
      optional: true
    - job: validate:openapi:spectral
      optional: true
    - job: validate:openapi:schema
      optional: true
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build
  script:
    - echo "Generating OpenAPI Validation Report"
    - echo "===================================="
    - |
      # Generate summary report
      node -e "
        const fs = require('fs');
        const yaml = require('yaml');
        const glob = require('glob');

        const files = glob.sync('openapi/**/*.{yaml,yml}');
        const report = {
          timestamp: new Date().toISOString(),
          pipeline_id: process.env.CI_PIPELINE_ID || 'local',
          commit_sha: process.env.CI_COMMIT_SHA || 'local',
          files_validated: files.length,
          files: files.map(f => {
            try {
              const content = fs.readFileSync(f, 'utf-8');
              const doc = yaml.parse(content);
              return {
                path: f,
                openapi_version: doc.openapi || 'unknown',
                title: doc.info?.title || 'unknown',
                version: doc.info?.version || 'unknown',
                has_ossa_metadata: !!doc['x-ossa-metadata'],
                has_ossa_extension: !!doc['x-ossa'],
                has_agent_extension: !!doc['x-agent'],
              };
            } catch (e) {
              return { path: f, error: e.message };
            }
          }),
        };

        fs.writeFileSync('openapi-validation-report.json', JSON.stringify(report, null, 2));
        console.log(JSON.stringify(report, null, 2));
      "
  artifacts:
    when: always
    paths:
      - openapi-validation-report.json
    reports:
      dotenv: openapi-validation.env
    expire_in: 1 week
  rules:
    - changes:
        - openapi/**/*
      when: always
    - if: $CI_COMMIT_BRANCH =~ /^release\/v/
      when: always
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
  allow_failure: true
