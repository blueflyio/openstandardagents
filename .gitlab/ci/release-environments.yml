# ============================================================================
# RELEASE ENVIRONMENTS - PERFECT CONFIGURATION (#376)
# ============================================================================
# Strategy:
# - release/v0.3.x: Staging environment (auto-deploy on merge)
# - production: Production environment (manual approval required)
# - npm-registry: NPM publishing (gated by ENABLE_RELEASE variable)
# ============================================================================

# Deploy to release environment (auto-deploy on merge to release branch)
deploy:release-environment:
  stage: deploy
  image: alpine:latest
  environment:
    name: release/v0.3.x
    url: https://gitlab.com/blueflyio/ossa/openstandardagents/-/tree/release/v0.3.x
    deployment_tier: staging
    auto_stop_in: 7 days
    on_stop: stop:release-environment
  script:
    - |
      #!/bin/sh
      set -e

      echo "ğŸš€ Deploying to release/v0.3.x environment"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "Branch: ${CI_COMMIT_BRANCH}"
      echo "Commit: ${CI_COMMIT_SHORT_SHA}"
      echo "MR: ${CI_MERGE_REQUEST_IID:-N/A}"
      echo "Pipeline: ${CI_PIPELINE_URL}"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Extract version from branch name
      if echo "${CI_COMMIT_BRANCH}" | grep -qE '^release/v[0-9]+\.[0-9]+\.x$'; then
        VERSION=$(echo "${CI_COMMIT_BRANCH}" | sed -E 's|release/v([0-9]+\.[0-9]+)\.x|\1|')
        echo "âœ… Release version: v${VERSION}.x"
      else
        echo "âš ï¸  Not a release branch, skipping deployment"
        exit 0
      fi

      echo "ğŸ“¦ Release environment deployment complete"
  rules:
    # Auto-deploy on merge to release branch
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/
      when: on_success
  allow_failure: false
  needs:
    - job: build:dist
      optional: true

# Stop release environment (manual)
stop:release-environment:
  stage: deploy
  image: alpine:latest
  environment:
    name: release/v0.3.x
    action: stop
  script:
    - echo "ğŸ›‘ Stopping release/v0.3.x environment"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/
      when: manual
  allow_failure: true

# Deploy to production (manual approval required)
deploy:production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://openstandardagents.org
    deployment_tier: production
    on_stop: stop:production
  script:
    - |
      #!/bin/sh
      set -e

      echo "ğŸš€ Deploying to PRODUCTION environment"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "Branch: ${CI_COMMIT_BRANCH}"
      echo "Commit: ${CI_COMMIT_SHORT_SHA}"
      echo "Tag: ${CI_COMMIT_TAG:-N/A}"
      echo "Pipeline: ${CI_PIPELINE_URL}"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Verify we're on main branch
      if [ "${CI_COMMIT_BRANCH}" != "main" ]; then
        echo "âŒ ERROR: Production deployment only allowed from main branch"
        exit 1
      fi

      # Extract version from tag if available
      if [ -n "${CI_COMMIT_TAG}" ]; then
        if echo "${CI_COMMIT_TAG}" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
          VERSION=$(echo "${CI_COMMIT_TAG}" | sed 's/^v//')
          echo "âœ… Production version: v${VERSION}"
        fi
      fi

      echo "ğŸ“¦ Production deployment complete"
  rules:
    # Only on main branch after successful merge
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false
  needs:
    - job: build:dist
      optional: true
    - job: test:unit
      optional: true

# Stop production environment (manual)
stop:production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    action: stop
  script:
    - echo "ğŸ›‘ Stopping production environment"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: true
