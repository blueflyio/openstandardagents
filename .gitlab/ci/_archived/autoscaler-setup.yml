# Auto-Scaling Runner Setup Job
# Deploys Kubernetes-based auto-scaling GitLab runners

setup:autoscaler-runners:
  stage: setup
  image: bitnami/kubectl:latest
  before_script:
    - kubectl version --client
  script:
    - |
      echo "Setting up OSSA auto-scaling GitLab runners..."
      kubectl apply -f .gitlab/runners/k8s-autoscaler-deployment.yaml
      kubectl wait --for=condition=available --timeout=300s \
        deployment/gitlab-runner-autoscaler -n gitlab-runner || true
      echo "Auto-scaling runners deployed"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $SETUP_AUTOSCALER == "true"
      when: manual
  allow_failure: true
