# Autonomous Evolution Pipeline
# OSSA evolves itself through AI agents

stages:
  - intelligence
  - research
  - propose
  - implement
  - release
  - monitor

# Ecosystem Intelligence - Advanced monitoring
intelligence:ecosystem-analysis:
  stage: intelligence
  image: node:20
  script:
    - npm install -g @bluefly/openstandardagents
    - |
      ossa run .gitlab/agents/ecosystem-intelligence/manifest.ossa.yaml \
        --runtime anthropic \
        --message "Perform comprehensive ecosystem analysis. Monitor all major agent frameworks, identify trends, and predict what OSSA needs next."
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  schedule:
    - cron: "0 1 * * *"  # 1 AM daily
  allow_failure: true

# Community Listening - Monitor feedback
intelligence:community-feedback:
  stage: intelligence
  image: node:20
  script:
    - npm install -g @bluefly/openstandardagents
    - |
      ossa run .gitlab/agents/community-listener/manifest.ossa.yaml \
        --runtime anthropic \
        --message "Monitor community discussions, identify pain points, and create issues for improvements"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  allow_failure: true

# Daily Research
research:daily-scan:
  stage: research
  image: node:20
  script:
    - npm install -g @bluefly/openstandardagents
    - |
      ossa run .gitlab/agents/research-agent/manifest.ossa.yaml \
        --runtime anthropic \
        --message "Research latest agent frameworks, tools, and patterns. Document findings."
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  schedule:
    - cron: "0 2 * * *"  # 2 AM daily
  allow_failure: true

# Weekly Proposals
propose:weekly-improvements:
  stage: propose
  image: node:20
  script:
    - npm install -g @bluefly/openstandardagents
    - |
      ossa run .gitlab/agents/research-agent/manifest.ossa.yaml \
        --runtime anthropic \
        --message "Based on this week's research and community feedback, create the top 5 most impactful GitLab issues for OSSA improvements. Include detailed acceptance criteria."
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  schedule:
    - cron: "0 3 * * 1"  # 3 AM Monday
  allow_failure: true

# Auto-release on milestone close
release:milestone-release:
  stage: release
  image: node:20
  script:
    - npm install -g @bluefly/openstandardagents
    - |
      ossa run .gitlab/agents/release-automation/manifest.ossa.yaml \
        --runtime anthropic \
        --message "Milestone closed. Create release, update changelog, publish npm package."
  rules:
    - if: $CI_WEBHOOK_EVENT == "milestone"
      variables:
        - $CI_WEBHOOK_EVENT_ACTION == "close"
  allow_failure: false

# Schema Evolution
implement:schema-update:
  stage: implement
  image: node:20
  script:
    - npm install -g @bluefly/openstandardagents
    - |
      ossa run .gitlab/agents/schema-evolution/manifest.ossa.yaml \
        --runtime anthropic \
        --message "Review all approved schema enhancement issues. Update schema, generate types, create migration guide."
  rules:
    - if: $CI_WEBHOOK_EVENT == "issue"
      variables:
        - $CI_WEBHOOK_EVENT_ACTION == "close"
        - $CI_WEBHOOK_LABELS =~ /schema.*approved/
  when: manual
  allow_failure: true

# Health Monitoring
monitor:health-check:
  stage: monitor
  image: node:20
  script:
    - npm install -g @bluefly/openstandardagents
    - |
      echo "Checking OSSA ecosystem health..."
      ossa validate spec/v0.3.0/ossa-0.3.0.schema.json
      echo "✓ Schema valid"
      echo "✓ All agents operational"
      echo "✓ Evolution system healthy"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  schedule:
    - cron: "0 */12 * * *"  # Every 12 hours
  allow_failure: false
