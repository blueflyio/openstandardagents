# Version Sync Job - Replaces 0.3.3 placeholders before build
# Runs after detect-version job, before build/test jobs

version:sync:placeholders:
  stage: setup
  image: node:20-alpine
  needs:
    - job: detect:version
      artifacts: true
  before_script:
    - apk add --no-cache git sed findutils
    - source build.env || true
  script:
    - |
      if [ -z "$VERSION" ]; then
        echo "VERSION not set, skipping version sync"
        exit 0
      fi
      
      echo "Syncing version ${VERSION} to all files..."
      
      # Files to update with version
      # Note: ALL version references MUST use 0.3.3 placeholder
      # This script replaces 0.3.3 with actual version (e.g., 0.3.0)
      FILES_TO_UPDATE=(
        "package.json"
        "package-lock.json"
        ".version.json"
        ".wiki-config.json"
        "README.md"
        "CHANGELOG.md"
        "spec/**/*.md"
        "spec/**/*.yaml"
        "spec/**/*.json"
        "openapi/**/*.yaml"
        "openapi/**/*.json"
        ".gitlab/**/*.md"
        ".gitlab/**/*.yml"
        ".gitlab/**/*.yaml"
        "bin/**"
        "scripts/**/*.ts"
        "scripts/**/*.js"
      )
      
      # Replace 0.3.3 with actual version
      for pattern in "${FILES_TO_UPDATE[@]}"; do
        find . -type f -name "$(basename "$pattern")" -o -path "$pattern" 2>/dev/null | while read -r file; do
          if [ -f "$file" ] && grep -q "0.3.3" "$file" 2>/dev/null; then
            echo "Updating $file with version ${VERSION}"
            sed -i "s/0.3.3/${VERSION}/g" "$file"
          fi
        done
      done
      
      # Verify package.json has placeholders replaced (not hardcoded)
      if grep -q '"version": "0.3.3"' package.json 2>/dev/null; then
        echo "ERROR: package.json still contains 0.3.3 placeholder after replacement"
        echo "This should not happen - version-sync job should have replaced it"
        exit 1
      fi
      
      # Check if any changes were made
      if git diff --quiet; then
        echo "No version changes needed"
      else
        echo "Version changes detected:"
        git diff --stat
        git config user.name "GitLab CI"
        git config user.email "ci@gitlab.com"
        git add -A
        git commit -m "chore(ci): sync version ${VERSION} [skip ci]" || true
        git push origin "$CI_COMMIT_REF_NAME" || echo "Could not push version sync commit"
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^release\/v/'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
  artifacts:
    expire_in: 1 hour
    paths:
      - build.env
