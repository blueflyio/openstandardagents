# ============================================================================
# Issue Consolidation CI Jobs
# ============================================================================
# Automatically consolidates and completes issues using agents
# ============================================================================

variables:
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}

# ============================================================================
# AUDIT ALL ISSUES
# ============================================================================

consolidation:audit-issues:
  stage: .pre
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ISSUE_CONSOLIDATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Auditing All Issues"
      echo "=================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/issue-lifecycle-manager/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @issue-lifecycle-manager" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"audit-all-issues\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"categorize\": true,
            \"identify_duplicates\": true,
            \"identify_related\": true,
            \"suggest_consolidation\": true
          }
        }" | jq '.'
  artifacts:
    reports:
      dotenv: issue-audit.env
    expire_in: 7 days
  allow_failure: true

# ============================================================================
# CONSOLIDATE RELATED ISSUES
# ============================================================================

consolidation:consolidate:
  stage: .pre
  image: alpine:latest
  needs:
    - job: consolidation:audit-issues
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ISSUE_CONSOLIDATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Consolidating Related Issues"
      echo "==========================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/issue-lifecycle-manager/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @issue-lifecycle-manager" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"consolidate-related-issues\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"consolidation_strategy\": \"epic_or_milestone\",
            \"auto_create_epics\": true,
            \"preserve_original_issues\": true,
            \"link_as_related\": true
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# PRIORITIZE BY IMPACT
# ============================================================================

consolidation:prioritize:
  stage: .pre
  image: alpine:latest
  needs:
    - job: consolidation:consolidate
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ISSUE_CONSOLIDATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Prioritizing Issues by Impact"
      echo "============================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/issue-lifecycle-manager/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @issue-lifecycle-manager" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"prioritize-by-impact\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"factors\": [
              \"dependencies\",
              \"user_impact\",
              \"technical_debt\",
              \"security_risk\"
            ],
            \"auto_label\": true
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# AUTO-COMPLETE SIMPLE ISSUES
# ============================================================================

consolidation:auto-complete:
  stage: validate
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ISSUE_CONSOLIDATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Auto-Completing Simple Issues"
      echo "============================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"auto-complete-simple-issues\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"complexity_threshold\": \"low\",
            \"auto_create_mr\": true,
            \"auto_merge_on_pass\": false
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# ASSIGN TO APPROPRIATE AGENTS
# ============================================================================

consolidation:assign-agents:
  stage: validate
  image: alpine:latest
  needs:
    - job: consolidation:prioritize
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ISSUE_CONSOLIDATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Assigning Issues to Agents"
      echo "=========================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"assign-issues-to-agents\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"agent_mapping\": {
              \"documentation\": \"@documentation-aggregator\",
              \"code_quality\": \"@code-quality-reviewer\",
              \"security\": \"@vulnerability-scanner\",
              \"ci_cd\": \"@pipeline-remediation\",
              \"version\": \"@release-coordinator\"
            },
            \"auto_assign\": true
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# TRACK PROGRESS
# ============================================================================

consolidation:track-progress:
  stage: deploy
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ISSUE_CONSOLIDATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Tracking Issue Progress"
      echo "======================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/issue-lifecycle-manager/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @issue-lifecycle-manager" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"track-issue-progress\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"update_milestones\": true,
            \"create_progress_report\": true,
            \"report_type\": \"gitlab_wiki\"
          }
        }" | jq '.'
  allow_failure: true
