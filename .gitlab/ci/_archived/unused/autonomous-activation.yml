# ============================================================================
# Autonomous Framework Activation
# ============================================================================
# One-time activation job that sets up everything via GitLab API
# ============================================================================

variables:
  GITLAB_URL: ${CI_SERVER_URL:-https://gitlab.com}
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}

activate:autonomous-framework:
  stage: .pre
  image: alpine:latest
  needs: []
  rules:
    - if: $ACTIVATE_AUTONOMOUS == "true"
      when: always
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
      when: always
      allow_failure: true
    - if: $CI_COMMIT_BRANCH =~ /^chore\/migrate-scripts-to-src$/
      when: always
      allow_failure: true
    - when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq openssl
  script:
    - |
      echo "Activating Autonomous Framework"
      echo "=============================="
      echo ""
      
      TOKEN="${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN:-${GITLAB_TOKEN}}"
      PROJECT_ID="${CI_PROJECT_ID}"
      
      if [ -z "$TOKEN" ]; then
        echo "ERROR: No token available"
        echo "Set SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN or GITLAB_TOKEN"
        exit 1
      fi
      
      # Create variables
      echo "Creating CI/CD variables..."
      for var in "AUTONOMOUS_MODE" "PLATFORM_AGENTS_API_URL"; do
        VALUE="enabled"
        if [ "$var" = "PLATFORM_AGENTS_API_URL" ]; then
          VALUE="${PLATFORM_AGENTS_API}"
        fi
        
        curl -X POST \
          "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/variables" \
          -H "PRIVATE-TOKEN: ${TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{
            \"key\": \"${var}\",
            \"value\": \"${VALUE}\",
            \"protected\": false,
            \"masked\": false
          }" 2>/dev/null | jq -r '.key // "exists"' || echo "Variable ${var} may already exist"
      done
      
      # Create webhook
      echo ""
      echo "Creating webhook..."
      WEBHOOK_SECRET=$(openssl rand -hex 32)
      WEBHOOK_URL="${PLATFORM_AGENTS_API}/api/webhooks/gitlab"
      
      curl -X POST \
        "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/hooks" \
        -H "PRIVATE-TOKEN: ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d "{
          \"url\": \"${WEBHOOK_URL}\",
          \"token\": \"${WEBHOOK_SECRET}\",
          \"enable_ssl_verification\": true,
          \"issues_events\": true,
          \"confidential_issues_events\": true,
          \"merge_requests_events\": true,
          \"tag_push_events\": true,
          \"pipeline_events\": true,
          \"releases_events\": true
        }" 2>/dev/null | jq -r '.id // "exists"' || echo "Webhook may already exist"
      
      # Create schedules
      echo ""
      echo "Creating pipeline schedules..."
      SCHEDULES=(
        "{\"desc\":\"Autonomous issue triage\",\"cron\":\"0 4 * * *\"}"
        "{\"desc\":\"Autonomous code quality\",\"cron\":\"0 2 * * *\"}"
        "{\"desc\":\"Autonomous MR review\",\"cron\":\"0 * * * *\"}"
        "{\"desc\":\"Autonomous pipeline monitoring\",\"cron\":\"*/15 * * * *\"}"
        "{\"desc\":\"Weekly ecosystem analysis\",\"cron\":\"0 1 * * 1\"}"
      )
      
      for schedule in "${SCHEDULES[@]}"; do
        DESC=$(echo "$schedule" | jq -r '.desc')
        CRON=$(echo "$schedule" | jq -r '.cron')
        
        curl -X POST \
          "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/pipeline_schedules" \
          -H "PRIVATE-TOKEN: ${TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{
            \"description\": \"${DESC}\",
            \"ref\": \"main\",
            \"cron\": \"${CRON}\",
            \"cron_timezone\": \"UTC\",
            \"active\": true,
            \"variables\": [{\"key\": \"AUTONOMOUS_MODE\", \"value\": \"enabled\"}]
          }" 2>/dev/null | jq -r '.id // "exists"' || echo "Schedule ${DESC} may already exist"
      done
      
      echo ""
      echo "Autonomous framework activation complete!"
  allow_failure: true
