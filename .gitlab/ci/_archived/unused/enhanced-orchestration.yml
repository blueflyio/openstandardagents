# ============================================================================
# Enhanced Agent Orchestration CI Jobs
# ============================================================================
# Implements agent-to-agent communication, performance analytics, and intelligent routing
# ============================================================================

variables:
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}
  AGENT_MESH_API: ${AGENT_MESH_API_URL:-http://agent-mesh:9090}
  AGENT_ROUTER_API: ${AGENT_ROUTER_API_URL:-http://agent-router:4000}
  AGENT_TRACER_API: ${AGENT_TRACER_API_URL:-http://agent-tracer:4318}

# ============================================================================
# AGENT DISCOVERY & CAPABILITY MAPPING
# ============================================================================

orchestration:discover-agents:
  stage: .pre
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ENHANCED_ORCHESTRATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Agent Discovery and Capability Mapping"
      echo "======================================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"discover-and-map-agents\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"include_capabilities\": true,
            \"include_performance\": true,
            \"include_availability\": true,
            \"router_api\": \"${AGENT_ROUTER_API}\"
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# PERFORMANCE ANALYTICS COLLECTION
# ============================================================================

orchestration:collect-metrics:
  stage: .pre
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ENHANCED_ORCHESTRATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Collecting Agent Performance Metrics"
      echo "===================================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"collect-agent-metrics\",
          \"inputs\": {
            \"metrics_source\": \"agent-tracer\",
            \"tracer_api\": \"${AGENT_TRACER_API}\",
            \"time_range\": \"24h\",
            \"include_latency\": true,
            \"include_token_usage\": true,
            \"include_error_rates\": true,
            \"include_success_rates\": true
          }
        }" | jq '.'
  artifacts:
    reports:
      dotenv: agent-metrics.env
    expire_in: 1 day
  allow_failure: true

orchestration:analyze-trends:
  stage: .pre
  image: alpine:latest
  needs:
    - job: orchestration:collect-metrics
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ENHANCED_ORCHESTRATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Analyzing Performance Trends"
      echo "============================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"analyze-performance-trends\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"trend_window\": \"7d\",
            \"alert_threshold\": 0.8,
            \"optimize_routing\": true,
            \"router_api\": \"${AGENT_ROUTER_API}\"
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# INTELLIGENT ROUTING CONFIGURATION
# ============================================================================

orchestration:update-routing:
  stage: .pre
  image: alpine:latest
  needs:
    - job: orchestration:analyze-trends
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ENHANCED_ORCHESTRATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Updating Intelligent Routing Rules"
      echo "=================================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"update-intelligent-routing\",
          \"inputs\": {
            \"router_api\": \"${AGENT_ROUTER_API}\",
            \"routing_strategy\": \"capability_and_performance_weighted\",
            \"load_balancing\": \"performance_aware\",
            \"health_check_interval\": 60,
            \"max_retries\": 3,
            \"session_affinity\": \"capability_based\"
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# AGENT-TO-AGENT COMMUNICATION SETUP
# ============================================================================

orchestration:setup-a2a:
  stage: .pre
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ENHANCED_ORCHESTRATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Setting Up Agent-to-Agent Communication Channels"
      echo "================================================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"setup-agent-mesh\",
          \"inputs\": {
            \"mesh_api\": \"${AGENT_MESH_API}\",
            \"channels\": [
              {
                \"name\": \"issue-coordination\",
                \"type\": \"pubsub\",
                \"agents\": [\"issue-lifecycle-manager\", \"task-dispatcher\"]
              },
              {
                \"name\": \"code-quality-coordination\",
                \"type\": \"pubsub\",
                \"agents\": [\"code-quality-reviewer\", \"mr-reviewer\"]
              },
              {
                \"name\": \"release-coordination\",
                \"type\": \"direct\",
                \"agents\": [\"release-coordinator\", \"task-dispatcher\"]
              },
              {
                \"name\": \"performance-alerts\",
                \"type\": \"broadcast\",
                \"agents\": [\"task-dispatcher\", \"pipeline-remediation\"]
              }
            ]
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# COORDINATED TASK EXECUTION (A2A)
# ============================================================================

orchestration:coordinate-issue-triage:
  stage: validate
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "issue"
      when: on_success
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Coordinated Issue Triage (A2A)"
      echo "================================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/issue-lifecycle-manager/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @issue-lifecycle-manager" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"coordinate-with-agents\",
          \"inputs\": {
            \"mesh_api\": \"${AGENT_MESH_API}\",
            \"coordination_type\": \"issue-triage\",
            \"project_id\": ${CI_PROJECT_ID},
            \"participating_agents\": [
              {
                \"agent\": \"code-quality-reviewer\",
                \"role\": \"analyze-code-impact\"
              },
              {
                \"agent\": \"mr-reviewer\",
                \"role\": \"check-related-mrs\"
              },
              {
                \"agent\": \"task-dispatcher\",
                \"role\": \"orchestrate-workflow\"
              }
            ],
            \"communication_channel\": \"issue-coordination\"
          }
        }" | jq '.'
  allow_failure: false

orchestration:coordinate-code-review:
  stage: validate
  image: alpine:latest
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Coordinated Code Review (A2A)"
      echo "=============================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/code-quality-reviewer/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_CODE_QUALITY_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @code-quality-reviewer" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"coordinate-with-agents\",
          \"inputs\": {
            \"mesh_api\": \"${AGENT_MESH_API}\",
            \"coordination_type\": \"code-review\",
            \"project_id\": ${CI_PROJECT_ID},
            \"mr_iid\": ${CI_MERGE_REQUEST_IID},
            \"participating_agents\": [
              {
                \"agent\": \"mr-reviewer\",
                \"role\": \"review-mr-context\"
              },
              {
                \"agent\": \"vulnerability-scanner\",
                \"role\": \"security-analysis\"
              },
              {
                \"agent\": \"pipeline-remediation\",
                \"role\": \"check-pipeline-impact\"
              }
            ],
            \"communication_channel\": \"code-quality-coordination\"
          }
        }" | jq '.'
  allow_failure: false

# ============================================================================
# PERFORMANCE-BASED ROUTING
# ============================================================================

orchestration:intelligent-route:
  stage: validate
  image: alpine:latest
  needs:
    - job: orchestration:collect-metrics
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Intelligent Performance-Based Routing"
      echo "====================================="
      
      TASK_TYPE="code-review"
      if [ -n "${CI_MERGE_REQUEST_IID}" ]; then
        TASK_TYPE="mr-review"
      elif [ -n "${CI_WEBHOOK_EVENT}" ] && [ "${CI_WEBHOOK_EVENT}" = "issue" ]; then
        TASK_TYPE="issue-triage"
      fi
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"intelligent-route-task\",
          \"inputs\": {
            \"router_api\": \"${AGENT_ROUTER_API}\",
            \"task_type\": \"${TASK_TYPE}\",
            \"project_id\": ${CI_PROJECT_ID},
            \"routing_criteria\": [
              {
                \"weight\": 0.4,
                \"factor\": \"performance_score\"
              },
              {
                \"weight\": 0.3,
                \"factor\": \"success_rate\"
              },
              {
                \"weight\": 0.2,
                \"factor\": \"latency\"
              },
              {
                \"weight\": 0.1,
                \"factor\": \"availability\"
              }
            ],
            \"fallback_strategy\": \"round_robin\"
          }
        }" | jq '.'
  allow_failure: false

# ============================================================================
# ANALYTICS DASHBOARD UPDATE
# ============================================================================

orchestration:update-analytics:
  stage: deploy
  image: alpine:latest
  needs:
    - job: orchestration:collect-metrics
      artifacts: true
      optional: true
    - job: orchestration:analyze-trends
      artifacts: true
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $ENHANCED_ORCHESTRATION == "true"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Updating Analytics Dashboard"
      echo "==========================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/task-dispatcher/invoke" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN:-${GITLAB_TOKEN}}" \
        -H "X-Service-Account: @task-dispatcher" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"update-analytics\",
          \"inputs\": {
            \"tracer_api\": \"${AGENT_TRACER_API}\",
            \"project_id\": ${CI_PROJECT_ID},
            \"metrics_to_collect\": [
              \"agent_invocations\",
              \"agent_latency\",
              \"agent_success_rate\",
              \"agent_token_usage\",
              \"agent_cost\",
              \"agent_to_agent_messages\",
              \"routing_decisions\",
              \"performance_trends\"
            ],
            \"dashboard_type\": \"gitlab_wiki\"
          }
        }" | jq '.'
  allow_failure: true
