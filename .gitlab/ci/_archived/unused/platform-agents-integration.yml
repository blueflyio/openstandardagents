# ============================================================================
# Platform-Agents Integration
# ============================================================================
# CI/CD jobs for invoking platform-agents agents with service account support
# ============================================================================

# Base template for platform-agents jobs
.agent-job-template:
  image: node:${NODE_VERSION:-20}-alpine
  before_script:
    - apk add --no-cache git curl jq bash
    - npm ci --legacy-peer-deps --prefer-offline --no-audit
    - npm run build
  variables:
    # Service account token resolution priority:
    # 1. Agent-specific token (e.g., SERVICE_ACCOUNT_SECURITY_TOKEN for vulnerability-scanner)
    # 2. Deployment token (for most agents)
    # 3. CI_JOB_TOKEN (fallback)
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  script:
    - |
      echo "ü§ñ Executing platform-agent: ${agent_name}"
      echo "   Service Account: ${GITLAB_TOKEN:0:10}..."

      # Map agent names to service accounts
      case "${agent_name}" in
        vulnerability-scanner|ossa-validator)
          export GITLAB_TOKEN="${SERVICE_ACCOUNT_SECURITY_TOKEN:-${GITLAB_TOKEN}}"
          echo "   Using: security-service-account"
          ;;
        cost-intelligence-monitor)
          export GITLAB_TOKEN="${SERVICE_ACCOUNT_MONITORING_TOKEN:-${GITLAB_TOKEN}}"
          echo "   Using: monitoring-service-account"
          ;;
        release-coordinator|version-manager)
          export GITLAB_TOKEN="${SERVICE_ACCOUNT_VERSION_MANAGER_TOKEN:-${GITLAB_TOKEN}}"
          echo "   Using: version-manager-service-account"
          ;;
        *)
          export GITLAB_TOKEN="${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${GITLAB_TOKEN}}"
          echo "   Using: deployment-service-account"
          ;;
      esac

      # Verify platform-agents project is accessible
      if ! curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        "${CI_API_V4_URL}/projects/blueflyio%2Fagent-platform%2Fplatform-agents" > /dev/null; then
        echo "‚ö†Ô∏è  WARNING: Cannot access platform-agents project"
        echo "   Falling back to CI_JOB_TOKEN"
        export GITLAB_TOKEN="${CI_JOB_TOKEN}"
      fi

      # Execute platform-agent via agent-suite.yml job
      # The agent-suite.yml from platform-agents defines the actual execution
      echo "‚úÖ Platform-agent ${agent_name} will be executed by agent-suite.yml"
      echo "   Token configured: ${GITLAB_TOKEN:0:10}..."
  rules:
    - if: $agent_name
      when: on_success
    - when: never

# ============================================================================
# Platform-Agents Agent Jobs
# ============================================================================

# Vulnerability Scanner
agent:vulnerability-scanner:
  extends: .agent-job-template
  stage: security
  variables:
    agent_name: vulnerability-scanner
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_SECURITY_TOKEN:-${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^release\//
  allow_failure: false

# MR Reviewer
agent:mr-reviewer:
  extends: .agent-job-template
  stage: quality
  variables:
    agent_name: mr-reviewer
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Recipe Publisher
agent:recipe-publisher:
  extends: .agent-job-template
  stage: deploy
  variables:
    agent_name: recipe-publisher
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\//
      when: manual
  allow_failure: false

# Release Coordinator
agent:release-coordinator:
  extends: .agent-job-template
  stage: release
  variables:
    agent_name: release-coordinator
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_VERSION_MANAGER_TOKEN:-${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false

# Task Dispatcher
agent:task-dispatcher:
  extends: .agent-job-template
  stage: .pre
  variables:
    agent_name: task-dispatcher
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# Pipeline Remediation
agent:pipeline-remediation:
  extends: .agent-job-template
  stage: .post
  variables:
    agent_name: pipeline-remediation
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_STATUS == "failed"
      when: on_failure
  allow_failure: true

# Code Quality Reviewer
agent:code-quality-reviewer:
  extends: .agent-job-template
  stage: quality
  variables:
    agent_name: code-quality-reviewer
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# Documentation Aggregator
agent:documentation-aggregator:
  extends: .agent-job-template
  stage: deploy
  variables:
    agent_name: documentation-aggregator
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: false

# OSSA Validator
agent:ossa-validator:
  extends: .agent-job-template
  stage: validate
  variables:
    agent_name: ossa-validator
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_SECURITY_TOKEN:-${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
        - "spec/**/*"
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - "spec/**/*"
  allow_failure: false

# Module Generator
agent:module-generator:
  extends: .agent-job-template
  stage: build
  variables:
    agent_name: module-generator
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
  allow_failure: true

# Drupal Standards Checker
agent:drupal-standards-checker:
  extends: .agent-job-template
  stage: quality
  variables:
    agent_name: drupal-standards-checker
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.module"
        - "**/*.php"
        - "**/composer.json"
  allow_failure: false

# Cluster Operator
agent:cluster-operator:
  extends: .agent-job-template
  stage: deploy
  variables:
    agent_name: cluster-operator
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false

# Issue Lifecycle Manager
agent:issue-lifecycle-manager:
  extends: .agent-job-template
  stage: .post
  variables:
    agent_name: issue-lifecycle-manager
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# MCP Server Builder
agent:mcp-server-builder:
  extends: .agent-job-template
  stage: build
  variables:
    agent_name: mcp-server-builder
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/mcp/**"
        - "**/*mcp*.ts"
        - "**/*mcp*.js"
  allow_failure: false

# Cost Intelligence Monitor
agent:cost-intelligence-monitor:
  extends: .agent-job-template
  stage: .post
  variables:
    agent_name: cost-intelligence-monitor
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_MONITORING_TOKEN:-${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success
  allow_failure: true

# Kagent Catalog Sync
agent:kagent-catalog-sync:
  extends: .agent-job-template
  stage: deploy
  variables:
    agent_name: kagent-catalog-sync
    GITLAB_TOKEN: "${SERVICE_ACCOUNT_DEPLOYMENT_TOKEN:-${CI_JOB_TOKEN}}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false
