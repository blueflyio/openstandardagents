# Extension Development Team CI/CD Pipeline
# Runs the multi-agent team to build OSSA extensions

stages:
  - validate
  - research
  - design
  - implement
  - test
  - deploy

variables:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  AGENT_TEAM_ENABLED: "true"

# Validate agent team configuration
validate:agent-team:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - |
      echo "üîç Validating extension development team configuration..."
      ossa validate .gitlab/agents/extension-development-team.ossa.yaml
      ossa validate .gitlab/agents/examples/*.ossa.yaml
      echo "‚úÖ Agent team configuration valid"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - .gitlab/agents/**/*.ossa.yaml
    - if: $CI_COMMIT_BRANCH =~ /^extension-team/

# Research phase - Platform analysis
research:platforms:
  stage: research
  image: python:${PYTHON_VERSION}-slim
  variables:
    PLATFORMS: "vertex-ai,dialogflow,autogpt,n8n"
  script:
    - |
      echo "üî¨ Starting platform research phase..."
      python scripts/extension-team/research_phase.py \
        --platforms "$PLATFORMS" \
        --output research-results.json
      echo "‚úÖ Research phase complete"
  artifacts:
    paths:
      - research-results.json
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^extension-team/
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Design phase - Schema design
design:schemas:
  stage: design
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - research:platforms
  script:
    - |
      echo "üé® Starting schema design phase..."
      node scripts/extension-team/design_phase.js \
        --research research-results.json \
        --output schemas/
      echo "‚úÖ Schema design phase complete"
  artifacts:
    paths:
      - schemas/
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^extension-team/
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Implementation phase - Code generation
implement:extensions:
  stage: implement
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - design:schemas
  parallel:
    matrix:
      - PLATFORM: [vertex-ai, dialogflow, autogpt, n8n]
  script:
    - |
      echo "üíª Building extension for $PLATFORM..."
      npm run extension:build -- --platform "$PLATFORM" --schemas schemas/
      echo "‚úÖ Extension implementation complete for $PLATFORM"
  artifacts:
    paths:
      - extensions/$PLATFORM/
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^extension-team/
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Test phase - Run test suites
test:extensions:
  stage: test
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - implement:extensions
  parallel:
    matrix:
      - PLATFORM: [vertex-ai, dialogflow, autogpt, n8n]
  script:
    - |
      echo "üß™ Testing extension for $PLATFORM..."
      cd extensions/$PLATFORM
      npm test -- --coverage
      npm run test:integration
      echo "‚úÖ Tests passed for $PLATFORM"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: extensions/$PLATFORM/coverage/cobertura-coverage.xml
    paths:
      - extensions/$PLATFORM/coverage/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^extension-team/
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Validation phase - Use platform-agents/manifest-validator
validate:extensions:
  stage: test
  extends:
    - .agent-job-template
  variables:
    agent_name: manifest-validator
  script:
    - |
      echo "‚úÖ Validating extension manifests using platform-agents/manifest-validator..."
      # Platform-agents agent will be executed via agent-job-template
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^extension-team/
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Deploy phase - Create merge requests using platform-agents/merge-request-reviewer
deploy:create-prs:
  stage: deploy
  extends:
    - .agent-job-template
  variables:
    agent_name: merge-request-reviewer
    task: create
  dependencies:
    - test:extensions
    - validate:extensions
  script:
    - |
      echo "üöÄ Creating merge requests using platform-agents/merge-request-reviewer..."
      # Platform-agents agent will be executed via agent-job-template
      echo "‚úÖ Merge requests created"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^extension-team/
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success
