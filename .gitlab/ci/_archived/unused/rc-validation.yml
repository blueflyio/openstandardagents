# ============================================================================
# RC VALIDATION STAGE
# ============================================================================
# Runs smoke tests, integration tests, and staging deployment for RC tags

rc:smoke-tests:
  stage: rc-validation
  image: node:${NODE_VERSION}-alpine
  tags:
    - self-hosted
    - docker
    - linux
  before_script:
    - apk add --no-cache curl jq
    - npm ci --legacy-peer-deps
  script:
    - |
      echo "Running smoke tests on RC build..."
      echo "RC Tag: ${CI_COMMIT_TAG}"
      
      # Run basic smoke tests
      npm run build || (echo "ERROR: Build failed" && exit 1)
      
      # Run unit tests as smoke tests
      npm run test:unit || npm test || (echo "ERROR: Smoke tests failed" && exit 1)
      
      echo "Smoke tests passed for ${CI_COMMIT_TAG}"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+-rc/'
      when: on_success
  allow_failure: false

rc:integration-tests:
  stage: rc-validation
  image: node:${NODE_VERSION}-alpine
  tags:
    - self-hosted
    - docker
    - linux
  before_script:
    - apk add --no-cache curl jq
    - npm ci --legacy-peer-deps
  script:
    - |
      echo "Running integration tests on RC..."
      echo "RC Tag: ${CI_COMMIT_TAG}"
      
      npm run build || (echo "ERROR: Build failed" && exit 1)
      
      # Run integration tests if available
      if npm run | grep -q "test:integration"; then
        npm run test:integration || (echo "ERROR: Integration tests failed" && exit 1)
      else
        echo "No integration tests defined, running full test suite..."
        npm test || (echo "ERROR: Tests failed" && exit 1)
      fi
      
      echo "Integration tests passed for ${CI_COMMIT_TAG}"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+-rc/'
      when: on_success
  allow_failure: false

rc:deploy-orbstack:
  stage: rc-validation
  image: node:${NODE_VERSION}-alpine
  tags:
    - self-hosted
    - docker
    - linux
  before_script:
    - apk add --no-cache curl jq
    - npm ci --legacy-peer-deps
  script:
    - |
      echo "Deploying RC to OrbStack environment..."
      echo "RC Tag: ${CI_COMMIT_TAG}"
      
      # Build the package
      npm run build || (echo "ERROR: Build failed" && exit 1)
      
      # For now, just validate the build
      # Add actual OrbStack deployment logic here when configured
      echo "RC build validated and ready for OrbStack deployment"
      echo "OrbStack deployment would happen here"
      
      # Example: npm pack and validate
      npm pack --dry-run || true
      
      echo "RC ${CI_COMMIT_TAG} validated for OrbStack"
  environment:
    name: orbstack
    url: https://ossa.orb.local
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+-rc/'
      when: manual
      allow_failure: false
