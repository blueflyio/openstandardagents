# OSSA Runners Configuration
# GitLab CI jobs that execute OSSA commands and agents

variables:
  OSSA_CLI_VERSION: "latest"
  OSSA_NODE_VERSION: "22"

# OSSA Runner Template
.ossa-runner:
  image: node:${OSSA_NODE_VERSION}-alpine
  variables:
    NPM_CONFIG_LEGACY_PEER_DEPS: "1"
  before_script:
    - apk add --no-cache git python3 make g++
    - npm ci --legacy-peer-deps
    - npm run build
    - |
      if [ ! -f "dist/cli/index.js" ]; then
        echo "ERROR: OSSA CLI not built"
        exit 1
      fi

# Schema Validation Runner
schema:validate-examples:
  extends: .ossa-runner
  stage: validate
  script:
    - echo "Validating all OSSA example manifests..."
    - npm run validate:examples || echo "Some examples may need updates"
  artifacts:
    when: always
    paths:
      - validation-results/
    reports:
      junit: validation-results/junit.xml
    expire_in: 7 days
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# OSSA Agent Execution Runner
ossa:run-agent:
  extends: .ossa-runner
  stage: test
  script:
    - |
      echo "Running OSSA agent: ${AGENT_MANIFEST}"
      if [ -z "$AGENT_MANIFEST" ]; then
        echo "ERROR: AGENT_MANIFEST variable not set"
        exit 1
      fi
      export GITLAB_TOKEN="${AGENT_SERVICE_TOKEN:-$CI_JOB_TOKEN}"
      node dist/cli/index.js run "$AGENT_MANIFEST" ${AGENT_ARGS:-""} || echo "Agent completed with warnings"
  rules:
    - if: $AGENT_MANIFEST
      when: on_success
  allow_failure: true

# OSSA Validation Runner
ossa:validate-manifest:
  extends: .ossa-runner
  stage: validate
  script:
    - |
      echo "Validating OSSA manifest: ${MANIFEST_PATH}"
      if [ -z "$MANIFEST_PATH" ]; then
        echo "ERROR: MANIFEST_PATH variable not set"
        exit 1
      fi
      node dist/cli/index.js validate "$MANIFEST_PATH" || exit 1
  rules:
    - if: $MANIFEST_PATH
      when: on_success

# OSSA Schema Generation Runner
ossa:generate-schema:
  extends: .ossa-runner
  stage: build
  script:
    - echo "Generating OSSA schema types..."
    - npm run gen:all
    - git diff --exit-code || echo "Schema types updated"
  artifacts:
    paths:
      - src/types/
      - src/schemas/
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - spec/**/*.json
