.playwright-base:
  image: mcr.microsoft.com/playwright:v1.48.0-jammy
  before_script:
    - npm ci
    - npx playwright install --with-deps

test:e2e:
  extends: .playwright-base
  stage: test
  script:
    - npx playwright test tests/e2e --reporter=html,junit
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    reports:
      junit: test-results/junit.xml
    expire_in: 7 days
  only:
    - merge_requests
    - main
    - release/*

test:visual:
  extends: .playwright-base
  stage: test
  script:
    - npx playwright test tests/visual --update-snapshots
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
      - tests/visual/*.png
    expire_in: 7 days
  only:
    - main
  allow_failure: true

test:visual:verify:
  extends: .playwright-base
  stage: test
  script:
    - npx playwright test tests/visual
  artifacts:
    when: on_failure
    paths:
      - playwright-report/
      - test-results/
    expire_in: 7 days
  only:
    - merge_requests
    - release/*
