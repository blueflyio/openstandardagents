# Runner Optimization Jobs
# Performance tuning, resource optimization, cost analysis

optimize:runner-resources:
  stage: quality
  image: bitnami/kubectl:latest
  script:
    - |
      echo "Analyzing runner resource usage..."
      
      # Get resource usage metrics
      kubectl top pods -n gitlab-runner --containers | head -20
      
      # Analyze CPU/Memory efficiency
      echo ""
      echo "Resource Efficiency Analysis:"
      kubectl get pods -n gitlab-runner -o json | \
        jq -r '.items[] | "\(.metadata.name)\tCPU: \(.spec.containers[0].resources.requests.cpu // "none")\tMemory: \(.spec.containers[0].resources.requests.memory // "none")"'
      
      # Check for over-provisioned pods
      echo ""
      echo "Checking for optimization opportunities..."
      # Add optimization logic here
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - if: $OPTIMIZE_RUNNERS == "true"
      when: manual
  allow_failure: true

analyze:runner-costs:
  stage: quality
  image: bitnami/kubectl:latest
  script:
    - |
      echo "Analyzing runner costs..."
      
      # Calculate pod hours
      POD_HOURS=$(kubectl get pods -n gitlab-runner -l app=gitlab-runner \
        -o jsonpath='{.items[*].metadata.creationTimestamp}' | \
        xargs -I {} date -d {} +%s | \
        awk '{sum += (systime() - $1) / 3600} END {print sum}')
      
      echo "Total pod hours: $POD_HOURS"
      
      # Estimate costs (example: $0.10 per pod-hour)
      ESTIMATED_COST=$(echo "$POD_HOURS * 0.10" | bc)
      echo "Estimated cost: \$$ESTIMATED_COST"
      
      # Cost optimization suggestions
      echo ""
      echo "Cost Optimization Suggestions:"
      echo "  - Scale down during low-traffic periods"
      echo "  - Use spot instances for non-critical jobs"
      echo "  - Optimize resource requests/limits"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
  allow_failure: true
