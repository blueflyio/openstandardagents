# ============================================================================
generate:types:
  stage: build
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  timeout: 10 minutes
  needs:
    - job: detect:version
      optional: true
      artifacts: true
  before_script:
    - apk add --no-cache curl jq
    - test -f build.env && . build.env || echo "No build.env found (using defaults)"
  script:
    - npm ci --legacy-peer-deps
    - npm run gen:types
    - npm run gen:zod
    - echo "Generated TypeScript types and Zod schemas"
  artifacts:
    paths:
      - src/types/generated/
    expire_in: 1 hour
  rules:
    - when: always

# STAGE 2 - BUILD
# ============================================================================

build:dist:
  stage: build
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  timeout: 30 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure
  needs:
    - job: version:sync:placeholders
      optional: true
      artifacts: true
    - job: detect:version
      optional: true
      artifacts: true
    - job: generate:types
      artifacts: true
  before_script:
    - apk add --no-cache curl jq
    - test -f build.env && . build.env || echo "No build.env found (using defaults)"
  script:
    - npm ci --legacy-peer-deps
    - npm run build
    - test -f dist/cli/index.js || (echo "ERROR ERROR dist/cli/index.js missing" && exit 1)
    - echo "Build completed"
  artifacts:
    paths:
      - dist/
      - package.json
      - package-lock.json
    expire_in: 1 hour
  rules:
    - when: always

