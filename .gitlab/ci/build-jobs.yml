# ============================================================================
# STAGE 1 - GENERATE (CodegenService via CLI)
# ============================================================================
# Uses: ossa generate all (types, zod, manifests, vscode, openapi)
# Single source of truth: package.json version
# ============================================================================
# Fixed: Removed inline comments from script arrays

generate:all:
  stage: build
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  timeout: 15 minutes
  needs:
    - job: detect:version
      optional: true
      artifacts: true
  before_script:
    - apk add --no-cache curl jq
    - test -f build.env && . build.env || echo "No build.env found (using defaults)"
  script:
    - npm ci --legacy-peer-deps
    - npm run build
    - node dist/cli/index.js generate all
    - echo "Generated all: types, zod, manifests, vscode, openapi"
  artifacts:
    paths:
      - src/types/generated/
      - tools/vscode-ossa/
      - openapi/
    expire_in: 1 hour
  rules:
    - when: always

# Version Drift Detection (fails on drift in MRs)
validate:version-drift:
  stage: build
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  timeout: 10 minutes
  needs:
    - job: generate:all
      artifacts: true
  script:
    - npm ci --legacy-peer-deps
    - npm run build
    - node dist/cli/index.js generate validate
    - git diff --exit-code || (echo "ERROR: Version drift detected! Run 'ossa generate sync' locally" && exit 1)
  rules:
    - if: $CI_MERGE_REQUEST_IID
      when: always
    - when: never

# STAGE 2 - BUILD
# ============================================================================

build:dist:
  stage: build
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  timeout: 30 minutes
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure
  needs:
    - job: version:sync:placeholders
      optional: true
      artifacts: true
    - job: detect:version
      optional: true
      artifacts: true
    - job: generate:all
      artifacts: true
  before_script:
    - apk add --no-cache curl jq
    - test -f build.env && . build.env || echo "No build.env found (using defaults)"
  script:
    - npm ci --legacy-peer-deps
    - npm run build
    - test -f dist/cli/index.js || (echo "ERROR ERROR dist/cli/index.js missing" && exit 1)
    - echo "Build completed"
  artifacts:
    paths:
      - dist/
      - package.json
      - package-lock.json
    expire_in: 1 hour
  rules:
    - when: always

