# ============================================================================
# BUILD JOBS - Build Once, Use Everywhere
# ============================================================================
# Single build job that creates artifacts for all downstream jobs
# Eliminates redundant npm ci and tsc runs

build:dist:
  stage: build
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  extends:
    - .npm-cache
    - .build-cache
  before_script:
    - apk add --no-cache curl jq
    - npm ci --prefer-offline --no-audit
  script:
    - echo "Building TypeScript and assets..."
    - npm run build
    - echo "Build complete. Artifacts available for all downstream jobs."
  artifacts:
    paths:
      - dist/
      - node_modules/
      - spec/
    expire_in: 1 day
    reports:
      dotenv: build.env
  rules:
    # Run on all pipelines except merge train (uses cached artifacts)
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"
      when: never
    - when: on_success
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

# Version detection for release workflows
detect:version:
  stage: build
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  before_script:
    - apk add --no-cache jq
  script:
    - |
      if [ -f .version.json ]; then
        VERSION=$(jq -r '.current' .version.json)
        echo "VERSION=${VERSION}" >> build.env
        echo "Detected version: ${VERSION}"
      else
        echo "VERSION=unknown" >> build.env
        echo "WARNING: .version.json not found"
      fi
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\//
      when: always
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^release\//
      when: always
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
      when: always
