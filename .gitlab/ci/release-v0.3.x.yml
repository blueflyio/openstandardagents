# Release/v0.3.x Workflow Configuration
# Implements dev tag automation for release/v0.3.x branch
#
# Workflow:
# 1. Feature branches merge into release/v0.3.x
# 2. On merge: Auto-creates -dev tags (v0.3.0-dev1, v0.3.0-dev2, etc.)
# 3. On merge release/v0.3.x → main: Creates final patch tag (v0.3.0)

# ============================================================================
# DEV TAG AUTOMATION FOR release/v0.3.x
# ============================================================================

create-dev-tag:v0.3.x:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git bash
    - git config user.email "ci@bluefly.io"
    - git config user.name "GitLab CI"
    - git remote set-url origin https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
    - git fetch --unshallow --tags --force || git fetch --tags --force || true
  script:
    - |
      #!/bin/bash
      set -e
      
      echo "DEV TAG AUTOMATION FOR release/v0.3.x"
      echo "======================================"
      echo "Branch: ${CI_COMMIT_BRANCH}"
      echo "Commit: ${CI_COMMIT_SHA}"
      echo ""
      
      # Base version for v0.3.x releases
      BASE_VERSION="0.3.0"
      
      # Get latest dev tag for v0.3.0
      LATEST_DEV_TAG=$(git tag -l "v${BASE_VERSION}-dev*" 2>/dev/null | sort -V | tail -1 || echo "")
      
      if [ -z "$LATEST_DEV_TAG" ]; then
        # First dev tag
        NEXT_NUM=1
      else
        # Extract number from latest tag (e.g., v0.3.0-dev1 -> 1)
        CURRENT_NUM=$(echo "$LATEST_DEV_TAG" | sed -n 's/.*-dev\([0-9]*\)/\1/p' | head -1)
        if [ -z "$CURRENT_NUM" ]; then
          CURRENT_NUM=0
        fi
        NEXT_NUM=$((CURRENT_NUM + 1))
      fi
      
      NEW_TAG="v${BASE_VERSION}-dev${NEXT_NUM}"
      
      # Check if tag already exists for this commit
      EXISTING_TAG=$(git tag --points-at "$CI_COMMIT_SHA" | grep "^v${BASE_VERSION}-dev" || echo "")
      if [ -n "$EXISTING_TAG" ]; then
        echo "Tag already exists for this commit: $EXISTING_TAG"
        echo "DEV_TAG_NAME=$EXISTING_TAG" >> dev-tag.env
        exit 0
      fi
      
      echo "Creating dev tag: $NEW_TAG"
      
      # Create annotated tag
      git tag -a "$NEW_TAG" -m "Dev build ${NEXT_NUM} for release/v0.3.x

      Auto-generated development tag
      - Version: ${BASE_VERSION}
      - Dev iteration: ${NEXT_NUM}
      - Commit: ${CI_COMMIT_SHA:0:8}
      - Pipeline: ${CI_PIPELINE_URL}
      
      This is a development release and should not be used in production." "$CI_COMMIT_SHA"
      
      # Push tag
      if git push origin "$NEW_TAG" 2>/dev/null; then
        echo "Created dev tag: $NEW_TAG"
        echo "DEV_TAG_NAME=$NEW_TAG" > dev-tag.env
        echo "DEV_TAG_VERSION=$BASE_VERSION" >> dev-tag.env
        echo "DEV_TAG_BUILD=$NEXT_NUM" >> dev-tag.env
      else
        echo "Failed to push tag $NEW_TAG"
        git tag -d "$NEW_TAG" 2>/dev/null || true
        exit 1
      fi
  artifacts:
    reports:
      dotenv: dev-tag.env
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "release/v0.3.x" && $CI_PIPELINE_SOURCE == "push"
      when: on_success
  allow_failure: false

# ============================================================================
# VERSION DETECTION FOR release/v0.3.x → main MERGE
# ============================================================================

detect-release-version:v0.3.x:
  stage: version-detect
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git
    - git fetch --tags --force || true
  script:
    - |
      #!/bin/bash
      set -e
      
      echo "VERSION DETECTION FOR release/v0.3.x → main"
      echo "============================================"
      
      BASE_VERSION="0.3.0"
      
      # Check if final version tag already exists
      if git tag -l "v${BASE_VERSION}" | grep -q "^v${BASE_VERSION}$"; then
        echo "Version v${BASE_VERSION} already released"
        echo "RELEASE_VERSION=" > release-version.env
        echo "RELEASE_READY=false" >> release-version.env
        exit 0
      fi
      
      # Get latest dev tag
      LATEST_DEV_TAG=$(git tag -l "v${BASE_VERSION}-dev*" 2>/dev/null | sort -V | tail -1 || echo "")
      
      if [ -z "$LATEST_DEV_TAG" ]; then
        echo "No dev tags found for v${BASE_VERSION}"
        echo "RELEASE_VERSION=" > release-version.env
        echo "RELEASE_READY=false" >> release-version.env
        exit 0
      fi
      
      echo "Latest dev tag: $LATEST_DEV_TAG"
      echo "Ready for release: v${BASE_VERSION}"
      
      echo "RELEASE_VERSION=v${BASE_VERSION}" > release-version.env
      echo "RELEASE_READY=true" >> release-version.env
      echo "LATEST_DEV_TAG=$LATEST_DEV_TAG" >> release-version.env
  artifacts:
    reports:
      dotenv: release-version.env
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /Merge branch 'release\/v0\.3\.x'/
      when: on_success
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "release/v0.3.x"
      when: on_success

# ============================================================================
# CREATE FINAL RELEASE TAG ON MERGE TO main
# ============================================================================

create-release-tag:v0.3.x:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git bash
    - git config user.email "ci@bluefly.io"
    - git config user.name "GitLab CI"
    - git remote set-url origin https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
    - git fetch --unshallow --tags --force || git fetch --tags --force || true
  script:
    - |
      #!/bin/bash
      set -e
      
      source release-version.env || true
      
      if [ "$RELEASE_READY" != "true" ] || [ -z "$RELEASE_VERSION" ]; then
        echo "Release not ready or version not detected"
        exit 0
      fi
      
      echo "CREATING FINAL RELEASE TAG"
      echo "=========================="
      echo "Version: $RELEASE_VERSION"
      echo "Commit: ${CI_COMMIT_SHA}"
      echo ""
      
      # Check if tag already exists
      if git tag -l "$RELEASE_VERSION" | grep -q "^${RELEASE_VERSION}$"; then
        echo "Tag $RELEASE_VERSION already exists"
        exit 0
      fi
      
      # Create annotated release tag
      git tag -a "$RELEASE_VERSION" -m "Release ${RELEASE_VERSION}

      Production release from release/v0.3.x branch
      - Version: ${RELEASE_VERSION}
      - Commit: ${CI_COMMIT_SHA:0:8}
      - Pipeline: ${CI_PIPELINE_URL}
      - Previous dev tag: ${LATEST_DEV_TAG:-none}
      
      This is a stable production release." "$CI_COMMIT_SHA"
      
      # Push tag
      if git push origin "$RELEASE_VERSION" 2>/dev/null; then
        echo "Created release tag: $RELEASE_VERSION"
      else
        echo "Failed to push tag $RELEASE_VERSION"
        git tag -d "$RELEASE_VERSION" 2>/dev/null || true
        exit 1
      fi
  needs:
    - detect-release-version:v0.3.x
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /Merge branch 'release\/v0\.3\.x'/
      when: on_success
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "release/v0.3.x"
      when: manual
  allow_failure: false
