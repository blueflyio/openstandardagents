# SEO Automation CI Jobs
# Uses the seo-optimizer OSSA agent for automated SEO validation

variables:
  SEO_REPORT_PATH: "seo-audit-report.md"
  SITEMAP_PAGES_PATH: "sitemap-pages.json"

# ============================================================================
# SEO Validation Stage
# ============================================================================

seo:validate-meta:
  stage: quality
  image: node:20-alpine
  script:
    - cd website
    - npm ci --prefer-offline
    - |
      echo "ðŸ” Validating SEO metadata across all pages..."
      node -e "
        const glob = require('glob');
        const fs = require('fs');
        const path = require('path');

        const pages = glob.sync('app/**/page.tsx');
        const results = { passed: [], failed: [], warnings: [] };

        pages.forEach(page => {
          const content = fs.readFileSync(page, 'utf8');
          const hasStaticMeta = content.includes('export const metadata');
          const hasDynamicMeta = content.includes('generateMetadata');
          const hasStructuredData = content.includes('StructuredData');
          const isClientComponent = content.includes(\"'use client'\");

          // Client components should have a layout.tsx with metadata
          const dir = path.dirname(page);
          const hasLayoutMeta = fs.existsSync(path.join(dir, 'layout.tsx'));

          if (hasStaticMeta || hasDynamicMeta || (isClientComponent && hasLayoutMeta)) {
            results.passed.push({ page, type: hasDynamicMeta ? 'dynamic' : 'static' });
          } else {
            results.failed.push({ page, isClient: isClientComponent });
          }

          if (!hasStructuredData && !page.includes('[')) {
            results.warnings.push({ page, issue: 'Missing structured data' });
          }
        });

        console.log('âœ… Passed:', results.passed.length);
        console.log('âŒ Failed:', results.failed.length);
        console.log('âš ï¸  Warnings:', results.warnings.length);

        if (results.failed.length > 0) {
          console.error('\\nPages missing metadata:');
          results.failed.forEach(f => console.error('  -', f.page));
          process.exit(1);
        }

        fs.writeFileSync('seo-meta-validation.json', JSON.stringify(results, null, 2));
      "
  artifacts:
    paths:
      - website/seo-meta-validation.json
    reports:
      dotenv: website/seo-meta-validation.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

seo:validate-sitemap:
  stage: quality
  image: node:20-alpine
  script:
    - cd website
    - npm ci --prefer-offline
    - |
      echo "ðŸ—ºï¸ Validating sitemap configuration..."
      node -e "
        const fs = require('fs');
        const path = require('path');

        // Check sitemap.ts exists
        if (!fs.existsSync('app/sitemap.ts')) {
          console.error('âŒ sitemap.ts not found');
          process.exit(1);
        }

        // Check robots.ts exists
        if (!fs.existsSync('app/robots.ts')) {
          console.error('âŒ robots.ts not found');
          process.exit(1);
        }

        // Count pages
        const glob = require('glob');
        const pages = glob.sync('app/**/page.tsx');
        console.log('ðŸ“„ Total pages found:', pages.length);

        // Verify sitemap references correct URL
        const sitemapContent = fs.readFileSync('app/sitemap.ts', 'utf8');
        if (!sitemapContent.includes('openstandardagents.org')) {
          console.error('âŒ Sitemap does not reference correct domain');
          process.exit(1);
        }

        console.log('âœ… Sitemap configuration valid');
      "
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

seo:check-links:
  stage: quality
  image: node:20-alpine
  allow_failure: true
  script:
    - cd website
    - npm ci --prefer-offline
    - |
      echo "ðŸ”— Checking for broken internal links..."
      node -e "
        const glob = require('glob');
        const fs = require('fs');
        const path = require('path');

        const files = glob.sync('**/*.{tsx,mdx,md}', { ignore: 'node_modules/**' });
        const brokenLinks = [];
        const linkPattern = /href=[\"'](\\/[^\"'#?]+)/g;

        // Build list of valid routes
        const validRoutes = new Set(['/']);
        glob.sync('app/**/page.tsx').forEach(page => {
          let route = page.replace('app', '').replace('/page.tsx', '') || '/';
          // Handle dynamic routes
          route = route.replace(/\\/\\[([^\\]]+)\\]/g, '/:$1');
          validRoutes.add(route);
        });

        files.forEach(file => {
          const content = fs.readFileSync(file, 'utf8');
          let match;
          while ((match = linkPattern.exec(content)) !== null) {
            const link = match[1].replace(/\\/$/, ''); // Remove trailing slash
            const normalizedLink = link.replace(/\\/:[^/]+/g, '/:param');

            // Check if route exists (accounting for dynamic segments)
            let found = false;
            for (const route of validRoutes) {
              if (route === link || route.replace(/\\/:[^/]+/g, '/:param') === normalizedLink) {
                found = true;
                break;
              }
            }

            if (!found && !link.startsWith('/api/') && !link.startsWith('/_')) {
              brokenLinks.push({ file, link });
            }
          }
        });

        if (brokenLinks.length > 0) {
          console.warn('âš ï¸  Potential broken links found:');
          brokenLinks.forEach(b => console.warn('  ', b.file, '->', b.link));
          fs.writeFileSync('broken-links.json', JSON.stringify(brokenLinks, null, 2));
        } else {
          console.log('âœ… No broken internal links found');
        }
      "
  artifacts:
    paths:
      - website/broken-links.json
    when: on_failure
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================================================
# Analytics Configuration
# ============================================================================

seo:configure-analytics:
  stage: build
  image: node:20-alpine
  script:
    - cd website
    - |
      echo "ðŸ“Š Generating analytics configuration..."
      cat > public/analytics-config.json << EOF
      {
        "measurementId": "${NEXT_PUBLIC_GA_MEASUREMENT_ID:-}",
        "enabled": $([ -n "$NEXT_PUBLIC_GA_MEASUREMENT_ID" ] && echo "true" || echo "false"),
        "settings": {
          "anonymize_ip": true,
          "send_page_view": true,
          "cookie_flags": "SameSite=None;Secure"
        },
        "customEvents": [
          {"name": "playground_validate", "category": "engagement"},
          {"name": "example_copy", "category": "engagement"},
          {"name": "docs_search", "category": "navigation"},
          {"name": "spec_download", "category": "conversion"}
        ],
        "generatedAt": "$(date -Iseconds)",
        "environment": "${CI_ENVIRONMENT_NAME:-development}"
      }
      EOF

      if [ -n "$NEXT_PUBLIC_GA_MEASUREMENT_ID" ]; then
        echo "âœ… Analytics ENABLED with ID: ${NEXT_PUBLIC_GA_MEASUREMENT_ID:0:5}***"
      else
        echo "âš ï¸  Analytics DISABLED - NEXT_PUBLIC_GA_MEASUREMENT_ID not set"
      fi
  artifacts:
    paths:
      - website/public/analytics-config.json
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

# ============================================================================
# SEO Audit Report
# ============================================================================

seo:generate-report:
  stage: quality
  image: node:20-alpine
  needs:
    - job: seo:validate-meta
      optional: true
    - job: seo:validate-sitemap
      optional: true
    - job: seo:check-links
      optional: true
  script:
    - cd website
    - |
      echo "ðŸ“‹ Generating SEO Audit Report..."

      # Count pages
      PAGE_COUNT=$(find app -name "page.tsx" | wc -l)

      # Check for meta validation results
      META_STATUS="âœ… Passed"
      if [ -f seo-meta-validation.json ]; then
        FAILED=$(cat seo-meta-validation.json | grep -c '"failed"' || echo "0")
        [ "$FAILED" -gt 0 ] && META_STATUS="âš ï¸ Issues found"
      fi

      # Check for broken links
      LINKS_STATUS="âœ… None found"
      BROKEN_COUNT=0
      if [ -f broken-links.json ]; then
        BROKEN_COUNT=$(cat broken-links.json | grep -c '"link"' || echo "0")
        [ "$BROKEN_COUNT" -gt 0 ] && LINKS_STATUS="âš ï¸ $BROKEN_COUNT found"
      fi

      cat > $SEO_REPORT_PATH << EOF
      # SEO Audit Report

      **Generated**: $(date -Iseconds)
      **Branch**: $CI_COMMIT_BRANCH
      **Pipeline**: $CI_PIPELINE_URL

      ## Summary

      | Metric | Status | Details |
      |--------|--------|---------|
      | Total Pages | âœ… | $PAGE_COUNT |
      | Meta Tags | $META_STATUS | See validation job |
      | Sitemap | âœ… | Configured |
      | Robots.txt | âœ… | Configured |
      | Broken Links | $LINKS_STATUS | $BROKEN_COUNT internal |
      | Analytics | $([ -n "$NEXT_PUBLIC_GA_MEASUREMENT_ID" ] && echo "âœ… Enabled" || echo "âš ï¸ Disabled") | GA4 |

      ## Configuration

      - **Domain**: https://openstandardagents.org
      - **Sitemap**: /sitemap.xml
      - **Robots**: /robots.txt
      - **Structured Data**: Organization, WebSite, Article schemas

      ## Recommendations

      $([ -z "$NEXT_PUBLIC_GA_MEASUREMENT_ID" ] && echo "- [ ] Set NEXT_PUBLIC_GA_MEASUREMENT_ID CI variable to enable analytics")
      $([ "$BROKEN_COUNT" -gt 0 ] && echo "- [ ] Fix $BROKEN_COUNT broken internal links")

      ---
      *Generated by seo-optimizer OSSA agent*
      EOF

      cat $SEO_REPORT_PATH
  artifacts:
    paths:
      - website/$SEO_REPORT_PATH
    reports:
      dotenv: website/$SEO_REPORT_PATH
    expire_in: 1 month
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/
