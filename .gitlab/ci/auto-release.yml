# AUTOMATED RELEASE WORKFLOW
# Handles EVERYTHING for solo developer workflow

release:auto:
  stage: release
  image: node:22-alpine
  before_script:
    - apk add --no-cache git curl jq
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
    - npm ci --legacy-peer-deps
  script:
    # 1. Generate all docs
    - npm run docs:generate || true
    - npm run docs:process || true
    - npm run version:examples || true
    
    # 2. Commit any generated changes
    - |
      if ! git diff --quiet; then
        git add -A
        git commit -m "chore: auto-generate docs and sync versions [skip ci]" || true
        git push https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_REF_NAME}
      fi
    
    # 3. Build and test
    - npm run build
    - npm test || true
    
    # 4. If on release branch, create MR to main
    - |
      if [[ "$CI_COMMIT_BRANCH" =~ ^release/ ]]; then
        RELEASE_VERSION=$(echo $CI_COMMIT_BRANCH | sed 's/release\///')
        
        # Check if MR already exists
        EXISTING_MR=$(curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests?source_branch=${CI_COMMIT_BRANCH}&target_branch=main&state=opened" | \
          jq -r '.[0].iid // empty')
        
        if [ -z "$EXISTING_MR" ]; then
          # Create MR to main
          MR_RESPONSE=$(curl -s --request POST --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests" \
            --data "source_branch=${CI_COMMIT_BRANCH}" \
            --data "target_branch=main" \
            --data "title=Release ${RELEASE_VERSION}" \
            --data "description=Automated release for ${RELEASE_VERSION}" \
            --data "remove_source_branch=false")
          
          MR_IID=$(echo $MR_RESPONSE | jq -r '.iid')
          echo "Created MR !${MR_IID}"
          
          # Auto-approve
          curl -s --request POST --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${MR_IID}/approve"
          
          # Auto-merge when pipeline passes
          curl -s --request PUT --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${MR_IID}/merge" \
            --data "merge_when_pipeline_succeeds=true"
        fi
      fi
    
    # 5. If on main after merge, publish to npm
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] && [ "$ENABLE_RELEASE" = "true" ]; then
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        npm publish --access public
        
        # Create git tag
        VERSION=$(node -p "require('./package.json').version")
        git tag "v${VERSION}"
        git push https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git "v${VERSION}"
        
        # Create GitLab release
        curl -s --request POST --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases" \
          --data "tag_name=v${VERSION}" \
          --data "name=v${VERSION}" \
          --data "description=Release ${VERSION}"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\//
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  allow_failure: false
