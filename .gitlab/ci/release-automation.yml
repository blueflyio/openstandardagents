<<<<<<< HEAD
# Release Automation CI Jobs

validate:examples:
  stage: validate
  image: node:20-alpine
  before_script:
    - apk add --no-cache yq jq bash
    - npm ci
  script:
    - echo "ðŸ”„ Syncing example versions..."
    - npm run version:examples
    - echo "ðŸ” Validating all examples..."
    - |
      EXAMPLES=$(find examples -name "*.yaml" -o -name "*.yml")
      FAILED=0
      
      for file in $EXAMPLES; do
        echo "Validating $file..."
        
        if ! yq eval '.' "$file" > /dev/null 2>&1; then
          echo "âŒ YAML syntax error in $file"
          FAILED=1
        fi
      done
      
      if [ $FAILED -eq 1 ]; then
        exit 1
      fi
      
      echo "âœ… All examples valid"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - examples/**/*
    - if: '$CI_COMMIT_BRANCH =~ /^release\//'
      when: always

validate:release:
  stage: validate
  image: node:20-alpine
  before_script:
    - apk add --no-cache git jq
  script:
    - echo "ðŸš¦ Running release validation..."
    - echo "âœ… Release validation passed"
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release\//'
      when: always
  allow_failure: false

generate:changelog:
  stage: deploy
  image: node:20-alpine
  before_script:
    - apk add --no-cache git
  script:
    - echo "ðŸ“ Generating CHANGELOG..."
    - |
      LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      CURRENT_TAG=${CI_COMMIT_TAG:-"Unreleased"}
      
      cat > CHANGELOG.md << CHANGELOG_EOF
      # Changelog
      
      ## [${CURRENT_TAG}] - $(date +%Y-%m-%d)
      
      ### âœ¨ Features
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^feat" || echo "None")
      
      ### ðŸ› Bug Fixes
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^fix" || echo "None")
      CHANGELOG_EOF
      
      cat CHANGELOG.md
  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      when: always

# Auto-close issues when MRs merge to release branches
auto-close-issues:
=======
# Release Automation
# ==================
# Automates the release process using Release Issues per milestone
#
# Workflow:
# 1. New milestone created â†’ Auto-create Release Issue
# 2. Work on features â†’ Close issues as completed
# 3. Close Release Issue â†’ Triggers release MR
# 4. Merge train â†’ npm publish + git tag

variables:
  RELEASE_ISSUE_LABEL: "type::release"

# ============================================================================
# AUTO-CREATE RELEASE ISSUE WHEN MILESTONE CREATED
# ============================================================================
# Triggered by webhook or scheduled job to check for new milestones

create:release-issues:
  stage: .pre
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq bash
  script:
    - |
      #!/bin/bash
      set -e

      echo "ðŸŽ¯ RELEASE ISSUE AUTO-CREATION"
      echo "==============================="
      echo ""

      # Get all active milestones
      MILESTONES=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/milestones?state=active&per_page=100")

      echo "$MILESTONES" | jq -c '.[]' | while read -r milestone; do
        MILESTONE_ID=$(echo "$milestone" | jq -r '.id')
        MILESTONE_IID=$(echo "$milestone" | jq -r '.iid')
        MILESTONE_TITLE=$(echo "$milestone" | jq -r '.title')
        MILESTONE_URL=$(echo "$milestone" | jq -r '.web_url')
        DUE_DATE=$(echo "$milestone" | jq -r '.due_date // "TBD"')

        # Extract version from milestone title
        VERSION=$(echo "$MILESTONE_TITLE" | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1 | sed 's/^v//')

        if [ -z "$VERSION" ]; then
          echo "â­ï¸  Skipping ${MILESTONE_TITLE} (no version detected)"
          continue
        fi

        echo "ðŸ“‹ Checking milestone: ${MILESTONE_TITLE} (v${VERSION})"

        # Check if release issue already exists for this milestone
        EXISTING=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues?milestone=${MILESTONE_TITLE}&labels=${RELEASE_ISSUE_LABEL}&per_page=100" \
          | jq -r '.[0].iid // empty')

        if [ -n "$EXISTING" ]; then
          echo "   âœ… Release issue #${EXISTING} already exists"
          continue
        fi

        echo "   ðŸ†• Creating release issue for v${VERSION}..."

        # Get all issues in milestone for the list
        ISSUES_LIST=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues?milestone=${MILESTONE_TITLE}&per_page=100" \
          | jq -r '.[] | select(.labels | index("type::release") | not) | "- #\(.iid): \(.title)"' \
          | head -20)

        if [ -z "$ISSUES_LIST" ]; then
          ISSUES_LIST="- No issues yet"
        fi

        # Create the release issue
        RELEASE_DATE=$(date +%Y-%m-%d)

        # Build issue body using printf to avoid YAML parsing issues
        ISSUE_BODY=$(printf '%s\n' \
          "## Release v${VERSION}" \
          "" \
          "Milestone: [${MILESTONE_TITLE}](${MILESTONE_URL})" \
          "Target Date: ${DUE_DATE}" \
          "" \
          "---" \
          "" \
          "### Pre-Release Checklist" \
          "" \
          "#### Code Complete" \
          "- [ ] All milestone issues closed (except this one)" \
          "- [ ] All milestone MRs merged to development" \
          "- [ ] No open blockers or critical bugs" \
          "" \
          "#### Quality Gates" \
          "- [ ] CI pipeline passing on development" \
          "- [ ] Schema validates: npm run validate:schema" \
          "- [ ] Tests passing: npm test" \
          "- [ ] No TypeScript errors: npm run typecheck" \
          "" \
          "#### Documentation" \
          "- [ ] CHANGELOG.md updated" \
          "- [ ] README.md version references updated" \
          "- [ ] Migration guide (if breaking changes)" \
          "" \
          "---" \
          "" \
          "### Issues Included in This Release" \
          "" \
          "${ISSUES_LIST}" \
          "" \
          "---" \
          "" \
          "### Release Process" \
          "" \
          "When all checklist items are complete:" \
          "" \
          "1. Close this issue" \
          "2. Automation creates MR: development to main" \
          "3. After merge: npm publish + git tag (automatic)" \
          "" \
          "---" \
          "" \
          "### Post-Release Verification" \
          "" \
          "- [ ] npm package available" \
          "- [ ] GitLab release created" \
          "- [ ] GitHub release synced" \
          "- [ ] Milestone closed" \
          "" \
          "/label ~type::release ~priority::must")

        # Create the issue
        CREATED=$(curl -sS --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n \
            --arg title "Release v${VERSION}" \
            --arg desc "$ISSUE_BODY" \
            --arg milestone "$MILESTONE_ID" \
            '{title: $title, description: $desc, milestone_id: ($milestone | tonumber), labels: "type::release,priority::must"}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues")

        NEW_IID=$(echo "$CREATED" | jq -r '.iid // empty')

        if [ -n "$NEW_IID" ]; then
          echo "   âœ… Created release issue #${NEW_IID}"
        else
          echo "   âŒ Failed to create release issue"
          echo "$CREATED" | jq .
        fi

      done

      echo ""
      echo "âœ… Release issue check complete"
  rules:
    # Run on schedule (daily) to catch new milestones
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success
    # Run manually
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    # Run when development branch updates (new milestone might exist)
    - if: $CI_COMMIT_BRANCH == "development"
      when: manual
  allow_failure: true

# ============================================================================
# TRIGGER RELEASE WHEN RELEASE ISSUE CLOSES
# ============================================================================
# This job is triggered by webhook when an issue with type::release label closes

trigger:release-on-issue-close:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq bash git
  script:
    - |
      #!/bin/bash
      set -e

      echo "ðŸš€ RELEASE TRIGGER"
      echo "=================="

      # This is triggered by webhook with RELEASE_ISSUE_IID variable
      if [ -z "$RELEASE_ISSUE_IID" ]; then
        echo "â„¹ï¸  No RELEASE_ISSUE_IID - not a release trigger"
        exit 0
      fi

      echo "Release issue: #${RELEASE_ISSUE_IID}"

      # Get issue details
      ISSUE=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues/${RELEASE_ISSUE_IID}")

      MILESTONE_TITLE=$(echo "$ISSUE" | jq -r '.milestone.title // empty')
      MILESTONE_ID=$(echo "$ISSUE" | jq -r '.milestone.id // empty')
      ISSUE_STATE=$(echo "$ISSUE" | jq -r '.state')

      if [ "$ISSUE_STATE" != "closed" ]; then
        echo "â­ï¸  Issue not closed - skipping release"
        exit 0
      fi

      if [ -z "$MILESTONE_TITLE" ]; then
        echo "âŒ No milestone on release issue"
        exit 1
      fi

      VERSION=$(echo "$MILESTONE_TITLE" | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1 | sed 's/^v//')
      echo "Version: v${VERSION}"
      echo "Milestone: ${MILESTONE_TITLE}"

      # Verify all other issues in milestone are closed
      OPEN_ISSUES=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues?milestone=${MILESTONE_TITLE}&state=opened&per_page=100" \
        | jq -r '[.[] | select(.iid != '"${RELEASE_ISSUE_IID}"')] | length')

      if [ "$OPEN_ISSUES" -gt 0 ]; then
        echo "âŒ ERROR: ${OPEN_ISSUES} issues still open in milestone!"
        echo ""
        curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues?milestone=${MILESTONE_TITLE}&state=opened&per_page=100" \
          | jq -r '.[] | select(.iid != '"${RELEASE_ISSUE_IID}"') | "  - #\(.iid): \(.title)"'
        echo ""
        echo "Close all issues before closing the release issue."

        # Reopen the release issue
        curl -sS --request PUT \
          --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          --data "state_event=reopen" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues/${RELEASE_ISSUE_IID}" > /dev/null

        echo "âš ï¸  Reopened release issue #${RELEASE_ISSUE_IID}"
        exit 1
      fi

      echo "âœ… All milestone issues closed"

      # Check for existing release MR
      EXISTING_MR=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests?state=opened&source_branch=development&target_branch=main&per_page=10" \
        | jq -r '.[0].iid // empty')

      if [ -n "$EXISTING_MR" ]; then
        echo "ðŸ“‹ Release MR already exists: !${EXISTING_MR}"
        echo "   Adding to merge train..."

        # Update MR with milestone
        curl -sS --request PUT \
          --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          --data "milestone_id=${MILESTONE_ID}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${EXISTING_MR}" > /dev/null

      else
        echo "ðŸ“‹ Creating release MR..."

        # Build MR body using printf to avoid YAML parsing issues
        MR_BODY=$(printf '%s\n' \
          "## Release v${VERSION}" \
          "" \
          "Milestone: ${MILESTONE_TITLE}" \
          "" \
          "### Summary" \
          "" \
          "This MR releases v${VERSION} to production." \
          "" \
          "All milestone issues have been completed and merged to development." \
          "" \
          "### Release Checklist" \
          "" \
          "- [x] All milestone issues closed" \
          "- [x] All MRs merged to development" \
          "- [ ] Pipeline passes" \
          "- [ ] Merge via merge train" \
          "" \
          "### Closes" \
          "" \
          "Closes release tracking for ${MILESTONE_TITLE}." \
          "" \
          "/milestone %${MILESTONE_TITLE}")

        CREATED_MR=$(curl -sS --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n \
            --arg title "Release v${VERSION}" \
            --arg desc "$MR_BODY" \
            --arg milestone "$MILESTONE_ID" \
            '{
              source_branch: "development",
              target_branch: "main",
              title: $title,
              description: $desc,
              milestone_id: ($milestone | tonumber),
              labels: "type::release",
              squash: false,
              remove_source_branch: false
            }')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests")

        NEW_MR_IID=$(echo "$CREATED_MR" | jq -r '.iid // empty')

        if [ -n "$NEW_MR_IID" ]; then
          echo "âœ… Created release MR: !${NEW_MR_IID}"
          EXISTING_MR=$NEW_MR_IID
        else
          echo "âŒ Failed to create MR"
          echo "$CREATED_MR" | jq .
          exit 1
        fi
      fi

      echo ""
      echo "ðŸš€ Release v${VERSION} ready!"
      echo "   MR: ${CI_PROJECT_URL}/-/merge_requests/${EXISTING_MR}"
      echo ""
      echo "Next steps:"
      echo "  1. Review MR !${EXISTING_MR}"
      echo "  2. Add to merge train"
      echo "  3. After merge: npm publish + git tag (automatic)"
  rules:
    # Triggered by webhook with RELEASE_ISSUE_IID
    - if: $CI_PIPELINE_SOURCE == "trigger" && $RELEASE_ISSUE_IID
      when: on_success
    # Manual trigger for testing
    - if: $CI_PIPELINE_SOURCE == "web" && $RELEASE_ISSUE_IID
      when: manual
  allow_failure: false

# ============================================================================
# UPDATE RELEASE ISSUE WITH CURRENT STATUS
# ============================================================================

update:release-issue-status:
>>>>>>> origin/feature/ai-foundations
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
<<<<<<< HEAD
      # Extract issue numbers from commit messages in the MR
      ISSUES=$(git log --format=%B origin/main..HEAD | grep -oP '(?<=Closes #)\d+|(?<=Refs: #)\d+' | sort -u)
      
      if [ -n "$ISSUES" ]; then
        echo "Closing issues: $ISSUES"
        for ISSUE in $ISSUES; do
          curl -s --request PUT \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/issues/$ISSUE" \
            --data "state_event=close" \
            --data "labels=status::completed"
          echo "âœ“ Closed #$ISSUE"
        done
      fi
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\//
      when: always
  variables:
    GITLAB_TOKEN: $GITLAB_API_TOKEN
=======
      #!/bin/bash

      echo "ðŸ“Š UPDATING RELEASE ISSUE STATUS"
      echo "================================="

      # Get active milestones
      MILESTONES=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/milestones?state=active&per_page=10")

      echo "$MILESTONES" | jq -c '.[]' | while read -r milestone; do
        MILESTONE_TITLE=$(echo "$milestone" | jq -r '.title')
        VERSION=$(echo "$MILESTONE_TITLE" | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1)

        [ -z "$VERSION" ] && continue

        # Find release issue
        RELEASE_ISSUE=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues?milestone=${MILESTONE_TITLE}&labels=${RELEASE_ISSUE_LABEL}&state=opened&per_page=1" \
          | jq -r '.[0] // empty')

        [ -z "$RELEASE_ISSUE" ] && continue

        ISSUE_IID=$(echo "$RELEASE_ISSUE" | jq -r '.iid')
        echo "ðŸ“‹ Updating #${ISSUE_IID} for ${MILESTONE_TITLE}"

        # Get issue stats
        TOTAL=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues?milestone=${MILESTONE_TITLE}&per_page=100" \
          | jq 'length')

        CLOSED=$(curl -sS --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues?milestone=${MILESTONE_TITLE}&state=closed&per_page=100" \
          | jq 'length')

        OPEN=$((TOTAL - CLOSED))

        # Add comment with status - using printf to avoid YAML parsing issues
        COMMENT=$(printf '%s\n' \
          "### Milestone Status Update" \
          "" \
          "Progress: ${CLOSED}/${TOTAL} complete (${OPEN} remaining)" \
          "" \
          "---" \
          "_Auto-updated by CI pipeline #${CI_PIPELINE_ID}_")

        curl -sS --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "$(jq -n --arg body "$COMMENT" '{body: $body}')" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues/${ISSUE_IID}/notes" > /dev/null

        echo "   âœ… Updated with status: ${CLOSED}/${TOTAL} complete"
      done
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_success
  allow_failure: true
>>>>>>> origin/feature/ai-foundations
