# Release Automation CI Jobs
# Runs validation agents on release branches

validate:examples:
  stage: validate
  image: node:20-alpine
  before_script:
    - apk add --no-cache yq jq
    - npm ci
  script:
    - echo "üîç Validating all examples..."
    - |
      # Find all example files
      EXAMPLES=$(find examples -name "*.yaml" -o -name "*.yml")
      FAILED=0
      
      for file in $EXAMPLES; do
        echo "Validating $file..."
        
        # Check YAML syntax
        if ! yq eval '.' "$file" > /dev/null 2>&1; then
          echo "‚ùå YAML syntax error in $file"
          FAILED=1
          continue
        fi
        
        # Check apiVersion for OSSA files
        if [[ "$file" == *.ossa.yaml ]]; then
          # Handle multi-document YAML files by checking each apiVersion separately
          VERSIONS=$(yq eval '.apiVersion' "$file")
          while IFS= read -r VERSION; do
            if [[ ! "$VERSION" =~ ^ossa/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "‚ùå Invalid apiVersion in $file: $VERSION"
              FAILED=1
            fi
          done <<< "$VERSIONS"
        fi
      done
      
      if [ $FAILED -eq 1 ]; then
        echo "‚ùå Example validation failed"
        exit 1
      fi
      
      echo "‚úÖ All examples valid"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - examples/**/*
    - if: '$CI_COMMIT_BRANCH =~ /^release\//'
      when: always

validate:release:
  stage: validate
  image: node:20-alpine
  before_script:
    - apk add --no-cache git jq
    - npm ci
  script:
    - echo "üö¶ Running release validation..."
    - |
      FAILED=0
      
      # Check tests pass
      echo "Running tests..."
      if ! npm test; then
        echo "‚ùå Tests failed"
        FAILED=1
      fi
      
      # Check CHANGELOG exists and is updated
      if [ ! -f CHANGELOG.md ]; then
        echo "‚ùå CHANGELOG.md missing"
        FAILED=1
      fi
      
      # Check version consistency
      PKG_VERSION=$(jq -r '.version' package.json)
      echo "Package version: $PKG_VERSION"
      
      # Check examples are valid
      if ! npm run validate:examples 2>/dev/null; then
        echo "‚ö†Ô∏è  Example validation script not found, skipping"
      fi
      
      if [ $FAILED -eq 1 ]; then
        echo "‚ùå Release validation failed"
        exit 1
      fi
      
      echo "‚úÖ Release validation passed"
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release\//'
      when: always
  allow_failure: false

generate:changelog:
  stage: deploy
  image: node:20-alpine
  before_script:
    - apk add --no-cache git
  script:
    - echo "üìù Generating CHANGELOG..."
    - |
      LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      CURRENT_TAG=${CI_COMMIT_TAG:-"Unreleased"}
      
      cat > CHANGELOG.md << CHANGELOG_EOF
      # Changelog
      
      ## [${CURRENT_TAG}] - $(date +%Y-%m-%d)
      
      ### ‚ú® Features
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^feat" || echo "None")
      
      ### üêõ Bug Fixes
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^fix" || echo "None")
      
      ### üìö Documentation
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^docs" || echo "None")
      
      ### ‚ö° Performance
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^perf" || echo "None")
      
      ### ‚ôªÔ∏è Refactoring
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^refactor" || echo "None")
      CHANGELOG_EOF
      
      cat CHANGELOG.md
  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      when: always
