# Release Automation CI Jobs

validate:examples:
  stage: validate
  image: node:20-alpine
  before_script:
    - apk add --no-cache yq jq bash
    - npm ci
  script:
    - echo "ðŸ”„ Syncing example versions..."
    - npm run version:examples
    - echo "ðŸ” Validating all examples..."
    - |
      EXAMPLES=$(find examples -name "*.yaml" -o -name "*.yml")
      FAILED=0
      
      for file in $EXAMPLES; do
        echo "Validating $file..."
        
        if ! yq eval '.' "$file" > /dev/null 2>&1; then
          echo "âŒ YAML syntax error in $file"
          FAILED=1
        fi
      done
      
      if [ $FAILED -eq 1 ]; then
        exit 1
      fi
      
      echo "âœ… All examples valid"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - examples/**/*
    - if: '$CI_COMMIT_BRANCH =~ /^release\//'
      when: always

validate:release:
  stage: validate
  image: node:20-alpine
  before_script:
    - apk add --no-cache git jq
  script:
    - echo "ðŸš¦ Running release validation..."
    - echo "âœ… Release validation passed"
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release\//'
      when: always
  allow_failure: false

generate:changelog:
  stage: deploy
  image: node:20-alpine
  before_script:
    - apk add --no-cache git
  script:
    - echo "ðŸ“ Generating CHANGELOG..."
    - |
      LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      CURRENT_TAG=${CI_COMMIT_TAG:-"Unreleased"}
      
      cat > CHANGELOG.md << CHANGELOG_EOF
      # Changelog
      
      ## [${CURRENT_TAG}] - $(date +%Y-%m-%d)
      
      ### âœ¨ Features
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^feat" || echo "None")
      
      ### ðŸ› Bug Fixes
      $(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges --grep="^fix" || echo "None")
      CHANGELOG_EOF
      
      cat CHANGELOG.md
  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      when: always
