# ============================================================================
# Complete Autonomous Framework Pipeline
# ============================================================================
# Master pipeline that orchestrates all autonomous systems
# ============================================================================

variables:
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}
  AUTONOMOUS_MODE: ${AUTONOMOUS_MODE:-enabled}

# ============================================================================
# AUTONOMOUS MASTER COORDINATOR
# ============================================================================

autonomous:master-coordinator:
  stage: .pre
  image: node:22-alpine
  needs: []
  rules:
    - if: $AUTONOMOUS_MODE == "enabled"
      when: always
  variables:
    AGENT_NAME: task-dispatcher
    SERVICE_ACCOUNT: "@t"ask-dispatcher
    AGENT_TOKEN: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Autonomous Framework Master Coordinator"
      echo "======================================="
      echo ""
      echo "Orchestrating all autonomous systems..."
      echo ""
      
      RESPONSE=$(curl -s -X POST \
        "${PLATFORM_AGENTS_API}/agents/${AGENT_NAME}/invoke" \
        -H "Authorization: Bearer ${AGENT_TOKEN}" \
        -H "X-Service-Account: ${SERVICE_ACCOUNT}" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"orchestrate-framework\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"coordinate_all\": true,
            \"prioritize_tasks\": true,
            \"create_workflow\": true
          }
        }")
      
      echo "$RESPONSE" | jq '.'
      
      WORKFLOW_ID=$(echo "$RESPONSE" | jq -r '.outputs.workflow_id // empty')
      if [ -n "$WORKFLOW_ID" ] && [ "$WORKFLOW_ID" != "null" ]; then
        echo "Workflow created: $WORKFLOW_ID"
      fi
  allow_failure: false
