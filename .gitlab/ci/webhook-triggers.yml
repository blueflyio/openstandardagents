# ============================================================================
# Webhook Triggers for Autonomous Framework
# ============================================================================
# Triggers autonomous flows based on GitLab events
# Uses existing platform-agents via webhooks
# ============================================================================

variables:
  PLATFORM_AGENTS_WEBHOOK: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}/api/webhooks/gitlab

# ============================================================================
# ISSUE WEBHOOK TRIGGERS
# ============================================================================

trigger:issue-opened:
  stage: .pre
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "issue"
      variables:
        - $CI_WEBHOOK_EVENT_ACTION == "open"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Triggering Issue Triage Agent"
      
      curl -X POST \
        "${PLATFORM_AGENTS_WEBHOOK}" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN}" \
        -H "X-Service-Account: @issue-lifecycle-manager" \
        -H "Content-Type: application/json" \
        -d "{
          \"object_kind\": \"issue\",
          \"event_type\": \"issue\",
          \"agent\": \"issue-lifecycle-manager\",
          \"task\": \"triage-new-issue\",
          \"object_attributes\": {
            \"iid\": ${CI_WEBHOOK_OBJECT_ATTRIBUTES_IID},
            \"action\": \"open\"
          }
        }" | jq '.'
  allow_failure: false

trigger:issue-updated:
  stage: .pre
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "issue"
      variables:
        - $CI_WEBHOOK_EVENT_ACTION == "update"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Triggering Issue Update Handler"
      
      curl -X POST \
        "${PLATFORM_AGENTS_WEBHOOK}" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN}" \
        -H "X-Service-Account: @issue-lifecycle-manager" \
        -H "Content-Type: application/json" \
        -d "{
          \"object_kind\": \"issue\",
          \"event_type\": \"issue\",
          \"agent\": \"issue-lifecycle-manager\",
          \"task\": \"update-issue-state\",
          \"object_attributes\": {
            \"iid\": ${CI_WEBHOOK_OBJECT_ATTRIBUTES_IID},
            \"action\": \"update\"
          }
        }" | jq '.'
  allow_failure: false

# ============================================================================
# MERGE REQUEST WEBHOOK TRIGGERS
# ============================================================================

trigger:mr-opened:
  stage: .pre
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "merge_request"
      variables:
        - $CI_WEBHOOK_EVENT_ACTION == "open"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Triggering MR Review Agent"
      
      curl -X POST \
        "${PLATFORM_AGENTS_WEBHOOK}" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}" \
        -H "X-Service-Account: @mr-reviewer" \
        -H "Content-Type: application/json" \
        -d "{
          \"object_kind\": \"merge_request\",
          \"event_type\": \"merge_request\",
          \"agent\": \"mr-reviewer\",
          \"task\": \"review-new-mr\",
          \"object_attributes\": {
            \"iid\": ${CI_WEBHOOK_OBJECT_ATTRIBUTES_IID},
            \"action\": \"open\"
          }
        }" | jq '.'
  allow_failure: false

trigger:mr-updated:
  stage: .pre
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "merge_request"
      variables:
        - $CI_WEBHOOK_EVENT_ACTION == "update"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Triggering MR Update Handler"
      
      curl -X POST \
        "${PLATFORM_AGENTS_WEBHOOK}" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}" \
        -H "X-Service-Account: @mr-reviewer" \
        -H "Content-Type: application/json" \
        -d "{
          \"object_kind\": \"merge_request\",
          \"event_type\": \"merge_request\",
          \"agent\": \"mr-reviewer\",
          \"task\": \"update-mr-review\",
          \"object_attributes\": {
            \"iid\": ${CI_WEBHOOK_OBJECT_ATTRIBUTES_IID},
            \"action\": \"update\"
          }
        }" | jq '.'
  allow_failure: false

# ============================================================================
# MILESTONE WEBHOOK TRIGGERS
# ============================================================================

trigger:milestone-closed:
  stage: release
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "milestone"
      variables:
        - $CI_WEBHOOK_EVENT_ACTION == "close"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Triggering Release Coordinator"
      
      curl -X POST \
        "${PLATFORM_AGENTS_WEBHOOK}" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN}" \
        -H "X-Service-Account: @release-coordinator" \
        -H "Content-Type: application/json" \
        -d "{
          \"object_kind\": \"milestone\",
          \"event_type\": \"milestone\",
          \"agent\": \"release-coordinator\",
          \"task\": \"milestone-closed-release\",
          \"object_attributes\": {
            \"id\": ${CI_WEBHOOK_OBJECT_ATTRIBUTES_ID},
            \"action\": \"close\"
          }
        }" | jq '.'
  allow_failure: false

# ============================================================================
# PIPELINE WEBHOOK TRIGGERS
# ============================================================================

trigger:pipeline-failed:
  stage: .post
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "pipeline"
      variables:
        - $CI_WEBHOOK_OBJECT_ATTRIBUTES_STATUS == "failed"
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Triggering Pipeline Remediation Agent"
      
      curl -X POST \
        "${PLATFORM_AGENTS_WEBHOOK}" \
        -H "Authorization: Bearer ${SERVICE_ACCOUNT_PIPELINE_REMEDIATION_TOKEN}" \
        -H "X-Service-Account: @pipeline-remediation" \
        -H "Content-Type: application/json" \
        -d "{
          \"object_kind\": \"pipeline\",
          \"event_type\": \"pipeline\",
          \"agent\": \"pipeline-remediation\",
          \"task\": \"fix-failed-pipeline\",
          \"object_attributes\": {
            \"id\": ${CI_WEBHOOK_OBJECT_ATTRIBUTES_ID},
            \"status\": \"failed\"
          }
        }" | jq '.'
  allow_failure: true
