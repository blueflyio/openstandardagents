# ============================================================================
# STAGE 7 - MIRROR
# ============================================================================

mirror:github:
  stage: mirror
  image: alpine:latest
  tags:
    - saas-linux-small-amd64
  before_script:
    - apk add --no-cache curl jq
    - apk add --no-cache git
    - git config --global user.email "ci@bluefly.io"
    - git config --global user.name "GitLab CI"
    - git fetch --all --tags --prune || true
  script:
    - |
      set -e
      
      # Use GH_TOKEN (group variable) or GITHUB_MIRROR_TOKEN (legacy)
      MIRROR_TOKEN="${GH_TOKEN:-$GITHUB_MIRROR_TOKEN}"

      if [ -z "$MIRROR_TOKEN" ]; then
        echo "INFO: No GitHub token set (GH_TOKEN or GITHUB_MIRROR_TOKEN) - skipping"
        exit 0
      fi

      echo "=== GitHub Mirror Sync ==="
      echo "Branch: ${CI_COMMIT_BRANCH:-N/A}"
      echo "Tag: ${CI_COMMIT_TAG:-N/A}"
      echo "Commit: ${CI_COMMIT_SHA:0:8}"
      
      # Add GitHub remote
      git remote remove github 2>/dev/null || true
      git remote add github https://${MIRROR_TOKEN}@github.com/blueflyio/openstandardagents.git
      
      # Sync main branch
      if [ "$CI_COMMIT_BRANCH" == "main" ] || [ -n "$CI_COMMIT_TAG" ]; then
        echo "Syncing main branch..."
        git push github main:main --force || echo "WARNING: Failed to push main branch"
      fi
      
      # Sync all release/* branches
      echo "Syncing release branches..."
      for branch in $(git branch -r | grep "origin/release/" | sed 's|origin/||'); do
        echo "  Syncing branch: $branch"
        git push github "$branch:$branch" --force || echo "WARNING: Failed to push $branch"
      done
      
      # Sync all tags (including RC and production tags)
      echo "Syncing all tags..."
      git push github --tags --force || echo "WARNING: Failed to push tags"
      
      # Verify what was synced
      echo ""
      echo "=== Sync Summary ==="
      echo "Branches synced:"
      git ls-remote --heads github | grep -E "(main|release/)" || echo "  (checking...)"
      echo ""
      echo "Tags synced (RC and production):"
      git ls-remote --tags github | grep -E "(v[0-9]+\.[0-9]+\.[0-9]+|rc)" | tail -10 || echo "  (checking...)"
      
      echo ""
      echo "GitHub mirror sync completed"
  rules:
    # Sync on tags (RC and production)
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$/
      when: on_success
    # Sync on main branch commits
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    # Sync on release branch commits
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/
      when: on_success
  allow_failure: true
