# ============================================================================
# STAGE 7 - MIRROR
# ============================================================================

mirror:github:
  stage: mirror
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
    - apk add --no-cache git
    - git config --global user.email "ci@bluefly.io"
    - git config --global user.name "GitLab CI"
  script:
    - |
      # Use GH_TOKEN (group variable) or GITHUB_MIRROR_TOKEN (legacy)
      MIRROR_TOKEN="${GH_TOKEN:-$GITHUB_MIRROR_TOKEN}"

      if [ -z "$MIRROR_TOKEN" ]; then
        echo "INFO: No GitHub token set (GH_TOKEN or GITHUB_MIRROR_TOKEN) - skipping"
        exit 0
      fi

      echo "Syncing to GitHub..."
      git remote add github https://${MIRROR_TOKEN}@github.com/blueflyio/openstandardagents.git || true
      git push github --all --force || true
      git push github --tags --force || true
      echo "GitHub mirror synced"
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  allow_failure: true

