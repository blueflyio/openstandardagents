# ============================================================================
# OSSA v0.3.0 Agent Integration in GitLab CI/CD
# ============================================================================
# Autonomous agent execution jobs integrated into CI/CD pipeline
# Showcases OSSA v0.3.0 with KAgent and GitLab Duo integration
# ============================================================================

# ============================================================================
# AGENT EXECUTION JOBS
# ============================================================================

# Release Orchestrator - Autonomous release management
agent:release-orchestrator:
  extends: ossa:agent
  stage: release
  variables:
    agent_name: release-orchestrator
    agent_path: .gitlab/agents/release-orchestrator/manifest.ossa.yaml
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $MILESTONE_READY == "true"
      when: on_success
  needs:
    - detect:milestone-and-tags
    - release:changelog

# CI/CD Optimizer - Pipeline performance analysis
agent:ci-cd-optimizer:
  extends: ossa:agent
  stage: quality
  variables:
    agent_name: ci-cd
    agent_path: .gitlab/agents/ci-cd/manifest.ossa.yaml
    task: analyze_pipeline
    inputs: |
      {
        "project_id": ${CI_PROJECT_ID},
        "pipeline_id": ${CI_PIPELINE_ID}
      }
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "development"
      when: on_success
  allow_failure: true

# Security Scanner - Security vulnerability detection
agent:security-scanner:
  extends: ossa:agent
  stage: quality
  variables:
    agent_name: security-scanner
    agent_path: .gitlab/agents/security-scanner/manifest.ossa.yaml
    task: scan_comprehensive
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  allow_failure: false

# Code Reviewer - Autonomous code review
agent:code-reviewer:
  extends: ossa:agent
  stage: .pre
  variables:
    agent_name: mr-reviewer
    agent_path: .gitlab/agents/mr-reviewer/manifest.ossa.yaml
    task: code-review
    inputs: |
      {
        "project_id": ${CI_PROJECT_ID},
        "merge_request_id": ${CI_MERGE_REQUEST_IID}
      }
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
  allow_failure: true

# Issue Triage - Autonomous issue routing
agent:issue-triage:
  extends: ossa:agent
  stage: .pre
  variables:
    agent_name: issue-triage
    agent_path: .gitlab/agents/issue-triage/manifest.ossa.yaml
    task: triage_issue
  rules:
    - if: $CI_PIPELINE_SOURCE == "webhook" && $CI_WEBHOOK_EVENT == "issue"
      when: on_success
  allow_failure: true

# Pipeline Fixer - Autonomous pipeline failure remediation
agent:pipeline-fixer:
  extends: ossa:agent
  stage: .post
  variables:
    agent_name: pipeline-fixer
    agent_path: .gitlab/agents/pipeline-fixer/manifest.ossa.yaml
    task: analyze_and_fix
    inputs: |
      {
        "project_id": ${CI_PROJECT_ID},
        "pipeline_id": ${CI_PIPELINE_ID},
        "job_id": ${CI_JOB_ID}
      }
  rules:
    - if: $CI_PIPELINE_STATUS == "failed"
      when: on_success
  allow_failure: true

# ============================================================================
# WORKFLOW EXECUTION JOBS
# ============================================================================

# Release Workflow - Complete release orchestration
workflow:release:
  extends: ossa:workflow
  stage: release
  variables:
    workflow_path: .gitlab/workflows/release-workflow.ossa.yaml
    workflow_inputs: |
      {
        "milestone_id": ${MILESTONE_ID},
        "milestone_title": "${MILESTONE_TITLE}",
        "project_id": ${CI_PROJECT_ID}
      }
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $MILESTONE_READY == "true"
      when: on_success
  needs:
    - detect:milestone-and-tags
    - release:changelog

# ============================================================================
# KAGENT DEPLOYMENT JOBS
# ============================================================================

# Deploy agents to Kubernetes via KAgent
deploy:agents:kagent:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl kubectl
    - |
      echo "üöÄ Deploying OSSA agents to Kubernetes via KAgent"
      echo "   Namespace: agent-system"
      echo "   Agents: All v0.3.0 agents"
  script:
    - |
      # Deploy each agent manifest to Kubernetes via KAgent
      for agent_dir in .gitlab/agents/*/; do
        if [ -f "${agent_dir}manifest.ossa.yaml" ]; then
          agent_name=$(basename "$agent_dir")
          echo "üì¶ Deploying agent: ${agent_name}"
          
          # Use KAgent CLI to deploy (if available)
          # kagent deploy "${agent_dir}manifest.ossa.yaml" --namespace agent-system || echo "  ‚ö†Ô∏è  KAgent CLI not available, skipping deployment"
          echo "  ‚úÖ Agent manifest ready for KAgent deployment: ${agent_name}"
        fi
      done
      
      echo ""
      echo "‚úÖ All OSSA v0.3.0 agents ready for Kubernetes deployment"
      echo "   Deploy manually with: kagent deploy .gitlab/agents/*/manifest.ossa.yaml"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $CI_COMMIT_BRANCH == "development"
      when: manual
  allow_failure: true

# ============================================================================
# GITLAB DUO FLOW VALIDATION
# ============================================================================

validate:duo-flows:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache yq
  script:
    - |
      echo "üîç Validating GitLab Duo flow configurations..."
      
      for flow in .gitlab/flows/*.yaml; do
        if [ -f "$flow" ]; then
          echo "  Validating: $flow"
          # Basic YAML validation
          yq eval '.' "$flow" > /dev/null || (echo "  ‚ùå Invalid YAML: $flow" && exit 1)
          echo "  ‚úÖ Valid: $flow"
        fi
      done
      
      echo ""
      echo "‚úÖ All GitLab Duo flows validated"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "development"
      when: always
  allow_failure: false
