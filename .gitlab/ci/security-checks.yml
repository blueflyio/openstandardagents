# Security Checks - Prevent Token Exposure
# Runs in .pre stage before any code is committed

security:check-tokens:
  stage: .pre
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - |
      set -e
      echo "Checking for exposed tokens..."
      FOUND=0
      
      # Check for GitLab PAT patterns
      if git grep -E "glpat-[A-Za-z0-9_-]{20,}" -- . :!'.gitlab/ci/security-checks.yml'; then
        echo "ERROR: GitLab PAT token found in codebase"
        FOUND=1
      fi
      
      # Check for GitHub token patterns
      if git grep -E "(ghp_|gho_|ghu_|ghs_|ghr_)[A-Za-z0-9_-]{36,}" -- . :!'.gitlab/ci/security-checks.yml'; then
        echo "ERROR: GitHub token found in codebase"
        FOUND=1
      fi
      
      # Check for generic bearer tokens (common leak vector)
      if git grep -E "(Bearer|bearer|Authorization:)\s+[A-Za-z0-9_-]{32,}" -- . :!'.gitlab/ci/security-checks.yml'; then
        echo "ERROR: Bearer token pattern found in codebase"
        FOUND=1
      fi
      
      # Check for .env files accidentally committed
      if git ls-files | grep -E '^\.env' | grep -v '^\.env\.example$' | grep -v '^\.env\.template$'; then
        echo "ERROR: .env file found in repository (should be in .gitignore)"
        FOUND=1
      fi
      
      if [ $FOUND -eq 1 ]; then
        echo "SECURITY VIOLATION: Tokens or secrets found in codebase"
        echo "Remove tokens immediately and revoke them"
        exit 1
      fi
      
      echo "No tokens or secrets found in codebase"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH =~ /^release\//'
    - if: '$CI_COMMIT_BRANCH == "main"'
  allow_failure: false
