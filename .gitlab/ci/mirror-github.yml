# =============================================================================
# SELECTIVE GITHUB MIRRORING
# =============================================================================
# Mirrors only main, release/* branches and production/RC tags to GitHub
# Excludes all feature branches and dev tags
#
# Requirements:
# - GITHUB_TOKEN CI/CD variable set
# - GitHub repository exists: https://github.com/blueflyio/openstandardagents
# =============================================================================

mirror:github:
  stage: .post
  image: alpine:latest
  tags:
    - self-hosted
    - docker
    - linux
  before_script:
    - apk add --no-cache git bash
    - git config --global user.email "ci@bluefly.io"
    - git config --global user.name "GitLab CI"
    - git fetch --all --tags --prune || true
    - |
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "WARNING: GITHUB_TOKEN not set - skipping GitHub mirror"
        echo "Add GITHUB_TOKEN in Settings > CI/CD > Variables"
        exit 0
      fi
      echo "GitHub token configured"
  script:
    - |
      #!/bin/bash
      set -e

      echo "SELECTIVE GITHUB MIRROR"
      echo "======================"
      echo "Branch: ${CI_COMMIT_BRANCH:-N/A}"
      echo "Tag: ${CI_COMMIT_TAG:-N/A}"
      echo "Commit: ${CI_COMMIT_SHA:0:8}"
      echo ""

      # Add/update GitHub remote
      git remote remove github 2>/dev/null || true
      git remote add github "https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git"

      # Function to check if branch should be synced
      should_sync_branch() {
        local branch="$1"
        # Remove 'origin/' prefix if present
        branch="${branch#origin/}"
        
        # Sync main and release branches only
        if [[ "$branch" == "main" ]] || [[ "$branch" =~ ^release/v[0-9]+\.[0-9]+\.x$ ]]; then
          return 0
        fi
        return 1
      }

      # Function to check if tag should be synced
      should_sync_tag() {
        local tag="$1"
        
        # Sync production tags: v0.3.5, v1.0.0, etc.
        if [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          return 0
        fi
        
        # Sync RC tags: v0.3.6-rc.1, v1.0.0-rc.2, etc.
        if [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ ]]; then
          return 0
        fi
        
        # Don't sync dev tags or any other tags
        return 1
      }

      # Sync branches
      echo "Syncing branches..."
      BRANCHES_TO_SYNC=()
      BRANCHES_SKIPPED=()

      while IFS= read -r branch; do
        branch="${branch#origin/}"
        
        if should_sync_branch "$branch"; then
          BRANCHES_TO_SYNC+=("$branch")
        else
          BRANCHES_SKIPPED+=("$branch")
        fi
      done < <(git branch -r | grep -v HEAD | sed 's/^[[:space:]]*//')

      if [ ${#BRANCHES_TO_SYNC[@]} -eq 0 ]; then
        echo "No branches to sync"
      else
        echo "Branches to sync: ${BRANCHES_TO_SYNC[*]}"
        for branch in "${BRANCHES_TO_SYNC[@]}"; do
          echo "  Syncing branch: $branch"
          git push github "origin/$branch:refs/heads/$branch" --force || {
            echo "WARNING: Failed to sync branch: $branch"
          }
        done
      fi

      if [ ${#BRANCHES_SKIPPED[@]} -gt 0 ]; then
        echo "Branches skipped (${#BRANCHES_SKIPPED[@]}): ${BRANCHES_SKIPPED[*]:0:5}..."
      fi

      # Sync tags
      echo ""
      echo "Syncing tags..."
      TAGS_TO_SYNC=()
      TAGS_SKIPPED=()

      while IFS= read -r tag; do
        if should_sync_tag "$tag"; then
          TAGS_TO_SYNC+=("$tag")
        else
          TAGS_SKIPPED+=("$tag")
        fi
      done < <(git tag)

      if [ ${#TAGS_TO_SYNC[@]} -eq 0 ]; then
        echo "No tags to sync"
      else
        echo "Tags to sync (${#TAGS_TO_SYNC[@]}): ${TAGS_TO_SYNC[*]:0:10}..."
        for tag in "${TAGS_TO_SYNC[@]}"; do
          echo "  Syncing tag: $tag"
          git push github "$tag" --force || {
            echo "WARNING: Failed to sync tag: $tag"
          }
        done
      fi

      if [ ${#TAGS_SKIPPED[@]} -gt 0 ]; then
        echo "Tags skipped (${#TAGS_SKIPPED[@]}): ${TAGS_SKIPPED[*]:0:10}..."
      fi

      echo ""
      echo "GitHub mirror sync complete"
  rules:
    # Run on main branch pushes
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
      when: on_success
    # Run on release branch pushes
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/ && $CI_PIPELINE_SOURCE == "push"
      when: on_success
    # Run on production tag creation
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/ && $CI_COMMIT_TAG !~ /-rc|-dev/
      when: on_success
    # Run on RC tag creation
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$/
      when: on_success
  allow_failure: true
