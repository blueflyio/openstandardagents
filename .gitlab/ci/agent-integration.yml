# =============================================================================
# Agent Integration CI Configuration
# =============================================================================
# This file provides GitLab CI jobs for automated agent invocation based on
# file changes and MR events.
# =============================================================================

# Include in main .gitlab-ci.yml:
#   include:
#     - local: '.gitlab/ci/agent-integration.yml'

stages:
  - validate
  - agents
  - review
  - post-review

variables:
  AGENT_PRIORITY: "normal"
  AGENT_TIMEOUT: "300"

# =============================================================================
# TEMPLATES
# =============================================================================

.agent-base:
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  variables:
    GIT_STRATEGY: none
  script:
    - |
      invoke_agent() {
        local agent_name=$1
        local command=$2
        local priority=${3:-$AGENT_PRIORITY}

        echo "ü§ñ Invoking agent: $agent_name"
        echo "   Command: $command"
        echo "   Priority: $priority"

        # Post comment to MR mentioning the agent
        curl -s --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_TOKEN:-$CI_JOB_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "{\"body\": \"@${agent_name} ${command}\"}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes" || true

        echo "‚úÖ Agent ${agent_name} invoked"
      }

.hotfix-rules:
  rules:
    - if: $CI_MERGE_REQUEST_LABELS =~ /hotfix/
      variables:
        AGENT_PRIORITY: "critical"
        AGENT_TIMEOUT: "60"

# =============================================================================
# VALIDATE STAGE - Schema & Syntax Checks
# =============================================================================

validate:yaml:
  stage: validate
  image: python:3.11-alpine
  before_script:
    - pip install yamllint --quiet
  script:
    - |
      echo "üîç Validating YAML files..."
      yamllint -c .yamllint.yml . || true
      echo "‚úÖ YAML validation complete"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.yaml"
        - "**/*.yml"
  allow_failure: true

validate:ossa:
  stage: validate
  image: node:20-alpine
  before_script:
    - npm install -g @bluefly/openstandardagents
  script:
    - |
      echo "üîç Validating OSSA manifests..."
      find . -name "*.ossa.yaml" -o -name "*.ossa.yml" | while read f; do
        echo "Validating: $f"
        ossa validate "$f" --strict || true
      done
      echo "‚úÖ OSSA validation complete"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
        - ".gitlab/agents/**/*"
        - ".agents/**/*"
  allow_failure: true

validate:gitlab-ci:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "üîç Validating GitLab CI syntax..."
      LINT_RESPONSE=$(curl -s --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN:-$CI_JOB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{\"content\": $(cat .gitlab-ci.yml | jq -Rs .)}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/ci/lint")

      if echo "$LINT_RESPONSE" | jq -e '.valid' | grep -q true; then
        echo "‚úÖ GitLab CI syntax is valid"
      else
        echo "‚ùå GitLab CI syntax errors:"
        echo "$LINT_RESPONSE" | jq -r '.errors[]' 2>/dev/null || echo "$LINT_RESPONSE"
        exit 1
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ".gitlab-ci.yml"
        - ".gitlab/ci/**/*.yml"
  allow_failure: true

# =============================================================================
# AGENTS STAGE - Auto-Invoke Based on File Changes
# =============================================================================

agent:mr-reviewer:
  extends: .agent-base
  stage: agents
  script:
    - invoke_agent "merge-request-reviewer" "review full"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

agent:ossa-validator:
  extends: .agent-base
  stage: agents
  script:
    - invoke_agent "manifest-validator" "validate --strict"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
        - ".gitlab/agents/**/*"
        - ".agents/**/*"
        - "spec/**/*"
  allow_failure: true

agent:ci-fixer:
  extends: .agent-base
  stage: agents
  script:
    - invoke_agent "pipeline-remediation" "validate"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - ".gitlab-ci.yml"
        - ".gitlab/ci/**/*.yml"
  allow_failure: true

agent:website-reviewer:
  extends: .agent-base
  stage: agents
  script:
    - invoke_agent "merge-request-reviewer" "review --focus website"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "website/**/*"
  allow_failure: true

agent:hotfix-review:
  extends:
    - .agent-base
    - .hotfix-rules
  stage: agents
  script:
    - invoke_agent "merge-request-reviewer" "review urgent --security" "critical"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /hotfix/
  when: always
  allow_failure: true

# =============================================================================
# REVIEW STAGE - Aggregate Agent Responses
# =============================================================================

review:aggregate:
  extends: .agent-base
  stage: review
  script:
    - |
      echo "üìä Aggregating agent responses..."

      # Fetch all comments from agents
      COMMENTS=$(curl -s --request GET \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN:-$CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes?per_page=100")

      # Count agent responses
      AGENT_RESPONSES=$(echo "$COMMENTS" | jq '[.[] | select(.author.username | test("^(merge-request-reviewer|manifest-validator|pipeline-remediation|code-quality-reviewer|issue-lifecycle-manager)"))] | length')
      echo "Agent responses: $AGENT_RESPONSES"

      # Check for blocking issues
      BLOCKING=$(echo "$COMMENTS" | jq '[.[] | select(.body | contains("BLOCKING") or contains("üö®"))] | length')

      if [ "$BLOCKING" -gt 0 ]; then
        echo "‚ùå Found $BLOCKING blocking issues from agents"
        exit 1
      fi

      echo "‚úÖ No blocking issues found"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - job: agent:mr-reviewer
      optional: true
    - job: agent:ossa-validator
      optional: true
    - job: agent:ci-fixer
      optional: true
    - job: agent:website-reviewer
      optional: true
  allow_failure: true

# =============================================================================
# POST-REVIEW STAGE - Documentation & Notifications
# =============================================================================

post-review:docs-sync:
  stage: post-review
  image: node:20-alpine
  script:
    - |
      echo "üìö Syncing documentation..."
      cd website
      npm ci --prefer-offline --no-audit
      npm run sync-wiki || true
      echo "‚úÖ Documentation sync complete"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "wiki/**/*"
        - "docs/**/*"
  when: manual
  allow_failure: true
