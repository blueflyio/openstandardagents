# GitLab Agent Integration
# Uses agents from blueflyio/agent-platform

variables:
  AGENT_PLATFORM_PROJECT: blueflyio/agent-platform/gitlab_components

# GitHub PR Sync Agent
github:sync:agent:
  stage: .pre
  trigger:
    project: ${AGENT_PLATFORM_GROUP}
    strategy: depend
  variables:
    AGENT_NAME: gitlab-lib-ci
    AGENT_TASK: github-pr-sync
    TARGET_REPO: blueflyio/openstandardagents
    GITHUB_OWNER: blueflyio
    GITHUB_REPO: openstandardagents
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
      allow_failure: true

# Code Review Agent
# Note: Requires blueflyio/agent-platform project to be created
# Currently set to allow_failure until agent-platform is deployed
code:review:agent:
  stage: .pre
  allow_failure: true
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: code-review
    TARGET_PROJECT: $CI_PROJECT_PATH
    MR_IID: $CI_MERGE_REQUEST_IID
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success

# Documentation Sync Agent
docs:sync:agent:
  stage: .post
  trigger:
    project: ${AGENT_PLATFORM_GROUP}
    strategy: depend
  variables:
    AGENT_NAME: gitlab-lib-ci
    AGENT_TASK: docs-sync
    SOURCE_BRANCH: $CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - docs/**/*
        - README.md

# Security Scan Agent
security:scan:agent:
  stage: test
  allow_failure: true
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: security-scan
    TARGET_PROJECT: $CI_PROJECT_PATH
    SCAN_TYPE: full
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "schedule"
      when: on_success

# TypeScript Build Agent
ts:build:agent:
  stage: build
  trigger:
    project: ${AGENT_PLATFORM_GROUP}
    strategy: depend
  variables:
    AGENT_NAME: ts-prod
    AGENT_TASK: build
    BUILD_TARGET: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Deployment Agent (Infrastructure)
deploy:infra:agent:
  stage: deploy
  trigger:
    project: ${AGENT_PLATFORM_GROUP}
    strategy: depend
  variables:
    AGENT_NAME: infra-prod
    AGENT_TASK: deploy
    ENVIRONMENT: production
    MANIFEST_PATH: infrastructure/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - infrastructure/**/*
      allow_failure: true
    - if: $CI_COMMIT_TAG
      allow_failure: true

# ML Model Deployment Agent
deploy:ml:agent:
  stage: deploy
  trigger:
    project: ${AGENT_PLATFORM_GROUP}
    strategy: depend
  variables:
    AGENT_NAME: ml-prod
    AGENT_TASK: deploy-model
    MODEL_PATH: models/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - models/**/*
      allow_failure: true

# Drupal Integration Agent
drupal:sync:agent:
  stage: .post
  trigger:
    project: ${AGENT_PLATFORM_GROUP}
    strategy: depend
  variables:
    AGENT_NAME: drupal-prod
    AGENT_TASK: sync-content
    CONTENT_TYPE: ossa-agents
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - spec/**/*
      allow_failure: true

# Native Build Agent
native:build:agent:
  stage: build
  trigger:
    project: ${AGENT_PLATFORM_GROUP}
    strategy: depend
  variables:
    AGENT_NAME: native-local
    AGENT_TASK: build-native
    PLATFORM: multi
  rules:
    - if: $CI_COMMIT_TAG
      allow_failure: true

# ============================================================================
# WEBHOOK-TRIGGERED AGENTS
# ============================================================================
# These agents are triggered by GitLab webhooks (issues, merge requests)
# Setup:
#   1. Create service account: https://gitlab.com/groups/blueflyio/-/settings/service_accounts
#   2. Add AGENT_SERVICE_TOKEN variable: https://gitlab.com/blueflyio/openstandardagents/-/settings/ci_cd
#   3. Create webhook: https://gitlab.com/blueflyio/openstandardagents/-/settings/integrations
#   4. Add WEBHOOK_SECRET variable

# MR Manager Agent - Triggered by webhook events
agent:mr-manager:
  stage: .pre
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build
  script:
    - |
      # Verify webhook authentication
      if [ "$CI_PIPELINE_SOURCE" != "trigger" ] && [ "$CI_PIPELINE_SOURCE" != "pipeline" ]; then
        echo "‚ÑπÔ∏è  Not triggered by webhook/trigger, skipping MR Manager"
        exit 0
      fi

      echo "ü§ñ MR Manager Agent Starting..."
      echo "   Pipeline Source: ${CI_PIPELINE_SOURCE}"
      echo "   Trigger: ${TRIGGER_EVENT_TYPE:-unknown}"

      # Use service account token for GitLab API calls
      export GITLAB_TOKEN="${AGENT_SERVICE_TOKEN}"

      # Check if manifest exists
      MANIFEST_PATH=".gitlab/agents/mr-manager/manifest.ossa.yaml"
      if [ -f "$MANIFEST_PATH" ]; then
        echo "üìã Running agent from: ${MANIFEST_PATH}"
        node dist/cli/index.js run "$MANIFEST_PATH" || echo "‚ö†Ô∏è  Agent completed with warnings"
      else
        echo "‚ö†Ô∏è  Agent manifest not found: ${MANIFEST_PATH}"
        echo "   Create the manifest or update MANIFEST_PATH"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
      when: on_success
    - if: $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_EVENT_TYPE
      when: on_success
  allow_failure: true

# Issue Triage Agent - Auto-labels and assigns issues
agent:issue-triage:
  stage: .pre
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build
  script:
    - |
      if [ "$CI_PIPELINE_SOURCE" != "trigger" ]; then
        echo "‚ÑπÔ∏è  Not triggered by webhook, skipping Issue Triage"
        exit 0
      fi

      if [ "$TRIGGER_EVENT_TYPE" != "issue" ]; then
        echo "‚ÑπÔ∏è  Not an issue event, skipping"
        exit 0
      fi

      echo "üè∑Ô∏è  Issue Triage Agent Starting..."
      export GITLAB_TOKEN="${AGENT_SERVICE_TOKEN}"

      MANIFEST_PATH=".gitlab/agents/issue-triage/manifest.ossa.yaml"
      if [ -f "$MANIFEST_PATH" ]; then
        node dist/cli/index.js run "$MANIFEST_PATH" || echo "‚ö†Ô∏è  Agent completed with warnings"
      else
        echo "‚ö†Ô∏è  Agent manifest not found: ${MANIFEST_PATH}"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger" && $TRIGGER_EVENT_TYPE == "issue"
      when: on_success
  allow_failure: true
