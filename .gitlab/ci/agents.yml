# GitLab Agent Integration
# Uses agents from blueflyio/platform-agents

variables:
  # ‚úÖ FIXED: Use correct project path
  AGENT_PLATFORM_PROJECT: blueflyio/platform-agents

# GitHub PR Sync Agent
github:sync:agent:
  stage: .pre
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: gitlab-lib-ci
    AGENT_TASK: github-pr-sync
    TARGET_REPO: blueflyio/openstandardagents
    GITHUB_OWNER: blueflyio
    GITHUB_REPO: openstandardagents
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
      allow_failure: true

# Code Review Agent - Local Execution
# Runs code review using local OSSA agent manifests
# Switched from downstream trigger to local execution for reliability
code:review:agent:
  stage: .pre
  image: node:${NODE_VERSION}-alpine
  allow_failure: false
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build || (echo "‚ö†Ô∏è  Build failed, skipping code review" && exit 0)
  script:
    - |
      set +e
      echo "üîç Code Review Agent Starting..."
      echo "   MR: !${CI_MERGE_REQUEST_IID}"
      echo "   Project: ${CI_PROJECT_PATH}"

      # Check for OSSA agent manifest
      MANIFEST_PATH=".gitlab/agents/ossa-agent/manifest.ossa.yaml"
      if [ ! -f "$MANIFEST_PATH" ]; then
        echo "‚ÑπÔ∏è  No code review agent manifest found at ${MANIFEST_PATH}"
        echo "   Skipping code review. Create manifest to enable."
        exit 0
      fi

      echo "üìã Running code review from: ${MANIFEST_PATH}"
      export GITLAB_TOKEN="${AGENT_SERVICE_TOKEN:-$CI_JOB_TOKEN}"
      export MR_IID="${CI_MERGE_REQUEST_IID}"
      export TARGET_PROJECT="${CI_PROJECT_PATH}"
      
      if node dist/cli/index.js run "$MANIFEST_PATH" 2>&1; then
        echo "‚úÖ Code review completed successfully"
      else
        echo "‚ö†Ô∏è  Code review completed with warnings (non-blocking)"
        exit 0
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success

# Documentation Sync Agent
docs:sync:agent:
  stage: .post
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: gitlab-lib-ci
    AGENT_TASK: docs-sync
    SOURCE_BRANCH: $CI_COMMIT_BRANCH
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - docs/**/*
        - README.md

# Security Scan Agent - Local Execution
# Runs security scanning using local OSSA security-scanner manifest
# Switched from downstream trigger to local execution for reliability
security:scan:agent:
  stage: test
  image: node:${NODE_VERSION}-alpine
  allow_failure: false
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build
  script:
    - |
      echo "üîí Security Scan Agent Starting..."
      echo "   Project: ${CI_PROJECT_PATH}"
      echo "   Scan Type: full"

      # Check for security scanner manifest
      MANIFEST_PATH=".gitlab/agents/security-scanner/manifest.ossa.yaml"
      if [ -f "$MANIFEST_PATH" ]; then
        echo "üìã Running security scan from: ${MANIFEST_PATH}"
        export GITLAB_TOKEN="${AGENT_SERVICE_TOKEN:-$CI_JOB_TOKEN}"
        export TARGET_PROJECT="${CI_PROJECT_PATH}"
        export SCAN_TYPE="full"
        node dist/cli/index.js run "$MANIFEST_PATH" || echo "‚ö†Ô∏è  Security scan completed with warnings"
      else
        echo "‚ÑπÔ∏è  No security scanner manifest found at ${MANIFEST_PATH}"
        echo "   Skipping security scan. Create manifest to enable."
        echo "   Using GitLab native security scanning instead."
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "schedule"
      when: on_success

# TypeScript Build Agent
# ‚úÖ FIXED: Added proper rules with when clause and allow_failure at rule level
ts:build:agent:
  stage: build
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: ts-prod
    AGENT_TASK: build
    BUILD_TARGET: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
      allow_failure: true
    - if: $CI_COMMIT_TAG
      when: on_success
      allow_failure: true

# Deployment Agent (Infrastructure)
deploy:infra:agent:
  stage: deploy
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: infra-prod
    AGENT_TASK: deploy
    ENVIRONMENT: production
    MANIFEST_PATH: infrastructure/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - infrastructure/**/*
      when: on_success
      allow_failure: true
    - if: $CI_COMMIT_TAG
      when: on_success
      allow_failure: true

# ML Model Deployment Agent
deploy:ml:agent:
  stage: deploy
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: ml-prod
    AGENT_TASK: deploy-model
    MODEL_PATH: models/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - models/**/*
      when: on_success
      allow_failure: true

# Drupal Integration Agent
drupal:sync:agent:
  stage: .post
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: drupal-prod
    AGENT_TASK: sync-content
    CONTENT_TYPE: ossa-agents
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - spec/**/*
      when: on_success
      allow_failure: true

# Native Build Agent
# ‚úÖ FIXED: Added proper rules with when clause and allow_failure at rule level
native:build:agent:
  stage: build
  trigger:
    project: ${AGENT_PLATFORM_PROJECT}
    strategy: depend
  variables:
    AGENT_NAME: native-local
    AGENT_TASK: build-native
    PLATFORM: multi
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
      allow_failure: true

# ============================================================================
# WEBHOOK-TRIGGERED AGENTS
# ============================================================================
# These agents are triggered by GitLab webhooks (issues, merge requests)
# Setup:
#   1. Create service account: https://gitlab.com/groups/blueflyio/-/settings/service_accounts
#   2. Add AGENT_SERVICE_TOKEN variable: https://gitlab.com/blueflyio/openstandardagents/-/settings/ci_cd
#   3. Create webhook: https://gitlab.com/blueflyio/openstandardagents/-/settings/integrations
#   4. Add WEBHOOK_SECRET variable

# MR Manager Agent - Triggered by webhook events
agent:mr-manager:
  stage: .pre
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build
  script:
    - |
      # Verify webhook authentication
      if [ "$CI_PIPELINE_SOURCE" != "trigger" ] && [ "$CI_PIPELINE_SOURCE" != "pipeline" ]; then
        echo "‚ÑπÔ∏è  Not triggered by webhook/trigger, skipping MR Manager"
        exit 0
      fi

      echo "ü§ñ MR Manager Agent Starting..."
      echo "   Pipeline Source: ${CI_PIPELINE_SOURCE}"
      echo "   Trigger: ${TRIGGER_EVENT_TYPE:-unknown}"

      # Use service account token for GitLab API calls
      export GITLAB_TOKEN="${AGENT_SERVICE_TOKEN}"

      # Check if manifest exists
      MANIFEST_PATH=".gitlab/agents/mr-manager/manifest.ossa.yaml"
      if [ -f "$MANIFEST_PATH" ]; then
        echo "üìã Running agent from: ${MANIFEST_PATH}"
        node dist/cli/index.js run "$MANIFEST_PATH" || echo "‚ö†Ô∏è  Agent completed with warnings"
      else
        echo "‚ö†Ô∏è  Agent manifest not found: ${MANIFEST_PATH}"
        echo "   Create the manifest or update MANIFEST_PATH"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
      when: on_success
    - if: $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_EVENT_TYPE
      when: on_success
  allow_failure: true

# Issue Triage Agent - Auto-labels and assigns issues
agent:issue-triage:
  stage: .pre
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --legacy-peer-deps
    - npm run build
  script:
    - |
      if [ "$CI_PIPELINE_SOURCE" != "trigger" ]; then
        echo "‚ÑπÔ∏è  Not triggered by webhook, skipping Issue Triage"
        exit 0
      fi

      if [ "$TRIGGER_EVENT_TYPE" != "issue" ]; then
        echo "‚ÑπÔ∏è  Not an issue event, skipping"
        exit 0
      fi

      echo "üè∑Ô∏è  Issue Triage Agent Starting..."
      export GITLAB_TOKEN="${AGENT_SERVICE_TOKEN}"

      MANIFEST_PATH=".gitlab/agents/issue-triage/manifest.ossa.yaml"
      if [ -f "$MANIFEST_PATH" ]; then
        node dist/cli/index.js run "$MANIFEST_PATH" || echo "‚ö†Ô∏è  Agent completed with warnings"
      else
        echo "‚ö†Ô∏è  Agent manifest not found: ${MANIFEST_PATH}"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger" && $TRIGGER_EVENT_TYPE == "issue"
      when: on_success
  allow_failure: true
