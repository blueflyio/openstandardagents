# GitLab CI: Reject any agent with hardcoded LLM models
# Enforces unified schema compliance

validate:no-hardcoded-models:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache grep findutils
  script:
    - |
      echo "üîç Checking for hardcoded LLM models..."
      
      VIOLATIONS=0
      
      # Find all agent files
      find . -type f \( -name "*.ossa.yaml" -o -name "agent.yaml" -o -name "agent.yml" \) | while read -r file; do
        # Check for hardcoded providers (without env var)
        if grep -E "^\s*provider:\s+(anthropic|openai|google|groq)" "$file" | grep -v '\${LLM_PROVIDER'; then
          echo "‚ùå VIOLATION: Hardcoded provider in $file"
          grep -n "provider:" "$file"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        
        # Check for hardcoded models (without env var)
        if grep -E "^\s*model:\s+(claude|gpt|gemini|llama)" "$file" | grep -v '\${LLM_MODEL'; then
          echo "‚ùå VIOLATION: Hardcoded model in $file"
          grep -n "model:" "$file"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        
        # Check for missing profile
        if ! grep -q "profile:" "$file"; then
          echo "‚ö†Ô∏è  WARNING: Missing execution profile in $file"
        fi
        
        # Check for missing runtime
        if ! grep -q "runtime:" "$file"; then
          echo "‚ö†Ô∏è  WARNING: Missing runtime declaration in $file"
        fi
      done
      
      if [ $VIOLATIONS -gt 0 ]; then
        echo ""
        echo "‚ùå Found $VIOLATIONS hardcoded model violations"
        echo "üìñ See: spec/v0.3.0/schemas/unified-llm.yaml"
        echo "üîß Run: scripts/migrate-to-unified-llm.sh"
        exit 1
      fi
      
      echo "‚úÖ No hardcoded models found"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "development"'
    - if: '$CI_COMMIT_BRANCH == "main"'
  allow_failure: false
