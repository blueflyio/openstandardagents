# =============================================================================
# Review Apps CI/CD Configuration
# =============================================================================
# Deploys dynamic review environments to OrbStack K8s using local runner.
#
# Requirements:
#   1. Self-hosted GitLab runner with tag "ossa" and K8s network access
#   2. CI/CD variable: KUBECONFIG_LOCAL (base64 encoded kubeconfig)
#   3. CI/CD variable: REVIEW_APPS_ENABLED=true
#   4. DNS: *.review.blueflyagents.com ‚Üí OrbStack ingress IP
#
# Flow:
#   Feature MR ‚Üí release/* : Creates review app at <MR_ID>.review.blueflyagents.com
#   Release MR ‚Üí main      : Creates staging at ossa-staging.review.blueflyagents.com
# =============================================================================

variables:
  REVIEW_NAMESPACE: ossa-review
  REVIEW_DOMAIN: "review.blueflyagents.com"

# =============================================================================
# REVIEW APP - Feature ‚Üí Release MRs (REQUIRES LOCAL RUNNER)
# =============================================================================
review:deploy:
  cache: {}  # Disable cache to avoid Docker networking issues
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - scheduler_failure
      - unknown_failure
  stage: deploy
  tags:
    - ossa  # Self-hosted runner with OrbStack K8s access
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  dependencies:
    - build:docker
  variables:
    GIT_STRATEGY: clone
  before_script:
    - |
      # Check if review apps are enabled
      if [ "$REVIEW_APPS_ENABLED" != "true" ]; then
        echo "‚ÑπÔ∏è  Review apps disabled (REVIEW_APPS_ENABLED != true)"
        echo "   Review apps require self-hosted runner with K8s access"
        exit 0
      fi

      # Install envsubst - detect package manager (bitnami/kubectl switched to Debian)
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache gettext curl ca-certificates
      elif command -v apt-get >/dev/null 2>&1; then
        apt-get update && apt-get install -y --no-install-recommends gettext-base curl ca-certificates
      else
        echo "‚ö†Ô∏è  No package manager found, envsubst may not be available"
      fi

      # Configure kubectl from CI variable (KUBECONFIG_LOCAL for OrbStack)
      if [ -n "$KUBECONFIG_LOCAL" ]; then
        mkdir -p ~/.kube
        if ! echo "$KUBECONFIG_LOCAL" | base64 -d > ~/.kube/config; then
          echo "‚ùå Failed to decode KUBECONFIG_LOCAL"
          exit 1
        fi
        chmod 600 ~/.kube/config
        echo "‚úÖ Kubectl configured from KUBECONFIG_LOCAL"
      else
        echo "‚ùå KUBECONFIG_LOCAL not set"
        echo "   To enable: Add KUBECONFIG_LOCAL CI/CD variable"
        exit 0
      fi

      # Verify kubectl connection
      if ! kubectl cluster-info >/dev/null 2>&1; then
        echo "‚ùå Cannot connect to Kubernetes cluster"
        exit 0
      fi

      # Set review app variables
      export REVIEW_APP_NAME="mr-${CI_MERGE_REQUEST_IID}"
      export REVIEW_APP_HOST="${CI_MERGE_REQUEST_IID}.${REVIEW_DOMAIN}"
      export REVIEW_APP_IMAGE="${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
      export NAMESPACE="${REVIEW_NAMESPACE}"

      echo "üì¶ Review App: ${REVIEW_APP_NAME}"
      echo "üåê URL: http://${REVIEW_APP_HOST}"
      echo "üê≥ Image: ${REVIEW_APP_IMAGE}"
  script:
    - |
      # Skip if kubectl not configured
      if [ ! -f ~/.kube/config ]; then
        echo "Skipping - kubectl not configured"
        exit 0
      fi

      # Create namespace if not exists
      kubectl create namespace "${NAMESPACE}" --dry-run=client -o yaml | kubectl apply -f -

      # Create registry secret if not exists
      kubectl create secret docker-registry gitlab-registry \
        --namespace="${NAMESPACE}" \
        --docker-server="${CI_REGISTRY}" \
        --docker-username="${CI_REGISTRY_USER}" \
        --docker-password="${CI_REGISTRY_PASSWORD}" \
        --dry-run=client -o yaml | kubectl apply -f - || \
      kubectl patch secret gitlab-registry -n "${NAMESPACE}" \
        --type='merge' -p="{\"data\":{\".dockerconfigjson\":\"$(echo -n "{\"auths\":{\"${CI_REGISTRY}\":{\"username\":\"${CI_REGISTRY_USER}\",\"password\":\"${CI_REGISTRY_PASSWORD}\"}}}" | base64 -w 0)\"}}"

      # Deploy review app (skip validation if cluster unreachable)
      envsubst < .gitlab/k8s/review-app.yaml | kubectl apply -f - --validate=false || {
        echo "‚ö†Ô∏è  Deployment failed - cluster may be unreachable"
        echo "   This is expected if KUBECONFIG_LOCAL points to local OrbStack"
        echo "   Review apps require local cluster access from GitLab runners"
        exit 0
      }

      # Wait for rollout (allow failure if cluster unreachable)
      kubectl rollout status deployment/"${REVIEW_APP_NAME}" -n "${NAMESPACE}" --timeout=120s || {
        echo "‚ö†Ô∏è  Rollout check failed - deployment may still be in progress"
        exit 0
      }

      echo ""
      echo "=============================================="
      echo "‚úÖ Review App Deployed!"
      echo "=============================================="
      echo "üåê URL: http://${REVIEW_APP_HOST}"
      echo "üìã MR: !${CI_MERGE_REQUEST_IID}"
      echo "üîÑ Branch: ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}"
      echo "=============================================="
  environment:
    name: review/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}
    url: http://${CI_MERGE_REQUEST_IID}.review.blueflyagents.com
    on_stop: review:stop
    auto_stop_in: 1 week
    deployment_tier: development
  allow_failure: true
  rules:
    # Auto deploy when targeting release/* and review apps enabled
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^release\// && $REVIEW_APPS_ENABLED == "true"
      when: on_success

# Stop review app when MR is closed/merged
review:stop:
  cache: {}  # Disable cache to avoid Docker networking issues
  retry:
    max: 2
    when:
      - runner_system_failure
      - unknown_failure
  stage: deploy
  tags:
    - ossa
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  variables:
    GIT_STRATEGY: none
  before_script:
    - |
      if [ -n "$KUBECONFIG_LOCAL" ]; then
        mkdir -p ~/.kube
        if ! echo "$KUBECONFIG_LOCAL" | base64 -d > ~/.kube/config; then
          echo "Failed to decode KUBECONFIG_LOCAL"
          exit 1
        fi
        chmod 600 ~/.kube/config
      fi
  script:
    - |
      if [ ! -f ~/.kube/config ]; then
        echo "Skipping - kubectl not configured"
        exit 0
      fi

      REVIEW_APP_NAME="mr-${CI_MERGE_REQUEST_IID}"
      echo "üßπ Stopping review app: ${REVIEW_APP_NAME}"

      kubectl delete deployment "${REVIEW_APP_NAME}" -n "${REVIEW_NAMESPACE}" --ignore-not-found=true
      kubectl delete service "${REVIEW_APP_NAME}" -n "${REVIEW_NAMESPACE}" --ignore-not-found=true
      kubectl delete ingress "${REVIEW_APP_NAME}" -n "${REVIEW_NAMESPACE}" --ignore-not-found=true

      echo "‚úÖ Review app stopped"
  environment:
    name: review/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}
    action: stop
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^release\// && $REVIEW_APPS_ENABLED == "true"
      when: manual

# =============================================================================
# STAGING - Release ‚Üí Main MRs
# =============================================================================
# Deploys staging preview when release branch merges to main
staging:deploy:
  cache: {}  # Disable cache to avoid Docker networking issues
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - scheduler_failure
      - unknown_failure
  stage: deploy
  tags:
    - ossa  # Self-hosted runner with OrbStack K8s access
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  dependencies:
    - build:docker
  variables:
    GIT_STRATEGY: clone
  before_script:
    - |
      # Install envsubst - detect package manager (bitnami/kubectl switched to Debian)
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache gettext ca-certificates
      elif command -v apt-get >/dev/null 2>&1; then
        apt-get update && apt-get install -y --no-install-recommends gettext-base curl ca-certificates
      fi

      # Configure kubectl from CI variable (KUBECONFIG_LOCAL for OrbStack)
      if [ -n "$KUBECONFIG_LOCAL" ]; then
        mkdir -p ~/.kube
        echo "$KUBECONFIG_LOCAL" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        echo "‚úÖ Kubectl configured from KUBECONFIG_LOCAL"
      else
        echo "‚ö†Ô∏è  KUBECONFIG_LOCAL not set - skipping K8s deployment"
        exit 0
      fi

      # Verify kubectl connection
      if ! kubectl cluster-info >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Cannot connect to Kubernetes cluster"
        exit 0
      fi

      # Set staging app variables
      export REVIEW_APP_NAME="ossa-staging"
      export REVIEW_APP_HOST="ossa-staging.${REVIEW_DOMAIN}"
      export REVIEW_APP_IMAGE="${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
      export NAMESPACE="${REVIEW_NAMESPACE}"

      echo "üì¶ Staging App: ${REVIEW_APP_NAME}"
      echo "üåê URL: http://${REVIEW_APP_HOST}"
  script:
    - |
      # Skip if kubectl not configured
      if [ ! -f ~/.kube/config ]; then
        echo "Skipping - kubectl not configured"
        exit 0
      fi

      # Create namespace if not exists
      kubectl create namespace "${NAMESPACE}" --dry-run=client -o yaml | kubectl apply -f -

      # Create registry secret
      kubectl create secret docker-registry gitlab-registry \
        --namespace="${NAMESPACE}" \
        --docker-server="${CI_REGISTRY}" \
        --docker-username="${CI_REGISTRY_USER}" \
        --docker-password="${CI_REGISTRY_PASSWORD}" \
        --dry-run=client -o yaml | kubectl apply -f -

      # Deploy staging
      envsubst < .gitlab/k8s/review-app.yaml | kubectl apply -f -

      # Wait for rollout
      kubectl rollout status deployment/"${REVIEW_APP_NAME}" -n "${NAMESPACE}" --timeout=120s

      echo ""
      echo "=============================================="
      echo "‚úÖ Staging Deployed!"
      echo "=============================================="
      echo "üåê URL: http://${REVIEW_APP_HOST}"
      echo "üìã MR: !${CI_MERGE_REQUEST_IID}"
      echo "üîÑ Source: ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}"
      echo "=============================================="
  environment:
    name: staging
    url: http://ossa-staging.review.blueflyagents.com
    deployment_tier: staging
  allow_failure: true
  rules:
    # Auto deploy release ‚Üí main MRs when review apps enabled
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release\// && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" && $REVIEW_APPS_ENABLED == "true"
      when: on_success

# =============================================================================
# PRODUCTION - Defined in main .gitlab-ci.yml as "pages" job
# =============================================================================
# The production deployment uses the special "pages" job name in .gitlab-ci.yml
# which triggers GitLab Pages when manually clicked on main branch
