# ============================================================================
# Autonomous Integration Jobs
# ============================================================================
# Integration jobs that connect all autonomous systems
# ============================================================================

variables:
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}

# ============================================================================
# AUTONOMOUS COORDINATOR
# ============================================================================

autonomous:coordinator:
  stage: .pre
  image: node:22-alpine
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - if: $AUTONOMOUS_MODE == "enabled"
      when: always
  variables:
    AGENT_NAME: task-dispatcher
    SERVICE_ACCOUNT: @task-dispatcher
    AGENT_TOKEN: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Autonomous Framework Coordinator"
      echo "================================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/${AGENT_NAME}/invoke" \
        -H "Authorization: Bearer ${AGENT_TOKEN}" \
        -H "X-Service-Account: ${SERVICE_ACCOUNT}" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"coordinate-autonomous-tasks\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"orchestrate\": true,
            \"prioritize\": true,
            \"create_workflow\": true
          }
        }" | jq '.'
  allow_failure: false

# ============================================================================
# AUTONOMOUS HEALTH MONITOR
# ============================================================================

autonomous:health-monitor:
  stage: .post
  image: node:22-alpine
  needs: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
  variables:
    AGENT_NAME: task-dispatcher
    SERVICE_ACCOUNT: @task-dispatcher
    AGENT_TOKEN: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Autonomous Health Monitor"
      echo "========================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/${AGENT_NAME}/invoke" \
        -H "Authorization: Bearer ${AGENT_TOKEN}" \
        -H "X-Service-Account: ${SERVICE_ACCOUNT}" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"health-check\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"check_agents\": true,
            \"check_pipelines\": true,
            \"check_issues\": true,
            \"create_issues\": true
          }
        }" | jq '.'
  allow_failure: true
