# Self-Healing CI Jobs
# Automatic recovery and health monitoring

monitor:runner-health:
  stage: monitor
  image: bitnami/kubectl:latest
  script:
    - |
      echo "Monitoring runner health..."
      kubectl get pods -n gitlab-runner -l app=gitlab-runner
      
      # Check for unhealthy pods
      UNHEALTHY=$(kubectl get pods -n gitlab-runner -l app=gitlab-runner \
        -o jsonpath='{.items[?(@.status.phase!="Running")].metadata.name}')
      
      if [ -n "$UNHEALTHY" ]; then
        echo "Unhealthy pods detected: $UNHEALTHY"
        for pod in $UNHEALTHY; do
          echo "Restarting pod: $pod"
          kubectl delete pod $pod -n gitlab-runner --grace-period=0 || true
        done
      else
        echo "All runners healthy"
      fi
      
      # Check restart counts
      kubectl get pods -n gitlab-runner -l app=gitlab-runner \
        -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.containerStatuses[0].restartCount}{"\n"}{end}' | \
        while read pod restarts; do
          if [ "$restarts" -gt 5 ]; then
            echo "Pod $pod has $restarts restarts - may need attention"
          fi
        done
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - if: $MONITOR_RUNNERS == "true"
      when: manual
  allow_failure: true

heal:runner-failures:
  stage: monitor
  image: bitnami/kubectl:latest
  script:
    - |
      echo "Self-healing runner failures..."
      
      # Get all runner pods
      PODS=$(kubectl get pods -n gitlab-runner -l app=gitlab-runner -o json)
      
      # Check each pod
      echo "$PODS" | jq -r '.items[] | select(.status.phase != "Running" or (.status.containerStatuses[0].restartCount // 0) > 5) | .metadata.name' | \
        while read pod; do
          echo "Healing pod: $pod"
          
          # Get pod status
          STATUS=$(kubectl get pod $pod -n gitlab-runner -o jsonpath='{.status.phase}')
          RESTARTS=$(kubectl get pod $pod -n gitlab-runner -o jsonpath='{.status.containerStatuses[0].restartCount}')
          
          echo "  Status: $STATUS, Restarts: $RESTARTS"
          
          # Delete unhealthy pod (deployment will recreate)
          kubectl delete pod $pod -n gitlab-runner --grace-period=0 --force || true
          
          echo "  Pod deleted, waiting for recreation..."
          sleep 10
        done
      
      # Verify deployment is healthy
      kubectl wait --for=condition=available --timeout=60s \
        deployment/gitlab-runner-autoscaler -n gitlab-runner || {
        echo "Deployment not healthy after healing attempt"
        exit 1
      }
      
      echo "Self-healing complete"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - if: $HEAL_RUNNERS == "true"
      when: manual
  allow_failure: true
