# =============================================================================
# OSSA Auto-Migration Component
# =============================================================================
# Usage: Include in your .gitlab-ci.yml to enable automated agent migrations
#
# Features:
# - Manual migration trigger for batch upgrades
# - Automatic validation on agent changes
# - Dry-run mode for preview
# - JSON report generation
#
# Requirements:
# - npm package.json with ossa-dev CLI available
# - .version.json file in project root
# =============================================================================

# Base configuration for all migration jobs
.ossa-migrate-base:
  image: node:${NODE_VERSION:-22}-alpine
  tags:
    - self-hosted
    - docker
    - linux
  before_script:
    - echo "Installing dependencies..."
    - npm ci --prefer-offline --no-audit
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/
    policy: pull

# =============================================================================
# Manual Migration Job
# =============================================================================
# Trigger: Manual via GitLab UI
# Purpose: Batch upgrade all agent manifests to target version
#
# Variables:
# - TARGET_VERSION: Target OSSA version (default: latest from .version.json)
# - AGENT_DIR: Directory to search for agents (default: ./agents)
# - DRY_RUN: Preview mode without writing files (default: true)
# =============================================================================

ossa:migrate-batch:
  extends: .ossa-migrate-base
  stage: validate
  variables:
    TARGET_VERSION: ""  # Empty = use .version.json current
    AGENT_DIR: "./agents"
    DRY_RUN: "true"
  script:
    # Show current state
    - echo "OSSA Auto-Migration"
    - echo "==================="
    - |
      if [ -f ".version.json" ]; then
        echo "Current version from .version.json:"
        cat .version.json | grep -E '"current"|"latest_stable"'
      else
        echo "ERROR: .version.json not found"
        exit 1
      fi

    # Determine target version
    - |
      if [ -z "$TARGET_VERSION" ]; then
        TARGET_VERSION=$(node -e "console.log(require('./.version.json').current)")
        echo "Using current version from .version.json: $TARGET_VERSION"
      else
        echo "Using specified target version: $TARGET_VERSION"
      fi

    # Run migration
    - echo ""
    - echo "Running migration..."
    - |
      if [ "$DRY_RUN" = "true" ]; then
        echo "DRY RUN MODE - No files will be modified"
        npx tsx src/dev-cli/src/index.ts migrate agents --version "$TARGET_VERSION" --dry-run --paths "$AGENT_DIR"
      else
        echo "LIVE MODE - Files will be updated"
        npx tsx src/dev-cli/src/index.ts migrate agents --version "$TARGET_VERSION" --paths "$AGENT_DIR"
      fi

    # Generate summary (on success or partial success)
    - |
      echo ""
      echo "Migration complete!"
      echo "Review the output above for details."

  artifacts:
    when: always
    expire_in: 30 days
    reports:
      dotenv: migration-report.env
    paths:
      - migration-report.json

  rules:
    # Manual trigger on any branch
    - when: manual
      allow_failure: true

# =============================================================================
# Automatic Validation Job
# =============================================================================
# Trigger: Automatic on agent file changes
# Purpose: Validate agent manifests are at current version
#
# This job runs automatically when .ossa.* files change and checks if any
# agents need migration. It fails if agents are outdated, prompting manual
# migration via ossa:migrate-batch.
# =============================================================================

ossa:validate-versions:
  extends: .ossa-migrate-base
  stage: validate
  script:
    - echo "Validating OSSA agent versions..."
    - |
      TARGET_VERSION=$(node -e "console.log(require('./.version.json').current)")
      echo "Current version: $TARGET_VERSION"

    # Run migration in dry-run mode to check for outdated agents
    - |
      echo ""
      echo "Checking for agents needing migration..."
      npx tsx src/dev-cli/src/index.ts migrate agents --dry-run --paths ./agents .gitlab .ossa examples spec 2>&1 | tee validation.log

      # Check if any agents need upgrading
      if grep -q "Upgraded: 0" validation.log; then
        echo ""
        echo "✅ All agents are at current version ($TARGET_VERSION)"
        exit 0
      else
        echo ""
        echo "⚠️  Some agents need migration to version $TARGET_VERSION"
        echo "Run the 'ossa:migrate-batch' job manually to upgrade agents."
        exit 1
      fi

  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - validation.log

  rules:
    # Run on MR when agent files change
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
        - "**/*.ossa.json"
        - ".version.json"
    # Run on release branches when agent files change
    - if: $CI_COMMIT_BRANCH =~ /^release\//
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
        - "**/*.ossa.json"
        - ".version.json"

# =============================================================================
# USAGE EXAMPLES
# =============================================================================
#
# 1. Manual Migration (Dry Run):
#    - Go to CI/CD > Pipelines
#    - Click "Run Pipeline"
#    - Click "ossa:migrate-batch" job
#    - Leave DRY_RUN=true to preview changes
#
# 2. Manual Migration (Live):
#    - Go to CI/CD > Pipelines
#    - Click "Run Pipeline"
#    - Set variable: DRY_RUN=false
#    - Click "ossa:migrate-batch" job
#    - Review changes and commit via MR
#
# 3. Custom Target Version:
#    - Set variable: TARGET_VERSION=0.3.5
#    - Set variable: DRY_RUN=false
#    - Run "ossa:migrate-batch" job
#
# 4. Custom Search Path:
#    - Set variable: AGENT_DIR=./my-agents
#    - Run "ossa:migrate-batch" job
#
# =============================================================================
