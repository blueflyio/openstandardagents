# ============================================================================
# Autonomous MR Management
# ============================================================================
# Fully autonomous MR lifecycle management
# ============================================================================

variables:
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}

# ============================================================================
# AUTO-REBASE OPEN MRS
# ============================================================================

autonomous:auto-rebase-mrs:
  stage: validate
  image: node:22-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
  variables:
    AGENT_NAME: mr-reviewer
    SERVICE_ACCOUNT: "@mr-reviewer"
    AGENT_TOKEN: ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Autonomous MR Auto-Rebase"
      echo "========================"
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/${AGENT_NAME}/invoke" \
        -H "Authorization: Bearer ${AGENT_TOKEN}" \
        -H "X-Service-Account: ${SERVICE_ACCOUNT}" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"auto-rebase-all\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"target_branch\": \"release/v0.3.x\",
            \"auto_resolve_conflicts\": false,
            \"create_issues\": true
          }
        }" | jq '.'
  allow_failure: true

# ============================================================================
# AUTO-APPROVE SAFE MRS
# ============================================================================

autonomous:auto-approve-safe:
  stage: validate
  image: node:22-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
  variables:
    AGENT_NAME: mr-reviewer
    SERVICE_ACCOUNT: "@mr-reviewer"
    AGENT_TOKEN: ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Autonomous MR Auto-Approval (Safe Only)"
      echo "======================================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/${AGENT_NAME}/invoke" \
        -H "Authorization: Bearer ${AGENT_TOKEN}" \
        -H "X-Service-Account: ${SERVICE_ACCOUNT}" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"auto-approve-safe\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"safety_criteria\": {
              \"all_tests_pass\": true,
              \"no_breaking_changes\": true,
              \"code_quality_score\": 90,
              \"security_scan_clean\": true
            },
            \"auto_merge\": false
          }
        }" | jq '.'
  allow_failure: false

# ============================================================================
# AUTO-CLOSE STALE MRS
# ============================================================================

autonomous:close-stale-mrs:
  stage: .post
  image: node:22-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
  variables:
    AGENT_NAME: mr-reviewer
    SERVICE_ACCOUNT: "@mr-reviewer"
    AGENT_TOKEN: ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Autonomous Stale MR Management"
      echo "=============================="
      
      curl -X POST \
        "${PLATFORM_AGENTS_API}/agents/${AGENT_NAME}/invoke" \
        -H "Authorization: Bearer ${AGENT_TOKEN}" \
        -H "X-Service-Account: ${SERVICE_ACCOUNT}" \
        -H "Content-Type: application/json" \
        -d "{
          \"task\": \"manage-stale-mrs\",
          \"inputs\": {
            \"project_id\": ${CI_PROJECT_ID},
            \"stale_days\": 30,
            \"auto_close\": true,
            \"notify_authors\": true,
            \"create_issues\": true
          }
        }" | jq '.'
  allow_failure: true
