# Branch Policy Enforcement
# Ensures main branch only receives merges from release branches

validate:branch-policy:
  stage: validate
  image: alpine:latest
  script:
    - |
      #!/bin/sh
      set -e

      echo "üîí BRANCH POLICY ENFORCEMENT"
      echo "============================"
      echo ""

      # Only run on merge requests targeting main
      if [ "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" != "main" ]; then
        echo "‚úÖ Not targeting main branch, policy check skipped"
        exit 0
      fi

      echo "Target branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
      echo "Source branch: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
      echo ""

      # Check if source branch is a release branch
      if [[ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" =~ ^release/ ]]; then
        echo "‚úÖ ALLOWED: Merge from release branch ‚Üí main"
        exit 0
      fi

      # Block all other merges to main
      echo "‚ùå BLOCKED: Direct merges to main are not allowed"
      echo ""
      echo "Policy: main branch only accepts merges from release/* branches"
      echo ""
      echo "Required workflow:"
      echo "  1. Create feature branch from release/*"
      echo "  2. Merge feature ‚Üí release/*"
      echo "  3. Merge release/* ‚Üí main"
      echo ""
      echo "Your branch: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
      echo "Please merge to a release branch first, then create MR from release branch to main"
      
      exit 1
  allow_failure: false
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: always
