# =============================================================================
# Scheduled Sync Pipeline
# Runs every 6 hours to check for OSSA spec updates
# =============================================================================

sync:scheduled:
  stage: sync
  image: node:20-alpine
  variables:
    NODE_ENV: development
    GIT_STRATEGY: clone
  before_script:
    - apk add --no-cache git curl jq
    - git config user.email "ci@blueflyio.com"
    - git config user.name "GitLab CI Bot"
    - cd website
    - npm ci --prefer-offline --no-audit
  script:
    - echo "üîÑ Checking for OSSA updates..."
    - |
      # Get current version from package.json
      CURRENT_VERSION=$(node -p "require('./package.json').dependencies['@bluefly/ossa']")
      echo "Current OSSA version: $CURRENT_VERSION"
      
      # Get latest version from npm
      LATEST_VERSION=$(npm view @bluefly/ossa version)
      echo "Latest OSSA version: $LATEST_VERSION"
      
      if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
        echo "üì¶ New version detected: $LATEST_VERSION"
        npm install @bluefly/ossa@latest
      fi
    - npm run fetch-spec
    - npm run fetch-versions
    - npm run sync-version
    - npm run fetch-examples
    - npm run sync-wiki
    - |
      if [ -n "$(git status --porcelain)" ]; then
        echo "üìù Changes detected, creating MR..."
        BRANCH="chore/auto-sync-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$BRANCH"
        git add -A
        git commit -m "chore(ci): auto-sync OSSA spec to v${LATEST_VERSION}

Automated sync triggered by scheduled pipeline.

- Updated OSSA spec from npm package
- Synced versions and examples
- Updated wiki documentation

[skip ci]"
        git push https://oauth2:${CI_JOB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git HEAD:"$BRANCH"
        
        # Create MR using GitLab API
        curl --request POST \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "{
            \"source_branch\": \"$BRANCH\",
            \"target_branch\": \"release/v0.3.0\",
            \"title\": \"chore(ci): auto-sync OSSA spec to v${LATEST_VERSION}\",
            \"description\": \"Automated sync of OSSA specification and documentation.\n\n- Updated to @bluefly/ossa@${LATEST_VERSION}\n- Synced examples and wiki\n\nTriggered by scheduled pipeline.\",
            \"remove_source_branch\": true
          }" \
          "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/merge_requests"
        
        echo "‚úÖ MR created for review"
      else
        echo "‚úÖ Already up to date"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: false
