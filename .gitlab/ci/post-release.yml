# ============================================================================
# POST-RELEASE CLEANUP
# ============================================================================
# After successful release:
# 1. Tag all issues with released::v{VERSION}
# 2. Tag all MRs with released::v{VERSION}
# 3. Create next milestone (patch increment)

post-release:cleanup:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
    - apk add --no-cache curl jq bash
  script:
    - |
      #!/bin/bash
      set -euo pipefail
      echo "ðŸ§¹ POST-RELEASE CLEANUP"
      echo "======================="

      # Check if release just happened
      if [ -z "$RELEASE_VERSION" ] || [ -z "$MILESTONE_ID" ]; then
        echo "INFO: No release detected - skipping cleanup"
        exit 0
      fi

      VERSION="${RELEASE_VERSION}"
      LABEL_NAME="released::v${VERSION}"

      echo "ðŸ“Œ Version: v${VERSION}"
      echo "ðŸ“Œ Milestone: ${MILESTONE_TITLE}"
      echo ""

      # 1. Create release label if not exists
      echo "Creating label: ${LABEL_NAME}"
      curl --request POST \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        --data "name=${LABEL_NAME}&color=#00FF00&description=Released in v${VERSION}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/labels" 2>/dev/null || echo "Label may already exist"

      # 2. Tag all closed issues in milestone
      echo ""
      echo "ðŸ“Œ Tagging issues..."
      ISSUES=$(curl -sS --max-time 30 -G \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues" \
        --data-urlencode "milestone=${MILESTONE_TITLE}" \
        --data-urlencode "state=closed" \
        --data-urlencode "per_page=100")

      echo "$ISSUES" | jq -r '.[].iid' | while read ISSUE_IID; do
        [ -z "$ISSUE_IID" ] && continue
        curl -sS --max-time 30 --request PUT \
          --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
          --data "add_labels=${LABEL_NAME}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues/${ISSUE_IID}" > /dev/null
        echo " âœ“ Tagged issue #${ISSUE_IID}"
      done

      # 3. Tag all merged MRs in milestone
      echo ""
      echo "ðŸ“Œ Tagging merge requests..."
      MRS=$(curl -sS --max-time 30 -G \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests" \
        --data-urlencode "milestone=${MILESTONE_TITLE}" \
        --data-urlencode "state=merged" \
        --data-urlencode "per_page=100")

      echo "$MRS" | jq -r '.[].iid' | while read MR_IID; do
        [ -z "$MR_IID" ] && continue
        curl -sS --max-time 30 --request PUT \
          --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
          --data "add_labels=${LABEL_NAME}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${MR_IID}" > /dev/null
        echo " âœ“ Tagged MR !${MR_IID}"
      done

      # 4. Create next milestone (patch increment)
      echo ""
      echo "ðŸ“… Creating next milestone..."
      NEXT_VERSION=$(echo "$VERSION" | awk -F. '{print $1"."$2"."$3+1}')

      NEXT_MILESTONE=$(curl -sS --max-time 30 --request POST \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{
          \"title\": \"v${NEXT_VERSION}\",
          \"description\": \"Next patch release (auto-created after v${VERSION})\"
        }" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/milestones" 2>/dev/null)

      NEXT_ID=$(echo "$NEXT_MILESTONE" | jq -r '.id // empty')
      if [ -n "$NEXT_ID" ]; then
        echo " âœ“ Created milestone v${NEXT_VERSION}"
      else
        echo " WARNING:  Milestone v${NEXT_VERSION} may already exist"
      fi

      echo ""
      echo "POST-RELEASE CLEANUP COMPLETE"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $MILESTONE_READY == "true" && $ENABLE_RELEASE == "true"
      when: on_success
  needs:
    - job: release:publish-npm
      optional: true
    - job: detect:milestone-and-tags
      optional: true
  allow_failure: true

# ============================================================================
# WORKFLOW - MERGE TRAINS ENABLED
# ============================================================================
# Merge trains prevent branch divergence by:
# 1. Queuing MRs instead of racing to merge
# 2. Testing merged state before allowing merge
# 3. Auto-rebasing when target branch updates
# 4. Failing fast on conflicts
#
# Enabled for: development, main branches
# Eliminates: Manual sync commits between releases
# See: https://docs.gitlab.com/ee/ci/pipelines/merge_trains.html
# ============================================================================

workflow:
  rules:
    # Merge train pipelines (combined state testing)
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "merge_train"
    # Merged result pipelines (pre-merge validation)
    - if: $CI_MERGE_REQUEST_EVENT_TYPE == "merged_result"
    # Regular MR pipelines
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Regular branch pipelines
    - if: $CI_COMMIT_BRANCH
    # Tag pipelines
    - if: $CI_COMMIT_TAG
    # Scheduled and webhook pipelines
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "trigger"

# ============================================================================
# RELEASE AUTOMATION - Enterprise Grade
# ============================================================================

# Auto-increment dev tag on merge to release branches
increment-dev-tag:
  stage: .post
  needs: []  # Run independently - don't wait for manual jobs
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache curl jq
    - npm ci
    - npm install -g tsx
  script:
    - tsx src/services/release-automation/increment-dev-tag.ts
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\/v/ && $CI_PIPELINE_SOURCE == "push"
      when: on_success
  allow_failure: true

# Manual release buttons (main branch only)
# Button 1: Publish to npmjs
release:publish-npm:
  stage: release
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache curl jq git
    - npm ci --prefer-offline --no-audit
  script:
    - RELEASE_ACTION=npm tsx src/services/release-automation/release-buttons.ts
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: npmjs/production
    url: https://www.npmjs.com/package/@bluefly/openstandardagents
  variables:
    NPM_TOKEN: $NPM_TOKEN

release-to-github:
  stage: release
  image: node:${NODE_VERSION}-alpine
  needs: [release:publish-npm]
  before_script:
    - apk add --no-cache curl jq
    - npm ci
  script:
    - RELEASE_ACTION=github tsx src/services/release-automation/release-buttons.ts
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
# Website deployment moved to openstandardagents.org repository
# See: https://gitlab.com/blueflyio/ossa/openstandardagents.org

announce-release:
  stage: .post
  image: node:${NODE_VERSION}-alpine
  needs: [release-to-github]
  optional: true
  before_script:
    - apk add --no-cache curl jq
    - npm ci
  script:
    - RELEASE_ACTION=announce tsx src/services/release-automation/release-buttons.ts
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
