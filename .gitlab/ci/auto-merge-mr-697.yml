# ============================================================================
# Auto-merge MR #697 into release/v0.3.x
# ============================================================================
# One-time job to merge the autonomous framework MR
# ============================================================================

merge:mr-697:
  stage: .pre
  image: alpine:latest
  needs: []
  rules:
    - if: $AUTO_MERGE_MR_697 == "true"
      when: always
    - when: manual
      allow_failure: false
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Auto-merging MR #697 into release/v0.3.x"
      echo "=========================================="
      echo ""
      
      TOKEN="${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN:-${GITLAB_TOKEN}}"
      PROJECT_ID="${CI_PROJECT_ID}"
      GITLAB_URL="${CI_SERVER_URL:-https://gitlab.com}"
      
      if [ -z "$TOKEN" ]; then
        echo "ERROR: No token available"
        exit 1
      fi
      
      # Update target branch if needed
      echo "Checking MR target branch..."
      MR_INFO=$(curl -s -X GET \
        "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/merge_requests/697" \
        -H "PRIVATE-TOKEN: ${TOKEN}")
      
      CURRENT_TARGET=$(echo "$MR_INFO" | jq -r '.target_branch')
      STATE=$(echo "$MR_INFO" | jq -r '.state')
      
      echo "Current target: ${CURRENT_TARGET}"
      echo "Current state: ${STATE}"
      
      if [ "$STATE" = "merged" ]; then
        echo "MR is already merged"
        exit 0
      fi
      
      # Update target branch if not release/v0.3.x
      if [ "$CURRENT_TARGET" != "release/v0.3.x" ]; then
        echo "Updating target branch to release/v0.3.x..."
        curl -X PUT \
          "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/merge_requests/697" \
          -H "PRIVATE-TOKEN: ${TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{\"target_branch\": \"release/v0.3.x\"}" | jq -r '.target_branch // .message'
      fi
      
      # Wait for pipeline to complete
      echo ""
      echo "Waiting for MR to be mergeable..."
      sleep 10
      
      # Check merge status
      MR_INFO=$(curl -s -X GET \
        "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/merge_requests/697" \
        -H "PRIVATE-TOKEN: ${TOKEN}")
      
      MERGE_STATUS=$(echo "$MR_INFO" | jq -r '.merge_status')
      HAS_CONFLICTS=$(echo "$MR_INFO" | jq -r '.has_conflicts')
      
      echo "Merge status: ${MERGE_STATUS}"
      echo "Has conflicts: ${HAS_CONFLICTS}"
      
      if [ "$MERGE_STATUS" = "can_be_merged" ] && [ "$HAS_CONFLICTS" = "false" ]; then
        echo ""
        echo "Merging MR #697..."
        MERGE_RESULT=$(curl -s -X PUT \
          "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/merge_requests/697/merge" \
          -H "PRIVATE-TOKEN: ${TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{
            \"merge_commit_message\": \"Merge autonomous framework implementation into release/v0.3.x\n\n- Complete autonomous framework with GitLab Duo flows\n- Automatic setup and activation jobs\n- All using existing OSSA-certified agents\n\nRefs: #102\"
          }")
        
        MERGED_STATE=$(echo "$MERGE_RESULT" | jq -r '.state')
        MERGE_SHA=$(echo "$MERGE_RESULT" | jq -r '.merge_commit_sha // .sha')
        
        if [ "$MERGED_STATE" = "merged" ]; then
          echo "MR merged successfully!"
          echo "Merge commit: ${MERGE_SHA}"
        else
          echo "Merge result: ${MERGE_RESULT}"
          exit 1
        fi
      else
        echo "MR cannot be merged - status: ${MERGE_STATUS}, conflicts: ${HAS_CONFLICTS}"
        exit 1
      fi
  allow_failure: false
