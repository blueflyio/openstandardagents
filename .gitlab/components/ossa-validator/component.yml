# OSSA OpenAPI Validator GitLab Component
# Centralizes OpenAPI validation across all LLM platform projects

spec:
  inputs:
    # Project configuration
    project_name:
      type: string
      description: Name of the project being validated
      default: $[[ inputs.project_name || CI_PROJECT_NAME ]]

    # Validation options
    spec_paths:
      type: array
      description: Array of OpenAPI spec file paths to validate
      default: ['src/api/*.yml', 'src/api/*.yaml', 'openapi/*.yml']

    ossa_version:
      type: string
      description: OSSA version to validate against
      default: '0.1.9'

    conformance_tier:
      type: string
      description: Required OSSA conformance tier
      default: 'core'
      enum: ['core', 'governed', 'advanced', 'enterprise']

    # Validation strictness
    fail_on_warnings:
      type: boolean
      description: Fail pipeline on validation warnings
      default: false

    require_agent_metadata:
      type: boolean
      description: Require agent-specific metadata
      default: true

    enforce_security_schemes:
      type: boolean
      description: Enforce security scheme validation
      default: true

    validate_examples:
      type: boolean
      description: Validate request/response examples
      default: true

    # Output options
    generate_report:
      type: boolean
      description: Generate detailed validation report
      default: true

    report_format:
      type: string
      description: Report output format
      default: 'markdown'
      enum: ['markdown', 'json', 'junit']

---
ossa:validate:
  stage: validate
  image: node:18-alpine

  variables:
    OSSA_VERSION: $[[ inputs.ossa_version ]]
    CONFORMANCE_TIER: $[[ inputs.conformance_tier ]]
    PROJECT_NAME: $[[ inputs.project_name ]]

  before_script:
    # Install OSSA CLI and dependencies
    - npm install -g @ossa/cli@latest
    - npm install -g js-yaml ajv ajv-formats

    # Verify OSSA CLI installation
    - ossa --version

    # Create reports directory
    - mkdir -p reports/ossa-validation

  script:
    # Find and validate all OpenAPI specifications
    - |
      echo "INFO: Discovering OpenAPI specifications..."
      SPECS_FOUND=0

      for pattern in $[[ inputs.spec_paths | join(' ') ]]; do
        for spec in $(find . -path "./node_modules" -prune -o -name "$pattern" -print 2>/dev/null); do
          if [ -f "$spec" ]; then
            echo "INFO: Found spec: $spec"
            SPECS_FOUND=$((SPECS_FOUND + 1))

            # Validate individual spec
            echo "INFO: Validating $spec..."

            ossa validate openapi "$spec" \
              --ossa-version "$OSSA_VERSION" \
              $[[ inputs.require_agent_metadata == false && '--no-agent-metadata' || '' ]] \
              $[[ inputs.enforce_security_schemes == false && '--no-security' || '' ]] \
              $[[ inputs.validate_examples == false && '--no-examples' || '' ]] \
              $[[ inputs.generate_report == true && '--output' || '' ]] \
              $[[ inputs.generate_report == true && "reports/ossa-validation/${spec//\//_}.md" || '' ]]

            # Check validation result
            if [ $? -eq 0 ]; then
              echo " $spec - OSSA compliant"
            else
              echo "ERROR: $spec - Validation failed"
              echo "VALIDATION_FAILED=true" >> validation.env
            fi
          fi
        done
      done

      if [ $SPECS_FOUND -eq 0 ]; then
        echo "WARNING: No OpenAPI specifications found"
        echo "Searched patterns: $[[ inputs.spec_paths | join(', ') ]]"
        exit 0
      fi

      echo "INFO: Validated $SPECS_FOUND specification(s)"

    # Project-wide validation
    - |
      echo "INFO: Running project-wide OSSA validation..."
      ossa validate project . \
        --config .ossa.config.yaml \
        $[[ inputs.generate_report == true && '--report reports/ossa-validation/project-compliance.md' || '' ]]

    # Generate summary report
    - |
      if [ "$[[ inputs.generate_report ]]" = "true" ]; then
        echo "INFO: Generating validation summary..."

        cat > reports/ossa-validation/summary.md << EOF
      # OSSA Validation Summary

      **Project:** $PROJECT_NAME
      **OSSA Version:** $OSSA_VERSION
      **Conformance Tier:** $CONFORMANCE_TIER
      **Validation Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

      ## Results

      EOF

        if [ -f validation.env ] && grep -q "VALIDATION_FAILED=true" validation.env; then
          echo "**Status:** ERROR: FAILED" >> reports/ossa-validation/summary.md
          echo "" >> reports/ossa-validation/summary.md
          echo "Some specifications failed OSSA compliance validation." >> reports/ossa-validation/summary.md
        else
          echo "**Status:**  PASSED" >> reports/ossa-validation/summary.md
          echo "" >> reports/ossa-validation/summary.md
          echo "All specifications are OSSA compliant!" >> reports/ossa-validation/summary.md
        fi

        echo "" >> reports/ossa-validation/summary.md
        echo "## Specifications Validated" >> reports/ossa-validation/summary.md
        echo "" >> reports/ossa-validation/summary.md

        find reports/ossa-validation -name "*.md" -not -name "summary.md" | while read report; do
          spec_name=$(basename "$report" .md)
          echo "- [$spec_name](./$spec_name.md)" >> reports/ossa-validation/summary.md
        done
      fi

    # Check for failures and exit appropriately
    - |
      if [ -f validation.env ] && grep -q "VALIDATION_FAILED=true" validation.env; then
        echo "ERROR: OSSA validation failed"
        exit 1
      else
        echo " OSSA validation passed"
      fi

  artifacts:
    when: always
    expire_in: 30 days
    reports:
      junit: reports/ossa-validation/junit.xml
    paths:
      - reports/ossa-validation/
    expose_as: 'OSSA Validation Report'

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Additional validation jobs for different scenarios

ossa:validate:strict:
  extends: ossa:validate
  variables:
    FAIL_ON_WARNINGS: 'true'
  script:
    - !reference [ossa:validate, script]
    - |
      # Additional strict validation
      echo "INFO: Running strict OSSA validation..."

      # Check for advanced OSSA features
      if [ "$CONFORMANCE_TIER" = "enterprise" ]; then
        ossa validate project . \
          --require-all-features \
          --enforce-enterprise-patterns \
          --validate-security-hardening
      fi

  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        CONFORMANCE_TIER: 'governed'
    - if: $CI_COMMIT_TAG
      variables:
        CONFORMANCE_TIER: 'enterprise'

ossa:validate:security:
  extends: ossa:validate
  variables:
    ENFORCE_SECURITY: 'true'
  script:
    - !reference [ossa:validate, script]
    - |
      # Security-focused validation
      echo "INFO: Running security-focused OSSA validation..."

      # Validate security schemes are properly implemented
      ossa validate security . \
        --require-authentication \
        --check-authorization \
        --validate-tls \
        --scan-vulnerabilities

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - '**/*.yml'
        - '**/*.yaml'
        - '**/security/**/*'
