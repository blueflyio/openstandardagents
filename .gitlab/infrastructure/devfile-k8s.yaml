schemaVersion: 2.2.0
metadata:
  name: ossa-development
  # Version is managed by package.json - run `npm run version:sync` to update
  description: OSSA development environment with GitLab agent access
components:
  - name: dev-tools
    container:
      image: node:22-alpine
      memoryLimit: 4Gi
      cpuLimit: 2000m
      mountSources: true
      env:
        - name: NODE_ENV
          value: development
        - name: KUBECONFIG
          value: /workspace/.kube/config
      volumeMounts:
        - name: kube-config
          path: /workspace/.kube
  
  - name: kubectl
    container:
      image: bitnami/kubectl:latest
      memoryLimit: 512Mi
      cpuLimit: 500m
      env:
        - name: KUBECONFIG
          value: /workspace/.kube/config
      volumeMounts:
        - name: kube-config
          path: /workspace/.kube

volumes:
  - name: kube-config
    ephemeral: true

commands:
  - id: install
    exec:
      component: dev-tools
      commandLine: npm ci --legacy-peer-deps
      workingDir: ${PROJECT_SOURCE}
  
  - id: build
    exec:
      component: dev-tools
      commandLine: npm run build
      workingDir: ${PROJECT_SOURCE}
  
  - id: test
    exec:
      component: dev-tools
      commandLine: npm test
      workingDir: ${PROJECT_SOURCE}
  
  - id: lint
    exec:
      component: dev-tools
      commandLine: npm run lint
      workingDir: ${PROJECT_SOURCE}
  
  - id: version-sync
    exec:
      component: dev-tools
      commandLine: npm run version:sync
      workingDir: ${PROJECT_SOURCE}
  
  - id: deploy-agents
    exec:
      component: kubectl
      commandLine: kubectl apply -f .gitlab/agents/
      workingDir: ${PROJECT_SOURCE}
  
  - id: get-pods
    exec:
      component: kubectl
      commandLine: kubectl get pods -n ossa-agents
  
  - id: agent-logs
    exec:
      component: kubectl
      commandLine: kubectl logs -n ossa-agents -l app=version-manager --tail=100 -f

events:
  postStart:
    - install
