# GitLab Duo Agent Platform - Flow Triggers
# https://docs.gitlab.com/user/duo_agent_platform/flows/
#
# Configures automatic Duo flow execution based on GitLab events

triggers:
  # Issue lifecycle automation
  issue_created:
    flow: issue-worker
    conditions:
      - labels: ["ready-for-dev", "duo-enabled"]
      - project_path: "blueflyio/ossa/openstandardagents"
    config:
      model: claude-sonnet-4-20250514
      max_iterations: 10

  issue_labeled:
    flow: issue-triage
    conditions:
      - labels: ["needs-triage"]
    config:
      auto_assign: true
      auto_milestone: true

  # MR automation
  mr_opened:
    flow: mr-reviewer
    conditions:
      - target_branch: ["development", "main"]
      - source_branch_regex: "^(feat|fix|chore|docs)/"
    config:
      model: claude-sonnet-4-20250514
      enforce_conventional_commits: true
      auto_label: true

  mr_updated:
    flow: mr-reviewer
    conditions:
      - target_branch: ["development", "main"]
      - has_conflicts: false
    config:
      review_changes_only: true

  # Pipeline failure handling
  pipeline_failed:
    flow: incident-response
    conditions:
      - retry_count: ">= 2"
      - branch: ["development", "main"]
    config:
      create_issue: true
      notify_channel: "gitlab-alerts"

  # OSSA validation on spec changes
  mr_opened:
    flow: ossa-validate
    conditions:
      - changed_files: ["spec/**", ".agents/**/*.yaml", ".gitlab/agents/**/*.yaml"]
    config:
      ossa_version: "0.2.9"
      strict_mode: true

# Default settings for all flows
defaults:
  model: claude-sonnet-4-20250514
  timeout_minutes: 30
  max_iterations: 20
  observability:
    enabled: true
    log_level: info
