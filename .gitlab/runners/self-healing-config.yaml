# OSSA Self-Healing Runner Configuration
# Automatic recovery, health monitoring, and resilience

apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-runner-self-healing
  namespace: gitlab-runner
data:
  health-check.sh: |
    #!/bin/sh
    # Health check script for GitLab runner
    if ! pgrep -f "gitlab-runner.*run" > /dev/null; then
      echo "Runner process not found"
      exit 1
    fi
    if ! curl -f http://localhost:8093/metrics > /dev/null 2>&1; then
      echo "Metrics endpoint not responding"
      exit 1
    fi
    exit 0

---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: gitlab-runner-pdb
  namespace: gitlab-runner
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: gitlab-runner
      component: autoscaler

---
apiVersion: v1
kind: Service
metadata:
  name: gitlab-runner-metrics
  namespace: gitlab-runner
  labels:
    app: gitlab-runner
spec:
  ports:
  - port: 8093
    targetPort: 8093
    name: metrics
  selector:
    app: gitlab-runner
    component: autoscaler

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: gitlab-runner
  namespace: gitlab-runner
spec:
  selector:
    matchLabels:
      app: gitlab-runner
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
