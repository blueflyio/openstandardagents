# Job Prioritization for OSSA Runners
# Priority queues, job scheduling, resource allocation

apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-priority-config
  namespace: gitlab-runner
data:
  priority-rules.json: |
    {
      "rules": [
        {
          "priority": "high",
          "tags": ["critical", "production", "hotfix"],
          "resources": {
            "cpu": "2",
            "memory": "4Gi"
          },
          "timeout": 3600
        },
        {
          "priority": "normal",
          "tags": ["default"],
          "resources": {
            "cpu": "1",
            "memory": "2Gi"
          },
          "timeout": 1800
        },
        {
          "priority": "low",
          "tags": ["low-priority", "background"],
          "resources": {
            "cpu": "500m",
            "memory": "1Gi"
          },
          "timeout": 3600
        }
      ],
      "scheduling": {
        "maxConcurrentHigh": 5,
        "maxConcurrentNormal": 10,
        "maxConcurrentLow": 5,
        "preemption": true
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-runner-config
  namespace: gitlab-runner
data:
  config.toml: |
    concurrent = 20
    check_interval = 0

    [session_server]
      session_timeout = 1800

    [[runners]]
      name = "ossa-high-priority"
      url = "https://gitlab.com/"
      token = "${GITLAB_RUNNER_TOKEN}"
      executor = "kubernetes"
      limit = 5
      [runners.kubernetes]
        namespace = "gitlab-runner"
        image = "node:22-alpine"
        cpu_limit = "2"
        memory_limit = "4Gi"
        cpu_request = "1"
        memory_request = "2Gi"
        [runners.kubernetes.pod_security_context]
          run_as_non_root = true
          run_as_user = 1000
        [runners.kubernetes.volumes]
          [[runners.kubernetes.volumes.empty_dir]]
            name = "cache"
            mount_path = "/cache"
      [runners.cache]
        Type = "s3"
        ServerAddress = "${S3_CACHE_SERVER}"
        AccessKey = "${S3_CACHE_ACCESS_KEY}"
        SecretKey = "${S3_CACHE_SECRET_KEY}"
        BucketName = "gitlab-runner-cache"

    [[runners]]
      name = "ossa-normal-priority"
      url = "https://gitlab.com/"
      token = "${GITLAB_RUNNER_TOKEN}"
      executor = "kubernetes"
      limit = 10
      [runners.kubernetes]
        namespace = "gitlab-runner"
        image = "node:22-alpine"
        cpu_limit = "1"
        memory_limit = "2Gi"
        cpu_request = "500m"
        memory_request = "1Gi"
        [runners.kubernetes.pod_security_context]
          run_as_non_root = true
          run_as_user = 1000
        [runners.kubernetes.volumes]
          [[runners.kubernetes.volumes.empty_dir]]
            name = "cache"
            mount_path = "/cache"
      [runners.cache]
        Type = "s3"
        ServerAddress = "${S3_CACHE_SERVER}"
        AccessKey = "${S3_CACHE_ACCESS_KEY}"
        SecretKey = "${S3_CACHE_SECRET_KEY}"
        BucketName = "gitlab-runner-cache"

    [[runners]]
      name = "ossa-low-priority"
      url = "https://gitlab.com/"
      token = "${GITLAB_RUNNER_TOKEN}"
      executor = "kubernetes"
      limit = 5
      [runners.kubernetes]
        namespace = "gitlab-runner"
        image = "node:22-alpine"
        cpu_limit = "500m"
        memory_limit = "1Gi"
        cpu_request = "200m"
        memory_request = "512Mi"
        [runners.kubernetes.pod_security_context]
          run_as_non_root = true
          run_as_user = 1000
        [runners.kubernetes.volumes]
          [[runners.kubernetes.volumes.empty_dir]]
            name = "cache"
            mount_path = "/cache"
      [runners.cache]
        Type = "s3"
        ServerAddress = "${S3_CACHE_SERVER}"
        AccessKey = "${S3_CACHE_ACCESS_KEY}"
        SecretKey = "${S3_CACHE_SECRET_KEY}"
        BucketName = "gitlab-runner-cache"
