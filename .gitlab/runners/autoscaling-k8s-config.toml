# OSSA Auto-Scaling GitLab Runner Configuration
# Kubernetes executor with auto-scaling

concurrent = 20
check_interval = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "ossa-autoscaler"
  url = "https://gitlab.com/"
  token = "${GITLAB_RUNNER_TOKEN}"
  executor = "kubernetes"
  [runners.kubernetes]
    namespace = "gitlab-runner"
    image = "node:22-alpine"
    privileged = false
    cpu_limit = "2"
    memory_limit = "4Gi"
    cpu_request = "500m"
    memory_request = "1Gi"
    service_cpu_limit = "1"
    service_memory_limit = "2Gi"
    service_cpu_request = "100m"
    service_memory_request = "512Mi"
    helper_cpu_limit = "500m"
    helper_memory_limit = "1Gi"
    helper_cpu_request = "100m"
    helper_memory_request = "256Mi"
    poll_timeout = 180
    output_limit = 4096
    [runners.kubernetes.affinity]
    [runners.kubernetes.pod_security_context]
      run_as_non_root = true
      run_as_user = 1000
      fs_group = 1000
    [runners.kubernetes.container_security_context]
      privileged = false
      allow_privilege_escalation = false
      read_only_root_filesystem = false
    [runners.kubernetes.volumes]
      [[runners.kubernetes.volumes.empty_dir]]
        name = "cache"
        mount_path = "/cache"
      [[runners.kubernetes.volumes.empty_dir]]
        name = "builds"
        mount_path = "/builds"
  [runners.cache]
    Type = "s3"
    ServerAddress = "${S3_CACHE_SERVER}"
    AccessKey = "${S3_CACHE_ACCESS_KEY}"
    SecretKey = "${S3_CACHE_SECRET_KEY}"
    BucketName = "gitlab-runner-cache"
    Insecure = false

[[runners]]
  name = "ossa-agent-autoscaler"
  url = "https://gitlab.com/"
  token = "${GITLAB_RUNNER_TOKEN}"
  executor = "kubernetes"
  [runners.kubernetes]
    namespace = "gitlab-runner"
    image = "node:22-alpine"
    privileged = false
    cpu_limit = "4"
    memory_limit = "8Gi"
    cpu_request = "1"
    memory_request = "2Gi"
    poll_timeout = 300
    output_limit = 8192
    [runners.kubernetes.affinity]
    [runners.kubernetes.pod_security_context]
      run_as_non_root = true
      run_as_user = 1000
    [runners.kubernetes.container_security_context]
      privileged = false
    [runners.kubernetes.volumes]
      [[runners.kubernetes.volumes.empty_dir]]
        name = "cache"
        mount_path = "/cache"
      [[runners.kubernetes.volumes.empty_dir]]
        name = "builds"
        mount_path = "/builds"
    [runners.kubernetes.env]
      - name = "GITLAB_TOKEN"
      - name = "ANTHROPIC_API_KEY"
      - name = "OPENAI_API_KEY"
  [runners.cache]
    Type = "s3"
    ServerAddress = "${S3_CACHE_SERVER}"
    AccessKey = "${S3_CACHE_ACCESS_KEY}"
    SecretKey = "${S3_CACHE_SECRET_KEY}"
    BucketName = "gitlab-runner-cache"
