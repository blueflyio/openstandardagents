# =============================================================================
# OSSA Validator Agent - CI Template
# =============================================================================
# Include this in your project's .gitlab-ci.yml to enable OSSA validation
#
# Usage:
#   include:
#     - remote: 'https://gitlab.com/blueflyio/ossa/openstandardagents/-/raw/main/.gitlab/agent-k8s/ci-template.yml'
#
#   variables:
#     OSSA_VALIDATION_ENABLED: "true"
#     OSSA_VALIDATION_STRICT: "false"
# =============================================================================

.ossa-validator-base:
  image: node:20-alpine
  before_script:
    - apk add --no-cache curl jq
    - npm install -g @bluefly/openstandardagents@latest
    - ossa --version
  tags:
    - self-hosted
    - docker
    - linux

# =============================================================================
# OSSA Manifest Validation
# =============================================================================

validate:ossa:manifests:
  extends: .ossa-validator-base
  stage: validate
  script:
    - echo "Validating OSSA manifests in ${CI_PROJECT_PATH}"
    - echo "Using @bluefly/openstandardagents from npmjs.org"
    - |
      # Find all .ossa.yaml files
      MANIFEST_FILES=$(find . -name "*.ossa.yaml" -o -name "*.ossa.yml")

      if [ -z "$MANIFEST_FILES" ]; then
        echo "No OSSA manifests found - skipping validation"
        exit 0
      fi

      echo "Found OSSA manifests:"
      echo "$MANIFEST_FILES"
      echo ""

      # Validate each manifest using official @bluefly/openstandardagents package
      FAILED=0
      WARNINGS=0

      for file in $MANIFEST_FILES; do
        echo "Validating $file..."

        if [ "${OSSA_VALIDATION_STRICT}" = "true" ]; then
          ossa validate "$file" --strict
        else
          ossa validate "$file"
        fi

        RESULT=$?

        if [ $RESULT -eq 0 ]; then
          echo "‚úÖ $file is valid"
        else
          echo "‚ùå $file validation failed"
          FAILED=$((FAILED + 1))
        fi

        echo ""
      done

      if [ $FAILED -gt 0 ]; then
        echo "ERROR: $FAILED manifest(s) failed validation"
        exit 1
      fi

      echo "All OSSA manifests validated successfully!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $OSSA_VALIDATION_ENABLED == "true"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
  allow_failure: !reference [.ossa-validation-allow-failure]

.ossa-validation-allow-failure:
  # Fail pipeline if strict mode enabled
  - $OSSA_VALIDATION_STRICT != "true"

# =============================================================================
# OSSA Schema Version Check
# =============================================================================

check:ossa:version:
  extends: .ossa-validator-base
  stage: validate
  script:
    - echo "Checking OSSA manifest versions"
    - |
      UNSUPPORTED=0
      for file in $(find . -name "*.ossa.yaml" -o -name "*.ossa.yml"); do
        VERSION=$(grep -E "^apiVersion:" "$file" | sed 's/.*ossa\/v//' || echo "unknown")

        if [[ ! "$VERSION" =~ ^0\.3 ]]; then
          echo "‚ùå $file uses unsupported version: ossa/v${VERSION}"
          echo "   Expected: ossa/v0.3.x"
          echo "   Run: ossa migrate $file --to v0.3.5"
          UNSUPPORTED=$((UNSUPPORTED + 1))
        else
          echo "‚úÖ $file: ossa/v${VERSION}"
        fi
      done

      if [ $UNSUPPORTED -gt 0 ]; then
        echo ""
        echo "ERROR: $UNSUPPORTED manifest(s) use unsupported OSSA versions"
        exit 1
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $OSSA_VALIDATION_ENABLED == "true"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
  allow_failure: false

# =============================================================================
# OSSA Cost Estimation
# =============================================================================

estimate:ossa:cost:
  extends: .ossa-validator-base
  stage: validate
  script:
    - echo "Estimating OSSA agent costs"
    - |
      for file in $(find . -name "*.ossa.yaml" -o -name "*.ossa.yml"); do
        echo ""
        echo "üìä $file:"

        # Extract LLM model
        MODEL=$(grep -A3 "llm:" "$file" | grep "model:" | sed 's/.*model: *//' | tr -d '"' || echo "unknown")

        # Rough cost estimates (per 1M tokens)
        case "$MODEL" in
          *"gpt-4"*)
            echo "   Model: $MODEL"
            echo "   Estimated cost: \$0.03-0.06 per run"
            ;;
          *"claude-opus"*)
            echo "   Model: $MODEL"
            echo "   Estimated cost: \$0.015-0.075 per run"
            ;;
          *"claude-sonnet"*)
            echo "   Model: $MODEL"
            echo "   Estimated cost: \$0.003-0.015 per run"
            ;;
          *"claude-haiku"* | *"gpt-3.5"* | *"gemini-flash"*)
            echo "   Model: $MODEL"
            echo "   Estimated cost: \$0.001-0.005 per run"
            ;;
          *)
            echo "   Model: $MODEL"
            echo "   Estimated cost: Unknown (model not recognized)"
            ;;
        esac

        # Check for cost controls
        if grep -q "cost_threshold_usd" "$file"; then
          THRESHOLD=$(grep "cost_threshold_usd:" "$file" | sed 's/.*: *//')
          echo "   ‚úÖ Cost threshold configured: \$$THRESHOLD"
        else
          echo "   ‚ö†Ô∏è  No cost threshold configured"
        fi
      done
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $OSSA_VALIDATION_ENABLED == "true"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
  allow_failure: true

# =============================================================================
# OSSA Safety Check
# =============================================================================

check:ossa:safety:
  extends: .ossa-validator-base
  stage: validate
  script:
    - echo "Checking OSSA safety configurations"
    - |
      WARNINGS=0
      for file in $(find . -name "*.ossa.yaml" -o -name "*.ossa.yml"); do
        echo ""
        echo "üîí $file:"

        # Check for guardrails
        if grep -q "guardrails:" "$file"; then
          echo "   ‚úÖ Guardrails configured"
        else
          echo "   ‚ö†Ô∏è  No guardrails configured"
          WARNINGS=$((WARNINGS + 1))
        fi

        # Check for PII handling
        if grep -q "pii_handling:" "$file"; then
          echo "   ‚úÖ PII handling specified"
        else
          echo "   ‚ö†Ô∏è  PII handling not specified"
          WARNINGS=$((WARNINGS + 1))
        fi

        # Check for audit settings
        if grep -q "audit_all_actions: true" "$file"; then
          echo "   ‚úÖ Full audit logging enabled"
        else
          echo "   ‚ÑπÔ∏è  Audit logging not enabled"
        fi
      done

      if [ $WARNINGS -gt 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  $WARNINGS safety warning(s) found - review recommended"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $OSSA_VALIDATION_ENABLED == "true"
      changes:
        - "**/*.ossa.yaml"
        - "**/*.ossa.yml"
  allow_failure: true
