# Enterprise Release Pipeline
# GitLab Ultimate + Duo Platform

variables:
  DOCKER_DRIVER: overlay2
  SECURE_LOG_LEVEL: info

stages:
  - validate
  - build
  - test
  - security
  - pre-release
  - release
  - post-release

# ============================================================================
# STAGE 1: VALIDATION
# ============================================================================

lint:
  stage: validate
  image: node:20
  script:
    - npm ci
    - npm run lint
    - npm run format:check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

type-check:
  stage: validate
  image: node:20
  script:
    - npm ci
    - npm run type-check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

unit-tests:
  stage: validate
  image: node:20
  script:
    - npm ci
    - npm run test:unit -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: junit.xml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

schema-validation:
  stage: validate
  image: node:20
  script:
    - npm ci
    - npm run validate:schema
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

# ============================================================================
# STAGE 2: BUILD
# ============================================================================

build:
  stage: build
  image: node:20
  script:
    - npm ci
    - npm run build
    - npm pack
  artifacts:
    paths:
      - dist/
      - '*.tgz'
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

build-website:
  stage: build
  image: node:20
  script:
    - cd website
    - npm ci
    - npm run build
  artifacts:
    paths:
      - website/.next/
      - website/out/
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

# ============================================================================
# STAGE 3: TEST
# ============================================================================

integration-tests:
  stage: test
  image: node:20
  script:
    - npm ci
    - npm run test:integration
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

e2e-tests:
  stage: test
  image: node:20
  script:
    - npm ci
    - npm run test:e2e
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

cross-platform-tests:
  stage: test
  parallel:
    matrix:
      - NODE_VERSION: ['18', '20', '22']
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'

# ============================================================================
# STAGE 4: SECURITY (GitLab Ultimate)
# ============================================================================

sast:
  stage: security
  variables:
    SAST_EXCLUDED_PATHS: "spec, test, tests, tmp, node_modules"

dependency_scanning:
  stage: security

secret_detection:
  stage: security

license_scanning:
  stage: security
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'

container_scanning:
  stage: security
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'

# GitLab Duo Code Review
duo-code-review:
  stage: security
  image: registry.gitlab.com/gitlab-org/security-products/analyzers/duo-code-review:latest
  script:
    - /analyzer run
  artifacts:
    reports:
      sast: gl-sast-report.json
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ============================================================================
# STAGE 5: PRE-RELEASE (development branch only)
# ============================================================================

create-rc-tag:
  stage: pre-release
  image: node:20
  script:
    - npm ci
    - node .gitlab/release-automation/webhooks/milestone-handler.ts
  rules:
    - if: '$CI_COMMIT_BRANCH == "development" && $MILESTONE_CLOSED == "true"'
      when: manual

dry-run-npm:
  stage: pre-release
  image: node:20
  script:
    - npm ci
    - npm run build
    - npm publish --dry-run
  rules:
    - if: '$CI_COMMIT_BRANCH == "development" && $MILESTONE_CLOSED == "true"'

dry-run-github:
  stage: pre-release
  image: node:20
  script:
    - echo "Simulating GitHub release..."
    - gh release view v$(node -p "require('./package.json').version") --repo blueflyio/ossa/openstandardagents || echo "Release would be created"
  rules:
    - if: '$CI_COMMIT_BRANCH == "development" && $MILESTONE_CLOSED == "true"'

dry-run-website:
  stage: pre-release
  image: node:20
  script:
    - cd website
    - npm ci
    - npm run build
    - echo "Website build successful, ready for deployment"
  rules:
    - if: '$CI_COMMIT_BRANCH == "development" && $MILESTONE_CLOSED == "true"'

create-release-mr:
  stage: pre-release
  image: node:20
  script:
    - node .gitlab/release-automation/webhooks/milestone-handler.ts
  rules:
    - if: '$CI_COMMIT_BRANCH == "development" && $MILESTONE_CLOSED == "true"'
      when: manual

# ============================================================================
# STAGE 6: RELEASE (main branch only, manual triggers)
# ============================================================================

release-npm:
  stage: release
  image: node:20
  script:
    - npm ci
    - RELEASE_ACTION=npm node .gitlab/release-automation/scripts/release-buttons.ts
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  environment:
    name: npm-production
    url: https://www.npmjs.com/package/openstandardagents

release-github:
  stage: release
  image: node:20
  needs: [release-npm]
  script:
    - RELEASE_ACTION=github node .gitlab/release-automation/scripts/release-buttons.ts
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  environment:
    name: github-production
    url: https://github.com/blueflyio/ossa/openstandardagents/releases

release-website:
  stage: release
  image: node:20
  needs: [release-github]
  script:
    - RELEASE_ACTION=website node .gitlab/release-automation/scripts/release-buttons.ts
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  environment:
    name: website-production
    url: https://openstandardagents.org

announce-release:
  stage: release
  image: node:20
  needs: [release-website]
  script:
    - RELEASE_ACTION=announce node .gitlab/release-automation/scripts/release-buttons.ts
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual

# ============================================================================
# STAGE 7: POST-RELEASE
# ============================================================================

tag-main:
  stage: post-release
  image: node:20
  script:
    - VERSION=$(node -p "require('./package.json').version")
    - git tag -a "v${VERSION}" -m "Release ${VERSION}"
    - git push origin "v${VERSION}"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $RELEASE_COMPLETE == "true"'

merge-to-development:
  stage: post-release
  image: node:20
  script:
    - git checkout development
    - git merge main --no-ff -m "chore: merge main after release [skip ci]"
    - git push origin development
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $RELEASE_COMPLETE == "true"'

close-milestone:
  stage: post-release
  image: node:20
  script:
    - echo "Closing milestone via API..."
    # TODO: Implement milestone close via API
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $RELEASE_COMPLETE == "true"'

# ============================================================================
# AUTO-INCREMENT DEV TAG (development branch)
# ============================================================================

increment-dev-tag:
  stage: post-release
  image: node:20
  script:
    - node .gitlab/release-automation/scripts/increment-dev-tag.ts
  rules:
    - if: '$CI_COMMIT_BRANCH == "development"'
      when: on_success

# ============================================================================
# ROLLBACK (manual trigger)
# ============================================================================

rollback:
  stage: release
  image: node:20
  script:
    - echo "Rolling back release..."
    - npm deprecate openstandardagents@$(node -p "require('./package.json').version") "This version has been rolled back due to critical issues"
    # TODO: Implement full rollback procedure
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  environment:
    name: rollback
    action: rollback

# ============================================================================
# INCLUDE GITLAB SECURITY TEMPLATES
# ============================================================================

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
