# ============================================================================
# OSSA v0.3.0 Task: Publish to npm
# ============================================================================
# Deterministic task for publishing npm packages
# Demonstrates idempotent execution type
# ============================================================================

apiVersion: ossa/v0.3.5
kind: Task
metadata:
  name: publish-npm-task
  version: 1.0.0
  description: "Publish package to npm registry"
  labels:
    domain: release-automation
    type: idempotent
    ossa-version: v0.3.0

spec:
  execution:
    type: idempotent
    runtime: node
    entrypoint: scripts/publish-npm.ts
    timeout_seconds: 600

  capabilities:
    - npm_publish
    - git_operations

  input:
    type: object
    properties:
      version:
        type: string
        pattern: "^\\d+\\.\\d+\\.\\d+"
        description: Semantic version to publish
      access:
        type: string
        enum: [public, restricted]
        default: public
      dry_run:
        type: boolean
        default: false
    required:
      - version

  output:
    type: object
    properties:
      published:
        type: boolean
      npm_url:
        type: string
        format: uri
      version:
        type: string

  batch:
    enabled: false

  preconditions:
    - expression: "version matches '^\\d+\\.\\d+\\.\\d+$'"
      message: "Version must be valid semver"
    - expression: "package.json exists"
      message: "package.json must exist"

  postconditions:
    - expression: "output.published == true"
      message: "Package must be published successfully"

extensions:
  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: task-system
      labels:
        app.kubernetes.io/name: publish-npm-task

runtime:
  type: kubernetes
  bindings:
    npm_registry:
      capability: npm_publish
      binding: secret
      secret: npm-token

