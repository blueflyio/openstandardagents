# ============================================================================
# OSSA v0.3.0 Task: Generate Changelog
# ============================================================================
# Deterministic task for generating changelog from milestone issues
# Demonstrates OSSA v0.3.0 Task kind with all features
# ============================================================================

apiVersion: ossa/v0.3.5
kind: Task
metadata:
  name: generate-changelog-task
  version: 1.0.0
  description: "Generate changelog from GitLab milestone issues"
  labels:
    domain: release-automation
    type: deterministic
    ossa-version: v0.3.0

spec:
  # ==========================================================================
  # EXECUTION: Task Execution Configuration
  # ==========================================================================
  execution:
    type: deterministic
    runtime: node
    entrypoint: scripts/generate-changelog.ts
    timeout_seconds: 300

  # ==========================================================================
  # CAPABILITIES: Required Capabilities
  # ==========================================================================
  capabilities:
    - gitlab_api_read
    - markdown_generation

  # ==========================================================================
  # INPUT: Task Input Schema
  # ==========================================================================
  input:
    type: object
    properties:
      milestone_id:
        type: integer
        description: GitLab milestone ID
      project_id:
        type: integer
        description: GitLab project ID
      format:
        type: string
        enum: [markdown, json]
        default: markdown
    required:
      - milestone_id
      - project_id

  # ==========================================================================
  # OUTPUT: Task Output Schema
  # ==========================================================================
  output:
    type: object
    properties:
      changelog:
        type: string
        description: Generated changelog content
      issue_count:
        type: integer
        description: Number of issues processed
      success:
        type: boolean
        description: Whether generation succeeded

  # ==========================================================================
  # BATCH: Batch Processing Configuration
  # ==========================================================================
  batch:
    enabled: false

  # ==========================================================================
  # DEPENDENCIES: Task Dependencies
  # ==========================================================================
  dependencies:
    - ref: .gitlab/agents/release-validator/manifest.ossa.yaml
      kind: Agent
      optional: false

  # ==========================================================================
  # PRECONDITIONS: Execution Conditions
  # ==========================================================================
  preconditions:
    - expression: "milestone_id > 0"
      message: "Milestone ID must be valid"
    - expression: "project_id > 0"
      message: "Project ID must be valid"

  # ==========================================================================
  # POSTCONDITIONS: Success Validation
  # ==========================================================================
  postconditions:
    - expression: "output.success == true"
      message: "Changelog generation must succeed"
    - expression: "output.changelog.length > 0"
      message: "Changelog must not be empty"

# ============================================================================
# EXTENSIONS: Framework Integrations
# ============================================================================
extensions:
  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: task-system
      labels:
        app.kubernetes.io/name: generate-changelog-task
        app.kubernetes.io/part-of: ossa-showcase

  gitlab_duo:
    enabled: true
    tool_integration: true

# ============================================================================
# RUNTIME: Runtime Capability Bindings
# ============================================================================
runtime:
  type: kubernetes
  bindings:
    gitlab_api:
      capability: gitlab_api_read
      binding: service_account
      service_account: gitlab-task-sa

