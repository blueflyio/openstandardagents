# =============================================================================
# GITLAB DUO AGENT CONFIG - AUTO-GENERATED FROM OSSA v0.3.0 MANIFEST
# =============================================================================
#
# Source: .gitlab/agents/gitlab-duo-ossa/manifest.ossa.yaml
# Generated: 2025-12-12T03:47:06.928Z
#
# COPY THIS TO: https://gitlab.com/blueflyio/openstandardagents/-/automate/agents/1261/edit
#
# DOGFOODING OSSA INSIDE GITLAB! ğŸš€
# =============================================================================

image: node:20-bookworm

commands:
  - |
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸš€ gitlab-duo-ossa-agent v1.0.0 - POWERED BY OSSA v0.3.0"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "DOGFOODING OSSA INSIDE GITLAB! ğŸ¯"
    echo ""
  - |
    apt-get update && apt-get install -y --no-install-recommends \
      git jq curl python3 python3-pip shellcheck ripgrep \
      && rm -rf /var/lib/apt/lists/*
  - npm ci --prefer-offline --no-audit
  - npm run build 2>/dev/null || echo "No build script"
  - pip3 install --break-system-packages yamllint jsonschema 2>/dev/null || true
  - |
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ” PHASE: OSSA v0.3.0 Deep Validation"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    VALIDATION_PASSED=0
    VALIDATION_FAILED=0
    VALIDATION_WARNINGS=0
    
    for manifest in $(find . -type f \( -name "*.ossa.yaml" -o -name "*.ossa.yml" \) ! -path "./node_modules/*"); do
      echo ""
      echo "ğŸ“„ Validating: $manifest"
    
      # Get version
      VERSION=$(grep -E "^apiVersion:" "$manifest" | head -1 | sed 's/apiVersion: *//' | tr -d '"'"'"' || echo "unknown")
      echo "   Version: $VERSION"
    
      # Run OSSA CLI validation
      if npx ossa validate "$manifest" 2>&1; then
        echo "   âœ… Schema: VALID"
        VALIDATION_PASSED=$((VALIDATION_PASSED + 1))
      else
        echo "   âŒ Schema: INVALID"
        VALIDATION_FAILED=$((VALIDATION_FAILED + 1))
      fi
    
      # v0.3.0 deep checks
      if echo "$VERSION" | grep -q "v0.3"; then
        echo "   ğŸ”¬ v0.3.0 compliance checks..."
    
        # Check for env var models
        if grep -qE "model:\s*(claude-|gpt-|gemini-)" "$manifest" 2>/dev/null; then
          if ! grep -qE 'model:\s*${' "$manifest" 2>/dev/null; then
            echo "   âš ï¸  Hardcoded model - use \${LLM_MODEL:-default}"
            VALIDATION_WARNINGS=$((VALIDATION_WARNINGS + 1))
          fi
        fi
    
        # Check required sections
        for section in observability safety cost_tracking; do
          if ! grep -q "$section:" "$manifest" 2>/dev/null; then
            echo "   âš ï¸  Missing: $section"
            VALIDATION_WARNINGS=$((VALIDATION_WARNINGS + 1))
          fi
        done
      fi
    done
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š OSSA Validation: âœ… $VALIDATION_PASSED | âŒ $VALIDATION_FAILED | âš ï¸ $VALIDATION_WARNINGS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  - |
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ” PHASE: Code Quality Analysis"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # TypeScript/ESLint
    if [ -f "package.json" ] && grep -q "eslint" package.json 2>/dev/null; then
      echo "ğŸ“‹ ESLint..."
      npx eslint . --ext .ts,.js --format stylish --max-warnings 100 2>/dev/null || true
    fi
    
    # YAML lint
    echo "ğŸ“‹ YAML lint..."
    yamllint -d "{extends: default, rules: {line-length: disable, document-start: disable}}" \
      .gitlab/agents/ .agents/ spec/ 2>/dev/null || true
    
    # ShellCheck
    echo "ğŸ“‹ ShellCheck..."
    find . -name "*.sh" -type f ! -path "./node_modules/*" -exec shellcheck {} \; 2>/dev/null || true
    
    echo "âœ… Code quality analysis complete"
  - |
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”’ PHASE: Security Scanning"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    SECURITY_ISSUES=0
    
    # Secrets scan
    echo "ğŸ” Scanning for secrets..."
    PATTERNS="(api[_-]?key|apikey|secret|password|token|auth|private[_-]?key)"
    if rg -i "$PATTERNS" --glob "!node_modules/**" --glob "!*.md" --glob "!*.lock" . 2>/dev/null | grep -v "env:" | grep -v '${' | head -10; then
      echo "âš ï¸  Potential secrets found"
      SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
    else
      echo "âœ… No secrets detected"
    fi
    
    # Hardcoded credentials
    echo "ğŸ” Checking for credentials..."
    if rg -i "(glpat-|ghp_|sk-|xoxb-|AKIA)" --glob "!node_modules/**" . 2>/dev/null | head -5; then
      echo "âŒ HARDCODED CREDENTIALS!"
      SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
    else
      echo "âœ… No hardcoded credentials"
    fi
    
    # npm audit
    echo "ğŸ” npm audit..."
    npm audit --audit-level=high 2>/dev/null || true
    
    echo ""
    echo "ğŸ”’ Security: $SECURITY_ISSUES issue(s)"
  - |
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“š PHASE: Documentation Check"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    [ -f "README.md" ] && echo "âœ… README.md" || echo "âš ï¸ No README.md"
    [ -f "CHANGELOG.md" ] && echo "âœ… CHANGELOG.md" || echo "âš ï¸ No CHANGELOG.md"
    
    for dir in .gitlab/agents/* .agents/*/; do
      [ -d "$dir" ] || continue
      name=$(basename "$dir")
      if [ -f "$dir/README.md" ] || [ -f "$dir/system-prompt.md" ]; then
        echo "âœ… $name: documented"
      else
        echo "âš ï¸ $name: needs docs"
      fi
    done
  - |
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”§ PHASE: Self-Healing Suggestions"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    FIXES=0
    
    for manifest in $(find . -name "*.ossa.yaml" ! -path "./node_modules/*"); do
      # Missing apiVersion
      if ! grep -q "^apiVersion:" "$manifest"; then
        echo "ğŸ”§ $manifest: Add 'apiVersion: ossa/v0.3.0'"
        FIXES=$((FIXES + 1))
      fi
    
      # Missing kind
      if ! grep -q "^kind:" "$manifest"; then
        echo "ğŸ”§ $manifest: Add 'kind: Agent'"
        FIXES=$((FIXES + 1))
      fi
    
      # Hardcoded models
      if grep -qE "model:\s*(claude-|gpt-)" "$manifest" 2>/dev/null; then
        if ! grep -qE 'model:\s*${' "$manifest" 2>/dev/null; then
          echo "ğŸ”§ $manifest: Use \${LLM_MODEL:-claude-sonnet-4}"
          FIXES=$((FIXES + 1))
        fi
      fi
    done
    
    echo ""
    echo "ğŸ“Š Suggested fixes: $FIXES"
  - |
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¯ gitlab-duo-ossa-agent - COMPLETE"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "OSSA v0.3.0 DOGFOODING SUCCESS! ğŸš€"
    echo ""
    echo "This agent was defined by: .gitlab/agents/gitlab-duo-ossa/manifest.ossa.yaml"
    echo "Schema version: ossa/v0.3.0"
    echo "Capabilities: ossa_validation, code_review, security_scan, auto_fix, documentation_check, test_coverage, agent_coordination"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# =============================================================================
# END OF GENERATED CONFIG
#
# This agent is PROOF that OSSA works.
# Every validation it runs demonstrates the power of standardized schemas.
#
# OSSA v0.3.0 - The OpenAPI for AI Agents
# =============================================================================
