# ============================================================================
# OSSA Compliance Auditor Agent - GitLab Kubernetes Deployment
# ============================================================================
#
# PURPOSE:
#   Automated compliance auditing for regulatory frameworks (SOC 2, HIPAA,
#   PCI-DSS, GDPR, FedRAMP). Validates Kubernetes configurations, audit logs,
#   and operational practices against compliance requirements.
#
# CAPABILITIES:
#   - SOC 2 compliance validation (access controls, encryption, logging)
#   - HIPAA compliance for healthcare workloads (PHI encryption, audit trails)
#   - PCI-DSS compliance for payment processing (network segmentation, encryption)
#   - GDPR compliance (data residency, right to erasure, consent management)
#   - FedRAMP compliance for government workloads (FIPS 140-2, NIST controls)
#   - Continuous compliance monitoring and automated remediation
#
# ============================================================================

apiVersion: ossa/v0.2.9
kind: Agent

metadata:
  name: compliance-auditor
  version: 1.0.0
  description: |
    Automated compliance auditing agent for regulatory frameworks (SOC 2, HIPAA,
    PCI-DSS, GDPR, FedRAMP). Validates Kubernetes configurations, audit logs, and
    operational practices against compliance requirements.

  labels:
    environment: production
    team: compliance
    domain: governance
    capability: audit
    frameworks: "SOC2,HIPAA,PCI-DSS,GDPR,FedRAMP"

  annotations:
    documentation: https://openstandardagents.org/docs/agents/compliance-auditor
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/compliance-auditor
    certifications: "SOC 2 Type II, HIPAA, PCI-DSS Level 1"

spec:
  taxonomy:
    domain: governance-risk-compliance
    subdomain: regulatory-compliance
    capability: automated-auditing

  role: |
    You are an expert compliance auditor specializing in regulatory frameworks.

    Your responsibilities:
    1. SOC 2 Type II Compliance:
       - Validate access controls (RBAC, least privilege)
       - Verify encryption at rest and in transit (TLS 1.2+)
       - Audit logging and retention (1 year minimum)
       - Monitor security incidents and response procedures
       - Validate backup and disaster recovery procedures

    2. HIPAA Compliance (Healthcare):
       - Verify PHI encryption (AES-256 at rest, TLS 1.2+ in transit)
       - Audit trail for all PHI access (who, what, when)
       - Access controls (role-based, need-to-know)
       - Breach notification procedures
       - Business Associate Agreements (BAA) tracking

    3. PCI-DSS Compliance (Payment Processing):
       - Network segmentation (cardholder data environment isolation)
       - Encryption of cardholder data (AES-256, tokenization)
       - No hardcoded credentials or secrets in code
       - Quarterly vulnerability scans
       - Annual penetration testing

    4. GDPR Compliance (EU Data Protection):
       - Data residency validation (EU region enforcement)
       - Right to erasure implementation (data deletion workflows)
       - Consent management and audit trails
       - Data processing agreements (DPA) validation
       - Data breach notification (72-hour requirement)

    5. FedRAMP Compliance (Government Workloads):
       - FIPS 140-2 validated cryptography
       - NIST 800-53 controls implementation
       - Continuous monitoring (ConMon) requirements
       - Incident response plan validation
       - System Security Plan (SSP) alignment

    For each violation:
    - Framework (SOC 2, HIPAA, PCI-DSS, GDPR, FedRAMP)
    - Control violated (specific requirement ID)
    - Severity (critical/high/medium/low)
    - Affected resources (namespace/pod/service)
    - Remediation steps
    - Auditor evidence (logs, configs, screenshots)

  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.0  # Deterministic for compliance
    maxTokens: 10000  # Large context for detailed audit reports

  tools:
    - type: mcp
      name: kubernetes-audit
      description: |
        Access Kubernetes audit logs for compliance validation.
      config:
        server: kubernetes-mcp
        auditLogPath: /var/log/kubernetes/audit
      auth:
        type: mtls
        certPath: /var/secrets/k8s-audit-cert.pem

    - type: http
      name: vault-compliance
      description: |
        Audit HashiCorp Vault for secrets encryption and access controls.
      endpoint: http://vault:8200/v1/sys/audit
      config:
        method: GET
        timeout: 10
      auth:
        type: token
        tokenPath: /var/secrets/vault-token

    - type: http
      name: falco-alerts
      description: |
        Query Falco for runtime security violations and compliance events.
      endpoint: http://falco:2801/api/v1/alerts
      config:
        method: GET
        timeout: 10

    - type: mcp
      name: postgres-audit
      description: |
        Audit PostgreSQL for data access logs and encryption settings.
      config:
        server: postgres-mcp
        database: audit_db
        auditSchema: pgaudit

    - type: http
      name: splunk-query
      description: |
        Query Splunk SIEM for security events and audit logs.
      endpoint: http://splunk:8089/services/search/jobs
      config:
        method: POST
        timeout: 30
      auth:
        type: bearer
        tokenPath: /var/secrets/splunk-token

    - type: a2a
      name: security-scanner
      description: |
        Coordinate with security-scanner for vulnerability compliance.
      endpoint: http://security-scanner:8080/a2a
      config:
        protocol: json-rpc
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem

    - type: http
      name: jira-api
      description: |
        Create compliance violation tickets in Jira.
      endpoint: https://jira.bluefly.io/rest/api/2/issue
      config:
        method: POST
        timeout: 10
      auth:
        type: bearer
        tokenPath: /var/secrets/jira-token

  autonomy:
    level: autonomous
    approval_required: false

    allowed_actions:
      - audit_kubernetes_configs
      - audit_access_logs
      - audit_encryption_settings
      - generate_compliance_reports
      - create_violation_tickets

    blocked_actions:
      - modify_audit_logs
      - disable_encryption
      - grant_access_permissions

  constraints:
    cost:
      maxTokensPerDay: 500000
      maxTokensPerRequest: 10000
      maxCostPerDay: 50.00
      currency: USD

    performance:
      maxLatencySeconds: 120
      maxConcurrentRequests: 10
      timeoutSeconds: 300

    resources:
      cpu: "1000m"
      memory: "2Gi"

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318
      samplingRate: 1.0  # 100% trace all compliance audits

    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: compliance_violations_total
          type: counter
          description: "Total compliance violations detected"
          labels: [framework, severity, control_id]
        - name: compliance_score
          type: gauge
          description: "Overall compliance score (0-100)"
          labels: [framework]
        - name: audit_duration_seconds
          type: histogram
          description: "Compliance audit duration"

    logging:
      level: info
      format: json
      auditLog:
        enabled: true
        destination: /var/log/compliance/audit.log
        retention: 7years  # 7 year retention for regulatory requirements
        tamperProof: true  # Write-once, append-only logging

  state:
    backend: postgres
    config:
      host: postgres-primary.default.svc.cluster.local
      port: 5432
      database: compliance_db
      schema: audit_trail
      ssl: true
      sslMode: require
      encryption: pgcrypto  # PostgreSQL encryption extension

  extensions:
    kagent:
      kubernetes:
        namespace: compliance-system
        labels:
          app: compliance-auditor
          team: compliance
          frameworks: "SOC2,HIPAA,PCI-DSS,GDPR,FedRAMP"
        annotations:
          certifications: "SOC 2 Type II, HIPAA, PCI-DSS Level 1"
        resourceLimits:
          cpu: "1000m"
          memory: "2Gi"
        serviceAccount: compliance-auditor-sa
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

      guardrails:
        requireApproval: false

        costLimits:
          maxTokensPerDay: 500000
          maxCostPerDay: 50.00
          currency: USD

        allowedActions:
          - kubernetes:get:*  # Read-only cluster access
          - vault:audit:*
          - postgres:select:audit_trail
          - splunk:search:*

        auditLog:
          destination: compliance-engine
          retention: 7years
          tamperProof: true

      a2aConfig:
        enabled: true
        protocol: json-rpc
        endpoints:
          - http://security-scanner:8080/a2a
          - http://config-validator:8080/a2a
        authentication:
          type: mtls
          certPath: /var/secrets/a2a-client-cert.pem
          keyPath: /var/secrets/a2a-client-key.pem

      meshIntegration:
        enabled: true
        istioIntegration: true
        ambientMesh: true
        mtlsMode: STRICT  # Required for compliance

# ============================================================================
# COMPLIANCE AUDIT SCHEDULE
# ============================================================================
#
# Continuous Monitoring:
#   - Real-time audit log ingestion (Kubernetes, Vault, PostgreSQL, Splunk)
#   - Immediate violation detection and alerting
#   - Automated ticket creation for remediation
#
# Daily Audits:
#   - Access control validation (RBAC, least privilege)
#   - Encryption settings verification (at rest, in transit)
#   - Audit log retention validation (1-7 years depending on framework)
#
# Weekly Audits:
#   - Security incident review and response validation
#   - Backup and disaster recovery testing
#   - Vulnerability scan analysis
#
# Monthly Audits:
#   - Compliance score calculation and trending
#   - Evidence collection for auditor review
#   - Compliance dashboard updates
#
# Quarterly Audits:
#   - Full compliance framework validation (SOC 2, HIPAA, PCI-DSS, GDPR, FedRAMP)
#   - External auditor evidence package preparation
#   - Risk assessment and gap analysis
#
# Annual Audits:
#   - Penetration testing coordination (PCI-DSS requirement)
#   - SOC 2 Type II audit preparation
#   - Compliance certification renewals
#
# ============================================================================
