# ============================================================================
# OSSA Compliance Auditor Agent - GitLab Kubernetes Deployment
# ============================================================================
#
# PURPOSE:
#   Automated compliance auditing for regulatory frameworks (SOC 2, HIPAA,
#   PCI-DSS, GDPR, FedRAMP). Validates Kubernetes configurations, audit logs,
#   and operational practices against compliance requirements.
#
# CAPABILITIES:
#   - SOC 2 compliance validation (access controls, encryption, logging)
#   - HIPAA compliance for healthcare workloads (PHI encryption, audit trails)
#   - PCI-DSS compliance for payment processing (network segmentation, encryption)
#   - GDPR compliance (data residency, right to erasure, consent management)
#   - FedRAMP compliance for government workloads (FIPS 140-2, NIST controls)
#   - Continuous compliance monitoring and automated remediation
#
# ============================================================================

apiVersion: ossa/v0.2.9
kind: Agent

metadata:
  name: compliance-auditor
  version: 1.0.0
  description: |
    Automated compliance auditing agent for regulatory frameworks (SOC 2, HIPAA,
    PCI-DSS, GDPR, FedRAMP). Validates Kubernetes configurations, audit logs, and
    operational practices against compliance requirements.

  labels:
    environment: production
    team: compliance
    domain: governance
    capability: audit
    frameworks: "SOC2,HIPAA,PCI-DSS,GDPR,FedRAMP"

  annotations:
    documentation: https://openstandardagents.org/docs/agents/compliance-auditor
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/compliance-auditor
    certifications: "SOC 2 Type II, HIPAA, PCI-DSS Level 1"

spec:
  taxonomy:
    domain: governance-risk-compliance
    subdomain: regulatory-compliance
    capability: automated-auditing

  role: |
    You are an expert compliance auditor specializing in regulatory frameworks.

    Your responsibilities:
    1. SOC 2 Type II Compliance:
       - Validate access controls (RBAC, least privilege)
       - Verify encryption at rest and in transit (TLS 1.2+)
       - Audit logging and retention (1 year minimum)
       - Monitor security incidents and response procedures
       - Validate backup and disaster recovery procedures

    2. HIPAA Compliance (Healthcare):
       - Verify PHI encryption (AES-256 at rest, TLS 1.2+ in transit)
       - Audit trail for all PHI access (who, what, when)
       - Access controls (role-based, need-to-know)
       - Breach notification procedures
       - Business Associate Agreements (BAA) tracking

    3. PCI-DSS Compliance (Payment Processing):
       - Network segmentation (cardholder data environment isolation)
       - Encryption of cardholder data (AES-256, tokenization)
       - No hardcoded credentials or secrets in code
       - Quarterly vulnerability scans
       - Annual penetration testing

    4. GDPR Compliance (EU Data Protection):
       - Data residency validation (EU region enforcement)
       - Right to erasure implementation (data deletion workflows)
       - Consent management and audit trails
       - Data processing agreements (DPA) validation
       - Data breach notification (72-hour requirement)

    5. FedRAMP Compliance (Government Workloads):
       - FIPS 140-2 validated cryptography
       - NIST 800-53 controls implementation
       - Continuous monitoring (ConMon) requirements
       - Incident response plan validation
       - System Security Plan (SSP) alignment

    For each violation:
    - Framework (SOC 2, HIPAA, PCI-DSS, GDPR, FedRAMP)
    - Control violated (specific requirement ID)
    - Severity (critical/high/medium/low)
    - Affected resources (namespace/pod/service)
    - Remediation steps
    - Auditor evidence (logs, configs, screenshots)

  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-sonnet}  # Use env var, defaults to latest sonnet
    temperature: 0.0  # Deterministic for compliance
    maxTokens: 10000  # Large context for detailed audit reports
    topP: 0.9

    fallback_models:
      - provider: ${LLM_FALLBACK_PROVIDER_1:-openai}
        model: ${LLM_FALLBACK_MODEL_1:-gpt-4o}
      - provider: ${LLM_FALLBACK_PROVIDER_2:-anthropic}
        model: ${LLM_FALLBACK_MODEL_2:-claude-haiku}

    retry_config:
      max_attempts: 3
      backoff_strategy: exponential

    cost_tracking:
      enabled: true
      budget_alert_threshold: 40.00
      cost_allocation_tags:
        project: ossa-agents
        team: compliance
        service: compliance-auditor

  tools:
    - type: mcp
      name: kubernetes-audit
      description: |
        Access Kubernetes audit logs for compliance validation.
      config:
        server: kubernetes-mcp
        auditLogPath: /var/log/kubernetes/audit
      auth:
        type: mtls
        certPath: /var/secrets/k8s-audit-cert.pem

    - type: http
      name: vault-compliance
      description: |
        Audit HashiCorp Vault for secrets encryption and access controls.
      endpoint: http://vault:8200/v1/sys/audit
      config:
        method: GET
        timeout: 10
      auth:
        type: token
        tokenPath: /var/secrets/vault-token

    - type: http
      name: falco-alerts
      description: |
        Query Falco for runtime security violations and compliance events.
      endpoint: http://falco:2801/api/v1/alerts
      config:
        method: GET
        timeout: 10

    - type: mcp
      name: postgres-audit
      description: |
        Audit PostgreSQL for data access logs and encryption settings.
      config:
        server: postgres-mcp
        database: audit_db
        auditSchema: pgaudit

    - type: http
      name: splunk-query
      description: |
        Query Splunk SIEM for security events and audit logs.
      endpoint: http://splunk:8089/services/search/jobs
      config:
        method: POST
        timeout: 30
      auth:
        type: bearer
        tokenPath: /var/secrets/splunk-token

    - type: a2a
      name: security-scanner
      description: |
        Coordinate with security-scanner for vulnerability compliance.
      endpoint: http://security-scanner:8080/a2a
      config:
        protocol: json-rpc
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem

    - type: http
      name: jira-api
      description: |
        Create compliance violation tickets in Jira.
      endpoint: https://jira.bluefly.io/rest/api/2/issue
      config:
        method: POST
        timeout: 10
      auth:
        type: bearer
        tokenPath: /var/secrets/jira-token

  autonomy:
    level: autonomous
    approval_required: false

    allowed_actions:
      - audit_kubernetes_configs
      - audit_access_logs
      - audit_encryption_settings
      - generate_compliance_reports
      - create_violation_tickets

    blocked_actions:
      - modify_audit_logs
      - disable_encryption
      - grant_access_permissions

  constraints:
    cost:
      maxTokensPerDay: 500000
      maxTokensPerRequest: 10000
      maxCostPerDay: 50.00
      currency: USD

    performance:
      maxLatencySeconds: 120
      maxConcurrentRequests: 10
      timeoutSeconds: 300

    resources:
      cpu: "1000m"
      memory: "2Gi"

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318
      samplingRate: 1.0  # 100% trace all compliance audits

    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: compliance_violations_total
          type: counter
          description: "Total compliance violations detected"
          labels: [framework, severity, control_id]
        - name: compliance_score
          type: gauge
          description: "Overall compliance score (0-100)"
          labels: [framework]
        - name: audit_duration_seconds
          type: histogram
          description: "Compliance audit duration"

    logging:
      level: info
      format: json
      auditLog:
        enabled: true
        destination: /var/log/compliance/audit.log
        retention: 7years  # 7 year retention for regulatory requirements
        tamperProof: true  # Write-once, append-only logging

  state:
    backend: postgres
    config:
      host: postgres-primary.default.svc.cluster.local
      port: 5432
      database: compliance_db
      schema: audit_trail
      ssl: true
      sslMode: require
      encryption: pgcrypto  # PostgreSQL encryption extension

  reliability:
    sla:
      availability_percent: 99.9
      latency_p95_ms: 30000
      error_rate_percent: 0.1
    circuit_breaker:
      enabled: true
      failure_threshold: 3
      timeout_seconds: 60
      half_open_requests: 2
    health_check:
      enabled: true
      interval_seconds: 30
      timeout_seconds: 10
    failover:
      enabled: true
      strategy: active-passive

  security:
    authentication:
      required: true
      methods:
        - mtls
        - bearer
    authorization:
      model: rbac
      roles:
        - compliance-auditor
        - agent-operator
      permissions:
        - kubernetes:read
        - audit:read
        - vault:audit
    encryption:
      in_transit:
        enabled: true
        tls_version: "1.3"
      at_rest:
        enabled: true
        algorithm: aes-256-gcm
        key_management: vault
    audit:
      enabled: true
      log_level: detailed
      retention_days: 2555  # 7 years for compliance
      pii_redaction: true
    compliance:
      frameworks:
        - soc2
        - hipaa
        - pci-dss
        - gdpr
        - fedramp

  safety:
    content_filtering:
      enabled: true
      categories:
        - pii
        - phi  # Protected Health Information
        - pci  # Payment Card Industry data
      threshold: high
      action: block
    rate_limiting:
      enabled: true
      requests_per_minute: 60
      burst_limit: 10
    guardrails:
      enabled: true
      policies:
        - name: audit_log_protection
          type: output
          rules:
            - no_modify_audit_logs
        - name: encryption_enforcement
          type: output
          rules:
            - no_disable_encryption
      max_tool_calls: 100
      max_execution_time_seconds: 300

  deployment:
    strategy: rolling
    rollback:
      enabled: true
      automatic: true
    versioning:
      scheme: semver
      compatibility: backward
    lifecycle:
      startup_probe:
        enabled: true
        initial_delay_seconds: 10
        period_seconds: 10
        failure_threshold: 6
      readiness_probe:
        enabled: true
        period_seconds: 10
      liveness_probe:
        enabled: true
        period_seconds: 30
      graceful_shutdown:
        enabled: true
        timeout_seconds: 60

  extensions:
    kagent:
      kubernetes:
        namespace: compliance-system
        labels:
          app: compliance-auditor
          team: compliance
          frameworks: "SOC2,HIPAA,PCI-DSS,GDPR,FedRAMP"
        annotations:
          certifications: "SOC 2 Type II, HIPAA, PCI-DSS Level 1"
        resourceLimits:
          cpu: "1000m"
          memory: "2Gi"
        serviceAccount: compliance-auditor-sa
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

      guardrails:
        requireApproval: false

        costLimits:
          maxTokensPerDay: 500000
          maxCostPerDay: 50.00
          currency: USD

        allowedActions:
          - kubernetes:get:*  # Read-only cluster access
          - vault:audit:*
          - postgres:select:audit_trail
          - splunk:search:*

        auditLog:
          destination: compliance-engine
          retention: 7years
          tamperProof: true

      a2aConfig:
        enabled: true
        protocol: json-rpc
        endpoints:
          - http://security-scanner:8080/a2a
          - http://config-validator:8080/a2a
        authentication:
          type: mtls
          certPath: /var/secrets/a2a-client-cert.pem
          keyPath: /var/secrets/a2a-client-key.pem

      meshIntegration:
        enabled: true
        istioIntegration: true
        ambientMesh: true
        mtlsMode: STRICT  # Required for compliance

# ============================================================================
# COMPLIANCE AUDIT SCHEDULE
# ============================================================================
#
# Continuous Monitoring:
#   - Real-time audit log ingestion (Kubernetes, Vault, PostgreSQL, Splunk)
#   - Immediate violation detection and alerting
#   - Automated ticket creation for remediation
#
# Daily Audits:
#   - Access control validation (RBAC, least privilege)
#   - Encryption settings verification (at rest, in transit)
#   - Audit log retention validation (1-7 years depending on framework)
#
# Weekly Audits:
#   - Security incident review and response validation
#   - Backup and disaster recovery testing
#   - Vulnerability scan analysis
#
# Monthly Audits:
#   - Compliance score calculation and trending
#   - Evidence collection for auditor review
#   - Compliance dashboard updates
#
# Quarterly Audits:
#   - Full compliance framework validation (SOC 2, HIPAA, PCI-DSS, GDPR, FedRAMP)
#   - External auditor evidence package preparation
#   - Risk assessment and gap analysis
#
# Annual Audits:
#   - Penetration testing coordination (PCI-DSS requirement)
#   - SOC 2 Type II audit preparation
#   - Compliance certification renewals
#
# ============================================================================
