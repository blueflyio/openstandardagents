apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: seo-optimizer
  namespace: website-automation
  labels:
    tier: automation
    domain: seo
    trigger: pipeline
spec:
  description: |
    SEO optimization and validation agent. Runs during CI/CD to:
    - Generate and validate sitemap
    - Validate meta tags and structured data
    - Configure analytics tracking
    - Check for broken links and missing images
    - Generate SEO audit reports

  capabilities:
    - seo-validation
    - sitemap-generation
    - metadata-extraction
    - link-checking
    - analytics-configuration

  triggers:
    - type: pipeline
      events:
        - pipeline.build
        - pipeline.deploy
      filters:
        - branch: [main, release/*, feature/*]
    - type: schedule
      cron: "0 6 * * 1"  # Weekly Monday 6am audit

  environment:
    GA_MEASUREMENT_ID: ${NEXT_PUBLIC_GA_MEASUREMENT_ID}
    SITE_URL: ${SITE_URL:-https://openstandardagents.org}
    GITLAB_TOKEN: ${GITLAB_TOKEN}

  tasks:
    # ========================================
    # 1. Sitemap Generation & Validation
    # ========================================
    - id: generate-sitemap
      name: Generate Sitemap
      type: script
      config:
        runtime: node
        script: |
          const fs = require('fs');
          const path = require('path');

          // Collect all pages from app directory
          const pages = [];
          const appDir = './website/app';

          function walkDir(dir, basePath = '') {
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            for (const entry of entries) {
              if (entry.isDirectory() && !entry.name.startsWith('_') && !entry.name.startsWith('.')) {
                const slug = entry.name.replace(/\[|\]/g, '');
                walkDir(path.join(dir, entry.name), `${basePath}/${slug}`);
              } else if (entry.name === 'page.tsx' || entry.name === 'page.js') {
                pages.push(basePath || '/');
              }
            }
          }

          walkDir(appDir);
          console.log(`Found ${pages.length} pages`);
          fs.writeFileSync('./website/public/sitemap-pages.json', JSON.stringify(pages, null, 2));
        outputs:
          - sitemap-pages.json

    - id: validate-sitemap
      name: Validate Sitemap Structure
      type: validation
      dependsOn: [generate-sitemap]
      config:
        checks:
          - name: sitemap-exists
            path: website/app/sitemap.ts
          - name: all-pages-included
            compare: sitemap-pages.json
          - name: valid-priorities
            range: [0.0, 1.0]
          - name: valid-changefreq
            values: [always, hourly, daily, weekly, monthly, yearly, never]

    # ========================================
    # 2. Meta Tags Validation
    # ========================================
    - id: validate-meta-tags
      name: Validate SEO Meta Tags
      type: validation
      config:
        rules:
          - file: "website/app/**/page.tsx"
            required:
              - title
              - description
            recommended:
              - openGraph.title
              - openGraph.description
              - twitter.card
          - file: "website/app/**/layout.tsx"
            required:
              - metadata

    - id: extract-meta
      name: Extract Meta Information
      type: script
      config:
        runtime: node
        script: |
          const glob = require('glob');
          const fs = require('fs');

          const pages = glob.sync('website/app/**/page.tsx');
          const metaReport = [];

          pages.forEach(page => {
            const content = fs.readFileSync(page, 'utf8');
            const hasMetadata = content.includes('export const metadata') ||
                               content.includes('export async function generateMetadata');
            const hasStructuredData = content.includes('StructuredData');

            metaReport.push({
              page,
              hasMetadata,
              hasStructuredData,
              status: hasMetadata ? 'ok' : 'missing'
            });
          });

          fs.writeFileSync('./seo-meta-report.json', JSON.stringify(metaReport, null, 2));

          const missing = metaReport.filter(r => !r.hasMetadata);
          if (missing.length > 0) {
            console.error('Pages missing metadata:', missing.map(m => m.page));
            process.exit(1);
          }
        outputs:
          - seo-meta-report.json

    # ========================================
    # 3. Analytics Configuration
    # ========================================
    - id: configure-analytics
      name: Configure Analytics
      type: configuration
      config:
        provider: google-analytics
        measurement_id: ${GA_MEASUREMENT_ID}
        settings:
          anonymize_ip: true
          cookie_flags: "SameSite=None;Secure"
          debug_mode: ${DEBUG:-false}
        events:
          - name: page_view
            auto: true
          - name: scroll_depth
            thresholds: [25, 50, 75, 90]
          - name: outbound_click
            selector: 'a[href^="http"]'
          - name: file_download
            extensions: [pdf, zip, yaml, json]
          - name: playground_interaction
            page: /playground
          - name: docs_navigation
            page: /docs/*

    - id: generate-analytics-config
      name: Generate Analytics Config
      type: script
      dependsOn: [configure-analytics]
      config:
        runtime: node
        script: |
          const fs = require('fs');

          const config = {
            measurementId: process.env.GA_MEASUREMENT_ID || '',
            enabled: !!process.env.GA_MEASUREMENT_ID,
            settings: {
              anonymize_ip: true,
              send_page_view: true,
              cookie_flags: 'SameSite=None;Secure'
            },
            customEvents: [
              { name: 'playground_validate', category: 'engagement' },
              { name: 'example_copy', category: 'engagement' },
              { name: 'docs_search', category: 'navigation' },
              { name: 'spec_download', category: 'conversion' }
            ],
            generatedAt: new Date().toISOString()
          };

          fs.writeFileSync('./website/public/analytics-config.json', JSON.stringify(config, null, 2));
          console.log('Analytics config generated:', config.enabled ? 'ENABLED' : 'DISABLED');
        outputs:
          - analytics-config.json

    # ========================================
    # 4. Structured Data Validation
    # ========================================
    - id: validate-structured-data
      name: Validate Schema.org Data
      type: validation
      config:
        schemas:
          - type: Organization
            required: [name, url, logo]
          - type: WebSite
            required: [name, url, potentialAction]
          - type: Article
            required: [headline, datePublished, author]
          - type: TechArticle
            required: [headline, description]

    # ========================================
    # 5. Link Checking
    # ========================================
    - id: check-links
      name: Check Internal Links
      type: script
      config:
        runtime: node
        script: |
          const glob = require('glob');
          const fs = require('fs');

          const files = glob.sync('website/**/*.{tsx,mdx,md}');
          const brokenLinks = [];
          const linkPattern = /href=["']([^"']+)["']/g;

          files.forEach(file => {
            const content = fs.readFileSync(file, 'utf8');
            let match;
            while ((match = linkPattern.exec(content)) !== null) {
              const link = match[1];
              // Check internal links
              if (link.startsWith('/') && !link.startsWith('//')) {
                const targetPath = `website/app${link === '/' ? '' : link}`;
                if (!fs.existsSync(targetPath) && !fs.existsSync(`${targetPath}/page.tsx`)) {
                  brokenLinks.push({ file, link });
                }
              }
            }
          });

          if (brokenLinks.length > 0) {
            console.error('Broken internal links found:', brokenLinks);
            fs.writeFileSync('./broken-links.json', JSON.stringify(brokenLinks, null, 2));
          }
        outputs:
          - broken-links.json

    # ========================================
    # 6. SEO Audit Report
    # ========================================
    - id: generate-report
      name: Generate SEO Audit Report
      type: report
      dependsOn:
        - validate-sitemap
        - extract-meta
        - validate-structured-data
        - check-links
      config:
        format: markdown
        output: seo-audit-report.md
        template: |
          # SEO Audit Report

          **Generated**: {{timestamp}}
          **Site**: {{site_url}}
          **Branch**: {{branch}}

          ## Summary

          | Metric | Status | Count |
          |--------|--------|-------|
          | Pages | {{pages_status}} | {{pages_count}} |
          | Meta Tags | {{meta_status}} | {{meta_count}} |
          | Structured Data | {{schema_status}} | {{schema_count}} |
          | Broken Links | {{links_status}} | {{broken_links_count}} |

          ## Sitemap

          - Total URLs: {{sitemap_urls}}
          - Last Modified: {{sitemap_modified}}

          ## Analytics

          - GA4 Enabled: {{ga_enabled}}
          - Measurement ID: {{ga_id_masked}}

          ## Recommendations

          {{#each recommendations}}
          - {{this}}
          {{/each}}

    - id: notify
      name: Post Audit Results
      type: notification
      dependsOn: [generate-report]
      config:
        channels:
          - type: gitlab-comment
            condition: merge_request
            template: |
              ## üîç SEO Audit Results

              {{#if all_passed}}
              ‚úÖ All SEO checks passed
              {{else}}
              ‚ö†Ô∏è Some SEO issues found - see attached report
              {{/if}}

              üìä [Full Report]({{report_url}})

          - type: artifact
            path: seo-audit-report.md

  integrations:
    gitlab:
      api_version: v4
      token: ${GITLAB_TOKEN}
      project: blueflyio/openstandardagents.org

  monitoring:
    metrics:
      - seo_score
      - pages_audited
      - broken_links_found
      - meta_coverage_percent
    logs:
      level: info
      format: json
