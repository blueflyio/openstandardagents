apiVersion: ossa/v0.3.3
kind: Agent
metadata:
  name: release-validator
  description: Pre-release gate - validates all release requirements
  labels:
    tier: release-automation
    criticality: critical
  annotations:
    ossa.io/migration: v0.3.2-to-v0.3.3
    ossa.io/migrated-date: 2026-01-07
spec:
  role: validator
  capabilities:
    - release-validation
    - quality-gate
    - ci-integration
  triggers:
    - type: pipeline
      events:
        - merge_request
      target_branches:
        - main
      source_branches:
        - release/*
  tasks:
    - name: validate-release
      description: Comprehensive release validation
      steps:
        - name: check-examples
          action: exec
          command: npm run validate:examples
          required: true
        - name: check-tests
          action: exec
          command: npm test
          required: true
        - name: check-changelog
          action: exec
          command: >
            if [ ! -f CHANGELOG.md ]; then
              echo "ERROR: CHANGELOG.md missing"
              exit 1
            fi

            if ! grep -q "## \[${CI_COMMIT_TAG:-UNRELEASED}\]" CHANGELOG.md;
            then
              echo "ERROR: CHANGELOG.md not updated for this release"
              exit 1
            fi
        - name: check-version
          action: exec
          command: >
            PKG_VERSION=$(jq -r '.version' package.json)

            if [[ "$CI_COMMIT_TAG" != "v$PKG_VERSION" ]]; then
              echo "ERROR: package.json version ($PKG_VERSION) doesn't match tag ($CI_COMMIT_TAG)"
              exit 1
            fi
        - name: check-docs
          action: exec
          command: |
            # Ensure README mentions new features
            npm run docs:check || exit 1
        - name: check-breaking-changes
          action: exec
          command: >
            # Check if BREAKING CHANGE in commits

            if git log --grep="BREAKING CHANGE" HEAD~10..HEAD | grep -q
            "BREAKING"; then
              if ! grep -q "## Breaking Changes" CHANGELOG.md; then
                echo "ERROR: Breaking changes in commits but not documented in CHANGELOG"
                exit 1
              fi
            fi
  outputs:
    - type: ci-status
      on_success: pass
      on_failure: block
    - type: comment
      template: |
        ## üö¶ Release Validation Results

        {% if success %}
        ‚úÖ All release requirements met. Ready to merge!
        {% else %}
        ‚ùå Release validation failed. Fix the following:
        {{ failures }}
        {% endif %}
