# ============================================================================
# OSSA Database Migrator Agent - GitLab Kubernetes Deployment
# ============================================================================
#
# PURPOSE:
#   Automated database schema migration management for PostgreSQL, MySQL, and
#   MongoDB. Validates migrations, manages rollback procedures, and coordinates
#   zero-downtime deployments with application updates.
#
# CAPABILITIES:
#   - Schema migration validation and dry-run
#   - Automated migration execution with transaction safety
#   - Rollback procedure generation and execution
#   - Data integrity verification (checksums, row counts)
#   - Zero-downtime migration strategies (expand-contract pattern)
#   - Multi-database coordination (PostgreSQL, MySQL, MongoDB)
#
# DEPLOYMENT:
#   Runs as supervised agent requiring approval for migrations.
#   Coordinates with rollback-coordinator for automated rollback on failure.
#
# ============================================================================

apiVersion: ossa/v0.2.x
kind: Agent

metadata:
  name: db-migrator
  version: 1.0.0
  description: |
    Automated database migration agent supporting PostgreSQL, MySQL, and MongoDB.
    Validates schema changes, executes migrations with transaction safety, generates
    rollback procedures, and verifies data integrity throughout the process.

  labels:
    environment: production
    team: data-engineering
    domain: database
    capability: schema-migration
    dora-metric: deployment-frequency

  annotations:
    documentation: https://openstandardagents.org/docs/agents/db-migrator
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/db-migrator
    safety: "transactional-rollback-enabled"

spec:
  # ==========================================================================
  # TAXONOMY: Database Operations Domain
  # ==========================================================================
  taxonomy:
    domain: data-engineering
    subdomain: schema-management
    capability: automated-migrations

  # ==========================================================================
  # ROLE: Database Migration Expertise
  # ==========================================================================
  role: |
    You are an expert database migration engineer specializing in safe, zero-downtime deployments.

    Your responsibilities:
    1. Validate migration scripts for syntax errors, performance risks, and data loss potential
    2. Execute migrations with transaction safety (BEGIN/COMMIT/ROLLBACK)
    3. Generate automatic rollback procedures for every forward migration
    4. Verify data integrity using checksums, row counts, and constraint validation
    5. Implement zero-downtime strategies (expand-contract, dual-writes, backfill)
    6. Coordinate with application deployments for synchronized schema changes
    7. Monitor migration performance and detect long-running locks/deadlocks
    8. Communicate with rollback-coordinator for automated failure recovery

    Migration Safety Checklist:
    - Dry-run in staging environment first
    - Generate rollback SQL before executing forward migration
    - Use transactions for DDL where supported (PostgreSQL)
    - Avoid full table locks (use CONCURRENTLY for indexes in PostgreSQL)
    - Validate constraints in separate transaction after data migration
    - Monitor query performance impact (pg_stat_statements, slow query log)
    - Verify replication lag doesn't exceed 5 seconds

    For each migration:
    - Risk level (low/medium/high/critical)
    - Estimated duration
    - Downtime required (none/seconds/minutes)
    - Rollback procedure (auto-generated SQL)
    - Data integrity checks (checksums, row counts)

  # ==========================================================================
  # LLM CONFIGURATION: High-Precision SQL Analysis
  # ==========================================================================
  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.0  # Deterministic for SQL safety
    maxTokens: 10000  # Large context for complex migrations

  # ==========================================================================
  # TOOLS: Database Management & Migration
  # ==========================================================================
  tools:
    # PostgreSQL migration engine
    - type: mcp
      name: postgres-migrator
      description: |
        Execute PostgreSQL migrations using transactional DDL. Supports
        schema changes, data migrations, and integrity validation.
      config:
        server: postgres-mcp
        database: application_db
        transactionMode: serializable
      auth:
        type: password
        passwordPath: /var/secrets/postgres-admin-password

    # MySQL migration engine
    - type: mcp
      name: mysql-migrator
      description: |
        Execute MySQL migrations with online DDL (ALGORITHM=INPLACE, LOCK=NONE).
        Supports pt-online-schema-change for large tables.
      config:
        server: mysql-mcp
        database: application_db
        onlineAlgorithm: true
      auth:
        type: password
        passwordPath: /var/secrets/mysql-admin-password

    # MongoDB schema validator
    - type: mcp
      name: mongodb-validator
      description: |
        Validate MongoDB schema changes and execute migrations with
        transaction support (replica sets only).
      config:
        server: mongodb-mcp
        database: application_db
        replicaSet: rs0
      auth:
        type: password
        passwordPath: /var/secrets/mongodb-admin-password

    # Migration version control (Flyway/Liquibase)
    - type: http
      name: flyway-api
      description: |
        Manage migration versioning, track applied migrations, and
        generate migration metadata using Flyway.
      endpoint: http://flyway-server:8080/api/v1
      config:
        method: POST
        timeout: 300
      auth:
        type: bearer
        tokenPath: /var/secrets/flyway-token

    # Data integrity validator
    - type: function
      name: integrity-checker
      description: |
        Calculate checksums, row counts, and constraint violations
        before and after migrations for data integrity verification.
      config:
        handler: integrity_check_handler
        algorithms: [md5, sha256, row_count, constraint_check]

    # Agent-to-Agent: rollback coordination
    - type: a2a
      name: rollback-coordinator
      description: |
        Communicate with rollback-coordinator agent to trigger automated
        rollback if migration fails or data integrity checks fail.
      endpoint: http://rollback-coordinator:8080/a2a
      config:
        protocol: json-rpc
        version: "2.0"
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem

  # ==========================================================================
  # AUTONOMY: Supervised (Requires Approval for Production Migrations)
  # ==========================================================================
  autonomy:
    level: supervised
    approval_required: true  # All production migrations require approval

    allowed_actions:
      - validate_migration_syntax
      - dry_run_migration_staging
      - generate_rollback_sql
      - check_data_integrity
      - read_migration_history

    blocked_actions:
      - execute_production_migration  # Requires approval
      - drop_tables
      - drop_databases
      - disable_constraints

  # ==========================================================================
  # CONSTRAINTS: Migration Execution Limits
  # ==========================================================================
  constraints:
    cost:
      maxTokensPerDay: 200000
      maxTokensPerRequest: 10000
      maxCostPerDay: 20.00
      currency: USD

    performance:
      maxLatencySeconds: 600  # 10 min for large migrations
      maxConcurrentRequests: 1  # Serial migration execution only
      timeoutSeconds: 1800  # 30 min migration timeout

    resources:
      cpu: "500m"
      memory: "1Gi"
      ephemeralStorage: "2Gi"

  # ==========================================================================
  # OBSERVABILITY: Migration Audit Trail
  # ==========================================================================
  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318
      samplingRate: 1.0  # 100% trace all migrations

    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: migrations_executed_total
          type: counter
          description: "Total migrations executed"
          labels: [database_type, status, risk_level]
        - name: migration_duration_seconds
          type: histogram
          description: "Migration execution duration"
        - name: rollbacks_triggered_total
          type: counter
          description: "Total rollbacks triggered"

    logging:
      level: info
      format: json
      auditLog:
        enabled: true
        destination: /var/log/database/migration-audit.log
        retention: 7years  # 7 year retention for compliance

  # ==========================================================================
  # STATE: Migration History & Rollback Procedures
  # ==========================================================================
  state:
    backend: postgres
    config:
      host: postgres-primary.default.svc.cluster.local
      port: 5432
      database: migration_metadata
      schema: flyway_schema_history
      ssl: true
      sslMode: require

  # ==========================================================================
  # EXTENSIONS: kAgent Kubernetes Integration
  # ==========================================================================
  extensions:
    kagent:
      kubernetes:
        namespace: data-system

        labels:
          app: db-migrator
          team: data-engineering
          dora-metric: deployment-frequency

        annotations:
          description: "Automated database migration agent"
          contact: "ops@openstandardagents.org"
          safety: "transactional-rollback-enabled"

        resourceLimits:
          cpu: "500m"
          memory: "1Gi"
          ephemeralStorage: "2Gi"

        serviceAccount: db-migrator-sa

        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

      guardrails:
        requireApproval: true  # Mandatory approval for production

        costLimits:
          maxTokensPerDay: 200000
          maxCostPerDay: 20.00
          currency: USD

        allowedActions:
          - postgres:select:*
          - postgres:insert:flyway_schema_history
          - postgres:execute:migration  # With approval only
          - mysql:execute:migration
          - mongodb:execute:migration

        auditLog:
          destination: compliance-engine
          retention: 7years

      a2aConfig:
        enabled: true
        protocol: json-rpc

        endpoints:
          - http://rollback-coordinator:8080/a2a
          - http://monitoring-agent:8080/a2a

        authentication:
          type: mtls
          certPath: /var/secrets/a2a-client-cert.pem
          keyPath: /var/secrets/a2a-client-key.pem

      meshIntegration:
        enabled: true
        istioIntegration: true
        ambientMesh: true
        mtlsMode: STRICT

# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
#
# Migration Workflow:
#   1. Developer creates migration file (V001__add_user_table.sql)
#   2. CI/CD triggers db-migrator agent
#   3. Agent validates syntax and generates rollback SQL
#   4. Agent executes dry-run in staging
#   5. Agent requests approval for production migration
#   6. Human approves via GitLab UI
#   7. Agent executes production migration in transaction
#   8. Agent verifies data integrity (checksums, row counts)
#   9. If failure: rollback-coordinator triggers automatic rollback
#   10. Agent records migration in flyway_schema_history
#
# Zero-Downtime Strategy (Expand-Contract):
#   Phase 1 (Expand): Add new column with default value
#   Phase 2 (Dual-Write): Application writes to both old and new columns
#   Phase 3 (Backfill): Migrate data from old to new column
#   Phase 4 (Contract): Remove old column after all data migrated
#
# Prerequisites:
#   - Flyway server for migration version control
#   - PostgreSQL primary with read replicas
#   - Staging environment mirroring production schema
#   - Backup verified within last 24 hours
#
# ============================================================================
