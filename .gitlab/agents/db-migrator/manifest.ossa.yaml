apiVersion: ossa/v0.3.2
kind: Agent
metadata:
  name: db-migrator
  version: 1.0.0
  description: |
    Automated database migration agent supporting PostgreSQL, MySQL, and MongoDB.
    Validates schema changes, executes migrations with transaction safety, generates
    rollback procedures, and verifies data integrity throughout the process.
  labels:
    environment: production
    team: data-engineering
    domain: database
    capability: schema-migration
    dora-metric: deployment-frequency
    ossa-version: v0.3.0
  annotations:
    documentation: https://openstandardagents.org/docs/agents/db-migrator
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/db-migrator
    safety: transactional-rollback-enabled
spec:
  taxonomy:
    domain: data-engineering
    subdomain: schema-management
    capability: automated-migrations
  role: |
    You are an expert database migration engineer specializing in safe, zero-downtime deployments.

    Your responsibilities:
    1. Validate migration scripts for syntax errors, performance risks, and data loss potential
    2. Execute migrations with transaction safety (BEGIN/COMMIT/ROLLBACK)
    3. Generate automatic rollback procedures for every forward migration
    4. Verify data integrity using checksums, row counts, and constraint validation
    5. Implement zero-downtime strategies (expand-contract, dual-writes, backfill)
    6. Coordinate with application deployments for synchronized schema changes
    7. Monitor migration performance and detect long-running locks/deadlocks
    8. Communicate with rollback-coordinator for automated failure recovery

    Migration Safety Checklist:
    - Dry-run in staging environment first
    - Generate rollback SQL before executing forward migration
    - Use transactions for DDL where supported (PostgreSQL)
    - Avoid full table locks (use CONCURRENTLY for indexes in PostgreSQL)
    - Validate constraints in separate transaction after data migration
    - Monitor query performance impact (pg_stat_statements, slow query log)
    - Verify replication lag doesn't exceed 5 seconds

    For each migration:
    - Risk level (low/medium/high/critical)
    - Estimated duration
    - Downtime required (none/seconds/minutes)
    - Rollback procedure (auto-generated SQL)
    - Data integrity checks (checksums, row counts)
  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-sonnet}
    temperature: 0
    maxTokens: 10000
    fallback_models:
      - provider: ${LLM_FALLBACK_PROVIDER_1:-openai}
        model: ${LLM_FALLBACK_MODEL_1:-gpt-4o}
      - provider: ${LLM_FALLBACK_PROVIDER_2:-anthropic}
        model: ${LLM_FALLBACK_MODEL_2:-claude-haiku}
    retry_config:
      max_attempts: 3
      backoff_strategy: exponential
    cost_tracking:
      enabled: true
      budget_alert_threshold: 25
      cost_allocation_tags:
        project: ossa-agents
        team: data-engineering
        service: db-migrator
  tools:
    - type: mcp
      name: postgres-migrator
      description: |
        Execute PostgreSQL migrations using transactional DDL. Supports
        schema changes, data migrations, and integrity validation.
      config:
        server: postgres-mcp
        database: application_db
        transactionMode: serializable
      auth:
        type: password
        passwordPath: /var/secrets/postgres-admin-password
    - type: mcp
      name: mysql-migrator
      description: |
        Execute MySQL migrations with online DDL (ALGORITHM=INPLACE, LOCK=NONE).
        Supports pt-online-schema-change for large tables.
      config:
        server: mysql-mcp
        database: application_db
        onlineAlgorithm: true
      auth:
        type: password
        passwordPath: /var/secrets/mysql-admin-password
    - type: mcp
      name: mongodb-validator
      description: |
        Validate MongoDB schema changes and execute migrations with
        transaction support (replica sets only).
      config:
        server: mongodb-mcp
        database: application_db
        replicaSet: rs0
      auth:
        type: password
        passwordPath: /var/secrets/mongodb-admin-password
    - type: http
      name: flyway-api
      description: |
        Manage migration versioning, track applied migrations, and
        generate migration metadata using Flyway.
      endpoint: http://flyway-server:8080/api/v1
      config:
        method: POST
        timeout: 300
      auth:
        type: bearer
        tokenPath: /var/secrets/flyway-token
    - type: function
      name: integrity-checker
      description: |
        Calculate checksums, row counts, and constraint violations
        before and after migrations for data integrity verification.
      config:
        handler: integrity_check_handler
        algorithms:
          - md5
          - sha256
          - row_count
          - constraint_check
    - type: a2a
      name: rollback-coordinator
      description: |
        Communicate with rollback-coordinator agent to trigger automated
        rollback if migration fails or data integrity checks fail.
      endpoint: http://rollback-coordinator:8080/a2a
      config:
        protocol: json-rpc
        version: "2.0"
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem
  autonomy:
    level: supervised
    approval_required: true
    allowed_actions:
      - validate_migration_syntax
      - dry_run_migration_staging
      - generate_rollback_sql
      - check_data_integrity
      - read_migration_history
    blocked_actions:
      - execute_production_migration
      - drop_tables
      - drop_databases
      - disable_constraints
  constraints:
    cost:
      maxTokensPerDay: 200000
      maxTokensPerRequest: 10000
      maxCostPerDay: 20
      currency: USD
    performance:
      maxLatencySeconds: 600
      maxConcurrentRequests: 1
      timeoutSeconds: 1800
    resources:
      cpu: 500m
      memory: 1Gi
      ephemeralStorage: 2Gi
  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318
      samplingRate: 1
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: migrations_executed_total
          type: counter
          description: Total migrations executed
          labels:
            - database_type
            - status
            - risk_level
        - name: migration_duration_seconds
          type: histogram
          description: Migration execution duration
        - name: rollbacks_triggered_total
          type: counter
          description: Total rollbacks triggered
    logging:
      level: info
      format: json
      auditLog:
        enabled: true
        destination: /var/log/database/migration-audit.log
        retention: 7years
  state:
    backend: postgres
    config:
      host: postgres-primary.default.svc.cluster.local
      port: 5432
      database: migration_metadata
      schema: flyway_schema_history
      ssl: true
      sslMode: require
  extensions:
    kagent:
      kubernetes:
        namespace: data-system
        labels:
          app: db-migrator
          team: data-engineering
          dora-metric: deployment-frequency
        annotations:
          description: Automated database migration agent
          contact: ops@openstandardagents.org
          safety: transactional-rollback-enabled
        resourceLimits:
          cpu: 500m
          memory: 1Gi
          ephemeralStorage: 2Gi
        serviceAccount: db-migrator-sa
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
      guardrails:
        requireApproval: true
        costLimits:
          maxTokensPerDay: 200000
          maxCostPerDay: 20
          currency: USD
        allowedActions:
          - postgres:select:*
          - postgres:insert:flyway_schema_history
          - postgres:execute:migration
          - mysql:execute:migration
          - mongodb:execute:migration
        auditLog:
          destination: compliance-engine
          retention: 7years
      a2aConfig:
        enabled: true
        protocol: json-rpc
        endpoints:
          - http://rollback-coordinator:8080/a2a
          - http://monitoring-agent:8080/a2a
        authentication:
          type: mtls
          certPath: /var/secrets/a2a-client-cert.pem
          keyPath: /var/secrets/a2a-client-key.pem
      meshIntegration:
        enabled: true
        istioIntegration: true
        ambientMesh: true
        mtlsMode: STRICT
extensions:
  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: agent-system
      labels:
        app.kubernetes.io/name: db-migrator
        app.kubernetes.io/part-of: ossa-showcase
        openstandardagents.org/version: v0.3.0
      resourceLimits:
        cpu: "1"
        memory: 2Gi
    deployment:
      replicas:
        min: 1
        max: 3
      strategy: rolling-update
    a2aConfig:
      enabled: true
      protocol: json-rpc
    meshIntegration:
      enabled: true
      istioIntegration: true
  gitlab_duo:
    enabled: true
    flow_execution: true
    model: ${GITLAB_DUO_MODEL:-claude-sonnet-4.5-20250929}
    knowledge_graph:
      enabled: true
      index_on_push: true
  mcp:
    enabled: true
    server_type: stdio
    server_name: db-migrator-mcp
