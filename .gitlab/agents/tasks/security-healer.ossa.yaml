apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: security-healer
  version: "1.0.0"
  description: Autonomous security vulnerability detection and remediation
  labels:
    environment: production
    purpose: security-healing
    team: security

spec:
  role: |
    You are a security healer agent for OSSA.

    Responsibilities:
    1. Scan for security vulnerabilities (SAST, dependency scanning, secrets)
    2. Auto-fix common security issues
    3. Rotate expired credentials and tokens
    4. Update vulnerable dependencies
    5. Apply security patches
    6. Enforce security best practices
    7. Create security issues for manual review
    8. Monitor for new CVEs affecting dependencies

    Security Checks:
    - Dependency Vulnerabilities (npm audit, Snyk)
    - Secrets in Code (GitLab Secret Detection, TruffleHog)
    - SAST Issues (Semgrep, ESLint security rules)
    - Container Vulnerabilities (Trivy)
    - License Compliance (FOSSA)
    - API Security (rate limiting, authentication)
    - Input Validation (injection attacks)
    - Secure Defaults (HTTPS, encryption, CSP)

    Auto-Fix Capabilities:
    - Update vulnerable npm packages
    - Remove hardcoded secrets (replace with env vars)
    - Fix ESLint security warnings
    - Add missing input validation
    - Enable security headers (CSP, HSTS, X-Frame-Options)
    - Implement rate limiting
    - Add authentication where missing
    - Fix SQL injection vulnerabilities
    - Patch XSS vulnerabilities

    Manual Review Required:
    - Breaking dependency updates
    - Architecture changes
    - Authentication system changes
    - Encryption key rotation
    - Security policy changes

    Severity Levels:
    - Critical (CVE 9.0+): Immediate auto-fix + alert
    - High (CVE 7.0-8.9): Auto-fix + create issue
    - Medium (CVE 4.0-6.9): Create issue + auto-fix PR
    - Low (CVE 0.1-3.9): Create issue (batch fixes)

  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.1
    max_tokens: 4000

  capabilities:
    - name: scan_dependencies
      description: Scan npm dependencies for vulnerabilities
    - name: scan_secrets
      description: Detect hardcoded secrets
    - name: scan_sast
      description: Run SAST analysis
    - name: update_dependency
      description: Update vulnerable package
    - name: remove_secret
      description: Replace secret with env var
    - name: fix_injection
      description: Fix SQL/XSS injection
    - name: add_validation
      description: Add input validation
    - name: add_security_headers
      description: Add security HTTP headers
    - name: rotate_credential
      description: Rotate expired credential
    - name: create_security_issue
      description: Create security issue

  safety:
    input_validation:
      max_length: 100000
    output_validation:
      require_citations: true
      max_tokens: 4000
    approval_required:
      - breaking_changes
      - auth_changes
      - encryption_changes

  constraints:
    max_cost_per_run: 3.00
    timeout_seconds: 600

  dependencies:
    - type: service
      name: gitlab-api
      version: v4
      optional: false
    - type: cli
      name: npm
      version: latest
      optional: false
    - type: cli
      name: semgrep
      version: latest
      optional: true

  observability:
    tracing:
      enabled: true
      provider: opentelemetry
    logging:
      level: info
      structured: true
    metrics:
      enabled: true
      track_costs: true
      track_latency: true
      custom_labels:
        agent_type: security-healer
        environment: production
        severity_tracked: "true"

  lifecycle:
    state: active
    maturity: stable
