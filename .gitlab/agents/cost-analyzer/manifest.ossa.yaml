# ============================================================================
# OSSA Cost Analyzer Agent - GitLab Kubernetes Deployment
# ============================================================================
#
# PURPOSE:
#   Automated cloud cost analysis and optimization for Kubernetes workloads.
#   Tracks resource usage, identifies cost optimization opportunities, and
#   provides recommendations for right-sizing, spot instances, and reserved capacity.
#
# CAPABILITIES:
#   - Real-time cost tracking per namespace/pod/service
#   - Idle resource detection (underutilized pods)
#   - Right-sizing recommendations (CPU/memory optimization)
#   - Spot instance vs on-demand cost comparison
#   - Reserved instance purchase recommendations
#   - Cost allocation and chargeback reporting
#
# ============================================================================

apiVersion: ossa/v0.2.8
kind: Agent

metadata:
  name: cost-analyzer
  version: 1.0.0
  description: |
    Automated cloud cost analysis and optimization agent for Kubernetes.
    Tracks resource costs, detects waste, and provides actionable recommendations
    for right-sizing, spot instances, and reserved capacity purchases.

  labels:
    environment: production
    team: finops
    domain: cost-management
    capability: optimization
    financial-impact: high

  annotations:
    documentation: https://openstandardagents.org/docs/agents/cost-analyzer
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/cost-analyzer
    target: "20% cost reduction in 90 days"

spec:
  taxonomy:
    domain: financial-operations
    subdomain: cost-optimization
    capability: analysis

  role: |
    You are an expert FinOps engineer specializing in Kubernetes cost optimization.

    Your responsibilities:
    1. Track real-time costs per namespace, pod, and service
    2. Identify idle resources (CPU/memory utilization < 20% for 7+ days)
    3. Recommend right-sizing (reduce CPU/memory based on actual usage)
    4. Compare spot instance vs on-demand costs for non-production workloads
    5. Recommend reserved instance purchases for stable production workloads
    6. Generate cost allocation reports for chargeback to teams
    7. Detect cost anomalies (unexpected spikes, new expensive resources)
    8. Coordinate with performance-optimizer for cost-aware optimizations

    Cost Optimization Priorities:
    1. Eliminate waste (idle resources, oversized pods)
    2. Right-size production workloads (reduce overprovisioning)
    3. Use spot instances for dev/test/batch workloads (60-90% savings)
    4. Purchase reserved instances for stable production (30-70% savings)
    5. Implement autoscaling to match demand (HPA/VPA/Cluster Autoscaler)

    For each recommendation:
    - Current monthly cost
    - Optimized monthly cost
    - Estimated savings ($ and %)
    - Implementation effort (low/medium/high)
    - Risk level (safe/moderate/high-risk)

  llm:
    provider: openai
    model: gpt-4-turbo
    temperature: 0.1
    maxTokens: 7000

  tools:
    - type: http
      name: kubecost-api
      description: |
        Query Kubecost for real-time cost data per namespace, pod, and service.
      endpoint: http://kubecost-cost-analyzer:9090/model
      config:
        method: GET
        timeout: 30

    - type: http
      name: aws-cost-explorer
      description: |
        Query AWS Cost Explorer API for EC2, EBS, and data transfer costs.
      endpoint: https://ce.us-east-1.amazonaws.com
      config:
        method: POST
        timeout: 15
      auth:
        type: aws-sigv4
        accessKeyPath: /var/secrets/aws-access-key
        secretKeyPath: /var/secrets/aws-secret-key

    - type: mcp
      name: kubernetes-metrics
      description: |
        Access Kubernetes metrics for resource usage analysis.
      config:
        server: kubernetes-mcp
        metricsServer: metrics.k8s.io

    - type: http
      name: prometheus-query
      description: |
        Query Prometheus for historical resource usage patterns.
      endpoint: http://prometheus:9090/api/v1/query_range
      config:
        method: POST
        timeout: 30

    - type: a2a
      name: performance-optimizer
      description: |
        Coordinate with performance-optimizer for cost-aware optimizations.
      endpoint: http://performance-optimizer:8080/a2a
      config:
        protocol: json-rpc
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem

    - type: http
      name: slack-webhook
      description: |
        Send cost reports and recommendations to Slack.
      endpoint: https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX
      config:
        method: POST
        timeout: 5

  autonomy:
    level: autonomous
    approval_required: false

    allowed_actions:
      - query_cost_data
      - analyze_resource_usage
      - generate_cost_reports
      - detect_cost_anomalies
      - recommend_optimizations

    blocked_actions:
      - apply_right_sizing  # Requires human approval
      - purchase_reserved_instances
      - terminate_resources

  constraints:
    cost:
      maxTokensPerDay: 250000
      maxTokensPerRequest: 7000
      maxCostPerDay: 25.00
      currency: USD

    performance:
      maxLatencySeconds: 60
      maxConcurrentRequests: 10
      timeoutSeconds: 120

    resources:
      cpu: "500m"
      memory: "1Gi"

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318

    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: monthly_cost_usd
          type: gauge
          description: "Total monthly Kubernetes cost"
          labels: [namespace, workload_type]
        - name: potential_savings_usd
          type: gauge
          description: "Potential monthly savings from recommendations"
        - name: cost_anomalies_detected_total
          type: counter
          description: "Cost anomalies detected"

    logging:
      level: info
      format: json

  state:
    backend: postgres
    config:
      host: postgres-primary.default.svc.cluster.local
      port: 5432
      database: cost_analysis
      schema: cost_data
      ssl: true

  extensions:
    kagent:
      kubernetes:
        namespace: finops-system
        labels:
          app: cost-analyzer
          team: finops
        resourceLimits:
          cpu: "500m"
          memory: "1Gi"
        serviceAccount: cost-analyzer-sa

      guardrails:
        requireApproval: false

        allowedActions:
          - kubecost:query:*
          - aws:describe:*
          - prometheus:query:*

      a2aConfig:
        enabled: true
        protocol: json-rpc
        endpoints:
          - http://performance-optimizer:8080/a2a
        authentication:
          type: mtls

      meshIntegration:
        enabled: true
        istioIntegration: true
        mtlsMode: STRICT

# ============================================================================
# COST OPTIMIZATION STRATEGIES
# ============================================================================
#
# 1. Idle Resource Elimination:
#    - Detect pods with CPU < 20% and memory < 20% for 7+ days
#    - Recommend termination or downsizing
#    - Estimated savings: $5,000-10,000/month
#
# 2. Right-Sizing:
#    - Analyze actual CPU/memory usage vs requests/limits
#    - Recommend reducing requests by 30-50% if consistently underutilized
#    - Estimated savings: $15,000-25,000/month
#
# 3. Spot Instances:
#    - Identify dev/test/batch workloads safe for interruption
#    - Recommend spot instance node pools (60-90% savings)
#    - Estimated savings: $20,000-40,000/month
#
# 4. Reserved Instances:
#    - Analyze production workload stability (7+ day consistent usage)
#    - Recommend 1-year or 3-year reserved instances (30-70% savings)
#    - Estimated savings: $30,000-50,000/month
#
# 5. Autoscaling:
#    - Implement HPA for CPU/memory-based scaling
#    - Implement VPA for automatic pod right-sizing
#    - Implement Cluster Autoscaler for node scaling
#    - Estimated savings: $10,000-20,000/month
#
# TOTAL POTENTIAL SAVINGS: $80,000-145,000/month (20-35% reduction)
#
# ============================================================================
