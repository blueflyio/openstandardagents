apiVersion: ossa/v0.3.2
kind: Agent
metadata:
  name: cost-analyzer
  version: 1.0.0
  description: |
    Automated cloud cost analysis and optimization agent for Kubernetes.
    Tracks resource costs, detects waste, and provides actionable recommendations
    for right-sizing, spot instances, and reserved capacity purchases.
  labels:
    environment: production
    team: finops
    domain: cost-management
    capability: optimization
    financial-impact: high
    ossa-version: v0.3.0
  annotations:
    documentation: https://openstandardagents.org/docs/agents/cost-analyzer
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/cost-analyzer
    target: 20% cost reduction in 90 days
spec:
  taxonomy:
    domain: infrastructure
    subdomain: cost-optimization
    capability: cost_analysis
  role: |
    You are an expert FinOps engineer specializing in Kubernetes cost optimization.

    Your responsibilities:
    1. Track real-time costs per namespace, pod, and service
    2. Identify idle resources (CPU/memory utilization < 20% for 7+ days)
    3. Recommend right-sizing (reduce CPU/memory based on actual usage)
    4. Compare spot instance vs on-demand costs for non-production workloads
    5. Recommend reserved instance purchases for stable production workloads
    6. Generate cost allocation reports for chargeback to teams
    7. Detect cost anomalies (unexpected spikes, new expensive resources)
    8. Coordinate with performance-optimizer for cost-aware optimizations

    Cost Optimization Priorities:
    1. Eliminate waste (idle resources, oversized pods)
    2. Right-size production workloads (reduce overprovisioning)
    3. Use spot instances for dev/test/batch workloads (60-90% savings)
    4. Purchase reserved instances for stable production (30-70% savings)
    5. Implement autoscaling to match demand (HPA/VPA/Cluster Autoscaler)

    For each recommendation:
    - Current monthly cost
    - Optimized monthly cost
    - Estimated savings ($ and %)
    - Implementation effort (low/medium/high)
    - Risk level (safe/moderate/high-risk)
  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-sonnet}
    temperature: 0.1
    maxTokens: 7000
    topP: 0.9
    fallback_models:
      - provider: ${LLM_FALLBACK_PROVIDER_1:-openai}
        model: ${LLM_FALLBACK_MODEL_1:-gpt-4o}
      - provider: ${LLM_FALLBACK_PROVIDER_2:-anthropic}
        model: ${LLM_FALLBACK_MODEL_2:-claude-haiku}
    retry_config:
      max_attempts: 3
      backoff_strategy: exponential
    cost_tracking:
      enabled: true
      budget_alert_threshold: 20
      cost_allocation_tags:
        project: ossa-agents
        team: finops
        service: cost-analyzer
  tools:
    - type: http
      name: kubecost-api
      description: |
        Query Kubecost for real-time cost data per namespace, pod, and service.
      endpoint: http://kubecost-cost-analyzer:9090/model
      config:
        method: GET
        timeout: 30
    - type: http
      name: aws-cost-explorer
      description: |
        Query AWS Cost Explorer API for EC2, EBS, and data transfer costs.
      endpoint: https://ce.us-east-1.amazonaws.com
      config:
        method: POST
        timeout: 15
      auth:
        type: aws-sigv4
        accessKeyPath: /var/secrets/aws-access-key
        secretKeyPath: /var/secrets/aws-secret-key
    - type: mcp
      name: kubernetes-metrics
      description: |
        Access Kubernetes metrics for resource usage analysis.
      config:
        server: kubernetes-mcp
        metricsServer: metrics.k8s.io
    - type: http
      name: prometheus-query
      description: |
        Query Prometheus for historical resource usage patterns.
      endpoint: http://prometheus:9090/api/v1/query_range
      config:
        method: POST
        timeout: 30
    - type: a2a
      name: performance-optimizer
      description: |
        Coordinate with performance-optimizer for cost-aware optimizations.
      endpoint: http://performance-optimizer:8080/a2a
      config:
        protocol: json-rpc
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem
    - type: http
      name: slack-webhook
      description: |
        Send cost reports and recommendations to Slack.
        Configure SLACK_WEBHOOK_URL environment variable with your Slack webhook URL.
      endpoint: ${SLACK_WEBHOOK_URL:-}
      config:
        method: POST
        timeout: 5
      auth:
        type: bearer
        credentials: env:SLACK_WEBHOOK_URL
  autonomy:
    level: autonomous
    approval_required: false
    allowed_actions:
      - query_cost_data
      - analyze_resource_usage
      - generate_cost_reports
      - detect_cost_anomalies
      - recommend_optimizations
    blocked_actions:
      - apply_right_sizing
      - purchase_reserved_instances
      - terminate_resources
  constraints:
    cost:
      maxTokensPerDay: 250000
      maxTokensPerRequest: 7000
      maxCostPerDay: 25
      currency: USD
    performance:
      maxLatencySeconds: 60
      maxConcurrentRequests: 10
      timeoutSeconds: 120
    resources:
      cpu: 500m
      memory: 1Gi
  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: monthly_cost_usd
          type: gauge
          description: Total monthly Kubernetes cost
          labels:
            - namespace
            - workload_type
        - name: potential_savings_usd
          type: gauge
          description: Potential monthly savings from recommendations
        - name: cost_anomalies_detected_total
          type: counter
          description: Cost anomalies detected
    logging:
      level: info
      format: json
  state:
    backend: postgres
    config:
      host: postgres-primary.default.svc.cluster.local
      port: 5432
      database: cost_analysis
      schema: cost_data
      ssl: true
  reliability:
    sla:
      availability_percent: 99
      latency_p95_ms: 15000
      error_rate_percent: 1
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      timeout_seconds: 60
      half_open_requests: 3
    health_check:
      enabled: true
      interval_seconds: 30
      timeout_seconds: 5
    failover:
      enabled: false
  security:
    authentication:
      required: true
      methods:
        - mtls
        - bearer
    authorization:
      model: rbac
      roles:
        - cost-analyzer
        - finops
      permissions:
        - kubernetes:metrics:read
        - kubecost:read
        - aws:describe
    audit:
      enabled: true
      log_level: standard
      retention_days: 365
      pii_redaction: false
  safety:
    rate_limiting:
      enabled: true
      requests_per_minute: 60
      burst_limit: 20
    guardrails:
      enabled: true
      policies:
        - name: read_only_resources
          type: output
          rules:
            - no_terminate_resources
        - name: no_purchase_without_approval
          type: output
          rules:
            - no_reserved_instance_purchase
      max_tool_calls: 50
      max_execution_time_seconds: 180
  deployment:
    strategy: rolling
    rollback:
      enabled: true
      automatic: false
    versioning:
      scheme: semver
      compatibility: backward
    lifecycle:
      startup_probe:
        enabled: true
        initial_delay_seconds: 5
        period_seconds: 10
        failure_threshold: 3
      readiness_probe:
        enabled: true
        period_seconds: 10
      liveness_probe:
        enabled: true
        period_seconds: 30
      graceful_shutdown:
        enabled: true
        timeout_seconds: 30
  extensions:
    kagent:
      kubernetes:
        namespace: finops-system
        labels:
          app: cost-analyzer
          team: finops
        resourceLimits:
          cpu: 500m
          memory: 1Gi
        serviceAccount: cost-analyzer-sa
      guardrails:
        requireApproval: false
        allowedActions:
          - kubecost:query:*
          - aws:describe:*
          - prometheus:query:*
      a2aConfig:
        enabled: true
        protocol: json-rpc
        endpoints:
          - http://performance-optimizer:8080/a2a
        authentication:
          type: mtls
      meshIntegration:
        enabled: true
        istioIntegration: true
        mtlsMode: STRICT
extensions:
  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: agent-system
      labels:
        app.kubernetes.io/name: cost-analyzer
        app.kubernetes.io/part-of: ossa-showcase
        openstandardagents.org/version: v0.3.0
      resourceLimits:
        cpu: "1"
        memory: 2Gi
    deployment:
      replicas:
        min: 1
        max: 3
      strategy: rolling-update
    a2aConfig:
      enabled: true
      protocol: json-rpc
    meshIntegration:
      enabled: true
      istioIntegration: true
  gitlab_duo:
    enabled: true
    flow_execution: true
    model: ${GITLAB_DUO_MODEL:-claude-sonnet-4.5-20250929}
    knowledge_graph:
      enabled: true
      index_on_push: true
  mcp:
    enabled: true
    server_type: stdio
    server_name: cost-analyzer-mcp
