# CI/CD Optimization Agent - OSSA v0.2.9 Compliant
# Triggered by GitLab webhooks for pipeline optimization and analysis
# Part of BlueFly.io Agent Platform

apiVersion: ossa/v0.2.9
kind: Agent
metadata:
  name: ci-cd
  version: 1.0.0
  description: |
    Intelligent CI/CD optimization agent that analyzes pipeline performance,
    identifies bottlenecks, recommends caching strategies, optimizes job
    dependencies, and suggests parallelization opportunities. Integrates with
    GitLab CI/CD and monitors pipeline execution metrics.
  labels:
    domain: infrastructure
    tier: production
    agent-assigned: ci-cd
    blueflyio.com/team: platform
    blueflyio.com/service: gitlab-automation
  annotations:
    openstandardagents.org/stability: stable
    blueflyio.gitlab.com/lifecycle: ready-for-dev
    blueflyio.gitlab.com/codeowner: "@platform-team"
    blueflyio.gitlab.com/commit-type: feat
    blueflyio.gitlab.com/priority: high

spec:
  taxonomy:
    domain: infrastructure
    subdomain: ci-cd-optimization
    capability: pipeline-analysis

  role: |
    You are the CI/CD Optimization Agent, an expert in GitLab CI/CD pipeline
    performance and efficiency. Your mission is to ensure pipelines run fast,
    cost-effectively, and reliably.

    ## Core Responsibilities

    1. **Pipeline Performance Analysis**
       - Analyze pipeline execution times and identify slow jobs
       - Detect job dependencies that prevent parallelization
       - Identify redundant steps and duplicate work
       - Track pipeline duration trends over time
       - Monitor runner utilization and queue times

    2. **Caching Strategy Optimization**
       - Analyze cache hit rates and effectiveness
       - Recommend cache key strategies for better reuse
       - Identify artifacts that should be cached
       - Suggest distributed cache configurations
       - Detect stale or ineffective caches

    3. **Parallelization Opportunities**
       - Identify jobs that can run in parallel
       - Recommend DAG (Directed Acyclic Graph) optimizations
       - Suggest job splitting for faster execution
       - Analyze stage dependencies and suggest improvements
       - Recommend matrix builds for test parallelization

    4. **Resource Optimization**
       - Recommend appropriate runner tags and sizes
       - Identify over/under-provisioned resources
       - Suggest Docker layer optimizations
       - Analyze image pull times and recommend optimizations
       - Monitor runner costs and suggest cost savings

    5. **Pipeline Reliability**
       - Detect flaky tests and intermittent failures
       - Analyze retry patterns and failure rates
       - Recommend pipeline execution policies
       - Monitor error trends and suggest fixes
       - Track DORA metrics (deployment frequency, lead time, MTTR, change failure rate)

    6. **Best Practices Enforcement**
       - Validate .gitlab-ci.yml against best practices
       - Recommend security scanning integration
       - Suggest compliance checks and gates
       - Enforce pipeline templates and standards
       - Validate artifact retention policies

    ## Analysis Outputs

    For each optimization recommendation:
    - **Current State**: Baseline metrics (duration, cost, resource usage)
    - **Improvement Potential**: Expected time/cost savings
    - **Implementation Complexity**: Low/Medium/High
    - **Risk Level**: Safe/Moderate/High-risk
    - **Priority**: Critical/High/Medium/Low

    ## DORA Metrics Tracking

    Monitor and report on:
    - **Deployment Frequency**: How often deploys to production
    - **Lead Time for Changes**: Time from commit to production
    - **Mean Time to Recovery (MTTR)**: Time to restore service
    - **Change Failure Rate**: % of deployments causing failures

    ## Safety Guidelines

    - NEVER modify pipelines without approval
    - NEVER disable security scans or compliance checks
    - ALWAYS validate changes in non-production first
    - ESCALATE breaking changes to humans
    - PRESERVE pipeline history for rollback

  llm:
    provider: anthropic
    model: claude-sonnet-4-5-20250929
    temperature: 0.2  # Low temperature for consistent analysis
    maxTokens: 16000
    topP: 0.9

    fallback_models:
      - provider: openai
        model: gpt-4o
      - provider: anthropic
        model: claude-3-5-haiku-20241022

    retry_config:
      max_attempts: 3
      backoff_strategy: exponential

    cost_tracking:
      enabled: true
      budget_alert_threshold: 30.00
      cost_allocation_tags:
        project: ossa-agents
        team: platform
        service: ci-cd-optimizer

  tools:
    - type: mcp
      name: gitlab-api
      server: gitlab-mcp-server
      namespace: blueflyio
      endpoint: https://gitlab.com/api/v4

      transport:
        protocol: http
        streaming: none
        rateLimit:
          requestsPerMinute: 100
          burstLimit: 20
          strategy: token_bucket
          onExceeded: queue

      auth:
        type: bearer
        credentials: env:GITLAB_TOKEN
        scopes:
          - api
          - read_api
          - read_repository

      circuit_breaker:
        enabled: true
        failure_threshold: 5
        timeout_seconds: 60

      capabilities:
        # Pipeline Analysis
        - name: get_pipeline
          version: "2.0"
          description: Get pipeline details and status
          scopes: [read:pipelines]
          transport:
            protocol: http
            binding: GET /projects/{id}/pipelines/{pipeline_id}
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              pipeline_id: { type: integer }
            required: [project_id, pipeline_id]

        - name: list_pipelines
          version: "2.0"
          description: List project pipelines for trend analysis
          scopes: [read:pipelines]
          transport:
            protocol: http
            binding: GET /projects/{id}/pipelines
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              status:
                type: string
                enum: [running, pending, success, failed, canceled, skipped]
              per_page: { type: integer, default: 20 }
              updated_after: { type: string, format: date-time }
            required: [project_id]

        - name: get_pipeline_jobs
          version: "2.0"
          description: Get all jobs in a pipeline
          scopes: [read:pipelines]
          transport:
            protocol: http
            binding: GET /projects/{id}/pipelines/{pipeline_id}/jobs
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              pipeline_id: { type: integer }
            required: [project_id, pipeline_id]

        - name: get_job_trace
          version: "1.0"
          description: Get job execution log for analysis
          scopes: [read:pipelines]
          transport:
            protocol: http
            binding: GET /projects/{id}/jobs/{job_id}/trace
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              job_id: { type: integer }
            required: [project_id, job_id]

        # CI/CD Configuration
        - name: get_ci_config
          version: "1.0"
          description: Get .gitlab-ci.yml content
          scopes: [read:repository]
          transport:
            protocol: http
            binding: GET /projects/{id}/repository/files/.gitlab-ci.yml
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              ref: { type: string, default: main }
            required: [project_id]

        - name: validate_ci_config
          version: "1.0"
          description: Validate CI/CD configuration
          scopes: [read:repository]
          transport:
            protocol: http
            binding: POST /projects/{id}/ci/lint
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              content: { type: string }
              dry_run: { type: boolean, default: true }
            required: [project_id, content]

        # Runner Analysis
        - name: list_runners
          version: "1.0"
          description: List project runners
          scopes: [read:runners]
          transport:
            protocol: http
            binding: GET /projects/{id}/runners
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              status:
                type: string
                enum: [online, offline, stale, never_contacted]
            required: [project_id]

        - name: get_runner_jobs
          version: "1.0"
          description: Get jobs executed by a runner
          scopes: [read:runners]
          transport:
            protocol: http
            binding: GET /runners/{runner_id}/jobs
          input_schema:
            type: object
            properties:
              runner_id: { type: integer }
              status:
                type: string
                enum: [running, success, failed, canceled]
            required: [runner_id]

        # Comments & Reporting
        - name: add_pipeline_comment
          version: "1.0"
          description: Add optimization report as MR comment
          scopes: [write:notes]
          transport:
            protocol: http
            binding: POST /projects/{id}/merge_requests/{mr_iid}/notes
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
              body: { type: string }
            required: [project_id, mr_iid, body]

        # Variables Analysis
        - name: list_variables
          version: "1.0"
          description: List CI/CD variables
          scopes: [read:variables]
          transport:
            protocol: http
            binding: GET /projects/{id}/variables
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
            required: [project_id]

    - type: mcp
      name: prometheus-metrics
      server: prometheus-mcp-server
      endpoint: ${PROMETHEUS_URL:-http://prometheus:9090}

      transport:
        protocol: http
        streaming: none

      auth:
        type: bearer
        credentials: env:PROMETHEUS_TOKEN

      capabilities:
        - name: query_pipeline_metrics
          version: "1.0"
          description: Query pipeline execution metrics
          scopes: [read:metrics]
          input_schema:
            type: object
            properties:
              query: { type: string }
              start: { type: string, format: date-time }
              end: { type: string, format: date-time }
            required: [query]

  state:
    mode: long_running
    storage:
      type: kv
      retention: 30d
      config:
        provider: redis
        prefix: agent:ci-cd
        endpoint: ${REDIS_URL:-redis://localhost:6379}
      encryption:
        enabled: true
        algorithm: aes-256-gcm
        keyRef: env:AGENT_ENCRYPTION_KEY
    context_window:
      max_messages: 100
      max_tokens: 64000
      strategy: summarization

  autonomy:
    level: autonomous
    approval_required: false
    allowed_actions:
      - read_pipelines
      - read_jobs
      - read_ci_config
      - read_runners
      - analyze_performance
      - generate_reports
      - add_comments
      - query_metrics
    blocked_actions:
      - modify_ci_config
      - delete_pipelines
      - modify_runners
      - bypass_policies
    escalation_policy:
      triggers:
        - breaking_change_detected
        - security_scan_disabled
        - compliance_violation
        - critical_performance_degradation
      notify:
        - slack:#ci-cd-alerts
        - gitlab:@platform-team

  constraints:
    cost:
      maxTokensPerDay: 500000
      maxTokensPerRequest: 32000
      maxCostPerDay: 50.00
      currency: USD
    performance:
      maxLatencySeconds: 45
      maxConcurrentRequests: 10
      timeoutSeconds: 180
    resources:
      cpu: "1"
      memory: 2Gi

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://phoenix:6006/v1/traces}
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: ${PROMETHEUS_PUSHGATEWAY:-http://prometheus:9091}
      customMetrics:
        - name: pipeline_optimization_recommendations_total
          type: counter
          description: Total optimization recommendations generated
        - name: pipeline_duration_improvement_seconds
          type: gauge
          description: Estimated pipeline duration improvement
        - name: cache_hit_rate
          type: gauge
          description: CI/CD cache hit rate
        - name: job_parallelization_opportunities
          type: gauge
          description: Number of parallelization opportunities identified
    logging:
      level: info
      format: json
    alerting:
      enabled: true
      channels:
        - slack
        - webhook
      rules:
        - name: pipeline_performance_degraded
          condition: avg_pipeline_duration > 30m
          severity: warning
        - name: cache_hit_rate_low
          condition: cache_hit_rate < 0.5
          severity: info
        - name: runner_queue_high
          condition: runner_queue_length > 10
          severity: warning
    slo:
      availability: 99.0
      latency_p95_ms: 15000
      error_budget: 1.0

  security:
    authentication:
      required: true
      methods:
        - bearer
        - oauth2
    authorization:
      model: rbac
      roles:
        - ci-cd-optimizer
        - agent-operator
      permissions:
        - pipelines:read
        - jobs:read
        - runners:read
        - repository:read
    encryption:
      in_transit:
        enabled: true
        tls_version: "1.3"
      at_rest:
        enabled: true
        algorithm: aes-256-gcm
        key_management: vault
    secrets:
      provider: vault
      rotation:
        enabled: true
        interval_days: 90
    audit:
      enabled: true
      log_level: standard
      retention_days: 365
      pii_redaction: true
    compliance:
      frameworks:
        - soc2
      data_residency:
        - US

  reliability:
    sla:
      availability_percent: 99.0
      latency_p95_ms: 15000
      error_rate_percent: 1.0
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      timeout_seconds: 60
      half_open_requests: 3
    health_check:
      enabled: true
      interval_seconds: 30
      timeout_seconds: 5
    failover:
      enabled: true
      strategy: active-passive

  collaboration:
    mode: collaborative
    handoffs:
      - target_agent: mr-manager
        conditions:
          - pipeline_optimization_complete
        context_transfer: partial
      - target_agent: performance-optimizer
        conditions:
          - resource_optimization_needed
        context_transfer: partial
      - target_agent: security-scanner
        conditions:
          - security_scan_optimization_needed
        context_transfer: minimal
    delegation:
      enabled: true
      allowed_agents:
        - performance-optimizer
        - cost-analyzer
      max_depth: 2
    communication:
      protocols:
        - mcp
        - http
      message_format: json

  safety:
    content_filtering:
      enabled: true
      categories:
        - pii
        - credentials
      threshold: high
      action: block
    pii_detection:
      enabled: true
      types:
        - email
        - phone
        - api_key
        - password
      action: redact
    rate_limiting:
      enabled: true
      requests_per_minute: 100
      burst_limit: 20
    guardrails:
      enabled: true
      policies:
        - name: preserve_security_scans
          type: output
          rules:
            - no_disable_security_scans
        - name: no_breaking_changes
          type: output
          rules:
            - validate_before_modify
      max_tool_calls: 100
      max_execution_time_seconds: 600
    human_in_loop:
      enabled: true
      triggers:
        - high_risk_action
        - breaking_change
        - compliance_change

  deployment:
    strategy: rolling
    rollback:
      enabled: true
      automatic: true
    versioning:
      scheme: semver
      compatibility: backward
    lifecycle:
      startup_probe:
        enabled: true
        initial_delay_seconds: 5
        period_seconds: 10
        failure_threshold: 3
      readiness_probe:
        enabled: true
        period_seconds: 10
      liveness_probe:
        enabled: true
        period_seconds: 30
      graceful_shutdown:
        enabled: true
        timeout_seconds: 30

extensions:
  buildkit:
    deployment:
      replicas:
        min: 1
        max: 3
    container:
      image: ghcr.io/blueflyio/agent-ci-cd:1.0.0
      runtime: docker
      resources:
        limits:
          cpu: "1"
          memory: 2Gi
    gitlab:
      custom_fields:
        agent_assigned: ci-cd
        agent_status: ready-for-dev
        commit_type: feat
        priority: high

  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: agent-system
      labels:
        app.kubernetes.io/name: ci-cd
        app.kubernetes.io/part-of: blueflyio-agents
        blueflyio.com/agent-type: ci-cd
    deployment:
      replicas: 2
      strategy: rolling-update

  mcp:
    enabled: true
    server_type: stdio
    server_name: ci-cd-mcp
    tools:
      - name: analyze_pipeline
        description: Analyze pipeline performance and generate optimization report
        inputSchema:
          type: object
          properties:
            project_id: { type: integer }
            pipeline_id: { type: integer }
          required: [project_id, pipeline_id]
      - name: recommend_optimizations
        description: Generate optimization recommendations for project
        inputSchema:
          type: object
          properties:
            project_id: { type: integer }
            analysis_period_days: { type: integer, default: 30 }
          required: [project_id]

  a2a:
    enabled: true
    agent_card:
      name: CI/CD Optimization Agent
      description: GitLab CI/CD pipeline performance analysis and optimization
      url: https://agents.blueflyio.com/ci-cd
      version: 1.0.0
      capabilities:
        - pipeline_analysis
        - cache_optimization
        - parallelization
        - dora_metrics
        - cost_optimization
      authentication:
        schemes:
          - bearer
      provider:
        organization: BlueFly.io
        url: https://blueflyio.com
    supported_content_types:
      - application/json
    skills:
      - id: optimize_pipeline
        name: Optimize Pipeline
        description: Analyze and optimize GitLab CI/CD pipelines
        input_modes: [data]
        output_modes: [text, data]
    streaming: none
