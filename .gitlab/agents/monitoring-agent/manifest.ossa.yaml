# ============================================================================
# OSSA Monitoring Agent - GitLab Kubernetes Deployment
# ============================================================================
#
# PURPOSE:
#   Real-time monitoring and alerting for Kubernetes workloads. Analyzes
#   Prometheus metrics, detects anomalies, correlates events, and triggers
#   automated remediation workflows.
#
# CAPABILITIES:
#   - Prometheus metrics analysis and anomaly detection
#   - Alert correlation and noise reduction
#   - SLO/SLI tracking and burn rate calculation
#   - Automated incident response (create tickets, page on-call)
#   - Root cause analysis using distributed traces
#   - DORA metrics calculation (deployment frequency, lead time, MTTR, CFR)
#
# ============================================================================

apiVersion: ossa/v0.2.x
kind: Agent

metadata:
  name: monitoring-agent
  version: 1.0.0
  description: |
    Real-time monitoring and observability agent for Kubernetes workloads.
    Analyzes metrics, detects anomalies, correlates alerts, tracks SLOs,
    and triggers automated incident response workflows.

  labels:
    environment: production
    team: sre
    domain: observability
    capability: monitoring
    dora-metric: mttr

  annotations:
    documentation: https://openstandardagents.org/docs/agents/monitoring-agent
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/monitoring-agent
    slo: "99.9% availability, p95 < 500ms"

spec:
  taxonomy:
    domain: observability
    subdomain: incident-management
    capability: monitoring

  role: |
    You are an expert SRE monitoring agent specializing in proactive incident detection.

    Your responsibilities:
    1. Monitor Prometheus metrics for anomalies (CPU spikes, memory leaks, error rates)
    2. Correlate alerts to reduce noise and identify root causes
    3. Track SLO/SLI metrics and calculate error budgets
    4. Detect SLO violations and calculate burn rates
    5. Analyze distributed traces for latency root cause analysis
    6. Calculate DORA metrics (deployment frequency, lead time, MTTR, change failure rate)
    7. Trigger automated remediation (scale pods, restart services, page on-call)
    8. Create incident tickets with context and suggested runbooks

    For each incident:
    - Severity (SEV1/SEV2/SEV3/SEV4)
    - Affected services and user impact
    - Root cause hypothesis
    - Suggested remediation
    - Runbook link
    - On-call escalation (if SEV1/SEV2)

  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.2
    maxTokens: 6000

  tools:
    - type: http
      name: prometheus-query
      description: |
        Query Prometheus for metrics, alerts, and time-series data.
      endpoint: http://prometheus:9090/api/v1/query
      config:
        method: POST
        timeout: 30
        queryLanguage: promql

    - type: http
      name: jaeger-trace-search
      description: |
        Search distributed traces in Jaeger for latency analysis.
      endpoint: http://jaeger-query:16686/api/traces
      config:
        method: GET
        timeout: 15

    - type: http
      name: alertmanager-api
      description: |
        Query and manage alerts in Prometheus Alertmanager.
      endpoint: http://alertmanager:9093/api/v2/alerts
      config:
        method: GET
        timeout: 10

    - type: http
      name: grafana-api
      description: |
        Query Grafana for dashboard data and annotations.
      endpoint: http://grafana:3000/api
      config:
        method: GET
        timeout: 10
      auth:
        type: bearer
        tokenPath: /var/secrets/grafana-token

    - type: http
      name: pagerduty-api
      description: |
        Create incidents and page on-call engineers via PagerDuty.
      endpoint: https://api.pagerduty.com/incidents
      config:
        method: POST
        timeout: 10
      auth:
        type: bearer
        tokenPath: /var/secrets/pagerduty-token

    - type: a2a
      name: rollback-coordinator
      description: |
        Trigger automated rollback if critical metrics degrade.
      endpoint: http://rollback-coordinator:8080/a2a
      config:
        protocol: json-rpc
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem

  autonomy:
    level: autonomous
    approval_required: false

    allowed_actions:
      - query_prometheus_metrics
      - search_distributed_traces
      - create_incident_tickets
      - page_oncall_engineers
      - trigger_autoscaling
      - generate_monitoring_reports

    blocked_actions:
      - trigger_rollback  # Requires coordination with rollback-coordinator

  constraints:
    cost:
      maxTokensPerDay: 400000
      maxTokensPerRequest: 6000
      maxCostPerDay: 40.00
      currency: USD

    performance:
      maxLatencySeconds: 15  # Fast incident response
      maxConcurrentRequests: 30
      timeoutSeconds: 60

    resources:
      cpu: "1000m"
      memory: "2Gi"

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318

    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: incidents_detected_total
          type: counter
          description: "Total incidents detected"
          labels: [severity, service]
        - name: slo_violations_total
          type: counter
          description: "Total SLO violations"
        - name: mttr_seconds
          type: histogram
          description: "Mean time to recovery"
        - name: dora_deployment_frequency
          type: gauge
          description: "Deployments per day"

    logging:
      level: info
      format: json

  state:
    backend: redis
    config:
      host: redis-cluster.default.svc.cluster.local
      port: 6379
      database: 5
      ttl: 2592000  # 30 days for DORA metrics
      keyPrefix: "monitoring-agent:"

  extensions:
    kagent:
      kubernetes:
        namespace: observability-system
        labels:
          app: monitoring-agent
          team: sre
        resourceLimits:
          cpu: "1000m"
          memory: "2Gi"
        serviceAccount: monitoring-agent-sa

      guardrails:
        requireApproval: false
        allowedActions:
          - prometheus:query:*
          - alertmanager:read:*
          - pagerduty:create:incident

      a2aConfig:
        enabled: true
        protocol: json-rpc
        endpoints:
          - http://rollback-coordinator:8080/a2a
          - http://performance-optimizer:8080/a2a
        authentication:
          type: mtls

      meshIntegration:
        enabled: true
        istioIntegration: true
        mtlsMode: STRICT

# ============================================================================
# DORA METRICS CALCULATION
# ============================================================================
#
# Deployment Frequency:
#   Query: rate(deployments_total[24h])
#   Target: > 1 deployment per day (elite performance)
#
# Lead Time for Changes:
#   Query: histogram_quantile(0.95, deployment_lead_time_seconds)
#   Target: < 1 hour (elite performance)
#
# Mean Time to Recovery (MTTR):
#   Query: histogram_quantile(0.95, incident_resolution_seconds)
#   Target: < 1 hour (elite performance)
#
# Change Failure Rate:
#   Query: rate(failed_deployments_total[24h]) / rate(deployments_total[24h])
#   Target: < 15% (elite performance)
#
# ============================================================================
