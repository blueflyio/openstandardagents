apiVersion: ossa/v0.3.0
kind: Agent

metadata:
  name: ossa-validator-v0.3
  version: 1.0.0
  description: |
    OpenStandardAgents Validator (v0.3.x) - Comprehensive OSSA v0.3.0 manifest validation.
    
    Validates OSSA v0.3.x manifests using @bluefly/openstandardagents npm package for:
    - Schema compliance (apiVersion, kind, metadata, spec)
    - LLM configuration with environment variable support
    - Capabilities, tools (MCP), and autonomy settings
    - Observability (telemetry, tracing, metrics)
    - Safety guardrails (PII, secrets, prompt injection)
    - Cost tracking and A2A messaging
    - Runtime bindings validation

  labels:
    domain: ossa-compliance
    subdomain: validation
    category: quality-assurance
    autonomy: assisted
    ossa-version: v0.3.0

  annotations:
    ossa.standard/compliance: full
    ossa.standard/validator: "true"
    npm.package: "@bluefly/openstandardagents"

spec:
  role: |
    You are the OpenStandardAgents Validator (v0.3.x), a specialized agent that validates
    OSSA v0.3.0 manifests for complete compliance with the specification.
    
    Your mission is to ensure every OSSA manifest meets the highest standards of:
    - Schema correctness
    - Security best practices
    - Observability completeness
    - Cost management
    - Runtime compatibility
    
    You use the @bluefly/openstandardagents npm package for validation and provide clear,
    actionable feedback with specific fixes for any violations.

  prompts:
    system:
      template: |
        You are the OpenStandardAgents Validator (v0.3.x).
        
        Validate OSSA v0.3.0 manifests using @bluefly/openstandardagents npm package
        with precision and provide actionable feedback.
        
        Validation scope:
        - Schema compliance (apiVersion, kind, metadata, spec)
        - LLM configuration (env var support, fallbacks, cost tracking)
        - Capabilities and tools (MCP compliance)
        - Autonomy settings and constraints
        - Observability (tracing, metrics, logging)
        - Safety guardrails (PII, secrets, prompt injection)
        - A2A messaging configuration
        - Runtime bindings validation
        
        Use: npx @bluefly/openstandardagents validate <manifest-path>
        
        Be thorough, clear, and helpful. Provide specific fixes for all violations.
      version: "1.0.0"

  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-3-5-sonnet-20241022}
    temperature: 0.1
    maxTokens: 8000

    profile: ${LLM_PROFILE:-balanced}

    fallback_models:
      - provider: ${LLM_FALLBACK_1_PROVIDER:-openai}
        model: ${LLM_FALLBACK_1_MODEL:-gpt-4o-mini}
        temperature: 0.1
      - provider: ${LLM_FALLBACK_2_PROVIDER:-anthropic}
        model: ${LLM_FALLBACK_2_MODEL:-claude-3-haiku-20240307}
        temperature: 0.1

    retry_config:
      max_attempts: 3
      backoff_strategy: exponential
      initial_delay_ms: 1000
      max_delay_ms: 30000

    cost_tracking:
      enabled: true
      budget_alert_threshold: 10.00
      daily_limit: 50.00
      cost_allocation_tags:
        project: ossa-validation
        team: ossa-core
        service: validator
        purpose: compliance

  capabilities:
    - name: schema_validation
      description: Validate OSSA v0.3.0 schema compliance using @bluefly/openstandardagents
      version: "1.0.0"
      scopes: [read, validate]

    - name: llm_config_validation
      description: Validate LLM configuration and env var support
      version: "1.0.0"
      scopes: [read, validate]

    - name: security_validation
      description: Validate safety guardrails and security settings
      version: "1.0.0"
      scopes: [read, validate]

    - name: observability_validation
      description: Validate observability configuration
      version: "1.0.0"
      scopes: [read, validate]

    - name: runtime_validation
      description: Validate runtime bindings and compatibility
      version: "1.0.0"
      scopes: [read, validate]

  tools:
    - type: exec
      name: ossa_validate_cli
      description: Execute @bluefly/openstandardagents CLI validation
      command: npx
      args:
        - @bluefly/openstandardagents
        - validate
        - ${manifest_path}
      env:
        - name: STRICT_MODE
          value: "${strict_mode:-true}"
      outputSchema:
        type: object
        properties:
          exit_code:
            type: integer
          stdout:
            type: string
          stderr:
            type: string
          valid:
            type: boolean

    - type: mcp
      name: validate_ossa_schema
      description: Validate OSSA manifest against v0.3.0 schema using @bluefly/openstandardagents
      inputSchema:
        type: object
        required: [manifest_path]
        properties:
          manifest_path:
            type: string
            description: Path to OSSA manifest file
          strict_mode:
            type: boolean
            default: true
            description: Enable strict validation
          check_deprecated:
            type: boolean
            default: true
            description: Check for deprecated fields
      outputSchema:
        type: object
        properties:
          valid:
            type: boolean
          errors:
            type: array
            items:
              type: object
              properties:
                path:
                  type: string
                message:
                  type: string
                severity:
                  type: string
                  enum: [error, warning, info]
                suggestion:
                  type: string
          compliance_score:
            type: number
            minimum: 0
            maximum: 100

  autonomy:
    level: assisted

    approval_required:
      - modify_manifests
      - bypass_validation

    allowed_actions:
      - validate_ossa_schema
      - ossa_validate_cli
      - validate_llm_config
      - validate_safety
      - validate_observability
      - validate_runtime
      - generate_report
      - suggest_fixes

    blocked_actions:
      - modify_files
      - delete_files
      - access_secrets

  constraints:
    cost:
      maxTokensPerDay: 500000
      maxTokensPerRequest: 8000
      maxCostPerDay: 50.00
      currency: USD

    performance:
      maxLatencySeconds: 30
      maxConcurrentRequests: 10
      timeoutSeconds: 60

  state:
    mode: stateless
    context_window:
      max_messages: 50
      max_tokens: 16000

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: ${OTEL_ENDPOINT:-http://otel-collector:4317}
      sample_rate: 1.0

    metrics:
      enabled: true
      exporter: prometheus
      port: 9091
      customMetrics:
        - name: ossa_validations_total
          type: counter
          description: Total OSSA validations performed
          labels: [version, result]
        - name: ossa_validation_duration_seconds
          type: histogram
          description: Time to validate OSSA manifest
          labels: [version]
        - name: validation_errors_total
          type: counter
          description: Validation errors by category
          labels: [category, severity]
        - name: validation_compliance_score
          type: gauge
          description: Compliance score (0-100)
          labels: [version]

    logging:
      level: info
      format: json
      include_input: false
      include_output: false

    alerting:
      enabled: true
      rules:
        - name: high_error_rate
          condition: error_rate > 0.1
          severity: warning
        - name: low_compliance_score
          condition: compliance_score < 70
          severity: warning

  safety:
    content_filtering:
      enabled: true
      categories: [pii, credentials, secrets, api_keys]
      threshold: strict
      action: redact

    pii_detection:
      enabled: true
      types: [email, phone, api_key, private_key]
      action: redact

    rate_limiting:
      enabled: true
      requests_per_minute: 100
      burst_limit: 200

    guardrails:
      enabled: true
      policies:
        - name: max_tool_calls
          max_tool_calls: 50
        - name: max_execution_time
          max_execution_time_seconds: 60
        - name: no_destructive_actions
          blocked_patterns: ["rm -rf", "DELETE FROM"]

  messaging:
    publishes:
      - channel: ossa.validation.complete
        description: Published when validation completes
        schema:
          type: object
          required: [manifest_path, result, timestamp]
          properties:
            manifest_path:
              type: string
            result:
              type: string
              enum: [passed, failed, warnings]
            compliance_score:
              type: number
            errors:
              type: array
            duration_ms:
              type: integer
        tags: [ossa, validation]

    subscribes:
      - channel: ossa.manifest.created
        description: Listen for new OSSA manifests
        handler: on_manifest_created
        priority: high
        maxConcurrency: 5

      - channel: ossa.manifest.updated
        description: Listen for manifest updates
        handler: on_manifest_updated
        priority: normal
        maxConcurrency: 5

    commands:
      - name: validate_manifest
        description: Validate a specific OSSA manifest using @bluefly/openstandardagents
        inputSchema:
          type: object
          required: [path]
          properties:
            path:
              type: string
            version:
              type: string
              default: "v0.3.0"
            strict:
              type: boolean
              default: true
        outputSchema:
          type: object
          properties:
            valid:
              type: boolean
            errors:
              type: array
            warnings:
              type: array
            compliance_score:
              type: number
        timeoutSeconds: 60
        idempotent: true

    reliability:
      deliveryGuarantee: at-least-once
      retry:
        maxAttempts: 3
        backoff:
          strategy: exponential
          initialDelayMs: 1000
          maxDelayMs: 10000

  extensions:
    mcp:
      enabled: true
      server_type: stdio
      server_name: ossa-validator-mcp

      tools:
        - name: ossa_validate
          description: Validate OSSA manifests using @bluefly/openstandardagents
        - name: llm_config_validate
          description: Validate LLM configuration
        - name: safety_validate
          description: Validate safety settings
        - name: observability_validate
          description: Validate observability config
        - name: runtime_validate
          description: Validate runtime bindings

      resources:
        - uri: npm://@bluefly/openstandardagents
          name: OSSA Validation Package
          description: The @bluefly/openstandardagents npm package for validation
          mimeType: application/json

        - uri: file:///spec/v0.3.0
          name: OSSA v0.3.0 Specification
          description: The complete OSSA v0.3.0 specification
          mimeType: application/json

  runtime:
    type: container
    image: node:20-bookworm
    transport: sync

    dependencies:
      - name: "@bluefly/openstandardagents"
        version: "latest"
        type: npm

    bindings:
      validate_ossa_schema:
        handler: OSSAValidator::validateSchema
        tool: ossa_validate
        config:
          package: "@bluefly/openstandardagents"
          command: "npx @bluefly/openstandardagents validate"
          schema_path: /spec/v0.3.0
          strict_mode: true

      validate_llm_config:
        handler: LLMConfigValidator::validate
        tool: llm_config_validate
        config:
          check_env_vars: true
          check_fallbacks: true

      validate_safety:
        handler: SafetyValidator::validate
        tool: safety_validate
        config:
          check_all: true

      validate_observability:
        handler: ObservabilityValidator::validate
        tool: observability_validate
        config:
          check_all: true

      validate_runtime:
        handler: RuntimeValidator::validate
        tool: runtime_validate
        config:
          check_compatibility: true

  reasoning:
    strategy: react
    max_steps: 20
    trace_enabled: true
    export_format: otel

    chains:
      - name: validation_chain
        steps:
          - fetch_manifest
          - parse_yaml
          - validate_schema_via_cli
          - validate_llm_config
          - validate_safety
          - validate_observability
          - validate_runtime
          - generate_report
