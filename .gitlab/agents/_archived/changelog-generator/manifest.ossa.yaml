apiVersion: ossa/v0.3.3
kind: Agent
metadata:
  name: changelog-generator
  description: Generates structured CHANGELOG from conventional commits
  labels:
    tier: release-automation
    criticality: high
  annotations:
    ossa.io/migration: v0.3.2-to-v0.3.3
    ossa.io/migrated-date: 2026-01-07
spec:
  role: generator
  capabilities:
    - git-analysis
    - markdown-generation
    - conventional-commits
  triggers:
    - type: pipeline
      events:
        - tag
      pattern: v*
  tasks:
    - name: generate-changelog
      description: Generate CHANGELOG.md from commits
      steps:
        - name: get-last-tag
          action: exec
          command: git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0"
        - name: parse-commits
          action: exec
          command: >
            git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo
            "")..HEAD \
              --pretty=format:"%h|%s|%b" --no-merges
        - name: group-by-type
          action: exec
          command: >
            #!/bin/bash

            echo "# Changelog"

            echo ""

            echo "## [${CI_COMMIT_TAG}] - $(date +%Y-%m-%d)"

            echo ""


            # Features

            echo "### âœ¨ Features"

            git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo
            "")..HEAD \
              --pretty=format:"- %s (%h)" --no-merges --grep="^feat"
            echo ""


            # Fixes

            echo "### ðŸ› Bug Fixes"

            git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo
            "")..HEAD \
              --pretty=format:"- %s (%h)" --no-merges --grep="^fix"
            echo ""


            # Docs

            echo "### ðŸ“š Documentation"

            git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo
            "")..HEAD \
              --pretty=format:"- %s (%h)" --no-merges --grep="^docs"
            echo ""
        - name: write-changelog
          action: exec
          command: |
            ./generate-changelog.sh > CHANGELOG.md
            git add CHANGELOG.md
            git commit -m "docs: update CHANGELOG for ${CI_COMMIT_TAG}" || true
  outputs:
    - type: artifact
      path: CHANGELOG.md
    - type: git-commit
      message: "docs: update CHANGELOG"
