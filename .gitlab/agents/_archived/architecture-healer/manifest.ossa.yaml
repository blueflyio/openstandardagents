apiVersion: ossa/v0.3.3
kind: Agent
metadata:
  name: architecture-healer
  version: 1.0.0
  description: |
    Architecture analysis and healing agent. Scans codebases to generate
    architecture diagrams, detect drift from intended design, validate
    layer boundaries, and enforce dependency directions.
  labels:
    environment: production
    team: architecture
    domain: architecture
    capability: architecture-analysis
    wave: "3"
  annotations:
    documentation: https://openstandardagents.org/docs/agents/architecture-healer
    support: ops@openstandardagents.org
    category: Architecture
    ossa.io/migration: v0.3.2-to-v0.3.3
    ossa.io/migrated-date: 2026-01-07
spec:
  taxonomy:
    domain: architecture
    subdomain: design-validation
    capability: architecture-healing
  role: |
    You are an expert software architect specializing in codebase analysis,
    architecture documentation, and design validation.

    Your responsibilities:
    1. Scan codebases to understand structure and dependencies
    2. Generate architecture diagrams (Mermaid, PlantUML, C4)
    3. Detect architecture drift from intended design
    4. Validate clean architecture layer boundaries
    5. Enforce dependency direction rules (no circular dependencies)
    6. Create merge requests for architecture documentation updates
    7. Alert on architecture violations

    When analyzing architecture:
    - Map module/package dependencies
    - Identify coupling between components
    - Validate separation of concerns
    - Check for layered architecture compliance
    - Detect API boundary violations

    Generate diagrams for:
    - High-level system architecture (C4 context)
    - Component diagrams (C4 container/component)
    - Sequence diagrams for critical flows
    - Dependency graphs
  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.2
    maxTokens: 8000
  tools:
    - type: mcp
      name: filesystem
      description: |
        Read source code files to analyze structure and dependencies.
      config:
        server: filesystem-mcp
        allowed_paths:
          - src/**
          - lib/**
          - packages/**
          - modules/**
    - type: http
      name: dependency-graph
      description: >
        Generate dependency graphs from package managers (npm, composer, go.mod).
      endpoint: http://dep-analyzer:8080/analyze
      config:
        method: POST
        timeout: 120
    - type: mcp
      name: gitlab-api
      description: |
        Access GitLab repositories and create merge requests for documentation.
      config:
        server: gitlab-mcp
        scope: repository
      auth:
        type: bearer
        tokenPath: /var/secrets/gitlab-token
    - type: a2a
      name: agent-mesh
      description: |
        Communicate with doc-agent and spec-healer for coordinated updates.
      endpoint: http://agent-mesh:9090/a2a
      config:
        protocol: json-rpc
        version: "2.0"
  capabilities:
    - name: scan_codebase_structure
      description: Scan codebase to understand module structure
      input_schema:
        type: object
        properties:
          repository_path:
            type: string
          include_patterns:
            type: array
            items:
              type: string
            default:
              - src/**
              - lib/**
          exclude_patterns:
            type: array
            items:
              type: string
            default:
              - node_modules/**
              - vendor/**
        required:
          - repository_path
      output_schema:
        type: object
        properties:
          modules:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                path:
                  type: string
                dependencies:
                  type: array
                  items:
                    type: string
          dependency_graph:
            type: object
          success:
            type: boolean
    - name: generate_diagrams
      description: Generate architecture diagrams in various formats
      input_schema:
        type: object
        properties:
          diagram_type:
            type: string
            enum:
              - mermaid
              - plantuml
              - c4
          scope:
            type: string
            enum:
              - context
              - container
              - component
              - code
            default: component
          repository_path:
            type: string
        required:
          - diagram_type
          - repository_path
      output_schema:
        type: object
        properties:
          diagram_source:
            type: string
          diagram_type:
            type: string
          success:
            type: boolean
    - name: detect_architecture_drift
      description: Detect drift from intended architecture design
      input_schema:
        type: object
        properties:
          current_structure:
            type: object
          intended_architecture:
            type: object
            description: C4 or ADR defining intended architecture
        required:
          - current_structure
          - intended_architecture
      output_schema:
        type: object
        properties:
          drift_detected:
            type: boolean
          violations:
            type: array
            items:
              type: object
              properties:
                type:
                  type: string
                description:
                  type: string
                severity:
                  type: string
                  enum:
                    - low
                    - medium
                    - high
                    - critical
          success:
            type: boolean
    - name: validate_layer_boundaries
      description: Validate clean architecture layer boundaries
      input_schema:
        type: object
        properties:
          repository_path:
            type: string
          layer_config:
            type: object
            properties:
              domain:
                type: array
                items:
                  type: string
              application:
                type: array
                items:
                  type: string
              infrastructure:
                type: array
                items:
                  type: string
        required:
          - repository_path
      output_schema:
        type: object
        properties:
          valid:
            type: boolean
          boundary_violations:
            type: array
            items:
              type: object
              properties:
                from_layer:
                  type: string
                to_layer:
                  type: string
                source_file:
                  type: string
                target_file:
                  type: string
          success:
            type: boolean
    - name: enforce_dependency_directions
      description: Detect and report circular dependencies
      input_schema:
        type: object
        properties:
          dependency_graph:
            type: object
        required:
          - dependency_graph
      output_schema:
        type: object
        properties:
          circular_dependencies:
            type: array
            items:
              type: array
              items:
                type: string
          valid:
            type: boolean
          success:
            type: boolean
  triggers:
    - type: webhook
      name: on_service_added
      event: push
      filter:
        paths:
          - src/services/**
          - packages/**
      description: Analyze architecture when new services added
    - type: webhook
      name: on_dependency_changed
      event: push
      filter:
        paths:
          - package.json
          - composer.json
          - go.mod
      description: Update diagrams when dependencies change
    - type: webhook
      name: on_api_endpoint_added
      event: push
      filter:
        paths:
          - src/api/**
          - openapi/**
      description: Update API diagrams
    - type: workflow
      name: on_status_review
      status: Review
      description: Generate architecture review on status change
  outputs:
    - name: mermaid_diagram
      type: file
      format: mermaid
      path: docs/architecture/diagrams/
    - name: plantuml_diagram
      type: file
      format: plantuml
      path: docs/architecture/diagrams/
    - name: c4_model
      type: file
      format: json
      path: docs/architecture/c4/
  autonomy:
    level: supervised
    approval_required: true
    allowed_actions:
      - scan_codebase_structure
      - generate_diagrams
      - detect_architecture_drift
      - validate_layer_boundaries
      - create_merge_requests
    blocked_actions:
      - delete_files
      - modify_source_code
  constraints:
    cost:
      maxTokensPerDay: 300000
      maxTokensPerRequest: 8000
      maxCostPerDay: 30
      currency: USD
    performance:
      maxLatencySeconds: 120
      maxConcurrentRequests: 3
      timeoutSeconds: 600
    resources:
      cpu: 2000m
      memory: 4Gi
      ephemeralStorage: 10Gi
  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318
      samplingRate: 0.5
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: architecture_scans
          type: counter
          description: Total architecture scans performed
        - name: drift_violations
          type: gauge
          description: Number of architecture drift violations
        - name: diagrams_generated
          type: counter
          description: Architecture diagrams generated
    logging:
      level: info
      format: json
  state:
    backend: redis
    config:
      host: redis-cluster.default.svc.cluster.local
      port: 6379
      database: 4
      ttl: 86400
      keyPrefix: "arch-healer:"
