apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: issue-triage
  namespace: gitlab-automation
  labels:
    tier: automation
    domain: issue-management
    trigger: webhook
spec:
  description: |
    Automated issue triage and classification agent. Handles new issues,
    applies labels, assigns to appropriate team members, and validates
    issue requirements.
  
  capabilities:
    - gitlab-api
    - issue-management
    - label-classification
    - nlp-analysis
  
  triggers:
    - type: webhook
      events:
        - issue.open
        - issue.update
        - note.issue
      filters:
        - state: opened
  
  tasks:
    - id: validate-issue
      name: Validate Issue Template
      type: validation
      config:
        required_sections:
          - description
          - expected_behavior
          - actual_behavior
        optional_sections:
          - steps_to_reproduce
          - environment
    
    - id: classify-type
      name: Classify Issue Type
      type: classification
      dependsOn: [validate-issue]
      config:
        patterns:
          bug:
            keywords: [error, bug, broken, crash, fail]
            labels: [type::bug, priority::high]
          feature:
            keywords: [feature, enhancement, add, new]
            labels: [type::feature, priority::medium]
          documentation:
            keywords: [docs, documentation, readme]
            labels: [type::documentation, priority::low]
          question:
            keywords: [question, how, why, help]
            labels: [type::question, priority::low]
    
    - id: estimate-weight
      name: Estimate Issue Weight
      type: estimation
      dependsOn: [classify-type]
      config:
        factors:
          - complexity
          - scope
          - dependencies
        scale: 1-5
    
    - id: assign-owner
      name: Auto-assign Owner
      type: assignment
      dependsOn: [classify-type]
      config:
        strategy: expertise-match
        team:
          - username: flux423
            expertise: [ci-cd, infrastructure, agents]
    
    - id: add-to-milestone
      name: Add to Current Milestone
      type: milestone-management
      dependsOn: [estimate-weight]
      config:
        strategy: current-active
        conditions:
          - weight_available: true
          - milestone_not_full: true
    
    - id: notify
      name: Send Triage Report
      type: notification
      config:
        channels:
          - type: gitlab-comment
            template: |
              ## ü§ñ Issue Triage Report
              
              **Type**: {{type}}
              **Weight**: {{weight}}
              **Assigned**: {{assignee}}
              **Milestone**: {{milestone}}
              
              {{#if validation_failed}}
              ‚ö†Ô∏è Please complete the issue template
              {{/if}}

  integrations:
    gitlab:
      api_version: v4
      token: ${GITLAB_TOKEN}
      project: blueflyio/ossa/openstandardagents.org
    
  monitoring:
    metrics:
      - issues_triaged
      - classification_accuracy
      - assignment_time
    logs:
      level: info
      format: json
