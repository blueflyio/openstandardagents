# ============================================================================
# OSSA GitOps Deployer Agent
# ============================================================================

apiVersion: ossa/v0.3.2
kind: Agent

metadata:
  name: gitops-deployer
  version: 1.0.0
  description: |
    GitOps deployment agent for Kubernetes. Syncs manifests from Git
    repositories to Kubernetes clusters using GitLab Agent for Kubernetes.
  labels:
    environment: production
    team: devops
    domain: gitops
    capability: deployment
    integration: gitlab-k8s
    ossa-version: v0.3.0

spec:
  taxonomy:
    domain: gitops
    subdomain: kubernetes-deployment
    capability: manifest-sync

  role: |
    You are a GitOps deployment specialist managing Kubernetes deployments
    via Git repositories.

    Your responsibilities:
    1. Sync Kubernetes manifests from Git to clusters
    2. Validate manifests before deployment
    3. Monitor deployment health
    4. Rollback on failures
    5. Manage secrets securely via External Secrets
    6. Coordinate with other agents for deployment workflows

  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.1
    maxTokens: 4096

  tools:
    - type: mcp
      name: gitlab-k8s-agent
      description: GitLab Agent for Kubernetes integration.
      config:
        server: gitlab-k8s-mcp
        agentPath: .gitlab/agents/k8s-agent

    - type: mcp
      name: kubernetes
      description: Kubernetes API access for deployments.
      config:
        server: kubernetes-mcp
      auth:
        type: mtls
        certPath: /var/secrets/k8s-client-cert.pem

  capabilities:
    - name: sync_manifests
      description: Sync manifests from Git to cluster
      input_schema:
        type: object
        properties:
          source_path: { type: string }
          target_namespace: { type: string }
          dry_run: { type: boolean, default: false }
        required: [source_path, target_namespace]

    - name: validate_manifests
      description: Validate Kubernetes manifests
      input_schema:
        type: object
        properties:
          manifest_path: { type: string }
        required: [manifest_path]

    - name: rollback_deployment
      description: Rollback a deployment to previous version
      input_schema:
        type: object
        properties:
          deployment: { type: string }
          namespace: { type: string }
          revision: { type: integer }
        required: [deployment, namespace]

  triggers:
    - type: webhook
      name: on_manifest_push
      event: push
      filter:
        paths:
          - 'kubernetes/**'
          - 'k8s/**'
          - 'manifests/**'

    - type: schedule
      name: reconciliation
      schedule: "*/5 * * * *"

  autonomy:
    level: supervised
    approval_required: true
    allowed_actions:
      - sync_manifests
      - validate_manifests
      - rollback_deployment
    blocked_actions:
      - delete_namespaces
      - modify_crds

  constraints:
    cost:
      maxTokensPerDay: 100000
      maxCostPerDay: 10.00
      currency: USD
    performance:
      maxLatencySeconds: 60
      timeoutSeconds: 300

  observability:
    tracing:
      enabled: true
    metrics:
      enabled: true
      customMetrics:
        - name: deployments_synced
          type: counter
        - name: sync_failures
          type: counter

extensions:
  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: agent-system
      labels:
        app.kubernetes.io/name: gitops-deployer
        app.kubernetes.io/part-of: ossa-showcase
        openstandardagents.org/version: v0.3.0
      resourceLimits:
        cpu: "1"
        memory: 2Gi
    deployment:
      replicas: { min: 1, max: 3 }
      strategy: rolling-update
    a2aConfig:
      enabled: true
      protocol: json-rpc
    meshIntegration:
      enabled: true
      istioIntegration: true

  gitlab_duo:
    enabled: true
    flow_execution: true
    model: ${GITLAB_DUO_MODEL:-claude-sonnet-4.5-20250929}
    knowledge_graph:
      enabled: true
      index_on_push: true

  mcp:
    enabled: true
    server_type: stdio
    server_name: gitops-deployer-mcp

