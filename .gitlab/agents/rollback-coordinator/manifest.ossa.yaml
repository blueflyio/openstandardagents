# ============================================================================
# OSSA Rollback Coordinator Agent - GitLab Kubernetes Deployment
# ============================================================================
#
# PURPOSE:
#   Automated rollback coordination for failed deployments and migrations.
#   Monitors deployment health, triggers rollbacks on failure, and coordinates
#   multi-component rollback workflows (application + database + config).
#
# CAPABILITIES:
#   - Deployment health monitoring (readiness, liveness, error rates)
#   - Automated rollback triggering on failure detection
#   - Multi-component rollback coordination (app + db + config)
#   - Traffic shifting and canary rollback
#   - Database schema rollback coordination with db-migrator
#   - Post-rollback verification and validation
#
# ============================================================================

apiVersion: ossa/v0.2.9
kind: Agent

metadata:
  name: rollback-coordinator
  version: 1.0.0
  description: |
    Automated rollback coordination agent for Kubernetes deployments.
    Monitors deployment health, detects failures, triggers coordinated rollbacks
    across application, database, and configuration components.

  labels:
    environment: production
    team: sre
    domain: deployment
    capability: rollback-automation
    dora-metric: mttr

  annotations:
    documentation: https://openstandardagents.org/docs/agents/rollback-coordinator
    support: ops@openstandardagents.org
    runbook: https://openstandardagents.org/docs/runbooks/rollback-coordinator
    safety: "automated-rollback-enabled"

spec:
  taxonomy:
    domain: deployment-automation
    subdomain: rollback-management
    capability: automated-recovery

  role: |
    You are an expert deployment rollback coordinator specializing in failure recovery.

    Your responsibilities:
    1. Monitor deployment health (readiness probes, error rates, latency spikes)
    2. Detect deployment failures (crash loops, failed health checks, high error rates)
    3. Trigger automated rollbacks when failure thresholds exceeded
    4. Coordinate multi-component rollbacks:
       - Application: Rollback Deployment/StatefulSet to previous revision
       - Database: Trigger db-migrator to execute rollback SQL
       - Configuration: Revert ConfigMaps and Secrets to previous version
    5. Manage traffic shifting (canary rollback, gradual traffic reduction)
    6. Verify rollback success (health checks, metrics validation)
    7. Create post-mortem incident reports with failure analysis

    Rollback Triggers:
    - Error rate > 5% for 5 minutes
    - P95 latency > 2x baseline for 10 minutes
    - Crash loop backoff (> 3 restarts in 5 minutes)
    - Failed readiness probes (> 50% pods not ready for 3 minutes)
    - Database migration failure (transaction rollback)

    For each rollback:
    - Trigger reason (metrics, logs, health checks)
    - Components affected (app/db/config)
    - Rollback strategy (immediate/canary/gradual)
    - Verification steps (health checks, smoke tests)
    - Post-mortem action items

  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.0  # Deterministic for safety-critical operations
    maxTokens: 8000

  tools:
    - type: http
      name: kubernetes-rollback
      description: |
        Execute Kubernetes rollbacks using kubectl rollout undo.
      endpoint: http://kubernetes-api:6443/apis/apps/v1
      config:
        method: POST
        timeout: 300
      auth:
        type: bearer
        tokenPath: /var/secrets/k8s-token

    - type: http
      name: argo-rollouts
      description: |
        Manage canary deployments and progressive delivery rollbacks.
      endpoint: http://argo-rollouts:8080/api/v1
      config:
        method: POST
        timeout: 300
      auth:
        type: bearer
        tokenPath: /var/secrets/argo-token

    - type: http
      name: istio-traffic-shift
      description: |
        Manage Istio VirtualService traffic shifting for gradual rollback.
      endpoint: http://istio-pilot:8080/api/v1
      config:
        method: POST
        timeout: 60
      auth:
        type: mtls
        certPath: /var/secrets/istio-client-cert.pem

    - type: a2a
      name: db-migrator
      description: |
        Coordinate database rollbacks with db-migrator agent.
      endpoint: http://db-migrator:8080/a2a
      config:
        protocol: json-rpc
        version: "2.0"
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem

    - type: http
      name: prometheus-query
      description: |
        Query Prometheus for deployment health metrics (error rates, latency).
      endpoint: http://prometheus:9090/api/v1/query
      config:
        method: POST
        timeout: 30
        queryLanguage: promql
      auth:
        type: bearer
        tokenPath: /var/secrets/prometheus-token

    - type: http
      name: monitoring-agent
      description: |
        Receive failure alerts and coordinate with monitoring-agent for incident response.
      endpoint: http://monitoring-agent:8080/a2a
      config:
        protocol: json-rpc
        version: "2.0"
      auth:
        type: mtls
        certPath: /var/secrets/a2a-client-cert.pem

  autonomy:
    level: autonomous
    approval_required: false  # Automated rollback on failure detection

    allowed_actions:
      - monitor_deployment_health
      - detect_failure_thresholds
      - trigger_rollback
      - coordinate_multi_component_rollback
      - verify_rollback_success
      - create_incident_report

    blocked_actions:
      - delete_namespace
      - delete_persistent_volumes
      - modify_cluster_config

  constraints:
    resource_limits:
      cpu: "500m"
      memory: "1Gi"
      ephemeral_storage: "2Gi"

    rate_limits:
      rollbacks_per_hour: 10
      api_calls_per_minute: 60

    safety_checks:
      - verify_previous_revision_exists
      - check_rollback_will_not_break_dependencies
      - validate_database_rollback_sql_before_execution

  state:
    backend: postgres
    config:
      host: postgres-primary.default.svc.cluster.local
      port: 5432
      database: rollback_metadata
      schema: rollback_history
      ssl: true
      sslMode: require

  extensions:
    kagent:
      kubernetes:
        namespace: deployment-system

        labels:
          app: rollback-coordinator
          team: sre
          dora-metric: mttr

        annotations:
          description: "Automated rollback coordination agent"
          contact: "ops@openstandardagents.org"
          safety: "automated-rollback-enabled"

        resourceLimits:
          cpu: "500m"
          memory: "1Gi"
          ephemeralStorage: "2Gi"

        serviceAccount: rollback-coordinator-sa

        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

      guardrails:
        requireApproval: false  # Autonomous for safety-critical rollbacks

        costLimits:
          maxTokensPerDay: 100000
          maxCostPerDay: 10.00
          currency: USD

        allowedActions:
          - kubernetes:rollback:deployment
          - kubernetes:rollback:statefulset
          - kubernetes:rollback:daemonset
          - kubernetes:update:configmap
          - kubernetes:update:secret
          - istio:update:virtualservice
          - argo:rollback:rollout

        auditLog:
          destination: compliance-engine
          retention: 7years

      a2aConfig:
        enabled: true
        protocol: json-rpc

        endpoints:
          - http://db-migrator:8080/a2a
          - http://monitoring-agent:8080/a2a

        authentication:
          type: mtls
          certPath: /var/secrets/a2a-client-cert.pem
          keyPath: /var/secrets/a2a-client-key.pem

      meshIntegration:
        enabled: true
        serviceMesh: istio

        trafficPolicy:
          loadBalancer: round_robin
          connectionPool:
            tcp:
              maxConnections: 100
            http:
              http1MaxPendingRequests: 50
              http2MaxRequests: 100

        circuitBreaker:
          consecutiveErrors: 5
          interval: 30s
          baseEjectionTime: 30s
          maxEjectionPercent: 50
