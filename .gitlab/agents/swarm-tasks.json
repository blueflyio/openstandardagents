{
  "swarm": {
    "name": "gitlab-kubernetes-deployment-swarm",
    "version": "1.0.0",
    "description": "Coordinated agent swarm for end-to-end Kubernetes deployment workflows with validation, migration, monitoring, and automated rollback.",
    "runtime": "kubernetes",
    "mesh": "gitlab-k8s-agent-mesh"
  },
  "tasks": [
    {
      "id": "task-001",
      "name": "Pre-Deployment Security Scan",
      "description": "Scan container images and Kubernetes manifests for security vulnerabilities before deployment",
      "agent": "security-scanner",
      "action": "scan_deployment_artifacts",
      "priority": "critical",
      "timeout": 300,
      "inputs": {
        "containerImages": [
          "registry.bluefly.io/app:v1.2.3",
          "registry.bluefly.io/sidecar:v0.5.0"
        ],
        "manifests": [
          "k8s/deployment.yaml",
          "k8s/service.yaml",
          "k8s/configmap.yaml"
        ],
        "scanTypes": [
          "cve-vulnerabilities",
          "secret-detection",
          "rbac-audit"
        ]
      },
      "outputs": {
        "scanReport": "security-scan-report.json",
        "criticalVulnerabilities": 0,
        "highVulnerabilities": 0,
        "secretsDetected": false
      },
      "onSuccess": "task-002",
      "onFailure": "abort-deployment",
      "retryPolicy": {
        "maxRetries": 2,
        "backoff": "exponential"
      }
    },
    {
      "id": "task-002",
      "name": "Configuration Validation",
      "description": "Validate Kubernetes manifests and Helm charts against schema, OPA policies, and best practices",
      "agent": "config-validator",
      "action": "validate_all_configs",
      "priority": "critical",
      "timeout": 60,
      "inputs": {
        "manifests": [
          "k8s/deployment.yaml",
          "k8s/service.yaml",
          "k8s/configmap.yaml",
          "k8s/hpa.yaml",
          "k8s/networkpolicy.yaml"
        ],
        "helmCharts": [
          "charts/application"
        ],
        "opaPolicies": [
          "resource-limits",
          "pod-security-standards",
          "network-policies"
        ]
      },
      "outputs": {
        "validationResult": "pass",
        "policyViolations": [],
        "recommendations": []
      },
      "dependencies": ["task-001"],
      "onSuccess": "task-003",
      "onFailure": "abort-deployment"
    },
    {
      "id": "task-003",
      "name": "Compliance Pre-Check",
      "description": "Validate deployment against regulatory compliance frameworks (SOC 2, HIPAA, PCI-DSS, GDPR)",
      "agent": "compliance-auditor",
      "action": "audit_deployment_compliance",
      "priority": "high",
      "timeout": 120,
      "inputs": {
        "frameworks": [
          "SOC2",
          "HIPAA",
          "PCI-DSS"
        ],
        "deploymentManifests": [
          "k8s/deployment.yaml",
          "k8s/service.yaml"
        ],
        "checkEncryption": true,
        "checkAccessControls": true,
        "checkAuditLogging": true
      },
      "outputs": {
        "complianceScore": 95,
        "violations": [],
        "complianceCertified": true
      },
      "dependencies": ["task-002"],
      "onSuccess": "task-004",
      "onFailure": "abort-deployment"
    },
    {
      "id": "task-004",
      "name": "Database Schema Migration",
      "description": "Execute database schema migrations with transaction safety and automatic rollback generation",
      "agent": "db-migrator",
      "action": "execute_migrations",
      "priority": "critical",
      "timeout": 600,
      "inputs": {
        "database": "postgresql",
        "migrationFiles": [
          "migrations/V001__add_user_table.sql",
          "migrations/V002__add_user_index.sql"
        ],
        "environment": "production",
        "dryRun": false,
        "generateRollback": true
      },
      "outputs": {
        "migrationsApplied": 2,
        "rollbackSql": "rollback/V002_rollback.sql",
        "integrityCheckPassed": true,
        "replicationLagSeconds": 2.5
      },
      "dependencies": ["task-003"],
      "onSuccess": "task-005",
      "onFailure": "task-009"
    },
    {
      "id": "task-005",
      "name": "Deploy Application to Kubernetes",
      "description": "Deploy application using kubectl/Helm with progressive delivery (canary)",
      "agent": "rollback-coordinator",
      "action": "deploy_with_canary",
      "priority": "critical",
      "timeout": 300,
      "inputs": {
        "deployment": "k8s/deployment.yaml",
        "strategy": "canary",
        "canarySteps": [
          {"weight": 10, "duration": "2m"},
          {"weight": 50, "duration": "5m"},
          {"weight": 100, "duration": "0m"}
        ],
        "healthChecks": {
          "readinessProbe": true,
          "livenessProbe": true
        }
      },
      "outputs": {
        "deploymentStatus": "progressing",
        "canaryWeight": 10,
        "healthyReplicas": 3,
        "totalReplicas": 3
      },
      "dependencies": ["task-004"],
      "onSuccess": "task-006",
      "onFailure": "task-009"
    },
    {
      "id": "task-006",
      "name": "Monitor Deployment Health",
      "description": "Monitor deployment metrics, error rates, and SLO compliance during rollout",
      "agent": "monitoring-agent",
      "action": "monitor_deployment",
      "priority": "critical",
      "timeout": 900,
      "inputs": {
        "deployment": "app-deployment",
        "namespace": "production",
        "monitoringDuration": "15m",
        "sloTargets": {
          "errorRate": 0.01,
          "p95Latency": 500,
          "availabilityPercentage": 99.9
        },
        "alerts": [
          "error-rate-high",
          "latency-degradation",
          "pod-crash-loop"
        ]
      },
      "outputs": {
        "errorRate": 0.002,
        "p95Latency": 285,
        "availability": 99.95,
        "sloViolations": 0,
        "incidentsDetected": 0
      },
      "dependencies": ["task-005"],
      "onSuccess": "task-007",
      "onFailure": "task-009"
    },
    {
      "id": "task-007",
      "name": "Performance Analysis",
      "description": "Analyze deployment performance and provide optimization recommendations",
      "agent": "performance-optimizer",
      "action": "analyze_deployment_performance",
      "priority": "medium",
      "timeout": 180,
      "inputs": {
        "deployment": "app-deployment",
        "namespace": "production",
        "metricsWindow": "15m",
        "analysisTypes": [
          "cpu-utilization",
          "memory-utilization",
          "network-latency",
          "database-query-performance"
        ]
      },
      "outputs": {
        "cpuUtilization": 45,
        "memoryUtilization": 62,
        "p95Latency": 285,
        "recommendations": [
          {
            "type": "right-sizing",
            "description": "Reduce CPU request from 1000m to 700m",
            "estimatedSavings": "$120/month"
          }
        ]
      },
      "dependencies": ["task-006"],
      "onSuccess": "task-008",
      "onFailure": "continue"
    },
    {
      "id": "task-008",
      "name": "Cost Impact Analysis",
      "description": "Calculate deployment cost and identify optimization opportunities",
      "agent": "cost-analyzer",
      "action": "analyze_deployment_cost",
      "priority": "low",
      "timeout": 60,
      "inputs": {
        "deployment": "app-deployment",
        "namespace": "production",
        "analysisWindow": "30d",
        "includeRecommendations": true
      },
      "outputs": {
        "currentMonthlyCost": 450,
        "optimizedMonthlyCost": 330,
        "potentialSavings": 120,
        "recommendations": [
          {
            "type": "right-sizing",
            "description": "Reduce CPU request from 1000m to 700m",
            "savings": 120
          }
        ]
      },
      "dependencies": ["task-007"],
      "onSuccess": "task-010",
      "onFailure": "continue"
    },
    {
      "id": "task-009",
      "name": "Automated Rollback",
      "description": "Trigger coordinated rollback of application, database, and configuration on deployment failure",
      "agent": "rollback-coordinator",
      "action": "trigger_full_rollback",
      "priority": "critical",
      "timeout": 300,
      "inputs": {
        "deployment": "app-deployment",
        "namespace": "production",
        "rollbackComponents": [
          "kubernetes-deployment",
          "database-schema",
          "configmaps"
        ],
        "rollbackStrategy": "immediate",
        "notifyOnCall": true
      },
      "outputs": {
        "rollbackStatus": "success",
        "componentsRolledBack": [
          "kubernetes-deployment",
          "database-schema"
        ],
        "rollbackDuration": 45,
        "healthChecksPassed": true,
        "postMortemCreated": true
      },
      "dependencies": [],
      "onSuccess": "task-010",
      "onFailure": "manual-intervention-required"
    },
    {
      "id": "task-010",
      "name": "Post-Deployment Compliance Audit",
      "description": "Audit deployed resources for ongoing compliance with regulatory frameworks",
      "agent": "compliance-auditor",
      "action": "audit_running_deployment",
      "priority": "medium",
      "timeout": 120,
      "inputs": {
        "deployment": "app-deployment",
        "namespace": "production",
        "frameworks": [
          "SOC2",
          "HIPAA",
          "PCI-DSS"
        ],
        "auditTypes": [
          "encryption-at-rest",
          "encryption-in-transit",
          "access-controls",
          "audit-logging"
        ]
      },
      "outputs": {
        "complianceScore": 98,
        "violations": [],
        "auditReport": "compliance-audit-2025-11-22.pdf",
        "nextAuditDate": "2025-12-22"
      },
      "dependencies": ["task-008", "task-009"],
      "onSuccess": "deployment-complete",
      "onFailure": "continue"
    }
  ],
  "workflows": [
    {
      "name": "happy-path-deployment",
      "description": "Successful deployment workflow without failures",
      "taskSequence": [
        "task-001",
        "task-002",
        "task-003",
        "task-004",
        "task-005",
        "task-006",
        "task-007",
        "task-008",
        "task-010"
      ]
    },
    {
      "name": "deployment-with-rollback",
      "description": "Deployment workflow with failure detection and automated rollback",
      "taskSequence": [
        "task-001",
        "task-002",
        "task-003",
        "task-004",
        "task-005",
        "task-006",
        "task-009",
        "task-010"
      ]
    },
    {
      "name": "security-focused-deployment",
      "description": "Deployment workflow prioritizing security and compliance",
      "taskSequence": [
        "task-001",
        "task-003",
        "task-002",
        "task-004",
        "task-005",
        "task-006",
        "task-010"
      ]
    },
    {
      "name": "cost-optimized-deployment",
      "description": "Deployment workflow with emphasis on cost optimization",
      "taskSequence": [
        "task-001",
        "task-002",
        "task-004",
        "task-005",
        "task-006",
        "task-007",
        "task-008",
        "task-010"
      ]
    }
  ],
  "sla": {
    "deploymentDuration": {
      "target": 20,
      "unit": "minutes",
      "p95": 18,
      "p99": 22
    },
    "successRate": {
      "target": 95,
      "actual": 97.5
    },
    "rollbackDuration": {
      "target": 5,
      "unit": "minutes",
      "p95": 4.2,
      "p99": 5.8
    }
  },
  "doraMetrics": {
    "deploymentFrequency": {
      "target": "multiple per day",
      "actual": 12,
      "unit": "deployments per day"
    },
    "leadTimeForChanges": {
      "target": 60,
      "actual": 45,
      "unit": "minutes"
    },
    "changeFailureRate": {
      "target": 15,
      "actual": 8.5,
      "unit": "percentage"
    },
    "timeToRestore": {
      "target": 60,
      "actual": 35,
      "unit": "minutes"
    }
  }
}
