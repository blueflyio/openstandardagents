apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: content-moderator
  namespace: website-automation
  version: 1.0.0
  description: |
    Moderator agent that audits published content for accuracy, freshness,
    and compliance. Flags outdated content and ensures ongoing quality.
  labels:
    tier: worker
    domain: content
    role: moderator
    trigger: scheduled
  author:
    name: OSSA Moderator Bot
    email: moderator@openstandardagents.org
    gitlab_service_account: ossa-moderator

spec:
  role: |
    You are the Moderator Agent for openstandardagents.org. You ensure published
    content remains accurate, fresh, and compliant over time.

    Moderation Responsibilities:
    1. Content Freshness: Flag content older than 90 days for review
    2. Link Rot: Check all external links weekly, flag broken ones
    3. Version Accuracy: Ensure OSSA version references are current
    4. Schema Compliance: Validate YAML examples against latest schema
    5. Fact Checking: Verify claims still match source materials
    6. Brand Consistency: Ensure "First-Class Citizens" messaging is present
    7. Community Feedback: Monitor issues/comments for content problems

    Audit Outputs:
    - Weekly health report
    - Issues for content needing updates
    - Alerts for critical problems (broken links, outdated versions)

  llm:
    provider: anthropic
    model: claude-sonnet-4-20250514
    temperature: 0.1
    max_tokens: 8192

  capabilities:
    - content-audit
    - link-validation
    - schema-validation
    - version-checking
    - gitlab-api

  triggers:
    - type: schedule
      cron: "0 0 * * 0"  # Sunday midnight - weekly audit
      description: Weekly content health audit

    - type: schedule
      cron: "0 6 * * *"  # Daily 6am - link check
      description: Daily broken link scan

    - type: webhook
      events:
        - issue.labeled
      filters:
        - label: content-issue

  tasks:
    # Daily Tasks
    - id: scan-links
      name: Scan All External Links
      type: link-validation
      schedule: daily
      config:
        scan_paths:
          - website/content/blog/**/*.md
          - website/content/docs/**/*.md
        link_patterns:
          - 'https?://[^\s\)\"\'<>]+'
        checks:
          - http_status
          - redirect_chains
          - ssl_validity
        output: link-scan-results.json

    - id: alert-broken-links
      name: Alert on Broken Links
      type: notification
      dependsOn: [scan-links]
      config:
        condition: "{{broken_links.length > 0}}"
        channels:
          - type: gitlab-issue
            title: "ðŸ”— Broken Links Found - {{date}}"
            labels: [content-issue, broken-links, priority::high]
            template: |
              ## Broken Links Detected

              The daily link scan found {{broken_links.length}} broken links:

              {{#each broken_links}}
              ### {{file}}
              - **Link**: `{{url}}`
              - **Status**: {{status_code}}
              - **Line**: {{line_number}}
              {{/each}}

              Please update or remove these links.

              ---
              *Detected by @ossa-moderator*

    # Weekly Tasks
    - id: audit-freshness
      name: Audit Content Freshness
      type: content-audit
      schedule: weekly
      config:
        scan_paths:
          - website/content/blog/**/*.md
          - website/content/docs/**/*.md
        thresholds:
          stale_warning: 90  # days
          stale_critical: 180  # days
        exclude_patterns:
          - "**/changelog.md"
          - "**/contributing.md"
        output: freshness-audit.json

    - id: validate-versions
      name: Validate Version References
      type: version-check
      schedule: weekly
      config:
        current_versions:
          ossa: "0.3.0"
          schema: "v0.3.0"
        scan_patterns:
          - 'apiVersion: ossa/v[\d.]+'
          - 'OSSA v[\d.]+'
          - 'version [\d.]+'
        output: version-audit.json

    - id: validate-schemas
      name: Validate All YAML Examples
      type: schema-validation
      schedule: weekly
      config:
        scan_paths:
          - website/content/**/*.md
          - .gitlab/agents/**/*.ossa.yaml
        extract_pattern: '```ya?ml\n([\s\S]*?)```'
        schema_url: https://openstandardagents.org/schema/v0.3.0/ossa-schema.json
        output: schema-validation.json

    - id: check-citations
      name: Verify Citation Sources
      type: citation-audit
      schedule: weekly
      config:
        scan_paths:
          - website/content/blog/**/*.md
        required_sources:
          - arxiv.org
          - github.com
          - developers.googleblog.com
        verify_accessibility: true
        output: citation-audit.json

    - id: check-brand-consistency
      name: Check Brand Messaging
      type: content-analysis
      schedule: weekly
      config:
        required_phrases:
          - "first-class citizens"
          - "vendor-neutral"
          - "open standard"
        scan_paths:
          - website/content/blog/**/*.md
          - website/app/page.tsx
        minimum_presence:
          blog_posts: 1
          homepage: 3
        output: brand-audit.json

    - id: generate-health-report
      name: Generate Weekly Health Report
      type: report-generation
      schedule: weekly
      dependsOn:
        - audit-freshness
        - validate-versions
        - validate-schemas
        - check-citations
        - check-brand-consistency
      config:
        template: |
          # Content Health Report - Week of {{week_start}}

          ## Summary

          | Metric | Status | Count |
          |--------|--------|-------|
          | Total Content | âœ… | {{total_content}} |
          | Fresh (<90 days) | {{freshness_status}} | {{fresh_count}} |
          | Stale (>90 days) | {{stale_status}} | {{stale_count}} |
          | Broken Links | {{links_status}} | {{broken_links_count}} |
          | Schema Errors | {{schema_status}} | {{schema_errors}} |
          | Version Mismatches | {{version_status}} | {{version_mismatches}} |

          ## Content Freshness

          {{#if stale_content}}
          ### Needs Review
          {{#each stale_content}}
          - **{{title}}** ({{age}} days old) - {{path}}
          {{/each}}
          {{else}}
          âœ… All content is fresh
          {{/if}}

          ## Schema Validation

          {{#if schema_errors}}
          ### Validation Errors
          {{#each schema_errors}}
          - **{{file}}**: {{error}}
          {{/each}}
          {{else}}
          âœ… All YAML examples valid
          {{/if}}

          ## Version References

          {{#if version_mismatches}}
          ### Outdated Versions
          {{#each version_mismatches}}
          - **{{file}}**: Found `{{found}}`, expected `{{expected}}`
          {{/each}}
          {{else}}
          âœ… All version references current
          {{/if}}

          ## Broken Links

          {{#if broken_links}}
          ### Links to Fix
          {{#each broken_links}}
          - {{file}}: [{{url}}]({{url}}) - {{status}}
          {{/each}}
          {{else}}
          âœ… All links working
          {{/if}}

          ## Brand Consistency

          - "First-class citizens" mentions: {{fcc_mentions}}
          - Brand compliance score: {{brand_score}}%

          ## Recommendations

          {{#each recommendations}}
          1. {{this}}
          {{/each}}

          ---
          *Generated by @ossa-moderator*
        output: weekly-health-report.md

    - id: publish-report
      name: Publish Health Report
      type: gitlab-api
      dependsOn: [generate-health-report]
      config:
        action: create_issue
        title: "ðŸ“Š Weekly Content Health Report - {{week_start}}"
        labels:
          - content-report
          - automated
        description: "{{health_report}}"
        assignee: flux423

    - id: create-remediation-issues
      name: Create Issues for Problems
      type: gitlab-api
      dependsOn: [generate-health-report]
      config:
        action: create_issues_batch
        conditions:
          - type: stale_content
            threshold: 90
            template:
              title: "ðŸ“ Review stale content: {{title}}"
              labels: [content-issue, stale, needs-author]
              assignee: ossa-author

          - type: broken_links
            threshold: 1
            template:
              title: "ðŸ”— Fix broken links in {{file}}"
              labels: [content-issue, broken-links, needs-author]
              assignee: ossa-author

          - type: schema_errors
            threshold: 1
            template:
              title: "âš ï¸ Fix schema validation in {{file}}"
              labels: [content-issue, schema-error, priority::high]
              assignee: ossa-author

  integrations:
    gitlab:
      api_version: v4
      token: ${MODERATOR_TOKEN}
      project: blueflyio/openstandardagents.org

    anthropic:
      api_key: ${ANTHROPIC_API_KEY}

    ossa_validator:
      schema_url: https://openstandardagents.org/schema/v0.3.0/ossa-schema.json

  monitoring:
    metrics:
      - audits_completed
      - issues_created
      - broken_links_found
      - stale_content_flagged
      - schema_errors_found
    alerts:
      - condition: broken_links > 10
        severity: warning
      - condition: schema_errors > 0
        severity: critical
    logs:
      level: info
      format: json
