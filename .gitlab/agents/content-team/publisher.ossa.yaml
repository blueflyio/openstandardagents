apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: content-publisher
  namespace: website-automation
  version: 1.0.0
  description: |
    Publisher agent that manages the final publication workflow for approved
    content. Handles merging, deployment scheduling, and social announcements.
  labels:
    tier: worker
    domain: content
    role: publisher
    trigger: webhook
  author:
    name: OSSA Publisher Bot
    email: publisher@openstandardagents.org
    gitlab_service_account: ossa-publisher

spec:
  role: |
    You are the Publisher Agent for openstandardagents.org. You manage the final
    stage of content lifecycle - from editor approval to live publication.

    Responsibilities:
    1. Verify editor approval is complete
    2. Schedule publication based on content calendar
    3. Merge approved MRs to release branch
    4. Trigger deployment pipeline
    5. Announce new content on social channels
    6. Update content registry/sitemap
    7. Notify team of successful publication

    Publication Guidelines:
    - Publish during peak hours (9am-11am UTC, Tue-Thu)
    - No more than 2 blog posts per week
    - Documentation updates can publish anytime
    - Major announcements require manual approval

    Output: Merged content, deployment triggered, social posts scheduled

  llm:
    provider: anthropic
    model: claude-sonnet-4-20250514
    temperature: 0.2
    max_tokens: 4096

  capabilities:
    - gitlab-api
    - deployment-management
    - social-media-scheduling
    - content-calendar
    - notification

  triggers:
    - type: webhook
      events:
        - merge_request.labeled
      filters:
        - label: editor-approved
        - label: needs-publisher

    - type: schedule
      cron: "0 9 * * 2,3,4"  # Tue-Thu 9am UTC
      description: Scheduled publication window

  tasks:
    - id: verify-approval
      name: Verify Editor Approval
      type: gitlab-api
      config:
        action: check_mr_approvals
        required_approvers:
          - ossa-editor
        minimum_approvals: 1

    - id: check-calendar
      name: Check Content Calendar
      type: calendar-check
      dependsOn: [verify-approval]
      config:
        source: .gitlab/content-calendar.yaml
        constraints:
          - max_blog_posts_per_week: 2
          - no_publish_weekends: true
          - preferred_days: [tuesday, wednesday, thursday]
          - preferred_hours: [9, 10, 11]
        output: publication-slot.json

    - id: schedule-publication
      name: Schedule Publication Time
      type: scheduling
      dependsOn: [check-calendar]
      config:
        strategy: optimal_slot
        fallback: next_available
        output: scheduled-time.json

    - id: merge-content
      name: Merge to Release Branch
      type: gitlab-api
      dependsOn: [schedule-publication]
      config:
        action: merge_mr
        options:
          squash: true
          delete_source_branch: true
          merge_commit_message: |
            content: {{title}}

            {{description}}

            Authored by: @ossa-author
            Edited by: @ossa-editor
            Published by: @ossa-publisher

            Closes #{{issue_number}}

    - id: trigger-deployment
      name: Trigger Website Deployment
      type: gitlab-api
      dependsOn: [merge-content]
      config:
        action: trigger_pipeline
        ref: release/v0.3.x
        variables:
          DEPLOYMENT_TYPE: content
          CONTENT_TYPE: "{{content_type}}"
          PURGE_CDN: true

    - id: verify-deployment
      name: Verify Deployment Success
      type: gitlab-api
      dependsOn: [trigger-deployment]
      config:
        action: wait_pipeline
        timeout: 600  # 10 minutes
        success_jobs:
          - build
          - deploy

    - id: verify-live
      name: Verify Content is Live
      type: http-check
      dependsOn: [verify-deployment]
      config:
        url: "https://openstandardagents.org/{{content_path}}"
        checks:
          - status_code: 200
          - contains_title: "{{title}}"
        retries: 3
        retry_delay: 30

    - id: update-sitemap
      name: Trigger Sitemap Regeneration
      type: gitlab-api
      dependsOn: [verify-live]
      config:
        action: trigger_pipeline
        ref: release/v0.3.x
        variables:
          JOB: sitemap:regenerate

    - id: create-social-posts
      name: Create Social Media Announcements
      type: content-generation
      dependsOn: [verify-live]
      config:
        platforms:
          - twitter:
              max_length: 280
              template: |
                {{emoji}} New from OSSA: {{title}}

                {{key_point}}

                Read more: {{url}}

                #AIAgents #OpenStandard #OSSA

          - linkedin:
              max_length: 700
              template: |
                {{title}}

                {{summary}}

                Key takeaways:
                {{#each key_points}}
                â€¢ {{this}}
                {{/each}}

                Read the full article: {{url}}

                #AIAgents #OpenStandardAgents #ArtificialIntelligence

          - discord:
              channel: announcements
              template: |
                **New Content Published!**

                ðŸ“„ **{{title}}**

                {{summary}}

                ðŸ”— Read more: {{url}}

        output: social-posts.json

    - id: schedule-social
      name: Schedule Social Posts
      type: social-scheduling
      dependsOn: [create-social-posts]
      config:
        schedule:
          twitter: immediate
          linkedin: "+2 hours"
          discord: immediate
        output: scheduled-posts.json

    - id: notify-team
      name: Notify Team of Publication
      type: notification
      dependsOn: [schedule-social]
      config:
        channels:
          - type: gitlab-comment
            issue: "{{issue_number}}"
            template: |
              ## ðŸš€ Content Published!

              **Title**: {{title}}
              **URL**: {{url}}
              **Published**: {{publish_time}}

              ### Deployment
              - Pipeline: {{pipeline_url}}
              - Status: âœ… Success

              ### Social Media
              {{#each social_posts}}
              - {{platform}}: {{status}}
              {{/each}}

              ---
              *Published by @ossa-publisher*

          - type: discord
            channel: content-updates
            template: |
              ðŸŽ‰ New content live on openstandardagents.org!

              **{{title}}**
              {{url}}

    - id: update-registry
      name: Update Content Registry
      type: file-update
      dependsOn: [notify-team]
      config:
        file: .gitlab/content-registry.json
        action: append
        data:
          title: "{{title}}"
          path: "{{content_path}}"
          type: "{{content_type}}"
          published: "{{publish_time}}"
          author: "@ossa-author"
          editor: "@ossa-editor"
          publisher: "@ossa-publisher"
          issue: "{{issue_number}}"
          mr: "{{mr_iid}}"

  integrations:
    gitlab:
      api_version: v4
      token: ${PUBLISHER_TOKEN}
      project: blueflyio/ossa/openstandardagents.org

    social:
      twitter:
        api_key: ${TWITTER_API_KEY}
        api_secret: ${TWITTER_API_SECRET}
      linkedin:
        access_token: ${LINKEDIN_TOKEN}

    discord:
      webhook_url: ${DISCORD_CONTENT_WEBHOOK}

  monitoring:
    metrics:
      - content_published
      - deployment_success_rate
      - time_to_publish
      - social_engagement
    logs:
      level: info
      format: json
