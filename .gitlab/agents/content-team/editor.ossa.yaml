apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: content-editor
  namespace: website-automation
  version: 1.0.0
  description: |
    Editor agent that reviews, improves, and approves content created by the
    author agent. Ensures quality, accuracy, and brand consistency.
  labels:
    tier: worker
    domain: content
    role: editor
    trigger: webhook
  author:
    name: OSSA Editor Bot
    email: editor@openstandardagents.org
    gitlab_service_account: ossa-editor

spec:
  role: |
    You are the Editor Agent for openstandardagents.org. You ensure all content
    meets quality standards before publication.

    Editorial Standards:
    1. Accuracy: Verify all technical claims and code examples
    2. Citations: Every claim must have a working source link
    3. Voice: Professional, authoritative, developer-friendly
    4. SEO: Proper meta tags, headings, keyword density
    5. Brand: "Treating Agents as First-Class Citizens" positioning
    6. Links: All internal and external links must work
    7. Code: All OSSA examples must validate against schema

    Review Process:
    1. Read full content for coherence and accuracy
    2. Verify every citation link is accessible
    3. Validate OSSA YAML examples against schema
    4. Check SEO metadata completeness
    5. Suggest improvements or request changes
    6. Approve when ready for publication

    Output: MR comments with suggestions, or approval for publisher

  llm:
    provider: anthropic
    model: claude-sonnet-4-20250514
    temperature: 0.2
    max_tokens: 8192

  capabilities:
    - content-review
    - link-validation
    - schema-validation
    - seo-analysis
    - gitlab-api

  triggers:
    - type: webhook
      events:
        - merge_request.labeled
      filters:
        - label: needs-editor-review

    - type: webhook
      events:
        - merge_request.updated
      filters:
        - label: revision-requested

  tasks:
    - id: fetch-content
      name: Fetch MR Content
      type: gitlab-api
      config:
        action: get_mr_changes
        file_types: [".md", ".mdx"]

    - id: validate-citations
      name: Validate All Citations
      type: link-validation
      dependsOn: [fetch-content]
      config:
        extract_pattern: '\[([^\]]+)\]\(([^)]+)\)'
        checks:
          - url_accessible
          - not_404
          - https_preferred
        output: citation-validation.json

    - id: validate-yaml
      name: Validate OSSA Examples
      type: schema-validation
      dependsOn: [fetch-content]
      config:
        extract_pattern: '```ya?ml\n([\s\S]*?)```'
        schema_path: spec/ossa-schema-v0.3.0.json
        output: yaml-validation.json

    - id: check-seo
      name: Check SEO Metadata
      type: seo-analysis
      dependsOn: [fetch-content]
      config:
        required_fields:
          - title
          - description
          - date
          - author
          - tags
        checks:
          - title_length: [30, 60]
          - description_length: [120, 160]
          - h1_count: 1
          - h2_required: true
          - internal_links: ">= 2"
        output: seo-analysis.json

    - id: review-content
      name: Editorial Review
      type: content-review
      dependsOn:
        - validate-citations
        - validate-yaml
        - check-seo
      config:
        criteria:
          accuracy: "Verify technical claims match sources"
          clarity: "Ensure content is understandable"
          voice: "Check brand consistency"
          completeness: "All sections fully developed"
          positioning: "First-class citizens theme present"

        scoring:
          pass_threshold: 80
          weights:
            accuracy: 30
            citations: 25
            seo: 20
            clarity: 15
            voice: 10

        output: editorial-review.json

    - id: generate-feedback
      name: Generate Review Feedback
      type: content-generation
      dependsOn: [review-content]
      config:
        template: |
          ## Editorial Review - {{review_date}}

          **Overall Score**: {{score}}/100 {{#if passing}}✅{{else}}❌{{/if}}

          ### Citation Validation
          {{#if citations_valid}}
          ✅ All {{citation_count}} citations verified
          {{else}}
          ❌ Issues found:
          {{#each citation_issues}}
          - Line {{line}}: [{{text}}]({{url}}) - {{issue}}
          {{/each}}
          {{/if}}

          ### OSSA Schema Validation
          {{#if yaml_valid}}
          ✅ All code examples validate against OSSA v0.3.0 schema
          {{else}}
          ❌ Validation errors:
          {{#each yaml_issues}}
          - Block {{index}}: {{error}}
          {{/each}}
          {{/if}}

          ### SEO Analysis
          {{#each seo_checks}}
          - {{name}}: {{#if passed}}✅{{else}}❌ {{issue}}{{/if}}
          {{/each}}

          ### Content Quality
          {{#each quality_feedback}}
          - **{{category}}**: {{feedback}}
          {{/each}}

          {{#if suggestions}}
          ### Suggested Improvements
          {{#each suggestions}}
          1. {{this}}
          {{/each}}
          {{/if}}

          ---
          {{#if passing}}
          ✅ **Approved for publication** - assigning to @ossa-publisher
          {{else}}
          ❌ **Revision requested** - please address the issues above
          {{/if}}

          *@ossa-editor*

    - id: post-review
      name: Post Review to MR
      type: gitlab-api
      dependsOn: [generate-feedback]
      config:
        action: add_mr_comment
        content: "{{review_feedback}}"

    - id: update-labels
      name: Update MR Labels
      type: gitlab-api
      dependsOn: [post-review]
      config:
        action: update_labels
        conditions:
          - if: "{{passing}}"
            labels_add: [editor-approved, needs-publisher]
            labels_remove: [needs-editor-review, revision-requested]
            assignee: ossa-publisher
          - else:
            labels_add: [revision-requested]
            labels_remove: [needs-editor-review]
            assignee: ossa-author

    - id: approve-mr
      name: Approve MR if Passing
      type: gitlab-api
      dependsOn: [update-labels]
      config:
        action: approve_mr
        condition: "{{passing}}"

  integrations:
    gitlab:
      api_version: v4
      token: ${EDITOR_TOKEN}
      project: blueflyio/ossa/openstandardagents.org

    anthropic:
      api_key: ${ANTHROPIC_API_KEY}

    ossa_validator:
      schema_url: https://openstandardagents.org/schema/v0.3.0/ossa-schema.json

  monitoring:
    metrics:
      - reviews_completed
      - approval_rate
      - average_revision_cycles
      - citation_issues_found
      - yaml_validation_failures
    logs:
      level: info
      format: json
