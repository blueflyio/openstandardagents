# MR Manager Agent - OSSA v0.2.8 Compliant
# Triggered by GitLab webhooks for merge request lifecycle management
# Part of BlueFly.io Agent Platform

apiVersion: ossa/v0.2.8
kind: Agent
metadata:
  name: mr-manager
  version: 1.0.0
  description: |
    Enterprise MR lifecycle manager that handles merge request automation,
    code review orchestration, merge train management, and deployment gates.
    Integrates with GitLab Ultimate features including merge trains,
    pipeline execution policies, and security scanning.
  labels:
    domain: development
    tier: production
    agent-assigned: mr-manager
    blueflyio.com/team: platform
    blueflyio.com/service: gitlab-automation
  annotations:
    openstandardagents.org/stability: stable
    blueflyio.gitlab.com/lifecycle: ready-for-dev
    blueflyio.gitlab.com/codeowner: "@platform-team"
    blueflyio.gitlab.com/commit-type: feat
    blueflyio.gitlab.com/priority: high

spec:
  taxonomy:
    domain: development
    subdomain: merge-request-management
    capability: automation

  role: |
    You are the MR Manager Agent, a critical component of the BlueFly.io
    GitLab automation platform. Your responsibilities span the entire
    merge request lifecycle:

    ## Core Responsibilities

    1. **MR Analysis & Validation**
       - Analyze MR content, changes, and commit messages
       - Validate against GitLab custom fields (commit_type, priority)
       - Check branch naming conventions and protection rules
       - Verify MR description completeness

    2. **Code Review Orchestration**
       - Assign appropriate reviewers based on CODEOWNERS
       - Coordinate with code-review-agent for automated review
       - Track review progress and resolve stale reviews
       - Manage approval rules and compliance gates

    3. **Merge Train Management**
       - Add MRs to merge train when ready
       - Monitor merge train pipeline status
       - Handle merge conflicts and rebasing
       - Coordinate parallel MR merging

    4. **Pipeline & Security Integration**
       - Monitor CI/CD pipeline status
       - Coordinate with security-scanner-agent for vulnerability checks
       - Enforce pipeline execution policies
       - Gate merges on security scan results

    5. **AgentFlow Lifecycle Transitions**
       - Move issues through: In Progress → Validation → Review → Merged
       - Update GitLab custom fields (agent_status)
       - Handle blocked states and escalations
       - Close linked issues on merge

    ## GitLab Custom Field Awareness

    - **agent_assigned**: Verify MR belongs to assigned agent
    - **agent_status**: Update status as MR progresses
    - **commit_type**: Validate conventional commit format
    - **priority**: Prioritize MR processing order
    - **release_type**: Determine version bump strategy
    - **token_estimate**: Stay within budget constraints

    ## Safety Guidelines

    - NEVER force-push to protected branches
    - NEVER merge without required approvals
    - ALWAYS verify pipeline success before merge
    - ESCALATE security vulnerabilities immediately
    - RESPECT merge request approvers' decisions

  llm:
    provider: anthropic
    model: claude-sonnet-4-5-20250929
    temperature: 0.2  # Low temperature for precise automation
    maxTokens: 16000
    topP: 0.9

    fallback_models:
      - provider: openai
        model: gpt-4o
      - provider: anthropic
        model: claude-3-5-haiku-20241022

    retry_config:
      max_attempts: 3
      backoff_strategy: exponential

    cost_tracking:
      enabled: true
      budget_alert_threshold: 25.00
      cost_allocation_tags:
        project: ossa-agents
        team: platform
        service: mr-manager

  tools:
    - type: mcp
      name: gitlab-api
      server: gitlab-mcp-server
      namespace: blueflyio
      endpoint: https://gitlab.com/api/v4

      transport:
        protocol: http
        streaming: none
        rateLimit:
          requestsPerMinute: 100
          burstLimit: 20
          strategy: token_bucket
          onExceeded: queue

      auth:
        type: bearer
        credentials: env:GITLAB_TOKEN
        scopes:
          - api
          - read_api
          - read_repository
          - write_repository

      health_check:
        enabled: true
        endpoint: /api/v4/version
        interval_seconds: 60
        timeout_seconds: 10

      circuit_breaker:
        enabled: true
        failure_threshold: 5
        timeout_seconds: 60

      capabilities:
        # MR Management
        - name: get_merge_request
          version: "2.0"
          description: Get merge request details
          scopes: [read:merge_requests]
          transport:
            protocol: http
            binding: GET /projects/{id}/merge_requests/{mr_iid}
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
            required: [project_id, mr_iid]

        - name: update_merge_request
          version: "2.0"
          description: Update merge request properties
          scopes: [write:merge_requests]
          transport:
            protocol: http
            binding: PUT /projects/{id}/merge_requests/{mr_iid}
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
              title: { type: string }
              description: { type: string }
              labels: { type: array, items: { type: string } }
              assignee_ids: { type: array, items: { type: integer } }
              reviewer_ids: { type: array, items: { type: integer } }
            required: [project_id, mr_iid]

        - name: merge_merge_request
          version: "2.0"
          description: Merge the MR (with merge train support)
          scopes: [write:merge_requests]
          transport:
            protocol: http
            binding: PUT /projects/{id}/merge_requests/{mr_iid}/merge
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
              merge_commit_message: { type: string }
              squash: { type: boolean, default: false }
              should_remove_source_branch: { type: boolean, default: true }
              merge_when_pipeline_succeeds: { type: boolean, default: true }
              auto_merge_strategy:
                type: string
                enum: [merge_train, merge_when_checks_pass]
            required: [project_id, mr_iid]

        - name: add_to_merge_train
          version: "1.0"
          description: Add MR to merge train
          scopes: [write:merge_requests]
          transport:
            protocol: http
            binding: POST /projects/{id}/merge_trains
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
              when_pipeline_succeeds: { type: boolean, default: true }
            required: [project_id, mr_iid]

        # Pipeline Management
        - name: get_pipeline_status
          version: "1.0"
          description: Get pipeline status for MR
          scopes: [read:pipelines]
          transport:
            protocol: http
            binding: GET /projects/{id}/merge_requests/{mr_iid}/pipelines
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
            required: [project_id, mr_iid]

        - name: retry_pipeline
          version: "1.0"
          description: Retry failed pipeline
          scopes: [write:pipelines]
          transport:
            protocol: http
            binding: POST /projects/{id}/pipelines/{pipeline_id}/retry
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              pipeline_id: { type: integer }
            required: [project_id, pipeline_id]

        # Review Management
        - name: get_approvals
          version: "1.0"
          description: Get MR approval status
          scopes: [read:merge_requests]
          transport:
            protocol: http
            binding: GET /projects/{id}/merge_requests/{mr_iid}/approvals
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
            required: [project_id, mr_iid]

        - name: add_comment
          version: "1.0"
          description: Add comment to MR
          scopes: [write:notes]
          transport:
            protocol: http
            binding: POST /projects/{id}/merge_requests/{mr_iid}/notes
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              mr_iid: { type: integer }
              body: { type: string }
            required: [project_id, mr_iid, body]

        # Issue Management (for linked issues)
        - name: update_issue_status
          version: "1.0"
          description: Update linked issue status
          scopes: [write:issues]
          transport:
            protocol: http
            binding: PUT /projects/{id}/issues/{issue_iid}
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
              issue_iid: { type: integer }
              labels: { type: array, items: { type: string } }
              state_event:
                type: string
                enum: [close, reopen]
            required: [project_id, issue_iid]

        - name: update_custom_fields
          version: "1.0"
          description: Update GitLab custom fields
          scopes: [write:issues]
          transport:
            protocol: http
            binding: PUT /projects/{id}/issues/{issue_iid}
          input_schema:
            type: object
            properties:
              issue_iid: { type: integer }
              agent_status:
                type: string
                enum: [ready-for-dev, assigned-to-bot, in-progress, validation, review, merged, blocked, done]
              priority:
                type: string
                enum: [critical, high, medium, low]
            required: [issue_iid]

  state:
    mode: session
    storage:
      type: kv
      retention: 7d
      config:
        provider: redis
        prefix: agent:mr-manager
        endpoint: ${REDIS_URL:-redis://localhost:6379}
      encryption:
        enabled: true
        algorithm: aes-256-gcm
        keyRef: env:AGENT_ENCRYPTION_KEY
    context_window:
      max_messages: 50
      max_tokens: 32000
      strategy: summarization

  autonomy:
    level: autonomous
    approval_required: false
    allowed_actions:
      - read_merge_requests
      - update_merge_requests
      - add_comments
      - add_labels
      - assign_reviewers
      - update_issue_status
      - retry_pipeline
      - add_to_merge_train
    blocked_actions:
      - force_merge
      - delete_branch
      - bypass_approvals
      - modify_protected_branches
    escalation_policy:
      triggers:
        - merge_conflict
        - security_vulnerability_critical
        - pipeline_failure_repeated
        - approval_timeout
      notify:
        - slack:#agent-alerts
        - gitlab:@platform-team

  constraints:
    cost:
      maxTokensPerDay: 500000
      maxTokensPerRequest: 32000
      maxCostPerDay: 50.00
      currency: USD
    performance:
      maxLatencySeconds: 30
      maxConcurrentRequests: 10
      timeoutSeconds: 120
    resources:
      cpu: "1"
      memory: 2Gi

  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://phoenix:6006/v1/traces}
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: ${PROMETHEUS_PUSHGATEWAY:-http://prometheus:9091}
    logging:
      level: info
      format: json
    alerting:
      enabled: true
      channels:
        - slack
        - webhook
      rules:
        - name: mr_processing_failed
          condition: error_count > 3
          severity: critical
        - name: merge_train_blocked
          condition: train_blocked_duration > 30m
          severity: warning
        - name: approval_stale
          condition: approval_pending_duration > 24h
          severity: info
    slo:
      availability: 99.5
      latency_p95_ms: 10000
      error_budget: 0.5

  security:
    authentication:
      required: true
      methods:
        - bearer
        - oauth2
    authorization:
      model: rbac
      roles:
        - mr-manager
        - agent-operator
      permissions:
        - merge_requests:read
        - merge_requests:write
        - pipelines:read
        - issues:write
    encryption:
      in_transit:
        enabled: true
        tls_version: "1.3"
      at_rest:
        enabled: true
        algorithm: aes-256-gcm
        key_management: vault
    secrets:
      provider: vault
      rotation:
        enabled: true
        interval_days: 90
    audit:
      enabled: true
      log_level: detailed
      retention_days: 365
      pii_redaction: true
    compliance:
      frameworks:
        - soc2
        - iso27001
      data_residency:
        - US

  reliability:
    sla:
      availability_percent: 99.5
      latency_p50_ms: 2000
      latency_p95_ms: 10000
      latency_p99_ms: 30000
      error_rate_percent: 0.5
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      timeout_seconds: 60
      half_open_requests: 3
    health_check:
      enabled: true
      endpoint: /health
      interval_seconds: 30
      timeout_seconds: 5
      unhealthy_threshold: 3
      healthy_threshold: 2
    failover:
      enabled: true
      strategy: active-passive
      fallback_agents:
        - mr-manager-backup
    disaster_recovery:
      enabled: true
      rpo_minutes: 15
      rto_minutes: 60

  collaboration:
    mode: orchestrated
    handoffs:
      - target_agent: code-review-agent
        conditions:
          - mr_needs_review
        context_transfer: full
      - target_agent: security-scanner-agent
        conditions:
          - code_changes_detected
        context_transfer: partial
      - target_agent: issue-triage-agent
        conditions:
          - linked_issue_update_needed
        context_transfer: minimal
    delegation:
      enabled: true
      allowed_agents:
        - code-review-agent
        - security-scanner-agent
        - test-runner-agent
      max_depth: 2
    communication:
      protocols:
        - mcp
        - http
      message_format: json
    orchestration:
      role: orchestrator
      workflow_engine: custom

  safety:
    content_filtering:
      enabled: true
      categories:
        - profanity
        - pii
      threshold: medium
      action: warn
    pii_detection:
      enabled: true
      types:
        - email
        - phone
        - credit_card
        - ssn
      action: redact
    rate_limiting:
      enabled: true
      requests_per_minute: 100
      requests_per_hour: 2000
      burst_limit: 20
    guardrails:
      enabled: true
      policies:
        - name: no_force_merge
          type: output
          rules:
            - deny_force_merge
        - name: require_ci_pass
          type: output
          rules:
            - require_pipeline_success
      max_tool_calls: 100
      max_execution_time_seconds: 600
    human_in_loop:
      enabled: true
      triggers:
        - high_risk_action
        - low_confidence
        - policy_violation
      timeout_seconds: 3600

  deployment:
    strategy: rolling
    canary:
      enabled: false
    rollback:
      enabled: true
      automatic: true
      triggers:
        - error_rate
        - health_check
    versioning:
      scheme: semver
      compatibility: backward
    lifecycle:
      startup_probe:
        enabled: true
        initial_delay_seconds: 5
        period_seconds: 10
        failure_threshold: 3
      readiness_probe:
        enabled: true
        period_seconds: 10
      liveness_probe:
        enabled: true
        period_seconds: 30
      graceful_shutdown:
        enabled: true
        timeout_seconds: 30

extensions:
  buildkit:
    deployment:
      replicas:
        min: 1
        max: 3
    container:
      image: ghcr.io/blueflyio/agent-mr-manager:1.0.0
      runtime: docker
      resources:
        limits:
          cpu: "1"
          memory: 2Gi
    gitlab:
      custom_fields:
        agent_assigned: mr-manager
        agent_status: ready-for-dev
        commit_type: feat
        priority: high

  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: agent-system
      labels:
        app.kubernetes.io/name: mr-manager
        app.kubernetes.io/part-of: blueflyio-agents
        blueflyio.com/agent-type: mr-manager
      annotations:
        kagent.dev/auto-restart: "true"
    deployment:
      replicas: 2
      strategy: rolling-update

  mcp:
    enabled: true
    server_type: stdio
    server_name: mr-manager-mcp
    config:
      max_message_size: 1048576
    tools:
      - name: process_mr_event
        description: Process incoming MR webhook event
        inputSchema:
          type: object
          properties:
            event_type:
              type: string
              enum: [open, update, merge, close, reopen, approve, unapprove]
            project_id: { type: integer }
            mr_iid: { type: integer }
            user: { type: string }
          required: [event_type, project_id, mr_iid]
      - name: transition_mr_status
        description: Move MR through AgentFlow lifecycle
        inputSchema:
          type: object
          properties:
            project_id: { type: integer }
            mr_iid: { type: integer }
            new_status:
              type: string
              enum: [validation, review, merged, blocked]
          required: [project_id, mr_iid, new_status]

  a2a:
    enabled: true
    agent_card:
      name: MR Manager Agent
      description: GitLab merge request lifecycle automation
      url: https://agents.blueflyio.com/mr-manager
      version: 1.0.0
      capabilities:
        - mr_analysis
        - review_orchestration
        - merge_train_management
        - pipeline_monitoring
      authentication:
        schemes:
          - bearer
      provider:
        organization: BlueFly.io
        url: https://blueflyio.com
    supported_content_types:
      - application/json
    skills:
      - id: process_mr
        name: Process Merge Request
        description: Analyze and process merge request events
        input_modes: [text, data]
        output_modes: [text, data]
    streaming: none
