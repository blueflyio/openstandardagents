apiVersion: ossa/v0.3.3
kind: Agent
metadata:
  name: version-automation-agent
  version: 1.0.0
  description: Automated version management using GitLab Ultimate Duo Agent Platform
  labels:
    - version-management
    - automation
    - gitlab-duo
    - platform-agents
spec:
  identity:
    provider: gitlab
    service_account:
      name: release-coordinator
      username: @release-coordinator
      email: release-coordinator@blueflyio.com
      display_name: Release Coordinator (Version Automation)
      roles: [maintainer]
    authentication:
      method: project_access_token
      scopes:
        - api
        - read_repository
        - write_repository
        - read_registry
      auto_refresh: true
      expiry_warning_days: 7
    token_source:
      env_var: SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN
      fallback:
        env_var: GITLAB_TOKEN

  capabilities:
    - name: version-detection
      type: analysis
      description: Detect version from multiple sources (package.json, .version.json, git tags, milestones)
      runtime: node
      timeout: 30s
      
    - name: version-bump
      type: transformation
      description: Bump version (major, minor, patch, rc, release)
      runtime: node
      timeout: 60s
      
    - name: multi-file-sync
      type: transformation
      description: Sync version across all files automatically
      runtime: node
      timeout: 120s
      
    - name: gitlab-api-integration
      type: integration
      description: Create MRs, update issues, manage milestones via GitLab API
      runtime: node
      timeout: 60s
      uses_agent: release-coordinator
      
    - name: file-pattern-detection
      type: analysis
      description: Automatically detect files that need version updates
      runtime: node
      timeout: 30s

  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-sonnet-4}
    profile: ${LLM_PROFILE:-efficient}
    temperature: 0.1
    max_tokens: 4000

  runtime:
    type: kubernetes
    namespace: agents.version-management
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi

  tasks:
    - name: detect-version-sources
      description: Find all version references in codebase
      capability: version-detection
      inputs:
        search_patterns:
          - "package.json"
          - ".version.json"
          - "**/package.json"
          - "**/*.md"
          - "**/*.yaml"
          - "**/*.yml"
          - "**/*.ts"
          - "**/*.js"
          - ".gitlab-ci.yml"
          - ".gitlab/**/*.yml"
      outputs:
        - version_sources: array
        - current_version: string
        - detected_patterns: object

    - name: bump-version
      description: Bump version based on type (major/minor/patch/rc/release)
      capability: version-bump
      inputs:
        bump_type: ${BUMP_TYPE:-patch}
        current_version: ${CURRENT_VERSION}
        target_branch: ${TARGET_BRANCH:-release/v0.3.x}
      outputs:
        - new_version: string
        - version_changes: array

    - name: sync-all-files
      description: Update version in all detected files
      capability: multi-file-sync
      inputs:
        new_version: ${NEW_VERSION}
        version_sources: ${VERSION_SOURCES}
        dry_run: ${DRY_RUN:-false}
      outputs:
        - updated_files: array
        - skipped_files: array
        - errors: array

    - name: create-version-mr
      description: Create merge request with version changes
      capability: gitlab-api-integration
      inputs:
        source_branch: ${CI_COMMIT_REF_NAME}
        target_branch: ${TARGET_BRANCH}
        title: "chore: bump version to ${NEW_VERSION}"
        description: |
          Automated version bump to ${NEW_VERSION}
          
          Updated files:
          ${UPDATED_FILES}
          
          Triggered by: ${CI_PIPELINE_SOURCE}
          Milestone: ${CI_MILESTONE_TITLE:-N/A}
      outputs:
        - mr_iid: number
        - mr_url: string

  workflows:
    - name: automated-version-bump
      description: Complete version bump workflow
      triggers:
        - type: milestone
          event: closed
          condition: milestone.title matches /v?(\d+\.\d+\.\d+)/
        - type: schedule
          cron: "0 2 * * *"  # Daily at 2 AM UTC
        - type: manual
          via: gitlab_ui
      tasks:
        - task: detect-version-sources
        - task: bump-version
          depends_on: [detect-version-sources]
        - task: sync-all-files
          depends_on: [bump-version]
        - task: create-version-mr
          depends_on: [sync-all-files]

  messaging:
    publishes:
      - channel: version.bumped
        on_event: workflow.completed
        message:
          version: ${NEW_VERSION}
          bump_type: ${BUMP_TYPE}
          updated_files: ${UPDATED_FILES}
    subscribes:
      - channel: milestone.closed
        handler: trigger-version-bump

  observability:
    traces: true
    metrics: true
    logs: true
    evidence: required

  safety:
    confirmations:
      - action: create-mr
        required: true
        message: "Create MR with version changes?"
      - action: push-to-main
        required: true
        message: "Push directly to main branch?"
    rate_limits:
      git_operations_per_hour: 50
      api_requests_per_minute: 30

extensions:
  gitlab_agent:
    config_path: .gitlab/agents/version-automation-agent/config.yaml
    capabilities:
      - kubernetes_api
      - gitlab_api
      - file_operations
    policy:
      default: deny
      allow:
        - action: read
          resource: repository
        - action: write
          resource: merge_requests
          condition: target_branch != "main"
        - action: read
          resource: milestones
        - action: read
          resource: issues

  vast_ai:
    enabled: ${VAST_AI_ENABLED:-false}
    instance_type: ${VAST_AI_INSTANCE:-RTX3090}
    auto_scale: true
    max_instances: 3
    cost_budget_per_hour: 2.0
