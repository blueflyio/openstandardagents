# ============================================================================
# Version Manager Agent Workflow - GitLab CI/CD Integration
# ============================================================================
#
# PURPOSE:
#   GitLab CI/CD workflow that uses the version-manager agent to automate
#   version operations. Demonstrates "dogfooding" by using OSSA agents
#   to manage OSSA itself.
#
# TRIGGERS:
#   - Manual: "Bump Version" button in GitLab UI
#   - Scheduled: Daily version consistency check
#   - Milestone: Auto-bump when milestone closes
#   - Webhook: Version bump request from external system
#
# ============================================================================

apiVersion: workflow.ossa.io/v1
kind: AgentWorkflow

metadata:
  name: version-management-workflow
  namespace: version-management

spec:
  triggers:
    - type: manual
      name: bump-version
      description: Manually trigger version bump
      parameters:
        - name: bump_type
          type: string
          enum: [major, minor, patch, rc, release]
          required: true
        - name: target_branch
          type: string
          default: development
          enum: [development, main]

    - type: scheduled
      name: version-consistency-check
      schedule: "0 2 * * *"  # Daily at 2 AM
      description: Daily version consistency validation

    - type: milestone
      name: milestone-version-bump
      condition: milestone_closed
      description: Auto-bump version when milestone closes

  steps:
    - name: validate-current-version
      agent: version-manager
      capability: validate_version_consistency
      input:
        check_mode: true
      on_failure: abort

    - name: detect-bump-type
      agent: version-manager
      capability: detect_bump_type
      input:
        source: milestone  # or manual, scheduled
        milestone_id: ${CI_MILESTONE_ID}
      condition: ${BUMP_TYPE == null}

    - name: bump-version
      agent: version-manager
      capability: version_bump
      input:
        bump_type: ${BUMP_TYPE}
        current_version: ${CURRENT_VERSION}
      on_failure: rollback

    - name: sync-versions
      agent: version-manager
      capability: version_sync
      input:
        version: ${NEW_VERSION}
        files:
          - package.json
          - website/package.json
          - README.md
          - CHANGELOG.md
          - RELEASING.md
          - website/content/docs/**/*.md
      on_failure: rollback

    - name: process-docs
      agent: version-manager
      capability: docs_process
      input:
        version: ${NEW_VERSION}
        templates:
          - website/content/docs/**/*.md
      on_failure: rollback

    - name: validate-sync
      agent: version-manager
      capability: validate_version_consistency
      input:
        check_mode: true
        expected_version: ${NEW_VERSION}
      on_failure: rollback

    - name: create-version-branch
      agent: version-manager
      capability: git_operations
      input:
        operation: create_branch
        branch_name: "chore/version-bump-${NEW_VERSION}"
        from_branch: ${TARGET_BRANCH}

    - name: commit-changes
      agent: version-manager
      capability: git_operations
      input:
        operation: commit
        message: "chore: bump version to ${NEW_VERSION}"
        files:
          - .version.json
          - package.json
          - website/package.json
          - README.md
          - CHANGELOG.md
          - RELEASING.md
          - spec/v${NEW_VERSION}/
          - website/content/docs/

    - name: push-branch
      agent: version-manager
      capability: git_operations
      input:
        operation: push
        branch: "chore/version-bump-${NEW_VERSION}"
        remote: origin

    - name: create-merge-request
      agent: version-manager
      capability: gitlab_api
      input:
        operation: create_merge_request
        source_branch: "chore/version-bump-${NEW_VERSION}"
        target_branch: ${TARGET_BRANCH}
        title: "chore: bump version to ${NEW_VERSION}"
        description: |
          Automated version bump to ${NEW_VERSION}
          
          Changes:
          - Updated .version.json
          - Synced package.json files
          - Updated documentation
          - Created spec/v${NEW_VERSION}/ directory
          
          Triggered by: ${TRIGGER_SOURCE}
        labels:
          - version-bump
          - automated
          - chore
        remove_source_branch: true

    - name: notify-team
      agent: version-manager
      capability: gitlab_api
      input:
        operation: create_issue_comment
        issue_id: ${MR_IID}
        comment: |
          ✅ Version bump to ${NEW_VERSION} completed successfully!
          
          **Changes:**
          - Version bumped: ${CURRENT_VERSION} → ${NEW_VERSION}
          - Files synchronized: ${SYNCED_FILES_COUNT}
          - Documentation processed: ${DOCS_PROCESSED_COUNT}
          
          **Next Steps:**
          1. Review the merge request
          2. Merge when ready
          3. Tag will be created automatically on merge

  rollback:
    - name: revert-version-changes
      agent: version-manager
      capability: git_operations
      input:
        operation: reset
        to_commit: ${PREVIOUS_COMMIT}

  notifications:
    - type: gitlab_issue
      on: success
      message: "✅ Version bump to ${NEW_VERSION} completed"
    - type: gitlab_issue
      on: failure
      message: "❌ Version bump failed: ${ERROR_MESSAGE}"

