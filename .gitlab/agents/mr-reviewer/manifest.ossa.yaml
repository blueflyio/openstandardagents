apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: mr-reviewer
  version: 1.0.0
  description: Automated merge request reviewer for code quality, security, and best practices
  labels:
    domain: quality-assurance
    subdomain: code-review
    autonomy: fully_autonomous
    use-case: merge-request-review
    ossa-version: v0.3.0
  annotations:
    gitlab.com/service-account: bot-mr-reviewer
spec:
  role: |
    You are @bot-mr-reviewer, the automated merge request reviewer for BlueFly.io projects.
    
    You review merge requests comprehensively and provide actionable feedback. You work alongside 
    other specialized agents and coordinate their findings.
    
    Review Checklist:
    1. Code Quality - Follows standards, no code smells, proper error handling, no hardcoded values
    2. Testing - Tests added/updated, coverage ≥80%, meaningful tests
    3. Documentation - README, API docs, inline comments, CHANGELOG
    4. Commits - Conventional format, issue references, descriptive messages
    5. Security - No secrets, dependencies audited, input validation, auth checks
    6. Performance - No obvious issues, optimized queries, caching considered
    7. Integration - Other agent validations passed (OSSA, Drupal, Config, Pipeline)
    
    Auto-approve if ALL conditions met:
    - All agent validations passed
    - Pipeline is green
    - No security issues
    - Test coverage ≥ 80%
    - Conventional commits used
    - Author is @bluefly (solo developer workflow)
    - Target branch is release/* (not main)
    
    Coordinate with other agents:
    - bot-ossa-validator: OSSA schema validation
    - bot-drupal-standards: Drupal code standards
    - bot-config-auditor: Config security
    - bot-gitlab-ci-fixer: Pipeline issues
    - bot-wiki-aggregator: Documentation sync
    
    Your role is to orchestrate their findings and make the final approval decision.
    
    Tone: Professional but friendly, constructive, specific and actionable, acknowledge good work.
  llm:
    provider: anthropic
    model: claude-sonnet-4.5-20250929
    temperature: 0.1
    fallback_models:
      - provider: openai
        model: gpt-4o
      - provider: anthropic
        model: claude-haiku-3.5
    retry_config:
      max_attempts: 3
      backoff_strategy: exponential
    cost_tracking:
      enabled: true
      budget_alert_threshold: 20
      cost_allocation_tags:
        project: ossa-agents
        team: platform
        service: mr-reviewer
  capabilities:
    - code-review
    - security-review
    - test-coverage-check
    - documentation-check
    - comment-generation
    - approval-decision
  tasks:
    - name: code-review
      description: Review code changes for quality and best practices
      steps:
        - name: fetch-mr-changes
          action: exec
          command: |
            curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              "${CI_API_V4_URL}/projects/${project_id}/merge_requests/${merge_request_id}/changes" \
              | jq -r '.changes[] | "\(.new_path): \(.diff)"'
        - name: analyze-code-quality
          action: exec
          command: |
            echo "Analyzing code quality..."
            # Code quality checks would go here
        - name: check-test-coverage
          action: exec
          command: |
            echo "Checking test coverage..."
            # Test coverage checks would go here
        - name: generate-review-comments
          action: exec
          command: |
            echo "Generating review comments..."
            # Review comment generation would go here
        - name: post-review
          action: exec
          command: |
            echo "Posting review to MR..."
            # Post review comments to GitLab MR
  tools:
    - type: http
      name: gitlab_api
    - type: function
      name: diff_analyzer
    - type: function
      name: security_scanner
  observability:
    logging:
      level: info
      format: json
    metrics:
      enabled: true
      port: 9090
  security:
    authentication:
      required: true
      method: service_account
    authorization:
      required: true
      scopes:
        - api
        - read_repository
        - write_repository
extensions:
  gitlab_duo:
    enabled: true
    flow_execution: true
    model: claude-sonnet-4.5-20250929
