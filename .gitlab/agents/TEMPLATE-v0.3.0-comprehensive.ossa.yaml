# ============================================================================
# OSSA v0.3.0 COMPREHENSIVE TEMPLATE - ALL FEATURES
# ============================================================================
# This template demonstrates EVERY feature available in OSSA v0.3.0:
# - Agent kind with full spec
# - All extensions (KAgent, GitLab Duo, MCP)
# - Complete observability, safety, autonomy, constraints
# - Runtime bindings
# - Use this as reference for updating all agents
# ============================================================================

apiVersion: ossa/v0.3.0
kind: Agent
metadata:
  name: template-agent-v0-3-0
  version: 1.0.0
  description: "Comprehensive OSSA v0.3.0 template showcasing all features"
  labels:
    domain: platform
    tier: production
    team: platform
    environment: production
    ossa-version: v0.3.0
  annotations:
    openstandardagents.org/stability: stable
    openstandardagents.org/showcase: "true"
    gitlab.com/duo-integration: enabled

spec:
  # ==========================================================================
  # ROLE: Agent Behavior & Expertise
  # ==========================================================================
  role: |
    You are an expert platform agent demonstrating OSSA v0.3.0 capabilities.
    You showcase all features including KAgent integration, GitLab Duo flows,
    MCP tools, observability, safety, and autonomous operations.

  # ==========================================================================
  # LLM CONFIGURATION: Model Selection & Behavior
  # ==========================================================================
  llm:
    provider: ${LLM_PROVIDER:-anthropic}
    model: ${LLM_MODEL:-claude-sonnet-4.5-20250929}
    temperature: 0.2
    maxTokens: 16000
    topP: 0.9
    
    fallback_models:
      - provider: openai
        model: gpt-4o
      - provider: anthropic
        model: claude-haiku-3.5
    
    retry_config:
      max_attempts: 3
      backoff_strategy: exponential
      initial_delay_ms: 1000
    
    cost_tracking:
      enabled: true
      budget_alert_threshold: 50.00
      cost_allocation_tags:
        project: ossa-showcase
        team: platform

  # ==========================================================================
  # TOOLS: MCP Server Integration
  # ==========================================================================
  tools:
    - type: mcp
      name: gitlab-api
      server: gitlab-mcp-server
      namespace: blueflyio
      endpoint: https://gitlab.com/api/v4
      
      transport:
        protocol: http
        streaming: none
        rateLimit:
          requestsPerMinute: 100
          burstLimit: 20
          strategy: token_bucket
          onExceeded: queue
      
      auth:
        type: bearer
        credentials: env:GITLAB_TOKEN
        scopes:
          - api
          - read_api
          - write_api
      
      circuit_breaker:
        enabled: true
        failure_threshold: 5
        timeout_seconds: 60
      
      capabilities:
        - name: get_project
          version: "2.0"
          description: Get GitLab project details
          scopes: [read:projects]
          transport:
            protocol: http
            binding: GET /projects/{id}
          input_schema:
            type: object
            properties:
              project_id: { type: integer }
            required: [project_id]

    - type: mcp
      name: kubernetes-api
      server: kubernetes-mcp-server
      endpoint: ${K8S_API_ENDPOINT}
      
      transport:
        protocol: http
        streaming: none
      
      auth:
        type: bearer
        credentials: file:/var/run/secrets/kubernetes.io/serviceaccount/token
      
      capabilities:
        - name: get_pods
          version: "1.0"
          description: Get Kubernetes pods
          input_schema:
            type: object
            properties:
              namespace: { type: string }
            required: [namespace]

  # ==========================================================================
  # AUTONOMY: Permission Model & Action Gates
  # ==========================================================================
  autonomy:
    level: autonomous
    approval_required: false
    
    allowed_actions:
      - read_projects
      - read_pipelines
      - read_merge_requests
      - analyze_code
      - generate_reports
    
    blocked_actions:
      - delete_projects
      - modify_protected_branches
      - bypass_security_scans
    
    escalation_policy:
      triggers:
        - breaking_change_detected
        - security_violation
        - cost_threshold_exceeded
      notify:
        - slack:#platform-alerts
        - gitlab:@platform-team

  # ==========================================================================
  # CONSTRAINTS: Cost & Performance Limits
  # ==========================================================================
  constraints:
    cost:
      maxTokensPerDay: 500000
      maxTokensPerRequest: 32000
      maxCostPerDay: 50.00
      currency: USD
    
    performance:
      maxLatencySeconds: 45
      maxConcurrentRequests: 10
      timeoutSeconds: 180
    
    resources:
      cpu: "1"
      memory: 2Gi

  # ==========================================================================
  # STATE: Long-Running State Management
  # ==========================================================================
  state:
    mode: long_running
    storage:
      type: kv
      retention: 30d
      config:
        provider: redis
        prefix: agent:template
        endpoint: ${REDIS_URL:-redis://localhost:6379}
      encryption:
        enabled: true
        algorithm: aes-256-gcm
        keyRef: env:AGENT_ENCRYPTION_KEY
    
    context_window:
      max_messages: 100
      max_tokens: 64000
      strategy: summarization

  # ==========================================================================
  # OBSERVABILITY: Tracing, Metrics, Logging
  # ==========================================================================
  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://phoenix:6006/v1/traces}
      sampling_rate: 1.0
    
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: ${PROMETHEUS_PUSHGATEWAY:-http://prometheus:9091}
      customMetrics:
        - name: agent_requests_total
          type: counter
          description: Total agent requests
        - name: agent_latency_seconds
          type: histogram
          description: Agent request latency
    
    logging:
      level: info
      format: json
    
    alerting:
      enabled: true
      channels:
        - slack
        - webhook
      rules:
        - name: high_error_rate
          condition: error_rate > 0.05
          severity: warning

  # ==========================================================================
  # SAFETY: Content Filtering & Guardrails
  # ==========================================================================
  safety:
    content_filtering:
      enabled: true
      categories:
        - pii
        - credentials
        - malicious_code
      threshold: high
      action: block
    
    pii_detection:
      enabled: true
      types:
        - email
        - phone
        - api_key
        - password
        - credit_card
      action: redact
    
    rate_limiting:
      enabled: true
      requests_per_minute: 100
      burst_limit: 20
    
    guardrails:
      enabled: true
      policies:
        - name: no_destructive_actions
          type: output
          rules:
            - no_delete_operations
            - no_protected_branch_modifications
      max_tool_calls: 100
      max_execution_time_seconds: 600
    
    human_in_loop:
      enabled: true
      triggers:
        - high_risk_action
        - breaking_change
        - compliance_violation

  # ==========================================================================
  # TRIGGERS: Event-Driven Activation
  # ==========================================================================
  triggers:
    - type: webhook
      event: merge_request
      conditions:
        - object_attributes.action == "open"
        - object_attributes.target_branch == "main"
    
    - type: webhook
      event: pipeline
      conditions:
        - object_attributes.status == "failed"
    
    - type: schedule
      cron: "0 */6 * * *"
      timezone: UTC

  # ==========================================================================
  # COLLABORATION: Agent-to-Agent Communication
  # ==========================================================================
  collaboration:
    mode: collaborative
    handoffs:
      - target_agent: security-scanner
        conditions:
          - security_issue_detected
        context_transfer: partial
      - target_agent: cost-analyzer
        conditions:
          - cost_optimization_needed
        context_transfer: minimal
    
    delegation:
      enabled: true
      allowed_agents:
        - security-scanner
        - performance-optimizer
      max_depth: 2
    
    communication:
      protocols:
        - mcp
        - http
        - json-rpc
      message_format: json

  # ==========================================================================
  # RELIABILITY: SLA & Circuit Breaker
  # ==========================================================================
  reliability:
    sla:
      availability_percent: 99.0
      latency_p95_ms: 15000
      error_rate_percent: 1.0
    
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      timeout_seconds: 60
      half_open_requests: 3
    
    health_check:
      enabled: true
      interval_seconds: 30
      timeout_seconds: 5
    
    failover:
      enabled: true
      strategy: active-passive

  # ==========================================================================
  # DEPLOYMENT: Lifecycle Management
  # ==========================================================================
  deployment:
    strategy: rolling
    rollback:
      enabled: true
      automatic: true
    versioning:
      scheme: semver
      compatibility: backward
    lifecycle:
      startup_probe:
        enabled: true
        initial_delay_seconds: 5
        period_seconds: 10
        failure_threshold: 3
      readiness_probe:
        enabled: true
        period_seconds: 10
      liveness_probe:
        enabled: true
        period_seconds: 30
      graceful_shutdown:
        enabled: true
        timeout_seconds: 30

# ============================================================================
# EXTENSIONS: Framework-Specific Integrations
# ============================================================================

extensions:
  # ========================================================================
  # KAGENT: Kubernetes-Native Agent Deployment
  # ========================================================================
  kagent:
    api_version: kagent.dev/v1alpha2
    kubernetes:
      namespace: agent-system
      labels:
        app.kubernetes.io/name: template-agent
        app.kubernetes.io/part-of: ossa-showcase
        app.kubernetes.io/version: "1.0.0"
        openstandardagents.org/version: v0.3.0
      annotations:
        description: "OSSA v0.3.0 showcase agent"
        contact: "platform-team@bluefly.io"
      resourceLimits:
        cpu: "1"
        memory: 2Gi
        ephemeral-storage: 10Gi
    
    deployment:
      replicas:
        min: 2
        max: 5
      strategy: rolling-update
      podDisruptionBudget:
        minAvailable: 1
    
    guardrails:
      requireApproval: false
      costLimits:
        maxTokensPerDay: 500000
        maxCostPerDay: 50.00
        currency: USD
      allowedActions:
        - kubernetes:get:pods
        - kubernetes:get:services
        - kubernetes:get:configmaps
      auditLog:
        destination: compliance-engine
        retention: 7years
    
    a2aConfig:
      enabled: true
      protocol: json-rpc
      endpoints:
        - http://security-scanner:8080/a2a
        - http://cost-analyzer:8080/a2a
      authentication:
        type: mtls
    
    meshIntegration:
      enabled: true
      istioIntegration: true
      ambientMesh: true

  # ========================================================================
  # GITLAB DUO: GitLab Duo Agent Platform Integration
  # ========================================================================
  gitlab_duo:
    enabled: true
    flow_execution: true
    model: ${GITLAB_DUO_MODEL:-claude-sonnet-4.5-20250929}
    
    # GitLab Duo Flow Configuration
    flows:
      - name: code-review-flow
        path: .gitlab/flows/code-review-flow.yaml
        triggers:
          - event: merge_request
            conditions:
              - target_branch == "main"
      
      - name: pipeline-optimization-flow
        path: .gitlab/flows/pipeline-optimization-flow.yaml
        triggers:
          - event: pipeline
            conditions:
              - status == "failed"
    
    # GitLab Knowledge Graph Integration
    knowledge_graph:
      enabled: true
      index_on_push: true
      query_enabled: true
    
    # GitLab Duo Agent Card
    agent_card:
      name: Template Agent v0.3.0
      description: Comprehensive OSSA v0.3.0 showcase agent
      capabilities:
        - code-analysis
        - pipeline-optimization
        - security-scanning
      authentication:
        schemes:
          - bearer
          - oauth2

  # ========================================================================
  # MCP: Model Context Protocol Extension
  # ========================================================================
  mcp:
    enabled: true
    server_type: stdio
    server_name: template-agent-mcp
    tools:
      - name: analyze_code
        description: Analyze code for quality and security
        inputSchema:
          type: object
          properties:
            file_path: { type: string }
            analysis_type: 
              type: string
              enum: [quality, security, performance]
          required: [file_path]
      - name: optimize_pipeline
        description: Optimize GitLab CI/CD pipeline
        inputSchema:
          type: object
          properties:
            project_id: { type: integer }
            pipeline_id: { type: integer }
          required: [project_id, pipeline_id]
    resources:
      - uri: gitlab://project/{project_id}/repository
        name: gitlab-repository
        description: GitLab repository resources
        mimeType: application/json
    prompts:
      - name: code-review-prompt
        description: Template for code review analysis
        arguments:
          - name: code_diff
            description: Git diff of changes
            required: true

# ============================================================================
# RUNTIME: Runtime-Specific Capability Bindings (for Task/Workflow)
# ============================================================================
# Note: Runtime bindings are used for Task and Workflow kinds
# For Agent kind, runtime is inferred from extensions.kagent
runtime:
  type: kubernetes
  bindings:
    gitlab_api:
      capability: gitlab_api_access
      binding: service_account
      service_account: gitlab-agent-sa
    kubernetes_api:
      capability: kubernetes_cluster_access
      binding: service_account
      service_account: k8s-agent-sa

