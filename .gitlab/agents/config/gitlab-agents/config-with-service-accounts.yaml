# GitLab Kubernetes Agent Configuration with Service Accounts
# Production-ready configuration using GitLab service accounts for automation
#
# SETUP:
# 1. Create service accounts in GitLab: https://gitlab.com/groups/blueflyio/-/settings/service_accounts
# 2. Generate Personal Access Tokens (PAT) for each service account
# 3. Configure CI/CD variables with service account tokens
# 4. Update this config to reference service accounts
#
# SERVICE ACCOUNTS NEEDED:
# - version-manager-service-account: Version management operations
# - deployment-service-account: Deployment operations
# - monitoring-service-account: Monitoring and observability
# - security-service-account: Security scanning operations

# User access configuration
# Grants Kubernetes cluster access to project/group members and activates Dashboard for Kubernetes
user_access:
  # Access method: agent impersonation (works on all GitLab tiers including Free)
  # All requests are forwarded to the API server using the agent service account
  access_as:
    agent: {}

  # Projects whose members should have access to this agent
  projects:
    - id: blueflyio/ossa/openstandardagents

  # Groups whose members should have access to this agent
  groups:
    - id: blueflyio
    - id: blueflyio/agent-platform

# CI/CD access configuration with service account impersonation
# Uses service accounts for automated operations instead of user impersonation
# More secure and auditable than user-based access
ci_access:
  # Projects whose CI/CD pipelines can access the cluster
  projects:
    - id: blueflyio/ossa/openstandardagents
      access_as:
        # Use service account for version management operations
        service_account:
          # Service account name (created in GitLab group settings)
          name: version-manager-service-account
          # Optional: Specific namespace for this service account
          namespace: version-management

  # Groups whose CI/CD pipelines can access the cluster
  groups:
    - id: blueflyio
      access_as:
        # Use service account for deployment operations
        service_account:
          name: deployment-service-account
          namespace: deployment-system

# Service account access configuration
# Defines which service accounts can access the cluster and what they can do
service_account_access:
  # Version management service account
  - name: version-manager-service-account
    namespace: version-management
    # Permissions for version management
    permissions:
      - apiGroups: [""]
        resources: ["configmaps", "secrets"]
        verbs: ["get", "list", "watch", "create", "update", "patch"]
      - apiGroups: ["apps"]
        resources: ["deployments"]
        verbs: ["get", "list", "watch"]
    # GitLab API scopes required
    gitlab_scopes:
      - api
      - write_repository
      - read_repository

  # Deployment service account
  - name: deployment-service-account
    namespace: deployment-system
    permissions:
      - apiGroups: [""]
        resources: ["pods", "services", "configmaps", "secrets"]
        verbs: ["*"]
      - apiGroups: ["apps"]
        resources: ["deployments", "statefulsets", "daemonsets"]
        verbs: ["*"]
    gitlab_scopes:
      - api
      - write_repository
      - read_repository

  # Monitoring service account
  - name: monitoring-service-account
    namespace: observability-system
    permissions:
      - apiGroups: [""]
        resources: ["pods", "services"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["apps"]
        resources: ["deployments"]
        verbs: ["get", "list", "watch"]
    gitlab_scopes:
      - api
      - read_repository

  # Security service account
  - name: security-service-account
    namespace: security-system
    permissions:
      - apiGroups: [""]
        resources: ["pods", "secrets"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["apps"]
        resources: ["deployments"]
        verbs: ["get", "list", "watch"]
    gitlab_scopes:
      - api
      - read_repository

# GitOps configuration (optional)
# Enables GitLab to manage Kubernetes resources via GitOps workflows
gitops:
  manifest_projects:
    - id: blueflyio/ossa/openstandardagents
      default_namespace: ossa-agents
      paths:
        - glob: '.gitlab/agents/**/*.yaml'
        - glob: 'infrastructure/k8s/**/*.yaml'
      # Use service account for GitOps operations
      access_as:
        service_account:
          name: gitops-service-account
          namespace: gitops-system

# Observability configuration
observability:
  logging:
    level: info
  
  metrics:
    enabled: true

# Agent configuration
agent:
  health:
    enabled: true
    interval: 30s
    timeout: 10s
  
  connection:
    max_connections: 100
    timeout: 60s
    keep_alive: 30s

# Security configuration
security:
  network_policy:
    enabled: true
  
  tls:
    verify: true
    min_version: "1.2"

# Service account token management
# Automatically rotates service account tokens
token_management:
  enabled: true
  rotation_period: 90d
  # Notify before expiration
  expiration_notification: 7d

