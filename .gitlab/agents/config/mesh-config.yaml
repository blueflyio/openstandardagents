# ============================================================================
# Agent Mesh Configuration - Multi-Agent Coordination
# ============================================================================
#
# PURPOSE:
#   Defines the agent mesh network topology, communication protocols, and
#   workflow orchestration for coordinated multi-agent operations.
#
# AGENT MESH TOPOLOGY:
#   This configuration establishes a service mesh for agent-to-agent (A2A)
#   communication, enabling complex workflows like:
#   - Deployment pipelines (config-validator → db-migrator → monitoring → rollback)
#   - Security remediation (security-scanner → compliance-auditor → rollback)
#   - Cost optimization (cost-analyzer → performance-optimizer)
#   - Incident response (monitoring → rollback → security)
#
# ============================================================================

apiVersion: mesh.ossa.io/v1
kind: AgentMesh
metadata:
  name: gitlab-k8s-agent-mesh
  namespace: agent-mesh-system
  labels:
    environment: production
    deployment: kubernetes
    mesh-version: v1.0.0

spec:
  # ==========================================================================
  # MESH TOPOLOGY: Agent Discovery and Registration
  # ==========================================================================
  agents:
    - name: security-scanner
      namespace: security-system
      endpoint: http://security-scanner:8080
      healthCheck: http://security-scanner:8080/health
      capabilities:
        - vulnerability-scanning
        - secret-detection
        - rbac-audit
        - cve-analysis
      dependencies: []  # No dependencies (can run standalone)

    - name: performance-optimizer
      namespace: platform-system
      endpoint: http://performance-optimizer:8080
      healthCheck: http://performance-optimizer:8080/health
      capabilities:
        - resource-optimization
        - hpa-recommendations
        - vpa-recommendations
        - latency-analysis
      dependencies:
        - cost-analyzer  # Coordinate for cost-aware optimizations

    - name: db-migrator
      namespace: data-system
      endpoint: http://db-migrator:8080
      healthCheck: http://db-migrator:8080/health
      capabilities:
        - schema-migration
        - data-migration
        - rollback-generation
        - integrity-validation
      dependencies:
        - rollback-coordinator  # Coordinate rollback on migration failure

    - name: config-validator
      namespace: platform-system
      endpoint: http://config-validator:8080
      healthCheck: http://config-validator:8080/health
      capabilities:
        - kubernetes-validation
        - helm-linting
        - opa-policy-enforcement
        - secret-detection
      dependencies:
        - security-scanner  # Delegate secret detection

    - name: monitoring-agent
      namespace: observability-system
      endpoint: http://monitoring-agent:8080
      healthCheck: http://monitoring-agent:8080/health
      capabilities:
        - metrics-analysis
        - anomaly-detection
        - slo-tracking
        - dora-metrics
        - incident-management
      dependencies:
        - rollback-coordinator  # Trigger rollback on incidents
        - performance-optimizer  # Coordinate performance analysis

    - name: rollback-coordinator
      namespace: deployment-system
      endpoint: http://rollback-coordinator:8080
      healthCheck: http://rollback-coordinator:8080/health
      capabilities:
        - deployment-rollback
        - database-rollback
        - config-rollback
        - traffic-shifting
      dependencies:
        - db-migrator  # Coordinate database rollbacks
        - monitoring-agent  # Receive failure alerts

    - name: cost-analyzer
      namespace: finops-system
      endpoint: http://cost-analyzer:8080
      healthCheck: http://cost-analyzer:8080/health
      capabilities:
        - cost-tracking
        - idle-resource-detection
        - right-sizing
        - spot-instance-recommendations
        - reserved-instance-recommendations
      dependencies:
        - performance-optimizer  # Coordinate cost-aware optimizations

    - name: compliance-auditor
      namespace: compliance-system
      endpoint: http://compliance-auditor:8080
      healthCheck: http://compliance-auditor:8080/health
      capabilities:
        - soc2-compliance
        - hipaa-compliance
        - pci-dss-compliance
        - gdpr-compliance
        - fedramp-compliance
      dependencies:
        - security-scanner  # Coordinate security compliance
        - config-validator  # Coordinate policy compliance

    - name: version-manager
      namespace: version-management
      endpoint: http://version-manager:8080
      healthCheck: http://version-manager:8080/health
      capabilities:
        - version-bumping
        - version-synchronization
        - documentation-processing
        - git-operations
        - milestone-integration
        - mr-creation
      dependencies: []  # No dependencies (can run standalone)

  # ==========================================================================
  # COMMUNICATION PROTOCOL: Agent-to-Agent (A2A) Configuration
  # ==========================================================================
  communication:
    protocol: json-rpc
    version: "2.0"
    transport: http
    timeout: 30  # 30 second default timeout for A2A calls

    # mTLS authentication for all agent-to-agent communication
    authentication:
      type: mtls
      ca:
        secret: agent-mesh-ca
        namespace: agent-mesh-system
      clientCerts:
        autoGenerate: true
        rotationPeriod: 90days
        certManager:
          enabled: true
          issuer: agent-mesh-issuer

    # Request/response format
    messageFormat:
      contentType: application/json
      encoding: utf-8
      compression: gzip  # Optional gzip compression for large payloads

    # Retry policy for failed A2A calls
    retryPolicy:
      maxRetries: 3
      initialBackoff: 1s
      maxBackoff: 10s
      backoffMultiplier: 2

    # Circuit breaker configuration
    circuitBreaker:
      enabled: true
      failureThreshold: 5  # Open circuit after 5 consecutive failures
      successThreshold: 2  # Close circuit after 2 consecutive successes
      timeout: 30s
      halfOpenRequests: 3

  # ==========================================================================
  # SERVICE MESH INTEGRATION: Istio Configuration
  # ==========================================================================
  serviceMesh:
    enabled: true
    provider: istio
    version: 1.20.0

    # Istio sidecar injection
    sidecarInjection:
      enabled: true
      namespaces:
        - security-system
        - platform-system
        - data-system
        - observability-system
        - deployment-system
        - finops-system
        - compliance-system

    # mTLS enforcement
    mtls:
      mode: STRICT  # Require mTLS for all inter-agent traffic
      permissiveMode: false

    # Traffic policies
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
        http:
          http2MaxRequests: 1000
          maxRequestsPerConnection: 2
      loadBalancer:
        simple: LEAST_REQUEST
      outlierDetection:
        consecutiveErrors: 5
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 50

    # Virtual services for traffic routing
    virtualServices:
      - name: agent-mesh-routing
        hosts:
          - "*.agent-mesh.svc.cluster.local"
        http:
          - match:
              - headers:
                  x-agent-mesh-version:
                    exact: v1
            route:
              - destination:
                  host: agent-mesh-gateway
                  subset: v1

  # ==========================================================================
  # OBSERVABILITY: Mesh-Level Monitoring
  # ==========================================================================
  observability:
    # Distributed tracing
    tracing:
      enabled: true
      samplingRate: 1.0  # 100% sampling for agent mesh traffic
      exporter: jaeger
      endpoint: http://jaeger-collector.observability-system:14268/api/traces

    # Metrics collection
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus.observability-system:9090/metrics
      customMetrics:
        - name: agent_mesh_requests_total
          type: counter
          description: "Total A2A requests in mesh"
          labels: [source_agent, target_agent, status]
        - name: agent_mesh_latency_seconds
          type: histogram
          description: "A2A request latency"
          labels: [source_agent, target_agent]
        - name: agent_mesh_failures_total
          type: counter
          description: "Total A2A request failures"
          labels: [source_agent, target_agent, error_type]

    # Logging
    logging:
      level: info
      format: json
      destination: stdout

  # ==========================================================================
  # WORKFLOW ORCHESTRATION: Common Agent Workflows
  # ==========================================================================
  workflows:
    # Deployment pipeline workflow
    - name: deployment-pipeline
      description: |
        End-to-end deployment workflow with validation, migration, monitoring,
        and automated rollback on failure.
      steps:
        - agent: config-validator
          action: validate_kubernetes_manifests
          onFailure: abort

        - agent: security-scanner
          action: scan_container_images
          onFailure: abort

        - agent: compliance-auditor
          action: audit_deployment_compliance
          onFailure: abort

        - agent: db-migrator
          action: execute_migrations
          onFailure: rollback

        - agent: monitoring-agent
          action: start_deployment_monitoring
          timeout: 300s

        - agent: rollback-coordinator
          action: standby_for_rollback
          trigger: monitoring_failure

    # Security remediation workflow
    - name: security-remediation
      description: |
        Automated security vulnerability remediation workflow.
      steps:
        - agent: security-scanner
          action: scan_vulnerabilities

        - agent: compliance-auditor
          action: validate_remediation_compliance

        - agent: config-validator
          action: validate_security_patches

        - agent: rollback-coordinator
          action: rollback_on_security_failure

    # Cost optimization workflow
    - name: cost-optimization
      description: |
        Collaborative cost optimization between cost-analyzer and
        performance-optimizer to ensure optimizations don't degrade performance.
      steps:
        - agent: cost-analyzer
          action: identify_cost_savings

        - agent: performance-optimizer
          action: validate_performance_impact

        - agent: monitoring-agent
          action: track_optimization_metrics

    # Incident response workflow
    - name: incident-response
      description: |
        Automated incident detection, analysis, and rollback workflow.
      steps:
        - agent: monitoring-agent
          action: detect_incident

        - agent: monitoring-agent
          action: analyze_root_cause

        - agent: rollback-coordinator
          action: trigger_automated_rollback

        - agent: monitoring-agent
          action: verify_recovery

        - agent: monitoring-agent
          action: create_postmortem_ticket

  # ==========================================================================
  # SECURITY: Mesh-Level Security Policies
  # ==========================================================================
  security:
    # Network policies
    networkPolicies:
      enabled: true
      defaultDeny: true  # Deny all traffic by default
      allowedConnections:
        - from: config-validator
          to: security-scanner
        - from: monitoring-agent
          to: rollback-coordinator
        - from: rollback-coordinator
          to: db-migrator
        - from: cost-analyzer
          to: performance-optimizer
        - from: compliance-auditor
          to: security-scanner

    # RBAC policies
    rbac:
      enabled: true
      serviceAccounts:
        autoCreate: true
        annotations:
          mesh.ossa.io/managed: "true"

    # Pod security standards
    podSecurity:
      enforce: restricted  # Restricted Pod Security Standard
      audit: restricted
      warn: restricted

# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
#
# Prerequisites:
#   - Istio service mesh installed (v1.20+)
#   - cert-manager for certificate management
#   - Prometheus & Jaeger for observability
#
# Deployment:
#   kubectl apply -f mesh-config.yaml
#
# Verification:
#   kubectl get agentmesh -n agent-mesh-system
#   istioctl proxy-status
#   kubectl get virtualservices -n agent-mesh-system
#
# ============================================================================
