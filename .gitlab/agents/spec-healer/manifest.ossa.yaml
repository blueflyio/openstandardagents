apiVersion: ossa/v0.3.3
kind: Agent
metadata:
  name: spec-healer
  version: 1.0.0
  description: |
    Specification validation and healing agent. Compares specifications
    against implementation, extracts behavior from tests, detects
    breaking changes, and generates updated specs to maintain consistency.
  labels:
    environment: production
    team: quality
    domain: quality
    capability: spec-validation
    wave: "3"
  annotations:
    documentation: https://openstandardagents.org/docs/agents/spec-healer
    support: ops@openstandardagents.org
    category: Quality
    ossa.io/migration: v0.3.2-to-v0.3.3
    ossa.io/migrated-date: 2026-01-07
spec:
  taxonomy:
    domain: development
    subdomain: specification-management
    capability: spec_healing
  role: |
    You are an expert specification validator specializing in API contracts,
    OpenAPI specifications, and behavior-driven development.

    Your responsibilities:
    1. Extract expected behavior from test files
    2. Compare specifications against actual implementation
    3. Generate updated specifications when drift detected
    4. Detect breaking changes in API contracts
    5. Validate OpenAPI specifications for completeness
    6. Create merge requests for specification updates
    7. Alert on specification violations

    When validating specifications:
    - Parse OpenAPI/Swagger specs
    - Extract assertions from test files
    - Compare expected vs actual behavior
    - Identify missing spec coverage
    - Detect backwards-incompatible changes

    Breaking change categories:
    - Removed endpoints
    - Changed request/response schemas
    - Modified authentication requirements
    - Renamed or removed fields
  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.1
    maxTokens: 8000
  tools:
    - type: mcp
      name: filesystem
      description: |
        Read specification files, test files, and implementation code.
      config:
        server: filesystem-mcp
        allowed_paths:
          - openapi/**
          - spec/**
          - tests/**
          - src/**
    - type: http
      name: openapi-validator
      description: |
        Validate OpenAPI specifications for schema correctness.
      endpoint: http://openapi-validator:8080/validate
      config:
        method: POST
        timeout: 60
    - type: http
      name: breaking-change-detector
      description: |
        Detect breaking changes between OpenAPI spec versions.
      endpoint: http://oasdiff:8080/diff
      config:
        method: POST
        timeout: 120
    - type: mcp
      name: gitlab-api
      description: |
        Access GitLab repositories and create merge requests.
      config:
        server: gitlab-mcp
        scope: repository
      auth:
        type: bearer
        tokenPath: /var/secrets/gitlab-token
    - type: a2a
      name: agent-mesh
      description: |
        Communicate with doc-agent and architecture-healer.
      endpoint: http://agent-mesh:9090/a2a
      config:
        protocol: json-rpc
        version: "2.0"
  capabilities:
    - name: extract_behavior_from_tests
      description: Extract expected behavior from test files
      input_schema:
        type: object
        properties:
          test_paths:
            type: array
            items:
              type: string
          test_framework:
            type: string
            enum:
              - jest
              - mocha
              - phpunit
              - pytest
              - go-test
        required:
          - test_paths
      output_schema:
        type: object
        properties:
          behaviors:
            type: array
            items:
              type: object
              properties:
                description:
                  type: string
                endpoint:
                  type: string
                method:
                  type: string
                expected_response:
                  type: object
          success:
            type: boolean
    - name: compare_spec_vs_implementation
      description: Compare spec against actual implementation
      input_schema:
        type: object
        properties:
          spec_path:
            type: string
          implementation_paths:
            type: array
            items:
              type: string
        required:
          - spec_path
          - implementation_paths
      output_schema:
        type: object
        properties:
          matches:
            type: boolean
          discrepancies:
            type: array
            items:
              type: object
              properties:
                type:
                  type: string
                  enum:
                    - missing_endpoint
                    - extra_endpoint
                    - schema_mismatch
                    - auth_mismatch
                spec_value:
                  type: string
                implementation_value:
                  type: string
          success:
            type: boolean
    - name: generate_updated_specs
      description: Generate updated specifications from implementation
      input_schema:
        type: object
        properties:
          implementation_paths:
            type: array
            items:
              type: string
          output_format:
            type: string
            enum:
              - openapi3
              - swagger2
              - asyncapi
            default: openapi3
        required:
          - implementation_paths
      output_schema:
        type: object
        properties:
          generated_spec:
            type: string
          format:
            type: string
          success:
            type: boolean
    - name: detect_breaking_changes
      description: Detect breaking changes between spec versions
      input_schema:
        type: object
        properties:
          old_spec_path:
            type: string
          new_spec_path:
            type: string
        required:
          - old_spec_path
          - new_spec_path
      output_schema:
        type: object
        properties:
          breaking_changes:
            type: array
            items:
              type: object
              properties:
                change_type:
                  type: string
                  enum:
                    - removed_endpoint
                    - removed_field
                    - type_changed
                    - required_added
                path:
                  type: string
                description:
                  type: string
                severity:
                  type: string
                  enum:
                    - low
                    - medium
                    - high
                    - critical
          has_breaking_changes:
            type: boolean
          success:
            type: boolean
    - name: validate_openapi_specs
      description: Validate OpenAPI specifications for completeness
      input_schema:
        type: object
        properties:
          spec_path:
            type: string
          validation_rules:
            type: array
            items:
              type: string
            default:
              - schema_valid
              - examples_valid
              - security_defined
              - responses_complete
        required:
          - spec_path
      output_schema:
        type: object
        properties:
          valid:
            type: boolean
          errors:
            type: array
            items:
              type: object
              properties:
                rule:
                  type: string
                path:
                  type: string
                message:
                  type: string
          warnings:
            type: array
            items:
              type: object
              properties:
                rule:
                  type: string
                path:
                  type: string
                message:
                  type: string
          success:
            type: boolean
  triggers:
    - type: webhook
      name: on_test_changes
      event: push
      filter:
        paths:
          - tests/**
          - spec/**
      description: Validate specs when tests change
    - type: webhook
      name: on_api_changes
      event: push
      filter:
        paths:
          - src/api/**
          - openapi/**
      description: Check for breaking changes
    - type: schedule
      name: weekly_audit
      schedule: 0 6 * * 3
      description: Weekly specification audit
    - type: workflow
      name: on_status_validation
      status: Validation
      description: Validate specs on status change
  outputs:
    - name: updated_specs
      type: file
      format: yaml
      path: openapi/
    - name: drift_report
      type: file
      format: json
      path: reports/spec-drift/
    - name: breaking_change_alert
      type: notification
      channels:
        - slack
        - gitlab-issue
  autonomy:
    level: supervised
    approval_required: true
    allowed_actions:
      - extract_behavior_from_tests
      - compare_spec_vs_implementation
      - generate_updated_specs
      - detect_breaking_changes
      - validate_openapi_specs
      - create_merge_requests
    blocked_actions:
      - delete_specs
      - force_push
  constraints:
    cost:
      maxTokensPerDay: 250000
      maxTokensPerRequest: 8000
      maxCostPerDay: 25
      currency: USD
    performance:
      maxLatencySeconds: 90
      maxConcurrentRequests: 5
      timeoutSeconds: 300
    resources:
      cpu: 1500m
      memory: 3Gi
      ephemeralStorage: 5Gi
  observability:
    tracing:
      enabled: true
      exporter: otlp
      endpoint: http://jaeger-collector:4318
      samplingRate: 0.5
    metrics:
      enabled: true
      exporter: prometheus
      endpoint: http://prometheus:9090/metrics
      customMetrics:
        - name: spec_validations
          type: counter
          description: Total specification validations
        - name: breaking_changes_detected
          type: counter
          description: Breaking changes detected
        - name: spec_drift_count
          type: gauge
          description: Current specification drift count
    logging:
      level: info
      format: json
  state:
    backend: redis
    config:
      host: redis-cluster.default.svc.cluster.local
      port: 6379
      database: 5
      ttl: 86400
      keyPrefix: "spec-healer:"
