image: node:22-alpine
injectGatewayToken: true

commands:
  - echo "Starting OSSA validation flow"

steps:
  - id: validate_ossa
    agent: bot-ossa-validator
    with:
      project_id: "{{ event.project_id }}"
      merge_request_id: "{{ event.merge_request_id }}"
      changed_files: "{{ event.changed_files }}"

  - id: post_result
    tool: CreateMergeRequestNote
    with:
      project_id: "{{ event.project_id }}"
      merge_request_id: "{{ event.merge_request_id }}"
      body: |
        ### ğŸ” OSSA Validation Results

        **Status:** {{ steps.validate_ossa.output.status | default('completed') }}

        {% if steps.validate_ossa.output.validated_files %}
        **Files Validated:**
        {{ steps.validate_ossa.output.validated_files | join('\n- ') }}
        {% endif %}

        {% if steps.validate_ossa.output.errors %}
        **Errors:**
        ```
        {{ steps.validate_ossa.output.errors }}
        ```
        {% endif %}

        {% if steps.validate_ossa.output.status == 'passed' %}
        âœ… All OSSA manifests are valid
        {% elif steps.validate_ossa.output.status == 'failed' %}
        âŒ Validation failed. Please fix the errors above.
        {% endif %}
