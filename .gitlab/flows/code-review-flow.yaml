image: node:22-alpine
injectGatewayToken: true

commands:
  - echo "üîç Starting Code Review Flow"

steps:
  - id: review_code
    agent: mr-reviewer
    with:
      project_id: "{{ event.project.id }}"
      merge_request_id: "{{ event.merge_request.id }}"
      review_focus: ["security", "performance", "best_practices"]

  - id: analyze_security
    agent: security-scanner
    with:
      merge_request_id: "{{ event.merge_request.id }}"
      scan_type: code_review
    needs:
      - review_code

  - id: check_compliance
    agent: compliance-auditor
    with:
      code_changes: "{{ review_code.output.changes }}"
      frameworks: ["soc2", "gdpr"]
    needs:
      - analyze_security

  - id: post_review
    tool: CreateMergeRequestNote
    with:
      project_id: "{{ event.project.id }}"
      merge_request_id: "{{ event.merge_request.id }}"
      body: |
        ## üîç Code Review Results

        **Review Status:** {{ review_code.output.status }}
        **Security Scan:** {{ analyze_security.output.status }}
        **Compliance:** {{ check_compliance.output.status }}

        ### Findings:
        {{ review_code.output.findings | join('\n- ') }}

        ### Security Issues:
        {% if analyze_security.output.vulnerabilities %}
        {{ analyze_security.output.vulnerabilities | join('\n- ') }}
        {% else %}
        ‚úÖ No security issues found
        {% endif %}

        Generated by OSSA v0.3.0 autonomous agents.
    needs:
      - check_compliance
