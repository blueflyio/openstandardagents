# ============================================================================
# GitLab Duo Flow: Enhanced Agent Orchestration
# ============================================================================
# Advanced agent orchestration with:
# - Agent-to-agent communication (A2A)
# - Performance analytics and metrics
# - Intelligent routing based on capabilities and performance
# ============================================================================

image: node:22-alpine
injectGatewayToken: true

variables:
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}
  AGENT_MESH_API: ${AGENT_MESH_API_URL:-http://agent-mesh:9090}
  AGENT_ROUTER_API: ${AGENT_ROUTER_API_URL:-http://agent-router:4000}
  AGENT_TRACER_API: ${AGENT_TRACER_API_URL:-http://agent-tracer:4318}
  SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}

commands:
  - echo "Starting Enhanced Agent Orchestration Flow"
  - apk add --no-cache curl jq

steps:
  # ============================================================================
  # PHASE 1: AGENT DISCOVERY & CAPABILITY MAPPING
  # ============================================================================
  - id: discover_agents
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: "@task-dispatcher"
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: discover-and-map-agents
      inputs:
        project_id: ${CI_PROJECT_ID}
        include_capabilities: true
        include_performance: true
        include_availability: true
    when: on_schedule
    schedule:
      cron: "0 */2 * * *"  # Every 2 hours

  # ============================================================================
  # PHASE 2: PERFORMANCE ANALYTICS COLLECTION
  # ============================================================================
  - id: collect_performance_metrics
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: "@task-dispatcher"
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: collect-agent-metrics
      inputs:
        metrics_source: agent-tracer
        time_range: "24h"
        include_latency: true
        include_token_usage: true
        include_error_rates: true
        include_success_rates: true
    when: on_schedule
    schedule:
      cron: "*/15 * * * *"  # Every 15 minutes

  - id: analyze_performance_trends
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: "@task-dispatcher"
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: analyze-performance-trends
      inputs:
        project_id: ${CI_PROJECT_ID}
        trend_window: "7d"
        alert_threshold: 0.8
        optimize_routing: true
    when: on_schedule
    schedule:
      cron: "0 1 * * *"  # Daily at 1 AM

  # ============================================================================
  # PHASE 3: INTELLIGENT ROUTING CONFIGURATION
  # ============================================================================
  - id: update_routing_rules
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: "@task-dispatcher"
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: update-intelligent-routing
      inputs:
        router_api: ${AGENT_ROUTER_API}
        routing_strategy: "capability_and_performance_weighted"
        load_balancing: "performance_aware"
        health_check_interval: 60
        max_retries: 3
        session_affinity: "capability_based"
    when: on_schedule
    schedule:
      cron: "0 */6 * * *"  # Every 6 hours

  # ============================================================================
  # PHASE 4: AGENT-TO-AGENT COMMUNICATION SETUP
  # ============================================================================
  - id: setup_a2a_channels
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: "@task-dispatcher"
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: setup-agent-mesh
      inputs:
        mesh_api: ${AGENT_MESH_API}
        channels:
          - name: "issue-coordination"
            type: "pubsub"
            agents: ["issue-lifecycle-manager", "task-dispatcher"]
          - name: "code-quality-coordination"
            type: "pubsub"
            agents: ["code-quality-reviewer", "mr-reviewer"]
          - name: "release-coordination"
            type: "direct"
            agents: ["release-coordinator", "task-dispatcher"]
          - name: "performance-alerts"
            type: "broadcast"
            agents: ["task-dispatcher", "pipeline-remediation"]
    when: on_schedule
    schedule:
      cron: "0 0 * * *"  # Daily at midnight

  # ============================================================================
  # PHASE 5: COORDINATED TASK EXECUTION (A2A)
  # ============================================================================
  - id: coordinate_issue_triage
    tool: InvokePlatformAgent
    with:
      agent: issue-lifecycle-manager
      service_account: "@issue-lifecycle-manager"
      token: ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN}
      task: coordinate-with-agents
      inputs:
        mesh_api: ${AGENT_MESH_API}
        coordination_type: "issue-triage"
        participating_agents:
          - agent: "code-quality-reviewer"
            role: "analyze-code-impact"
          - agent: "mr-reviewer"
            role: "check-related-mrs"
          - agent: "task-dispatcher"
            role: "orchestrate-workflow"
        communication_channel: "issue-coordination"
    when: on_schedule
    schedule:
      cron: "0 */4 * * *"  # Every 4 hours

  - id: coordinate_code_review
    tool: InvokePlatformAgent
    with:
      agent: code-quality-reviewer
      service_account: "@code-quality-reviewer"
      token: ${SERVICE_ACCOUNT_CODE_QUALITY_TOKEN}
      task: coordinate-with-agents
      inputs:
        mesh_api: ${AGENT_MESH_API}
        coordination_type: "code-review"
        participating_agents:
          - agent: "mr-reviewer"
            role: "review-mr-context"
          - agent: "vulnerability-scanner"
            role: "security-analysis"
          - agent: "pipeline-remediation"
            role: "check-pipeline-impact"
        communication_channel: "code-quality-coordination"
    when: on_merge_request
    filters:
      - target_branch: "release/v0.3.x"

  # ============================================================================
  # PHASE 6: PERFORMANCE-BASED ROUTING
  # ============================================================================
  - id: route_by_performance
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: "@task-dispatcher"
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: intelligent-route-task
      inputs:
        router_api: ${AGENT_ROUTER_API}
        task_type: "code-review"
        routing_criteria:
          - weight: 0.4
            factor: "performance_score"
          - weight: 0.3
            factor: "success_rate"
          - weight: 0.2
            factor: "latency"
          - weight: 0.1
            factor: "availability"
        fallback_strategy: "round_robin"
    when: on_merge_request

  # ============================================================================
  # PHASE 7: ANALYTICS DASHBOARD UPDATE
  # ============================================================================
  - id: update_analytics_dashboard
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: "@task-dispatcher"
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: update-analytics
      inputs:
        tracer_api: ${AGENT_TRACER_API}
        metrics_to_collect:
          - agent_invocations
          - agent_latency
          - agent_success_rate
          - agent_token_usage
          - agent_cost
          - agent_to_agent_messages
          - routing_decisions
          - performance_trends
        dashboard_type: "gitlab_wiki"
    when: on_schedule
    schedule:
      cron: "0 */1 * * *"  # Every hour
