# ============================================================================
# GitLab Duo Flow: Pipeline Optimization
# ============================================================================
# Autonomous pipeline analysis and optimization flow
# Triggered on pipeline failures or performance degradation
# ============================================================================

image: node:22-alpine
injectGatewayToken: true

commands:
  - echo "ðŸ”§ Starting Pipeline Optimization Flow"

steps:
  - id: analyze_pipeline
    agent: ci-cd
    with:
      project_id: "{{ event.project.id }}"
      pipeline_id: "{{ event.pipeline.id }}"
      analysis_type: performance

  - id: identify_optimizations
    agent: performance-optimizer
    with:
      analysis_results: "{{ steps.analyze_pipeline.output }}"
      focus_areas: ["caching", "parallelization", "resource_usage"]
    needs:
      - analyze_pipeline

  - id: analyze_costs
    agent: cost-analyzer
    with:
      pipeline_id: "{{ event.pipeline.id }}"
      optimization_suggestions: "{{ steps.identify_optimizations.output }}"
    needs:
      - identify_optimizations

  - id: generate_recommendations
    agent: ci-cd
    with:
      action: generate_recommendations
      performance_analysis: "{{ steps.identify_optimizations.output }}"
      cost_analysis: "{{ steps.analyze_costs.output }}"
    needs:
      - analyze_costs

  - id: post_recommendations
    tool: CreateMergeRequestNote
    with:
      project_id: "{{ event.project.id }}"
      merge_request_id: "{{ event.merge_request.id }}"
      body: |
        ## ðŸ”§ Pipeline Optimization Recommendations

        **Current Duration:** {{ steps.analyze_pipeline.output.current_duration }}s
        **Potential Improvement:** {{ steps.generate_recommendations.output.improvement_percent }}%

        ### Recommendations:
        {{ steps.generate_recommendations.output.recommendations | join('\n') }}

        **Estimated Cost Savings:** ${{ steps.analyze_costs.output.savings_per_month }}/month

        Generated by OSSA v0.3.0 autonomous agents.
    needs:
      - generate_recommendations
