# ============================================================================
# GitLab Duo Flow: Security Remediation
# ============================================================================
# Autonomous security vulnerability detection and remediation
# Triggered by security scan failures or vulnerability reports
# ============================================================================

image: node:22-alpine
injectGatewayToken: true

commands:
  - echo "ðŸ”’ Starting Security Remediation Flow"

steps:
  - id: scan_vulnerabilities
    agent: security-scanner
    with:
      project_id: "{{ event.project.id }}"
      scan_type: comprehensive
      include_dependencies: true

  - id: audit_compliance
    agent: compliance-auditor
    with:
      vulnerabilities: "{{ steps.scan_vulnerabilities.output.vulnerabilities }}"
      frameworks: ["soc2", "hipaa", "gdpr"]
    needs:
      - scan_vulnerabilities

  - id: validate_remediation
    agent: config-validator
    with:
      security_patches: "{{ steps.scan_vulnerabilities.output.recommended_patches }}"
      validate_policies: true
    needs:
      - audit_compliance

  - id: create_remediation_mr
    agent: mr-manager
    with:
      action: create_security_remediation
      vulnerabilities: "{{ steps.scan_vulnerabilities.output.vulnerabilities }}"
      patches: "{{ steps.validate_remediation.output.approved_patches }}"
    needs:
      - validate_remediation

  - id: notify_security_team
    tool: CreateIssue
    with:
      project_id: "{{ event.project.id }}"
      title: "Security Remediation Required: {{ steps.scan_vulnerabilities.output.severity }}"
      description: |
        ## Security Scan Results

        **Severity:** {{ steps.scan_vulnerabilities.output.severity }}
        **Vulnerabilities Found:** {{ steps.scan_vulnerabilities.output.count }}

        **Remediation MR:** {{ steps.create_remediation_mr.output.mr_url }}

        **Compliance Status:** {{ steps.audit_compliance.output.compliance_status }}

        Generated by OSSA v0.3.0 security agents.
      labels: ["security", "compliance", "automated"]
    needs:
      - create_remediation_mr

