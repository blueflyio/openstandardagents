# ============================================================================
# GitLab Duo Flow: Autonomous Framework Orchestration
# ============================================================================
# The first living and breathing framework maintained by OSSA-certified agents
# Uses existing service accounts and platform-agents - NO new agents created
# ============================================================================

image: node:22-alpine
injectGatewayToken: true

variables:
  PLATFORM_AGENTS_API: ${PLATFORM_AGENTS_API_URL:-https://api.blueflyagents.com}
  SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN: ${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN}
  SERVICE_ACCOUNT_MR_REVIEWER_TOKEN: ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}
  SERVICE_ACCOUNT_CODE_QUALITY_TOKEN: ${SERVICE_ACCOUNT_CODE_QUALITY_TOKEN}
  SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN: ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN}
  SERVICE_ACCOUNT_DOCUMENTATION_TOKEN: ${SERVICE_ACCOUNT_DOCUMENTATION_TOKEN}
  SERVICE_ACCOUNT_PIPELINE_REMEDIATION_TOKEN: ${SERVICE_ACCOUNT_PIPELINE_REMEDIATION_TOKEN}

commands:
  - echo "Starting Autonomous Framework Orchestration Flow"
  - apk add --no-cache curl jq

steps:
  # ============================================================================
  # PHASE 1: ISSUE INTELLIGENCE & TRIAGE
  # ============================================================================
  - id: scan_issues
    tool: InvokePlatformAgent
    with:
      agent: issue-lifecycle-manager
      service_account: @issue-lifecycle-manager
      token: ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN}
      task: scan-and-triage
      inputs:
        project_id: ${CI_PROJECT_ID}
        auto_assign: true
        auto_label: true
        create_subtasks: true
    when: on_schedule
    schedule:
      cron: "0 */4 * * *"  # Every 4 hours

  - id: prioritize_issues
    tool: InvokePlatformAgent
    with:
      agent: issue-lifecycle-manager
      service_account: @issue-lifecycle-manager
      token: ${SERVICE_ACCOUNT_ISSUE_LIFECYCLE_TOKEN}
      task: prioritize
      inputs:
        project_id: ${CI_PROJECT_ID}
        criteria:
          - impact
          - urgency
          - dependencies
          - milestone_alignment
    needs:
      - scan_issues

  # ============================================================================
  # PHASE 2: AUTONOMOUS CODE IMPROVEMENT
  # ============================================================================
  - id: code_quality_scan
    tool: InvokePlatformAgent
    with:
      agent: code-quality-reviewer
      service_account: @code-quality-reviewer
      token: ${SERVICE_ACCOUNT_CODE_QUALITY_TOKEN}
      task: comprehensive-review
      inputs:
        project_id: ${CI_PROJECT_ID}
        scope: entire_codebase
        auto_fix: true
        create_issues: true
    when: on_schedule
    schedule:
      cron: "0 2 * * *"  # Daily at 2 AM

  - id: security_audit
    tool: InvokePlatformAgent
    with:
      agent: vulnerability-scanner
      service_account: @vuln-scanner
      token: ${SERVICE_ACCOUNT_VULN_SCANNER_TOKEN}
      task: full-scan
      inputs:
        project_id: ${CI_PROJECT_ID}
        severity_threshold: high
        auto_remediate: true
    needs:
      - code_quality_scan

  # ============================================================================
  # PHASE 3: AUTONOMOUS VERSION MANAGEMENT
  # ============================================================================
  - id: detect_version_opportunities
    tool: InvokePlatformAgent
    with:
      agent: release-coordinator
      service_account: @release-coordinator
      token: ${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN}
      task: detect-version-opportunities
      inputs:
        project_id: ${CI_PROJECT_ID}
        check_milestones: true
        check_commits: true
        auto_bump: false  # Create MR, don't auto-bump
    when: on_schedule
    schedule:
      cron: "0 3 * * *"  # Daily at 3 AM

  - id: create_version_mr
    tool: InvokePlatformAgent
    with:
      agent: release-coordinator
      service_account: @release-coordinator
      token: ${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN}
      task: create-version-mr
      inputs:
        bump_type: ${VERSION_BUMP_TYPE}
        target_branch: release/v0.3.x
        auto_assign: true
    condition: ${detect_version_opportunities.output.should_bump} == true
    needs:
      - detect_version_opportunities

  # ============================================================================
  # PHASE 4: AUTONOMOUS DOCUMENTATION
  # ============================================================================
  - id: sync_documentation
    tool: InvokePlatformAgent
    with:
      agent: documentation-aggregator
      service_account: @documentation-aggregator
      token: ${SERVICE_ACCOUNT_DOCUMENTATION_TOKEN}
      task: sync-all-docs
      inputs:
        project_id: ${CI_PROJECT_ID}
        source: repository
        target: gitlab_wiki
        auto_update: true
    when: on_schedule
    schedule:
      cron: "0 4 * * *"  # Daily at 4 AM

  - id: validate_documentation
    tool: InvokePlatformAgent
    with:
      agent: documentation-aggregator
      service_account: @documentation-aggregator
      token: ${SERVICE_ACCOUNT_DOCUMENTATION_TOKEN}
      task: validate-completeness
      inputs:
        project_id: ${CI_PROJECT_ID}
        check_links: true
        check_examples: true
        create_issues: true
    needs:
      - sync_documentation

  # ============================================================================
  # PHASE 5: AUTONOMOUS MR MANAGEMENT
  # ============================================================================
  - id: review_open_mrs
    tool: InvokePlatformAgent
    with:
      agent: mr-reviewer
      service_account: @mr-reviewer
      token: ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}
      task: review-all-open
      inputs:
        project_id: ${CI_PROJECT_ID}
        auto_approve_safe: true
        auto_merge_passing: false  # Require human approval for merge
        create_fix_mrs: true
    when: on_schedule
    schedule:
      cron: "*/30 * * * *"  # Every 30 minutes

  - id: auto_rebase_mrs
    tool: InvokePlatformAgent
    with:
      agent: mr-reviewer
      service_account: @mr-reviewer
      token: ${SERVICE_ACCOUNT_MR_REVIEWER_TOKEN}
      task: auto-rebase
      inputs:
        project_id: ${CI_PROJECT_ID}
        target_branch: release/v0.3.x
        auto_resolve_conflicts: false
    needs:
      - review_open_mrs

  # ============================================================================
  # PHASE 6: PIPELINE SELF-HEALING
  # ============================================================================
  - id: monitor_pipelines
    tool: InvokePlatformAgent
    with:
      agent: pipeline-remediation
      service_account: @pipeline-remediation
      token: ${SERVICE_ACCOUNT_PIPELINE_REMEDIATION_TOKEN}
      task: monitor-failures
      inputs:
        project_id: ${CI_PROJECT_ID}
        lookback_hours: 24
        auto_fix: true
        create_issues: true
    when: on_schedule
    schedule:
      cron: "*/15 * * * *"  # Every 15 minutes

  - id: fix_pipeline_issues
    tool: InvokePlatformAgent
    with:
      agent: pipeline-remediation
      service_account: @pipeline-remediation
      token: ${SERVICE_ACCOUNT_PIPELINE_REMEDIATION_TOKEN}
      task: auto-fix
      inputs:
        pipeline_id: ${CI_PIPELINE_ID}
        create_mr: true
    condition: ${monitor_pipelines.output.has_failures} == true
    needs:
      - monitor_pipelines

  # ============================================================================
  # PHASE 7: AUTONOMOUS RELEASE ORCHESTRATION
  # ============================================================================
  - id: check_milestone_readiness
    tool: InvokePlatformAgent
    with:
      agent: release-coordinator
      service_account: @release-coordinator
      token: ${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN}
      task: check-milestone-readiness
      inputs:
        project_id: ${CI_PROJECT_ID}
        milestone_id: ${CI_MILESTONE_ID}
        auto_create_rc: true
    when: on_webhook
    webhook:
      event: milestone
      action: updated

  - id: create_release
    tool: InvokePlatformAgent
    with:
      agent: release-coordinator
      service_account: @release-coordinator
      token: ${SERVICE_ACCOUNT_RELEASE_COORDINATOR_TOKEN}
      task: create-release
      inputs:
        milestone_id: ${CI_MILESTONE_ID}
        version: ${VERSION}
        publish_npm: true
        create_gitlab_release: true
    condition: ${check_milestone_readiness.output.is_ready} == true
    needs:
      - check_milestone_readiness

  # ============================================================================
  # PHASE 8: CONTINUOUS IMPROVEMENT
  # ============================================================================
  - id: analyze_ecosystem
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: @task-dispatcher
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: ecosystem-analysis
      inputs:
        project_id: ${CI_PROJECT_ID}
        create_improvement_issues: true
    when: on_schedule
    schedule:
      cron: "0 1 * * 1"  # Weekly on Monday at 1 AM

  - id: generate_improvements
    tool: InvokePlatformAgent
    with:
      agent: task-dispatcher
      service_account: @task-dispatcher
      token: ${SERVICE_ACCOUNT_TASK_DISPATCHER_TOKEN}
      task: generate-improvement-plan
      inputs:
        project_id: ${CI_PROJECT_ID}
        max_issues: 10
        prioritize: true
    needs:
      - analyze_ecosystem
