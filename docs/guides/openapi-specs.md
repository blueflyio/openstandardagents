# OpenAPI Specifications Guide

Complete guide to OpenAPI 3.1 specifications generated by OSSA exports.

## Overview

Every OSSA export includes a complete OpenAPI 3.1 specification that documents all API endpoints, request/response schemas, authentication, and error handling.

### Benefits

- **Auto-Generated Documentation**: Interactive API docs via Swagger UI
- **Client SDKGeneration**: Generate clients in any language
- **Validation**: Automatic request/response validation
- **Type Safety**: TypeScript types from schemas
- **Standards Compliance**: Industry-standard API documentation

## Accessing OpenAPI Specs

All exports expose OpenAPI specs at standard endpoints:

```bash
# Get OpenAPI specification
curl http://localhost:3000/openapi

# Get as JSON (default is YAML)
curl http://localhost:3000/openapi?format=json

# Get specific version
curl http://localhost:3000/openapi/v1
```

## Specification Structure

### Basic Structure

```yaml
openapi: 3.1.0
info:
  title: My Agent API
  version: 1.0.0
  description: AI-powered agent generated from OSSA manifest
  contact:
    name: Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Local development
  - url: https://api.example.com
    description: Production

paths:
  /api/v1/execute:
    post:
      summary: Execute agent
      # ... endpoint details

components:
  schemas:
    # ... schema definitions
  securitySchemes:
    # ... authentication methods
```

### Info Section

Metadata about your API:

```yaml
info:
  title: Code Review Agent API
  version: 1.2.0
  description: |
    AI-powered code review agent with security analysis.

    ## Features
    - Code review
    - Security scanning
    - Style checking

    ## Authentication
    Requires API key in `X-API-Key` header.

  contact:
    name: API Support
    email: api@example.com
    url: https://example.com/support

  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

  termsOfService: https://example.com/terms
```

### Servers Section

API server URLs:

```yaml
servers:
  - url: http://localhost:3000
    description: Local development server

  - url: https://api-staging.example.com
    description: Staging environment

  - url: https://api.example.com
    description: Production environment
    variables:
      version:
        default: v1
        enum: [v1, v2]

  - url: https://{region}.api.example.com
    description: Regional endpoints
    variables:
      region:
        default: us-east
        enum: [us-east, us-west, eu-central]
```

## Paths (Endpoints)

### Execute Endpoint

```yaml
paths:
  /api/v1/execute:
    post:
      summary: Execute agent with input
      description: |
        Sends input to the agent and returns the response.
        The agent will use available tools as needed.

      operationId: executeAgent
      tags:
        - Agent Execution

      security:
        - ApiKeyAuth: []

      requestBody:
        required: true
        description: Execution request
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteRequest'
            examples:
              simple:
                summary: Simple text input
                value:
                  input: "What is the capital of France?"
              withContext:
                summary: Input with context
                value:
                  input: "Analyze this code"
                  context:
                    language: python
                    file: app.py

      responses:
        '200':
          description: Successful execution
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
              examples:
                success:
                  value:
                    success: true
                    output: "The capital of France is Paris."
                    metadata:
                      executionTime: 1234
                      tokensUsed: 150

        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
```

### Streaming Endpoint

```yaml
paths:
  /api/v1/chat/stream:
    post:
      summary: Stream agent response
      description: Stream agent response in real-time using Server-Sent Events

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'

      responses:
        '200':
          description: Streaming response
          content:
            text/event-stream:
              schema:
                type: string
                format: event-stream
              examples:
                stream:
                  value: |
                    data: {"type":"content","delta":"Hello"}
                    data: {"type":"content","delta":" world"}
                    data: {"type":"done"}
```

## Components

### Schemas

Define reusable schemas:

```yaml
components:
  schemas:
    ExecuteRequest:
      type: object
      required:
        - input
      properties:
        input:
          type: string
          description: User input text
          minLength: 1
          maxLength: 10000
          example: "Analyze this code"

        context:
          type: object
          description: Execution context
          additionalProperties: true
          example:
            language: python
            file: app.py

        options:
          type: object
          description: Execution options
          properties:
            temperature:
              type: number
              description: LLM temperature
              minimum: 0
              maximum: 1
              default: 0.7
            maxTokens:
              type: integer
              description: Maximum tokens
              minimum: 1
              maximum: 4096
              default: 1024

    ExecuteResponse:
      type: object
      required:
        - success
        - output
      properties:
        success:
          type: boolean
          description: Whether execution succeeded

        output:
          type: string
          description: Agent output

        metadata:
          type: object
          required:
            - executionTime
            - tokensUsed
          properties:
            executionTime:
              type: integer
              description: Execution time in milliseconds
            tokensUsed:
              type: integer
              description: Total tokens consumed
            cost:
              type: number
              description: Cost in USD

        toolCalls:
          type: array
          description: Tools called during execution
          items:
            $ref: '#/components/schemas/ToolCall'

    ToolCall:
      type: object
      required:
        - name
        - input
        - result
      properties:
        name:
          type: string
          description: Tool name
        input:
          type: object
          description: Tool input parameters
        result:
          type: string
          description: Tool execution result

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Error code
              enum:
                - INVALID_INPUT
                - UNAUTHORIZED
                - RATE_LIMIT_EXCEEDED
                - INTERNAL_ERROR
            message:
              type: string
              description: Human-readable error message
            details:
              type: string
              description: Additional error details
```

### Security Schemes

Define authentication methods:

```yaml
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication

    OAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://example.com/oauth/authorize
          tokenUrl: https://example.com/oauth/token
          scopes:
            execute: Execute agent
            admin: Administrative access
```

### Apply Security

```yaml
# Global security (applies to all endpoints)
security:
  - ApiKeyAuth: []

# Or per-endpoint
paths:
  /api/v1/execute:
    post:
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
```

## Code Generation

### Generate TypeScript Client

```bash
# Install openapi-generator
npm install -g @openapitools/openapi-generator-cli

# Generate TypeScript client
openapi-generator-cli generate \
  -i http://localhost:3000/openapi \
  -g typescript-fetch \
  -o ./generated-client

# Use generated client
import { DefaultApi } from './generated-client';

const api = new DefaultApi({
  basePath: 'http://localhost:3000',
  headers: {
    'X-API-Key': 'your-key'
  }
});

const response = await api.executeAgent({
  input: 'test'
});
```

### Generate Python Client

```bash
openapi-generator-cli generate \
  -i http://localhost:3000/openapi \
  -g python \
  -o ./python-client

# Use generated client
from openapi_client import ApiClient, Configuration, DefaultApi

config = Configuration(
    host="http://localhost:3000",
    api_key={'X-API-Key': 'your-key'}
)

with ApiClient(config) as client:
    api = DefaultApi(client)
    response = api.execute_agent(input="test")
```

### Generate Go Client

```bash
openapi-generator-cli generate \
  -i http://localhost:3000/openapi \
  -g go \
  -o ./go-client

# Use generated client
import (
    "context"
    openapi "github.com/yourorg/go-client"
)

cfg := openapi.NewConfiguration()
cfg.AddDefaultHeader("X-API-Key", "your-key")
client := openapi.NewAPIClient(cfg)

resp, _, err := client.DefaultApi.ExecuteAgent(
    context.Background(),
).Input("test").Execute()
```

## Interactive Documentation

### Swagger UI

Serve interactive API documentation:

```typescript
import swaggerUi from 'swagger-ui-express';
import YAML from 'yamljs';

const swaggerDocument = YAML.load('./openapi.yaml');

app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerDocument));
```

Access at: `http://localhost:3000/api-docs`

### ReDoc

Alternative documentation UI:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>API Documentation</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:300,400,700" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <redoc spec-url='/openapi'></redoc>
    <script src="https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js"></script>
  </body>
</html>
```

## Validation

### Request Validation

Use OpenAPI spec for request validation:

```typescript
import { OpenApiValidator } from 'express-openapi-validator';

app.use(
  OpenApiValidator.middleware({
    apiSpec: './openapi.yaml',
    validateRequests: true,
    validateResponses: true,
  })
);

// Invalid requests are automatically rejected
// POST /api/v1/execute with invalid body
// -> 400 Bad Request with validation errors
```

### Response Validation

Validate responses match spec:

```typescript
app.post('/api/v1/execute', async (req, res) => {
  const result = await agent.execute(req.body);

  // Response is validated against schema
  res.json(result);
  // If response doesn't match schema -> 500 Internal Server Error
});
```

## Versioning

### API Versioning

```yaml
# Version in path
paths:
  /api/v1/execute:
    # v1 implementation

  /api/v2/execute:
    # v2 implementation

# Or version in header
paths:
  /api/execute:
    post:
      parameters:
        - name: API-Version
          in: header
          required: true
          schema:
            type: string
            enum: [v1, v2]
```

### Spec Versioning

```yaml
info:
  version: 2.1.0  # Spec version

  x-api-version:
    major: 2
    minor: 1
    patch: 0

  x-changelog:
    - version: 2.1.0
      date: 2026-02-02
      changes:
        - Added streaming endpoint
        - Improved error responses
    - version: 2.0.0
      date: 2026-01-15
      changes:
        - Breaking: Changed response format
        - Added tool support
```

## Extensions

### Custom Extensions

Add custom metadata with `x-` prefix:

```yaml
paths:
  /api/v1/execute:
    post:
      x-rate-limit:
        requests: 100
        window: 60

      x-cache:
        enabled: true
        ttl: 300

      x-cost:
        estimated: 0.002
        unit: USD

components:
  schemas:
    ExecuteRequest:
      x-examples:
        - name: simple
          value:
            input: "test"
        - name: complex
          value:
            input: "analyze"
            context:
              file: app.py
```

### OSSA Extensions

OSSA-specific extensions:

```yaml
info:
  x-ossa:
    version: v0.4.0
    manifest: ./agent.ossa.yaml
    platform: anthropic

paths:
  /api/v1/execute:
    post:
      x-ossa-tools:
        - analyze_code
        - check_security

      x-ossa-capabilities:
        - code-review
        - security-analysis
```

## Best Practices

### 1. Use Descriptive Names

```yaml
# Good
components:
  schemas:
    AgentExecutionRequest:
      type: object

# Bad
components:
  schemas:
    Request:
      type: object
```

### 2. Include Examples

```yaml
components:
  schemas:
    ExecuteRequest:
      type: object
      properties:
        input:
          type: string
          example: "Analyze this code"  # Always include examples
```

### 3. Document Errors

```yaml
responses:
  '400':
    description: Invalid request
    content:
      application/json:
        schema:
          $ref: '#/components/schemas/Error'
        examples:
          invalid_input:
            summary: Missing required field
            value:
              error:
                code: INVALID_INPUT
                message: "Field 'input' is required"
```

### 4. Use References

```yaml
# Good - DRY
components:
  schemas:
    ExecuteResponse:
      properties:
        metadata:
          $ref: '#/components/schemas/Metadata'

# Bad - Duplication
components:
  schemas:
    ExecuteResponse:
      properties:
        metadata:
          type: object
          properties:
            # ... repeated definition
```

### 5. Validate Spec

```bash
# Install validator
npm install -g @apidevtools/swagger-cli

# Validate spec
swagger-cli validate openapi.yaml

# Bundle spec (resolve all $refs)
swagger-cli bundle openapi.yaml -o openapi-bundled.yaml
```

## Testing

### Test Against Spec

```typescript
import { OpenAPIBackend } from 'openapi-backend';

const api = new OpenAPIBackend({
  definition: './openapi.yaml',
});

// Test endpoint exists
test('execute endpoint exists', () => {
  const operation = api.matchOperation({
    method: 'POST',
    path: '/api/v1/execute',
  });
  expect(operation).toBeDefined();
});

// Test request validation
test('validates requests', async () => {
  const result = api.validateRequest(
    {
      method: 'POST',
      path: '/api/v1/execute',
      body: { input: 'test' },
    },
    {
      method: 'POST',
      path: '/api/v1/execute',
    }
  );
  expect(result.valid).toBe(true);
});
```

## Next Steps

- [API Endpoints Guide](./api-endpoints.md) - Complete endpoint reference
- [Best Practices](./best-practices.md) - General best practices
- [Client Generation](./client-generation.md) - Generate API clients
