# API Endpoints Guide

Complete guide to API endpoints generated by OSSA exports.

## Overview

All OSSA platform exports can generate production-ready API endpoints with:

- **RESTful APIs**: Standard HTTP methods and status codes
- **OpenAPI 3.1**: Complete specifications for all endpoints
- **Authentication**: API key and JWT support
- **Validation**: Automatic request/response validation
- **Error Handling**: Consistent error responses
- **Rate Limiting**: Built-in rate limiting
- **CORS**: Cross-origin resource sharing support

## Enable API Generation

```bash
# Any platform export can include API endpoints
ossa export agent.ossa.yaml --platform npm --with-api
ossa export agent.ossa.yaml --platform langchain --with-api
ossa export agent.ossa.yaml --platform anthropic --with-api
```

## Standard Endpoints

All exports include these standard endpoints:

### Health Check

**GET** `/health`

Check API health and availability.

```bash
curl http://localhost:3000/health
```

**Response:**

```json
{
  "status": "healthy",
  "uptime": 12345,
  "timestamp": "2026-02-02T10:00:00Z",
  "version": "1.0.0"
}
```

### Agent Information

**GET** `/api/v1/info`

Get agent metadata and capabilities.

```bash
curl http://localhost:3000/api/v1/info
```

**Response:**

```json
{
  "name": "code-reviewer",
  "version": "1.0.0",
  "description": "AI-powered code review agent",
  "capabilities": ["code-review", "security-analysis"],
  "model": {
    "provider": "anthropic",
    "model": "claude-3-5-sonnet-20241022"
  },
  "tools": [
    {
      "name": "analyze_code",
      "description": "Analyze code for issues"
    }
  ]
}
```

### Execute Agent

**POST** `/api/v1/execute`

Execute agent with input.

```bash
curl -X POST http://localhost:3000/api/v1/execute \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "input": "Review this code: def hello(): pass",
    "context": {
      "language": "python"
    }
  }'
```

**Request Body:**

```typescript
{
  input: string;          // User input
  context?: object;       // Execution context (optional)
  options?: {
    temperature?: number; // Override temperature
    maxTokens?: number;   // Override max tokens
    tools?: string[];     // Specific tools to use
  };
}
```

**Response:**

```json
{
  "success": true,
  "output": "Code review complete. The function looks good.",
  "metadata": {
    "executionTime": 1234,
    "tokensUsed": 150,
    "cost": 0.00225
  },
  "toolCalls": []
}
```

### Validate Input

**POST** `/api/v1/validate`

Validate input before execution.

```bash
curl -X POST http://localhost:3000/api/v1/validate \
  -H "Content-Type: application/json" \
  -d '{
    "input": "test input",
    "schema": "execute"
  }'
```

**Response:**

```json
{
  "valid": true,
  "errors": []
}
```

### OpenAPI Specification

**GET** `/openapi` or `/api/v1/openapi`

Get complete OpenAPI 3.1 specification.

```bash
curl http://localhost:3000/openapi
```

Returns full OpenAPI YAML or JSON.

## Platform-Specific Endpoints

### Anthropic Export Endpoints

#### Chat

**POST** `/api/v1/chat`

Send message to Claude agent.

```bash
curl -X POST http://localhost:3000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {"role": "user", "content": "Hello"}
    ],
    "temperature": 0.7
  }'
```

**Response:**

```json
{
  "success": true,
  "response": {
    "text": "Hello! How can I help you today?",
    "usage": {
      "inputTokens": 10,
      "outputTokens": 12,
      "totalTokens": 22
    },
    "cost": 0.00033,
    "stopReason": "end_turn"
  }
}
```

#### Streaming Chat

**POST** `/api/v1/chat/stream`

Stream agent response in real-time.

```bash
curl -X POST http://localhost:3000/api/v1/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {"role": "user", "content": "Write a poem"}
    ]
  }'
```

Returns Server-Sent Events:

```
data: {"type":"content","delta":"The"}
data: {"type":"content","delta":" roses"}
data: {"type":"content","delta":" are"}
data: {"type":"done","usage":{"totalTokens":50}}
```

#### Models List

**GET** `/api/v1/models`

List available Claude models.

```bash
curl http://localhost:3000/api/v1/models
```

**Response:**

```json
{
  "models": [
    {
      "id": "claude-3-5-sonnet-20241022",
      "name": "Claude 3.5 Sonnet",
      "contextWindow": 200000,
      "pricing": {
        "input": 0.003,
        "output": 0.015
      }
    }
  ]
}
```

### LangChain Export Endpoints

#### Execute Tool

**POST** `/api/v1/tools/{toolName}`

Execute specific LangChain tool.

```bash
curl -X POST http://localhost:3000/api/v1/tools/analyze_code \
  -H "Content-Type: application/json" \
  -d '{
    "code": "def hello(): pass",
    "language": "python"
  }'
```

**Response:**

```json
{
  "success": true,
  "result": "Code analysis complete",
  "metadata": {
    "tool": "analyze_code",
    "executionTime": 500
  }
}
```

#### List Tools

**GET** `/api/v1/tools`

List all available tools.

```bash
curl http://localhost:3000/api/v1/tools
```

**Response:**

```json
{
  "tools": [
    {
      "name": "analyze_code",
      "description": "Analyze code for issues",
      "parameters": {
        "code": {
          "type": "string",
          "required": true
        },
        "language": {
          "type": "string",
          "required": true
        }
      }
    }
  ]
}
```

### npm Export Endpoints

#### Get Manifest

**GET** `/manifest` or `/api/v1/manifest`

Get embedded OSSA manifest.

```bash
curl http://localhost:3000/manifest
```

Returns OSSA YAML manifest.

#### Get Metadata

**GET** `/metadata` or `/api/v1/metadata`

Get agent metadata as JSON.

```bash
curl http://localhost:3000/metadata
```

**Response:**

```json
{
  "name": "my-agent",
  "version": "1.0.0",
  "description": "AI agent",
  "capabilities": ["code-review"],
  "ossaVersion": "v0.4.1"
}
```

## Authentication

### API Key Authentication

Most endpoints require API key authentication:

```bash
curl -H "X-API-Key: your-api-key" \
  http://localhost:3000/api/v1/execute
```

#### Set API Key

```bash
# Environment variable
export API_KEY=your-secret-key

# In request header
X-API-Key: your-secret-key
```

#### Generate API Key

```bash
# Using the API
curl -X POST http://localhost:3000/api/v1/auth/keys \
  -H "Authorization: Bearer admin-token" \
  -d '{
    "name": "production-key",
    "scopes": ["execute", "chat"]
  }'
```

### JWT Authentication

Some exports support JWT tokens:

```bash
curl -H "Authorization: Bearer eyJhbG..." \
  http://localhost:3000/api/v1/execute
```

## Error Responses

All endpoints return consistent error responses:

### 400 Bad Request

```json
{
  "error": {
    "code": "INVALID_INPUT",
    "message": "Input validation failed",
    "details": [
      {
        "field": "input",
        "message": "Required field missing"
      }
    ]
  }
}
```

### 401 Unauthorized

```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Invalid or missing API key"
  }
}
```

### 429 Too Many Requests

```json
{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Rate limit exceeded",
    "retryAfter": 60
  }
}
```

### 500 Internal Server Error

```json
{
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "Agent execution failed",
    "details": "Connection timeout"
  }
}
```

## Rate Limiting

All APIs include rate limiting:

### Default Limits

- **Per IP**: 100 requests/minute
- **Per API Key**: 1000 requests/minute
- **Burst**: 20 requests/second

### Headers

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1633024800
```

### Configure Limits

```bash
# Environment variables
export RATE_LIMIT_PER_IP=100
export RATE_LIMIT_PER_KEY=1000
export RATE_LIMIT_WINDOW=60
```

## CORS Configuration

### Default CORS

```javascript
{
  origin: "*",
  methods: ["GET", "POST", "PUT", "DELETE"],
  allowedHeaders: ["Content-Type", "X-API-Key", "Authorization"]
}
```

### Configure CORS

```bash
# Environment variables
export CORS_ORIGIN=https://example.com
export CORS_METHODS=GET,POST
export CORS_CREDENTIALS=true
```

## Request Validation

All requests are validated against JSON schemas:

### Example Schema

```json
{
  "type": "object",
  "required": ["input"],
  "properties": {
    "input": {
      "type": "string",
      "minLength": 1,
      "maxLength": 10000
    },
    "context": {
      "type": "object"
    },
    "options": {
      "type": "object",
      "properties": {
        "temperature": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    }
  }
}
```

### Validation Errors

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Request validation failed",
    "details": [
      {
        "field": "input",
        "message": "must be string",
        "value": 123
      }
    ]
  }
}
```

## Monitoring

### Metrics Endpoint

**GET** `/metrics`

Prometheus-compatible metrics.

```bash
curl http://localhost:3000/metrics
```

**Response:**

```
# HELP api_requests_total Total API requests
# TYPE api_requests_total counter
api_requests_total{method="POST",endpoint="/execute",status="200"} 1234

# HELP api_request_duration_seconds API request duration
# TYPE api_request_duration_seconds histogram
api_request_duration_seconds_bucket{le="0.1"} 100
api_request_duration_seconds_bucket{le="0.5"} 450
```

### Health Details

**GET** `/health/detailed`

Detailed health information.

```bash
curl http://localhost:3000/health/detailed
```

**Response:**

```json
{
  "status": "healthy",
  "checks": {
    "llm": {
      "status": "healthy",
      "latency": 123
    },
    "database": {
      "status": "healthy",
      "connections": 5
    }
  },
  "metrics": {
    "requestsPerMinute": 45,
    "averageLatency": 234,
    "errorRate": 0.01
  }
}
```

## WebSocket Support

Real-time bidirectional communication:

### Connect

```javascript
const ws = new WebSocket('ws://localhost:3000/ws');

ws.onopen = () => {
  ws.send(JSON.stringify({
    type: 'authenticate',
    apiKey: 'your-api-key'
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log(data);
};
```

### Execute

```javascript
ws.send(JSON.stringify({
  type: 'execute',
  input: 'Analyze this code'
}));
```

### Receive

```javascript
{
  "type": "response",
  "output": "Analysis complete",
  "metadata": {...}
}
```

## Testing

### cURL Examples

```bash
# Health check
curl http://localhost:3000/health

# Execute with auth
curl -X POST http://localhost:3000/api/v1/execute \
  -H "Content-Type: application/json" \
  -H "X-API-Key: test-key" \
  -d '{"input":"test"}'

# Stream response
curl -N -X POST http://localhost:3000/api/v1/chat/stream \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","content":"hello"}]}'
```

### JavaScript/TypeScript

```typescript
// Using fetch
const response = await fetch('http://localhost:3000/api/v1/execute', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-API-Key': 'your-key'
  },
  body: JSON.stringify({
    input: 'test input'
  })
});

const data = await response.json();
console.log(data);
```

### Python

```python
import requests

response = requests.post(
    'http://localhost:3000/api/v1/execute',
    headers={
        'Content-Type': 'application/json',
        'X-API-Key': 'your-key'
    },
    json={
        'input': 'test input'
    }
)

print(response.json())
```

## Best Practices

### 1. Always Include Error Handling

```typescript
try {
  const response = await fetch('/api/v1/execute', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-API-Key': process.env.API_KEY
    },
    body: JSON.stringify({ input })
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error.message);
  }

  const data = await response.json();
  return data;
} catch (error) {
  console.error('API request failed:', error);
  throw error;
}
```

### 2. Implement Retries

```typescript
async function executeWithRetry(input: string, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await execute(input);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await sleep(1000 * (i + 1));  // Exponential backoff
    }
  }
}
```

### 3. Use Environment Variables

```typescript
const API_URL = process.env.API_URL || 'http://localhost:3000';
const API_KEY = process.env.API_KEY;

if (!API_KEY) {
  throw new Error('API_KEY environment variable required');
}
```

### 4. Validate Responses

```typescript
interface ExecuteResponse {
  success: boolean;
  output: string;
  metadata: {
    executionTime: number;
    tokensUsed: number;
  };
}

function validateResponse(data: any): data is ExecuteResponse {
  return (
    typeof data.success === 'boolean' &&
    typeof data.output === 'string' &&
    typeof data.metadata?.executionTime === 'number'
  );
}
```

### 5. Monitor API Usage

```typescript
const startTime = Date.now();

const response = await fetch('/api/v1/execute', options);

const duration = Date.now() - startTime;
console.log(`API call took ${duration}ms`);

// Track in metrics
metrics.recordAPICall(duration, response.status);
```

## Next Steps

- [OpenAPI Specifications](./openapi-specs.md) - Complete OpenAPI guide
- [Best Practices](./best-practices.md) - General best practices
- [Cost Optimization](./cost-optimization.md) - Reduce API costs
