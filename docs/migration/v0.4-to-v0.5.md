# Migration Guide: v0.4.0 to v0.5.0

Upgrade to OSSA v0.5.0 for production-quality exports, API endpoints, and cost optimization.

## Overview

v0.5.0 is a major feature release focused on production readiness:

### What's New

1. **Production-Quality Exports**: LangChain, npm, and Anthropic exports with API endpoints
2. **OpenAPI Specifications**: Complete OpenAPI 3.1 specs for all exports
3. **Cost Optimization**: Prompt caching, token budgets, and usage tracking
4. **API Endpoints**: REST APIs for all platform exports
5. **Enhanced Validation**: Best practices, security, and cost validation
6. **Interactive Documentation**: Swagger UI and ReDoc support

### Breaking Changes

None! v0.5.0 is fully backward compatible with v0.4.0 manifests.

## Installation

### Upgrade npm Package

```bash
# Update to v0.5.0
npm install @bluefly/openstandardagents@0.5.0

# Or latest
npm install @bluefly/openstandardagents@latest

# Verify version
npx ossa --version
```

### Upgrade Global CLI

```bash
# Uninstall old version
npm uninstall -g @bluefly/openstandardagents

# Install v0.5.0
npm install -g @bluefly/openstandardagents@0.5.0

# Verify
ossa --version
```

## Migrate Existing Agents

### 1. Validate Existing Manifests

```bash
# Validate v0.4.0 manifests work with v0.5.0
ossa validate agent.ossa.yaml

# Should output:
# ✓ Valid OSSA manifest (v0.4.0)
# ℹ Compatible with v0.5.0
```

### 2. Update API Version (Optional)

Update to v0.5.0 to access new features:

```yaml
# Before (v0.4.0)
apiVersion: ossa/v0.4.0
kind: Agent
metadata:
  name: my-agent

# After (v0.5.0) - optional, v0.4.0 still works
apiVersion: ossa/v0.5.0
kind: Agent
metadata:
  name: my-agent
```

### 3. Standardize Format

```bash
# Auto-upgrade to v0.5.0 format
ossa standardize agent.ossa.yaml --target-version v0.5.0

# Creates agent.ossa.yaml.v0.5.0
# Review and replace original if looks good
```

## New Features

### 1. API Endpoints

All exports now support API endpoints:

```bash
# Before (v0.4.0)
ossa export agent.ossa.yaml --platform npm --output ./package

# After (v0.5.0) - add API endpoints
ossa export agent.ossa.yaml --platform npm --with-api --output ./package
```

**Generated structure:**

```
package/
├── package.json
├── index.js
├── index.d.ts
├── api/              # NEW in v0.5.0
│   ├── server.ts     # Express API server
│   ├── routes.ts     # API routes
│   └── openapi.yaml  # OpenAPI 3.1 spec
└── README.md
```

**Start API server:**

```bash
cd package
npm install
npm start  # Runs on http://localhost:3000
```

### 2. OpenAPI Specifications

Every export includes complete OpenAPI 3.1 specification:

```bash
# Get OpenAPI spec
curl http://localhost:3000/openapi

# View in Swagger UI
open http://localhost:3000/api-docs
```

**Generate client SDKs:**

```bash
# TypeScript client
openapi-generator-cli generate \
  -i http://localhost:3000/openapi \
  -g typescript-fetch \
  -o ./client

# Python client
openapi-generator-cli generate \
  -i http://localhost:3000/openapi \
  -g python \
  -o ./python-client
```

### 3. Prompt Caching

Enable Anthropic prompt caching for 90% cost savings:

```yaml
# Add to agent manifest
spec:
  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022

  # NEW in v0.5.0
  extensions:
    anthropic:
      prompt_caching:
        enabled: true
        cache_breakpoints:
          - system_prompt
          - tool_definitions
```

**Usage:**

```typescript
import { AnthropicAdapter } from './runtime';

const adapter = new AnthropicAdapter(manifest, {
  enablePromptCaching: true  // NEW
});

// First request: $0.015
const response1 = await adapter.execute([...]);

// Subsequent requests: $0.002 (87% cheaper!)
const response2 = await adapter.execute([...]);
```

### 4. Token Budgets

Prevent cost overruns with token limits:

```yaml
# NEW in v0.5.0
spec:
  token_budget:
    max_input_tokens: 100000    # Daily input limit
    max_output_tokens: 50000    # Daily output limit
    max_total_tokens: 150000    # Daily total limit
    reset_interval: daily
```

**Enforcement:**

```typescript
try {
  const response = await adapter.execute([...]);
} catch (error) {
  if (error.code === 'TOKEN_BUDGET_EXCEEDED') {
    console.error('Daily token budget exceeded');
  }
}
```

### 5. Enhanced Validation

New validation rules for best practices, security, and cost:

```bash
# Run enhanced validation
ossa validate agent.ossa.yaml --enhanced

# Output:
# ✓ Schema validation passed
# ⚠ Best practice: Set maxTokens to avoid excessive costs
# ⚠ Security: temperature > 0.8 may produce unpredictable outputs
# ⚠ Cost: Consider enabling prompt caching for Anthropic provider
```

**Fix suggestions automatically:**

```bash
ossa validate agent.ossa.yaml --fix

# Adds recommended settings:
# - maxTokens: 2048 (if missing)
# - temperature: 0.7 (if > 0.9)
# - prompt_caching: enabled (for Anthropic)
```

## Migration Examples

### Example 1: Simple Agent

**Before (v0.4.0):**

```yaml
apiVersion: ossa/v0.4.0
kind: Agent
metadata:
  name: code-reviewer
  version: 1.0.0
spec:
  role: Code Reviewer
  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
```

**After (v0.5.0):**

```yaml
apiVersion: ossa/v0.5.0  # Updated
kind: Agent
metadata:
  name: code-reviewer
  version: 1.1.0  # Bump version
spec:
  role: Code Reviewer
  llm:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.3        # NEW: explicit temperature
    maxTokens: 2048        # NEW: token limit

  # NEW: Cost optimization
  extensions:
    anthropic:
      prompt_caching:
        enabled: true

  # NEW: Token budget
  token_budget:
    max_total_tokens: 100000
    reset_interval: daily
```

### Example 2: npm Package Export

**Before (v0.4.0):**

```bash
ossa export agent.ossa.yaml --platform npm --output ./package

# Generated files:
# - package.json
# - index.js
# - index.d.ts
# - README.md
```

**After (v0.5.0):**

```bash
ossa export agent.ossa.yaml \
  --platform npm \
  --with-api \
  --skill \
  --output ./package

# Generated files:
# - package.json
# - index.js
# - index.d.ts
# - api/server.ts      # NEW
# - api/routes.ts      # NEW
# - api/openapi.yaml   # NEW
# - SKILL.md           # NEW (Claude Code skill)
# - README.md
```

**Deploy as API:**

```bash
cd package
npm install
npm start

# API available at http://localhost:3000
# OpenAPI spec at http://localhost:3000/openapi
# Swagger UI at http://localhost:3000/api-docs
```

### Example 3: LangChain Export

**Before (v0.4.0):**

```bash
ossa export agent.ossa.yaml --platform langchain --output ./langchain
```

**After (v0.5.0):**

```bash
ossa export agent.ossa.yaml \
  --platform langchain \
  --with-api \
  --output ./langchain

# Deploy API
cd langchain
npm install
npm start

# Use API
curl -X POST http://localhost:3000/api/v1/execute \
  -H "Content-Type: application/json" \
  -d '{"input": "test"}'
```

## CLI Command Updates

### New Commands

```bash
# Interactive wizard (enhanced)
ossa wizard create

# Lint manifests
ossa lint agent.ossa.yaml

# Generate OpenAPI spec from manifest
ossa generate openapi agent.ossa.yaml --output openapi.yaml

# Estimate costs
ossa estimate agent.ossa.yaml --requests 10000
```

### Updated Commands

```bash
# Export with new options
ossa export agent.ossa.yaml \
  --platform npm \
  --with-api \              # NEW: Include API endpoints
  --skill \                 # NEW: Include Claude Skill
  --dry-run \              # Enhanced preview
  --verbose                # Enhanced logging

# Validate with new rules
ossa validate agent.ossa.yaml \
  --enhanced \             # NEW: Enhanced validation
  --fix \                  # NEW: Auto-fix issues
  --cost-analysis          # NEW: Cost analysis
```

## Troubleshooting

### Import Errors After Upgrade

**Problem:**

```typescript
// Error: Cannot find module '@bluefly/openstandardagents/validation'
import { validateManifest } from '@bluefly/openstandardagents/validation';
```

**Solution:**

```bash
# Clear node_modules and reinstall
rm -rf node_modules package-lock.json
npm install
```

### Version Mismatch

**Problem:**

```bash
ossa --version
# Shows: 0.4.0 (expected 0.5.0)
```

**Solution:**

```bash
# Clear npm cache
npm cache clean --force

# Reinstall
npm install -g @bluefly/openstandardagents@0.5.0

# Verify
ossa --version  # Should show 0.5.0
```

### Validation Warnings

**Problem:**

```bash
ossa validate agent.ossa.yaml
# ⚠ Warning: maxTokens not set
```

**Solution:**

```bash
# Auto-fix warnings
ossa validate agent.ossa.yaml --fix

# Or manually add to manifest
spec:
  llm:
    maxTokens: 2048
```

### API Server Won't Start

**Problem:**

```bash
npm start
# Error: Port 3000 already in use
```

**Solution:**

```bash
# Use different port
PORT=3001 npm start

# Or kill existing process
lsof -ti:3000 | xargs kill
```

## Backward Compatibility

### v0.4.0 Manifests

All v0.4.0 manifests work with v0.5.0 without changes:

```bash
# v0.4.0 manifest
cat agent.ossa.yaml
# apiVersion: ossa/v0.4.0
# ...

# Validate with v0.5.0
ossa validate agent.ossa.yaml
# ✓ Valid OSSA manifest (v0.4.0)
# ℹ Compatible with v0.5.0

# Export with v0.5.0
ossa export agent.ossa.yaml --platform npm
# ✓ Works perfectly
```

### API Breaking Changes

None. All v0.5.0 APIs are additions, not replacements.

## Rollback

If you need to rollback to v0.4.0:

```bash
# Uninstall v0.5.0
npm uninstall -g @bluefly/openstandardagents

# Install v0.4.0
npm install -g @bluefly/openstandardagents@0.4.0

# Verify
ossa --version  # Should show 0.4.0
```

## Next Steps

- [Export Guides](../exports/) - Platform-specific export guides
- [API Endpoints](../guides/api-endpoints.md) - Complete API documentation
- [Cost Optimization](../guides/cost-optimization.md) - Reduce costs by 90%
- [Best Practices](../guides/best-practices.md) - Production best practices

## Support

Need help migrating?

- **Issues**: [GitLab Issues](https://gitlab.com/blueflyio/ossa/openstandardagents/-/issues)
- **Discussions**: [GitLab Discussions](https://gitlab.com/blueflyio/ossa/openstandardagents/-/issues)
- **Documentation**: [openstandardagents.org](https://openstandardagents.org)
