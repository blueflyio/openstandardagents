# OSSA v0.3.0 Workflow: Drupal Module Development
# Composes Tasks and Agents into a complete development workflow
apiVersion: ossa/v0.3.0
kind: Workflow

metadata:
  name: drupal-module-development
  version: 1.0.0
  description: Full Drupal module development workflow with lint, fix, sync, and test
  labels:
    domain: drupal
    tier: development
    category: workflow
  annotations:
    ossa.io/created-date: "2025-12-09"

spec:
  triggers:
    - type: manual
    - type: event
      source: gitlab
      event: issue.created
      filter:
        labels:
          - type::feature
          - domain::drupal

  inputs:
    type: object
    properties:
      module_path:
        type: string
        description: Path to the Drupal module
      issue_id:
        type: string
        description: GitLab issue ID
    required:
      - module_path

  outputs:
    type: object
    properties:
      success:
        type: boolean
      phpcs_violations:
        type: integer
      files_synced:
        type: integer

  steps:
    - id: analyze
      name: Analyze Module Requirements
      kind: Agent
      ref: ./agents/drupal-module-specialist.ossa.yaml
      input:
        task: "Analyze module at ${{ workflow.input.module_path }}"
      timeout_seconds: 300

    - id: lint
      name: Check PHP Coding Standards
      kind: Task
      ref: ./tasks/phpcs-check.ossa.yaml
      depends_on:
        - analyze
      input:
        path: "${{ workflow.input.module_path }}"
        standard: Drupal,DrupalPractice
      continue_on_error: true

    - id: fix
      name: Auto-fix Coding Standards
      kind: Task
      ref: ./tasks/phpcbf-fix.ossa.yaml
      condition: "${{ steps.lint.output.has_errors == true }}"
      depends_on:
        - lint
      input:
        path: "${{ workflow.input.module_path }}"

    - id: sync
      name: Sync to LLM Platform
      kind: Task
      ref: ./tasks/drupal-sync.ossa.yaml
      depends_on:
        - fix
      input:
        modules: true
        dry_run: false

    - id: commit
      name: Commit Changes
      kind: Task
      ref: ./tasks/git-commit.ossa.yaml
      depends_on:
        - sync
      input:
        type: feat
        scope: drupal
        subject: "implement module changes"
        issue_ref: "${{ workflow.input.issue_id }}"

  context:
    variables:
      standard: Drupal,DrupalPractice
      source_dir: /Users/flux423/Sites/LLM/all_drupal_custom/modules

  concurrency:
    group: drupal-development
    cancel_in_progress: false

  error_handling:
    on_failure: compensate
    compensation_steps:
      - id: rollback
        name: Rollback Changes
        kind: Task
        inline:
          execution:
            type: idempotent
            runtime: any
            entrypoint: git checkout .
    notification:
      channels:
        - slack
      template: workflow-failure

  timeout_seconds: 1800

  observability:
    tracing:
      enabled: true
      propagate_context: true
    metrics:
      enabled: true
      custom_labels:
        workflow: drupal-module-development
    logging:
      level: info
