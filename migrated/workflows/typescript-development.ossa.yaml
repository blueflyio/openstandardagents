# OSSA v0.3.0 Workflow: TypeScript Development
# Complete TypeScript package development workflow
apiVersion: ossa/v0.3.0
kind: Workflow

metadata:
  name: typescript-development
  version: 1.0.0
  description: TypeScript package development workflow with build, test, and lint
  labels:
    domain: typescript
    tier: development
    category: workflow
  annotations:
    ossa.io/created-date: "2025-12-09"

spec:
  triggers:
    - type: manual
    - type: event
      source: gitlab
      event: merge_request.created

  inputs:
    type: object
    properties:
      package_path:
        type: string
        description: Path to the TypeScript package
      run_tests:
        type: boolean
        description: Whether to run tests
    required:
      - package_path

  outputs:
    type: object
    properties:
      build_success:
        type: boolean
      test_passed:
        type: boolean
      coverage:
        type: number

  steps:
    - id: install
      name: Install Dependencies
      kind: Task
      inline:
        execution:
          type: idempotent
          runtime: node
          entrypoint: npm install
          timeout_seconds: 120

    - id: lint
      name: Run ESLint
      kind: Task
      depends_on:
        - install
      inline:
        execution:
          type: deterministic
          runtime: node
          entrypoint: npm run lint
          timeout_seconds: 60
      continue_on_error: true

    - id: typecheck
      name: TypeScript Type Check
      kind: Task
      depends_on:
        - install
      inline:
        execution:
          type: deterministic
          runtime: node
          entrypoint: npm run typecheck
          timeout_seconds: 120

    - id: build
      name: Build Package
      kind: Task
      ref: ./tasks/npm-build.ossa.yaml
      depends_on:
        - typecheck
      input:
        working_directory: "${{ workflow.input.package_path }}"
        production: true

    - id: test
      name: Run Tests
      kind: Task
      ref: ./tasks/npm-test.ossa.yaml
      condition: "${{ workflow.input.run_tests == true }}"
      depends_on:
        - build
      input:
        working_directory: "${{ workflow.input.package_path }}"
        coverage: true

    - id: quality-gate
      name: Quality Gate Check
      kind: Conditional
      depends_on:
        - test
      branches:
        - condition: "${{ steps.test.output.coverage_percent >= 80 }}"
          steps:
            - id: pass
              kind: Task
              inline:
                execution:
                  type: deterministic
                  runtime: any
                  entrypoint: "echo 'Quality gate passed'"
      else:
        - id: fail
          kind: Task
          inline:
            execution:
              type: deterministic
              runtime: any
              entrypoint: "exit 1"

  concurrency:
    group: typescript-dev-${{ workflow.input.package_path }}
    cancel_in_progress: true

  error_handling:
    on_failure: halt
    notification:
      channels:
        - slack

  timeout_seconds: 1200

  observability:
    tracing:
      enabled: true
    metrics:
      enabled: true
    logging:
      level: info
