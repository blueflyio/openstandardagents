# OSSA v0.3.0 Workflow: CI Pipeline Fix
# Self-healing workflow for CI/CD pipeline failures
apiVersion: ossa/v0.3.0
kind: Workflow

metadata:
  name: ci-pipeline-fix
  version: 1.0.0
  description: Self-healing workflow for CI/CD pipeline failures with 3 retry attempts
  labels:
    domain: cicd
    tier: platform
    category: healing
  annotations:
    ossa.io/created-date: "2025-12-09"

spec:
  triggers:
    - type: event
      source: gitlab
      event: pipeline.failed
    - type: webhook
      path: /webhooks/pipeline-failed

  inputs:
    type: object
    properties:
      pipeline_id:
        type: string
        description: GitLab pipeline ID
      project_id:
        type: string
        description: GitLab project ID
      failure_type:
        type: string
        description: Type of failure (lint, test, build, security)
    required:
      - pipeline_id
      - project_id

  outputs:
    type: object
    properties:
      fixed:
        type: boolean
      attempts:
        type: integer
      fix_type:
        type: string

  steps:
    - id: analyze-failure
      name: Analyze Pipeline Failure
      kind: Agent
      ref: ./agents/debug-specialist.ossa.yaml
      input:
        pipeline_id: "${{ workflow.input.pipeline_id }}"
        task: "Analyze CI pipeline failure and identify root cause"
      timeout_seconds: 300

    - id: determine-fix
      name: Determine Fix Strategy
      kind: Conditional
      branches:
        - condition: "${{ steps.analyze-failure.output.failure_type == 'lint' }}"
          steps:
            - id: fix-lint
              kind: Task
              ref: ./tasks/phpcbf-fix.ossa.yaml
              input:
                path: "${{ steps.analyze-failure.output.affected_path }}"
        - condition: "${{ steps.analyze-failure.output.failure_type == 'test' }}"
          steps:
            - id: fix-test
              kind: Agent
              ref: ./agents/debug-specialist.ossa.yaml
              input:
                task: "Fix failing tests"
        - condition: "${{ steps.analyze-failure.output.failure_type == 'build' }}"
          steps:
            - id: fix-build
              kind: Task
              ref: ./tasks/npm-build.ossa.yaml
              input:
                working_directory: "${{ steps.analyze-failure.output.affected_path }}"
      else:
        - id: escalate
          name: Escalate to Human
          kind: Task
          inline:
            execution:
              type: deterministic
              runtime: any
              entrypoint: glab issue create --title "Pipeline fix required"

    - id: verify-fix
      name: Verify Fix
      kind: Task
      ref: ./tasks/npm-test.ossa.yaml
      depends_on:
        - determine-fix
      input:
        working_directory: "."
        coverage: false

    - id: commit-fix
      name: Commit Fix
      kind: Task
      ref: ./tasks/git-commit.ossa.yaml
      condition: "${{ steps.verify-fix.output.passed == true }}"
      depends_on:
        - verify-fix
      input:
        type: fix
        scope: ci
        subject: "auto-fix pipeline failure"

  error_handling:
    on_failure: notify
    retry_policy:
      max_attempts: 3
      backoff: exponential
      initial_delay_ms: 5000
      max_delay_ms: 60000
    notification:
      channels:
        - slack
        - email
      template: pipeline-fix-failed

  timeout_seconds: 900

  observability:
    tracing:
      enabled: true
      propagate_context: true
    metrics:
      enabled: true
      custom_labels:
        workflow: ci-pipeline-fix
    logging:
      level: info
