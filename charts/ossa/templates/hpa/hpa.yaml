{{- if .Values.hpa.enabled }}
{{- $services := list "gateway" "taskAgent" "commAgent" "mcpAgent" "coordination" "discovery" "orchestration" "monitoring" }}
{{- range $serviceName := $services }}
{{- $service := index $.Values.services $serviceName }}
{{- if $service.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "ossa.fullname" $ }}-{{ $serviceName | kebabcase }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "ossa.serviceLabels" (dict "component" ($serviceName | kebabcase) "Chart" $.Chart "Release" $.Release "Values" $.Values) | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "ossa.fullname" $ }}-{{ $serviceName | kebabcase }}
  minReplicas: {{ $service.minReplicas | default 1 }}
  maxReplicas: {{ $service.maxReplicas | default 10 }}
  metrics:
  {{- if $.Values.hpa.metrics.cpu }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ $.Values.hpa.metrics.cpu.targetAverageUtilization | default 70 }}
  {{- end }}
  {{- if $.Values.hpa.metrics.memory }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ $.Values.hpa.metrics.memory.targetAverageUtilization | default 70 }}
  {{- end }}
  {{- if and $.Values.hpa.customMetrics.enabled $.Values.hpa.customMetrics.requests }}
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: {{ $.Values.hpa.customMetrics.requests.targetAverageValue | default "1000m" }}
  {{- end }}
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15
      selectPolicy: Max
{{- end }}
{{- end }}
{{- end }}