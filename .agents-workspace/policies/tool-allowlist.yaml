# ============================================================================
# OSSA Tool Policy - MCP Server Allowlist
# ============================================================================
# Defines what tools are permitted within this workspace.
# Projects reference this policy; they cannot request tools not listed here.
# ============================================================================

apiVersion: ossa.dev/v1
kind: ToolPolicy
metadata:
  name: ossa-workspace-policy
  version: "1.0.0"

spec:
  mcp_servers:
    allowed:
      # Filesystem access - HIGH TRUST
      - name: filesystem
        uri: npx -y @modelcontextprotocol/server-filesystem
        trust: high
        scope: [read, write]
        directories:
          - ./src
          - ./docs
          - ./.agents
          - ./examples
          - ./tests
        description: File system access for code and documentation

      # Git operations - HIGH TRUST
      - name: git
        uri: npx -y @modelcontextprotocol/server-git
        trust: high
        scope: [read, status, diff, log]
        description: Git repository operations (read-only by default)

      # GitLab integration - MEDIUM TRUST
      - name: gitlab
        uri: npx -y @modelcontextprotocol/server-gitlab
        trust: medium
        scope: [read, issues, mrs]
        description: GitLab API access for issues and merge requests

      # GitHub integration - MEDIUM TRUST
      - name: github
        uri: npx -y @modelcontextprotocol/server-github
        trust: medium
        scope: [read, issues, prs]
        description: GitHub API access for issues and pull requests

      # Memory/persistence - HIGH TRUST
      - name: memory
        uri: npx -y @modelcontextprotocol/server-memory
        trust: high
        scope: [read, write]
        description: Knowledge graph persistence

      # PostgreSQL - MEDIUM TRUST
      - name: postgres
        uri: npx -y @modelcontextprotocol/server-postgres
        trust: medium
        scope: [read, query]
        description: PostgreSQL database access (read-only)

      # Sequential thinking - HIGH TRUST
      - name: sequential-thinking
        uri: npx -y @modelcontextprotocol/server-sequential-thinking
        trust: high
        scope: [execute]
        description: Structured reasoning and problem solving

    denied:
      # Shell execution - BLOCKED
      - pattern: "*shell*"
        reason: "Direct shell access prohibited - use specific tool servers"

      - pattern: "*execute*"
        reason: "Arbitrary code execution prohibited"

      - pattern: "*eval*"
        reason: "Dynamic code evaluation prohibited"

  risk_tiers:
    high:
      requires: human-approval
      audit: full
      retention: 90d
      examples:
        - "Database schema changes"
        - "Credential access"
        - "Production deployments"

    medium:
      requires: workspace-policy
      audit: summary
      retention: 30d
      examples:
        - "External API calls"
        - "File modifications"
        - "Git operations"

    low:
      requires: none
      audit: none
      retention: 7d
      examples:
        - "Read-only operations"
        - "Documentation access"
        - "Schema validation"

  boundaries:
    global_never:
      # Secrets and credentials
      - "**/.env"
      - "**/.env.*"
      - "**/secrets/**"
      - "**/*.key"
      - "**/*.pem"
      - "**/credentials.json"

      # Package management internals
      - "**/node_modules/**"
      - "**/vendor/**"
      - "**/.git/objects/**"

      # Build artifacts
      - "**/dist/**"
      - "**/build/**"
      - "**/.next/**"

      # IDE and tool configs with potential secrets
      - "**/.vscode/settings.json"
      - "**/.idea/**"

  compliance:
    standards:
      - "OWASP Top 10"
      - "OSSA Security Guidelines"
    audit_log:
      enabled: true
      destination: ".agents-workspace/logs/"
      format: jsonl

  # Security tiers (detailed definitions)
  security_tiers:
    # Standard tier - Most agents operate here
    standard:
      level: 1
      permissions:
        - read:source
        - read:docs
        - read:tests
        - write:generated
        - execute:lint
        - execute:test
      restrictions:
        - no-network-access
        - no-credential-access
        - sandbox-execution
      audit: minimal

    # Elevated tier - CI/CD and security tools
    elevated:
      level: 2
      permissions:
        - read:*
        - write:source
        - write:tests
        - execute:build
        - execute:deploy-preview
        - access:git
      restrictions:
        - no-production-access
        - no-credential-modification
        - logged-execution
      audit: detailed
      requires:
        - workspace-approval

    # Admin tier - Full access (human oversight required)
    admin:
      level: 3
      permissions:
        - read:*
        - write:*
        - execute:*
        - access:credentials
        - access:production
      restrictions:
        - human-in-the-loop
        - full-audit-trail
      audit: full
      requires:
        - human-approval
        - mfa-verification

  # Agent tier assignments
  agent_tiers:
    code-assistant: standard
    doc-generator: standard
    test-generator: standard
    data-transformer: standard
    code-reviewer: elevated
    security-scanner: elevated
    ci-pipeline: elevated
    workflow-orchestrator: elevated
    content-writer: standard
    compliance-validator: elevated

  # Tier escalation policies
  escalation:
    method: explicit-request
    approval:
      standard_to_elevated: workspace-policy
      elevated_to_admin: human-approval
    timeout: 300s  # 5 minute window for elevated operations
