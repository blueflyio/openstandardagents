# Standard Lefthook Configuration Template
# Apply this to ALL git repositories in the monorepo
# NO shell scripts - uses npm/composer/buildkit commands only
# Enforces: GitLab-First workflow, code quality, AI attribution blocking

pre-commit:
  parallel: false
  commands:
    # Validate GitLab CI configuration (CRITICAL - prevents wasting CI minutes)
    validate-gitlab-ci:
      run: .lefthook/checks/validate-gitlab-ci.sh
      priority: 1
      stage_fixed: false
      skip:
        - merge
        - rebase

    # Validate version consistency (CRITICAL for releases)
    validate-version-sync:
      run: |
        # Only check if version-related files are staged
        STAGED_FILES=$(git diff --cached --name-only)
        if echo "$STAGED_FILES" | grep -qE "(package.json|README.md|spec/)"; then
          echo "Validating version consistency..."

          if [ -n "$SKIP_VERSION_CHECK" ]; then
            echo "WARNING: SKIP_VERSION_CHECK set - bypassing validation (NOT RECOMMENDED)"
            exit 0
          fi

          if [ ! -f "src/tools/version/sync-versions.ts" ]; then
            echo "WARNING: sync-versions.ts not found, skipping validation"
            exit 0
          fi

          # Run version sync check
          if ! npx tsx src/tools/version/sync-versions.ts --check 2>&1; then
            echo ""
            echo "ERROR: COMMIT BLOCKED: Version references are inconsistent!"
            echo ""
            echo "FIX THIS:"
            echo " 1. Run: npx tsx src/tools/version/sync-versions.ts --fix"
            echo " 2. Review the changes"
            echo " 3. Stage the updated files: git add ."
            echo " 4. Retry your commit"
            echo ""
            echo "Why this matters:"
            echo " • Prevents releasing versions with wrong README data"
            echo " • Ensures schema paths match package.json"
            echo " • Keeps all documentation synchronized"
            echo ""
            echo "To bypass (NOT RECOMMENDED): SKIP_VERSION_CHECK=1 git commit ..."
            exit 1
          fi

          echo "Version consistency validated"
        fi
      skip:
        - merge
        - rebase

    # Block .md files in root (except README.md)
    block-root-md:
      run: |
        # Allow standard open source project files
        ROOT_MD=$(git diff --cached --name-only --diff-filter=A | grep -E '^[^/]+.md$' | grep -v -E '^(README|CONTRIBUTING|CHANGELOG|LICENSE|CODE_OF_CONDUCT|AGENTS).md$' || true)
        if [ -n "$ROOT_MD" ]; then
          echo ""
          echo "ERROR: .md files in root are forbidden (except standard OSS files)"
          echo "$ROOT_MD" | sed 's/^/  • /'
          echo ""
          echo "Use GitLab Wiki instead:"
          echo "  buildkit gitlab wiki create --slug "page-name" --file file.md"
          echo ""
          echo "INFO:  Allowed root .md files: README.md, CONTRIBUTING.md, CHANGELOG.md, LICENSE.md, CODE_OF_CONDUCT.md, AGENTS.md"
          echo ""
          exit 1
        fi
      files: git diff --cached --name-only --diff-filter=A
      glob: "*.md"

    # Block .sh scripts (use GitLab CI jobs instead)
    block-sh-scripts:
      run: |
        SH_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.sh$' || true)
        if [ -n "$SH_FILES" ]; then
          echo ""
          echo "ERROR: .sh scripts are forbidden (use GitLab CI jobs)"
          echo "$SH_FILES" | sed 's/^/  • /'
          echo ""
          echo "Use GitLab CI instead:"
          echo "  Add job to .gitlab-ci.yml"
          echo ""
          exit 1
        fi
      files: git diff --cached --name-only --diff-filter=A
      glob: "*.sh"

    # TypeScript/JavaScript formatting (if package.json exists)
    format:
      run: |
        if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
          if npm run format >/dev/null 2>&1; then
            npm run format
          fi
        fi
      root: "."
      stage_fixed: true
      skip:
        - merge
        - rebase

    # TypeScript/JavaScript linting (if package.json exists)
    lint:
      run: |
        if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
          if npm run lint >/dev/null 2>&1; then
            npm run lint
          fi
        fi
      root: "."
      files: git diff --cached --name-only --diff-filter=ACM
      skip:
        - merge
        - rebase

    # TypeScript type checking (if package.json exists)
    typecheck:
      run: |
        if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
          if npm run typecheck >/dev/null 2>&1; then
            npm run typecheck
          fi
        fi
      root: "."
      glob: "**/*.{ts,tsx}"
      skip:
        - merge
        - rebase

    # PHP/Drupal linting (if composer.json exists)
    phpcs:
      glob: "**/*.{php,module,install,theme,inc}"
      root: "."
      run: |
        if [ -f "composer.json" ] && command -v composer >/dev/null 2>&1; then
          if composer run-script --list 2>/dev/null | grep -q "phpcs"; then
            composer phpcs
          fi
        fi
      skip:
        - merge
        - rebase

    # PHPStan (if composer.json exists)
    phpstan:
      glob: "**/*.{php,module,install,theme,inc}"
      root: "."
      run: |
        if [ -f "composer.json" ] && command -v composer >/dev/null 2>&1; then
          if composer run-script --list 2>/dev/null | grep -q "phpstan"; then
            composer phpstan
          fi
        fi
      skip:
        - merge
        - rebase

commit-msg:
  commands:
    # Block AI attribution in commit messages
    claude-protection:
      run: |
        COMMIT_MSG_FILE="{1}"
        if [ -z "$COMMIT_MSG_FILE" ] || [ "$COMMIT_MSG_FILE" = "{1}" ]; then
          COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
        fi

        if [ ! -f "$COMMIT_MSG_FILE" ]; then
          COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
        fi

        if [ ! -f "$COMMIT_MSG_FILE" ]; then
          echo "WARNING: Could not find commit message file"
          exit 0
        fi

        COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

        # Forbidden patterns that should NEVER appear in commit messages
        if echo "$COMMIT_MSG" | grep -qiE "Generated with.*Claude|Co-Authored-By:.*Claude|robot|claude.ai|noreply@anthropic.com"; then
          echo ""
          echo "COMMIT BLOCKED: Forbidden Claude/AI attribution detected!"
          echo "  ERROR: NO 'Generated with Claude Code'"
          echo "  ERROR: NO 'Co-Authored-By: Claude'"
          echo "  ERROR: NO emoji or AI attribution allowed"
          echo "  ERROR: NO AI/Claude references"
          echo ""
          echo "   Write as the human developer"
          echo "   Use professional technical language"
          echo ""
          exit 1
        fi

    # Require GitLab Issue reference for feature branches (warning only)
    require-issue-ref:
      run: |
        BRANCH=$(git branch --show-current)
        if [[ "$BRANCH" =~ ^(feature|bug|hotfix|chore) ]] && ! grep -qiE "(#[0-9]+|issue|gitlab)" "$1"; then
          echo ""
          echo "WARNING: WARNING: Branch '$BRANCH' should reference GitLab Issue"
          echo "  Format: 'feat: description (fixes #123)'"
          echo ""
        fi

pre-push:
  commands:
    # Run tests (if available)
    test:
      run: |
        if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
          if npm test >/dev/null 2>&1; then
            npm test
          fi
        elif [ -f "composer.json" ] && command -v composer >/dev/null 2>&1; then
          if composer run-script --list 2>/dev/null | grep -q "test"; then
            composer test
          fi
        fi
      root: "."
      skip:
        - merge
        - rebase

    # Security audit (warning only)
    security-audit:
      run: |
        if [ -f "package.json" ] && command -v npm >/dev/null 2>&1; then
          npm audit --audit-level=moderate || true
        fi
      root: "."
      skip:
        - merge
        - rebase

skip_output:
  - meta
  - summary