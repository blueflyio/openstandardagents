# GitLab CI/CD Pipeline for OSSA Platform v1.0
# Comprehensive CI/CD for agent validation, conformance testing, and deployment

# Include golden workflow component for standardization
include:
  - component: gitlab.bluefly.io/llm/gitlab_components/workflow/golden@v0.1.0
    inputs:
      project_name: "OSSA"
      enable_auto_flow: true
      enable_comprehensive_testing: true
      enable_security_scanning: true
      test_coverage_threshold: 85
      enable_roadmap_sync: true
      enable_linear_integration: true

# OSSA-specific stages extending golden workflow
stages:
  - prepare
  - validate
  - conformance
  - build
  - test
  - security
  - benchmark
  - deploy
  - monitor
  - release
  - roadmap-sync

# Global variables
variables:
  NODE_VERSION: "20"
  OSSA_VERSION: "1.0"
  PROJECT_VERSION: "1.0.0"
  DOCKER_REGISTRY: "registry.gitlab.com/${CI_PROJECT_PATH}"
  # Database configuration
  POSTGRES_VERSION: "14"
  POSTGRES_DB: "ossa_test"
  POSTGRES_USER: "ossa"
  POSTGRES_PASSWORD: "ossa_test_password"
  DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}"
  # Conformance thresholds
  BRONZE_COVERAGE: "50"
  SILVER_COVERAGE: "70"
  GOLD_COVERAGE: "85"
  PLATINUM_COVERAGE: "95"
  
# TDD Phase 1: All tests MUST fail (RED)
test:red-phase:
  stage: test-red
  image: node:${NODE_VERSION}
  script:
    - echo "üî¥ TDD RED Phase - Expecting ALL tests to fail"
    - npm install
    - npm run build || true  # Allow build to fail
    - npm run api:validate || echo "‚úÖ API validation expected to pass"
    - "echo 'Running ACDL tests (expecting failures)...'"
    - "npm run test:acdl 2>&1 | tee test-output.log || true"
    - "FAILED_TESTS=$(grep -c 'FAIL' test-output.log || echo '0')"
    - "TOTAL_TESTS=$(grep -c '‚úì\\|‚úó\\|√ó' test-output.log || echo '1')"
    - "echo 'Failed tests: $FAILED_TESTS'"
    - "echo 'Total tests: $TOTAL_TESTS'"
    - "if [ \"$FAILED_TESTS\" -eq \"0\" ]; then echo '‚ùå ERROR: Tests are passing but should fail in TDD RED phase!' && exit 1; else echo '‚úÖ SUCCESS: $FAILED_TESTS tests failing as expected in RED phase'; fi"
    - npm run test:coverage || echo "Coverage collection may fail in RED phase"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: test-results.xml
    paths:
      - coverage/
      - test-output.log
    expire_in: 1 week
  allow_failure: true  # Expected to fail in RED phase
  only:
    - __REBUILD
    - feature/*
    - fix/*
    - fix/*
    - development

# OSSA-specific validation job
validate:ossa-spec:
  stage: validate
  needs: ["detect:version"]
  image: node:20
  script:
    - echo "üîç Validating OSSA specification v${PROJECT_VERSION}"
    - npm install
    - npm run api:validate
    - npx swagger-cli validate src/api/acdl-specification.yml
    - echo "‚úÖ API specifications valid"
  artifacts:
    paths:
      - src/types/api.ts
    expire_in: 1 day
  only:
    - __REBUILD
    - feature/*
    - fix/*
    - fix/*
    - development

# Mock Server Testing
test:mock-server:
  stage: test-agents
  image: node:${NODE_VERSION}
  services:
    - name: redis:latest
      alias: redis
  variables:
    REDIS_URL: "redis://redis:6379"
    MOCK_PORT: "3001"
  script:
    - echo "üñ•Ô∏è Testing ACDL Mock Server"
    - npm install
    - npm run build || echo "Build may fail in RED phase"
    - "npm run mock:server:bg"
    - "sleep 5"
    - "curl -f http://localhost:3001/health || (echo '‚ùå Mock server health check failed' && exit 1)"
    - "echo '‚úÖ Mock server running'"
    - "echo 'üöÄ Testing agent spawning...'"
    - "npm run agents:spawn:tdd || echo 'Agent spawning expected to fail without implementation'"
    - "npm run agents:spawn:validation || echo 'Validation spawning expected to fail'"
    - "npm run agents:workload || echo 'Workload check may fail without agents'"
    - "echo 'Agent spawn tests completed'"
    - "echo 'üß™ Running tests against mock server'"
    - "npm run test:with-mock || echo 'Tests expected to fail in RED phase'"
  artifacts:
    paths:
      - test-output.log
    expire_in: 1 week
  allow_failure: true
  only:
    - __REBUILD
    - feature/*
    - fix/*

# OSSA specification security check
security:ossa-spec:
  stage: security
  image: node:20
  script:
    - echo "üîí Running security scans"
    - npm install
    - npm audit --audit-level=moderate || echo "Security issues found - will be addressed in implementation phase"
    - "if grep -r 'password\\|secret\\|key\\|token' test/ --include='*.ts' --include='*.js' | grep -v 'mock\\|test\\|example'; then echo '‚ö†Ô∏è Potential secrets in test files'; else echo '‚úÖ No secrets found in test files'; fi"
  allow_failure: true
  only:
    - __REBUILD
    - feature/*
    - fix/*
    - main

# Lint and Format Check
lint:check:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "üßπ Running linting and formatting checks"
    - npm install
    - npm run lint || echo "Linting issues found"
    - npx prettier --check 'src/**/*.ts' 'test/**/*.ts' || echo "Formatting issues found"
  artifacts:
    reports:
      junit: lint-results.xml
  allow_failure: true
  only:
    - __REBUILD
    - feature/*
    - fix/*

# Build Verification (may fail in RED phase)
build:verify:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - echo "üî® Attempting build (may fail in TDD RED phase)"
    - npm install
    - npm run clean
    - npm run build || {
        echo "‚ö†Ô∏è Build failed - expected in RED phase without implementation"
        echo "Build will succeed once implementation is complete"
        exit 0
      }
    - echo "‚úÖ Build successful"
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  allow_failure: true
  only:
    - __REBUILD
    - feature/*
    - fix/*

# Agent Integration Test
test:agent-integration:
  stage: test-agents
  image: node:${NODE_VERSION}
  variables:
    OSSA_API_URL: "http://localhost:3001"
  script:
    - echo "ü§ñ Testing agent integration patterns"
    - npm install
    - npm run build || true
    - "npm run mock:server:bg"
    - "sleep 3"
    - "echo 'Testing orchestrator agents...'"
    - "curl -X POST http://localhost:3001/api/v1/acdl/discover -H 'Content-Type: application/json' -d '{\"agentType\": \"orchestrator\"}' || echo 'Expected to work with mock'"
    - "echo 'Testing worker agents...'"
    - "curl -X POST http://localhost:3001/api/v1/acdl/discover -H 'Content-Type: application/json' -d '{\"agentType\": \"worker\", \"domains\": [\"api-design\"]}' || echo 'Expected to work with mock'"
    - "echo 'Testing critic agents...'"
    - "curl -X POST http://localhost:3001/api/v1/acdl/discover -H 'Content-Type: application/json' -d '{\"agentType\": \"critic\", \"domains\": [\"security\", \"quality\"]}' || echo 'Expected to work with mock'"
    - "echo '‚úÖ Agent integration patterns tested'"
  allow_failure: true
  only:
    - __REBUILD
    - feature/*
    - fix/*

# Roadmap Pipeline Jobs
roadmap:validate:
  stage: roadmap
  image: node:${NODE_VERSION}
  script:
    - echo "üìã Validating ROADMAP.md"
    - npm install
    - npm run roadmap:validate ROADMAP.md || echo "Validation warnings"
  artifacts:
    reports:
      junit: roadmap-validation.xml
    paths:
      - roadmap-validation.json
  only:
    changes:
      - ROADMAP.md
      - roadmaps/**/*.md

roadmap:parse:
  stage: roadmap
  image: node:${NODE_VERSION}
  script:
    - echo "üîç Parsing roadmap to structured format"
    - npm install
    - npm run roadmap:parse ROADMAP.md --output roadmap.json
    - npm run roadmap:export --format yaml --output roadmap.yaml
  artifacts:
    paths:
      - roadmap.json
      - roadmap.yaml
    expire_in: 1 week
  only:
    changes:
      - ROADMAP.md

roadmap:sync:linear:
  stage: roadmap
  image: node:${NODE_VERSION}
  dependencies:
    - roadmap:parse
  script:
    - echo "üîÑ Syncing roadmap to Linear"
    - npm install
    - |
      if [ -n "$LINEAR_API_KEY" ] && [ -n "$LINEAR_TEAM_ID" ]; then
        npm run roadmap:sync --to-linear --team-id $LINEAR_TEAM_ID
        echo "‚úÖ Roadmap synced to Linear"
      else
        echo "‚ö†Ô∏è Linear credentials not configured, skipping sync"
      fi
  only:
    refs:
      - main
      - development
    changes:
      - ROADMAP.md
  when: manual

roadmap:aggregate:
  stage: roadmap
  image: node:${NODE_VERSION}
  script:
    - echo "üìä Aggregating project roadmaps"
    - npm install
    - npm run roadmap:aggregate --projects "packages/*" --output AGGREGATED_ROADMAP.md
    - npm run roadmap:export --source AGGREGATED_ROADMAP.md --format dita --output docs/roadmap/
  artifacts:
    paths:
      - AGGREGATED_ROADMAP.md
      - docs/roadmap/
    expire_in: 1 month
  only:
    - schedules
    - main

# Contract Testing (Dredd-style)
test:contracts:
  stage: test-red
  image: node:${NODE_VERSION}
  script:
    - echo "üìã Contract testing against OpenAPI spec"
    - npm install
    - "npm install -g dredd || echo 'Dredd installation may fail'"
    - "npm run mock:server:bg"
    - "sleep 3"
    - "dredd src/api/acdl-specification.yml http://localhost:3001 || (echo '‚ö†Ô∏è Contract tests failed - expected in RED phase' && echo 'Will pass once implementation matches specification')"
  allow_failure: true
  only:
    - __REBUILD
    - feature/*
    - fix/*

# Deploy to test environment (OSSA as specification standard)
deploy:test:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "üöÄ Deploying OSSA specification standard"
    - echo "Building specification package"
    - npm install
    - npm run build
    - echo "‚úÖ OSSA specification ready for deployment"
  when: manual
  only:
    - feature/v0.1.0-specification-separation
    - development
  environment:
    name: specification-standard
    url: https://ossa.dev

# Notification job
notify:status:
  stage: .post
  image: alpine:latest
  script:
    - "echo 'üìä CI/CD Pipeline Status for OSSA v0.1.0 Specification'"
    - "echo 'Phase: Specification Standard (pure specification)'"
    - "echo 'Implementation migrated to agent-buildkit'"
    - "echo 'OSSA Specification Results:'"
    - "echo '- ‚úÖ API validation: Expected to PASS'"
    - "echo '- ‚úÖ Specification build: Expected to PASS'"
    - "echo '- ‚ö†Ô∏è Implementation tests: MIGRATED to agent-buildkit'"
    - "echo ''"
    - "echo 'OSSA is now a pure specification standard like OpenAPI'"
    - "echo 'Implementation available at agent-buildkit'"
  allow_failure: true
  when: always

# Cache configuration
cache:
  key: 
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

# GitLab Pages deployment
pages:
  stage: pages
  image: node:${NODE_VERSION}
  script:
    - echo "üåê Building OSSA Documentation Site with Redocly"
    - npm install
    - echo "Preparing public directory with Redocly API documentation..."
    - |
      # The public directory already contains our Redocly setup
      # Just need to copy OpenAPI specs to be accessible
      mkdir -p public/src/api
      cp src/api/*.yml public/src/api/ 2>/dev/null || true
      cp src/api/*.yaml public/src/api/ 2>/dev/null || true
      
      # Create docs structure
      mkdir -p public/docs/specification
      mkdir -p public/docs/getting-started
      mkdir -p public/docs/development
      
      # Copy key documentation
      if [ -f ".agents/README.md" ]; then
        cp .agents/README.md public/docs/specification/agents.md
        # Convert markdown to HTML for web viewing
        npx markdown-to-html .agents/README.md -o public/docs/specification/agents.html 2>/dev/null || true
      fi
      
      if [ -f "README.md" ]; then
        cp README.md public/docs/getting-started/index.md
        npx markdown-to-html README.md -o public/docs/getting-started/index.html 2>/dev/null || true
      fi
      
      if [ -f "ROADMAP.md" ]; then
        cp ROADMAP.md public/docs/development/roadmap.md
        npx markdown-to-html ROADMAP.md -o public/docs/development/roadmap.html 2>/dev/null || true
      fi
      
      
      # The main API documentation page is api-docs.html with Redocly
      if [ -f "public/api-docs.html" ]; then
        echo "‚úÖ Redocly API documentation ready at api-docs.html"
      fi
      
      echo "‚úÖ Documentation site built successfully"
    - ls -la public/
    - echo "üì¶ Documentation structure:"
    - find public -type f -name "*.html" | head -20
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main
    - development
    - pages

# Release and tagging job
release:version:
  stage: release
  image: node:${NODE_VERSION}
  script:
    - echo "üè∑Ô∏è Creating release tag for OSSA v${PROJECT_VERSION}"
    - |
      # Create multiple environment tags based on branch
      TAGS_TO_CREATE=()

      if [[ "$CI_COMMIT_BRANCH" == "main" ]]; then
        # Production branch - create production tag
        TAGS_TO_CREATE+=("v${PROJECT_VERSION}")
        echo "Creating production tag: v${PROJECT_VERSION}"
      elif [[ "$CI_COMMIT_BRANCH" == "development" ]]; then
        # Development branch - create dev and staging tags
        TAGS_TO_CREATE+=("v${PROJECT_VERSION}-dev")
        TAGS_TO_CREATE+=("v${PROJECT_VERSION}-staging")
        echo "Creating development tags"
      elif [[ "$CI_COMMIT_BRANCH" =~ ^feature/ ]]; then
        # Feature branch - create feature, dev-preview, and candidate tags
        FEATURE_NAME=$(echo "$CI_COMMIT_BRANCH" | sed 's/^feature\///' | sed 's/[^a-zA-Z0-9-]/-/g')
        TAGS_TO_CREATE+=("v${PROJECT_VERSION}-feature-${FEATURE_NAME}")
        TAGS_TO_CREATE+=("v${PROJECT_VERSION}-dev-${FEATURE_NAME}")
        TAGS_TO_CREATE+=("v${PROJECT_VERSION}-rc-${FEATURE_NAME}")
        echo "Creating feature branch tags for: $FEATURE_NAME"
      else
        echo "Release only runs on main, development, or feature branches"
        exit 0
      fi
    - |
      # Configure git with token authentication
      git config --global user.email "ci@ossa.dev"
      git config --global user.name "OSSA CI"

      # Create and push each tag
      for TAG_NAME in "${TAGS_TO_CREATE[@]}"; do
        echo "üìå Checking tag: $TAG_NAME"

        # Fetch existing tags and check if tag already exists
        git fetch --tags origin || true
        if git tag -l | grep -q "^${TAG_NAME}$"; then
          echo "‚ö†Ô∏è Tag $TAG_NAME already exists, skipping creation"
          continue
        fi

        echo "‚ú® Creating new tag: $TAG_NAME"

        # Create tag with descriptive message
        git tag -a "$TAG_NAME" -m "OSSA Release $TAG_NAME

        Branch: ${CI_COMMIT_BRANCH}
        Version: ${OSSA_VERSION}
        Features:
        - Agent specification v${OSSA_VERSION}
        - Complete API documentation
        - Production-ready Docker infrastructure
        - GitLab Pages documentation site

        Built from commit: ${CI_COMMIT_SHA}"

        # Push tag using token if available, fallback to default
        if [ -n "$GITLAB_TOKEN" ]; then
          echo "Using GITLAB_TOKEN for authentication"
          git push https://oauth2:${GITLAB_TOKEN}@gitlab.bluefly.io/llm/openapi-ai-agents-standard.git "$TAG_NAME"
        else
          echo "Using default CI authentication"
          git push origin "$TAG_NAME"
        fi

        echo "‚úÖ Tag $TAG_NAME created and pushed"
      done

      echo "üéâ All tags created successfully:"
      for TAG in "${TAGS_TO_CREATE[@]}"; do
        echo "  - $TAG"
      done
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_success
    - if: $CI_COMMIT_BRANCH =~ /^feature\//
      when: on_success
  allow_failure: false

# Only run on specific branches during TDD phases
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "__REBUILD"
    - if: $CI_COMMIT_BRANCH =~ /^feature\//
    - if: $CI_COMMIT_BRANCH =~ /^fix\//
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "pages"
    - if: $CI_COMMIT_TAG