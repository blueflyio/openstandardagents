#!/usr/bin/env node

/**
 * Postinstall Hook - Automatic Agent Migration
 *
 * Runs after `npm install` or `npm update` to help users migrate
 * their agent manifests to the latest OSSA schema version.
 *
 * IMPORTANT: Non-intrusive - only shows message, doesn't auto-migrate
 */

import { existsSync } from 'fs';
import { join } from 'path';
import { execSync } from 'child_process';

// Detect if we're being installed in a user's project (not the package itself)
const isUserProject = () => {
  const cwd = process.cwd();
  const packageJsonPath = join(cwd, 'package.json');

  if (!existsSync(packageJsonPath)) {
    return false;
  }

  try {
    const pkgContent = existsSync(packageJsonPath) ?
      await import('file://' + packageJsonPath, { assert: { type: 'json' } }) : null;
    if (!pkgContent) return false;
    const pkg = pkgContent.default;
    // If package.json name is our package, we're inside the package itself
    return pkg.name !== '@bluefly/openstandardagents';
  } catch {
    return false;
  }
};

// Check if there are likely agent manifests in the project
const hasAgentManifests = () => {
  try {
    const result = execSync(
      'find . -name "*.ossa.yaml" -o -name "*.ossa.yml" -o -name "*.ossa.json" 2>/dev/null | head -1',
      { encoding: 'utf-8', stdio: ['pipe', 'pipe', 'ignore'] }
    ).trim();
    return result.length > 0;
  } catch {
    return false;
  }
};

// Main
(async () => {
  if (await isUserProject() && hasAgentManifests()) {
    console.log('\nðŸ“¦ @bluefly/openstandardagents updated!');
    console.log('\nðŸ”„ Agent manifests detected in your project.');
    console.log(
      '   To migrate to the latest schema version, run:\n'
    );
    console.log('   npx ossa-dev migrate agents --dry-run');
    console.log('   npx ossa-dev migrate agents\n');
  }
})();
