<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSSA Development Server</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: #1e1e1e;
        color: #d4d4d4;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: #252526;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 8px;
        border-left: 4px solid #4ec9b0;
      }

      h1 {
        color: #4ec9b0;
        font-size: 28px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #4ec9b0;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .subtitle {
        color: #858585;
        font-size: 14px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: #252526;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #3794ff;
      }

      .card h2 {
        color: #4ec9b0;
        font-size: 18px;
        margin-bottom: 15px;
      }

      .stat {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #333;
      }

      .stat:last-child {
        border-bottom: none;
      }

      .stat-label {
        color: #858585;
      }

      .stat-value {
        color: #d4d4d4;
        font-weight: 600;
      }

      .events {
        background: #252526;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #dcdcaa;
        max-height: 600px;
        overflow-y: auto;
      }

      .events h2 {
        color: #4ec9b0;
        font-size: 18px;
        margin-bottom: 15px;
        position: sticky;
        top: 0;
        background: #252526;
        padding-bottom: 10px;
      }

      .event {
        background: #2d2d2d;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 4px solid #3794ff;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .event.validation-success {
        border-left-color: #4ec9b0;
      }

      .event.validation-error {
        border-left-color: #f48771;
      }

      .event.file-change {
        border-left-color: #dcdcaa;
      }

      .event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .event-type {
        font-weight: 600;
        color: #4ec9b0;
        font-size: 14px;
        text-transform: uppercase;
      }

      .event-time {
        font-size: 12px;
        color: #858585;
      }

      .event-body {
        color: #d4d4d4;
        font-size: 14px;
      }

      .event-details {
        background: #1e1e1e;
        padding: 10px;
        margin-top: 10px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        overflow-x: auto;
      }

      .error-list {
        margin-top: 10px;
      }

      .error-item {
        padding: 5px 0;
        color: #f48771;
      }

      .warning-item {
        padding: 5px 0;
        color: #dcdcaa;
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
      }

      .badge-success {
        background: #1e3a1e;
        color: #4ec9b0;
      }

      .badge-error {
        background: #3a1e1e;
        color: #f48771;
      }

      .badge-warning {
        background: #3a351e;
        color: #dcdcaa;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #858585;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #1e1e1e;
      }

      ::-webkit-scrollbar-thumb {
        background: #3e3e42;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #4e4e52;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          <span class="status-indicator" id="connectionStatus"></span>
          üöÄ OSSA Development Server
        </h1>
        <p class="subtitle" id="connectionText">Connecting to WebSocket...</p>
      </header>

      <div class="grid">
        <div class="card">
          <h2>üìä Server Statistics</h2>
          <div class="stat">
            <span class="stat-label">Watched Files</span>
            <span class="stat-value" id="watchedFiles">-</span>
          </div>
          <div class="stat">
            <span class="stat-label">File Changes</span>
            <span class="stat-value" id="fileChanges">0</span>
          </div>
          <div class="stat">
            <span class="stat-label">Validations</span>
            <span class="stat-value" id="validations">0</span>
          </div>
          <div class="stat">
            <span class="stat-label">Connected Clients</span>
            <span class="stat-value" id="clients">1</span>
          </div>
        </div>

        <div class="card">
          <h2>üìÑ Latest Validation</h2>
          <div id="latestValidation" class="empty-state">
            Waiting for file changes...
          </div>
        </div>
      </div>

      <div class="events">
        <h2>üì° Real-time Events</h2>
        <div id="eventsList">
          <div class="empty-state">
            Watching for changes... Edit your manifest files to see live
            updates.
          </div>
        </div>
      </div>
    </div>

    <script>
      const ws = new WebSocket('ws://' + window.location.host + '/ws');
      const eventsList = document.getElementById('eventsList');
      const connectionStatus = document.getElementById('connectionStatus');
      const connectionText = document.getElementById('connectionText');

      let stats = {
        fileChanges: 0,
        validations: 0,
        clients: 1,
        watchedFiles: 0,
      };

      ws.onopen = () => {
        connectionStatus.style.background = '#4ec9b0';
        connectionText.textContent = 'Connected ‚Ä¢ Watching for changes';
        clearEmptyState();
      };

      ws.onclose = () => {
        connectionStatus.style.background = '#f48771';
        connectionStatus.style.animation = 'none';
        connectionText.textContent = 'Disconnected ‚Ä¢ Reconnecting...';
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };

      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleMessage(message);
      };

      function handleMessage(message) {
        switch (message.type) {
          case 'connected':
            stats.watchedFiles = message.data.watchedFiles?.length || 0;
            updateStats();
            addConnectedEvent(message);
            break;

          case 'file_change':
            stats.fileChanges++;
            updateStats();
            addFileChangeEvent(message);
            break;

          case 'validation':
            stats.validations++;
            updateStats();
            addValidationEvent(message);
            updateLatestValidation(message.data.result);
            break;

          case 'reload':
            addReloadEvent(message);
            break;

          case 'error':
            addErrorEvent(message);
            break;
        }
      }

      function updateStats() {
        document.getElementById('fileChanges').textContent = stats.fileChanges;
        document.getElementById('validations').textContent = stats.validations;
        document.getElementById('clients').textContent = stats.clients;
        document.getElementById('watchedFiles').textContent =
          stats.watchedFiles;
      }

      function updateLatestValidation(result) {
        const container = document.getElementById('latestValidation');

        if (result.valid) {
          container.innerHTML = `
          <div style="color: #4ec9b0; font-weight: 600; margin-bottom: 5px;">
            ‚úÖ Valid
            <span class="badge badge-success">${result.duration}ms</span>
          </div>
          <div style="color: #858585; font-size: 13px;">
            ${result.filePath.split('/').pop()}
          </div>
          ${
            result.warnings.length > 0
              ? `
            <div style="margin-top: 10px;">
              <span class="badge badge-warning">${result.warnings.length} warning(s)</span>
            </div>
          `
              : ''
          }
        `;
        } else {
          container.innerHTML = `
          <div style="color: #f48771; font-weight: 600; margin-bottom: 5px;">
            ‚ùå Invalid
            <span class="badge badge-error">${result.errors.length} error(s)</span>
          </div>
          <div style="color: #858585; font-size: 13px; margin-bottom: 10px;">
            ${result.filePath.split('/').pop()}
          </div>
          <div class="error-list">
            ${result.errors
              .slice(0, 3)
              .map(
                (err) =>
                  `<div class="error-item">‚Ä¢ ${err.message}${err.line ? ` (line ${err.line})` : ''}</div>`
              )
              .join('')}
            ${result.errors.length > 3 ? `<div style="color: #858585; margin-top: 5px;">... and ${result.errors.length - 3} more</div>` : ''}
          </div>
        `;
        }
      }

      function clearEmptyState() {
        const empty = eventsList.querySelector('.empty-state');
        if (empty) {
          empty.remove();
        }
      }

      function addEvent(type, title, body, cssClass = '') {
        clearEmptyState();

        const event = document.createElement('div');
        event.className = `event ${cssClass}`;
        event.innerHTML = `
        <div class="event-header">
          <span class="event-type">${type}</span>
          <span class="event-time">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="event-body">
          ${title}
        </div>
        ${body ? `<div class="event-details">${body}</div>` : ''}
      `;

        eventsList.insertBefore(event, eventsList.firstChild);

        // Keep only last 50 events
        while (eventsList.children.length > 50) {
          eventsList.removeChild(eventsList.lastChild);
        }
      }

      function addConnectedEvent(message) {
        addEvent(
          'üîå Connected',
          `Server version ${message.data.serverVersion}`,
          `Watching ${message.data.watchedFiles?.length || 0} file(s)`,
          'file-change'
        );
      }

      function addFileChangeEvent(message) {
        const event = message.data.event;
        const fileName = event.path.split('/').pop();
        const emoji =
          event.type === 'add' ? '‚ûï' : event.type === 'change' ? '‚úèÔ∏è' : '‚ûñ';

        addEvent(
          `${emoji} File ${event.type}`,
          fileName,
          event.path,
          'file-change'
        );
      }

      function addValidationEvent(message) {
        const result = message.data.result;
        const fileName = result.filePath.split('/').pop();

        if (result.valid) {
          const warnings =
            result.warnings.length > 0
              ? `<span class="badge badge-warning">${result.warnings.length} warning(s)</span>`
              : '';

          addEvent(
            '‚úÖ Validation Success',
            `${fileName} <span class="badge badge-success">${result.duration}ms</span> ${warnings}`,
            result.warnings.length > 0
              ? result.warnings.map((w) => `‚ö†Ô∏è  ${w.message}`).join('\n')
              : null,
            'validation-success'
          );
        } else {
          const errorList = result.errors
            .slice(0, 5)
            .map(
              (err) =>
                `‚ùå ${err.message}${err.line ? ` (line ${err.line})` : ''}`
            )
            .join('\n');

          const more =
            result.errors.length > 5
              ? `\n... and ${result.errors.length - 5} more errors`
              : '';

          addEvent(
            '‚ùå Validation Failed',
            `${fileName} <span class="badge badge-error">${result.errors.length} error(s)</span>`,
            errorList + more,
            'validation-error'
          );
        }
      }

      function addReloadEvent(message) {
        const fileName = message.data.filePath.split('/').pop();
        addEvent(
          'üîÑ Reload',
          `${fileName} - ${message.data.reason}`,
          null,
          'file-change'
        );
      }

      function addErrorEvent(message) {
        addEvent(
          'üö® Error',
          message.data.message,
          message.data.details
            ? JSON.stringify(message.data.details, null, 2)
            : null,
          'validation-error'
        );
      }
    </script>
  </body>
</html>
