openapi: 3.1.0
info:
  title: OSSA Agent Audit API
  version: 1.0.0
  description: API for auditing and fixing OSSA agent compliance

servers:
  - url: http://localhost:3000/api/v1
    description: Local OSSA server

paths:
  /audit/repositories:
    post:
      summary: Audit multiple repositories for OSSA compliance
      operationId: auditRepositories
      tags: [Audit]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [repositories]
              properties:
                repositories:
                  type: array
                  items:
                    type: string
                    description: Repository path
                  example:
                    - /Users/flux423/Sites/LLM/common_npm/agent-brain
                    - /Users/flux423/Sites/LLM/common_npm/agent-chat
                deep:
                  type: boolean
                  default: true
                  description: Perform deep validation of agent files
      responses:
        200:
          description: Audit results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditReport'

  /audit/repository/{path}:
    get:
      summary: Audit single repository
      operationId: auditRepository
      tags: [Audit]
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: Repository audit results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RepositoryAudit'

  /audit/agent:
    post:
      summary: Audit individual agent
      operationId: auditAgent
      tags: [Audit]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [path]
              properties:
                path:
                  type: string
                  description: Path to agent directory
      responses:
        200:
          description: Agent audit results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentAudit'

  /fix/agent:
    post:
      summary: Fix agent compliance issues
      operationId: fixAgent
      tags: [Fix]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [agentPath, issues]
              properties:
                agentPath:
                  type: string
                issues:
                  type: array
                  items:
                    $ref: '#/components/schemas/ComplianceIssue'
                options:
                  $ref: '#/components/schemas/FixOptions'
      responses:
        200:
          description: Fix results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FixResult'

  /fix/batch:
    post:
      summary: Batch fix multiple agents
      operationId: batchFix
      tags: [Fix]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [fixes]
              properties:
                fixes:
                  type: array
                  items:
                    type: object
                    required: [agentPath, issues]
                    properties:
                      agentPath:
                        type: string
                      issues:
                        type: array
                        items:
                          $ref: '#/components/schemas/ComplianceIssue'
                options:
                  $ref: '#/components/schemas/FixOptions'
      responses:
        200:
          description: Batch fix results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/FixResult'
                  summary:
                    $ref: '#/components/schemas/FixSummary'

  /generate/agent-files:
    post:
      summary: Generate missing agent files
      operationId: generateAgentFiles
      tags: [Generate]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [agentPath, agentName, category]
              properties:
                agentPath:
                  type: string
                agentName:
                  type: string
                category:
                  $ref: '#/components/schemas/TaxonomyCategory'
                description:
                  type: string
                version:
                  type: string
                  default: '0.1.0'
                files:
                  type: array
                  items:
                    type: string
                    enum: [agent.yml, openapi.yaml, README.md]
                  default: [agent.yml, openapi.yaml, README.md]
      responses:
        201:
          description: Files generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateResult'

components:
  schemas:
    TaxonomyCategory:
      type: string
      enum:
        - critics
        - governors
        - integrators
        - judges
        - monitors
        - orchestrators
        - trainers
        - voice
        - workers

    AuditReport:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        repositories:
          type: array
          items:
            $ref: '#/components/schemas/RepositoryAudit'
        summary:
          type: object
          properties:
            totalRepositories:
              type: integer
            totalAgents:
              type: integer
            compliantAgents:
              type: integer
            nonCompliantAgents:
              type: integer
            missingFiles:
              type: integer
            invalidConfigurations:
              type: integer

    RepositoryAudit:
      type: object
      properties:
        path:
          type: string
        name:
          type: string
        hasAgentsDirectory:
          type: boolean
        agents:
          type: array
          items:
            $ref: '#/components/schemas/AgentAudit'
        compliance:
          type: object
          properties:
            score:
              type: number
              minimum: 0
              maximum: 100
            compliant:
              type: boolean
            issues:
              type: array
              items:
                $ref: '#/components/schemas/ComplianceIssue'

    AgentAudit:
      type: object
      properties:
        path:
          type: string
        name:
          type: string
        category:
          $ref: '#/components/schemas/TaxonomyCategory'
        exists:
          type: boolean
        files:
          type: object
          properties:
            hasAgentYml:
              type: boolean
            hasOpenApiYaml:
              type: boolean
            hasReadme:
              type: boolean
        validation:
          type: object
          properties:
            agentYmlValid:
              type: boolean
            openApiValid:
              type: boolean
            categoryCorrect:
              type: boolean
        issues:
          type: array
          items:
            $ref: '#/components/schemas/ComplianceIssue'
        fixable:
          type: boolean

    ComplianceIssue:
      type: object
      properties:
        type:
          type: string
          enum:
            - missing_file
            - invalid_yaml
            - wrong_category
            - missing_field
            - invalid_openapi
            - no_description
        severity:
          type: string
          enum: [error, warning, info]
        file:
          type: string
        message:
          type: string
        fixable:
          type: boolean

    FixOptions:
      type: object
      properties:
        createMissing:
          type: boolean
          default: true
        updateCategory:
          type: boolean
          default: true
        generateOpenApi:
          type: boolean
          default: true
        generateReadme:
          type: boolean
          default: true
        useTemplate:
          type: string
          enum: [basic, advanced, ml, integration]
          default: basic

    FixResult:
      type: object
      properties:
        agentPath:
          type: string
        success:
          type: boolean
        filesCreated:
          type: array
          items:
            type: string
        filesUpdated:
          type: array
          items:
            type: string
        errors:
          type: array
          items:
            type: string

    FixSummary:
      type: object
      properties:
        totalAgents:
          type: integer
        successful:
          type: integer
        failed:
          type: integer
        filesCreated:
          type: integer
        filesUpdated:
          type: integer

    GenerateResult:
      type: object
      properties:
        success:
          type: boolean
        files:
          type: object
          properties:
            agentYml:
              type: object
              properties:
                created:
                  type: boolean
                path:
                  type: string
            openApiYaml:
              type: object
              properties:
                created:
                  type: boolean
                path:
                  type: string
            readme:
              type: object
              properties:
                created:
                  type: boolean
                path:
                  type: string
        message:
          type: string