#!/bin/bash
# OSSA Master CRUD Command
# Unified interface for all OSSA operations

set -e

# Configuration
OSSA_DIR="/Users/flux423/Sites/LLM/OSSA"
SCRIPTS_DIR="$OSSA_DIR/scripts"
INFRASTRUCTURE_DIR="$OSSA_DIR/infrastructure"

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Main command router
RESOURCE=${1:-help}
ACTION=${2:-help}
shift 2 2>/dev/null || true
OPTIONS=$@

case $RESOURCE in
    # ===== DOCUMENTATION MANAGEMENT =====
    docs|documentation)
        case $ACTION in
            create|organize)
                echo -e "${BLUE}üìö Creating organized documentation structure...${NC}"
                bash "$SCRIPTS_DIR/organize-docs.sh"
                ;;
            read|status)
                echo -e "${CYAN}üìä Reading documentation status...${NC}"
                bash "$SCRIPTS_DIR/docs-safe-reorg.sh" status
                ;;
            update|generate)
                echo -e "${YELLOW}üîÑ Updating documentation...${NC}"
                bash "$SCRIPTS_DIR/generate-api-docs.sh"
                ;;
            delete|archive)
                echo -e "${RED}üì¶ Archiving old documentation...${NC}"
                bash "$SCRIPTS_DIR/docs-safe-reorg.sh" archive
                ;;
            pipeline)
                echo -e "${BLUE}üöÄ Running full documentation pipeline...${NC}"
                bash "$SCRIPTS_DIR/docs-pipeline.sh" all
                ;;
            *)
                echo "Usage: $0 docs <create|read|update|delete|pipeline>"
                ;;
        esac
        ;;
    
    # ===== API PORTAL MANAGEMENT =====
    api|portal)
        case $ACTION in
            create|start)
                echo -e "${BLUE}üöÄ Creating API portal...${NC}"
                docker-compose -f "$INFRASTRUCTURE_DIR/docker/docker-compose.openapi.yml" -p "ossa-openapi" up -d
                echo -e "${GREEN}‚úÖ API Portal available at:${NC}"
                echo "  Swagger UI: http://localhost:8080"
                echo "  Redocly: http://localhost:8081"
                echo "  Portal: http://localhost:8082"
                ;;
            read|status)
                echo -e "${CYAN}üìä Reading API portal status...${NC}"
                docker-compose -f "$INFRASTRUCTURE_DIR/docker/docker-compose.openapi.yml" -p "ossa-openapi" ps
                ;;
            update|restart)
                echo -e "${YELLOW}üîÑ Updating API portal...${NC}"
                docker-compose -f "$INFRASTRUCTURE_DIR/docker/docker-compose.openapi.yml" -p "ossa-openapi" restart
                ;;
            delete|stop)
                echo -e "${RED}üõë Deleting API portal...${NC}"
                docker-compose -f "$INFRASTRUCTURE_DIR/docker/docker-compose.openapi.yml" -p "ossa-openapi" down
                ;;
            *)
                echo "Usage: $0 api <create|read|update|delete>"
                ;;
        esac
        ;;
    
    # ===== FEDERATED NETWORK MANAGEMENT =====
    federated|network)
        case $ACTION in
            create|launch)
                echo -e "${BLUE}üåê Creating federated network...${NC}"
                bash "$SCRIPTS_DIR/launch-federated-network.sh"
                ;;
            read|monitor)
                echo -e "${CYAN}üìä Reading federated network status...${NC}"
                bash "$SCRIPTS_DIR/monitor-activation.sh"
                ;;
            update|activate)
                echo -e "${YELLOW}üîÑ Updating federated network...${NC}"
                npx tsx "$SCRIPTS_DIR/activate-federated-learning.ts"
                ;;
            delete|stop)
                echo -e "${RED}üõë Stopping federated network...${NC}"
                pkill -f "launch-federated-network" || true
                echo "Federated network stopped"
                ;;
            *)
                echo "Usage: $0 federated <create|read|update|delete>"
                ;;
        esac
        ;;
    
    # ===== QDRANT VECTOR DB MANAGEMENT =====
    qdrant|vector)
        case $ACTION in
            create|activate)
                echo -e "${BLUE}üß† Creating Qdrant connection...${NC}"
                npx tsx "$SCRIPTS_DIR/activate-with-existing-qdrant.ts"
                ;;
            read|status)
                echo -e "${CYAN}üìä Reading Qdrant status...${NC}"
                curl -s http://localhost:6333/collections || echo "Qdrant not accessible"
                ;;
            update|sync)
                echo -e "${YELLOW}üîÑ Updating Qdrant vectors...${NC}"
                npx tsx "$SCRIPTS_DIR/vortex-federated-integration.ts"
                ;;
            delete|clear)
                echo -e "${RED}üóëÔ∏è Clearing Qdrant collections...${NC}"
                echo "Warning: This will delete all collections. Confirm? (y/n)"
                read -r confirm
                [ "$confirm" = "y" ] && curl -X DELETE http://localhost:6333/collections/*
                ;;
            *)
                echo "Usage: $0 qdrant <create|read|update|delete>"
                ;;
        esac
        ;;
    
    # ===== VALIDATION MANAGEMENT =====
    validate|validation)
        case $ACTION in
            create|run)
                echo -e "${BLUE}‚úÖ Running validations...${NC}"
                npx tsx "$SCRIPTS_DIR/validate-golden.ts"
                node "$SCRIPTS_DIR/validate-schemas.cjs"
                ;;
            read|status)
                echo -e "${CYAN}üìä Reading validation status...${NC}"
                npx tsx "$SCRIPTS_DIR/validate-golden.ts" --status
                ;;
            update|fix)
                echo -e "${YELLOW}üîß Fixing validation issues...${NC}"
                npx tsx "$SCRIPTS_DIR/validate-golden.ts" --fix
                ;;
            delete|reset)
                echo -e "${RED}üîÑ Resetting validation state...${NC}"
                rm -f "$OSSA_DIR/.validation-cache" 2>/dev/null
                echo "Validation cache cleared"
                ;;
            *)
                echo "Usage: $0 validate <create|read|update|delete>"
                ;;
        esac
        ;;
    
    # ===== PROJECT STANDARDIZATION =====
    standardize|projects)
        case $ACTION in
            create|run)
                echo -e "${BLUE}üìê Standardizing all projects...${NC}"
                bash "$SCRIPTS_DIR/standardize-all-projects.sh"
                ;;
            read|status)
                echo -e "${CYAN}üìä Reading standardization status...${NC}"
                bash "$SCRIPTS_DIR/standardize-all-projects.sh" --status
                ;;
            update|sync)
                echo -e "${YELLOW}üîÑ Updating project standards...${NC}"
                bash "$SCRIPTS_DIR/standardize-all-projects.sh" --update
                ;;
            delete|revert)
                echo -e "${RED}‚Ü©Ô∏è Reverting standardization...${NC}"
                echo "Warning: This will revert changes. Confirm? (y/n)"
                read -r confirm
                [ "$confirm" = "y" ] && git checkout -- .
                ;;
            *)
                echo "Usage: $0 standardize <create|read|update|delete>"
                ;;
        esac
        ;;
    
    # ===== HELP AND DEFAULT =====
    help|--help|-h|*)
        cat <<EOF
${BOLD}OSSA Master CRUD Command${NC}
=========================

Usage: $0 <resource> <action> [options]

${CYAN}Resources & Actions:${NC}

${BOLD}Documentation Management${NC}
  $0 docs create      # Organize documentation structure
  $0 docs read        # Check documentation status
  $0 docs update      # Generate API documentation
  $0 docs delete      # Archive old documentation
  $0 docs pipeline    # Run full documentation pipeline

${BOLD}API Portal Management${NC}
  $0 api create       # Start API documentation portal
  $0 api read         # Check portal status
  $0 api update       # Restart portal services
  $0 api delete       # Stop portal services

${BOLD}Federated Network${NC}
  $0 federated create # Launch federated network
  $0 federated read   # Monitor network status
  $0 federated update # Activate federated learning
  $0 federated delete # Stop federated network

${BOLD}Qdrant Vector DB${NC}
  $0 qdrant create    # Activate Qdrant connection
  $0 qdrant read      # Check Qdrant status
  $0 qdrant update    # Sync vector embeddings
  $0 qdrant delete    # Clear collections

${BOLD}Validation${NC}
  $0 validate create  # Run all validations
  $0 validate read    # Check validation status
  $0 validate update  # Fix validation issues
  $0 validate delete  # Reset validation cache

${BOLD}Project Standardization${NC}
  $0 standardize create  # Standardize all projects
  $0 standardize read    # Check standardization status
  $0 standardize update  # Update standards
  $0 standardize delete  # Revert standardization

${CYAN}Quick Examples:${NC}
  $0 api create           # Start API portal
  $0 docs pipeline        # Full docs generation
  $0 federated create     # Launch federated network
  $0 validate run         # Run all validations

${CYAN}Aliases:${NC}
  ‚Ä¢ create = start, launch, run
  ‚Ä¢ read = status, monitor, check
  ‚Ä¢ update = restart, sync, fix
  ‚Ä¢ delete = stop, clear, revert

EOF
        ;;
esac