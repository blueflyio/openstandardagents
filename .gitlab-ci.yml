# GitLab CI/CD Pipeline for OSSA Specification
# Standard pipeline without custom components

stages:
  - validate
  - test
  - build
  - deploy
  - release

variables:
  NODE_VERSION: "20"
  OSSA_VERSION: "0.2.0"

# Validate OpenAPI specifications
validate:openapi:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "Validating OSSA OpenAPI specifications..."
    - npm install -g @redocly/cli
    - redocly lint openapi/**/*.yaml || true
  allow_failure: true

# Validate JSON schemas
validate:schemas:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "Validating OSSA JSON schemas..."
    - npm install
    - npm run validate:examples || true
  artifacts:
    reports:
      junit: test-results.xml
    paths:
      - test-results.xml
  allow_failure: true

# Run tests
test:unit:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - echo "Running OSSA specification tests..."
    - npm install
    - npm run test || true
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: junit.xml
    paths:
      - coverage/
  allow_failure: true

# Build documentation
build:docs:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - echo "Building OSSA documentation..."
    - npm install -g @redocly/cli
    - mkdir -p public/api
    - |
      for spec in openapi/**/*.yaml; do
        if [ -f "$spec" ]; then
          filename=$(basename "$spec" .yaml)
          echo "Generating docs for $filename..."
          redocly build-docs "$spec" -o "public/api/${filename}.html" || true
        fi
      done
  artifacts:
    paths:
      - public/
    expire_in: 1 week

# Deploy to GitLab Pages
pages:
  stage: deploy
  dependencies:
    - build:docs
  script:
    - echo "Deploying OSSA documentation to GitLab Pages..."
    - ls -la public/
  artifacts:
    paths:
      - public
  only:
    - main
    - development

# Create release tag
release:tag:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating OSSA v${OSSA_VERSION} release..."
  release:
    tag_name: "v${OSSA_VERSION}"
    description: "OSSA Specification v${OSSA_VERSION} - The OpenAPI for AI Agents"
  only:
    - main
  when: manual

# Lint code
lint:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "Linting OSSA codebase..."
    - npm install
    - npm run lint || true
  allow_failure: true
