# =============================================================================
# OSSA Specification CI/CD Pipeline - GitLab Ultimate Optimized
# =============================================================================
# Open Standard for Software Agents (OSSA) - JSON Schema Specification
#
# OPTIMIZATION FEATURES:
# - GitLab Ultimate security scanning (SAST, Dependency Scanning, Secret Detection)
# - Intelligent caching (npm, build artifacts, test results)
# - Conditional execution by pipeline type (feature push vs MR vs release)
# - Build once, use everywhere (artifact reuse)
# - Merge train optimization (skip heavy tests)
# - Parallel execution for independent jobs
#
# PIPELINE TYPES:
# - Feature branch push: Quick validation (2-3 min)
# - MR pipeline: Full tests + security (6-8 min)
# - Merge train: Quick validation (3-4 min)
# - Release/main: Full suite + security + release (10-12 min)
# =============================================================================

include:
  # ============================================================================
  # GitLab Ultimate Security Templates (FREE with Ultimate)
  # ============================================================================
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/SAST-IaC.gitlab-ci.yml
  - template: Code-Quality.gitlab-ci.yml

  # ============================================================================
  # Local CI Configuration Files (Organized by Concern)
  # ============================================================================
  - local: .gitlab/ci/caching.yml
  - local: .gitlab/ci/build-jobs.yml
  - local: .gitlab/ci/validation-jobs.yml
  - local: .gitlab/ci/optimized-test-jobs.yml
  - local: .gitlab/ci/security-jobs.yml
  - local: .gitlab/ci/quality-gates.yml
  - local: .gitlab/ci/release-workflow.yml
  - local: .gitlab/ci/merge-train-optimized.yml

# =============================================================================
# PIPELINE STAGES
# =============================================================================
stages:
  - .pre          # Setup, caching preparation
  - validate      # Quick validation (schema, lint, typecheck)
  - build         # TypeScript compilation (build once, use everywhere)
  - test          # Unit, integration, e2e tests
  - security      # SAST, Dependency Scanning, Secret Detection
  - quality       # Code quality gates
  - release       # Semantic release, npm publish
  - .post         # Cleanup, notifications, dev tags

# =============================================================================
# GLOBAL VARIABLES
# =============================================================================
variables:
  NODE_VERSION: "22.14"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: fast
  CACHE_COMPRESSION_LEVEL: fast

# =============================================================================
# VALIDATION JOBS (Quick checks - run early)
# =============================================================================

validate:schema:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  extends:
    - .npm-cache-readonly
  before_script:
    - npm ci --prefer-offline --no-audit
  script:
    - echo "Validating OSSA JSON Schema..."
    - npm run validate:schema
    - echo "Schema compiles successfully"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release\//
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH !~ /^(main|release)/
      when: on_success  # Quick check on feature branches too

validate:examples:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  extends:
    - .npm-cache-readonly
  before_script:
    - npm ci --prefer-offline --no-audit
  script:
    - echo "Validating example manifests..."
    - npm run validate:examples || echo "Some examples need fixes - see issues"
    - echo "Example validation complete"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release\//
    - if: $CI_COMMIT_BRANCH == "main"

validate:ossa-templates:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  extends:
    - .npm-cache-readonly
  before_script:
    - npm ci --prefer-offline --no-audit
  script:
    - echo "Validating OSSA template manifests..."
    - |
      for f in examples/ossa-templates/*.ossa.yaml; do
        echo "Validating $f..."
        npx ajv-cli validate -s spec/v0.3.3/ossa-0.3.3.schema.json --strict=false --allow-union-types -d "$f"
      done
    - echo "All OSSA template examples valid"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release\//
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# RELEASE JOBS (Semantic Release)
# =============================================================================

release:semantic:
  stage: release
  image: node:${NODE_VERSION}
  tags:
    - saas-linux-small-amd64
  variables:
    GIT_AUTHOR_NAME: "OSSA Release Bot"
    GIT_AUTHOR_EMAIL: "release-bot@openstandardagents.org"
    GIT_COMMITTER_NAME: "OSSA Release Bot"
    GIT_COMMITTER_EMAIL: "release-bot@openstandardagents.org"
    GITLAB_TOKEN: ${GITLAB_PUSH_TOKEN}
  extends:
    - .npm-cache
  before_script:
    - npm ci
    - npm run build
    - |
      if [ -z "$NPM_TOKEN" ]; then
        echo "ERROR: NPM_TOKEN not set in CI/CD variables"
        echo "Add NPM_TOKEN in Settings > CI/CD > Variables"
        exit 1
      fi
      if [ -z "$GITLAB_PUSH_TOKEN" ]; then
        echo "ERROR: GITLAB_PUSH_TOKEN not set"
        exit 1
      fi
      echo "Required tokens configured"
  script:
    - echo "Running semantic-release..."
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
    - npx semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/ && $CI_PIPELINE_SOURCE == "push"
  environment:
    name: production
    url: https://www.npmjs.com/package/@bluefly/openstandardagents
