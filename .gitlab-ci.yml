# =============================================================================
# OSSA Specification CI/CD Pipeline - Using Golden Component
# =============================================================================
#
# Versioning Strategy (HARDENED GITLAB FLOW):
# - Feature ‚Üí release/v0.4.x: Auto-creates v0.4.0-dev.N tags (development env)
# - release/v0.4.x ‚Üí main: Auto-creates v0.4.0-rc.N tags (staging env)
# - Manual trigger on main: Creates v0.4.0 production release (production env)
#
# Publishing Strategy:
# - GitHub: Only main + release branches, only RC + production tags
# - npm: Only verified production releases (no RC, no dev)
# - GitLab Releases: Only production tags
# =============================================================================

include:
  # Golden component handles: validate, test, build, security
  - component: $CI_SERVER_FQDN/blueflyio/gitlab_components/golden@release/v0.1.x
    inputs:
      # Project configuration
      node_version: "22.14"
      project_type: "nodejs"

      # Enable standard features
      enable_comprehensive_testing: true
      enable_security_scanning: true
      enable_secrets_scan: true
      enable_dependency_scan: true
      enable_sast: true

      # Disable features we handle custom
      enable_tagging: false  # We handle custom dev/rc/production tagging
      enable_deployment: false
      enable_pages: false
      enable_npm_publish: false  # We handle manual npm publish

      # Coverage
      test_coverage_threshold: 80

# =============================================================================
# CUSTOM STAGES (Added to golden stages)
# =============================================================================
stages:
  - detect
  - validate
  - test
  - security
  - build
  - publish
  - heal
  - version  # Custom: dev/rc tagging
  - release  # Custom: production release
  - deploy   # Custom: npm publish

variables:
  NODE_VERSION: "22.14"
  GIT_DEPTH: 0  # Full history for versioning

# =============================================================================
# VERSION STAGE - Auto-Versioning with GitLab Environments
# =============================================================================

# Dev version: Feature merged to release/v0.4.x ‚Üí v0.4.0-dev.N
version:dev:
  stage: version
  image: node:${NODE_VERSION}
  extends: .base-runner
  environment:
    name: development
    deployment_tier: development
    action: prepare
  variables:
    GIT_AUTHOR_NAME: "OSSA Release Bot"
    GIT_AUTHOR_EMAIL: "release-bot@openstandardagents.org"
    GIT_COMMITTER_NAME: "OSSA Release Bot"
    GIT_COMMITTER_EMAIL: "release-bot@openstandardagents.org"
  before_script:
    - npm ci
    - git config user.name "${GIT_AUTHOR_NAME}"
    - git config user.email "${GIT_AUTHOR_EMAIL}"
  script:
    - echo "üè∑Ô∏è  Creating dev version tag..."
    - |
      # Get latest version from package.json
      CURRENT_VERSION=$(node -p "require('./package.json').version")

      # Get latest dev tag for this version
      LATEST_DEV=$(git tag -l "${CURRENT_VERSION}-dev.*" | sort -V | tail -1)

      if [ -z "$LATEST_DEV" ]; then
        DEV_NUMBER=1
      else
        DEV_NUMBER=$(echo $LATEST_DEV | grep -oP '(?<=-dev\.)\d+' || echo "0")
        DEV_NUMBER=$((DEV_NUMBER + 1))
      fi

      NEW_TAG="${CURRENT_VERSION}-dev.${DEV_NUMBER}"
      echo "Creating tag: $NEW_TAG"

      git tag -a "$NEW_TAG" -m "Development version $NEW_TAG"
      git push https://oauth2:${GITLAB_PUSH_TOKEN}@gitlab.com/blueflyio/ossa/openstandardagents.git "$NEW_TAG"

      echo "‚úÖ Created dev tag: $NEW_TAG"
      echo "üåç Environment: development"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release/ && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/

# RC version: release/v0.4.x merged to main ‚Üí v0.4.0-rc.N
version:rc:
  stage: version
  image: node:${NODE_VERSION}
  extends: .base-runner
  environment:
    name: staging
    deployment_tier: staging
    action: prepare
  variables:
    GIT_AUTHOR_NAME: "OSSA Release Bot"
    GIT_AUTHOR_EMAIL: "release-bot@openstandardagents.org"
    GIT_COMMITTER_NAME: "OSSA Release Bot"
    GIT_COMMITTER_EMAIL: "release-bot@openstandardagents.org"
  before_script:
    - npm ci
    - git config user.name "${GIT_AUTHOR_NAME}"
    - git config user.email "${GIT_AUTHOR_EMAIL}"
  script:
    - echo "üè∑Ô∏è  Creating RC version tag..."
    - |
      # Get latest version from package.json
      CURRENT_VERSION=$(node -p "require('./package.json').version")

      # Get latest RC tag for this version
      LATEST_RC=$(git tag -l "${CURRENT_VERSION}-rc.*" | sort -V | tail -1)

      if [ -z "$LATEST_RC" ]; then
        RC_NUMBER=1
      else
        RC_NUMBER=$(echo $LATEST_RC | grep -oP '(?<=-rc\.)\d+' || echo "0")
        RC_NUMBER=$((RC_NUMBER + 1))
      fi

      NEW_TAG="${CURRENT_VERSION}-rc.${RC_NUMBER}"
      echo "Creating RC tag: $NEW_TAG"

      git tag -a "$NEW_TAG" -m "Release candidate $NEW_TAG"
      git push https://oauth2:${GITLAB_PUSH_TOKEN}@gitlab.com/blueflyio/ossa/openstandardagents.git "$NEW_TAG"

      # Push RC tag to GitHub
      if [ -n "$GITHUB_TOKEN" ]; then
        git push https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git "$NEW_TAG"
        echo "‚úÖ Pushed RC tag to GitHub"
      fi

      echo "‚úÖ Created RC tag: $NEW_TAG"
      echo "üåç Environment: staging"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/

# =============================================================================
# RELEASE STAGE - Production Release (Manual Trigger with Button)
# =============================================================================

release:production:
  stage: release
  image: node:${NODE_VERSION}
  extends: .base-runner
  environment:
    name: production
    deployment_tier: production
    url: https://www.npmjs.com/package/@bluefly/openstandardagents
    action: start
  variables:
    GIT_AUTHOR_NAME: "OSSA Release Bot"
    GIT_AUTHOR_EMAIL: "release-bot@openstandardagents.org"
    GIT_COMMITTER_NAME: "OSSA Release Bot"
    GIT_COMMITTER_EMAIL: "release-bot@openstandardagents.org"
  before_script:
    - npm ci
    - npm run build
    - git config user.name "${GIT_AUTHOR_NAME}"
    - git config user.email "${GIT_AUTHOR_EMAIL}"
    - |
      # Validate required tokens
      if [ -z "$NPM_TOKEN" ]; then
        echo "‚ùå ERROR: NPM_TOKEN not set in CI/CD variables"
        exit 1
      fi
      if [ -z "$GITLAB_PUSH_TOKEN" ]; then
        echo "‚ùå ERROR: GITLAB_PUSH_TOKEN not set"
        exit 1
      fi
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "‚ùå ERROR: GITHUB_TOKEN not set"
        exit 1
      fi
      echo "‚úÖ Required tokens configured"
  script:
    - echo "üöÄ Running semantic-release for PRODUCTION..."
    - npx semantic-release
    - |
      # Get the new version
      NEW_VERSION=$(node -p "require('./package.json').version")
      echo "‚úÖ Released production version: v${NEW_VERSION}"

      # Sync main and release branches to GitHub
      echo "üì§ Syncing branches to GitHub..."
      git push https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git main:main
      git push https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git release/v0.4.x:release/v0.4.x

      # Push production tag to GitHub
      git push https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git "v${NEW_VERSION}"

      echo "‚úÖ Synced to GitHub: main, release/v0.4.x, v${NEW_VERSION}"
      echo "üåç Environment: production"
  when: manual
  only:
    - main
  artifacts:
    paths:
      - dist/*.tgz
    expire_in: 90 days

# =============================================================================
# DEPLOY STAGE - npm Publish + GitLab Release
# =============================================================================

deploy:npm:
  stage: deploy
  image: node:${NODE_VERSION}
  extends: .base-runner
  environment:
    name: production
    deployment_tier: production
    url: https://www.npmjs.com/package/@bluefly/openstandardagents
    action: start
  needs:
    - job: release:production
  before_script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
  script:
    - |
      VERSION=$(node -p "require('./package.json').version")
      echo "üì¶ Publishing to npm: v${VERSION}"

      npm publish --access public

      echo "‚úÖ Published to npm: @bluefly/openstandardagents@${VERSION}"
      echo "üìç https://www.npmjs.com/package/@bluefly/openstandardagents/v/${VERSION}"
  only:
    - main

deploy:gitlab-release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  extends: .base-runner
  needs:
    - job: release:production
      artifacts: true
    - job: deploy:npm
  script:
    - |
      VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
      echo "üìù Creating GitLab release for v${VERSION}..."
  release:
    tag_name: "v${VERSION}"
    name: "Release v${VERSION}"
    description: |
      ## OSSA v${VERSION}

      Open Standard for Software Agents

      See [CHANGELOG.md](https://gitlab.com/blueflyio/ossa/openstandardagents/-/blob/main/CHANGELOG.md) for full release notes.

      **Install:**
      ```bash
      npm install @bluefly/openstandardagents@${VERSION}
      ```

      **Links:**
      - [npm package](https://www.npmjs.com/package/@bluefly/openstandardagents/v/${VERSION})
      - [GitHub mirror](https://github.com/blueflyio/openstandardagents)
      - [Documentation](https://openstandardagents.org)
    assets:
      links:
        - name: "npm package"
          url: "https://www.npmjs.com/package/@bluefly/openstandardagents/v/${VERSION}"
  only:
    - main
