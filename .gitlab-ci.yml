# OSSA GitLab CI/CD Pipeline Configuration
# Production-ready CI/CD for OSSA Platform v1.0

# ==================== GOLDEN WORKFLOW INTEGRATION ====================
include:
  - component: gitlab.bluefly.io/llm/gitlab_components/workflow/golden@v0.1.0
    inputs:
      project_name: "OSSA"
      enable_auto_flow: true
      enable_comprehensive_testing: true
      enable_security_scanning: true
      test_coverage_threshold: 85
      enable_roadmap_sync: true
      enable_linear_integration: true

# ==================== WORKFLOW RULES ====================
workflow:
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "development"'
    - if: '$CI_COMMIT_TAG'
    - when: manual

# ==================== VARIABLES ====================
variables:
  # Versions
  NODE_VERSION: "20"
  OSSA_VERSION: "1.0"
  POSTGRES_VERSION: "14"

  # Docker Registry
  DOCKER_REGISTRY: "registry.gitlab.com/${CI_PROJECT_PATH}"
  OSSA_API_IMAGE: "${DOCKER_REGISTRY}/ossa-api:${CI_COMMIT_SHA}"
  OSSA_VALIDATOR_IMAGE: "${DOCKER_REGISTRY}/ossa-validator:${CI_COMMIT_SHA}"

  # Database
  POSTGRES_DB: "ossa_test"
  POSTGRES_USER: "ossa"
  POSTGRES_PASSWORD: "${CI_POSTGRES_PASSWORD}"
  DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}"

  # Conformance Levels
  BRONZE_COVERAGE: "50"
  SILVER_COVERAGE: "70"
  GOLD_COVERAGE: "85"
  PLATINUM_COVERAGE: "95"

  # Linear Integration
  LINEAR_API_KEY: "${CI_LINEAR_API_KEY}"
  LINEAR_TEAM_ID: "${CI_LINEAR_TEAM_ID}"

  # BuildKit Integration
  BUILDKIT_ENABLED: "true"

# ==================== STAGES ====================
stages:
  - prepare
  - validate
  - test
  - conformance
  - build
  - security
  - benchmark
  - deploy
  - monitor
  - roadmap
  - release

# ==================== TEMPLATES ====================

# Node.js job template
.node_template:
  image: node:${NODE_VERSION}-alpine
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
  before_script:
    - npm ci --prefer-offline

# Docker job template
.docker_template:
  image: docker:24-alpine
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# ==================== PREPARE STAGE ====================

install:dependencies:
  stage: prepare
  extends: .node_template
  script:
    - npm ci
    - npm run bootstrap || npm install
    - npm ls --depth=0
  artifacts:
    paths:
      - node_modules/
      - packages/*/node_modules/
    expire_in: 1 hour

# ==================== VALIDATE STAGE ====================

validate:ossa-schemas:
  stage: validate
  extends: .node_template
  needs: ["install:dependencies"]
  script:
    - echo "Validating OSSA v1.0 schemas..."
    - npx ajv compile -s packages/ossa-specification/schemas/v1.0/*.json
    - echo "‚úÖ Schema validation passed"
  artifacts:
    reports:
      junit: schema-validation.xml

validate:openapi:
  stage: validate
  extends: .node_template
  needs: ["install:dependencies"]
  script:
    - echo "Validating OpenAPI specifications..."
    - npx @redocly/cli lint packages/ossa-api/openapi.yaml
    - |
      for spec in examples/*/openapi.yaml; do
        echo "Validating $spec"
        npx @redocly/cli lint "$spec" || true
      done
  artifacts:
    paths:
      - openapi-validation-report.html

validate:agents:
  stage: validate
  extends: .node_template
  needs: ["install:dependencies"]
  script:
    - echo "Validating OSSA agents..."
    - |
      for agent in examples/*/agent.yml; do
        echo "Validating $(dirname $agent)"
        node packages/ossa-validator/dist/cli.js validate agent "$agent" || true
      done
  artifacts:
    paths:
      - agent-validation-report.json
    expire_in: 1 week

validate:roadmaps:
  stage: validate
  extends: .node_template
  needs: ["install:dependencies"]
  script:
    - echo "Validating OSSA roadmaps..."
    - npx ajv compile -s packages/ossa-specification/schemas/v1.0/roadmap.schema.json
    - echo "‚úÖ Roadmap schema validation passed"

# ==================== TEST STAGE ====================

test:unit:
  stage: test
  extends: .node_template
  needs: ["install:dependencies"]
  services:
    - postgres:${POSTGRES_VERSION}
  script:
    - npm run test:unit -- --coverage
    - npx nyc report --reporter=text
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: test-results/unit.xml
    paths:
      - coverage/
    expire_in: 1 week

test:integration:
  stage: test
  extends: .node_template
  needs: ["install:dependencies"]
  services:
    - postgres:${POSTGRES_VERSION}
    - redis:7-alpine
  script:
    - echo "Running database migrations..."
    - npx knex migrate:latest || true
    - echo "Running integration tests..."
    - npm run test:integration || true
  artifacts:
    reports:
      junit: test-results/integration.xml

test:api:
  stage: test
  extends: .node_template
  needs: ["install:dependencies", "validate:openapi"]
  services:
    - postgres:${POSTGRES_VERSION}
  script:
    - echo "Starting API server..."
    - npm run api:start &
    - sleep 5
    - echo "Testing API endpoints..."
    - npx newman run tests/postman/ossa-api.json || true
    - npx dredd packages/ossa-api/openapi.yaml http://localhost:3000 || true

test:bridges:
  stage: test
  extends: .node_template
  needs: ["install:dependencies"]
  parallel:
    matrix:
      - BRIDGE: [mcp, langchain, a2a, openapi]
  script:
    - echo "Testing ${BRIDGE} bridge..."
    - npm run test:bridge:${BRIDGE} || true

# ==================== CONFORMANCE STAGE ====================

conformance:bronze:
  stage: conformance
  extends: .node_template
  needs: ["test:unit", "validate:agents"]
  script:
    - echo "ü•â Testing Bronze conformance..."
    - node packages/ossa-validator/dist/cli.js conformance check --level bronze examples/minimal
  artifacts:
    paths:
      - conformance-bronze-report.json

conformance:silver:
  stage: conformance
  extends: .node_template
  needs: ["test:unit", "validate:agents"]
  script:
    - echo "ü•à Testing Silver conformance..."
    - node packages/ossa-validator/dist/cli.js conformance check --level silver examples/production
    - |
      COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
      if (( $(echo "$COVERAGE < $SILVER_COVERAGE" | bc -l) )); then
        echo "‚ö†Ô∏è Coverage $COVERAGE% is below Silver requirement of $SILVER_COVERAGE%"
      fi
  artifacts:
    paths:
      - conformance-silver-report.json

conformance:gold:
  stage: conformance
  extends: .node_template
  needs: ["conformance:silver", "test:bridges"]
  script:
    - echo "ü•á Testing Gold conformance..."
    - node packages/ossa-validator/dist/cli.js conformance check --level gold examples/enterprise
  artifacts:
    paths:
      - conformance-gold-report.json
  allow_failure: true

conformance:platinum:
  stage: conformance
  extends: .node_template
  needs: ["conformance:gold"]
  script:
    - echo "üíé Testing Platinum conformance..."
    - node packages/ossa-validator/dist/cli.js conformance check --level platinum examples/enterprise
  artifacts:
    paths:
      - conformance-platinum-report.json
  allow_failure: true

# ==================== BUILD STAGE ====================

build:packages:
  stage: build
  extends: .node_template
  needs: ["test:unit"]
  script:
    - npm run build:all || npm run build
    - echo "‚úÖ Packages built successfully"
  artifacts:
    paths:
      - packages/*/dist/
    expire_in: 1 week

build:docker:api:
  stage: build
  extends: .docker_template
  needs: ["build:packages"]
  script:
    - cd packages/ossa-api
    - |
      cat > Dockerfile << 'EOF'
      FROM node:20-alpine
      WORKDIR /app
      COPY package*.json ./
      RUN npm ci --production
      COPY dist/ ./dist/
      COPY database/ ./database/
      EXPOSE 3000
      CMD ["node", "dist/index.js"]
      EOF
    - docker build -t ${OSSA_API_IMAGE} .
    - docker push ${OSSA_API_IMAGE}
    - docker tag ${OSSA_API_IMAGE} ${DOCKER_REGISTRY}/ossa-api:latest
    - docker push ${DOCKER_REGISTRY}/ossa-api:latest

build:docker:validator:
  stage: build
  extends: .docker_template
  needs: ["build:packages"]
  script:
    - cd packages/ossa-validator
    - |
      cat > Dockerfile << 'EOF'
      FROM node:20-alpine
      WORKDIR /app
      COPY package*.json ./
      RUN npm ci --production
      COPY dist/ ./dist/
      ENTRYPOINT ["node", "dist/cli.js"]
      EOF
    - docker build -t ${OSSA_VALIDATOR_IMAGE} .
    - docker push ${OSSA_VALIDATOR_IMAGE}

# ==================== SECURITY STAGE ====================

security:dependencies:
  stage: security
  extends: .node_template
  needs: ["install:dependencies"]
  script:
    - npm audit --audit-level=moderate
    - npx snyk test || true
  allow_failure: true

security:sast:
  stage: security
  image: returntocorp/semgrep
  script:
    - semgrep --config=auto --json -o sast-report.json .
  artifacts:
    reports:
      sast: sast-report.json
  allow_failure: true

security:container:
  stage: security
  extends: .docker_template
  needs: ["build:docker:api", "build:docker:validator"]
  script:
    - apk add --no-cache trivy
    - trivy image ${OSSA_API_IMAGE}
    - trivy image ${OSSA_VALIDATOR_IMAGE}
  allow_failure: true

# ==================== BENCHMARK STAGE ====================

benchmark:validation:
  stage: benchmark
  extends: .node_template
  needs: ["build:packages"]
  script:
    - echo "‚ö° Benchmarking OSSA validation..."
    - node benchmarks/validation.js || true
    - echo "Target: <50ms per validation"
  artifacts:
    paths:
      - benchmark-results/
    expire_in: 1 week
  allow_failure: true

benchmark:discovery:
  stage: benchmark
  extends: .node_template
  needs: ["build:packages"]
  script:
    - echo "‚ö° Benchmarking agent discovery..."
    - node benchmarks/discovery.js || true
    - echo "Target: 100 agents in <2s"
  artifacts:
    paths:
      - benchmark-results/
  allow_failure: true

# ==================== DEPLOY STAGE ====================

deploy:staging:
  stage: deploy
  image: alpine/helm:latest
  needs: ["build:docker:api", "conformance:silver"]
  environment:
    name: staging
    url: https://staging.ossa.ai
  script:
    - echo "üöÄ Deploying to staging..."
    - |
      cat > values.yaml << EOF
      image:
        api:
          repository: ${DOCKER_REGISTRY}/ossa-api
          tag: ${CI_COMMIT_SHA}
        validator:
          repository: ${DOCKER_REGISTRY}/ossa-validator
          tag: ${CI_COMMIT_SHA}
      environment: staging
      EOF
    - echo "Deployment simulated for staging"
  only:
    - development
    - main

deploy:production:
  stage: deploy
  image: alpine/helm:latest
  needs: ["deploy:staging", "conformance:gold"]
  environment:
    name: production
    url: https://api.ossa.ai
  script:
    - echo "üöÄ Deploying to production..."
  when: manual
  only:
    - main

# ==================== MONITOR STAGE ====================

monitor:health:
  stage: monitor
  needs: ["deploy:staging"]
  script:
    - |
      echo "üè• Checking health..."
      for i in {1..5}; do
        curl -f https://staging.ossa.ai/v1/health || echo "Health check attempt $i"
        sleep 3
      done
  retry: 2
  allow_failure: true

monitor:metrics:
  stage: monitor
  needs: ["deploy:staging"]
  script:
    - echo "üìä Collecting metrics..."
    - curl -s https://staging.ossa.ai/v1/metrics || echo "Metrics endpoint not available"
  allow_failure: true

# ==================== ROADMAP SYNC STAGE ====================

roadmap:sync-linear:
  stage: roadmap
  extends: .node_template
  needs: ["validate:roadmaps"]
  script:
    - echo "üîÑ Syncing roadmap with Linear..."
    - |
      if [ -n "$LINEAR_API_KEY" ]; then
        node packages/ossa-validator/dist/cli.js roadmap sync \
          --to linear \
          --api-key ${LINEAR_API_KEY} \
          --team-id ${LINEAR_TEAM_ID}
      else
        echo "Linear API key not configured"
      fi
  when: manual
  only:
    - main
    - development

roadmap:sync-gitlab:
  stage: roadmap
  extends: .node_template
  needs: ["validate:roadmaps"]
  script:
    - echo "üîÑ Syncing roadmap with GitLab..."
    - |
      node packages/ossa-validator/dist/cli.js roadmap sync \
        --to gitlab \
        --project-id ${CI_PROJECT_ID}
  when: manual

# ==================== RELEASE STAGE ====================

release:npm:
  stage: release
  extends: .node_template
  needs: ["deploy:production"]
  script:
    - echo "üì¶ Publishing to npm..."
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - |
      cd packages/ossa-specification
      npm version ${CI_COMMIT_TAG} --no-git-tag-version
      npm publish --access public
      cd ../ossa-validator
      npm version ${CI_COMMIT_TAG} --no-git-tag-version
      npm publish --access public
  only:
    - tags

release:changelog:
  stage: release
  extends: .node_template
  needs: ["release:npm"]
  script:
    - echo "üìù Generating changelog..."
    - npx conventional-changelog -p angular -i CHANGELOG.md -s
    - |
      git config user.email "ci@ossa.ai"
      git config user.name "OSSA CI"
      git add CHANGELOG.md
      git commit -m "chore: update CHANGELOG.md for ${CI_COMMIT_TAG} [skip ci]" || true
      git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:main || true
  only:
    - tags

# ==================== BUILDKIT INTEGRATION ====================

buildkit:validate:
  stage: validate
  extends: .node_template
  needs: ["install:dependencies"]
  script:
    - echo "üîß Validating with BuildKit..."
    - |
      if [ "$BUILDKIT_ENABLED" == "true" ]; then
        npx buildkit validate agent examples/*/agent.yml
      else
        echo "BuildKit not enabled"
      fi
  allow_failure: true

buildkit:deploy:
  stage: deploy
  extends: .node_template
  needs: ["conformance:bronze", "build:packages"]
  script:
    - echo "üîß Deploying with BuildKit..."
    - |
      if [ "$BUILDKIT_ENABLED" == "true" ]; then
        npx buildkit deploy agent \
          --target gitlab \
          --ossa-compliant \
          --manifest examples/production/agent.yml
      else
        echo "BuildKit not enabled"
      fi
  when: manual
  allow_failure: true

# ==================== PAGES (Documentation) ====================

pages:
  stage: deploy
  extends: .node_template
  needs: ["build:packages"]
  script:
    - echo "üìö Building documentation..."
    - mkdir -p public
    - cp -r docs/* public/
    - npx @redocly/cli build-docs packages/ossa-api/openapi.yaml -o public/api.html
  artifacts:
    paths:
      - public
  only:
    - main