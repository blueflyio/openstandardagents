# =============================================================================
# OSSA Specification CI/CD Pipeline - Simple & Direct
# =============================================================================
#
# Versioning Strategy (SMART VERSION BUMP):
# - Feature â†’ release/v0.4.x: Smart-detects latest prod tag, bumps patch, creates v0.4.X-dev.N
# - release/v0.4.x â†’ main: Auto-creates v0.4.X-rc.N tags (staging env)
# - Manual trigger on main: Creates v0.4.X production release (production env)
# - Next feature: Automatically bumps to next patch (v0.4.X+1-dev.1)
#
# Publishing Strategy:
# - GitHub: Only main + release branches, only RC + production tags
# - npm: Only verified production releases (no RC, no dev)
# - GitLab Releases: Only production tags
# =============================================================================

stages:
  - validate
  - test
  - build
  - smoke
  - version
  - release
  - deploy

variables:
  NODE_VERSION: "22.14"
  GIT_DEPTH: 0  # Full history for versioning

# =============================================================================
# SMART VERSION BUMP COMPONENT
# =============================================================================
# Automatically detects latest production tag and bumps patch version
# Creates -dev.N and -rc.N tags automatically
# DISABLED: Component has missing dependency (runner-selector)
# include:
#   - component: $CI_SERVER_FQDN/blueflyio/agent-platform/gitlab_components/release/smart-version-bump@main
#     inputs:
#       node_version: "22.14"
#       create_dev_tags: true
#       create_rc_tags: true
#       git_author_name: "OSSA Release Bot"
#       git_author_email: "release-bot@openstandardagents.org"

# =============================================================================
# BASE JOB TEMPLATE
# =============================================================================
.base-runner:
  image: node:${NODE_VERSION}
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/
  before_script:
    - npm ci --cache .npm --prefer-offline

# =============================================================================
# VALIDATE STAGE
# =============================================================================
validate:schema:
  extends: .base-runner
  stage: validate
  script:
    - npm run validate:schema
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

validate:examples:
  extends: .base-runner
  stage: validate
  script:
    - npm run validate:examples
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

# =============================================================================
# TEST STAGE
# =============================================================================
test:unit:
  extends: .base-runner
  stage: test
  script:
    - npm run test:unit
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

test:smoke:
  extends: .base-runner
  stage: smoke
  needs:
    - job: build
      artifacts: true
  script:
    - npm run test:smoke
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

# =============================================================================
# BUILD STAGE
# =============================================================================
build:
  extends: .base-runner
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|release\/)/

# =============================================================================
# VERSION STAGE - Now handled by smart-version-bump component
# =============================================================================
# Component automatically:
# - Detects latest production tag
# - Bumps patch version for new development cycles
# - Creates -dev.N tags on release branches
# - Creates -rc.N tags on main branch
# - Updates package.json automatically
#
# See: gitlab_components/release/smart-version-bump
# =============================================================================

# =============================================================================
# RELEASE STAGE - Production Release (Manual Trigger with Button)
# =============================================================================

release:production:
  stage: release
  image: node:${NODE_VERSION}
  extends: .base-runner
  environment:
    name: production
    deployment_tier: production
    url: https://www.npmjs.com/package/@bluefly/openstandardagents
    action: start
  variables:
    GIT_AUTHOR_NAME: "OSSA Release Bot"
    GIT_AUTHOR_EMAIL: "release-bot@openstandardagents.org"
    GIT_COMMITTER_NAME: "OSSA Release Bot"
    GIT_COMMITTER_EMAIL: "release-bot@openstandardagents.org"
  before_script:
    - npm ci
    - npm run build
    - git config user.name "${GIT_AUTHOR_NAME}"
    - git config user.email "${GIT_AUTHOR_EMAIL}"
    - |
      # Validate required tokens
      if [ -z "$NPM_TOKEN" ]; then
        echo "âŒ ERROR: NPM_TOKEN not set in CI/CD variables"
        exit 1
      fi
      if [ -z "$GITLAB_PUSH_TOKEN" ]; then
        echo "âŒ ERROR: GITLAB_PUSH_TOKEN not set"
        exit 1
      fi
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "âŒ ERROR: GITHUB_TOKEN not set"
        exit 1
      fi
      echo "âœ… Required tokens configured"
  script:
    - echo "ğŸš€ Running semantic-release for PRODUCTION..."
    - npx semantic-release
    - |
      # Get the new version
      NEW_VERSION=$(node -p "require('./package.json').version")
      echo "âœ… Released production version: v${NEW_VERSION}"

      # Sync main and release branches to GitHub
      echo "ğŸ“¤ Syncing branches to GitHub..."
      git push https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git main:main
      git push https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git release/v0.4.x:release/v0.4.x

      # Push production tag to GitHub
      git push https://${GITHUB_TOKEN}@github.com/blueflyio/openstandardagents.git "v${NEW_VERSION}"

      echo "âœ… Synced to GitHub: main, release/v0.4.x, v${NEW_VERSION}"
      echo "ğŸŒ Environment: production"
  when: manual
  only:
    - main
  artifacts:
    paths:
      - dist/*.tgz
    expire_in: 90 days

# =============================================================================
# DEPLOY STAGE - npm Publish + GitLab Release
# =============================================================================

deploy:npm:
  stage: deploy
  image: node:${NODE_VERSION}
  extends: .base-runner
  environment:
    name: production
    deployment_tier: production
    url: https://www.npmjs.com/package/@bluefly/openstandardagents
    action: start
  needs:
    - job: release:production
  before_script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
  script:
    - |
      VERSION=$(node -p "require('./package.json').version")
      echo "ğŸ“¦ Publishing to npm: v${VERSION}"

      npm publish --access public

      echo "âœ… Published to npm: @bluefly/openstandardagents@${VERSION}"
      echo "ğŸ“ https://www.npmjs.com/package/@bluefly/openstandardagents/v/${VERSION}"
  only:
    - main

deploy:gitlab-release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  extends: .base-runner
  needs:
    - job: release:production
      artifacts: true
    - job: deploy:npm
  script:
    - |
      VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
      echo "ğŸ“ Creating GitLab release for v${VERSION}..."
  release:
    tag_name: "v${VERSION}"
    name: "Release v${VERSION}"
    description: |
      ## OSSA v${VERSION}

      Open Standard for Software Agents

      See [CHANGELOG.md](https://gitlab.com/blueflyio/ossa/openstandardagents/-/blob/main/CHANGELOG.md) for full release notes.

      **Install:**
      ```bash
      npm install @bluefly/openstandardagents@${VERSION}
      ```

      **Links:**
      - [npm package](https://www.npmjs.com/package/@bluefly/openstandardagents/v/${VERSION})
      - [GitHub mirror](https://github.com/blueflyio/openstandardagents)
      - [Documentation](https://openstandardagents.org)
    assets:
      links:
        - name: "npm package"
          url: "https://www.npmjs.com/package/@bluefly/openstandardagents/v/${VERSION}"
  only:
    - main
