# =============================================================================
# OSSA Specification CI/CD Pipeline - GitLab Ultimate Optimized
# =============================================================================
# Open Standard for Software Agents (OSSA) - JSON Schema Specification
# 
# OPTIMIZATION FEATURES:
# - GitLab Ultimate security scanning (SAST, Dependency Scanning, Secret Detection)
# - Intelligent caching (npm, build artifacts, test results)
# - Conditional execution by pipeline type (feature push vs MR vs release)
# - Build once, use everywhere (artifact reuse)
# - Merge train optimization (skip heavy tests)
# - Parallel execution for independent jobs
#
# PIPELINE TYPES:
# - Feature branch push: Quick validation (2-3 min)
# - MR pipeline: Full tests + security (6-8 min)
# - Merge train: Quick validation (3-4 min)
# - Release/main: Full suite + security + release (10-12 min)
# =============================================================================

include:
  # ============================================================================
  # GitLab Component - Golden CI Template (no inputs - use defaults)
  # ============================================================================
  - component: $CI_SERVER_FQDN/blueflyio/gitlab_components/golden@release/v0.1.x
  # ============================================================================
  # Local CI Configuration Files (Organized by Concern)
  # ============================================================================
  # NOTE: GitLab SAST/Dependency-Scanning templates removed - they include
  # placeholder jobs that fail by design. Security scanning handled by:
  # - test:security (npm audit) in optimized-test-jobs.yml
  # - security-jobs.yml for additional security checks
  - local: .gitlab/ci/caching.yml
  - local: .gitlab/ci/rules.yml
  - local: .gitlab/ci/build-jobs.yml
  - local: .gitlab/ci/validation-jobs.yml
  - local: .gitlab/ci/conformance-jobs.yml
  - local: .gitlab/ci/optimized-test-jobs.yml
  - local: .gitlab/ci/security-jobs.yml
  - local: .gitlab/ci/quality-gates.yml
  - local: .gitlab/ci/release-workflow.yml
  - local: .gitlab/ci/release-promote.yml
  - local: .gitlab/ci/sdk-publish.yml
  - local: .gitlab/ci/merge-train-optimized.yml
  - local: .gitlab/ci/ossa-auto-migrate.yml

# =============================================================================
# PIPELINE DEDUPLICATION
# =============================================================================
# Prevent duplicate pipelines - only run pipelines for valid sources
# GitLab will automatically cancel older pipelines for the same ref
workflow:
  rules:
    # Allow pipelines for pushes (GitLab handles deduplication)
    - if: $CI_PIPELINE_SOURCE == "push"
    # Allow pipelines for merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Allow scheduled pipelines
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # Allow API/web triggered pipelines
    - if: $CI_PIPELINE_SOURCE == "api" || $CI_PIPELINE_SOURCE == "web"
    # Block everything else
    - when: never

# =============================================================================
# PIPELINE STAGES
# =============================================================================
stages:
  - .pre          # Setup, caching preparation
  - validate      # Quick validation (schema, lint, typecheck)
  - build         # TypeScript compilation (build once, use everywhere)
  - test          # Unit, integration, e2e tests
  - security      # SAST, Dependency Scanning, Secret Detection
  - quality       # Code quality gates
  - release       # Semantic release, npm publish
  - deploy        # Deployment (used by golden component)
  - .post         # Cleanup, notifications, dev tags

# =============================================================================
# GLOBAL VARIABLES
# =============================================================================
variables:
  NODE_VERSION: "22.14"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: fast
  CACHE_COMPRESSION_LEVEL: fast
  
  # ============================================================================
  # GitLab Ultimate Observability (OpenTelemetry)
  # ============================================================================
  # GitLab Observability OTLP endpoint for traces, metrics, and logs
  # Uses GITLAB_OBSERVABILITY_TOKEN if available, falls back to CI_DEPLOY_OSSA
  OTEL_EXPORTER_OTLP_ENDPOINT: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/observability/v1"
  OTEL_EXPORTER_OTLP_HEADERS: "PRIVATE-TOKEN=${GITLAB_OBSERVABILITY_TOKEN:-${CI_DEPLOY_OSSA}}"
  
  # Service identification
  OTEL_SERVICE_NAME: "ossa-openstandardagents"
  OTEL_SERVICE_VERSION: "${CI_COMMIT_SHORT_SHA}"
  
  # Resource attributes for observability
  OTEL_RESOURCE_ATTRIBUTES: "deployment.environment=${CI_ENVIRONMENT_NAME:-ci},service.namespace=llm-platform,git.commit.sha=${CI_COMMIT_SHA},git.branch=${CI_COMMIT_REF_NAME},git.tag=${CI_COMMIT_TAG:-none},ossa.version=${CI_COMMIT_TAG:-0.3.3},pipeline.id=${CI_PIPELINE_ID},job.id=${CI_JOB_ID}"
  
  # OpenTelemetry exporters
  OTEL_TRACES_EXPORTER: "otlp"
  OTEL_METRICS_EXPORTER: "otlp"
  OTEL_LOGS_EXPORTER: "otlp"
  OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
  
  # Observability export configuration (from group variable)
  GITLAB_OBSERVABILITY_EXPORT: "${GITLAB_OBSERVABILITY_EXPORT:-traces,metrics,logs}"

# =============================================================================
# VALIDATION JOBS (Quick checks - run early)
# =============================================================================

validate:schema:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  extends:
    - .npm-cache-readonly
  before_script:
    - npm ci --prefer-offline --no-audit
  script:
    - echo "Validating OSSA JSON Schema..."
    - npm run validate:schema
    - echo "Schema compiles successfully"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release\//
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH !~ /^(main|release)/
      when: on_success  # Quick check on feature branches too

validate:examples:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  extends:
    - .npm-cache-readonly
  before_script:
    - npm ci --prefer-offline --no-audit
  script:
    - echo "Validating example manifests..."
    - npm run validate:examples || echo "Some examples need fixes - see issues"
    - echo "Example validation complete"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release\//
    - if: $CI_COMMIT_BRANCH == "main"

validate:ossa-templates:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - saas-linux-small-amd64
  extends:
    - .npm-cache-readonly
  before_script:
    - apk add --no-cache jq
    - npm ci --prefer-offline --no-audit
  script:
    - echo "Validating OSSA template manifests..."
    - |
      # Read current version from .version.json
      CURRENT_VERSION=$(jq -r '.current' .version.json)
      SPEC_PATH=$(jq -r '.spec_path' .version.json)
      SCHEMA_FILE=$(jq -r '.schema_file' .version.json)
      SCHEMA_PATH="${SPEC_PATH}/${SCHEMA_FILE}"

      echo "Using schema: ${SCHEMA_PATH}"

      FAILED=0
      for f in examples/ossa-templates/*.ossa.yaml; do
        echo "Validating $f..."
        # Detect apiVersion in file
        API_VERSION=$(grep -E "^apiVersion:" "$f" | head -1 | sed -E 's/.*v([0-9]+\.[0-9]+).*/\1/' || echo "")
        if [ -z "$API_VERSION" ]; then
          echo "WARNING: Could not detect apiVersion in $f"
          FAILED=$((FAILED + 1))
          continue
        fi

        # After v0.3 consolidation, manifests use minor version (v0.3)
        # but validate against current patch-level schema (v0.3.5)
        if [ "$API_VERSION" != "0.3" ]; then
          echo "ERROR: Expected apiVersion ossa/v0.3, got ossa/v${API_VERSION}"
          FAILED=$((FAILED + 1))
          continue
        fi

        if npx ajv-cli validate -s "$SCHEMA_PATH" --strict=false --allow-union-types -d "$f" >/dev/null 2>&1; then
          echo "✓ $f (ossa/v${API_VERSION} → schema v${CURRENT_VERSION})"
        else
          echo "✗ FAILED: $f (ossa/v${API_VERSION})"
          npx ajv-cli validate -s "$SCHEMA_PATH" --strict=false --allow-union-types -d "$f" 2>&1 || true
          FAILED=$((FAILED + 1))
        fi
      done
      if [ $FAILED -gt 0 ]; then
        echo "ERROR: $FAILED template manifests failed validation"
        exit 1
      fi
      echo "All OSSA template examples valid"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release\//
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# RELEASE JOBS (Semantic Release)
# =============================================================================

# REMOVED: release:publish-v0.3.3 - replaced by automated promote-rc-to-stable → publish-npm:stable
# The new workflow is fully automated:
# 1. promote-rc-to-stable creates stable tag on main
# 2. publish-npm:stable publishes to npmjs.org
# 3. create-gitlab-release:stable creates GitLab release
# 4. sync-github:stable syncs to GitHub

release:semantic:
  stage: release
  image: node:${NODE_VERSION}
  tags:
    - saas-linux-small-amd64
  environment:
    name: production
  variables:
    GIT_AUTHOR_NAME: "OSSA Release Bot"
    GIT_AUTHOR_EMAIL: "release-bot@openstandardagents.org"
    GIT_COMMITTER_NAME: "OSSA Release Bot"
    GIT_COMMITTER_EMAIL: "release-bot@openstandardagents.org"
    GITLAB_TOKEN: ${CI_DEPLOY_OSSA}
  extends:
    - .npm-cache
  before_script:
    - npm ci
    - npm run build
    - |
      if [ -z "$OSSA_NPMJS" ]; then
        echo "ERROR: OSSA_NPMJS not set in CI/CD variables"
        exit 1
      fi
      echo "OSSA_NPMJS configured"
      if [ -z "$CI_DEPLOY_OSSA" ]; then
        echo "ERROR: CI_DEPLOY_OSSA not set"
        exit 1
      fi
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "WARNING: GITHUB_TOKEN not set - GitHub releases will be skipped"
        echo "Add GITHUB_TOKEN in Settings > CI/CD > Variables"
        echo "Create token at: https://github.com/settings/tokens (repo scope)"
      else
        echo "✓ GitHub token configured"
      fi
      echo "✓ Required tokens configured"
  script:
    - echo "Running semantic-release..."
    # Configure npm auth with OSSA_NPMJS token
    - echo "//registry.npmjs.org/:_authToken=${OSSA_NPMJS}" > ~/.npmrc
    - |
      # Fetch latest tags and commits to ensure semantic-release has correct git state
      git fetch --tags --prune origin
      git fetch origin ${CI_COMMIT_REF_NAME}:${CI_COMMIT_REF_NAME} || true
    - |
      if [ -n "$GITHUB_TOKEN" ]; then
        export GITHUB_TOKEN
      fi
      # Skip lifecycle scripts (prepublishOnly) - already built/tested in CI
      export npm_config_ignore_scripts=true
      npx semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
      when: on_success
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/ && $CI_PIPELINE_SOURCE == "push"
      when: on_success
  # NOTE: Removed 'environment: production' which was causing job to be manual
  # due to GitLab's production tier environment protection rules

# =============================================================================
# OVERRIDE GOLDEN COMPONENT JOBS (Disable jobs not applicable to this project)
# =============================================================================

# Disable benchmarks job from golden component - OSSA doesn't have benchmarks
benchmarks:
  rules:
    - when: never
