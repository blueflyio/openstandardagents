# OpenAPI AI Agents Standard - GitLab CI/CD Pipeline
# Enterprise-grade automation for compliance and quality assurance

stages:
  - validate
  - test
  - security
  - compliance
  - build
  - deploy
  - release

variables:
  NODE_VERSION: "18.19.0"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"
  CACHE_FALLBACK_KEY: "fallback-$CI_COMMIT_REF_SLUG"

# Cache dependencies across jobs
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - node_modules/
    - .npm/
    - coverage/
  fallback_keys:
    - $CACHE_FALLBACK_KEY
    - "fallback-main"

# Global before_script for all jobs
before_script:
  - echo "üöÄ Starting OpenAPI AI Agents Standard CI/CD pipeline"
  - echo "Branch: $CI_COMMIT_REF_NAME"
  - echo "Commit: $CI_COMMIT_SHA"
  - echo "Pipeline: $CI_PIPELINE_ID"
  - node --version
  - npm --version

# Validation Stage - Ensure code quality and standards
validate:code:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üîç Validating code quality and standards..."
    - npm ci
    - npm run lint
    - npm run format:check
    - echo "‚úÖ Code validation completed"
  artifacts:
    reports:
      junit: test-results/validation.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*$/

validate:schema:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üîç Validating JSON schemas and OpenAPI specifications..."
    - npm ci
    - npm run validate:schemas
    - npm run validate:openapi
    - echo "‚úÖ Schema validation completed"
  artifacts:
    reports:
      junit: test-results/schema-validation.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Testing Stage - Comprehensive test coverage
test:unit:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üß™ Running unit tests..."
    - npm ci
    - npm run test:unit -- --coverage --reporter=verbose
    - npm run test:coverage:report
    - echo "‚úÖ Unit tests completed"
  coverage: '/All files[^|]*\|[^|]*\|[^|]*\|[^|]*\s+(\d+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: test-results/unit-tests.xml
    paths:
      - coverage/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:integration:
  stage: test
  image: node:${NODE_VERSION}-alpine
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: "postgresql://test_user:test_password@postgres:5432/test_db"
  script:
    - echo "üß™ Running integration tests..."
    - npm ci
    - npm run test:integration -- --reporter=verbose
    - echo "‚úÖ Integration tests completed"
  artifacts:
    reports:
      junit: test-results/integration-tests.xml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*$/

test:validation-api:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üß™ Testing validation API endpoints..."
    - cd services/validation-api
    - npm ci
    - npm run test:api
    - npm run test:endpoints
    - echo "‚úÖ Validation API tests completed"
  artifacts:
    reports:
      junit: test-results/validation-api-tests.xml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:compliance:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üß™ Testing compliance validation logic..."
    - npm ci
    - npm run test:compliance
    - npm run test:dual-format
    - echo "‚úÖ Compliance tests completed"
  artifacts:
    reports:
      junit: test-results/compliance-tests.xml
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Security Stage - Security scanning and vulnerability assessment
security:scan:
  stage: security
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üîí Running security scans..."
    - npm ci
    - npm audit --audit-level=moderate
    - npm run security:scan
    - echo "‚úÖ Security scan completed"
  artifacts:
    reports:
      security: gl-sast-report.json
      dependency_scanning: gl-dependency-scanning-report.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

security:maestro:
  stage: security
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üîí Running MAESTRO security framework assessment..."
    - npm ci
    - npm run security:maestro
    - npm run security:threat-modeling
    - echo "‚úÖ MAESTRO assessment completed"
  artifacts:
    reports:
      junit: test-results/maestro-assessment.xml
    paths:
      - security-reports/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Compliance Stage - Regulatory and standards compliance
compliance:iso42001:
  stage: compliance
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üìã Validating ISO 42001:2023 compliance..."
    - npm ci
    - npm run compliance:iso42001
    - npm run compliance:report
    - echo "‚úÖ ISO 42001 compliance validation completed"
  artifacts:
    reports:
      junit: test-results/iso42001-compliance.xml
    paths:
      - compliance-reports/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

compliance:nist-rmf:
  stage: compliance
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üìã Validating NIST AI RMF 1.0 compliance..."
    - npm ci
    - npm run compliance:nist-rmf
    - npm run compliance:risk-assessment
    - echo "‚úÖ NIST AI RMF compliance validation completed"
  artifacts:
    reports:
      junit: test-results/nist-rmf-compliance.xml
    paths:
      - compliance-reports/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

compliance:eu-ai-act:
  stage: compliance
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üìã Validating EU AI Act compliance..."
    - npm ci
    - npm run compliance:eu-ai-act
    - npm run compliance:transparency
    - echo "‚úÖ EU AI Act compliance validation completed"
  artifacts:
    reports:
      junit: test-results/eu-ai-act-compliance.xml
    paths:
      - compliance-reports/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build Stage - Create production artifacts
build:services:
  stage: build
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üèóÔ∏è Building validation services..."
    - cd services/validation-api
    - npm ci
    - npm run build
    - cd ../universal-agent-toolkit
    - npm ci
    - npm run build
    - echo "‚úÖ Services built successfully"
  artifacts:
    paths:
      - services/*/dist/
      - services/*/build/
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*$/

build:docker:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: overlay2
  script:
    - echo "üê≥ Building Docker images..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - cd services/validation-api
    - docker build -t $CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE/validation-api:latest .
    - docker push $CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/validation-api:latest
    - cd ../universal-agent-toolkit
    - docker build -t $CI_REGISTRY_IMAGE/universal-agent-toolkit:$CI_COMMIT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE/universal-agent-toolkit:latest .
    - docker push $CI_REGISTRY_IMAGE/universal-agent-toolkit:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/universal-agent-toolkit:latest
    - echo "‚úÖ Docker images built and pushed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*$/

# Deploy Stage - Deploy to staging and production
deploy:staging:
  stage: deploy
  image: alpine:latest
  environment:
    name: staging
    url: https://staging.openapi-ai-agents.org
  script:
    - echo "üöÄ Deploying to staging environment..."
    - apk add --no-cache curl
    - curl -X POST $STAGING_DEPLOY_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"ref\": \"$CI_COMMIT_REF_NAME\", \"sha\": \"$CI_COMMIT_SHA\"}"
    - echo "‚úÖ Staging deployment initiated"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual

deploy:production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://api.openapi-ai-agents.org
  script:
    - echo "üöÄ Deploying to production environment..."
    - apk add --no-cache curl
    - curl -X POST $PRODUCTION_DEPLOY_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"ref\": \"$CI_COMMIT_REF_NAME\", \"sha\": \"$CI_COMMIT_SHA\"}"
    - echo "‚úÖ Production deployment initiated"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual
  dependencies:
    - deploy:staging

# Release Stage - Create releases and tags
release:create:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "üè∑Ô∏è Creating release..."
    - |
      release-cli create \
        --name "Release $CI_COMMIT_TAG" \
        --tag-name $CI_COMMIT_TAG \
        --assets-link "{\"name\":\"Validation API\",\"url\":\"$CI_REGISTRY_IMAGE/validation-api:$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Universal Agent Toolkit\",\"url\":\"$CI_REGISTRY_IMAGE/universal-agent-toolkit:$CI_COMMIT_TAG\"}" \
        --assets-link "{\"name\":\"Compliance Report\",\"url\":\"$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/browse/compliance-reports?job=compliance:iso42001\"}"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  dependencies:
    - build:docker
    - compliance:iso42001

# Quality Gates and Notifications
quality:gate:
  stage: .pre
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üîç Running quality gates..."
    - npm ci
    - npm run quality:check
    - |
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        echo "üö® Quality gate: Main branch protection"
        npm run quality:strict
      fi
    - echo "‚úÖ Quality gates passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

notify:success:
  stage: .post
  image: alpine:latest
  script:
    - echo "‚úÖ Pipeline completed successfully"
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST $SLACK_WEBHOOK_URL \
          -H "Content-Type: application/json" \
          -d "{\"text\":\"üéâ OpenAPI AI Agents Standard pipeline completed successfully! Branch: $CI_COMMIT_REF_NAME, Commit: $CI_COMMIT_SHA\"}"
      fi
  rules:
    - when: on_success

notify:failure:
  stage: .post
  image: alpine:latest
  script:
    - echo "‚ùå Pipeline failed"
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST $SLACK_WEBHOOK_URL \
          -H "Content-Type: application/json" \
          -d "{\"text\":\"üö® OpenAPI AI Agents Standard pipeline failed! Branch: $CI_COMMIT_REF_NAME, Commit: $CI_COMMIT_SHA. Check: $CI_PIPELINE_URL\"}"
      fi
  rules:
    - when: on_failure

# Performance and Monitoring
performance:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üìä Running performance tests..."
    - npm ci
    - npm run test:performance
    - npm run test:load
    - echo "‚úÖ Performance tests completed"
  artifacts:
    reports:
      junit: test-results/performance-tests.xml
    paths:
      - performance-reports/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# Documentation Generation
docs:generate:
  stage: build
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üìö Generating documentation..."
    - npm ci
    - npm run docs:generate
    - npm run docs:validate
    - echo "‚úÖ Documentation generated"
  artifacts:
    paths:
      - docs/generated/
      - docs/api/
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*$/

# Security and Compliance Reporting
report:compliance:
  stage: .post
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "üìã Generating compliance report..."
    - npm ci
    - npm run report:compliance
    - npm run report:security
    - echo "‚úÖ Compliance report generated"
  artifacts:
    paths:
      - compliance-reports/
      - security-reports/
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - compliance:iso42001
    - compliance:nist-rmf
    - compliance:eu-ai-act
    - security:maestro