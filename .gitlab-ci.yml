# =============================================================================
# OSSA Website CI/CD Pipeline with Auto DevOps Integration
# =============================================================================
#
# Auto DevOps Features Enabled:
# - Auto Build: Cloud Native Buildpacks (CNB) with Heroku builder
# - Auto Test: Herokuish-based test detection
# - Auto Code Quality: Static analysis with GitLab Code Quality
# - Auto SAST: Static application security testing
# - Auto Secret Detection: Credential leak detection
# - Auto Dependency Scanning: Vulnerability scanning for dependencies
# - Auto Container Scanning: Docker image vulnerability scanning
# - Auto Browser Performance: Sitespeed.io performance testing
# - Auto Deploy: Kubernetes deployment with Helm
#
# GitLab Ultimate Features:
# - Unit Test Reports: JUnit XML format with coverage
# - Test Cases: Playwright E2E tests with JUnit reports
# - Metrics Reports: Custom deployment and build metrics
# - Code Quality: Docker-based code quality analysis
# - Browser Performance: Sitespeed.io performance testing
# - Accessibility Testing: Pa11y automated WCAG 2.1 AA compliance
#
# Pipeline Stages:
# 1. validate - Lint, typecheck, branch protection
# 2. test - Unit tests + E2E tests (Playwright)
# 3. build - Next.js static export
# 4. security - SAST, Secret Detection, Dependency Scanning
# 5. quality - Code quality, performance, accessibility
# 6. deploy - Staging (development) and Production (main)
# 7. release - Release automation
# =============================================================================

include:
  # Auto DevOps templates
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/Container-Scanning.gitlab-ci.yml
  - template: Jobs/Code-Quality.gitlab-ci.yml

stages:
  - validate
  - test
  - build
  - security
  - quality
  - deploy
  - release

variables:
  NODE_VERSION: "20"
  PLAYWRIGHT_BROWSERS_PATH: "$CI_PROJECT_DIR/.cache/ms-playwright"
  # Auto DevOps variables
  SAST_EXCLUDED_PATHS: "spec, test, tests, tmp, node_modules, .cache"
  SECRET_DETECTION_EXCLUDED_PATHS: "node_modules, .cache"
  DS_EXCLUDED_PATHS: "spec, test, tests, tmp"
  CODE_QUALITY_DISABLED: "false"
  SAST_DISABLED: "false"
  SECRET_DETECTION_DISABLED: "false"
  DEPENDENCY_SCANNING_DISABLED: "false"
  CONTAINER_SCANNING_DISABLED: "false"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^(feature|bugfix|hotfix|chore)\/.+/

# =============================================================================
# BRANCH PROTECTION
# =============================================================================
enforce-main-branch-policy:
  stage: validate
  image: alpine:latest
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH == "main"
  script:
    - |
      if [ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" != "development" ]; then
        echo "âŒ ERROR: Main branch only accepts merges from 'development'"
        echo "   Source: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
        echo "   Target: $CI_MERGE_REQUEST_TARGET_BRANCH"
        exit 1
      fi
    - echo "âœ… Branch policy check passed"

# =============================================================================
# TEMPLATES
# =============================================================================
.node-setup:
  image: node:${NODE_VERSION}-alpine
  variables:
    NODE_ENV: development
  before_script:
    - cd website
    - npm ci --prefer-offline --no-audit

# =============================================================================
# VALIDATE
# =============================================================================
validate:lint:
  extends: .node-setup
  stage: validate
  script:
    - npm run lint
  allow_failure: false

validate:typecheck:
  extends: .node-setup
  stage: validate
  script:
    - npx tsc --noEmit
  allow_failure: false

# =============================================================================
# TEST
# =============================================================================
test:unit:
  extends: .node-setup
  stage: test
  script:
    - npm run test -- --coverage --reporters=default --reporters=jest-junit
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: website/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: website/coverage/cobertura-coverage.xml
    paths:
      - website/coverage
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"

test:e2e:
  extends: .node-setup
  stage: test
  image: mcr.microsoft.com/playwright:v1.48.0-jammy
  cache:
    key: playwright-cache
    paths:
      - .cache/ms-playwright
  script:
    - npx playwright install --with-deps
    - npm run test:e2e -- --reporter=junit --reporter=html
  artifacts:
    when: always
    reports:
      junit: website/playwright-report/results.xml
    paths:
      - website/playwright-report
      - website/test-results
    expire_in: 30 days
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# BUILD
# =============================================================================
build:website:
  stage: build
  image: node:20-alpine
  variables:
    NODE_ENV: development
  before_script:
    - cd website
    - npm ci --prefer-offline --no-audit
  script:
    - npm run build
    - mkdir -p ../website-build
    - cp -r out/* ../website-build/
  artifacts:
    paths:
      - website-build
    expire_in: 1 day

build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  script:
    - cd website
    - |
      cat > Dockerfile << 'EOF'
      FROM node:20-alpine
      WORKDIR /app
      COPY out ./out
      RUN npm install -g serve
      EXPOSE 3000
      CMD ["serve", "-s", "out", "-l", "3000"]
      EOF
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
  dependencies:
    - build:website
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# SECURITY
# =============================================================================
# SAST, Secret Detection, Dependency Scanning are included from templates
# Container Scanning needs the image to be built first
container_scanning:
  stage: security
  variables:
    CS_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  dependencies:
    - build:docker
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# QUALITY
# =============================================================================
quality:browser-performance:
  stage: quality
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - build:website
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - mkdir -p sitespeed-results
    # Start a simple HTTP server to serve static files, then run sitespeed
    - |
      docker network create perf-net || true
      docker run -d --name static-server --network perf-net \
        -v "$(pwd)/website-build":/usr/share/nginx/html:ro \
        nginx:alpine
      sleep 3
      docker run --network perf-net --shm-size=1g --rm \
        -v "$(pwd)/sitespeed-results":/sitespeed.io \
        sitespeedio/sitespeed.io:latest \
        http://static-server/index.html \
        --outputFolder /sitespeed.io \
        -n 1 || true
      docker stop static-server || true
      docker rm static-server || true
  artifacts:
    reports:
      browser_performance: sitespeed-results/data/performance.json
    paths:
      - sitespeed-results
    expire_in: 30 days
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"

quality:accessibility:
  stage: quality
  image: node:${NODE_VERSION}
  dependencies:
    - build:website
  before_script:
    - npm install -g pa11y-ci
  script:
    - pa11y-ci --sitemap website-build/sitemap.xml --json > accessibility.json || true
  artifacts:
    reports:
      accessibility: accessibility.json
    paths:
      - accessibility.json
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"

quality:metrics:
  extends: .node-setup
  stage: quality
  script:
    - |
      cat > metrics.txt << EOF
      # TYPE deployment_frequency counter
      # HELP deployment_frequency Number of deployments
      deployment_frequency{environment="$CI_ENVIRONMENT_NAME"} 1
      # TYPE build_duration_seconds gauge
      # HELP build_duration_seconds Build duration in seconds
      build_duration_seconds{job="$CI_JOB_NAME"} $CI_JOB_DURATION
      EOF
  artifacts:
    reports:
      metrics: metrics.txt
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# REVIEW - Disabled (GitLab artifact URLs don't work for SPAs)
# Use OrbStack environment for local testing instead
# =============================================================================

# =============================================================================
# STAGING - GitLab Pages from development
# =============================================================================
pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build:website
  script:
    - mkdir -p public
    - cp -r website-build/* public/
    - echo "âœ… Deployed to staging"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  environment:
    name: orbstack
    url: http://ossa.orb.local
    deployment_tier: staging
  rules:
    - if: $CI_COMMIT_BRANCH == "development"

# =============================================================================
# PRODUCTION - Manual approval required
# =============================================================================
deploy:production:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build:website
  script:
    - mkdir -p public
    - cp -r website-build/* public/
    - echo "ðŸš€ PRODUCTION DEPLOYED"
  artifacts:
    paths:
      - public
    expire_in: 90 days
  environment:
    name: production
    url: https://openstandardagents.org
    deployment_tier: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  resource_group: production

# =============================================================================
# NOTIFICATIONS
# =============================================================================
notify:discord:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      if [ -z "$DISCORD_WEBHOOK_URL" ]; then
        echo "âš ï¸  DISCORD_WEBHOOK_URL not set"
        exit 0
      fi

      # Determine deployment type
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        ENV="Production"
        COLOR=5763719  # Green
        URL="https://openstandardagents.org"
      elif [ "$CI_COMMIT_BRANCH" = "development" ]; then
        ENV="Staging"
        COLOR=15844367  # Gold
        URL="https://staging.openstandardagents.org"
      else
        exit 0
      fi

      # Build Discord embed
      PAYLOAD=$(cat <<EOF
      {
        "embeds": [{
          "title": "ðŸš€ ${ENV} Deployment",
          "description": "**openstandardagents.org** has been deployed",
          "color": ${COLOR},
          "fields": [
            {
              "name": "Environment",
              "value": "${ENV}",
              "inline": true
            },
            {
              "name": "Branch",
              "value": "${CI_COMMIT_BRANCH}",
              "inline": true
            },
            {
              "name": "Commit",
              "value": "[${CI_COMMIT_SHORT_SHA}](${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA})",
              "inline": true
            },
            {
              "name": "Pipeline",
              "value": "[#${CI_PIPELINE_ID}](${CI_PIPELINE_URL})",
              "inline": true
            },
            {
              "name": "Deployed By",
              "value": "${GITLAB_USER_NAME:-CI}",
              "inline": true
            },
            {
              "name": "URL",
              "value": "[${URL}](${URL})",
              "inline": true
            }
          ],
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }]
      }
      EOF
      )

      # Send to Discord
      curl -H "Content-Type: application/json" \
        -d "$PAYLOAD" \
        "$DISCORD_WEBHOOK_URL"

      echo "âœ… Discord notification sent"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_success
  allow_failure: true

# =============================================================================
# AGENT AUTOMATION
# =============================================================================
mr-manager-agent:
  stage: .pre
  image: node:20-alpine
  script:
    - |
      echo "MR Manager Agent triggered"
      echo "MR: $CI_MERGE_REQUEST_IID"
      echo "Pipeline: $CI_PIPELINE_ID"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true
