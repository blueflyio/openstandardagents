# GitLab CI/CD Pipeline for OSSA
# Decoupled Release Model:
# - Code flows freely: Feature ‚Üí development ‚Üí main (CI validates, no auto-release)
# - Website deployment: Manual button (independent of releases)
# - NPM releases: Manual button + milestone-gated
#
# Workflow:
# 1. Feature branches ‚Üí merge to development (CI validates)
# 2. Development ‚Üí merge to main via merge train (CI validates)
# 3. Click "Deploy Website" button ‚Üí GitLab Pages deploys
# 4. Close milestone ‚Üí Click "Release" button ‚Üí npm publish + git tag
#
# Status: ACTIVE MODE
# Last updated: 2025-11-24

stages:
  - version-detect
  - validate
  - build
  - test
  - quality
  - deploy
  - release
  - mirror

variables:
  NODE_VERSION: "22"
  NPM_CONFIG_LEGACY_PEER_DEPS: "1"
  HUSKY: "0"
  LEFTHOOK: "0"

# ============================================================================
# STAGE 0: VERSION DETECTION (for release gating)
# ============================================================================

detect:milestone-version:
  stage: version-detect
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git
  script:
    - |
      echo "üîç Milestone Version Detection"
      echo "=============================="
      echo ""

      git fetch --tags 2>/dev/null || echo "Warning: Could not fetch tags"

      # Get closed milestones
      ALL_MILESTONES=$(curl -sS -G "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/milestones" \
        --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}" \
        --data-urlencode "per_page=100" \
        --data-urlencode "state=closed")

      MILESTONE_FOUND=false
      RELEASE_VERSION=""
      MILESTONE_TITLE=""
      MILESTONE_ID=""

      for milestone in $(echo "$ALL_MILESTONES" | jq -c '.[]'); do
        TITLE=$(echo "$milestone" | jq -r '.title')
        ID=$(echo "$milestone" | jq -r '.id')
        VERSION=$(echo "$TITLE" | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1 | sed 's/^v//')

        if [ -z "$VERSION" ]; then continue; fi

        # Skip if already released
        if git tag -l | grep -qE "^v?${VERSION}$"; then
          echo "‚è≠Ô∏è  Skipping: $TITLE (v${VERSION} already released)"
          continue
        fi

        # Get milestone stats
        STATS=$(curl -sS "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/milestones/${ID}" \
          --header "PRIVATE-TOKEN: ${GITLAB_PUSH_TOKEN}")
        OPEN_ISSUES=$(echo "$STATS" | jq -r '((.total_issues_count // 0) - (.closed_issues_count // 0))')

        if [ "$OPEN_ISSUES" -eq 0 ]; then
          echo "‚úÖ Found release-ready milestone: $TITLE"
          MILESTONE_FOUND=true
          RELEASE_VERSION="$VERSION"
          MILESTONE_TITLE="$TITLE"
          MILESTONE_ID="$ID"
          break
        else
          echo "‚ö†Ô∏è  $TITLE has $OPEN_ISSUES open issues"
        fi
      done

      # Write environment file
      echo "RELEASE_VERSION=${RELEASE_VERSION}" > milestone-version.env
      echo "MILESTONE_TITLE=${MILESTONE_TITLE}" >> milestone-version.env
      echo "MILESTONE_ID=${MILESTONE_ID}" >> milestone-version.env
      echo "MILESTONE_READY=${MILESTONE_FOUND}" >> milestone-version.env

      echo ""
      cat milestone-version.env
  artifacts:
    reports:
      dotenv: milestone-version.env
    paths:
      - milestone-version.env
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
  allow_failure: true

# ============================================================================
# STAGE 1: VALIDATE
# ============================================================================

validate:node:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - node --version
    - npm --version
    - echo "Node.js ${NODE_VERSION} ready"
  rules:
    - when: always

validate:ossa:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - npm ci --legacy-peer-deps
    - npm run build
    - echo "Validating example manifests..."
    - node dist/cli/index.js validate examples/getting-started/hello-world-complete.ossa.yaml || echo "WARNING: Validation warnings (non-blocking)"
  allow_failure: true
  rules:
    - when: always

validate:version-sync:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - npm ci --legacy-peer-deps
    - echo "üîç Checking version consistency..."
    - npx tsx scripts/sync-versions.ts --check
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "development"
      when: always
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - changes:
      - package.json
      - README.md
      - spec/**/*
      when: always

validate:docs-consistency:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --legacy-peer-deps
  script:
    - |
      echo "üîç Documentation Validation"
      echo "==========================="

      VERSION=$(node -p "require('./package.json').version")
      echo "üì¶ Package version: v${VERSION}"

      # Run version sync check
      if ! npx tsx scripts/sync-versions.ts --check; then
        echo "‚ùå Documentation out of sync!"
        echo "Run: npx tsx scripts/sync-versions.ts --fix"
        exit 1
      fi

      # Verify spec directory
      if [ ! -d "spec/v${VERSION}" ]; then
        echo "‚ùå spec/v${VERSION}/ missing"
        exit 1
      fi

      # Verify schema file
      if [ ! -f "spec/v${VERSION}/ossa-${VERSION}.schema.json" ]; then
        echo "‚ùå Schema file missing"
        exit 1
      fi

      echo "‚úÖ Documentation consistent"
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH == "development"
      when: always
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
      when: always
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development"
      when: always

# ============================================================================
# STAGE 2: BUILD
# ============================================================================

build:dist:
  stage: build
  image: node:${NODE_VERSION}-alpine
  script:
    - npm ci --legacy-peer-deps
    - npm run build
    - test -f dist/cli/index.js || (echo "ERROR: dist/cli/index.js missing" && exit 1)
    - echo "Build completed"
  artifacts:
    paths:
      - dist/
      - package.json
      - package-lock.json
    expire_in: 1 hour
  rules:
    - when: always

# ============================================================================
# STAGE 3: TEST
# ============================================================================

test:lint:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - npm ci --legacy-peer-deps
    - npm run build
    - npm run lint || echo "WARNING: Lint warnings"
    - npm run typecheck || echo "WARNING: Typecheck warnings"
  allow_failure: true
  rules:
    - when: always

test:unit:
  stage: test
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - build:dist
  before_script:
    - npm ci --legacy-peer-deps
  script:
    - npm run build
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  allow_failure: false
  rules:
    - when: always

test:security:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - npm ci --legacy-peer-deps
    - npm audit --production || echo "WARNING: Security vulnerabilities"
  allow_failure: true
  rules:
    - when: always

# ============================================================================
# STAGE 4: QUALITY GATES
# ============================================================================

quality:gates:
  stage: quality
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "‚úÖ Quality gates passed"
  rules:
    - when: always
  needs:
    - job: test:unit
      optional: true
    - job: test:lint
      optional: true
    - job: test:security
      optional: true

# ============================================================================
# STAGE 5: DEPLOY (Website - Manual Button)
# ============================================================================
# Website deployment is INDEPENDENT of npm releases
# Click the button to deploy website at any time

pages:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  needs: []  # Run independently - no dependencies
  before_script:
    - cd website
    - npm ci
    - apk add --no-cache git curl
    - export GITLAB_HOST="${GITLAB_HOST:-${CI_SERVER_HOST}}"
  script:
    - npm run sync-wiki || echo "Warning: Wiki sync failed"
    - npm run build
    - mv out ../public
  artifacts:
    paths:
      - public
  environment:
    name: website
    url: https://openstandardagents.org
    deployment_tier: production
  rules:
    # Manual button on main - deploy website anytime
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    # Manual on development for preview
    - if: $CI_COMMIT_BRANCH == "development"
      when: manual
      allow_failure: true

# ============================================================================
# STAGE 6: RELEASE (NPM - Manual Button, Milestone-Gated)
# ============================================================================
# NPM release requires:
# 1. Closed milestone with version in title
# 2. All issues in milestone closed (100% complete)
# 3. Manual button click

release:preview:
  stage: release
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - build:dist
  before_script:
    - npm ci --legacy-peer-deps
  script:
    - |
      echo "üîç Release Preview"
      echo "=================="

      CURRENT_VERSION=$(node -p "require('./package.json').version")
      echo "üì¶ Current version: v${CURRENT_VERSION}"

      if [ -n "$RELEASE_VERSION" ] && [ "$MILESTONE_READY" = "true" ]; then
        echo ""
        echo "‚úÖ Release ready!"
        echo "   Milestone: ${MILESTONE_TITLE}"
        echo "   Version to release: v${RELEASE_VERSION}"
        echo ""
        echo "Click 'release:npm' button to publish."
      else
        echo ""
        echo "‚ÑπÔ∏è  No release-ready milestone found"
        echo "   Close a milestone with version to enable release"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
  allow_failure: true
  needs:
    - build:dist
    - job: detect:milestone-version
      optional: true
      artifacts: true

release:npm:
  stage: release
  image: node:${NODE_VERSION}-alpine
  dependencies:
    - build:dist
    - detect:milestone-version
  before_script:
    - apk add --no-cache git curl jq
    - npm ci --legacy-peer-deps
    - git config --global user.email "ci@blueflyio.com"
    - git config --global user.name "GitLab CI Release"
    - git remote set-url origin https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
    - git fetch --unshallow --tags || true
    - git checkout -B main origin/main
  script:
    - |
      echo "üöÄ NPM Release (Milestone-Gated)"
      echo "================================="

      # Validate milestone is ready
      if [ "$MILESTONE_READY" != "true" ]; then
        echo "‚ùå RELEASE BLOCKED: No release-ready milestone"
        echo ""
        echo "Requirements:"
        echo "  1. Milestone with version in title (e.g., 'v0.2.6 - Feature')"
        echo "  2. Milestone must be CLOSED"
        echo "  3. All issues must be closed (100% complete)"
        echo "  4. Version not already released"
        exit 1
      fi

      VERSION="$RELEASE_VERSION"
      echo "‚úÖ Releasing v${VERSION}"
      echo "   Milestone: ${MILESTONE_TITLE}"

      # Update package.json
      npm version ${VERSION} --no-git-tag-version --allow-same-version

      # Sync documentation
      echo "üìù Syncing documentation..."
      npx tsx scripts/sync-versions.ts --fix

      # Verify sync
      if ! npx tsx scripts/sync-versions.ts --check; then
        echo "‚ùå Documentation sync failed"
        exit 1
      fi

      # Configure npm
      echo "@bluefly:registry=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/" > .npmrc
      echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc

      if [ -n "$NPM_TOKEN" ]; then
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> .npmrc
      fi

      # Run tests
      echo "üß™ Running tests..."
      npm run test || (echo "‚ùå Tests failed" && exit 1)

      # Publish
      echo "üì¶ Publishing to npm..."
      npm publish --access public

      # Commit and tag
      echo "üè∑Ô∏è  Creating tag..."
      git add package.json package-lock.json README.md spec/ RELEASING.md || true
      git commit -m "chore(release): v${VERSION} [skip ci]" || echo "No changes"
      git tag -a "v${VERSION}" -m "Release v${VERSION}"
      git push origin main --tags

      echo ""
      echo "‚úÖ Released v${VERSION}"
      echo "   üì¶ npm: https://www.npmjs.com/package/@bluefly/openstandardagents"
      echo "   üè∑Ô∏è  Tag: v${VERSION}"
  rules:
    # Manual button - only appears on main branch
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: false
  needs:
    - quality:gates
    - build:dist
    - validate:docs-consistency
    - job: detect:milestone-version
      artifacts: true

# ============================================================================
# STAGE 7: MIRROR
# ============================================================================

mirror:github:
  stage: mirror
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl
    - git config --global user.email "ci@blueflyio.com"
    - git config --global user.name "GitLab CI"
  script:
    - |
      if [ -z "$GITHUB_MIRROR_TOKEN" ]; then
        echo "‚ö†Ô∏è  GITHUB_MIRROR_TOKEN not set - skipping"
        exit 0
      fi

      echo "üîÑ Syncing to GitHub..."
      git remote add github https://${GITHUB_MIRROR_TOKEN}@github.com/blueflyio/openstandardagents.git || true
      git push github --all --force || true
      git push github --tags --force || true
      echo "‚úÖ GitHub mirror synced"
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  allow_failure: true

# ============================================================================
# WORKFLOW
# ============================================================================

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH
      when: always
    - if: $CI_MERGE_REQUEST_IID
      when: always
    - if: $CI_COMMIT_TAG
      when: always
