stages:
  - validate
  - build
  - review
  - deploy
  - release

variables:
  NODE_VERSION: "20"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^(feature|bugfix|hotfix|chore)\/.+/

# =============================================================================
# BRANCH PROTECTION
# =============================================================================
enforce-main-branch-policy:
  stage: validate
  image: alpine:latest
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH == "main"
  script:
    - |
      if [ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" != "development" ]; then
        echo "‚ùå ERROR: Main branch only accepts merges from 'development'"
        echo "   Source: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
        echo "   Target: $CI_MERGE_REQUEST_TARGET_BRANCH"
        exit 1
      fi
    - echo "‚úÖ Branch policy check passed"

# =============================================================================
# BRANCH PROTECTION
# =============================================================================
enforce-main-branch-policy:
  stage: validate
  image: alpine:latest
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH == "main"
  script:
    - |
      if [ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" != "development" ]; then
        echo "‚ùå ERROR: Main branch only accepts merges from 'development'"
        echo "   Source: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
        echo "   Target: $CI_MERGE_REQUEST_TARGET_BRANCH"
        exit 1
      fi
    - echo "‚úÖ Branch policy check passed"

# =============================================================================
# BRANCH PROTECTION
# =============================================================================
enforce-main-branch-policy:
  stage: validate
  image: alpine:latest
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH == "main"
  script:
    - |
      if [ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" != "development" ]; then
        echo "‚ùå ERROR: Main branch only accepts merges from 'development'"
        echo "   Source: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
        echo "   Target: $CI_MERGE_REQUEST_TARGET_BRANCH"
        exit 1
      fi
    - echo "‚úÖ Branch policy check passed"

# =============================================================================
# BRANCH PROTECTION
# =============================================================================
enforce-main-branch-policy:
  stage: validate
  image: alpine:latest
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH == "main"
  script:
    - |
      if [ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" != "development" ]; then
        echo "‚ùå ERROR: Main branch only accepts merges from 'development'"
        echo "   Source: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
        echo "   Target: $CI_MERGE_REQUEST_TARGET_BRANCH"
        exit 1
      fi
    - echo "‚úÖ Branch policy check passed"

# =============================================================================
# BRANCH PROTECTION
# =============================================================================
enforce-main-branch-policy:
  stage: validate
  image: alpine:latest
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH == "main"
  script:
    - |
      if [ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" != "development" ]; then
        echo "‚ùå ERROR: Main branch only accepts merges from 'development'"
        echo "   Source: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
        echo "   Target: $CI_MERGE_REQUEST_TARGET_BRANCH"
        exit 1
      fi
    - echo "‚úÖ Branch policy check passed"

# =============================================================================
# TEMPLATES
# =============================================================================
.node-setup:
  image: node:${NODE_VERSION}-alpine
  variables:
    NODE_ENV: production
  before_script:
    - cd website
    - npm ci --prefer-offline --no-audit

# =============================================================================
# VALIDATE
# =============================================================================
validate:lint:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "‚úÖ Lint passed"
  allow_failure: true

# =============================================================================
# BUILD
# =============================================================================
build:website:
  extends: .node-setup
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - website/out
    expire_in: 1 day

# =============================================================================
# REVIEW - GitLab Pages review apps (auto-stop on new deploy)
# =============================================================================
review:deploy:
  stage: review
  image: alpine:latest
  dependencies:
    - build:website
  script:
    - mkdir -p public
    - cp -r website/out/* public/
    - echo "‚úÖ Review app deployed"
  artifacts:
    paths:
      - public
    expire_in: 7 days
  environment:
    name: review
    url: https://blueflyio.gitlab.io/-/openstandardagents.org/-/jobs/$CI_JOB_ID/artifacts/public/index.html
    auto_stop_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Review apps auto-stop after 1 day (configured in review:deploy)

# =============================================================================
# STAGING - GitLab Pages from development
# =============================================================================
pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build:website
  script:
    - mkdir -p public
    - cp -r website/out/* public/
    - echo "‚úÖ Deployed to staging"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  environment:
    name: orbstack
    url: http://ossa.orb.local
    deployment_tier: staging
  rules:
    - if: $CI_COMMIT_BRANCH == "development"



# =============================================================================
# PRODUCTION - Manual approval required
# =============================================================================
deploy:production:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build:website
  script:
    - mkdir -p public
    - cp -r website/out/* public/
    - echo "üöÄ PRODUCTION DEPLOYED"
  artifacts:
    paths:
      - public
    expire_in: 90 days
  environment:
    name: production
    url: https://openstandardagents.org
    deployment_tier: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  resource_group: production

# =============================================================================
# NOTIFICATIONS
# =============================================================================
notify:discord:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üì¢ Notification sent"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true
