# =============================================================================
# OSSA Specification CI/CD Pipeline
# Open Standard for Scalable AI Agents - JSON Schema Specification
# =============================================================================

stages:
  - validate
  - test
  - release

variables:
  NODE_VERSION: "22.14"
  CI_USE_LOCAL_RUNNERS: "true" # Toggle this to switch between local and shared runners
  GIT_DEPTH: 0 # Disable shallow cloning to prevent git corruption

workflow:
  rules:
    - if: $CI_USE_LOCAL_RUNNERS == "true"
      variables:
        OSSA_RUNNER_TAG: "local"
    - if: $CI_USE_LOCAL_RUNNERS != "true"
      variables:
        OSSA_RUNNER_TAG: "saas-linux-small-amd64" # GitLab SaaS shared runner
    - when: always

# =============================================================================
# VALIDATE STAGE - Schema & Manifest Validation
# =============================================================================

validate:schema:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - ${OSSA_RUNNER_TAG}
  timeout: 10 minutes
  before_script:
    - npm ci --prefer-offline --no-audit --ignore-scripts
  script:
    - echo "Validating OSSA JSON Schema..."
    - timeout 5m npm run validate:schema || echo "[WARN] Schema validation timed out - see issue #395"
    - echo "Schema compiles successfully"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release/
    - if: $CI_COMMIT_BRANCH == "main"

validate:examples:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - ${OSSA_RUNNER_TAG}
  timeout: 10 minutes
  before_script:
    - npm ci --prefer-offline --no-audit --ignore-scripts
  script:
    - echo "Validating example manifests..."
    - timeout 5m npm run validate:examples || echo "[WARN] Some examples need fixes - see issue #395"
    - echo "Example validation complete"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release/
    - if: $CI_COMMIT_BRANCH == "main"

validate:ossa-templates:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  tags:
    - ${OSSA_RUNNER_TAG}
  timeout: 10 minutes
  before_script:
    - npm ci --prefer-offline --no-audit --ignore-scripts
  script:
    - echo "Validating power agent manifests..."
    - |
      timeout 5m bash -c '
      for f in examples/ossa-templates/*.ossa.yaml; do
        echo "Validating $f..."
        npx ajv-cli validate -s spec/v0.3.3/ossa-0.3.3.schema.json --strict=false --allow-union-types -d "$f" || echo "SKIP: $f"
      done
      ' || echo "[WARN] Template validation timed out or failed - see issue #395"
    - echo "OSSA template validation complete"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release/
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# TEST STAGE - Unit & Integration Tests
# =============================================================================

.node-setup:
  image: node:${NODE_VERSION}-alpine
  tags:
    - ${OSSA_RUNNER_TAG}
  before_script:
    - npm ci --prefer-offline --no-audit

test:unit:
  extends: .node-setup
  stage: test
  allow_failure: true
  script:
    # Build - allows failure for in-progress TypeScript work
    - npm run build 2>&1 || echo "[WARN] Build has TypeScript errors (known issue in SDK work)"
    # Run tests that don't require CLI
    - npm run test -- --testPathIgnore="integration/cli"
  artifacts:
    when: always
    reports:
      junit: junit.xml
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^release/
    - if: $CI_COMMIT_BRANCH == "main"

# =============================================================================
# RELEASE STAGE - Automated Semantic Release
# =============================================================================

release:semantic:
  stage: release
  image: node:${NODE_VERSION}
  tags:
    - ${OSSA_RUNNER_TAG}
  variables:
    GIT_AUTHOR_NAME: "OSSA Release Bot"
    GIT_AUTHOR_EMAIL: "release-bot@openstandardagents.org"
    GIT_COMMITTER_NAME: "OSSA Release Bot"
    GIT_COMMITTER_EMAIL: "release-bot@openstandardagents.org"
    GITLAB_TOKEN: ${GITLAB_PUSH_TOKEN}
  before_script:
    - npm ci
    - npm run build
    - |
      # Clean up stale local tags from previous failed runs (local runner issue)
      git tag -l | xargs -r git tag -d
      git fetch --tags
      echo "Cleaned stale local tags"
    - |
      # Publishing to GitLab Package Registry (private)
      # Use GITLAB_TOKEN from CI/CD variables for package publishing
      echo "//gitlab.com/api/v4/projects/76265294/packages/npm/:_authToken=${GITLAB_TOKEN}" > .npmrc
      echo "@bluefly:registry=https://gitlab.com/api/v4/projects/76265294/packages/npm/" >> .npmrc
      if [ -z "$GITLAB_TOKEN" ]; then
        echo "ERROR: GITLAB_TOKEN not set in CI/CD variables"
        exit 1
      fi
      if [ -z "$GITLAB_PUSH_TOKEN" ]; then
        echo "ERROR: GITLAB_PUSH_TOKEN not set"
        exit 1
      fi
      echo "Publishing to GitLab Package Registry (private)"
  script:
    - echo "ðŸš€ Running semantic-release..."
    - npx semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_BRANCH =~ /^release\/v[0-9]+\.[0-9]+\.x$/ && $CI_PIPELINE_SOURCE == "push"
