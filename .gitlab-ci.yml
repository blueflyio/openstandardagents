stages:
  - validate
  - build
  - deploy

variables:
  NODE_VERSION: "20"

.node-setup:
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache git curl
    - cd website
    - npm ci --legacy-peer-deps

# Validation
validate:lint:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "Lint validation - skipping until setup complete"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "development"
  allow_failure: true

# Build website - runs automatically on all branches
build:website:
  extends: .node-setup
  stage: build
  script:
    - npm run build:no-wiki || npm run build
    - |
      if [ ! -d "out" ]; then
        echo "‚ùå ERROR: out/ directory not found"
        exit 1
      fi
    - echo "‚úÖ Build complete"
  artifacts:
    paths:
      - website/out
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "development"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Deploy to GitLab Pages - AUTOMATIC for development, MANUAL approval for main
pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build:website
  script:
    - mkdir -p public
    - cp -r website/out/* public/
    - echo "‚úÖ Deployed to GitLab Pages"
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    # Development: Auto-deploy (staging preview)
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_success
    # Main: Requires approval (production)
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: $CI_COMMIT_BRANCH
    url: https://blueflyio.gitlab.io/openstandardagents.org
    deployment_tier: staging
    action: start

# Production environment (main only) - protected environment approval
deploy:production:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build:website
  script:
    - mkdir -p public
    - cp -r website/out/* public/
    - echo "üöÄ Deployed to PRODUCTION"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  environment:
    name: production
    url: https://openstandardagents.org
    deployment_tier: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  allow_failure: false

# Discord notification
notify:discord:
  stage: .post
  image: curlimages/curl:latest
  script:
    - |
      if [ -n "$DISCORD_WEBHOOK_URL" ]; then
        curl -X POST "$DISCORD_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"Pipeline ${CI_PIPELINE_STATUS}\",
              \"description\": \"Pipeline #${CI_PIPELINE_ID} for ${CI_PROJECT_NAME}\",
              \"color\": $([ \"$CI_PIPELINE_STATUS\" == \"success\" ] && echo \"3066993\" || echo \"15158332\"),
              \"fields\": [
                {\"name\": \"Branch\", \"value\": \"${CI_COMMIT_BRANCH}\", \"inline\": true},
                {\"name\": \"Commit\", \"value\": \"${CI_COMMIT_SHORT_SHA}\", \"inline\": true}
              ],
              \"url\": \"${CI_PIPELINE_URL}\"
            }]
          }"
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_failure
  allow_failure: true
