stages:
  - validate
  - test
  - build
  - deploy
  - promote
  - release
variables:
  NODE_VERSION: '20'
  OSSA_VERSION: '0.2.2'
validate:openapi:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "Validating OSSA OpenAPI specifications..."
    - npm install -g @redocly/cli
    - redocly lint openapi/**/*.yaml || true
  allow_failure: true
validate:schemas:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "Validating OSSA JSON schemas..."
    - npm install
    - npm run validate:examples || true
  artifacts:
    reports:
      junit: test-results.xml
    paths:
      - test-results.xml
  allow_failure: true
test:unit:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - echo "Running OSSA specification tests..."
    - npm install
    - npm run test || true
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: junit.xml
    paths:
      - coverage/
  allow_failure: true
build:docs:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - echo "Building OSSA documentation..."
    - npm install -g @redocly/cli
    - mkdir -p public/api
    - |
      for spec in openapi/**/*.yaml; do
        if [ -f "$spec" ]; then
          filename=$(basename "$spec" .yaml)
          echo "Generating docs for $filename..."
          redocly build-docs "$spec" -o "public/api/${filename}.html" || true
        fi
      done
  artifacts:
    paths:
      - public/
    expire_in: 1 week
pages:
  stage: deploy
  dependencies:
    - build:docs
  script:
    - echo "Deploying OSSA documentation to GitLab Pages..."
    - ls -la public/
  artifacts:
    paths:
      - public
  only:
    - main
    - development
publish:gitlab-packages:development:
  stage: release
  image: node:${NODE_VERSION}
  script:
    - echo "Publishing OSSA to GitLab Packages Registry (development pre-release)..."
    - echo "@bluefly:registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" >> .npmrc
    - echo "//gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - npm install
    - npm run build
    # Update version to include development pre-release tag
    - npm version prerelease --preid=dev --no-git-tag-version
    - npm publish --registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/ --tag development
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
      when: on_success

publish:gitlab-packages:main:
  stage: release
  image: node:${NODE_VERSION}
  script:
    - echo "Publishing OSSA to GitLab Packages Registry (stable release)..."
    - echo "@bluefly:registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" >> .npmrc
    - echo "//gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - npm install
    - npm run build
    - npm publish --registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/ --tag latest
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success

publish:gitlab-packages:tagged:
  stage: release
  image: node:${NODE_VERSION}
  script:
    - echo "Publishing OSSA to GitLab Packages Registry (tagged release)..."
    - echo "@bluefly:registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" >> .npmrc
    - echo "//gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - npm install
    - npm run build
    - npm publish --registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: on_success

release:gitlab:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating OSSA v${OSSA_VERSION} GitLab release..."
  release:
    tag_name: v${OSSA_VERSION}
    description: OSSA Specification v${OSSA_VERSION} - The OpenAPI for AI Agents
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: on_success
  needs:
    - publish:gitlab-packages:tagged

release:npmjs:manual:
  stage: release
  image: node:${NODE_VERSION}
  script:
    - echo "Publishing OSSA v${OSSA_VERSION} to npmjs.com..."
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - npm whoami --registry=https://registry.npmjs.org/
    - npm install
    - npm run build
    - npm publish --access public --registry=https://registry.npmjs.org/
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: manual
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  needs:
    - job: publish:gitlab-packages:tagged
      optional: true
    - job: publish:gitlab-packages:main
      optional: true
  dependencies:
    - publish:gitlab-packages:tagged
    - publish:gitlab-packages:main
lint:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "Linting OSSA codebase..."
    - npm install
    - npm run lint || true
  allow_failure: true

# promote-to-main job disabled - use GitLab merge requests for main branch
# Manual merges to main are the proper workflow
#
# promote-to-main:
#   stage: promote
#   image: node:${NODE_VERSION}
#   before_script:
#     - apt-get update && apt-get install -y git
#     - git config --global user.email "ci@gitlab.bluefly.io"
#     - git config --global user.name "GitLab CI"
#   script:
#     - echo "Merging development to main and creating release tag..."
#     - git fetch origin
#     - git checkout main
#     - git merge origin/development --no-ff -m "chore merge development to main for v${OSSA_VERSION} release"
#     - git tag -a "v${OSSA_VERSION}" -m "Release v${OSSA_VERSION} - OSSA Specification"
#     - git push origin main
#     - git push origin "v${OSSA_VERSION}"
#   rules:
#     - if: $CI_COMMIT_BRANCH == "development"
#       when: manual
#   needs:
#     - validate:openapi
#     - validate:schemas
#     - test:unit
#     - lint
