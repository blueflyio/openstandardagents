stages:
  - validate
  - test
  - build
  - deploy
  - promote
  - release
variables:
  NODE_VERSION: '22'
  OSSA_VERSION: '0.2.2'

validate:openapi:
  stage: validate
  image: node:22
  script:
    - echo "Validating OSSA OpenAPI specifications..."
    - npm install -g @redocly/cli
    - redocly lint openapi/**/*.yaml || true
  allow_failure: true
validate:schemas:
  stage: validate
  image: node:22
  script:
    - echo "Validating OSSA JSON schemas..."
    - npm install
    - npm run validate:examples || true
  artifacts:
    reports:
      junit: test-results.xml
    paths:
      - test-results.xml
  allow_failure: true
test:unit:
  stage: test
  image: node:22
  script:
    - echo "Running OSSA specification tests..."
    - npm install
    - npm run test || true
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: junit.xml
    paths:
      - coverage/
  allow_failure: true
build:docs:
  stage: build
  image: node:22
  script:
    - echo "Building OSSA documentation..."
    - npm install -g @redocly/cli
    - mkdir -p public/api
    - |
      for spec in openapi/**/*.yaml; do
        if [ -f "$spec" ]; then
          filename=$(basename "$spec" .yaml)
          echo "Generating docs for $filename..."
          redocly build-docs "$spec" -o "public/api/${filename}.html" || true
        fi
      done
  artifacts:
    paths:
      - public/
    expire_in: 1 week
pages:
  stage: deploy
  dependencies:
    - build:docs
  script:
    - echo "Deploying OSSA documentation to GitLab Pages..."
    - ls -la public/
  artifacts:
    paths:
      - public
  only:
    - main
    - development
semantic-release:development:
  stage: release
  image: node:${NODE_VERSION}
  before_script:
    - if command -v apt-get >/dev/null 2>&1; then apt-get update && apt-get install -y git; elif command -v apk >/dev/null 2>&1; then apk add --no-cache git; fi
    - npm install
    - git config --global user.email "thomas.scola@bluefly.io"
    - git config --global user.name "Thomas Scola, Founder & CEO of Bluefly.io"
    - git remote set-url origin https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
  script:
    - echo "Running semantic-release for development branch..."
    - export GITLAB_TOKEN=${CI_JOB_TOKEN}
    - npx semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == "development" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/
      when: on_success
  environment:
    name: development
    url: https://gitlab.bluefly.io/$CI_PROJECT_PATH/-/releases

semantic-release:main:
  stage: release
  image: node:${NODE_VERSION}
  before_script:
    - if command -v apt-get >/dev/null 2>&1; then apt-get update && apt-get install -y git; elif command -v apk >/dev/null 2>&1; then apk add --no-cache git; fi
    - npm install
    - git config --global user.email "thomas.scola@bluefly.io"
    - git config --global user.name "Thomas Scola, Founder & CEO of Bluefly.io"
    - git remote set-url origin https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
  script:
    - echo "Running semantic-release for main branch..."
    - export GITLAB_TOKEN=${CI_JOB_TOKEN}
    - npx semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/
      when: on_success
  environment:
    name: production
    url: https://gitlab.bluefly.io/$CI_PROJECT_PATH/-/releases

publish:gitlab-packages:
  stage: release
  image: node:${NODE_VERSION}
  script:
    - echo "ðŸ“¦ Publishing OSSA to GitLab Packages Registry..."
    - echo "@bluefly:registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" >> .npmrc
    - echo "//gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - npm install
    - npm run build
    - echo "ðŸš€ Publishing version $(node -p "require('./package.json').version") to GitLab Packages..."
    - npm publish --registry=https://gitlab.bluefly.io/api/v4/projects/${CI_PROJECT_ID}/packages/npm/
    - echo "âœ… Successfully published to GitLab Packages Registry"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
      when: on_success
  needs:
    - semantic-release:main
  environment:
    name: gitlab-packages
    url: https://gitlab.bluefly.io/llm/openapi-ai-agents-standard/-/packages

publish:npmjs:manual:
  stage: release
  image: node:${NODE_VERSION}
  script:
    - echo "ðŸ“¦ Publishing OSSA to npmjs.com..."
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - npm whoami --registry=https://registry.npmjs.org/ || echo "âš ï¸ npm authentication check skipped"
    - npm install
    - npm run build
    - echo "ðŸš€ Publishing version $(node -p "require('./package.json').version") to npmjs.com..."
    - npm publish --access public --registry=https://registry.npmjs.org/
    - echo "âœ… Successfully published to npmjs.com"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
      when: manual
      allow_failure: false
  needs:
    - publish:gitlab-packages
  environment:
    name: npmjs-production
    url: https://www.npmjs.com/package/@bluefly/open-standards-scalable-agents
lint:
  stage: validate
  image: node:${NODE_VERSION}
  script:
    - echo "Linting OSSA codebase..."
    - npm install
    - npm run lint || true
  allow_failure: true

promote-to-main:
  stage: promote
  image: node:${NODE_VERSION}
  before_script:
    - if command -v apt-get >/dev/null 2>&1; then apt-get update && apt-get install -y git; elif command -v apk >/dev/null 2>&1; then apk add --no-cache git; fi
    - git config --global user.email "thomas.scola@bluefly.io"
    - git config --global user.name "Thomas Scola, Founder & CEO of Bluefly.io"
    - git remote set-url origin https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
  script:
    - |
      set -e
      echo "ðŸš€ Attempting fast-forward merge of development -> main..."
      git fetch --all --prune --unshallow || true
      git checkout -B main origin/main
      # Try fast-forward only
      if git merge --ff-only origin/development; then
        git push origin main
        echo "âœ… Fast-forward merge completed."
      else
        echo "âš ï¸ Fast-forward not possible. Creating Merge Request instead."
        # Create MR via GitLab API using job token
        MR_TITLE="chore: merge development to main"
        MR_DESC="Automated MR created by CI promote-to-main job when fast-forward was not possible. Please resolve conflicts and merge."
        # First, check if an open MR already exists
        EXISTING_MR_RESPONSE=$(curl -sS -G "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests" \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --data-urlencode "source_branch=development" \
          --data-urlencode "target_branch=main" \
          --data-urlencode "state=opened")
        EXISTING_MR_URL=$(echo "$EXISTING_MR_RESPONSE" | node -e "process.stdin.on('data',d=>{try{const j=JSON.parse(d);if(Array.isArray(j)&&j.length){console.log(j[0].web_url||'');}else{console.log('');}}catch(e){}})")
        if [ -n "$EXISTING_MR_URL" ]; then
          echo "ðŸ“¬ Existing Merge Request found: $EXISTING_MR_URL"
          exit 0
        fi

        # Create a new MR via GitLab API using CI job token as PRIVATE-TOKEN
        CREATE_MR_RESPONSE=$(curl -sS -X POST "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests" \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --data-urlencode "source_branch=development" \
          --data-urlencode "target_branch=main" \
          --data-urlencode "title=${MR_TITLE}" \
          --data-urlencode "remove_source_branch=false" \
          --data-urlencode "squash=false" \
          --data-urlencode "description=${MR_DESC}" \
          --data-urlencode "allow_collaboration=true")
        echo "MR create response: ${CREATE_MR_RESPONSE}"
        MR_WEB_URL=$(echo "$CREATE_MR_RESPONSE" | node -e "process.stdin.on('data',d=>{try{const j=JSON.parse(d);console.log(j.web_url||'');}catch(e){}})")
        if [ -n "$MR_WEB_URL" ]; then
          echo "ðŸ“¬ Merge Request created: $MR_WEB_URL"
          # Succeed the job; manual review will handle conflicts
          exit 0
        else
          echo "âŒ Failed to create Merge Request (unauthorized or permissions). Please create MR from development -> main manually."
          exit 1
        fi
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "development"
      when: manual
      allow_failure: false
  environment:
    name: production
    action: start
  needs:
    - validate:openapi
    - validate:schemas
    - test:unit
