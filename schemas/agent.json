{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://api.llm.bluefly.io/schemas/agent.json",
  "title": "OSSA Agent Schema",
  "description": "JSON Schema for OSSA v0.3.0 Agent definitions supporting CRUD operations",
  "type": "object",
  "required": ["apiVersion", "kind", "metadata", "spec"],
  "properties": {
    "apiVersion": {
      "type": "string",
      "const": "ossa/v0.3.0",
      "description": "OSSA specification version"
    },
    "kind": {
      "type": "string",
      "const": "Agent",
      "description": "Resource type identifier"
    },
    "metadata": {
      "$ref": "#/$defs/Metadata"
    },
    "spec": {
      "$ref": "#/$defs/AgentSpec"
    }
  },
  "$defs": {
    "Metadata": {
      "type": "object",
      "required": ["name", "version"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
          "minLength": 1,
          "maxLength": 63,
          "description": "Agent name in DNS label format"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9]+([.-][a-zA-Z0-9]+)*)?$",
          "description": "Semantic version (e.g., 1.0.0, 2.1.3-beta)"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the agent"
        },
        "labels": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Key-value labels for categorization and filtering"
        }
      }
    },
    "AgentSpec": {
      "type": "object",
      "required": ["llm", "runtime", "capabilities"],
      "properties": {
        "llm": {
          "$ref": "#/$defs/LLMConfig"
        },
        "execution_profile": {
          "$ref": "#/$defs/ExecutionProfile"
        },
        "runtime": {
          "$ref": "#/$defs/RuntimeConfig"
        },
        "capabilities": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Capability"
          },
          "minItems": 1,
          "description": "Agent capabilities and actions"
        },
        "functions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Function"
          },
          "description": "OpenAI-style function definitions"
        },
        "extensions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Extension"
          },
          "description": "External integrations and extensions"
        },
        "role": {
          "type": "string",
          "description": "Primary role of the agent"
        },
        "taxonomy": {
          "$ref": "#/$defs/Taxonomy"
        },
        "tools": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Tool"
          },
          "description": "MCP and other tool integrations"
        },
        "knowledge_graph": {
          "$ref": "#/$defs/KnowledgeGraph"
        }
      }
    },
    "LLMConfig": {
      "type": "object",
      "required": ["provider", "model"],
      "properties": {
        "provider": {
          "type": "string",
          "description": "LLM provider (supports environment variable substitution)",
          "examples": ["anthropic", "openai", "google", "mistral"]
        },
        "model": {
          "type": "string",
          "description": "Model identifier",
          "examples": ["claude-sonnet-4", "gpt-4o", "gemini-2.0-flash"]
        },
        "profile": {
          "type": "string",
          "enum": ["fast", "balanced", "deep", "safe"],
          "default": "balanced",
          "description": "Execution profile for A2A compatibility"
        },
        "temperature": {
          "type": "number",
          "minimum": 0,
          "maximum": 2,
          "default": 0.1,
          "description": "Sampling temperature for response generation"
        },
        "maxTokens": {
          "type": "integer",
          "minimum": 1,
          "maximum": 200000,
          "default": 16000,
          "description": "Maximum tokens in model response"
        },
        "topP": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.9,
          "description": "Nucleus sampling parameter"
        },
        "fallback_models": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/FallbackModel"
          },
          "description": "Fallback models for resilience"
        },
        "retry_config": {
          "$ref": "#/$defs/RetryConfig"
        }
      }
    },
    "FallbackModel": {
      "type": "object",
      "required": ["provider", "model", "condition"],
      "properties": {
        "provider": {
          "type": "string"
        },
        "model": {
          "type": "string"
        },
        "condition": {
          "type": "string",
          "enum": ["on_error", "on_rate_limit", "on_timeout"],
          "description": "Condition triggering fallback"
        }
      }
    },
    "RetryConfig": {
      "type": "object",
      "properties": {
        "max_attempts": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3,
          "description": "Maximum retry attempts"
        },
        "backoff_strategy": {
          "type": "string",
          "enum": ["linear", "exponential", "fibonacci"],
          "default": "exponential",
          "description": "Backoff strategy for retries"
        }
      }
    },
    "ExecutionProfile": {
      "type": "object",
      "properties": {
        "default": {
          "type": "string",
          "enum": ["fast", "balanced", "deep", "safe"]
        },
        "profiles": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/ProfileConfig"
          }
        }
      }
    },
    "ProfileConfig": {
      "type": "object",
      "properties": {
        "maxTokens": {
          "type": "integer"
        },
        "temperature": {
          "type": "number"
        },
        "reasoning_enabled": {
          "type": "boolean"
        },
        "validation_required": {
          "type": "boolean"
        },
        "audit_log": {
          "type": "boolean"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "RuntimeConfig": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["unified", "kubernetes", "docker", "serverless", "local"],
          "description": "Runtime environment type"
        },
        "supports": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["google-a2a", "gitlab-duo", "ossa-mesh", "mcp", "local-execution"]
          },
          "description": "Supported runtime platforms"
        },
        "scheduling": {
          "$ref": "#/$defs/SchedulingConfig"
        },
        "resource_limits": {
          "$ref": "#/$defs/ResourceLimits"
        }
      }
    },
    "SchedulingConfig": {
      "type": "object",
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["fair", "priority", "round-robin"],
          "default": "fair"
        },
        "priority": {
          "type": "string",
          "enum": ["low", "normal", "high", "critical"],
          "default": "normal"
        },
        "max_concurrent": {
          "type": "integer",
          "minimum": 1,
          "default": 10,
          "description": "Maximum concurrent executions"
        },
        "timeout_seconds": {
          "type": "integer",
          "minimum": 1,
          "default": 300,
          "description": "Execution timeout in seconds"
        }
      }
    },
    "ResourceLimits": {
      "type": "object",
      "properties": {
        "memory_mb": {
          "type": "integer",
          "minimum": 128,
          "default": 512,
          "description": "Memory limit in megabytes"
        },
        "cpu_millicores": {
          "type": "integer",
          "minimum": 100,
          "default": 500,
          "description": "CPU limit in millicores"
        }
      }
    },
    "Capability": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Capability identifier"
        },
        "type": {
          "type": "string",
          "enum": ["action", "query", "monitor", "transform"],
          "description": "Capability type"
        },
        "runtime": {
          "type": "string",
          "enum": ["llm", "code", "hybrid"],
          "description": "Runtime execution mode"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description"
        },
        "input_schema": {
          "type": "object",
          "description": "JSON Schema for capability input validation"
        }
      }
    },
    "Function": {
      "type": "object",
      "required": ["name", "description", "parameters"],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Function name (snake_case)"
        },
        "description": {
          "type": "string",
          "description": "Function description for LLM"
        },
        "parameters": {
          "type": "object",
          "description": "OpenAI-style function parameters (JSON Schema)"
        },
        "returns": {
          "type": "object",
          "description": "Return value schema"
        }
      }
    },
    "Extension": {
      "type": "object",
      "required": ["type", "name", "endpoint"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["http", "mcp", "grpc", "websocket"],
          "description": "Extension protocol type"
        },
        "name": {
          "type": "string",
          "description": "Extension identifier"
        },
        "endpoint": {
          "type": "string",
          "format": "uri",
          "description": "Extension endpoint URL"
        },
        "credentials_ref": {
          "type": "string",
          "description": "Reference to credentials in secrets manager"
        }
      }
    },
    "Taxonomy": {
      "type": "object",
      "properties": {
        "domain": {
          "type": "string",
          "description": "Primary domain (e.g., security, development)"
        },
        "subdomain": {
          "type": "string",
          "description": "Subdomain specialization"
        },
        "capability": {
          "type": "string",
          "description": "Specific capability area"
        }
      }
    },
    "Tool": {
      "type": "object",
      "required": ["name", "source"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Tool identifier"
        },
        "description": {
          "type": "string",
          "description": "Tool description"
        },
        "source": {
          "$ref": "#/$defs/ToolSource"
        }
      }
    },
    "ToolSource": {
      "type": "object",
      "required": ["type", "uri"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["mcp", "http", "grpc"],
          "description": "Tool protocol type"
        },
        "uri": {
          "type": "string",
          "format": "uri",
          "description": "Tool endpoint URI"
        }
      }
    },
    "KnowledgeGraph": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable knowledge graph integration"
        },
        "provider": {
          "type": "string",
          "enum": ["neo4j", "memgraph", "dgraph"],
          "description": "Graph database provider"
        },
        "connection": {
          "$ref": "#/$defs/GraphConnection"
        }
      }
    },
    "GraphConnection": {
      "type": "object",
      "properties": {
        "endpoint": {
          "type": "string",
          "format": "uri",
          "description": "Graph database endpoint"
        },
        "credentials_ref": {
          "type": "string",
          "description": "Reference to database credentials"
        }
      }
    }
  },
  "examples": [
    {
      "apiVersion": "ossa/v0.3.0",
      "kind": "Agent",
      "metadata": {
        "name": "security-scanner",
        "version": "1.0.0",
        "description": "Security vulnerability scanner for code repositories",
        "labels": {
          "domain": "security",
          "capability": "scanning",
          "runtime": "kubernetes"
        }
      },
      "spec": {
        "llm": {
          "provider": "anthropic",
          "model": "claude-sonnet-4",
          "profile": "balanced",
          "temperature": 0.1,
          "maxTokens": 16000
        },
        "runtime": {
          "type": "kubernetes",
          "supports": ["ossa-mesh", "mcp"],
          "scheduling": {
            "strategy": "fair",
            "priority": "normal",
            "max_concurrent": 10,
            "timeout_seconds": 300
          },
          "resource_limits": {
            "memory_mb": 512,
            "cpu_millicores": 500
          }
        },
        "capabilities": [
          {
            "name": "security_scan",
            "type": "action",
            "runtime": "llm",
            "description": "Run security analysis on code",
            "input_schema": {
              "type": "object",
              "required": ["path"],
              "properties": {
                "path": {
                  "type": "string"
                },
                "severity": {
                  "type": "string",
                  "enum": ["low", "medium", "high", "critical"]
                }
              }
            }
          }
        ]
      }
    }
  ]
}
