# Comprehensive Ingress and Load Balancer Configuration for OSSA v0.1.8

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ossa-platform-ingress
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-platform-ingress
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: ossa-platform
    ossa.bluefly.io/version: "0.1.8"
  annotations:
    # NGINX Ingress Controller annotations
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/rate-limit-connections: "100"
    
    # Security headers
    nginx.ingress.kubernetes.io/server-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:;" always;
    
    # Load balancing and session affinity
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "ossa-session"
    nginx.ingress.kubernetes.io/session-cookie-expires: "3600"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "3600"
    nginx.ingress.kubernetes.io/session-cookie-path: "/"
    
    # Performance optimizations
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "8"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/client-max-body-size: "50m"
    
    # Enable gzip compression
    nginx.ingress.kubernetes.io/enable-gzip: "true"
    nginx.ingress.kubernetes.io/gzip-types: "application/json,application/javascript,text/css,text/javascript,text/plain,text/xml"
    
    # CORS configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://ossa.llm.bluefly.io,https://*.llm.bluefly.io"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-API-Key,X-Client-Version"
    nginx.ingress.kubernetes.io/cors-expose-headers: "Content-Length,Content-Range,X-Rate-Limit-Remaining,X-Rate-Limit-Reset"
    nginx.ingress.kubernetes.io/cors-max-age: "86400"
    
    # Health check configuration
    nginx.ingress.kubernetes.io/health-check-path: "/health"
    nginx.ingress.kubernetes.io/health-check-interval: "30s"
    nginx.ingress.kubernetes.io/health-check-timeout: "10s"
    
    # TLS/SSL configuration
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    cert-manager.io/acme-challenge-type: "http01"
spec:
  tls:
  - hosts:
    - ossa.llm.bluefly.io
    - ossa-api.llm.bluefly.io
    - ossa-monitor.llm.bluefly.io
    secretName: ossa-platform-tls
  rules:
  # Main API Gateway
  - host: ossa.llm.bluefly.io
    http:
      paths:
      # API v1 routes
      - path: /api/v1/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-gateway
            port:
              number: 80
      
      # GraphQL endpoint
      - path: /graphql/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-gateway
            port:
              number: 80
      
      # Health and monitoring endpoints
      - path: /health/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-gateway
            port:
              number: 80
      
      # Metrics endpoint (restricted access)
      - path: /metrics/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-gateway
            port:
              number: 80
      
      # WebSocket connections for real-time features
      - path: /ws/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-gateway
            port:
              number: 80
      
      # Default route
      - path: /(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-gateway
            port:
              number: 80

  # Dedicated API subdomain
  - host: ossa-api.llm.bluefly.io
    http:
      paths:
      - path: /(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-gateway
            port:
              number: 80

  # Monitoring subdomain
  - host: ossa-monitor.llm.bluefly.io
    http:
      paths:
      # Grafana dashboard
      - path: /grafana/(.*)
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 3000
      
      # Prometheus interface
      - path: /prometheus/(.*)
        pathType: Prefix
        backend:
          service:
            name: prometheus
            port:
              number: 9090
      
      # Jaeger tracing
      - path: /jaeger/(.*)
        pathType: Prefix
        backend:
          service:
            name: jaeger
            port:
              number: 16686
      
      # AlertManager
      - path: /alertmanager/(.*)
        pathType: Prefix
        backend:
          service:
            name: alertmanager
            port:
              number: 9093

---
# Internal Services Ingress (for admin/internal tools)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ossa-internal-ingress
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-internal-ingress
    app.kubernetes.io/component: internal-ingress
    app.kubernetes.io/part-of: ossa-platform
    ossa.bluefly.io/version: "0.1.8"
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    
    # Restrict access to internal networks only
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    
    # Basic authentication for additional security
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: ossa-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: 'OSSA Internal Access'
    
    # TLS configuration
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - ossa-internal.llm.bluefly.io
    secretName: ossa-internal-tls
  rules:
  - host: ossa-internal.llm.bluefly.io
    http:
      paths:
      # Direct service access for debugging
      - path: /coordination/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-coordination
            port:
              number: 3010
      
      - path: /discovery/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-discovery
            port:
              number: 3011
      
      - path: /orchestration/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-orchestration
            port:
              number: 3012
      
      # Health monitoring service
      - path: /health-monitor/(.*)
        pathType: Prefix
        backend:
          service:
            name: ossa-health-monitor
            port:
              number: 8080

---
# Network Load Balancer for High Performance
apiVersion: v1
kind: Service
metadata:
  name: ossa-nlb
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-nlb
    app.kubernetes.io/component: load-balancer
    app.kubernetes.io/part-of: ossa-platform
    ossa.bluefly.io/version: "0.1.8"
  annotations:
    # AWS Network Load Balancer
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "http"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/health"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "10"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout: "6"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: "2"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "2"
    
    # Connection draining
    service.beta.kubernetes.io/aws-load-balancer-connection-draining-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-connection-draining-timeout: "300"
    
    # Access logging
    service.beta.kubernetes.io/aws-load-balancer-access-log-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name: "ossa-nlb-logs"
    service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix: "nlb"
    
    # Additional attributes
    service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: "Environment=production,Project=ossa,Version=0.1.8"
spec:
  type: LoadBalancer
  loadBalancerSourceRanges:
  - 0.0.0.0/0  # Allow all traffic (restrict as needed for security)
  selector:
    app.kubernetes.io/name: ossa-gateway
  ports:
  - name: http
    port: 80
    targetPort: 3000
    protocol: TCP
  - name: https
    port: 443
    targetPort: 3000
    protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours

---
# Application Load Balancer for Advanced Features
apiVersion: v1
kind: Service
metadata:
  name: ossa-alb
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-alb
    app.kubernetes.io/component: app-load-balancer
    app.kubernetes.io/part-of: ossa-platform
    ossa.bluefly.io/version: "0.1.8"
  annotations:
    # AWS Application Load Balancer
    service.beta.kubernetes.io/aws-load-balancer-type: "alb"
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    service.beta.kubernetes.io/aws-load-balancer-target-type: "ip"
    
    # Health check configuration
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/health"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval-seconds: "15"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-timeout-seconds: "5"
    service.beta.kubernetes.io/aws-load-balancer-success-codes: "200"
    service.beta.kubernetes.io/aws-load-balancer-healthy-threshold-count: "2"
    service.beta.kubernetes.io/aws-load-balancer-unhealthy-threshold-count: "2"
    
    # SSL configuration
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-west-2:123456789012:certificate/12345678-1234-1234-1234-123456789012"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "https"
    service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    
    # Advanced features
    service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout: "60"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    
    # Security groups
    service.beta.kubernetes.io/aws-load-balancer-security-groups: "sg-ossa-alb"
    service.beta.kubernetes.io/aws-load-balancer-manage-backend-security-group-rules: "true"
    
    # Subnets (specify your public subnets)
    service.beta.kubernetes.io/aws-load-balancer-subnets: "subnet-12345,subnet-67890,subnet-abcdef"
    
    # Tags
    service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: "Environment=production,Project=ossa,Version=0.1.8,LoadBalancer=ALB"
spec:
  type: LoadBalancer
  selector:
    app.kubernetes.io/name: ossa-gateway
  ports:
  - name: http
    port: 80
    targetPort: 3000
    protocol: TCP
  - name: https
    port: 443
    targetPort: 3000
    protocol: TCP

---
# Global Load Balancer for Multi-Region
apiVersion: networking.gke.io/v1
kind: MultiClusterIngress
metadata:
  name: ossa-global-lb
  namespace: ossa-global
  labels:
    app.kubernetes.io/name: ossa-global-lb
    app.kubernetes.io/component: global-load-balancer
    ossa.bluefly.io/version: "0.1.8"
  annotations:
    networking.gke.io/load-balancer-type: "External"
    networking.gke.io/managed-certificates: "ossa-global-ssl-cert"
    networking.gke.io/ip-address-reservation: "ossa-global-ip"
spec:
  template:
    spec:
      backend:
        serviceName: ossa-global-backend
        servicePort: 80
      rules:
      - host: ossa.llm.bluefly.io
        http:
          paths:
          - path: /api/v1/*
            backend:
              serviceName: ossa-gateway-mcs
              servicePort: 80
          - path: /graphql/*
            backend:
              serviceName: ossa-gateway-mcs
              servicePort: 80
          - path: /*
            backend:
              serviceName: ossa-global-backend
              servicePort: 80

---
# Basic Auth Secret for Internal Access
apiVersion: v1
kind: Secret
metadata:
  name: ossa-basic-auth
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-basic-auth
    app.kubernetes.io/component: authentication
type: Opaque
data:
  auth: YWRtaW46JGFwcjEkSDY1dnVVVlYkbUhKUGZ6cFRxbG5vZzJvdEFYeXNjMQ==  # admin:ossa-admin-2025

---
# WAF Policy for Application Security (AWS ALB specific)
apiVersion: v1
kind: ConfigMap
metadata:
  name: ossa-waf-policy
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-waf-policy
    app.kubernetes.io/component: security
data:
  waf-policy.json: |
    {
      "Name": "OSSA-WAF-Policy",
      "Scope": "REGIONAL",
      "DefaultAction": {
        "Allow": {}
      },
      "Rules": [
        {
          "Name": "AWSManagedRulesCommonRuleSet",
          "Priority": 1,
          "OverrideAction": {
            "None": {}
          },
          "Statement": {
            "ManagedRuleGroupStatement": {
              "VendorName": "AWS",
              "Name": "AWSManagedRulesCommonRuleSet"
            }
          },
          "VisibilityConfig": {
            "SampledRequestsEnabled": true,
            "CloudWatchMetricsEnabled": true,
            "MetricName": "CommonRuleSetMetric"
          }
        },
        {
          "Name": "RateLimitRule",
          "Priority": 2,
          "Action": {
            "Block": {}
          },
          "Statement": {
            "RateBasedStatement": {
              "Limit": 2000,
              "AggregateKeyType": "IP"
            }
          },
          "VisibilityConfig": {
            "SampledRequestsEnabled": true,
            "CloudWatchMetricsEnabled": true,
            "MetricName": "RateLimitMetric"
          }
        }
      ]
    }

---
# CDN Configuration for Static Assets
apiVersion: v1
kind: ConfigMap
metadata:
  name: ossa-cdn-config
  namespace: ossa-platform
  labels:
    app.kubernetes.io/name: ossa-cdn-config
    app.kubernetes.io/component: cdn
data:
  cloudfront-config.json: |
    {
      "CallerReference": "ossa-platform-cdn-2025",
      "Comment": "OSSA Platform CDN Distribution",
      "Enabled": true,
      "PriceClass": "PriceClass_All",
      "Origins": {
        "Quantity": 1,
        "Items": [
          {
            "Id": "ossa-origin",
            "DomainName": "ossa.llm.bluefly.io",
            "CustomOriginConfig": {
              "HTTPPort": 80,
              "HTTPSPort": 443,
              "OriginProtocolPolicy": "https-only",
              "OriginSslProtocols": {
                "Quantity": 3,
                "Items": ["TLSv1", "TLSv1.1", "TLSv1.2"]
              }
            }
          }
        ]
      },
      "DefaultCacheBehavior": {
        "TargetOriginId": "ossa-origin",
        "ViewerProtocolPolicy": "redirect-to-https",
        "AllowedMethods": {
          "Quantity": 7,
          "Items": ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"],
          "CachedMethods": {
            "Quantity": 2,
            "Items": ["GET", "HEAD"]
          }
        },
        "ForwardedValues": {
          "QueryString": true,
          "Cookies": {"Forward": "all"}
        },
        "MinTTL": 0,
        "DefaultTTL": 86400,
        "MaxTTL": 31536000
      }
    }