# Orchestration Rules - Workspace Level
# Defines how workspace orchestrates agents across projects

ossa: "0.1.8"
kind: "OrchestrationRules"
metadata:
  name: "workspace-orchestration-rules"
  version: "1.0.0"
  description: "Rules for cross-project agent orchestration and routing"

spec:
  # === ROUTING RULES ===
  routing_rules:
    # Default routing strategy
    default_strategy: "capability_match"
    
    # Capability-based routing
    capability_routing:
      - capability: "code_analysis"
        preferred_projects: ["backend-api", "frontend-app"]
        fallback_projects: ["*"]
        load_balancing: "round_robin"
        
      - capability: "security_scanning"
        preferred_projects: ["backend-api"]
        fallback_projects: ["security-tools"]
        load_balancing: "least_busy"
        
      - capability: "data_processing"
        preferred_projects: ["ml-pipeline", "data-warehouse"]
        fallback_projects: []
        load_balancing: "resource_based"
        
      - capability: "documentation_generation"
        preferred_projects: ["*"]  # Any project can handle
        fallback_projects: []
        load_balancing: "random"
        
    # Domain-based routing
    domain_routing:
      - domain: "machine_learning"
        route_to_projects: ["ml-pipeline", "ai-research"]
        
      - domain: "web_development"
        route_to_projects: ["frontend-app", "backend-api"]
        
      - domain: "infrastructure"
        route_to_projects: ["devops-tools", "cloud-platform"]
        
    # Team-based routing
    team_routing:
      engineering:
        allowed_projects: ["backend-api", "frontend-app", "mobile-app"]
        priority: "high"
        
      data_science:
        allowed_projects: ["ml-pipeline", "data-warehouse", "analytics"]
        priority: "high"
        
      security:
        allowed_projects: ["*"]  # Security team can access all
        priority: "critical"
        
  # === ORCHESTRATION PATTERNS ===
  orchestration_patterns:
    # Sequential execution pattern
    sequential:
      - name: "code_review_pipeline"
        description: "Sequential code review process"
        steps:
          - project: "backend-api"
            agent: "code-analyzer"
            timeout: "30s"
          - project: "security-tools"
            agent: "vulnerability-scanner"
            timeout: "60s"
          - project: "documentation"
            agent: "report-generator"
            timeout: "20s"
            
    # Parallel execution pattern
    parallel:
      - name: "multi_project_validation"
        description: "Validate across multiple projects simultaneously"
        groups:
          - projects: ["backend-api", "frontend-app", "mobile-app"]
            agent_type: "validator"
            max_parallel: 3
            
    # Fan-out/fan-in pattern
    fanout:
      - name: "workspace_security_scan"
        description: "Security scan across all projects"
        fanout:
          target: "all_projects"
          agent: "security-scanner"
          collect_results: true
          aggregation: "security-dashboard"
          
    # Pipeline pattern
    pipeline:
      - name: "deployment_pipeline"
        description: "Multi-stage deployment pipeline"
        stages:
          - stage: "validation"
            projects: ["backend-api", "frontend-app"]
            parallel: true
          - stage: "security"
            projects: ["security-tools"]
            parallel: false
          - stage: "deployment"
            projects: ["devops-tools"]
            parallel: false
            
  # === COORDINATION RULES ===
  coordination_rules:
    # Context sharing rules
    context_sharing:
      - rule: "share_domain_context"
        description: "Share context between projects in same domain"
        condition: "same_domain"
        scope: "domain_wide"
        
      - rule: "share_security_context"
        description: "Share security findings across all projects"
        condition: "security_finding"
        scope: "workspace_wide"
        
      - rule: "share_performance_metrics"
        description: "Share performance data for optimization"
        condition: "performance_data"
        scope: "related_projects"
        
    # Handoff rules
    handoff_rules:
      - rule: "capability_handoff"
        description: "Hand off to project with best capability match"
        priority: 1
        timeout: "5s"
        
      - rule: "load_based_handoff"
        description: "Hand off based on current load"
        priority: 2
        timeout: "3s"
        
      - rule: "affinity_handoff"
        description: "Prefer previous successful handoffs"
        priority: 3
        timeout: "2s"
        
  # === LOAD BALANCING ===
  load_balancing:
    # Algorithms available
    algorithms:
      round_robin:
        description: "Simple round-robin distribution"
        sticky_sessions: false
        
      least_busy:
        description: "Route to least busy project"
        metric: "current_requests"
        sticky_sessions: false
        
      capability_score:
        description: "Route based on capability match score"
        scoring_factors:
          - capability_match: 0.5
          - performance_history: 0.3
          - current_load: 0.2
        sticky_sessions: true
        
      resource_based:
        description: "Route based on available resources"
        resources_checked:
          - cpu_available
          - memory_available
          - token_budget_remaining
        sticky_sessions: false
        
    # Circuit breaker configuration
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      timeout: "30s"
      half_open_requests: 2
      
  # === FAILURE HANDLING ===
  failure_handling:
    # Retry policies
    retry_policies:
      default:
        max_retries: 3
        backoff: "exponential"
        initial_delay: "1s"
        max_delay: "30s"
        
      critical:
        max_retries: 5
        backoff: "linear"
        initial_delay: "2s"
        max_delay: "10s"
        
    # Fallback strategies
    fallback_strategies:
      - strategy: "next_best_capability"
        description: "Try project with next best capability match"
        
      - strategy: "degraded_service"
        description: "Provide limited functionality"
        
      - strategy: "queue_for_retry"
        description: "Queue request for later retry"
        
    # Dead letter queue
    dead_letter_queue:
      enabled: true
      max_retention: "24h"
      alert_threshold: 100
      
  # === OPTIMIZATION RULES ===
  optimization:
    # Caching rules
    caching:
      - rule: "cache_frequent_requests"
        description: "Cache frequently requested capabilities"
        ttl: "5m"
        scope: "workspace"
        
      - rule: "cache_expensive_operations"
        description: "Cache results of expensive operations"
        ttl: "30m"
        scope: "project"
        
    # Batching rules
    batching:
      - rule: "batch_similar_requests"
        description: "Batch similar requests together"
        window: "100ms"
        max_batch_size: 10
        
    # Pre-warming rules
    prewarming:
      - rule: "prewarm_critical_agents"
        description: "Keep critical agents warm"
        agents: ["security-scanner", "api-validator"]
        
  # === GOVERNANCE RULES ===
  governance:
    # Access control
    access_control:
      - rule: "team_based_access"
        description: "Enforce team-based project access"
        enforcement: "strict"
        
      - rule: "compliance_required"
        description: "Require compliance for production access"
        enforcement: "strict"
        
    # Audit rules
    audit:
      - rule: "audit_all_cross_project"
        description: "Audit all cross-project requests"
        retention: "90d"
        
      - rule: "audit_failed_requests"
        description: "Detailed audit of failed requests"
        retention: "30d"
        
    # Rate limiting
    rate_limiting:
      default:
        requests_per_minute: 1000
        burst: 100
        
      by_team:
        engineering: 2000
        data_science: 1500
        product: 500
        
      by_capability:
        security_scanning: 100
        data_processing: 500
        code_analysis: 1000

# === MONITORING ===
monitoring:
  # Metrics to track
  tracked_metrics:
    - "routing_decisions"
    - "handoff_success_rate"
    - "cross_project_latency"
    - "capability_utilization"
    - "failure_rate_by_pattern"
    
  # Alerting rules
  alerts:
    - name: "high_failure_rate"
      condition: "failure_rate > 5%"
      severity: "warning"
      
    - name: "routing_degradation"
      condition: "routing_latency > 500ms"
      severity: "critical"
      
    - name: "capacity_exhaustion"
      condition: "available_capacity < 10%"
      severity: "warning"