# OSSA Enterprise Monitoring - Prometheus Configuration
# Version: 0.1.8 - Comprehensive Metrics Collection

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'ossa-production'
    environment: 'production'

rule_files:
  - "ossa-alerts.yml"
  - "ossa-recording-rules.yml"
  - "sla-rules.yml"

scrape_configs:
  # Core OSSA API Services
  - job_name: 'ossa-api-core'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443', 'localhost:3000', 'localhost:8000']
    scheme: https
    metrics_path: '/api/v1/metrics'
    scrape_interval: 5s
    scrape_timeout: 10s
    params:
      format: ['prometheus']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
      - source_labels: [__address__]
        regex: '(.*):.*'
        target_label: host
        replacement: '${1}'

  # Agent Registry & Management
  - job_name: 'ossa-agents'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/agents/metrics'
    scrape_interval: 10s
    metrics_path: '/metrics'
    params:
      subsystem: ['agents', 'registry', 'discovery']

  # VORTEX Token Exchange & Optimization
  - job_name: 'ossa-vortex'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/vortex/metrics'
    scrape_interval: 5s
    params:
      metrics: ['token_usage', 'optimization_ratio', 'cost_savings']

  # 360Â° Feedback Loop System
  - job_name: 'ossa-feedback'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/feedback/metrics'
    scrape_interval: 10s
    params:
      metrics: ['feedback_accuracy', 'response_quality', 'satisfaction_score']

  # Memory System Metrics (ACTA)
  - job_name: 'ossa-memory'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/memory/metrics'
    scrape_interval: 15s
    params:
      metrics: ['context_retention', 'knowledge_accuracy', 'memory_efficiency']

  # Orchestration System Performance
  - job_name: 'ossa-orchestration'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/orchestration/metrics'
    scrape_interval: 5s
    params:
      metrics: ['workflow_success_rate', 'execution_time', 'resource_utilization']

  # OpenAPI Generator & SDK Metrics
  - job_name: 'ossa-openapi-generator'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/openapi/metrics'
    scrape_interval: 30s
    params:
      metrics: ['generation_accuracy', 'spec_compliance', 'sdk_quality']

  # Security & Trust Scoring
  - job_name: 'ossa-security'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/security/metrics'
    scrape_interval: 10s
    params:
      metrics: ['trust_score', 'vulnerability_count', 'compliance_status']

  # Circuit Breaker & Resilience
  - job_name: 'ossa-resilience'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/resilience/metrics'
    scrape_interval: 5s
    params:
      metrics: ['circuit_breaker_state', 'failure_rate', 'recovery_time']

  # Validation & Compliance Engine
  - job_name: 'ossa-validation'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/validation/metrics'
    scrape_interval: 10s
    params:
      metrics: ['validation_accuracy', 'compliance_score', 'certification_status']

  # Performance & SLA Metrics
  - job_name: 'ossa-performance'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/performance/metrics'
    scrape_interval: 5s
    params:
      metrics: ['response_time', 'throughput', 'availability', 'error_rate']

  # Token Usage & Cost Optimization
  - job_name: 'ossa-token-metrics'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/tokens/metrics'
    scrape_interval: 10s
    params:
      metrics: ['token_consumption', 'optimization_savings', 'cost_per_request']

  # Agent Fleet Management (100-Agent)
  - job_name: 'ossa-fleet'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/fleet/metrics'
    scrape_interval: 15s
    params:
      metrics: ['active_agents', 'deployment_health', 'load_distribution']

  # Infrastructure Metrics
  - job_name: 'ossa-infrastructure'
    static_configs:
      - targets: ['localhost:9100', 'localhost:9091']
    scrape_interval: 15s
    metrics_path: '/metrics'

  # Database & Storage Metrics  
  - job_name: 'ossa-storage'
    static_configs:
      - targets: ['localhost:5432', 'localhost:6333', 'localhost:9200']
    scrape_interval: 30s
    params:
      metrics: ['storage_utilization', 'query_performance', 'index_health']

  # GitLab CI/CD Pipeline Metrics
  - job_name: 'ossa-cicd'
    static_configs:
      - targets: ['gitlab.com']
    scheme: https
    metrics_path: '/api/v4/projects/metrics'
    scrape_interval: 60s
    params:
      metrics: ['pipeline_success_rate', 'deployment_frequency', 'lead_time']

  # OPC UA/UADP Industrial Protocol Metrics
  - job_name: 'ossa-industrial'
    static_configs:
      - targets: ['ossa.ossa.orb.local:443']
    scheme: https
    metrics_path: '/api/v1/industrial/metrics'
    scrape_interval: 5s
    params:
      protocols: ['opcua', 'uadp']
      metrics: ['protocol_compliance', 'real_time_latency', 'security_status']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:9093
      timeout: 10s
      path_prefix: /
      scheme: http

# Recording rules for SLA calculations
recording_rules:
  - name: ossa.sla.rules
    interval: 30s
    rules:
      - record: ossa:availability:5m
        expr: (1 - (rate(ossa_http_requests_total{code=~"5.."}[5m]) / rate(ossa_http_requests_total[5m]))) * 100
      - record: ossa:response_time:p99:5m
        expr: histogram_quantile(0.99, rate(ossa_http_request_duration_seconds_bucket[5m]))
      - record: ossa:throughput:5m
        expr: rate(ossa_http_requests_total[5m])
      - record: ossa:token_optimization:5m
        expr: (1 - (ossa_tokens_consumed / ossa_tokens_requested)) * 100

# Remote write configuration for long-term storage
remote_write:
  - url: "http://localhost:8428/api/v1/write"
    queue_config:
      max_samples_per_send: 10000
      batch_send_deadline: 5s
      min_shards: 1
      max_shards: 200
      
# Remote read for federated queries
remote_read:
  - url: "http://localhost:8428/api/v1/read"
    read_recent: true