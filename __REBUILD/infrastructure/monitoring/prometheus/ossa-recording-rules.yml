# OSSA Recording Rules for SLA and Performance Metrics
# Version: 0.1.8 - Aggregated Metrics for Dashboards

groups:
  - name: ossa.sla.recording
    interval: 30s
    rules:
      # Availability SLA Recording Rules
      - record: ossa:availability:1m
        expr: (1 - (rate(ossa_http_requests_total{code=~"5.."}[1m]) / rate(ossa_http_requests_total[1m]))) * 100

      - record: ossa:availability:5m
        expr: (1 - (rate(ossa_http_requests_total{code=~"5.."}[5m]) / rate(ossa_http_requests_total[5m]))) * 100

      - record: ossa:availability:1h
        expr: (1 - (rate(ossa_http_requests_total{code=~"5.."}[1h]) / rate(ossa_http_requests_total[1h]))) * 100

      - record: ossa:availability:24h
        expr: (1 - (rate(ossa_http_requests_total{code=~"5.."}[24h]) / rate(ossa_http_requests_total[24h]))) * 100

      # Response Time SLA Recording Rules
      - record: ossa:response_time:p50:5m
        expr: histogram_quantile(0.50, rate(ossa_http_request_duration_seconds_bucket[5m]))

      - record: ossa:response_time:p95:5m
        expr: histogram_quantile(0.95, rate(ossa_http_request_duration_seconds_bucket[5m]))

      - record: ossa:response_time:p99:5m
        expr: histogram_quantile(0.99, rate(ossa_http_request_duration_seconds_bucket[5m]))

      - record: ossa:response_time:p99:1h
        expr: histogram_quantile(0.99, rate(ossa_http_request_duration_seconds_bucket[1h]))

      # Throughput Recording Rules
      - record: ossa:throughput:1m
        expr: rate(ossa_http_requests_total[1m]) * 60

      - record: ossa:throughput:5m
        expr: rate(ossa_http_requests_total[5m]) * 60

      - record: ossa:throughput:1h
        expr: rate(ossa_http_requests_total[1h]) * 60

      # Error Rate Recording Rules
      - record: ossa:error_rate:5m
        expr: rate(ossa_http_requests_total{code=~"4..|5.."}[5m]) / rate(ossa_http_requests_total[5m]) * 100

      - record: ossa:error_rate:1h
        expr: rate(ossa_http_requests_total{code=~"4..|5.."}[1h]) / rate(ossa_http_requests_total[1h]) * 100

  - name: ossa.business.recording
    interval: 1m
    rules:
      # Token Optimization Recording Rules
      - record: ossa:token_optimization:5m
        expr: (1 - (rate(ossa_tokens_consumed_total[5m]) / rate(ossa_tokens_requested_total[5m]))) * 100

      - record: ossa:token_optimization:1h
        expr: (1 - (rate(ossa_tokens_consumed_total[1h]) / rate(ossa_tokens_requested_total[1h]))) * 100

      - record: ossa:token_optimization:24h
        expr: (1 - (rate(ossa_tokens_consumed_total[24h]) / rate(ossa_tokens_requested_total[24h]))) * 100

      # Cost Optimization Recording Rules
      - record: ossa:cost_savings:1h
        expr: (ossa_token_cost_saved_usd[1h] / (ossa_token_cost_saved_usd[1h] + ossa_token_cost_spent_usd[1h])) * 100

      - record: ossa:cost_savings:24h
        expr: (ossa_token_cost_saved_usd[24h] / (ossa_token_cost_saved_usd[24h] + ossa_token_cost_spent_usd[24h])) * 100

      # Agent Fleet Health Recording Rules
      - record: ossa:agents:healthy:ratio
        expr: ossa_agents_healthy_total / ossa_agents_total

      - record: ossa:agents:deployment_success_rate:1h
        expr: (1 - (rate(ossa_agent_deployment_failures_total[1h]) / rate(ossa_agent_deployment_attempts_total[1h]))) * 100

  - name: ossa.quality.recording
    interval: 2m
    rules:
      # Research Quality Recording Rules
      - record: ossa:research_accuracy:5m
        expr: avg(ossa_research_accuracy_percent)

      - record: ossa:research_accuracy:1h
        expr: avg_over_time(ossa_research_accuracy_percent[1h])

      - record: ossa:research_accuracy:24h
        expr: avg_over_time(ossa_research_accuracy_percent[24h])

      # Code Generation Quality Recording Rules
      - record: ossa:code_quality:5m
        expr: avg(ossa_code_generation_quality_percent)

      - record: ossa:code_quality:1h
        expr: avg_over_time(ossa_code_generation_quality_percent[1h])

      # Specification Compliance Recording Rules
      - record: ossa:spec_compliance:5m
        expr: avg(ossa_specification_compliance_percent)

      - record: ossa:spec_compliance:1h
        expr: avg_over_time(ossa_specification_compliance_percent[1h])

  - name: ossa.security.recording
    interval: 1m
    rules:
      # Security Metrics Recording Rules
      - record: ossa:trust_score:5m
        expr: avg(ossa_trust_score)

      - record: ossa:trust_score:1h
        expr: avg_over_time(ossa_trust_score[1h])

      - record: ossa:vulnerability_density:24h
        expr: increase(ossa_security_vulnerabilities_total[24h]) / ossa_code_lines_total * 1000

      - record: ossa:compliance_score:1h
        expr: (1 - (rate(ossa_compliance_violations_total[1h]) / rate(ossa_compliance_checks_total[1h]))) * 100

  - name: ossa.orchestration.recording
    interval: 30s
    rules:
      # Workflow Performance Recording Rules
      - record: ossa:workflow_success_rate:5m
        expr: (1 - (rate(ossa_workflow_failures_total[5m]) / rate(ossa_workflow_executions_total[5m]))) * 100

      - record: ossa:workflow_success_rate:1h
        expr: (1 - (rate(ossa_workflow_failures_total[1h]) / rate(ossa_workflow_executions_total[1h]))) * 100

      - record: ossa:workflow_duration:p95:5m
        expr: histogram_quantile(0.95, rate(ossa_workflow_duration_seconds_bucket[5m]))

      - record: ossa:workflow_duration:p99:5m
        expr: histogram_quantile(0.99, rate(ossa_workflow_duration_seconds_bucket[5m]))

      # Circuit Breaker Recording Rules
      - record: ossa:circuit_breaker_trip_rate:1h
        expr: rate(ossa_circuit_breaker_trips_total[1h])

  - name: ossa.resource.recording
    interval: 1m
    rules:
      # Resource Utilization Recording Rules
      - record: ossa:memory_utilization:5m
        expr: avg(ossa_memory_usage_bytes / ossa_memory_limit_bytes * 100)

      - record: ossa:cpu_utilization:5m
        expr: avg(ossa_cpu_usage_percent)

      - record: ossa:disk_utilization:5m
        expr: avg((ossa_disk_total_bytes - ossa_disk_free_bytes) / ossa_disk_total_bytes * 100)

      # Network Performance Recording Rules
      - record: ossa:network_throughput:5m
        expr: rate(ossa_network_bytes_total[5m])

      - record: ossa:network_errors:5m
        expr: rate(ossa_network_errors_total[5m])

  - name: ossa.industrial.recording
    interval: 15s
    rules:
      # Industrial Protocol Recording Rules
      - record: ossa:industrial_latency:p99:1m
        expr: histogram_quantile(0.99, rate(ossa_industrial_protocol_latency_seconds_bucket[1m]))

      - record: ossa:industrial_throughput:5m
        expr: rate(ossa_industrial_protocol_messages_total[5m])

      - record: ossa:industrial_error_rate:5m
        expr: rate(ossa_industrial_protocol_errors_total[5m]) / rate(ossa_industrial_protocol_messages_total[5m]) * 100

  - name: ossa.user.recording
    interval: 5m
    rules:
      # User Experience Recording Rules
      - record: ossa:user_satisfaction:1h
        expr: avg_over_time(ossa_user_satisfaction_score[1h])

      - record: ossa:user_satisfaction:24h
        expr: avg_over_time(ossa_user_satisfaction_score[24h])

      - record: ossa:user_sessions:5m
        expr: rate(ossa_user_sessions_total[5m]) * 300

      - record: ossa:user_retention:24h
        expr: ossa_active_users_24h / ossa_new_users_24h * 100