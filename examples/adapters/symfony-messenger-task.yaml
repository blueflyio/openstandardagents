# Example: OSSA Task executed via Symfony Messenger
# Demonstrates async task execution with queue-based processing
apiVersion: ossa/v0.3.0
kind: Task
metadata:
  name: send-email-symfony
  version: 1.0.0
  description: Send email using Symfony Mailer via Messenger
  labels:
    runtime: symfony
    transport: messenger
    domain: communication

spec:
  execution:
    type: deterministic
    runtime: symfony
    entrypoint: "App\\TaskHandler\\SendEmailHandler::execute"
    timeout_seconds: 30

  capabilities:
    - send_email
    - render_template
    - validate_email

  input:
    type: object
    properties:
      to:
        type: string
        format: email
        description: Recipient email address
      subject:
        type: string
        description: Email subject line
      template:
        type: string
        description: Twig template name
      variables:
        type: object
        description: Template variables
        additionalProperties: true
      attachments:
        type: array
        items:
          type: object
          properties:
            filename:
              type: string
            content_type:
              type: string
            path:
              type: string
      priority:
        type: string
        enum: [low, normal, high]
        default: normal
    required:
      - to
      - subject
      - template

  output:
    type: object
    properties:
      message_id:
        type: string
        description: Email message ID
      sent_at:
        type: string
        format: date-time
      status:
        type: string
        enum: [sent, queued, failed]
      delivery_info:
        type: object
        properties:
          transport:
            type: string
          queue_position:
            type: integer

  error_handling:
    on_error: retry
    retry:
      max_attempts: 3
      initial_delay_ms: 1000
      backoff_strategy: exponential
      retryable_errors:
        - SMTP_TEMPORARY_ERROR
        - CONNECTION_TIMEOUT
        - RATE_LIMITED

  observability:
    logging:
      level: info
    metrics:
      enabled: true
      custom_labels:
        email_type: "${{ input.template }}"
        priority: "${{ input.priority }}"

# Symfony-specific runtime bindings
runtime:
  type: symfony
  bindings:
    send_email:
      service: "@Symfony\\Component\\Mailer\\MailerInterface"
      method: "send"
    render_template:
      service: "@Twig\\Environment"
      method: "render"
    validate_email:
      service: "@Symfony\\Component\\Validator\\Validator\\ValidatorInterface"
      method: "validate"

  # Messenger configuration
  messenger:
    transport: ossa_tasks
    routing_key: email.send
    priority: "${{ input.priority }}"
    delay_ms: 0

    # Message headers
    headers:
      X-OSSA-Task-Type: send-email
      X-OSSA-Version: v0.3.0
      X-Priority: "${{ input.priority }}"

    # Retry configuration (overrides default)
    retry:
      max_retries: 3
      delay: 1000
      multiplier: 2
      max_delay: 60000
