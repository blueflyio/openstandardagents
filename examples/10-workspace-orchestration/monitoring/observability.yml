# Enterprise Observability Configuration
# Comprehensive monitoring, logging, and alerting for AI agent workspaces
# OpenAPI AI Agents Standard (OSSA) v0.1.8

ossa: "0.1.8"
kind: "ObservabilityConfiguration"
metadata:
  name: "enterprise-observability"
  version: "1.0.0"
  description: "Production-grade observability stack for AI agent orchestration"

spec:
  # === METRICS COLLECTION ===
  metrics:
    # Core metrics infrastructure
    infrastructure:
      prometheus:
        enabled: true
        scrape_interval: "15s"
        retention: "30d"
        storage: "100GB"
        
      grafana:
        enabled: true
        dashboards_as_code: true
        alerting: true
        
      victoriametrics:
        enabled: false  # Alternative to Prometheus for scale

    # Application metrics
    application_metrics:
      agent_metrics:
        - agent_invocations_total
        - agent_response_time_seconds
        - agent_success_rate
        - agent_token_usage_total
        - agent_cost_usd_total
        
      orchestration_metrics:
        - orchestration_requests_total
        - orchestration_latency_seconds
        - orchestration_success_rate
        - concurrent_orchestrations
        - queue_depth
        
      workspace_metrics:
        - discovered_agents_total
        - registry_queries_total
        - cache_hit_ratio
        - resource_utilization_percent
        
    # Business metrics
    business_metrics:
      cost_tracking:
        - daily_spend_usd
        - cost_per_request_usd
        - budget_utilization_percent
        - cost_by_team_usd
        
      performance_kpis:
        - user_satisfaction_score
        - system_availability_percent
        - mean_time_to_resolution_seconds
        - throughput_requests_per_second

    # Custom metrics
    custom_metrics:
      enabled: true
      namespaces:
        - "ai_agent"
        - "orchestration" 
        - "compliance"
        - "security"

  # === DISTRIBUTED TRACING ===
  tracing:
    # Tracing infrastructure
    infrastructure:
      jaeger:
        enabled: true
        sampling_rate: 0.1
        storage: "elasticsearch"
        
      zipkin:
        enabled: false
        
      otel_collector:
        enabled: true
        processors: ["batch", "memory_limiter", "resource"]

    # Trace configuration
    configuration:
      context_propagation: "w3c"
      max_span_attributes: 128
      max_events_per_span: 128
      
      sampling_strategies:
        - service: "orchestration-engine"
          sampling_rate: 1.0  # 100% sampling for critical service
          
        - service: "agent-registry"
          sampling_rate: 0.5
          
        - service: "default"
          sampling_rate: 0.1

    # Custom instrumentation
    custom_spans:
      - span_name: "agent_discovery"
        attributes: ["capability", "confidence", "latency"]
        
      - span_name: "orchestration_pattern"
        attributes: ["pattern_type", "participants", "success"]
        
      - span_name: "compliance_check"
        attributes: ["framework", "controls", "result"]

  # === LOGGING ===
  logging:
    # Log aggregation
    aggregation:
      elasticsearch:
        enabled: true
        cluster: "logging-cluster"
        indices:
          - pattern: "agents-*"
            retention: "90d"
            
          - pattern: "orchestration-*"
            retention: "30d"
            
          - pattern: "security-*"
            retention: "7y"  # Compliance requirement

      fluentd:
        enabled: true
        buffer_type: "file"
        flush_interval: "10s"

    # Log levels and formats
    configuration:
      default_level: "info"
      format: "json"
      
      level_overrides:
        security: "debug"
        compliance: "debug"
        performance: "warn"

    # Structured logging
    structured_logging:
      enabled: true
      fields:
        - timestamp
        - level
        - service
        - trace_id
        - span_id
        - user_id
        - request_id
        - message
        
      sensitive_data_redaction:
        - pii_fields: ["email", "ssn", "phone"]
        - credential_fields: ["password", "token", "key"]

    # Log analysis
    analysis:
      ml_anomaly_detection: true
      pattern_recognition: true
      correlation_analysis: true
      
      alerts:
        - pattern: "ERROR.*authentication"
          threshold: 10
          window: "5m"
          
        - pattern: "CRITICAL.*orchestration"
          threshold: 1
          window: "1m"

  # === ALERTING ===
  alerting:
    # Alert managers
    infrastructure:
      alertmanager:
        enabled: true
        high_availability: true
        
      pagerduty:
        enabled: true
        service_key: "${PAGERDUTY_SERVICE_KEY}"
        
      slack:
        enabled: true
        channels:
          - name: "#alerts-critical"
            severity: ["critical", "high"]
            
          - name: "#alerts-warning"  
            severity: ["medium", "low"]

    # Alert rules
    rules:
      # Infrastructure alerts
      infrastructure:
        - alert: "WorkspaceDown"
          expr: "up{job='workspace'} == 0"
          for: "1m"
          severity: "critical"
          
        - alert: "HighCPUUsage"
          expr: "cpu_usage_percent > 80"
          for: "5m"
          severity: "warning"

      # Application alerts  
      application:
        - alert: "OrchestrationLatencyHigh"
          expr: "orchestration_latency_p95 > 5000"
          for: "2m"
          severity: "warning"
          
        - alert: "AgentFailureRateHigh"
          expr: "agent_failure_rate > 0.05"
          for: "1m"
          severity: "critical"

      # Business alerts
      business:
        - alert: "BudgetExceeded"
          expr: "daily_spend_usd > daily_budget_usd"
          for: "0m"
          severity: "critical"
          
        - alert: "SLABreach"
          expr: "availability_percent < 99.9"
          for: "5m"
          severity: "high"

      # Security alerts
      security:
        - alert: "SecurityIncident"
          expr: "security_incidents_total > 0"
          for: "0m"
          severity: "critical"
          
        - alert: "ComplianceViolation"
          expr: "compliance_violations_total > 0"
          for: "0m"
          severity: "high"

  # === DASHBOARDS ===
  dashboards:
    # Executive dashboard
    executive:
      name: "AI Agent Executive Overview"
      panels:
        - title: "System Health"
          type: "stat"
          metrics: ["availability", "error_rate", "response_time"]
          
        - title: "Cost Overview"
          type: "graph"
          metrics: ["daily_spend", "budget_utilization"]
          
        - title: "Compliance Status"
          type: "table"
          metrics: ["iso_42001_score", "nist_rmf_score", "sox_score"]

    # Operations dashboard
    operations:
      name: "Agent Operations"
      panels:
        - title: "Agent Performance"
          type: "heatmap"
          metrics: ["agent_response_time", "agent_success_rate"]
          
        - title: "Orchestration Metrics"
          type: "graph"
          metrics: ["orchestration_requests", "concurrent_orchestrations"]
          
        - title: "Resource Utilization"
          type: "gauge"
          metrics: ["cpu_usage", "memory_usage", "token_usage"]

    # Security dashboard
    security:
      name: "Security Monitoring"
      panels:
        - title: "Threat Level"
          type: "stat"
          metrics: ["current_threat_level", "active_incidents"]
          
        - title: "Authentication Events"
          type: "graph"
          metrics: ["login_attempts", "failed_logins", "mfa_usage"]
          
        - title: "Security Controls"
          type: "table"
          metrics: ["control_effectiveness", "policy_violations"]

    # Compliance dashboard
    compliance:
      name: "Compliance Status"
      panels:
        - title: "Framework Compliance"
          type: "table"
          frameworks: ["iso_42001", "nist_ai_rmf", "eu_ai_act", "sox"]
          
        - title: "Audit Readiness"
          type: "stat"
          metrics: ["audit_score", "evidence_completeness"]
          
        - title: "Risk Management"
          type: "heatmap"
          metrics: ["risk_score", "mitigation_status"]

  # === HEALTH CHECKS ===
  health_checks:
    # Service health
    services:
      - name: "orchestration-engine"
        endpoint: "/health"
        interval: "30s"
        timeout: "5s"
        
      - name: "agent-registry"
        endpoint: "/health"
        interval: "30s"
        timeout: "3s"
        
      - name: "compliance-engine"
        endpoint: "/health"
        interval: "60s"
        timeout: "10s"

    # Deep health checks
    deep_checks:
      enabled: true
      interval: "5m"
      
      checks:
        - name: "end_to_end_orchestration"
          type: "synthetic"
          timeout: "30s"
          
        - name: "compliance_validation"
          type: "functional"
          timeout: "60s"
          
        - name: "security_controls"
          type: "security"
          timeout: "45s"

  # === PERFORMANCE MONITORING ===
  performance:
    # Application Performance Monitoring
    apm:
      enabled: true
      agent: "elastic-apm"
      
      transaction_sampling: 1.0
      error_sampling: 1.0
      span_frames_min_duration: "5ms"

    # Real User Monitoring
    rum:
      enabled: true
      session_replay: true
      error_tracking: true
      performance_tracking: true

    # Synthetic monitoring
    synthetic:
      enabled: true
      tests:
        - name: "agent_discovery_test"
          type: "api"
          interval: "1m"
          endpoint: "/api/agents/discover"
          
        - name: "orchestration_test"
          type: "workflow"
          interval: "5m"
          scenario: "basic_orchestration"

  # === DATA RETENTION ===
  retention:
    metrics: "30d"
    traces: "7d"
    logs:
      default: "30d"
      security: "7y"
      compliance: "7y"
      debug: "3d"

  # === COST OPTIMIZATION ===
  cost_optimization:
    # Sampling strategies
    sampling:
      metrics_downsampling: true
      log_sampling_by_level: true
      trace_tail_sampling: true

    # Storage optimization
    storage:
      compression: true
      cold_storage_threshold: "30d"
      archival_threshold: "1y"