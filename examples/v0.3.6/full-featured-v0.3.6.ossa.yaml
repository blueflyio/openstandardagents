apiVersion: ossa/v0.3.6
kind: Agent
metadata:
  name: gitlab-mr-reviewer-pro
  version: 1.0.0
  description: "Enterprise-grade MR reviewer with token efficiency, composite identity, and knowledge graph"
  efficiency_tier: economy  # Aggressive optimization

  # Agent Catalog Metadata (v0.3.6+)
  catalog:
    published: true
    catalog_id: gitlab-mr-reviewer-pro
    visibility: internal
    categories:
      - code-quality
      - security
      - gitlab
      - code-review
    tags:
      - gitlab-duo
      - token-efficiency
      - knowledge-graph
      - composite-identity
      - enterprise
    icon_url: https://example.com/icons/mr-reviewer.svg
    documentation_url: https://docs.example.com/mr-reviewer
    pricing:
      model: enterprise
      subscription_monthly: 499
    ratings:
      average: 4.8
      count: 127

  labels:
    cost-tier: economy
    security-level: high
    compliance: sox-gdpr
    environment: production

spec:
  role: "Expert code reviewer with deep codebase understanding, security focus, and 95% cost efficiency"

  # Composite Identity (GitLab Duo v0.3.6+)
  identity:
    provider: gitlab

    composite:
      enabled: true
      merge_strategy: restrictive

      primary_identity:
        username: mr-review-bot
        email: mr-review-bot@company.com
        roles:
          - developer

      secondary_identity:
        user_id: $GITLAB_USER_ID
        username: $GITLAB_USERNAME
        email: $GITLAB_USER_EMAIL

      permissions:
        read:
          - repositories
          - merge_requests
          - pipelines
        write:
          - merge_request_comments
        execute:
          - code_analysis
          - security_scan

    authentication:
      method: oauth2
      scopes:
        - api
        - read_repository
        - write_repository
      auto_refresh: true

    token_source:
      env_var: GITLAB_COMPOSITE_TOKEN

  llm:
    provider: anthropic
    model: claude-opus-4
    temperature: 0.2
    max_tokens: 8192

  # Token Efficiency (v0.3.6+) - 95% savings
  token_efficiency:
    enabled: true

    # Context Management: 70% savings
    context_management:
      strategy: adaptive
      pruning:
        enabled: true
        threshold: 0.3
        max_tokens: 50000
        preserve_recent: 10
      summarization:
        enabled: true
        model: haiku
        compression_ratio: 0.2
        trigger_threshold: 100000
      caching:
        enabled: true
        ttl: 600
        strategy: hybrid

    # Prompt Caching: 90% savings
    prompt_caching:
      enabled: true
      provider: anthropic
      strategy: hybrid
      cache_breakpoints:
        - system_prompt
        - knowledge_base
        - recent_history
        - tools
      min_tokens: 1024
      ttl: 300
      estimated_savings: 90

    # Token Budgets: Hard limits
    token_budget:
      enabled: true
      input_limit: 150000
      output_limit: 8192
      total_limit: 160000
      enforcement: adaptive
      overflow_behavior: summarize

    # Tool Output Limits
    tool_output_limits:
      enabled: true
      max_tokens_per_tool: 10000
      max_total_tokens: 100000
      truncation_strategy: smart
      large_output_handling: summarize

    # Streaming for reduced latency
    streaming:
      enabled: true
      chunk_size: 512

    # Knowledge Graph: 98% savings
    knowledge_graph:
      enabled: true
      max_context_tokens: 15000
      indexing_strategy: selective

    # Checkpoint Compression
    checkpoint_compression:
      enabled: true
      strategy: delta
      compression_ratio: 0.15

    # Estimated Savings
    estimated_savings:
      percentage: 95
      baseline_cost: 15
      optimized_cost: 0.75

  # Knowledge Sources with Compliance Enforcement
  knowledge_sources:
    - name: codebase-graph
      provider: custom
      config:
        type: knowledge_graph
        mcp_server: gitlab-kg

  mandatory_knowledge_sources:
    - source_id: react-best-practices
      enforcement_level: query
      triggers:
        - "**/*.tsx"
        - "**/*.jsx"
    - source_id: typescript-standards
      enforcement_level: validate
      triggers:
        - "**/*.ts"
        - "**/*.tsx"
    - source_id: security-patterns
      enforcement_level: block
      triggers:
        - "**/*auth*.ts"
        - "**/*security*.ts"

  # MCP Extensions
  extensions:
    mcp:
      servers:
        - name: gitlab-kg
          transport: http
          oauth2:
            enabled: true
            registration_endpoint: https://gitlab.com/oauth/applications
            scopes:
              - api
              - read_repository

      tools:
        - name: query_codebase
          description: "Semantic code search"
          server: gitlab-kg

        - name: get_relationships
          description: "Code relationships"
          server: gitlab-kg

        - name: security_scan
          description: "Security vulnerability scan"
          server: gitlab-kg

  tools:
    - type: mcp
      name: gitlab-mr-tools
      description: "GitLab MR operations"

    - type: function
      name: static-analysis
      description: "ESLint, TypeScript, Prettier checks"

    - type: function
      name: security-scan
      description: "SAST, dependency vulnerabilities"

  autonomy:
    level: assisted
    approval_required:
      - merge_request_approval
      - code_modification
    allowed_actions:
      - add_comment
      - request_changes
      - run_analysis
    blocked_actions:
      - approve_mr
      - merge_mr
      - modify_code

  observability:
    enabled: true
    tracing:
      enabled: true
      provider: opentelemetry
      sampling_rate: 1
    metrics:
      track_tokens: true
      track_cost: true
      track_latency: true
      track_quality: true
    logging:
      level: info
      structured: true

  safety:
    sandboxing:
      enabled: true
      mode: strict
    content_filtering:
      enabled: true
      blocklist:
        - credentials
        - api-keys
        - passwords
    rate_limiting:
      enabled: true
      requests_per_minute: 30

  # Runtime Configuration
  runtime:
    max_turns: 20
    checkpoint_interval: 5
    environments:
      production:
        max_turns: 15
        timeout: 300
      staging:
        max_turns: 20
        timeout: 600

  # Completion Signals
  completion:
    enabled: true
    default_signal: complete
    signals:
      - signal: complete
        description: "Review completed successfully"
      - signal: blocked
        description: "Security issues found"
      - signal: escalate
        description: "Complex issues require human review"

  # Checkpointing
  checkpointing:
    enabled: true
    strategy: interval
    storage:
      backend: agent-brain
      location: redis://checkpoint-store:6379
      retention: 7d
