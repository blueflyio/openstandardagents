apiVersion: ossa/v0.3.6
kind: Agent
metadata:
  name: cost-optimized-code-reviewer
  version: 1.0.0
  description: "Code review agent with significant cost optimization through token efficiency"
  efficiency_tier: economy  # Enables aggressive optimization
  labels:
    cost-tier: economy
    use-case: code-review
    optimization: aggressive

spec:
  role: "Expert code reviewer focused on security, performance, and best practices"

  llm:
    provider: anthropic
    model: claude-opus-4
    temperature: 0.3
    max_tokens: 4096

  # Token Efficiency Configuration (v0.3.6+)
  # Achieves significant cost optimization vs baseline
  token_efficiency:
    enabled: true

    # Context Management: 70% savings
    context_management:
      strategy: semantic_pruning
      pruning:
        enabled: true
        threshold: 0.3          # Keep only 30% most relevant context
        max_tokens: 50000       # Hard limit on context size
        preserve_recent: 5      # Always keep last 5 messages
      summarization:
        enabled: true
        model: haiku            # Use cheap model for summaries
        compression_ratio: 0.3  # Compress to 30% of original
        trigger_threshold: 50000 # Summarize when context exceeds 50k tokens

    # Prompt Caching: 90% savings on repeated context (Anthropic)
    prompt_caching:
      enabled: true
      provider: anthropic
      strategy: hybrid
      cache_breakpoints:
        - system_prompt        # Cache system prompt (always static)
        - knowledge_base       # Cache React best practices
        - tools                # Cache tool definitions
      min_tokens: 1024
      ttl: 300                 # 5 minutes
      estimated_savings: 90

    # Token Budget: Hard limits
    token_budget:
      enabled: true
      input_limit: 100000      # Max 100k input tokens
      output_limit: 4096       # Max 4k output tokens
      enforcement: hard        # Block if exceeded
      overflow_behavior: summarize  # Summarize if over budget

    # Tool Output Limits: Prevent massive tool outputs
    tool_output_limits:
      enabled: true
      max_tokens_per_tool: 5000
      max_total_tokens: 50000
      truncation_strategy: smart
      large_output_handling: summarize

    # Estimated Savings (for documentation)
    estimated_savings:
      percentage: 95
      baseline_cost: 10.00
      optimized_cost: 0.50

  # Knowledge sources for code quality
  mandatory_knowledge_sources:
    - source_id: react-best-practices
      enforcement_level: query
      triggers:
        - "**/*.tsx"
        - "**/*.jsx"
    - source_id: typescript-standards
      enforcement_level: validate
      triggers:
        - "**/*.ts"
        - "**/*.tsx"

  tools:
    - type: mcp
      name: gitlab-mr-tools
      description: "GitLab MR operations"
    - type: function
      name: code-analysis
      description: "Static code analysis"

  autonomy:
    level: assisted
    approval_required:
      - merge_request
      - code_change

  observability:
    enabled: true
    tracing:
      enabled: true
      provider: opentelemetry
    metrics:
      track_tokens: true
      track_cost: true
      track_latency: true
