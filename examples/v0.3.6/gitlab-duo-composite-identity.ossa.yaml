apiVersion: ossa/v0.3.6
kind: Agent
metadata:
  name: gitlab-deployment-agent
  version: 1.0.0
  description: "Deployment agent with GitLab Duo composite identity for attribution and security"
  catalog:
    published: true
    visibility: internal
    categories:
      - devops
      - deployment
      - gitlab
    tags:
      - gitlab-duo
      - composite-identity
      - production-deployment
    documentation_url: https://docs.example.com/deployment-agent

spec:
  role: "Production deployment orchestrator with human oversight and attribution"

  # Composite Identity (GitLab Duo Agent Platform v0.3.6+)
  # Merges service account (bot) + human user for security and attribution
  identity:
    provider: gitlab

    # Composite Identity Configuration
    composite:
      enabled: true
      merge_strategy: restrictive  # Intersection of permissions (most secure)

      # Primary: Service account (bot)
      primary_identity:
        username: deploy-bot
        email: deploy-bot@company.com
        roles:
          - deployer

      # Secondary: Human operator (for attribution)
      secondary_identity:
        user_id: $GITLAB_USER_ID      # Injected by GitLab Duo
        username: $GITLAB_USERNAME
        email: user@example.com

      # Explicit permission boundaries
      permissions:
        read:
          - repositories
          - deployments
          - pipelines
          - environments
        write:
          - deployments           # Service account can deploy
          # Note: Cannot write to repositories (security)
        execute:
          - deploy-production     # Requires BOTH identities
          - deploy-staging        # Service account only

    # Authentication
    authentication:
      method: oauth2
      scopes:
        - api
        - read_repository
        - write_repository
      auto_refresh: true

    # Token source
    token_source:
      env_var: GITLAB_TOKEN       # Composite token from GitLab Duo

  llm:
    provider: anthropic
    model: claude-sonnet-4
    temperature: 0.1              # Low temp for deterministic deployment

  tools:
    - type: kubernetes
      name: k8s-deploy
      description: "Kubernetes deployment operations"

    - type: mcp
      name: gitlab-api
      description: "GitLab API access via MCP"

    - type: function
      name: pre-deploy-checks
      description: "Validation before deployment"

  autonomy:
    level: assisted
    approval_required:
      - deploy-production        # Always require human approval for prod
    allowed_actions:
      - validate-deployment
      - deploy-staging
      - rollback
    blocked_actions:
      - force-push               # Never allowed
      - delete-production        # Never allowed

  observability:
    enabled: true
    tracing:
      enabled: true
      provider: opentelemetry
    audit:
      enabled: true
      level: comprehensive       # Full audit trail for deployments
      retention_days: 365

  safety:
    sandboxing:
      enabled: true
      mode: strict
    rate_limiting:
      enabled: true
      requests_per_minute: 10
