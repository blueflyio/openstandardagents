# ============================================================================
# Spectral Ruleset for OSSA OpenAPI Documents
# ============================================================================
# Custom rules for validating OpenAPI specs with OSSA extensions
#
# @see https://openstandardagents.org/docs/openapi-extensions
# @see https://stoplight.io/p/docs/gh/stoplightio/spectral
# ============================================================================

extends:
  - spectral:oas

# Override some default rule severities
rules:
  # Info validations
  info-contact: warn
  info-description: warn
  info-license: off  # Not required for internal APIs

  # Operation validations
  operation-description: warn
  operation-operationId: error
  operation-operationId-unique: error
  operation-tags: warn
  operation-tag-defined: warn

  # Path validations
  path-params: error
  path-keys-no-trailing-slash: error
  path-not-include-query: error

  # Component validations
  oas3-valid-media-example: warn
  oas3-valid-schema-example: warn

  # Security
  oas3-api-servers: warn

  # OSSA-specific custom rules
  ossa-metadata-recommended:
    message: "OSSA agents should include x-ossa-metadata extension for compliance tracking"
    severity: info
    given: "$"
    then:
      field: x-ossa-metadata
      function: truthy

  ossa-agent-identification:
    message: "OSSA agents should include x-ossa or x-agent extension for agent identification"
    severity: info
    given: "$"
    then:
      - field: x-ossa
        function: truthy
      - field: x-agent
        function: truthy

  ossa-capability-on-operations:
    message: "Operations should include x-ossa-capability to link to agent capabilities"
    severity: hint
    given: "$.paths[*][get,post,put,patch,delete]"
    then:
      field: x-ossa-capability
      function: truthy

  ossa-autonomy-on-write-operations:
    message: "Write operations (POST/PUT/PATCH/DELETE) should define x-ossa-autonomy level"
    severity: hint
    given: "$.paths[*][post,put,patch,delete]"
    then:
      field: x-ossa-autonomy
      function: truthy

  ossa-valid-autonomy-level:
    message: "x-ossa-autonomy.level must be one of: full, supervised, human-in-the-loop, none"
    severity: error
    given: "$.paths[*][*].x-ossa-autonomy.level"
    then:
      function: enumeration
      functionOptions:
        values:
          - full
          - supervised
          - human-in-the-loop
          - none

  ossa-valid-capability-type:
    message: "x-ossa-capability.type must be one of: tool, skill, knowledge, integration"
    severity: error
    given: "$.paths[*][*].x-ossa-capability.type"
    then:
      function: enumeration
      functionOptions:
        values:
          - tool
          - skill
          - knowledge
          - integration

  # Version validation
  openapi-version-3x:
    message: "OSSA requires OpenAPI 3.0 or 3.1"
    severity: error
    given: "$.openapi"
    then:
      function: pattern
      functionOptions:
        match: "^3\\.(0|1)"

  # Server URL validation
  server-url-https-recommended:
    message: "Production APIs should use HTTPS"
    severity: warn
    given: "$.servers[*].url"
    then:
      function: pattern
      functionOptions:
        notMatch: "^http://(?!localhost|127\\.0\\.0\\.1)"
